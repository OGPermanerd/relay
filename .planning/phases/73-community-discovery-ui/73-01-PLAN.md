---
phase: 73-community-discovery-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/skill-communities.ts
  - packages/db/src/migrations/0041_add_community_labels.sql
  - packages/db/src/services/community-queries.ts
  - packages/db/src/services/index.ts
  - apps/web/lib/community-label-generator.ts
  - apps/web/app/api/cron/community-detection/route.ts
autonomous: true

must_haves:
  truths:
    - "Community label and description columns exist in skill_communities table"
    - "Query service returns community overviews with member count and top skills"
    - "Query service returns community detail with similarity scores to centroid"
    - "AI label generator produces name + description from member skill list"
    - "Cron endpoint generates labels after detection runs"
  artifacts:
    - path: "packages/db/src/migrations/0041_add_community_labels.sql"
      provides: "ALTER TABLE adding community_label and community_description"
      contains: "ALTER TABLE skill_communities"
    - path: "packages/db/src/services/community-queries.ts"
      provides: "getCommunities and getCommunityDetail query functions"
      exports: ["getCommunities", "getCommunityDetail"]
    - path: "apps/web/lib/community-label-generator.ts"
      provides: "AI label generation via Anthropic Haiku"
      exports: ["generateCommunityLabel"]
  key_links:
    - from: "apps/web/app/api/cron/community-detection/route.ts"
      to: "apps/web/lib/community-label-generator.ts"
      via: "import generateCommunityLabel"
      pattern: "generateCommunityLabel"
    - from: "packages/db/src/services/community-queries.ts"
      to: "packages/db/src/schema/skill-communities.ts"
      via: "SQL queries against skill_communities table"
      pattern: "skill_communities"
---

<objective>
Add community label/description columns, create query services for browse and detail pages, build AI label generator, and wire label generation into the cron endpoint.

Purpose: Provide the complete backend foundation for community discovery -- schema, queries, AI labeling, and automated label refresh.
Output: Migration applied, two query functions exported, label generator working, cron endpoint updated.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@packages/db/src/schema/skill-communities.ts
@packages/db/src/services/community-detection.ts
@apps/web/app/api/cron/community-detection/route.ts
@apps/web/lib/ai-review.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration + query services</name>
  <files>
    packages/db/src/schema/skill-communities.ts
    packages/db/src/migrations/0041_add_community_labels.sql
    packages/db/src/services/community-queries.ts
    packages/db/src/services/index.ts
  </files>
  <action>
1. Create migration `packages/db/src/migrations/0041_add_community_labels.sql`:
   ```sql
   ALTER TABLE skill_communities
     ADD COLUMN IF NOT EXISTS community_label TEXT,
     ADD COLUMN IF NOT EXISTS community_description TEXT;
   ```

2. Update `packages/db/src/schema/skill-communities.ts` -- add two columns to the pgTable definition:
   ```typescript
   communityLabel: text("community_label"),
   communityDescription: text("community_description"),
   ```

3. Run migration: `cd /home/dev/projects/relay && pnpm db:migrate`

4. Create `packages/db/src/services/community-queries.ts` with two functions:

   **getCommunities(tenantId: string)** -- Returns array of CommunityOverview objects. Uses SQL:
   - GROUP BY community_id within tenant
   - MAX(community_label) as label, MAX(community_description) as description
   - COUNT(*)::int as member_count, MAX(modularity) as modularity
   - json_agg of top skills (name, slug, category) ordered by total_uses DESC, limited to first 3 via slice
   - JOIN skills, filter status='published' AND visibility IN ('global_approved','tenant')
   - ORDER BY member_count DESC

   Interface CommunityOverview: { communityId: number; label: string | null; description: string | null; memberCount: number; topSkills: { name: string; slug: string; category: string }[]; modularity: number; }

   **getCommunityDetail(tenantId: string, communityId: number)** -- Returns CommunityDetail or null. Uses SQL:
   - CTE: community_skills (skill_id list for this community+tenant)
   - CTE: centroid (AVG(se.embedding) from skill_embeddings for community skills) -- pgvector AVG() verified working
   - CTE: meta (MAX label, description, modularity for this community)
   - Main query: JOIN skills + skill_embeddings, CROSS JOIN centroid + meta
   - Similarity: ROUND(100 * (1 - (se.embedding <=> c.center) / 2))::int AS similarity_pct
   - Filter: status='published', visibility IN ('global_approved','tenant')
   - ORDER BY se.embedding <=> c.center ASC

   Interface CommunityDetail: { communityId: number; label: string | null; description: string | null; modularity: number; skills: Array<{ id: string; name: string; slug: string; description: string; category: string; totalUses: number; averageRating: number | null; similarityPct: number; }>; }

   Both functions: guard with `if (!db) return []` / `return null`.

5. Export both functions and their types from `packages/db/src/services/index.ts`:
   ```typescript
   export { getCommunities, getCommunityDetail, type CommunityOverview, type CommunityDetail } from "./community-queries";
   ```
  </action>
  <verify>
    - `pnpm db:migrate` succeeds
    - `pnpm turbo typecheck` passes
    - Query `SELECT community_label, community_description FROM skill_communities LIMIT 1` works (returns nulls)
  </verify>
  <done>Migration applied, both query functions exported and type-check clean. getCommunities returns array with member counts, getCommunityDetail returns skills with similarity percentages.</done>
</task>

<task type="auto">
  <name>Task 2: AI label generator + cron integration</name>
  <files>
    apps/web/lib/community-label-generator.ts
    apps/web/app/api/cron/community-detection/route.ts
  </files>
  <action>
1. Create `apps/web/lib/community-label-generator.ts`:
   - Follow the pattern in `apps/web/lib/ai-review.ts` for Anthropic client init
   - Model: `claude-haiku-4-5-20251001` (cost-efficient, short outputs)
   - Use `output_config.format.type: "json_schema"` with schema: { name: string, description: string }
   - System prompt: "You name clusters of related AI automation skills. Given member skills, produce a community name (2-5 words, title case) and 1-2 sentence description. Be specific. Good: 'Code Review Automation'. Bad: 'Productivity Tools'."
   - User message: list of skill names with categories and truncated descriptions (100 chars)
   - Validate with Zod: z.object({ name: z.string(), description: z.string() })
   - max_tokens: 256
   - Export: `generateCommunityLabel(skills: { name: string; description: string; category: string }[]): Promise<{ name: string; description: string }>`

2. Create `generateAndPersistCommunityLabels(tenantId: string)` in the same file:
   - Import db from `@everyskill/db` (the client)
   - Import sql from drizzle-orm
   - Query distinct community_ids for tenant: `SELECT DISTINCT community_id FROM skill_communities WHERE tenant_id = $1`
   - For each community_id:
     a. Fetch member skills: `SELECT s.name, s.description, s.category FROM skill_communities sc JOIN skills s ON s.id = sc.skill_id WHERE sc.tenant_id = $1 AND sc.community_id = $2 AND s.status = 'published'`
     b. Call `generateCommunityLabel(skills)`
     c. UPDATE all rows: `UPDATE skill_communities SET community_label = $1, community_description = $2 WHERE tenant_id = $3 AND community_id = $4`
   - Wrap each community's label generation in try/catch -- log warning and continue if one fails
   - Return count of labeled communities

3. Update `apps/web/app/api/cron/community-detection/route.ts`:
   - Import `generateAndPersistCommunityLabels` from `@/lib/community-label-generator`
   - After the existing `detectCommunities(tenantId)` call succeeds (and result is not skipped and communities > 0), call `await generateAndPersistCommunityLabels(tenantId)`
   - Add the label count to the JSON response
   - Log: `[COMMUNITY DETECTION] Generated labels for N communities`
  </action>
  <verify>
    - `pnpm turbo typecheck` passes
    - `pnpm lint` passes (no lint errors)
    - Curl the cron endpoint (with CRON_SECRET) and verify labels are generated:
      `curl -s -H "Authorization: Bearer $(grep CRON_SECRET /home/dev/projects/relay/apps/web/.env.local | cut -d= -f2)" "http://localhost:2002/api/cron/community-detection" | jq .`
    - Verify labels persisted: `psql everyskill -c "SELECT community_id, community_label, community_description FROM skill_communities WHERE community_label IS NOT NULL GROUP BY community_id, community_label, community_description"`
  </verify>
  <done>AI label generator creates descriptive names and summaries for each community. Cron endpoint automatically generates labels after detection. Labels persisted in DB and queryable.</done>
</task>

</tasks>

<verification>
- Migration 0041 applied, columns exist
- Both query functions type-check and are exported
- AI labels generated for all 4 communities in dev DB
- Cron endpoint runs full pipeline: detect + label
</verification>

<success_criteria>
- skill_communities table has community_label and community_description columns
- getCommunities returns community list with labels, descriptions, member counts, top skills
- getCommunityDetail returns skills ranked by centroid similarity with percentage scores
- generateCommunityLabel produces AI-generated name+description via Haiku
- Cron endpoint triggers label generation after detection
</success_criteria>

<output>
After completion, create `.planning/phases/73-community-discovery-ui/73-01-SUMMARY.md`
</output>
