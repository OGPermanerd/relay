---
phase: 50-gmail-oauth-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["50-01", "50-02"]
files_modified:
  - apps/web/app/(protected)/settings/connections/page.tsx
  - apps/web/app/(protected)/settings/connections/gmail-connection-card.tsx
  - apps/web/app/(protected)/settings/settings-nav.tsx
  - apps/web/components/admin-settings-form.tsx
  - apps/web/app/actions/admin-settings.ts
autonomous: true

must_haves:
  truths:
    - "User sees Connections tab in settings nav"
    - "Settings/connections page shows Gmail connection status"
    - "Connected state shows email, connected date, and Disconnect button"
    - "Disconnected state shows Connect Gmail button that navigates to /api/gmail/connect"
    - "Feature-disabled state shows informational message when admin has not enabled Gmail"
    - "Admin can toggle gmailDiagnosticEnabled from admin settings form"
    - "When admin disables feature, Connect Gmail option is hidden for users"
  artifacts:
    - path: "apps/web/app/(protected)/settings/connections/page.tsx"
      provides: "Settings connections page (server component)"
      contains: "GmailConnectionCard"
    - path: "apps/web/app/(protected)/settings/connections/gmail-connection-card.tsx"
      provides: "Client component showing connect/disconnect/status"
      contains: "use client"
    - path: "apps/web/app/(protected)/settings/settings-nav.tsx"
      provides: "Updated nav with Connections tab"
      contains: "Connections"
  key_links:
    - from: "apps/web/app/(protected)/settings/connections/page.tsx"
      to: "/api/gmail/status"
      via: "Server-side check or direct DB query for initial state"
      pattern: "hasActiveGmailConnection|getSiteSettings"
    - from: "apps/web/app/(protected)/settings/connections/gmail-connection-card.tsx"
      to: "/api/gmail/connect"
      via: "Link or window.location for OAuth redirect"
      pattern: "/api/gmail/connect"
    - from: "apps/web/app/(protected)/settings/connections/gmail-connection-card.tsx"
      to: "/api/gmail/disconnect"
      via: "fetch POST for disconnect action"
      pattern: "/api/gmail/disconnect"
---

<objective>
Build the settings connections UI page with Gmail connect/disconnect card, update settings nav, and add admin toggle for Gmail diagnostic feature.

Purpose: Users need a UI to connect/disconnect Gmail, see connection status, and admins need to control feature availability.
Output: Connections settings page, Gmail connection card component, updated settings nav, admin toggle.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/app/(protected)/settings/settings-nav.tsx
@apps/web/app/(protected)/settings/layout.tsx
@apps/web/components/admin-settings-form.tsx
@apps/web/app/actions/admin-settings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Settings connections page and Gmail connection card</name>
  <files>
    apps/web/app/(protected)/settings/connections/page.tsx
    apps/web/app/(protected)/settings/connections/gmail-connection-card.tsx
    apps/web/app/(protected)/settings/settings-nav.tsx
  </files>
  <action>
    1. Update `apps/web/app/(protected)/settings/settings-nav.tsx`:
       - Add `{ label: "Connections", href: "/settings/connections" }` to the tabs array, placing it between "Preferences" and "Notifications"

    2. Create `apps/web/app/(protected)/settings/connections/page.tsx` (server component):
       - Import `auth` from "@/auth", `redirect` from "next/navigation"
       - Import `hasActiveGmailConnection`, `getSiteSettings` from "@everyskill/db"
       - Import `GmailConnectionCard` from "./gmail-connection-card"
       - Get session. If no session.user.id or no tenantId, redirect("/login")
       - Fetch site settings for tenant: `getSiteSettings(session.user.tenantId)`
       - Check if feature enabled: `settings?.gmailDiagnosticEnabled ?? false`
       - If enabled, check connection: `hasActiveGmailConnection(session.user.id)`
       - Get searchParams from page props for query params (connected, error)
       - Render:
         ```
         <div>
           <h2 className="text-lg font-semibold text-gray-900">Connected Accounts</h2>
           <p className="mt-1 text-sm text-gray-600">Manage your external service connections</p>
           <div className="mt-6">
             <GmailConnectionCard
               enabled={featureEnabled}
               connected={connected}
               successMessage={searchParams.connected === "true" ? "Gmail connected successfully" : undefined}
               errorMessage={errorMessage based on searchParams.error}
             />
           </div>
         </div>
         ```
       - Map error codes to user-friendly messages: invalid_state -> "OAuth state mismatch. Please try again.", gmail_scope_denied -> "Gmail access was not granted. Please allow the Gmail permission to continue.", token_exchange_failed -> "Failed to connect Gmail. Please try again.", feature_disabled -> "Gmail integration is not enabled for your organization.", no_code -> "Authorization was cancelled."

    3. Create `apps/web/app/(protected)/settings/connections/gmail-connection-card.tsx` ("use client"):
       - Props: `{ enabled: boolean, connected: boolean, successMessage?: string, errorMessage?: string }`
       - Use `useState` for `disconnecting` loading state and `useRouter` for refresh after disconnect
       - Render a card with: Gmail icon (use an inline SVG or just a colored circle with "G"), title "Gmail", description "Connect your Gmail to analyze email patterns and get personalized skill recommendations"
       - Three states:
         a) **Feature disabled** (`!enabled`): Show muted card with message "Gmail diagnostics is not enabled for your organization. Contact your admin to enable this feature."
         b) **Not connected** (`enabled && !connected`): Show a "Connect Gmail" link/button that navigates to `/api/gmail/connect`. Use `<a href="/api/gmail/connect">` (NOT next/link -- this is an API redirect, not a page navigation). Style as primary blue button.
         c) **Connected** (`enabled && connected`): Show green "Connected" badge, "Disconnect" button (red/destructive style). On disconnect click: `fetch("/api/gmail/disconnect", { method: "POST" })`, then `router.refresh()` to re-render server component.
       - Show successMessage in green alert if present
       - Show errorMessage in red alert if present
       - Card styling: border rounded-lg, padding, consistent with other settings pages (Tailwind)
  </action>
  <verify>
    Run `cd /home/dev/projects/relay/apps/web && npx next build` to verify pages compile.
    Start dev server if not running, then navigate to http://localhost:2002/settings/connections and verify page loads.
    Run relevant E2E tests: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/home.spec.ts` to verify no regressions on navigation.
  </verify>
  <done>
    Settings nav shows "Connections" tab. /settings/connections page renders with Gmail connection card. Card shows correct state based on feature toggle and connection status. Build passes. No E2E regressions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin toggle for Gmail diagnostic feature</name>
  <files>
    apps/web/components/admin-settings-form.tsx
    apps/web/app/actions/admin-settings.ts
  </files>
  <action>
    1. Update `apps/web/app/actions/admin-settings.ts` -- in `saveSettingsAction`:
       - Parse `gmailDiagnosticEnabled` from formData: `const gmailDiagnosticEnabled = formData.get("gmailDiagnosticEnabled") === "on";`
       - Add `gmailDiagnosticEnabled` to the `updateSiteSettings()` call alongside existing fields
       - Add revalidatePath("/settings/connections") after the existing revalidatePath("/admin/settings")

    2. Update `apps/web/components/admin-settings-form.tsx`:
       - Add `gmailDiagnosticEnabled: boolean` to the `initialSettings` interface (with default `false`)
       - Add a new section in the form (after existing sections, before the save button) with heading "Gmail Diagnostics":
         ```
         <div className="border-t pt-6 mt-6">
           <h3 className="text-sm font-medium text-gray-900">Gmail Diagnostics</h3>
           <p className="text-sm text-gray-500 mt-1">Allow users to connect their Gmail and receive personalized skill recommendations based on email patterns.</p>
           <label className="flex items-center gap-2 mt-3">
             <input type="checkbox" name="gmailDiagnosticEnabled" defaultChecked={defaults.gmailDiagnosticEnabled} className="..." />
             <span className="text-sm text-gray-700">Enable Gmail diagnostic feature</span>
           </label>
         </div>
         ```
       - Also update the `defaults` fallback object to include `gmailDiagnosticEnabled: false`

    3. Update the admin settings page that renders AdminSettingsForm (find where initialSettings is constructed and add gmailDiagnosticEnabled from the settings query). Check `apps/web/app/(protected)/admin/settings/page.tsx` or wherever AdminSettingsForm is rendered -- add `gmailDiagnosticEnabled: settings?.gmailDiagnosticEnabled ?? false` to initialSettings prop.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay/apps/web && npx next build` to verify compile.
    Navigate to admin settings page and verify Gmail Diagnostics toggle appears.
  </verify>
  <done>
    Admin settings form has Gmail Diagnostics toggle. Saving the form persists gmailDiagnosticEnabled to site_settings. When enabled, users see Connect Gmail on /settings/connections. When disabled, card shows feature-not-enabled message. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build --filter web` passes
2. /settings/connections page loads and shows Gmail connection card
3. Settings nav has Connections tab between Preferences and Notifications
4. Admin settings form has Gmail Diagnostics toggle
5. When admin disables feature, connections page shows disabled message
6. No E2E test regressions
</verification>

<success_criteria>
- User can navigate to /settings/connections and see Gmail connection card
- Card shows three states correctly: disabled, not connected, connected
- Connect button links to /api/gmail/connect
- Disconnect button calls /api/gmail/disconnect and refreshes
- Admin can toggle gmail_diagnostic_enabled from admin settings
- Error/success messages display from query params
- All existing E2E tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/50-gmail-oauth-infrastructure/50-03-SUMMARY.md`
</output>
