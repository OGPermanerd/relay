---
phase: 50-gmail-oauth-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["50-01"]
files_modified:
  - apps/web/lib/gmail-oauth.ts
  - apps/web/app/api/gmail/connect/route.ts
  - apps/web/app/api/gmail/callback/route.ts
  - apps/web/app/api/gmail/disconnect/route.ts
  - apps/web/app/api/gmail/status/route.ts
  - apps/web/middleware.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/gmail/connect redirects authenticated user to Google OAuth with gmail.readonly scope"
    - "GET /api/gmail/callback exchanges code for tokens, verifies scope includes gmail.readonly, stores encrypted tokens"
    - "POST /api/gmail/disconnect revokes token with Google and deletes from DB"
    - "GET /api/gmail/status returns { enabled, connected } based on admin toggle and user connection"
    - "Middleware exempts only /api/gmail/callback (other gmail routes require session)"
  artifacts:
    - path: "apps/web/lib/gmail-oauth.ts"
      provides: "OAuth2Client factory and redirect URI helper"
      exports: ["createGmailOAuth2Client", "getGmailRedirectUri"]
    - path: "apps/web/app/api/gmail/connect/route.ts"
      provides: "OAuth initiation with state cookie"
      exports: ["GET"]
    - path: "apps/web/app/api/gmail/callback/route.ts"
      provides: "OAuth callback with code exchange and scope verification"
      exports: ["GET"]
    - path: "apps/web/app/api/gmail/disconnect/route.ts"
      provides: "Token revocation and deletion"
      exports: ["POST"]
    - path: "apps/web/app/api/gmail/status/route.ts"
      provides: "Connection status check"
      exports: ["GET"]
  key_links:
    - from: "apps/web/app/api/gmail/callback/route.ts"
      to: "packages/db/src/services/gmail-tokens.ts"
      via: "upsertGmailTokens import"
      pattern: "upsertGmailTokens"
    - from: "apps/web/app/api/gmail/disconnect/route.ts"
      to: "packages/db/src/services/gmail-tokens.ts"
      via: "getGmailTokenDecrypted + deleteGmailTokens"
      pattern: "deleteGmailTokens"
    - from: "apps/web/app/api/gmail/status/route.ts"
      to: "packages/db/src/services/site-settings.ts"
      via: "getSiteSettings for admin toggle check"
      pattern: "getSiteSettings"
    - from: "apps/web/middleware.ts"
      to: "/api/gmail/callback"
      via: "exempt path check"
      pattern: "gmail/callback"
---

<objective>
Create the four Gmail OAuth API routes (connect, callback, disconnect, status) and update middleware to exempt the callback route.

Purpose: These routes implement the actual OAuth flow -- initiating consent, handling Google's redirect, revoking tokens, and checking status.
Output: 4 API route files, 1 OAuth utility file, updated middleware.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gmail OAuth client factory and API routes</name>
  <files>
    apps/web/lib/gmail-oauth.ts
    apps/web/app/api/gmail/connect/route.ts
    apps/web/app/api/gmail/callback/route.ts
    apps/web/app/api/gmail/disconnect/route.ts
    apps/web/app/api/gmail/status/route.ts
    apps/web/middleware.ts
  </files>
  <action>
    First install the dependency: `pnpm --filter web add google-auth-library`

    1. Create `apps/web/lib/gmail-oauth.ts`:
       - Import `OAuth2Client` from "google-auth-library"
       - `getGmailRedirectUri(): string` -- returns `${process.env.NEXTAUTH_URL}/api/gmail/callback`
       - `createGmailOAuth2Client(): OAuth2Client` -- creates client with AUTH_GOOGLE_ID, AUTH_GOOGLE_SECRET, and redirect URI from getGmailRedirectUri()
       - Export both functions

    2. Create `apps/web/app/api/gmail/connect/route.ts` (GET handler):
       - Import `auth` from "@/auth", `NextRequest`, `NextResponse` from "next/server", `createGmailOAuth2Client` from "@/lib/gmail-oauth", `getSiteSettings` from "@everyskill/db"
       - Get session via `auth()`. If no session.user.id or no session.user.tenantId, redirect to "/login"
       - Check admin toggle: `getSiteSettings(session.user.tenantId)`. If `!settings?.gmailDiagnosticEnabled`, redirect to "/settings/connections?error=feature_disabled"
       - Generate state: `Buffer.from(JSON.stringify({ userId: session.user.id, csrf: crypto.randomUUID() })).toString("base64url")`
       - Create OAuth2Client, generate authorize URL with: `access_type: "offline"`, `prompt: "consent"`, `scope: ["https://www.googleapis.com/auth/gmail.readonly"]`, `state`, `login_hint: session.user.email ?? undefined`, `include_granted_scopes: false`
       - Set `gmail_oauth_state` httpOnly cookie with the state value, maxAge 600 (10 min), sameSite "lax", secure in production, path "/"
       - Return NextResponse.redirect(authorizeUrl)

    3. Create `apps/web/app/api/gmail/callback/route.ts` (GET handler):
       - Import auth, NextRequest, NextResponse, createGmailOAuth2Client, upsertGmailTokens from "@everyskill/db"
       - Get session via auth(). If no session.user.id or no tenantId, redirect to "/login"
       - Parse searchParams: code, state, error, scope
       - Verify state matches `gmail_oauth_state` cookie. If mismatch, redirect to "/settings/connections?error=invalid_state"
       - If error param present or no code, redirect to "/settings/connections?error={error || 'no_code'}"
       - Check scope includes "gmail.readonly". If not, redirect to "/settings/connections?error=gmail_scope_denied"
       - Exchange code for tokens: `oauth2Client.getToken(code)` -- wrap in try/catch
       - Call `upsertGmailTokens({ userId: session.user.id, tenantId: session.user.tenantId, accessToken: tokens.access_token!, refreshToken: tokens.refresh_token!, expiresAt: new Date(tokens.expiry_date!), scope: tokens.scope! })`
       - Delete the gmail_oauth_state cookie
       - Redirect to "/settings/connections?connected=true"
       - On any error in token exchange: redirect to "/settings/connections?error=token_exchange_failed"

    4. Create `apps/web/app/api/gmail/disconnect/route.ts` (POST handler):
       - Import auth, NextResponse, getGmailTokenDecrypted and deleteGmailTokens from "@everyskill/db"
       - Get session. If no session.user.id, return 401 JSON
       - Get decrypted token via getGmailTokenDecrypted(session.user.id)
       - If token exists: try to revoke with Google POST to `https://oauth2.googleapis.com/revoke?token=${token.accessToken}` with Content-Type "application/x-www-form-urlencoded" (wrap in try/catch, non-fatal)
       - Delete tokens: `deleteGmailTokens(session.user.id)`
       - Return `NextResponse.json({ disconnected: true })`

    5. Create `apps/web/app/api/gmail/status/route.ts` (GET handler):
       - Import auth, NextResponse, hasActiveGmailConnection and getSiteSettings from "@everyskill/db"
       - Get session. If no session.user.id or no tenantId, return 401 JSON
       - Get site settings for tenant. If `!settings?.gmailDiagnosticEnabled`, return `{ enabled: false, connected: false }`
       - Check connection: `hasActiveGmailConnection(session.user.id)`
       - Return `{ enabled: true, connected }`

    6. Update `apps/web/middleware.ts`:
       - Add `/api/gmail/callback` to the exempt paths block. Add the line:
         `pathname === "/api/gmail/callback" ||`
       - Place it after the `/api/auth` check. ONLY exempt callback -- connect, disconnect, status routes need authentication (they call `auth()` internally but middleware's cookie check ensures they're behind the login wall).
  </action>
  <verify>
    Run `cd /home/dev/projects/relay/apps/web && npx next build` (or `pnpm build --filter web`) to verify all routes compile.
    Verify middleware change: `grep "gmail/callback" /home/dev/projects/relay/apps/web/middleware.ts`
    Verify routes exist: `ls /home/dev/projects/relay/apps/web/app/api/gmail/*/route.ts`
  </verify>
  <done>
    All 4 Gmail API routes compile and export correct HTTP methods. OAuth client factory is reusable. Middleware exempts only /api/gmail/callback. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build --filter web` passes
2. All 4 route files exist under apps/web/app/api/gmail/
3. Middleware exempts /api/gmail/callback but NOT connect/disconnect/status
4. google-auth-library is in apps/web package.json dependencies
</verification>

<success_criteria>
- /api/gmail/connect generates Google OAuth URL with gmail.readonly scope and state cookie
- /api/gmail/callback verifies state, checks scope, exchanges code, stores encrypted tokens
- /api/gmail/disconnect revokes with Google (best-effort) and deletes tokens
- /api/gmail/status checks admin toggle and user connection status
- Middleware exempts only the callback route
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/50-gmail-oauth-infrastructure/50-02-SUMMARY.md`
</output>
