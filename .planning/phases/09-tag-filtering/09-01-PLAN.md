---
phase: 09-tag-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/skills.ts
  - packages/db/src/seed.ts
  - apps/web/lib/search-skills.ts
autonomous: true

must_haves:
  truths:
    - "User sees a list of available tags on the browse page"
    - "User can select one or more tags to filter the skill list"
    - "Tag filtering works together with category dropdown and search input"
    - "Selecting tags updates URL state (shareable filtered views)"
  artifacts:
    - path: "packages/db/src/schema/skills.ts"
      provides: "Tags column in skills table"
      contains: "tags.*text.*array"
    - path: "apps/web/lib/search-skills.ts"
      provides: "Working tag query and filter functions"
      exports: ["searchSkills", "getAvailableTags"]
  key_links:
    - from: "apps/web/lib/search-skills.ts"
      to: "skills.tags"
      via: "getAvailableTags query"
      pattern: "skills\\.tags"
    - from: "apps/web/lib/search-skills.ts"
      to: "skills.tags"
      via: "searchSkills filter"
      pattern: "arrayContains|arrayOverlaps|@>"
---

<objective>
Implement backend tag storage and filtering for the existing tag filter UI.

Purpose: The TagFilter component already exists and works, but `getAvailableTags()` returns an empty array and tag filtering in `searchSkills()` is a no-op. This plan adds the database column and implements the backend queries.

Output: Working tag filtering that surfaces tags to the UI and filters skills when tags are selected.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Source files to modify
@packages/db/src/schema/skills.ts
@packages/db/src/seed.ts
@apps/web/lib/search-skills.ts

# UI already exists - reference only
@apps/web/components/tag-filter.tsx
@apps/web/app/(protected)/skills/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tags column to skills schema and seed data</name>
  <files>
    packages/db/src/schema/skills.ts
    packages/db/src/seed.ts
  </files>
  <action>
1. In `packages/db/src/schema/skills.ts`:
   - Import `text` from drizzle-orm/pg-core (already imported)
   - Add `tags` column after `category` column:
     ```typescript
     tags: text("tags").array().default([]),
     ```
   - This creates a TEXT[] column with empty array default

2. In `packages/db/src/seed.ts`:
   - Add tags to each test skill in the `testSkills` array:
     - Code Review Assistant: `["code-review", "best-practices", "security"]`
     - API Documentation Generator: `["documentation", "api", "automation"]`
     - Test Writer: `["testing", "automation", "tdd"]`

3. Run schema migration:
   ```bash
   cd packages/db
   pnpm drizzle-kit generate
   pnpm drizzle-kit push
   ```

4. Re-seed to populate tags:
   ```bash
   pnpm db:seed
   ```

Note: Using TEXT[] instead of JSONB because:
- Tags are simple string arrays, not nested objects
- PostgreSQL array operators (@> containment) work directly
- Simpler type inference in Drizzle
  </action>
  <verify>
1. Check schema file has tags column: `grep "tags.*text.*array" packages/db/src/schema/skills.ts`
2. Verify migration ran: Check that drizzle-kit push succeeds without errors
3. Verify seed includes tags: Query database with `SELECT name, tags FROM skills LIMIT 3`
  </verify>
  <done>
- Skills table has `tags` TEXT[] column
- Seed skills have sample tags assigned
- Database schema is migrated and seeded
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement tag queries in search-skills.ts</name>
  <files>
    apps/web/lib/search-skills.ts
  </files>
  <action>
1. Update `getAvailableTags()` function to query distinct tags:
   ```typescript
   export async function getAvailableTags(): Promise<string[]> {
     if (!db) return [];

     // Use unnest to flatten arrays, then select distinct
     const result = await db.execute(
       sql`SELECT DISTINCT unnest(tags) as tag FROM skills WHERE tags IS NOT NULL ORDER BY tag`
     );

     return result.rows.map((row: any) => row.tag as string);
   }
   ```

2. Update `searchSkills()` to filter by tags:
   - Replace the TODO comment block (lines ~55-62) with actual filtering:
   ```typescript
   // Tag filtering - match skills containing ANY of the selected tags
   if (params.tags && params.tags.length > 0) {
     conditions.push(
       sql`${skills.tags} && ${params.tags}::text[]`
     );
   }
   ```

   The `&&` operator checks for array overlap (ANY tag matches).
   Alternative: Use `@>` for ALL tags must match, but ANY is more user-friendly.

3. Import `sql` if not already imported (it is already imported from drizzle-orm)

Note: The UI component (TagFilter) already handles:
- Displaying tags as chips
- Toggle selection via nuqs URL state
- Passing tags to searchSkills via URL params
- Rendering nothing if availableTags is empty

The UI will "just work" once these backend functions return real data.
  </action>
  <verify>
1. TypeScript compiles: `cd apps/web && pnpm tsc --noEmit`
2. Manual test: Start dev server, navigate to /skills
   - Tags should appear as filter chips
   - Clicking a tag should filter the list
   - URL should update with ?tags=tag1,tag2
3. Combined filtering: Apply tag + category + search, verify results narrow correctly
  </verify>
  <done>
- `getAvailableTags()` returns unique tags from all skills
- `searchSkills()` filters by tags when provided
- TagFilter component displays and works on browse page
- URL state updates when tags are selected
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Tag display**: Visit /skills, tags appear as clickable chips
2. **Single tag filter**: Click "testing" tag, only Test Writer skill shows
3. **Multi-tag filter**: Click "automation" + "api", shows API Doc Generator
4. **Combined filters**: Select "prompt" category + "security" tag, shows Code Review Assistant
5. **URL state**: Tags are reflected in URL as `?tags=testing,automation`
6. **Page refresh**: Reload page with tags in URL, filter persists
</verification>

<success_criteria>
- [ ] Tags column exists in skills table (TEXT[])
- [ ] Seed data includes sample tags for test skills
- [ ] `getAvailableTags()` returns non-empty array of unique tags
- [ ] `searchSkills({tags: ['testing']})` filters to matching skills
- [ ] Browse page shows tag filter chips
- [ ] Clicking tags filters the skill list
- [ ] Tag selection persists in URL
- [ ] Tag filtering combines with category and search filters
</success_criteria>

<output>
After completion, create `.planning/phases/09-tag-filtering/09-01-SUMMARY.md`
</output>
