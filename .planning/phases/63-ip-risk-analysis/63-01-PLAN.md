---
phase: 63-ip-risk-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/ip-dashboard-queries.ts
  - apps/web/hooks/use-analytics-sort.ts
  - apps/web/app/actions/get-employee-risk-skills.ts
autonomous: true

must_haves:
  truths:
    - "At-risk skills (single-author, high-usage, no forks) can be queried by tenant"
    - "Employees can be ranked by IP concentration risk (how many at-risk skills they solely own)"
    - "Individual employee drill-down returns their specific at-risk skills on demand"
  artifacts:
    - path: "apps/web/lib/ip-dashboard-queries.ts"
      provides: "getAtRiskSkillAlerts, getIpRiskEmployees, getEmployeeAtRiskSkills queries + types + threshold constants"
      contains: "HIGH_USAGE_THRESHOLD"
    - path: "apps/web/app/actions/get-employee-risk-skills.ts"
      provides: "fetchEmployeeRiskSkills server action with auth guard"
      contains: "use server"
    - path: "apps/web/hooks/use-analytics-sort.ts"
      provides: "useIpRiskSortState hook for risk table column sorting"
      contains: "IP_RISK_SORT_COLUMNS"
  key_links:
    - from: "apps/web/app/actions/get-employee-risk-skills.ts"
      to: "apps/web/lib/ip-dashboard-queries.ts"
      via: "imports getEmployeeAtRiskSkills"
      pattern: "getEmployeeAtRiskSkills"
---

<objective>
Add IP risk analysis query functions, server action, and sort hook for the IP dashboard.

Purpose: Provide the data layer for Phase 63's IP concentration risk section -- three SQL query functions that identify at-risk skills (single-author, high-usage, no forks), rank employees by IP concentration, and support per-employee drill-down. Plus the server action and sort hook the UI will consume.

Output: Three new query functions + types + constants in ip-dashboard-queries.ts, a server action in get-employee-risk-skills.ts, and a new useIpRiskSortState hook in use-analytics-sort.ts.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-ip-risk-analysis/63-RESEARCH.md
@apps/web/lib/ip-dashboard-queries.ts
@apps/web/hooks/use-analytics-sort.ts
@apps/web/app/actions/get-employee-activity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add risk query functions and types to ip-dashboard-queries.ts</name>
  <files>apps/web/lib/ip-dashboard-queries.ts</files>
  <action>
Add to the EXISTING ip-dashboard-queries.ts file (do NOT create a new file):

1. Add threshold constants at the top of the file (after the existing imports):
   - `export const HIGH_USAGE_THRESHOLD = 10;`
   - `export const CRITICAL_USAGE_THRESHOLD = 50;`

2. Add three new TypeScript interfaces in the Types section:
   - `AtRiskSkillAlert`: skillId, skillName, category, authorId, authorName (string|null), totalUses, hoursSavedPerUse, riskLevel ("critical"|"high")
   - `IpRiskEmployee`: userId, name (string|null), email, image (string|null), atRiskSkillCount, totalAtRiskUses, totalAtRiskHoursSaved, highestRiskSeverity (number), riskLevel ("critical"|"high"|"medium")
   - `EmployeeAtRiskSkill`: skillId, skillName, slug, category, totalUses, hoursSavedPerUse, riskLevel ("critical"|"high")

3. Add three query functions following the existing db.execute(sql`...`) pattern:

   a. `getAtRiskSkillAlerts(tenantId: string): Promise<AtRiskSkillAlert[]>`
      - SELECT published skills where: author_id IS NOT NULL, total_uses >= HIGH_USAGE_THRESHOLD, no published forks exist (NOT EXISTS subquery with tenant_id filter on both outer and inner query)
      - JOIN users for author name
      - ORDER BY total_uses DESC, LIMIT 20
      - Map riskLevel in TypeScript: total_uses >= CRITICAL_USAGE_THRESHOLD ? "critical" : "high"
      - Return empty array if !db

   b. `getIpRiskEmployees(tenantId: string): Promise<IpRiskEmployee[]>`
      - Same WHERE conditions as above, GROUP BY user
      - COUNT(*) as at_risk_skill_count, SUM(total_uses) as total_at_risk_uses, SUM(COALESCE(hours_saved,1)*total_uses) as total_at_risk_hours_saved
      - IMPORTANT: Use numeric severity for MAX: `MAX(CASE WHEN total_uses >= CRITICAL_USAGE_THRESHOLD THEN 3 WHEN total_uses >= HIGH_USAGE_THRESHOLD THEN 2 ELSE 1 END)::integer` to avoid alphabetical string ordering bug
      - Map riskLevel in TypeScript from numeric severity (3=critical, 2=high, 1=medium)
      - ORDER BY total_at_risk_uses DESC

   c. `getEmployeeAtRiskSkills(tenantId: string, userId: string): Promise<EmployeeAtRiskSkill[]>`
      - Same base WHERE + NOT EXISTS fork check, plus author_id = userId filter
      - Include slug for skill links
      - ORDER BY total_uses DESC

   IMPORTANT: Every subquery MUST include `AND fork.tenant_id = tenantId` for tenant isolation. Use the parameterized sql template tag for all values (never sql.raw for user inputs). Cast aggregates appropriately (::integer, ::double precision).
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30` to verify no type errors in the file.</verify>
  <done>Three new query functions + interfaces + threshold constants exist in ip-dashboard-queries.ts, all following the established db.execute(sql`...`) pattern with proper tenant isolation.</done>
</task>

<task type="auto">
  <name>Task 2: Add server action and sort hook</name>
  <files>
    apps/web/app/actions/get-employee-risk-skills.ts
    apps/web/hooks/use-analytics-sort.ts
  </files>
  <action>
1. Create NEW file `apps/web/app/actions/get-employee-risk-skills.ts`:
   - "use server" directive at top
   - Import auth from "@/auth"
   - Import getEmployeeAtRiskSkills from "@/lib/ip-dashboard-queries"
   - Do NOT re-export types from this file (causes bundler errors per project conventions)
   - Export async function `fetchEmployeeRiskSkills(userId: string)` that:
     a. Calls auth() and checks session?.user?.tenantId, throws "Unauthorized" if missing
     b. Calls and returns getEmployeeAtRiskSkills(session.user.tenantId, userId)
   - Follow the exact pattern from get-employee-activity.ts

2. Add to EXISTING `apps/web/hooks/use-analytics-sort.ts`:
   - Add IP Risk sort columns constant:
     ```
     export const IP_RISK_SORT_COLUMNS = ["name", "atRiskSkillCount", "totalAtRiskUses", "totalAtRiskHoursSaved", "riskLevel"] as const;
     export type IpRiskSortColumn = (typeof IP_RISK_SORT_COLUMNS)[number];
     ```
   - Add `useIpRiskSortState()` hook following the exact pattern of useEmployeeSortState/useSkillSortState:
     - URL params: "riskSort" and "riskDir"
     - Default sort: "totalAtRiskUses" descending
     - Returns { sortBy, sortDir, isPending, toggleSort }
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30` to verify no type errors.</verify>
  <done>Server action fetchEmployeeRiskSkills exists with auth guard, useIpRiskSortState hook provides URL-persisted sort state for the risk table.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for the web app with no errors related to ip-dashboard-queries, get-employee-risk-skills, or use-analytics-sort
2. ip-dashboard-queries.ts exports: HIGH_USAGE_THRESHOLD, CRITICAL_USAGE_THRESHOLD, AtRiskSkillAlert, IpRiskEmployee, EmployeeAtRiskSkill, getAtRiskSkillAlerts, getIpRiskEmployees, getEmployeeAtRiskSkills
3. get-employee-risk-skills.ts exports fetchEmployeeRiskSkills with "use server" directive
4. use-analytics-sort.ts exports IP_RISK_SORT_COLUMNS, IpRiskSortColumn, useIpRiskSortState
</verification>

<success_criteria>
All three query functions compile and export correct types. Server action has auth guard. Sort hook follows nuqs pattern. No type errors.
</success_criteria>

<output>
After completion, create `.planning/phases/63-ip-risk-analysis/63-01-SUMMARY.md`
</output>
