---
phase: 63-ip-risk-analysis
plan: 02
type: execute
wave: 2
depends_on: ["63-01"]
files_modified:
  - apps/web/components/ip-risk-section.tsx
  - apps/web/components/ip-dashboard-view.tsx
  - apps/web/app/(protected)/leverage/ip-dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees proactive risk alert cards with red/amber severity indicators on the IP dashboard (not hidden behind a click)"
    - "Admin sees an employee risk ranking table with sortable columns showing IP concentration"
    - "Admin can click any employee row to drill down into their specific at-risk skills in a modal"
    - "Risk section appears between hero stat cards and quality trends chart"
  artifacts:
    - path: "apps/web/components/ip-risk-section.tsx"
      provides: "IpRiskSection component with alert cards, sortable employee table, and drill-down modal"
      contains: "IpRiskSection"
    - path: "apps/web/components/ip-dashboard-view.tsx"
      provides: "Updated view passing risk data to IpRiskSection between stat cards and quality chart"
      contains: "IpRiskSection"
    - path: "apps/web/app/(protected)/leverage/ip-dashboard/page.tsx"
      provides: "Updated page fetching risk data via Promise.all"
      contains: "getIpRiskEmployees"
  key_links:
    - from: "apps/web/app/(protected)/leverage/ip-dashboard/page.tsx"
      to: "apps/web/lib/ip-dashboard-queries.ts"
      via: "imports getIpRiskEmployees and getAtRiskSkillAlerts"
      pattern: "getIpRiskEmployees|getAtRiskSkillAlerts"
    - from: "apps/web/components/ip-risk-section.tsx"
      to: "apps/web/app/actions/get-employee-risk-skills.ts"
      via: "calls fetchEmployeeRiskSkills for drill-down modal"
      pattern: "fetchEmployeeRiskSkills"
    - from: "apps/web/components/ip-dashboard-view.tsx"
      to: "apps/web/components/ip-risk-section.tsx"
      via: "renders IpRiskSection with risk data props"
      pattern: "IpRiskSection"
---

<objective>
Build the IP Risk Section UI component and wire it into the existing IP dashboard page.

Purpose: Give admins a proactive view of IP concentration risks -- alert cards for the most dangerous single-author skills, a sortable employee risk ranking table, and a drill-down modal showing each employee's at-risk skills. This fulfills all four Phase 63 success criteria.

Output: New ip-risk-section.tsx component, updated ip-dashboard-view.tsx and page.tsx to fetch and display risk data.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-ip-risk-analysis/63-RESEARCH.md
@.planning/phases/63-ip-risk-analysis/63-01-SUMMARY.md
@apps/web/components/ip-dashboard-view.tsx
@apps/web/app/(protected)/leverage/ip-dashboard/page.tsx
@apps/web/components/employees-tab.tsx
@apps/web/components/employee-detail-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IpRiskSection component</name>
  <files>apps/web/components/ip-risk-section.tsx</files>
  <action>
Create NEW file `apps/web/components/ip-risk-section.tsx` as a "use client" component.

Import types from "@/lib/ip-dashboard-queries" (AtRiskSkillAlert, IpRiskEmployee, EmployeeAtRiskSkill, HIGH_USAGE_THRESHOLD, CRITICAL_USAGE_THRESHOLD).
Import fetchEmployeeRiskSkills from "@/app/actions/get-employee-risk-skills".
Import useIpRiskSortState and IpRiskSortColumn from "@/hooks/use-analytics-sort".
Import Image from "next/image", Link from "next/link", useState/useMemo/useEffect from "react".

The component has THREE sections:

**1. Risk Alert Cards (proactive, always visible at top)**
- Props: `atRiskAlerts: AtRiskSkillAlert[]`
- Show top alerts as styled cards (max 5 visible, with "and X more" text if truncated)
- Each card: skill name, author name, total uses count, hours_saved_per_use, risk badge
- Critical alerts: red border/background (`border-red-200 bg-red-50`), red badge
- High alerts: amber border/background (`border-amber-200 bg-amber-50`), amber badge
- Include a warning icon (SVG) and explanatory text: "Single author, high usage, no forks"
- If no alerts, show dashed-border empty state: "No key person dependency risks detected"
- Section heading: "Key Person Dependency Alerts" with count badge

**2. Employee IP Concentration Risk Table (sortable)**
- Props: `riskEmployees: IpRiskEmployee[]`
- Use useIpRiskSortState() for URL-persisted sorting
- Sortable columns: Employee (name), At-Risk Skills (count), Total At-Risk Uses, Hours at Risk, Risk Level
- Follow employees-tab.tsx pattern EXACTLY for sort header arrows and click handlers
- Client-side sorting in useMemo (data is small, no need for server-side sort)
- Row click opens drill-down modal (set selectedEmployee state)
- Risk level column: render RiskBadge inline span with appropriate colors
- Avatar + name in Employee column (Image component with fallback to initials, same as employees-tab)
- Section heading: "IP Concentration by Employee"
- Empty state if no employees at risk

**3. Drill-Down Modal (on-demand via server action)**
- Triggered when selectedEmployee is set (click table row)
- Follow employee-detail-modal.tsx pattern: fixed overlay, backdrop click-to-close, scrollable content
- On open: call fetchEmployeeRiskSkills(employee.userId) via useEffect
- Loading state while fetching
- Display: employee name/avatar at top, then list of at-risk skills
- Each skill: name (Link to /skills/[slug]), category, total uses, hours saved per use, risk badge
- Close button (X icon in top-right corner)

**Inline RiskBadge helper** (not a separate component):
```
const RISK_STYLES = {
  critical: "bg-red-100 text-red-700 border-red-200",
  high: "bg-amber-100 text-amber-700 border-amber-200",
  medium: "bg-yellow-50 text-yellow-700 border-yellow-200",
} as const;
```
Render as `<span className="inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-xs font-medium ...">`.

IMPORTANT:
- Do NOT use toLocaleDateString() or any locale-dependent formatting
- Use Tailwind utility classes only (no custom CSS)
- All data is pre-computed server-side; client only displays and sorts
- Export `IpRiskSectionProps` interface for use by ip-dashboard-view.tsx
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30` to verify no type errors.</verify>
  <done>IpRiskSection component renders alert cards, sortable employee table, and drill-down modal with proper risk badge styling.</done>
</task>

<task type="auto">
  <name>Task 2: Wire risk data into IP dashboard page and view</name>
  <files>
    apps/web/app/(protected)/leverage/ip-dashboard/page.tsx
    apps/web/components/ip-dashboard-view.tsx
  </files>
  <action>
1. Update `apps/web/app/(protected)/leverage/ip-dashboard/page.tsx`:
   - Add imports: getIpRiskEmployees, getAtRiskSkillAlerts from "@/lib/ip-dashboard-queries"
   - Extend the existing Promise.all to include the two new queries:
     ```
     const [stats, trendData, riskEmployees, atRiskAlerts] = await Promise.all([
       getIpDashboardStats(tenantId),
       getQualityTrends(tenantId, startDate),
       getIpRiskEmployees(tenantId),
       getAtRiskSkillAlerts(tenantId),
     ]);
     ```
   - Pass new props to IpDashboardView: `riskEmployees={riskEmployees} atRiskAlerts={atRiskAlerts}`

2. Update `apps/web/components/ip-dashboard-view.tsx`:
   - Add import: IpRiskSection from "./ip-risk-section"
   - Add import: types AtRiskSkillAlert, IpRiskEmployee from "@/lib/ip-dashboard-queries"
   - Extend IpDashboardViewProps to include: riskEmployees: IpRiskEmployee[], atRiskAlerts: AtRiskSkillAlert[]
   - Insert IpRiskSection BETWEEN the stat cards grid and the quality trends chart:
     ```
     {/* Hero Stat Cards Grid */}
     ...existing stat cards...

     {/* IP Risk Analysis Section - NEW */}
     <IpRiskSection riskEmployees={riskEmployees} atRiskAlerts={atRiskAlerts} />

     {/* Quality Trends Chart */}
     ...existing chart...
     ```

This placement satisfies success criterion 4: "Risk alerts surface proactively on the IP dashboard (not hidden behind a click)."
  </action>
  <verify>
1. Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30` for type check.
2. Run `cd /home/dev/projects/relay && pnpm build 2>&1 | tail -20` to verify the page compiles.
3. Run Playwright tests: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/ip-dashboard.spec.ts 2>&1 | tail -20` (if the test file exists) OR verify the page loads at http://localhost:2002/leverage/ip-dashboard.
  </verify>
  <done>IP dashboard page fetches risk data in parallel with existing stats and trends. IpDashboardView renders IpRiskSection between stat cards and quality chart. Page compiles and loads without errors.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with no errors
2. IP dashboard page at /leverage/ip-dashboard loads and shows:
   - Existing hero stat cards (unchanged)
   - NEW: Key Person Dependency Alerts section with amber/red alert cards
   - NEW: IP Concentration by Employee table (sortable)
   - Existing quality trends chart (pushed below risk section)
3. Clicking an employee row in the risk table opens a drill-down modal showing their at-risk skills
4. Alert cards show risk badges with correct red (critical) and amber (high) styling
5. Empty states display properly when no at-risk skills exist
6. Playwright E2E test passes (if exists) or manual page load verification succeeds
</verification>

<success_criteria>
All four Phase 63 success criteria met:
1. Admin sees IP concentration risk section with employees ranked by critical IP ownership
2. Admin sees alert badges on skills with key person dependency (single author, high usage, no forks)
3. Admin can drill down on any employee to see their at-risk skills
4. Risk alerts surface proactively on the IP dashboard with amber/red severity indicators
</success_criteria>

<output>
After completion, create `.planning/phases/63-ip-risk-analysis/63-02-SUMMARY.md`
</output>
