---
phase: 69-extended-visibility
plan: 02
type: execute
wave: 2
depends_on: ["69-01"]
files_modified:
  - apps/web/lib/trending.ts
  - apps/web/lib/leaderboard.ts
  - apps/web/lib/portfolio-queries.ts
  - apps/web/lib/search-skills.ts
  - apps/web/lib/company-approved.ts
  - apps/web/app/actions/skills.ts
  - apps/mcp/src/tools/everyskill.ts
  - apps/mcp/src/tools/create.ts
  - apps/mcp/src/tools/update-skill.ts
  - apps/mcp/src/tools/legacy.ts
autonomous: false

must_haves:
  truths:
    - "Trending skills include global_approved skills alongside tenant skills"
    - "Leaderboard counts global_approved skills for contributor rankings"
    - "Portfolio company bucket includes global_approved; portable bucket stays personal-only; private excluded from both"
    - "Contribution ranking includes global_approved in org-level aggregation"
    - "Tag aggregation includes global_approved skills"
    - "Company-approved section includes global_approved-visibility skills"
    - "Zod schema in server actions accepts all 4 visibility values"
    - "Only admins can set global_approved via server action"
    - "MCP tools accept all 4 visibility values but reject global_approved (no role info)"
  artifacts:
    - path: "apps/web/lib/trending.ts"
      provides: "Trending query with global_approved included"
      contains: "IN ('global_approved', 'tenant')"
    - path: "apps/web/lib/leaderboard.ts"
      provides: "Leaderboard query with global_approved included"
      contains: "IN ('global_approved', 'tenant')"
    - path: "apps/web/app/actions/skills.ts"
      provides: "Skill creation with 4-level Zod + admin gate"
      contains: "global_approved"
  key_links:
    - from: "apps/web/app/actions/skills.ts"
      to: "apps/web/lib/admin.ts"
      via: "isAdmin(session) check for global_approved"
      pattern: "isAdmin.*session"
---

<objective>
Update all inline hardcoded visibility queries (8 files, ~12 locations) and all validation schemas (4 files) to support the 4 visibility levels.

Purpose: The centralized helpers (Plan 01) auto-update ~7 callers, but 8+ files use inline `visibility = 'tenant'` for org-level aggregations. These EACH need individual update. Additionally, Zod schemas and MCP type annotations must accept the new values. The admin gate for global_approved is enforced here.

Output: All 10 files updated with correct visibility filtering. Admin gate working. MCP tools reject global_approved.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/69-extended-visibility/69-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update inline visibility queries in 5 lib files</name>
  <files>
    apps/web/lib/trending.ts
    apps/web/lib/leaderboard.ts
    apps/web/lib/portfolio-queries.ts
    apps/web/lib/search-skills.ts
    apps/web/lib/company-approved.ts
  </files>
  <action>
**apps/web/lib/trending.ts** (line 55):
Change: `AND s.visibility = 'tenant'`
To: `AND s.visibility IN ('global_approved', 'tenant')`

**apps/web/lib/leaderboard.ts** (line 59):
Change: `AND s.visibility = 'tenant'`
To: `AND s.visibility IN ('global_approved', 'tenant')`

**apps/web/lib/portfolio-queries.ts** -- 4 locations:
1. Line ~80: `COUNT(*) FILTER (WHERE visibility = 'personal')` -- LEAVE UNCHANGED (portable bucket stays personal-only)
2. Line ~82: `COUNT(*) FILTER (WHERE visibility = 'tenant')` -- Change to: `COUNT(*) FILTER (WHERE visibility IN ('global_approved', 'tenant'))`
3. Same for the hours_saved FILTER on the same line pattern: `FILTER (WHERE visibility = 'tenant')` -> `FILTER (WHERE visibility IN ('global_approved', 'tenant'))`
4. Line ~197: `AND s.visibility = 'tenant'` -> `AND s.visibility IN ('global_approved', 'tenant')`
5. Line ~230: `AND visibility = 'tenant'` -> `AND visibility IN ('global_approved', 'tenant')`

Note: `getPortfolioSkills()` (line ~122-162) does NOT filter by visibility -- it shows ALL of the author's published skills. This is correct: the author sees all their own skills in their portfolio page. Leave it unchanged.

Note: Private skills are excluded from portfolio stats by not being in either bucket. The `skills_authored` COUNT includes all published skills regardless of visibility, which is correct (it counts what the author created). The bucket breakdowns (portable vs company) intentionally exclude private.

**apps/web/lib/search-skills.ts** (line 302 in `getAvailableTags()`):
Change: `AND visibility = 'tenant'`
To: `AND visibility IN ('global_approved', 'tenant')`

**apps/web/lib/company-approved.ts** (line 34):
Change: `eq(skills.visibility, "tenant")`
To: Use `inArray` from drizzle-orm: `inArray(skills.visibility, ["global_approved", "tenant"])`
Add `inArray` to the imports from "drizzle-orm" at the top of the file.

**Verification grep after changes:**
Run: `grep -rn "visibility = 'tenant'" apps/web/lib/ --include='*.ts'`
Expected: Only `resume-queries.ts:71` should remain (the `AND s.visibility = 'personal'` clause is correct and the `includeCompanySkills` visibility clause is also intentionally personal-only for resume exports).
  </action>
  <verify>
Run: `pnpm turbo typecheck` -- no type errors.
Run: `grep -rn "eq(skills.visibility, .tenant.)" apps/web/lib/ --include='*.ts'` -- should return 0 results.
Run: `grep -rn "visibility = 'tenant'" apps/web/lib/ --include='*.ts'` -- should only match resume-queries.ts (intentional personal filter).
  </verify>
  <done>
All 5 lib files updated. Trending, leaderboard, portfolio ranking, tag aggregation, and company-approved queries all include global_approved alongside tenant. Resume queries intentionally unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update validation schemas and admin gate (server actions + MCP)</name>
  <files>
    apps/web/app/actions/skills.ts
    apps/mcp/src/tools/everyskill.ts
    apps/mcp/src/tools/create.ts
    apps/mcp/src/tools/update-skill.ts
    apps/mcp/src/tools/legacy.ts
  </files>
  <action>
**apps/web/app/actions/skills.ts:**
1. Update Zod schema (line 47): Change `visibility: z.enum(["tenant", "personal"]).default("tenant")` to `visibility: z.enum(["global_approved", "tenant", "personal", "private"]).default("tenant")`
2. Add import for `isAdmin` from `@/lib/admin` (check if already imported, if not add it).
3. In the `checkAndCreateSkill` function, AFTER Zod parsing succeeds and BEFORE the skill is created in DB, add the admin gate:
```typescript
if (parsed.data.visibility === "global_approved") {
  const session = await auth();
  if (!isAdmin(session)) {
    return { errors: { visibility: ["Only admins can set global visibility"] } };
  }
}
```
If `auth()` is already called earlier in the function, reuse that session variable instead of calling auth() again.

4. If there is an `updateSkill` or similar server action in the same file, apply the same admin gate for visibility changes to global_approved.

**apps/mcp/src/tools/everyskill.ts** (line 112):
Change Zod enum: `z.enum(["tenant", "personal"])` -> `z.enum(["global_approved", "tenant", "personal", "private"])`
Update the `.describe()` to: `"Skill visibility: global_approved (cross-tenant, admin only), tenant (team), personal (author portfolio), private (hidden)"`

Update the `EverySkillArgs` type (line ~134):
Change: `visibility?: "tenant" | "personal"` -> `visibility?: "global_approved" | "tenant" | "personal" | "private"`

**apps/mcp/src/tools/create.ts** (line ~110):
Change: `visibility?: "tenant" | "personal"` -> `visibility?: "global_approved" | "tenant" | "personal" | "private"`

Add a guard BEFORE the DB insert: if `visibility === "global_approved"`, return an error:
```typescript
if (visibility === "global_approved") {
  return {
    content: [{ type: "text" as const, text: JSON.stringify({ error: "MCP cannot set global_approved visibility (requires admin role)" }) }],
    isError: true,
  };
}
```

**apps/mcp/src/tools/update-skill.ts** (line ~60):
Change: `visibility?: "tenant" | "personal"` -> `visibility?: "global_approved" | "tenant" | "personal" | "private"`

Add the same guard: if `visibility === "global_approved"`, return an error.

**apps/mcp/src/tools/legacy.ts** (line ~184):
Change: `z.enum(["tenant", "personal"])` -> `z.enum(["global_approved", "tenant", "personal", "private"])`
Update the `.describe()` to match.
  </action>
  <verify>
Run: `pnpm turbo typecheck` -- no type errors across all packages.
Run: `grep -rn '"tenant" | "personal"' apps/mcp/src/ --include='*.ts'` -- should return 0 results (all updated to 4-level union).
  </verify>
  <done>
Server action Zod schema accepts all 4 levels with admin gate for global_approved. MCP tools accept all 4 levels in Zod but reject global_approved at handler level. All type annotations updated.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo typecheck` passes
2. `pnpm lint` passes (no new lint errors)
3. Grep audit shows no remaining `visibility = 'tenant'` in lib files except resume-queries.ts
4. Grep audit shows no remaining `"tenant" | "personal"` in MCP tools
5. Admin gate present in server action for global_approved
</verification>

<success_criteria>
- All 8 inline hardcoded visibility locations updated to include global_approved
- Server action Zod accepts 4 levels, admin gate blocks non-admin global_approved
- MCP tools accept 4 levels in schema, reject global_approved at handler level
- Resume queries intentionally unchanged (personal filter stays)
- No type errors, no lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/69-extended-visibility/69-02-SUMMARY.md`
</output>
