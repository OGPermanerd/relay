---
phase: 69-extended-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/lib/visibility.ts
  - packages/db/src/schema/skills.ts
  - packages/db/src/migrations/0038_extend_visibility.sql
  - packages/db/src/lib/__tests__/visibility.test.ts
autonomous: true

must_haves:
  truths:
    - "buildVisibilityFilter returns global_approved and tenant skills for anonymous users"
    - "buildVisibilityFilter returns global_approved, tenant, personal (own), and private (own) for authenticated users"
    - "visibilitySQL produces the same filtering logic as raw SQL strings"
    - "orgVisibleSQL returns clause matching only global_approved and tenant"
    - "VISIBILITY_LEVELS constant exports all 4 levels"
    - "Migration adds CHECK constraint and updates RLS policy"
  artifacts:
    - path: "packages/db/src/lib/visibility.ts"
      provides: "Centralized visibility helpers for all 4 levels"
      exports: ["VISIBILITY_LEVELS", "VisibilityLevel", "ORG_VISIBLE_LEVELS", "isOrgVisible", "orgVisibleSQL", "buildVisibilityFilter", "visibilitySQL"]
    - path: "packages/db/src/migrations/0038_extend_visibility.sql"
      provides: "CHECK constraint + modified RLS policy"
      contains: "skills_visibility_check"
    - path: "packages/db/src/lib/__tests__/visibility.test.ts"
      provides: "Unit tests for all visibility helpers"
  key_links:
    - from: "packages/db/src/lib/visibility.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "imports skills table for Drizzle query builder"
      pattern: "from.*schema/skills"
---

<objective>
Create the visibility foundation: update centralized helpers to support 4 visibility levels, write migration for CHECK constraint and RLS policy, and add unit tests.

Purpose: This is the P0 foundation that all other plans depend on. The centralized helpers auto-propagate to ~7 callers (hybrid-search, semantic-search, search-skills pkg, skill-forks, search-skills app, similar-skills, MCP list). The migration adds DB-level data integrity.

Output: Updated visibility.ts with 4-level support, migration 0038, unit tests passing.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/lib/visibility.ts
@packages/db/src/schema/skills.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update visibility helpers, schema comment, and create migration</name>
  <files>
    packages/db/src/lib/visibility.ts
    packages/db/src/schema/skills.ts
    packages/db/src/migrations/0038_extend_visibility.sql
  </files>
  <action>
**packages/db/src/lib/visibility.ts** -- Complete rewrite (34 lines -> ~60 lines):

Add these new exports at the top:
```typescript
export const VISIBILITY_LEVELS = ["global_approved", "tenant", "personal", "private"] as const;
export type VisibilityLevel = typeof VISIBILITY_LEVELS[number];
export const ORG_VISIBLE_LEVELS = ["global_approved", "tenant"] as const;

export function isOrgVisible(visibility: string): boolean {
  return visibility === "global_approved" || visibility === "tenant";
}
```

Add new `orgVisibleSQL()` function:
```typescript
export function orgVisibleSQL(): SQL {
  return sql`visibility IN ('global_approved', 'tenant')`;
}
```

Update `buildVisibilityFilter(userId?)`:
- No userId: return `or(eq(skills.visibility, "global_approved"), eq(skills.visibility, "tenant"))!`
- With userId: return `or(eq(skills.visibility, "global_approved"), eq(skills.visibility, "tenant"), and(eq(skills.visibility, "personal"), eq(skills.authorId, userId)), and(eq(skills.visibility, "private"), eq(skills.authorId, userId)))!`

Update `visibilitySQL(userId?)`:
- No userId: return `` sql`visibility IN ('global_approved', 'tenant')` ``
- With userId: return `` sql`(visibility IN ('global_approved', 'tenant') OR (visibility IN ('personal', 'private') AND author_id = ${userId}))` ``

Keep existing imports: `sql, eq, or, and` from drizzle-orm, `skills` from schema.

**packages/db/src/schema/skills.ts** -- Update the comment on line 49:
Change: `visibility: text("visibility").notNull().default("tenant"), // "tenant" or "personal"`
To: `visibility: text("visibility").notNull().default("tenant"), // "global_approved" | "tenant" | "personal" | "private"`

Also update the Drizzle pgPolicy on the skills table (lines 96-101). Change the USING clause to include global_approved:
```typescript
pgPolicy("tenant_isolation", {
  as: "restrictive",
  for: "all",
  using: sql`tenant_id = current_setting('app.current_tenant_id', true) OR visibility = 'global_approved'`,
  withCheck: sql`tenant_id = current_setting('app.current_tenant_id', true)`,
}),
```

**packages/db/src/migrations/0038_extend_visibility.sql** -- Create new file:
```sql
-- Phase 69: Extended Visibility
-- Adds CHECK constraint for 4 visibility levels
-- Modifies RLS policy on skills to allow cross-tenant reads of global_approved

-- Step 1: Add CHECK constraint
-- Existing data is all 'tenant' or 'personal' -- both pass this constraint
ALTER TABLE skills
  ADD CONSTRAINT skills_visibility_check
  CHECK (visibility IN ('global_approved', 'tenant', 'personal', 'private'));

-- Step 2: Modify skills RLS policy for cross-tenant global_approved reads
DROP POLICY IF EXISTS tenant_isolation ON skills;

CREATE POLICY tenant_isolation ON skills FOR ALL
  USING (
    tenant_id = current_setting('app.current_tenant_id', true)
    OR visibility = 'global_approved'
  )
  WITH CHECK (
    tenant_id = current_setting('app.current_tenant_id', true)
  );
```
  </action>
  <verify>
Run `pnpm turbo typecheck` -- should pass with no errors related to visibility imports.
Run `pnpm db:migrate` to apply migration 0038. Verify it succeeds.
  </verify>
  <done>
visibility.ts exports VISIBILITY_LEVELS, VisibilityLevel, ORG_VISIBLE_LEVELS, isOrgVisible, orgVisibleSQL, buildVisibilityFilter (4-level), visibilitySQL (4-level). Migration 0038 applied. Schema comment updated. Drizzle pgPolicy updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for visibility helpers</name>
  <files>
    packages/db/src/lib/__tests__/visibility.test.ts
  </files>
  <action>
Create directory `packages/db/src/lib/__tests__/` if it does not exist.

Create `packages/db/src/lib/__tests__/visibility.test.ts` with tests for:

1. **VISIBILITY_LEVELS** -- contains exactly ["global_approved", "tenant", "personal", "private"]
2. **isOrgVisible** -- returns true for "global_approved" and "tenant", false for "personal" and "private"
3. **buildVisibilityFilter(undefined)** -- verify SQL output includes global_approved and tenant but not personal/private. Use Drizzle's `sql` tag serialization or test the function returns a truthy SQL object.
4. **buildVisibilityFilter("user-123")** -- verify SQL output includes all 4 levels with author_id conditions for personal/private.
5. **visibilitySQL(undefined)** -- verify generated SQL string contains `IN ('global_approved', 'tenant')` and does NOT contain personal/private.
6. **visibilitySQL("user-123")** -- verify generated SQL string contains all 4 levels and author_id binding.
7. **orgVisibleSQL()** -- verify generated SQL contains `IN ('global_approved', 'tenant')`.

Use vitest (the project's test runner). Import from `../visibility`. For SQL objects, use `.queryChunks` or convert to string representation to assert on the SQL content. Check the existing test patterns in the project -- look at `packages/db/src/**/*.test.ts` for examples.

If vitest is not configured for packages/db, check for a vitest.config in packages/db. If none exists, create a minimal one or run tests from the workspace root.
  </action>
  <verify>
Run tests: `cd /home/dev/projects/relay && pnpm --filter @everyskill/db test` (or `npx vitest run packages/db/src/lib/__tests__/visibility.test.ts`).
All 7+ test cases should pass.
  </verify>
  <done>
Unit tests exist and pass for all visibility helper functions covering all 4 levels and both authenticated/anonymous code paths.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo typecheck` passes -- no type errors
2. Migration 0038 applied successfully
3. All visibility unit tests pass
4. Existing callers of buildVisibilityFilter/visibilitySQL (7 files) still compile without changes (the function signature is backward-compatible)
</verification>

<success_criteria>
- VISIBILITY_LEVELS, VisibilityLevel, ORG_VISIBLE_LEVELS, isOrgVisible, orgVisibleSQL exported from visibility.ts
- buildVisibilityFilter handles all 4 levels correctly for both anonymous and authenticated
- visibilitySQL handles all 4 levels correctly for both anonymous and authenticated
- Migration 0038 adds CHECK constraint and updates RLS policy
- Unit tests cover all helpers and pass
</success_criteria>

<output>
After completion, create `.planning/phases/69-extended-visibility/69-01-SUMMARY.md`
</output>
