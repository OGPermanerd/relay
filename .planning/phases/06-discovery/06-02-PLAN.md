---
phase: 06-discovery
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/lib/usage-trends.ts
  - apps/web/components/sparkline.tsx
  - apps/web/components/skill-card.tsx
  - apps/web/components/skill-list.tsx
autonomous: true

must_haves:
  truths:
    - "SkillCard displays name, author, category, rating, total uses, and FTE Days Saved sparkline"
    - "Sparkline shows 14-day usage trend with daily aggregation"
    - "SkillList renders grid of SkillCards with responsive layout"
    - "FTE Days Saved calculated as (totalUses * hoursSaved) / 8"
  artifacts:
    - path: "apps/web/components/skill-card.tsx"
      provides: "Skill preview card with all metrics"
      exports: ["SkillCard"]
    - path: "apps/web/components/skill-list.tsx"
      provides: "Responsive grid of skill cards"
      exports: ["SkillList"]
    - path: "apps/web/components/sparkline.tsx"
      provides: "react-sparklines wrapper component"
      exports: ["Sparkline"]
    - path: "apps/web/lib/usage-trends.ts"
      provides: "Usage trend aggregation query"
      exports: ["getUsageTrends"]
  key_links:
    - from: "apps/web/components/skill-card.tsx"
      to: "apps/web/components/sparkline.tsx"
      via: "imports and renders Sparkline"
      pattern: "import.*Sparkline"
    - from: "apps/web/lib/usage-trends.ts"
      to: "@relay/db"
      via: "queries usageEvents with date_trunc"
      pattern: "date_trunc.*usageEvents"
---

<objective>
Create skill card components with sparkline visualization for FTE Days Saved trends.

Purpose: Provide rich skill previews showing all key metrics (name, author, rating, uses, FTE trend) in a scannable card format.
Output: Reusable SkillCard, SkillList, and Sparkline components ready for the search results page.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-discovery/06-RESEARCH.md

# Existing patterns to follow
@apps/web/components/skill-detail.tsx
@apps/web/components/stat-card.tsx
@apps/web/lib/skill-stats.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-sparklines and create Sparkline wrapper</name>
  <files>apps/web/package.json, apps/web/components/sparkline.tsx</files>
  <action>
1. Install react-sparklines in the web app:
```bash
pnpm --filter web add react-sparklines
pnpm --filter web add -D @types/react-sparklines
```

2. Create apps/web/components/sparkline.tsx:
```typescript
"use client";

import { Sparklines, SparklinesLine } from "react-sparklines";

interface SparklineProps {
  data: number[];
  width?: number;
  height?: number;
  color?: string;
}

/**
 * Sparkline chart for visualizing usage trends
 *
 * Default sizing optimized for skill cards (60x20px)
 * Uses blue color to match the app theme
 */
export function Sparkline({
  data,
  width = 60,
  height = 20,
  color = "#3b82f6",
}: SparklineProps) {
  // Handle empty data - show flat line
  if (!data || data.length === 0) {
    return (
      <Sparklines data={[0, 0, 0, 0, 0]} width={width} height={height}>
        <SparklinesLine color="#9ca3af" />
      </Sparklines>
    );
  }

  return (
    <Sparklines data={data} width={width} height={height}>
      <SparklinesLine color={color} />
    </Sparklines>
  );
}
```

The wrapper component:
- Is a client component (uses react-sparklines which needs browser APIs)
- Provides sensible defaults for card display
- Handles empty data case with gray flat line
  </action>
  <verify>
Run `pnpm --filter web typecheck` - should pass.
Run `pnpm --filter web build` - should complete without errors.
  </verify>
  <done>
react-sparklines installed, Sparkline wrapper component exported from apps/web/components/sparkline.tsx.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create usage trends query for batch sparkline data</name>
  <files>apps/web/lib/usage-trends.ts</files>
  <action>
Create apps/web/lib/usage-trends.ts for fetching sparkline data:

```typescript
import { db } from "@relay/db";
import { usageEvents } from "@relay/db/schema";
import { sql, inArray, gte, and } from "drizzle-orm";

interface DailyUsage {
  date: string;
  count: number;
}

/**
 * Get usage trends for multiple skills in a single query
 *
 * Aggregates usage events by day for the last N days.
 * Returns a map of skillId -> array of daily counts.
 *
 * Uses batch query to avoid N+1 problem with skill cards.
 *
 * @param skillIds - Array of skill IDs to fetch trends for
 * @param days - Number of days to look back (default 14)
 * @returns Map of skillId to array of daily usage counts
 */
export async function getUsageTrends(
  skillIds: string[],
  days: number = 14
): Promise<Map<string, number[]>> {
  // Handle null db or empty skillIds
  if (!db || skillIds.length === 0) {
    return new Map();
  }

  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);
  startDate.setHours(0, 0, 0, 0);

  // Query all usage events for the skills in the date range
  const results = await db
    .select({
      skillId: usageEvents.skillId,
      date: sql<string>`date_trunc('day', ${usageEvents.createdAt})::date::text`,
      count: sql<number>`cast(count(*) as integer)`,
    })
    .from(usageEvents)
    .where(
      and(
        inArray(usageEvents.skillId, skillIds),
        gte(usageEvents.createdAt, startDate)
      )
    )
    .groupBy(usageEvents.skillId, sql`date_trunc('day', ${usageEvents.createdAt})`)
    .orderBy(sql`date_trunc('day', ${usageEvents.createdAt})`);

  // Group by skillId
  const bySkill = new Map<string, DailyUsage[]>();
  for (const row of results) {
    if (!row.skillId) continue;
    const existing = bySkill.get(row.skillId) || [];
    existing.push({ date: row.date, count: row.count });
    bySkill.set(row.skillId, existing);
  }

  // Fill gaps and convert to number arrays
  const trendMap = new Map<string, number[]>();

  for (const skillId of skillIds) {
    const dailyData = bySkill.get(skillId) || [];
    const filled = fillMissingDays(dailyData, days);
    trendMap.set(skillId, filled);
  }

  return trendMap;
}

/**
 * Fill missing days with zero counts
 */
function fillMissingDays(data: DailyUsage[], days: number): number[] {
  const result: number[] = [];
  const dataMap = new Map(data.map((d) => [d.date, d.count]));

  for (let i = days - 1; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split("T")[0];
    result.push(dataMap.get(dateStr) || 0);
  }

  return result;
}
```

Key design decisions:
- Batch query to avoid N+1 (one query for all skills on page)
- 14 days default matches typical sparkline width
- Fills gaps with zeros for continuous sparkline
- Returns Map for O(1) lookup per skill
  </action>
  <verify>
Run `pnpm --filter web typecheck` - should pass.
  </verify>
  <done>
getUsageTrends function exported, batches usage data for multiple skills in single query, returns Map of skillId to daily counts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SkillCard and SkillList components</name>
  <files>apps/web/components/skill-card.tsx, apps/web/components/skill-list.tsx</files>
  <action>
1. Create apps/web/components/skill-card.tsx:

```typescript
import Link from "next/link";
import Image from "next/image";
import { formatRating } from "@relay/db";
import { Sparkline } from "./sparkline";

export interface SkillCardData {
  id: string;
  name: string;
  slug: string;
  description: string;
  category: string;
  totalUses: number;
  averageRating: number | null;
  hoursSaved: number | null;
  author: {
    id: string;
    name: string | null;
    image: string | null;
  } | null;
}

interface SkillCardProps {
  skill: SkillCardData;
  usageTrend: number[];
}

/**
 * Skill preview card for browse/search results
 *
 * Displays:
 * - Category badge
 * - Name and truncated description
 * - Total uses, rating, FTE Days Saved with sparkline
 * - Author avatar and name
 */
export function SkillCard({ skill, usageTrend }: SkillCardProps) {
  // Calculate FTE Days Saved: (totalUses * hoursSaved) / 8
  const fteDaysSaved = ((skill.totalUses * (skill.hoursSaved ?? 1)) / 8).toFixed(1);

  return (
    <Link
      href={`/skills/${skill.slug}`}
      className="group block rounded-lg border border-gray-200 bg-white p-4 shadow-sm transition hover:border-blue-300 hover:shadow-md"
    >
      {/* Header */}
      <div className="mb-3">
        <span className="text-xs font-medium uppercase text-blue-600">
          {skill.category}
        </span>
        <h3 className="mt-1 font-semibold text-gray-900 group-hover:text-blue-600">
          {skill.name}
        </h3>
        <p className="mt-1 line-clamp-2 text-sm text-gray-600">
          {skill.description}
        </p>
      </div>

      {/* Metrics row */}
      <div className="flex items-center gap-4 border-t border-gray-100 pt-3 text-sm text-gray-500">
        <span>{skill.totalUses} uses</span>
        <span>
          {skill.averageRating !== null
            ? `${formatRating(skill.averageRating)} stars`
            : "No ratings"}
        </span>
        <div className="flex items-center gap-1">
          <span>{fteDaysSaved} days</span>
          <Sparkline data={usageTrend} />
        </div>
      </div>

      {/* Author */}
      {skill.author && (
        <div className="mt-3 flex items-center gap-2">
          {skill.author.image ? (
            <Image
              src={skill.author.image}
              alt={skill.author.name || "Author"}
              width={24}
              height={24}
              className="rounded-full"
            />
          ) : (
            <div className="flex h-6 w-6 items-center justify-center rounded-full bg-gray-200 text-xs font-medium text-gray-600">
              {skill.author.name?.charAt(0).toUpperCase() || "?"}
            </div>
          )}
          <span className="text-xs text-gray-500">
            by {skill.author.name || "Anonymous"}
          </span>
        </div>
      )}
    </Link>
  );
}
```

2. Create apps/web/components/skill-list.tsx:

```typescript
import { SkillCard, SkillCardData } from "./skill-card";

interface SkillListProps {
  skills: SkillCardData[];
  usageTrends: Map<string, number[]>;
}

/**
 * Responsive grid of skill cards
 *
 * Layout:
 * - 1 column on mobile
 * - 2 columns on tablet (sm)
 * - 3 columns on desktop (lg)
 */
export function SkillList({ skills, usageTrends }: SkillListProps) {
  if (skills.length === 0) {
    return null; // Parent handles empty state
  }

  return (
    <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
      {skills.map((skill) => (
        <SkillCard
          key={skill.id}
          skill={skill}
          usageTrend={usageTrends.get(skill.id) || []}
        />
      ))}
    </div>
  );
}
```

Implementation notes:
- SkillCard is a link to the skill detail page
- line-clamp-2 truncates long descriptions
- formatRating from @relay/db converts integer*100 to string
- SkillList uses CSS grid for responsive layout
- Empty state is handled by parent (Plan 04)
  </action>
  <verify>
Run `pnpm --filter web typecheck` - should pass.
Run `pnpm --filter web build` - should complete without errors.
  </verify>
  <done>
SkillCard displays all metrics including sparkline, SkillList renders responsive grid of cards.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` - All packages pass type checking
2. `pnpm --filter web build` - Web app builds successfully
3. react-sparklines is listed in apps/web/package.json dependencies
4. Components are importable: SkillCard, SkillList, Sparkline
5. getUsageTrends function queries database with batch optimization
</verification>

<success_criteria>
- react-sparklines installed with @types
- Sparkline component wraps library with sensible defaults
- getUsageTrends batches query for multiple skills
- SkillCard shows name, description, category, uses, rating, FTE days with sparkline
- SkillList renders responsive grid layout
- All components pass typecheck
</success_criteria>

<output>
After completion, create `.planning/phases/06-discovery/06-02-SUMMARY.md`
</output>
