---
phase: 06-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/skills.ts
  - apps/web/lib/search-skills.ts
autonomous: true

must_haves:
  truths:
    - "Skills table has searchVector generated column with weighted name (A) and description (B)"
    - "GIN index exists on searchVector column for fast full-text search"
    - "Search function returns skills matching query terms with stemming and ranking"
    - "Empty query returns all skills ordered by totalUses"
  artifacts:
    - path: "packages/db/src/schema/skills.ts"
      provides: "searchVector generated column with GIN index"
      contains: "searchVector"
    - path: "apps/web/lib/search-skills.ts"
      provides: "Server-side search function with PostgreSQL FTS"
      exports: ["searchSkills"]
  key_links:
    - from: "apps/web/lib/search-skills.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "drizzle query with searchVector"
      pattern: "searchVector.*@@.*websearch_to_tsquery"
---

<objective>
Add PostgreSQL full-text search infrastructure to the skills table and create a server-side search function.

Purpose: Enable fast, relevance-ranked text search across skill names and descriptions using PostgreSQL's built-in FTS.
Output: Skills schema with searchVector column + search function ready for use in browse page.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-discovery/06-RESEARCH.md

# Existing files to modify/reference
@packages/db/src/schema/skills.ts
@packages/db/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add searchVector generated column to skills schema</name>
  <files>packages/db/src/schema/skills.ts</files>
  <action>
Add a generated tsvector column for full-text search with weighted fields:

1. Import required types from drizzle-orm/pg-core:
   - `tsvector` type for the column
   - `index` for GIN index definition

2. Add searchVector column after averageRating:
```typescript
searchVector: tsvector("search_vector")
  .generatedAlwaysAs((): SQL =>
    sql`setweight(to_tsvector('english', ${skills.name}), 'A') ||
        setweight(to_tsvector('english', ${skills.description}), 'B')`
  ),
```

3. Add GIN index in table definition (third parameter to pgTable):
```typescript
(table) => [
  index("skills_search_idx").using("gin", table.searchVector),
]
```

4. Import `sql` and `SQL` from 'drizzle-orm' at top of file.

Note: The generated column automatically updates when name/description changes.
Weight A (name) ranks higher than Weight B (description) in search results.
  </action>
  <verify>
Run `pnpm --filter @relay/db typecheck` - should pass with no errors.
Inspect the modified skills.ts file to confirm searchVector column and GIN index are present.
  </verify>
  <done>
skills.ts exports skills table with searchVector generated column and skills_search_idx GIN index.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create searchSkills function with FTS query</name>
  <files>apps/web/lib/search-skills.ts</files>
  <action>
Create a new file apps/web/lib/search-skills.ts that implements PostgreSQL full-text search:

```typescript
import { db, skills, users } from "@relay/db";
import { sql, eq, desc, and } from "drizzle-orm";

export interface SearchSkillResult {
  id: string;
  name: string;
  slug: string;
  description: string;
  category: string;
  totalUses: number;
  averageRating: number | null;
  hoursSaved: number | null;
  author: {
    id: string;
    name: string | null;
    image: string | null;
  } | null;
}

export interface SearchParams {
  query?: string;
  category?: string;
  tags?: string[];
}

/**
 * Search skills using PostgreSQL full-text search
 *
 * When query is provided: Uses websearch_to_tsquery for parsing and ts_rank for ordering
 * When query is empty: Returns all skills ordered by totalUses descending
 *
 * @param params - Search parameters (query, category, tags)
 * @returns Array of matching skills with author info
 */
export async function searchSkills(params: SearchParams): Promise<SearchSkillResult[]> {
  // Handle null db case
  if (!db) {
    return [];
  }

  const conditions = [];

  // Full-text search condition
  if (params.query && params.query.trim()) {
    conditions.push(
      sql`${skills.searchVector} @@ websearch_to_tsquery('english', ${params.query})`
    );
  }

  // Category filter
  if (params.category) {
    conditions.push(eq(skills.category, params.category));
  }

  // TODO: Tag filtering will be added in Plan 03
  // Tags are stored in metadata JSONB field

  // Build query
  const baseQuery = db
    .select({
      id: skills.id,
      name: skills.name,
      slug: skills.slug,
      description: skills.description,
      category: skills.category,
      totalUses: skills.totalUses,
      averageRating: skills.averageRating,
      hoursSaved: skills.hoursSaved,
      author: {
        id: users.id,
        name: users.name,
        image: users.image,
      },
    })
    .from(skills)
    .leftJoin(users, eq(skills.authorId, users.id));

  // Apply conditions if any
  const filteredQuery = conditions.length > 0
    ? baseQuery.where(and(...conditions))
    : baseQuery;

  // Order by relevance (when searching) or totalUses (when browsing)
  if (params.query && params.query.trim()) {
    return filteredQuery.orderBy(
      sql`ts_rank(${skills.searchVector}, websearch_to_tsquery('english', ${params.query})) DESC`
    );
  }

  return filteredQuery.orderBy(desc(skills.totalUses));
}
```

Key implementation details:
- Uses websearch_to_tsquery which supports quoted phrases and boolean operators
- ts_rank orders results by relevance when query is present
- Falls back to totalUses ordering when no query (for browse mode)
- Returns author info via left join
- Gracefully returns empty array when db is null
  </action>
  <verify>
Run `pnpm --filter web typecheck` - should pass.
File exists at apps/web/lib/search-skills.ts with searchSkills export.
  </verify>
  <done>
searchSkills function accepts query/category params and returns skills array with author data, using PostgreSQL FTS for ranking.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` - All packages pass type checking
2. Skills schema includes searchVector column and GIN index definition
3. searchSkills function is importable from apps/web/lib/search-skills.ts
</verification>

<success_criteria>
- skills table has searchVector generated column with setweight for name (A) and description (B)
- GIN index defined on searchVector column
- searchSkills function queries using websearch_to_tsquery and ts_rank
- Function returns skills with author relation
- Empty query returns all skills ordered by totalUses
</success_criteria>

<output>
After completion, create `.planning/phases/06-discovery/06-01-SUMMARY.md`
</output>
