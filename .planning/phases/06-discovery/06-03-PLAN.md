---
phase: 06-discovery
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - apps/web/components/providers.tsx
  - apps/web/components/search-input.tsx
  - apps/web/components/category-filter.tsx
  - apps/web/components/tag-filter.tsx
  - apps/web/lib/search-skills.ts
autonomous: true

must_haves:
  truths:
    - "NuqsAdapter wraps the application for URL state management"
    - "SearchInput updates URL query parameter 'q' with debounce"
    - "CategoryFilter displays category tabs and updates 'category' param"
    - "TagFilter displays tag chips and updates 'tags' array param"
    - "Search function filters by tags from metadata JSONB"
  artifacts:
    - path: "apps/web/components/search-input.tsx"
      provides: "Debounced search input with nuqs"
      exports: ["SearchInput"]
    - path: "apps/web/components/category-filter.tsx"
      provides: "Category tabs with nuqs"
      exports: ["CategoryFilter"]
    - path: "apps/web/components/tag-filter.tsx"
      provides: "Tag filter chips with nuqs"
      exports: ["TagFilter"]
  key_links:
    - from: "apps/web/components/providers.tsx"
      to: "nuqs"
      via: "NuqsAdapter wrapper"
      pattern: "NuqsAdapter"
    - from: "apps/web/components/search-input.tsx"
      to: "URL"
      via: "useQueryState('q')"
      pattern: "useQueryState.*'q'"
---

<objective>
Add URL-synced filter components for search, category browse, and tag filtering.

Purpose: Enable shareable, bookmarkable search URLs with browser back/forward navigation support.
Output: Search input, category tabs, and tag filter components using nuqs for URL state management.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-discovery/06-RESEARCH.md
@.planning/phases/06-discovery/06-01-SUMMARY.md

# Existing files to modify/reference
@apps/web/components/providers.tsx
@apps/web/lib/search-skills.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install nuqs and add NuqsAdapter to providers</name>
  <files>apps/web/package.json, apps/web/components/providers.tsx</files>
  <action>
1. Install nuqs in the web app:
```bash
pnpm --filter web add nuqs
```

2. Update apps/web/components/providers.tsx to include NuqsAdapter:

```typescript
"use client";

import { SessionProvider } from "next-auth/react";
import { NuqsAdapter } from "nuqs/adapters/next/app";
import type { ReactNode } from "react";

interface ProvidersProps {
  children: ReactNode;
}

export function Providers({ children }: ProvidersProps) {
  return (
    <SessionProvider>
      <NuqsAdapter>{children}</NuqsAdapter>
    </SessionProvider>
  );
}
```

Note: NuqsAdapter must wrap the app to enable URL state synchronization.
The adapter handles history state, SSR hydration, and URL updates.
  </action>
  <verify>
Run `pnpm --filter web typecheck` - should pass.
Run `pnpm --filter web build` - should complete without errors.
  </verify>
  <done>
nuqs installed, NuqsAdapter wrapping application in providers.tsx.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SearchInput, CategoryFilter, and TagFilter components</name>
  <files>apps/web/components/search-input.tsx, apps/web/components/category-filter.tsx, apps/web/components/tag-filter.tsx</files>
  <action>
1. Create apps/web/components/search-input.tsx:

```typescript
"use client";

import { useQueryState, parseAsString } from "nuqs";
import { useTransition, useRef, useEffect } from "react";

/**
 * Search input with URL synchronization
 *
 * Uses nuqs to sync search query to URL 'q' parameter.
 * Debounces input to prevent excessive URL updates.
 * Uses startTransition for non-blocking updates.
 */
export function SearchInput() {
  const [query, setQuery] = useQueryState("q", parseAsString.withDefault(""));
  const [isPending, startTransition] = useTransition();
  const inputRef = useRef<HTMLInputElement>(null);
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  // Clear timeout on unmount
  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;

    // Clear previous timeout
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }

    // Debounce URL update (300ms)
    timeoutRef.current = setTimeout(() => {
      startTransition(() => {
        setQuery(value || null); // null removes param from URL
      });
    }, 300);
  };

  return (
    <div className="relative">
      <input
        ref={inputRef}
        type="search"
        placeholder="Search skills..."
        defaultValue={query}
        onChange={handleChange}
        className="w-full rounded-lg border border-gray-300 px-4 py-2 pl-10 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
      />
      <svg
        className="absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400"
        fill="none"
        viewBox="0 0 24 24"
        strokeWidth={1.5}
        stroke="currentColor"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
        />
      </svg>
      {isPending && (
        <div className="absolute right-3 top-1/2 -translate-y-1/2">
          <div className="h-4 w-4 animate-spin rounded-full border-2 border-blue-500 border-t-transparent" />
        </div>
      )}
    </div>
  );
}
```

2. Create apps/web/components/category-filter.tsx:

```typescript
"use client";

import { useQueryState, parseAsStringEnum } from "nuqs";
import { useTransition } from "react";

// Category values matching the skills schema
const CATEGORIES = ["prompt", "workflow", "agent", "mcp"] as const;
type Category = (typeof CATEGORIES)[number];

const CATEGORY_LABELS: Record<Category, string> = {
  prompt: "Prompts",
  workflow: "Workflows",
  agent: "Agents",
  mcp: "MCP Tools",
};

/**
 * Category filter tabs with URL synchronization
 *
 * Shows "All" plus each category as clickable tabs.
 * Uses nuqs to sync to URL 'category' parameter.
 */
export function CategoryFilter() {
  const [category, setCategory] = useQueryState(
    "category",
    parseAsStringEnum(CATEGORIES).withDefault(null as unknown as Category)
  );
  const [isPending, startTransition] = useTransition();

  const handleSelect = (value: Category | null) => {
    startTransition(() => {
      setCategory(value);
    });
  };

  return (
    <div className="flex flex-wrap gap-2">
      <button
        onClick={() => handleSelect(null)}
        className={`rounded-full px-4 py-1.5 text-sm font-medium transition ${
          category === null
            ? "bg-blue-600 text-white"
            : "bg-gray-100 text-gray-700 hover:bg-gray-200"
        }`}
        disabled={isPending}
      >
        All
      </button>
      {CATEGORIES.map((cat) => (
        <button
          key={cat}
          onClick={() => handleSelect(cat)}
          className={`rounded-full px-4 py-1.5 text-sm font-medium transition ${
            category === cat
              ? "bg-blue-600 text-white"
              : "bg-gray-100 text-gray-700 hover:bg-gray-200"
          }`}
          disabled={isPending}
        >
          {CATEGORY_LABELS[cat]}
        </button>
      ))}
    </div>
  );
}
```

3. Create apps/web/components/tag-filter.tsx:

```typescript
"use client";

import { useQueryState, parseAsArrayOf, parseAsString } from "nuqs";
import { useTransition } from "react";

interface TagFilterProps {
  availableTags: string[];
}

/**
 * Tag filter chips with URL synchronization
 *
 * Shows available tags as toggleable chips.
 * Uses nuqs to sync selected tags to URL 'tags' parameter as comma-separated values.
 */
export function TagFilter({ availableTags }: TagFilterProps) {
  const [selectedTags, setSelectedTags] = useQueryState(
    "tags",
    parseAsArrayOf(parseAsString, ",").withDefault([])
  );
  const [isPending, startTransition] = useTransition();

  const toggleTag = (tag: string) => {
    startTransition(() => {
      const newTags = selectedTags.includes(tag)
        ? selectedTags.filter((t) => t !== tag)
        : [...selectedTags, tag];

      setSelectedTags(newTags.length > 0 ? newTags : null);
    });
  };

  if (availableTags.length === 0) {
    return null;
  }

  return (
    <div className="flex flex-wrap gap-2">
      <span className="text-sm text-gray-500">Tags:</span>
      {availableTags.map((tag) => {
        const isSelected = selectedTags.includes(tag);
        return (
          <button
            key={tag}
            onClick={() => toggleTag(tag)}
            className={`rounded-full border px-3 py-1 text-xs font-medium transition ${
              isSelected
                ? "border-blue-500 bg-blue-50 text-blue-700"
                : "border-gray-200 text-gray-600 hover:border-gray-300 hover:bg-gray-50"
            }`}
            disabled={isPending}
          >
            {tag}
          </button>
        );
      })}
    </div>
  );
}
```

Implementation notes:
- All components use client-side rendering ("use client")
- useTransition prevents blocking during URL updates
- nuqs parsers ensure type-safe URL parameters
- Debounce on search input prevents excessive queries
- Category tabs show active state with blue background
- Tags are comma-separated in URL (e.g., ?tags=ai,coding)
  </action>
  <verify>
Run `pnpm --filter web typecheck` - should pass.
Run `pnpm --filter web build` - should complete without errors.
  </verify>
  <done>
SearchInput, CategoryFilter, and TagFilter components created with nuqs URL state management.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tag filtering to searchSkills function</name>
  <files>apps/web/lib/search-skills.ts</files>
  <action>
Update apps/web/lib/search-skills.ts to support tag filtering via JSONB query:

1. Add tags condition in the searchSkills function. Update the conditions building section:

After the existing category filter condition, add:

```typescript
// Tag filter - tags stored in metadata JSONB as { tags: string[] }
if (params.tags && params.tags.length > 0) {
  // PostgreSQL JSONB array containment: metadata->'tags' @> '["tag1","tag2"]'::jsonb
  conditions.push(
    sql`${skills.metadata}->>'tags' IS NOT NULL AND ${skills.metadata}->'tags' @> ${JSON.stringify(params.tags)}::jsonb`
  );
}
```

Wait - looking at the skills schema, there is no metadata field yet. The skills table only has: id, name, slug, description, category, publishedVersionId, draftVersionId, totalUses, averageRating, content, hoursSaved, authorId, createdAt, updatedAt.

For now, add the tag filter code but it will be a no-op until a metadata field is added to the schema. Add a TODO comment:

```typescript
// TODO: Tag filtering requires adding metadata JSONB column to skills table
// For now, tag filter is a no-op
if (params.tags && params.tags.length > 0) {
  // Will be implemented when metadata column is added:
  // conditions.push(
  //   sql`${skills.metadata}->'tags' @> ${JSON.stringify(params.tags)}::jsonb`
  // );
}
```

Also add a helper function to get available tags (returns empty array for now):

```typescript
/**
 * Get all unique tags from skills
 *
 * TODO: Implement when metadata column is added to skills table
 * @returns Array of unique tag strings
 */
export async function getAvailableTags(): Promise<string[]> {
  // Placeholder - will query distinct tags from metadata when available
  return [];
}
```

Export getAvailableTags alongside searchSkills.
  </action>
  <verify>
Run `pnpm --filter web typecheck` - should pass.
  </verify>
  <done>
searchSkills has placeholder for tag filtering, getAvailableTags helper exported for future use.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` - All packages pass type checking
2. `pnpm --filter web build` - Web app builds successfully
3. nuqs is listed in apps/web/package.json dependencies
4. providers.tsx includes NuqsAdapter wrapper
5. Filter components export: SearchInput, CategoryFilter, TagFilter
6. searchSkills function has tag filter placeholder
</verification>

<success_criteria>
- nuqs installed in web app
- NuqsAdapter wraps app in providers.tsx
- SearchInput debounces and syncs to URL 'q' parameter
- CategoryFilter syncs to URL 'category' parameter
- TagFilter syncs to URL 'tags' parameter
- searchSkills has tag filter placeholder for future implementation
- All components pass typecheck
</success_criteria>

<output>
After completion, create `.planning/phases/06-discovery/06-03-SUMMARY.md`
</output>
