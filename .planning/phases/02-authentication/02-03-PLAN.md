---
phase: 02-authentication
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - apps/web/app/(protected)/profile/page.tsx
  - apps/web/app/(protected)/layout.tsx
  - apps/web/components/sign-out-button.tsx
  - apps/web/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "User profile page displays name from Google"
    - "User profile page displays avatar from Google"
    - "User profile page shows placeholder for contribution statistics"
    - "User can sign out from the application"
  artifacts:
    - path: "apps/web/app/(protected)/profile/page.tsx"
      provides: "User profile page"
      contains: "session.user"
    - path: "apps/web/components/sign-out-button.tsx"
      provides: "Sign out button component"
      contains: "signOut"
  key_links:
    - from: "apps/web/app/(protected)/profile/page.tsx"
      to: "apps/web/auth.ts"
      via: "auth() session access"
      pattern: "auth\\(\\)"
    - from: "apps/web/components/sign-out-button.tsx"
      to: "apps/web/auth.ts"
      via: "signOut server action"
      pattern: "signOut"
---

<objective>
Create user profile page displaying Google account information and contribution statistics placeholder.

Purpose: Complete the authentication user experience by showing users their profile with name and avatar from Google, plus a preview of contribution statistics (to be populated in later phases).

Output: Protected profile page, sign-out functionality, and updated home page with navigation.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication/02-RESEARCH.md
@.planning/phases/02-authentication/02-01-SUMMARY.md
@.planning/phases/02-authentication/02-02-SUMMARY.md
@apps/web/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sign-out button and protected layout</name>
  <files>
    - apps/web/components/sign-out-button.tsx
    - apps/web/app/(protected)/layout.tsx
  </files>
  <action>
1. Create apps/web/components/sign-out-button.tsx:
   ```typescript
   import { signOut } from "@/auth"

   export function SignOutButton() {
     return (
       <form
         action={async () => {
           "use server"
           await signOut({ redirectTo: "/login" })
         }}
       >
         <button
           type="submit"
           className="text-gray-600 hover:text-gray-900 text-sm font-medium transition-colors"
         >
           Sign out
         </button>
       </form>
     )
   }
   ```

2. Create apps/web/app/(protected)/layout.tsx for protected routes header:
   ```typescript
   import Link from "next/link"
   import { auth } from "@/auth"
   import { redirect } from "next/navigation"
   import { SignOutButton } from "@/components/sign-out-button"

   export default async function ProtectedLayout({
     children,
   }: {
     children: React.ReactNode
   }) {
     const session = await auth()

     if (!session?.user) {
       redirect("/login")
     }

     return (
       <div className="min-h-screen bg-gray-50">
         <header className="bg-white shadow-sm">
           <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
             <div className="flex justify-between items-center h-16">
               <div className="flex items-center gap-8">
                 <Link
                   href="/"
                   className="text-xl font-bold text-gray-900"
                 >
                   Relay
                 </Link>
                 <nav className="hidden sm:flex gap-6">
                   <Link
                     href="/"
                     className="text-gray-600 hover:text-gray-900 text-sm font-medium"
                   >
                     Home
                   </Link>
                   <Link
                     href="/profile"
                     className="text-gray-600 hover:text-gray-900 text-sm font-medium"
                   >
                     Profile
                   </Link>
                 </nav>
               </div>
               <div className="flex items-center gap-4">
                 {session.user.image && (
                   <img
                     src={session.user.image}
                     alt=""
                     className="w-8 h-8 rounded-full"
                   />
                 )}
                 <span className="text-sm text-gray-700 hidden sm:block">
                   {session.user.name}
                 </span>
                 <SignOutButton />
               </div>
             </div>
           </div>
         </header>
         <main>{children}</main>
       </div>
     )
   }
   ```

Note: The (protected) route group applies this layout to all child routes without affecting URLs.
  </action>
  <verify>
    - `cat apps/web/components/sign-out-button.tsx` shows signOut server action
    - `cat apps/web/app/\(protected\)/layout.tsx` shows auth() call and header with navigation
    - `pnpm typecheck` passes
  </verify>
  <done>
    - SignOutButton component with server action
    - Protected layout with header, navigation, user avatar, and sign out
    - Session verification in layout (redirect if not authenticated)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create profile page and update home page</name>
  <files>
    - apps/web/app/(protected)/profile/page.tsx
    - apps/web/app/page.tsx
  </files>
  <action>
1. Create apps/web/app/(protected)/profile/page.tsx:
   ```typescript
   import { auth } from "@/auth"
   import { redirect } from "next/navigation"

   export default async function ProfilePage() {
     const session = await auth()

     if (!session?.user) {
       redirect("/login")
     }

     const { name, email, image } = session.user

     return (
       <div className="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
         <h1 className="text-2xl font-bold text-gray-900 mb-8">Profile</h1>

         {/* User Info Section */}
         <div className="bg-white shadow rounded-lg p-6 mb-8">
           <div className="flex items-center gap-6">
             {image ? (
               <img
                 src={image}
                 alt={name || "User avatar"}
                 className="w-20 h-20 rounded-full"
               />
             ) : (
               <div className="w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center">
                 <span className="text-2xl text-gray-500">
                   {name?.charAt(0) || "?"}
                 </span>
               </div>
             )}
             <div>
               <h2 className="text-xl font-semibold text-gray-900">
                 {name || "Unknown User"}
               </h2>
               <p className="text-gray-600">{email}</p>
             </div>
           </div>
         </div>

         {/* Contribution Statistics Placeholder */}
         <div className="bg-white shadow rounded-lg p-6">
           <h3 className="text-lg font-semibold text-gray-900 mb-4">
             Contribution Statistics
           </h3>
           <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
             <div className="text-center p-4 bg-gray-50 rounded-lg">
               <p className="text-2xl font-bold text-gray-900">-</p>
               <p className="text-sm text-gray-600">Skills Shared</p>
             </div>
             <div className="text-center p-4 bg-gray-50 rounded-lg">
               <p className="text-2xl font-bold text-gray-900">-</p>
               <p className="text-sm text-gray-600">Total Uses</p>
             </div>
             <div className="text-center p-4 bg-gray-50 rounded-lg">
               <p className="text-2xl font-bold text-gray-900">-</p>
               <p className="text-sm text-gray-600">Avg Rating</p>
             </div>
             <div className="text-center p-4 bg-gray-50 rounded-lg">
               <p className="text-2xl font-bold text-gray-900">-</p>
               <p className="text-sm text-gray-600">FTE Days Saved</p>
             </div>
           </div>
           <p className="mt-4 text-sm text-gray-500 text-center">
             Statistics will appear once you start sharing skills
           </p>
         </div>
       </div>
     )
   }
   ```

2. Move apps/web/app/page.tsx into protected layout by creating apps/web/app/(protected)/page.tsx:
   ```typescript
   import { auth } from "@/auth"
   import { redirect } from "next/navigation"
   import Link from "next/link"

   export default async function HomePage() {
     const session = await auth()

     if (!session?.user) {
       redirect("/login")
     }

     return (
       <div className="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
         <h1 className="text-2xl font-bold text-gray-900 mb-4">
           Welcome to Relay, {session.user.name?.split(" ")[0]}!
         </h1>
         <p className="text-gray-600 mb-8">
           Discover and share skills with your colleagues.
         </p>

         <div className="grid gap-4 sm:grid-cols-2">
           <Link
             href="/profile"
             className="block p-6 bg-white shadow rounded-lg hover:shadow-md transition-shadow"
           >
             <h2 className="text-lg font-semibold text-gray-900 mb-2">
               Your Profile
             </h2>
             <p className="text-gray-600 text-sm">
               View your profile and contribution statistics
             </p>
           </Link>

           <div className="block p-6 bg-gray-100 rounded-lg opacity-60">
             <h2 className="text-lg font-semibold text-gray-900 mb-2">
               Browse Skills
             </h2>
             <p className="text-gray-600 text-sm">
               Coming soon in Phase 6
             </p>
           </div>
         </div>
       </div>
     )
   }
   ```

3. Delete the old apps/web/app/page.tsx (now moved to protected group):
   - The new location apps/web/app/(protected)/page.tsx serves the same / URL
   - Route groups (parentheses) don't affect URLs
  </action>
  <verify>
    - `cat apps/web/app/\(protected\)/profile/page.tsx` shows session.user.name, image, email
    - `cat apps/web/app/\(protected\)/page.tsx` shows authenticated home page
    - Profile page has contribution statistics placeholder with 4 stat boxes
    - `pnpm typecheck` passes
    - `pnpm build` succeeds
  </verify>
  <done>
    - Profile page displays name and avatar from Google
    - Profile page shows contribution statistics placeholder (Skills Shared, Total Uses, Avg Rating, FTE Days Saved)
    - Home page updated with welcome message and navigation cards
    - Old root page.tsx removed in favor of protected group version
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete authentication flow with Google SSO:
    1. Login page with Google sign-in button
    2. Middleware route protection (redirects to /login if not authenticated)
    3. Protected home page with personalized welcome
    4. Profile page with Google avatar, name, email, and contribution statistics placeholder
    5. Sign out functionality
  </what-built>
  <how-to-verify>
    Prerequisites:
    - Ensure environment variables are set:
      - AUTH_SECRET (generate with: openssl rand -base64 32)
      - AUTH_GOOGLE_ID (from Google Cloud Console)
      - AUTH_GOOGLE_SECRET (from Google Cloud Console)
      - AUTH_ALLOWED_DOMAIN (your company domain, e.g., "company.com")
    - Ensure Google OAuth redirect URI is configured: http://localhost:3000/api/auth/callback/google

    Test steps:
    1. Start dev server: `pnpm dev`
    2. Visit http://localhost:3000
       - Expected: Redirected to /login
    3. Click "Sign in with Google"
       - Expected: Google OAuth picker appears (limited to company domain)
    4. Sign in with company Google account
       - Expected: Redirected to home page with "Welcome to Relay, [FirstName]!"
    5. Click "Profile" in navigation
       - Expected: Profile page shows your Google name, email, and avatar
       - Expected: Contribution statistics show placeholder values (-)
    6. Click "Sign out"
       - Expected: Redirected to /login page
    7. Try visiting http://localhost:3000/profile directly
       - Expected: Redirected to /login

    If sign-in fails with non-company email:
    - Expected: Redirected to /login with error message "Access denied"
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Run from project root:

1. TypeScript compiles:
   ```bash
   pnpm typecheck
   ```

2. Build succeeds:
   ```bash
   pnpm build
   ```

3. Files exist with correct patterns:
   ```bash
   grep -l "auth()" apps/web/app/\(protected\)/profile/page.tsx
   grep -l "signOut" apps/web/components/sign-out-button.tsx
   ```

4. Manual verification via human checkpoint (see above)
</verification>

<success_criteria>
- Profile page displays name from Google
- Profile page displays avatar from Google
- Profile page displays email
- Profile page shows contribution statistics placeholder (4 stat boxes)
- Sign out button works and redirects to /login
- Protected layout shows header with navigation on all protected pages
- Home page personalized with user's first name
- TypeScript compiles without errors
- Build succeeds
- Human verification confirms full auth flow works
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-03-SUMMARY.md`
</output>
