---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/auth.config.ts
  - apps/web/auth.ts
  - apps/web/app/api/auth/[...nextauth]/route.ts
  - packages/db/src/schema/auth.ts
  - packages/db/src/schema/users.ts
  - packages/db/src/schema/index.ts
  - apps/web/package.json
autonomous: true
user_setup:
  - service: google-oauth
    why: "Google Workspace SSO authentication"
    env_vars:
      - name: AUTH_SECRET
        source: "Generate with: openssl rand -base64 32"
      - name: AUTH_GOOGLE_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: AUTH_GOOGLE_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client Secret"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add authorized redirect URI: http://localhost:3000/api/auth/callback/google"
        location: "OAuth 2.0 Client -> Authorized redirect URIs"

must_haves:
  truths:
    - "Auth.js v5 is installed and configured"
    - "Google OAuth provider is configured with domain restriction"
    - "Database schema supports Auth.js (accounts, sessions, verificationTokens)"
    - "API route handles OAuth callbacks at /api/auth/*"
  artifacts:
    - path: "apps/web/auth.config.ts"
      provides: "Edge-compatible auth configuration"
      contains: "Google"
    - path: "apps/web/auth.ts"
      provides: "Full auth configuration with Drizzle adapter"
      exports: ["auth", "signIn", "signOut", "handlers"]
    - path: "apps/web/app/api/auth/[...nextauth]/route.ts"
      provides: "Auth API route handlers"
      exports: ["GET", "POST"]
    - path: "packages/db/src/schema/auth.ts"
      provides: "Auth-related database tables"
      contains: "accounts"
  key_links:
    - from: "apps/web/auth.ts"
      to: "@relay/db"
      via: "DrizzleAdapter import"
      pattern: "DrizzleAdapter.*db"
    - from: "apps/web/auth.ts"
      to: "apps/web/auth.config.ts"
      via: "config spread"
      pattern: "authConfig"
---

<objective>
Configure Auth.js v5 with Google OAuth provider and Drizzle adapter for PostgreSQL.

Purpose: Enable Google Workspace SSO authentication with company domain restriction, storing user accounts in the existing PostgreSQL database.

Output: Complete auth configuration files, database schema for Auth.js tables, and API route handler.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-RESEARCH.md
@packages/db/src/schema/users.ts
@packages/db/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Auth.js dependencies and create auth schema</name>
  <files>
    - apps/web/package.json
    - packages/db/src/schema/auth.ts
    - packages/db/src/schema/users.ts
    - packages/db/src/schema/index.ts
  </files>
  <action>
1. Install Auth.js dependencies in apps/web:
   ```bash
   cd apps/web && pnpm add next-auth@beta @auth/drizzle-adapter
   ```

2. Modify packages/db/src/schema/users.ts:
   - Change `id` from `uuid("id").primaryKey().defaultRandom()` to `text("id").primaryKey().$defaultFn(() => crypto.randomUUID())`
   - This is required because Auth.js DrizzleAdapter expects text primary keys
   - Keep all other fields (email, name, avatarUrl, createdAt, updatedAt)

3. Create packages/db/src/schema/auth.ts with Auth.js required tables:
   - `accounts` table with composite PK (provider, providerAccountId), references users.id with cascade delete
   - `sessions` table with sessionToken PK, references users.id with cascade delete
   - `verificationTokens` table with composite PK (identifier, token)
   - Import AdapterAccountType from "next-auth/adapters" for the type column
   - Follow exact schema from research (02-RESEARCH.md Code Examples section)

4. Update packages/db/src/schema/index.ts to export auth schema:
   ```typescript
   export * from "./users";
   export * from "./auth";
   ```

5. Run drizzle-kit push to sync schema:
   ```bash
   cd packages/db && pnpm db:push
   ```
   Note: This may fail if DATABASE_URL not set - that's expected in sandbox. Schema files are still valid.
  </action>
  <verify>
    - `pnpm --filter @relay/web exec -- cat package.json | grep next-auth` shows next-auth@beta
    - `cat packages/db/src/schema/auth.ts` contains accounts, sessions, verificationTokens exports
    - `cat packages/db/src/schema/users.ts` shows text("id") instead of uuid("id")
    - TypeScript compiles: `pnpm typecheck` passes
  </verify>
  <done>
    - Auth.js packages installed in apps/web
    - Users table uses text id for Auth.js compatibility
    - accounts, sessions, verificationTokens tables defined
    - Schema exports updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Auth.js configuration files and API route</name>
  <files>
    - apps/web/auth.config.ts
    - apps/web/auth.ts
    - apps/web/app/api/auth/[...nextauth]/route.ts
  </files>
  <action>
1. Create apps/web/auth.config.ts (Edge-compatible, no database imports):
   ```typescript
   import Google from "next-auth/providers/google"
   import type { NextAuthConfig } from "next-auth"

   // Edge-compatible configuration - no database imports
   export default {
     providers: [
       Google({
         authorization: {
           params: {
             // Restrict Google picker to company domain (UX only, not security)
             hd: process.env.AUTH_ALLOWED_DOMAIN || "company.com",
           },
         },
       }),
     ],
     pages: {
       signIn: "/login",
       error: "/login",  // Redirect auth errors to login page
     },
     callbacks: {
       authorized: async ({ auth }) => {
         // Used by middleware to check authentication
         return !!auth
       },
     },
   } satisfies NextAuthConfig
   ```

2. Create apps/web/auth.ts (full config with Drizzle adapter):
   ```typescript
   import NextAuth from "next-auth"
   import { DrizzleAdapter } from "@auth/drizzle-adapter"
   import { db } from "@relay/db"
   import { users, accounts, sessions, verificationTokens } from "@relay/db/schema"
   import authConfig from "./auth.config"

   const ALLOWED_DOMAIN = process.env.AUTH_ALLOWED_DOMAIN || "company.com"

   export const { handlers, auth, signIn, signOut } = NextAuth({
     adapter: DrizzleAdapter(db, {
       usersTable: users,
       accountsTable: accounts,
       sessionsTable: sessions,
       verificationTokensTable: verificationTokens,
     }),
     session: { strategy: "jwt" },  // Required for Edge middleware
     callbacks: {
       async signIn({ account, profile }) {
         // Security validation - cannot be bypassed
         if (account?.provider === "google") {
           const isVerified = profile?.email_verified === true
           const isAllowedDomain = profile?.email?.endsWith(`@${ALLOWED_DOMAIN}`)
           return isVerified && !!isAllowedDomain
         }
         return false  // Reject non-Google providers
       },
       async jwt({ token, user }) {
         // Add user id to token on first sign in
         if (user) {
           token.id = user.id
         }
         return token
       },
       async session({ session, token }) {
         // Add user id to session
         if (session.user && token.id) {
           session.user.id = token.id as string
         }
         return session
       },
     },
     ...authConfig,
   })
   ```

3. Create apps/web/app/api/auth/[...nextauth]/route.ts:
   ```typescript
   import { handlers } from "@/auth"

   export const { GET, POST } = handlers
   ```

4. Create path alias in apps/web/tsconfig.json if not exists:
   - Verify `"@/*": ["./app/*"]` or `"@/*": ["./*"]` path alias exists
   - If using "./*", auth.ts is at "@/auth"
  </action>
  <verify>
    - `cat apps/web/auth.config.ts` shows Google provider with hd parameter
    - `cat apps/web/auth.ts` shows DrizzleAdapter, signIn callback with domain check
    - `cat apps/web/app/api/auth/[...nextauth]/route.ts` exports GET and POST
    - TypeScript compiles: `pnpm typecheck` passes
  </verify>
  <done>
    - auth.config.ts provides Edge-compatible configuration
    - auth.ts provides full configuration with Drizzle adapter and domain restriction
    - API route handler exports GET and POST for OAuth callbacks
    - Domain restriction enforced in signIn callback (security) and hd param (UX)
  </done>
</task>

</tasks>

<verification>
Run from project root:

1. Dependencies installed:
   ```bash
   pnpm --filter @relay/web list next-auth
   ```

2. TypeScript compiles:
   ```bash
   pnpm typecheck
   ```

3. Schema files exist with correct exports:
   ```bash
   grep -l "accounts" packages/db/src/schema/auth.ts
   grep -l "handlers" apps/web/auth.ts
   ```

4. Build succeeds:
   ```bash
   pnpm build
   ```
</verification>

<success_criteria>
- Auth.js v5 (next-auth@beta) installed in apps/web
- Database schema includes accounts, sessions, verificationTokens tables
- Users table uses text id for Auth.js compatibility
- auth.config.ts provides Edge-compatible config with Google provider
- auth.ts provides full config with Drizzle adapter and domain restriction
- API route at /api/auth/[...nextauth] handles OAuth callbacks
- TypeScript compiles without errors
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
