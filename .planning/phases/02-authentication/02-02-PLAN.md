---
phase: 02-authentication
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/web/middleware.ts
  - apps/web/app/(auth)/login/page.tsx
  - apps/web/app/layout.tsx
  - apps/web/components/providers.tsx
autonomous: true

must_haves:
  truths:
    - "Unauthenticated users are redirected to /login"
    - "Login page displays Google sign-in button"
    - "Static assets and API routes are not blocked by middleware"
    - "SessionProvider wraps the application for client-side session access"
  artifacts:
    - path: "apps/web/middleware.ts"
      provides: "Route protection middleware"
      contains: "auth"
    - path: "apps/web/app/(auth)/login/page.tsx"
      provides: "Login page with Google sign-in"
      contains: "signIn"
    - path: "apps/web/components/providers.tsx"
      provides: "Client-side providers wrapper"
      contains: "SessionProvider"
  key_links:
    - from: "apps/web/middleware.ts"
      to: "apps/web/auth.config.ts"
      via: "Edge-compatible auth import"
      pattern: "authConfig"
    - from: "apps/web/app/(auth)/login/page.tsx"
      to: "apps/web/auth.ts"
      via: "signIn server action"
      pattern: 'signIn.*"google"'
---

<objective>
Implement route protection middleware and login page for Google SSO.

Purpose: Ensure only authenticated users with company domain emails can access the application, with a clear login flow.

Output: Middleware for route protection, login page with Google sign-in, and SessionProvider for client components.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication/02-RESEARCH.md
@.planning/phases/02-authentication/02-01-SUMMARY.md
@apps/web/auth.config.ts
@apps/web/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create middleware and SessionProvider</name>
  <files>
    - apps/web/middleware.ts
    - apps/web/components/providers.tsx
    - apps/web/app/layout.tsx
  </files>
  <action>
1. Create apps/web/middleware.ts (uses Edge-compatible auth.config):
   ```typescript
   import NextAuth from "next-auth"
   import authConfig from "./auth.config"

   const { auth } = NextAuth(authConfig)

   export default auth((req) => {
     const isLoggedIn = !!req.auth
     const isLoginPage = req.nextUrl.pathname === "/login"
     const isAuthApi = req.nextUrl.pathname.startsWith("/api/auth")

     // Allow auth API routes
     if (isAuthApi) {
       return
     }

     // Redirect unauthenticated users to login
     if (!isLoggedIn && !isLoginPage) {
       const loginUrl = new URL("/login", req.nextUrl.origin)
       // Preserve the original URL as callback
       loginUrl.searchParams.set("callbackUrl", req.nextUrl.pathname)
       return Response.redirect(loginUrl)
     }

     // Redirect authenticated users away from login page
     if (isLoggedIn && isLoginPage) {
       return Response.redirect(new URL("/", req.nextUrl.origin))
     }
   })

   export const config = {
     // Match all routes except static files, images, and auth API
     matcher: [
       "/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)",
     ],
   }
   ```

2. Create apps/web/components/providers.tsx:
   ```typescript
   "use client"

   import { SessionProvider } from "next-auth/react"
   import type { ReactNode } from "react"

   interface ProvidersProps {
     children: ReactNode
   }

   export function Providers({ children }: ProvidersProps) {
     return <SessionProvider>{children}</SessionProvider>
   }
   ```

3. Update apps/web/app/layout.tsx to wrap with Providers:
   ```typescript
   import type { Metadata } from "next"
   import { Providers } from "@/components/providers"
   import "./globals.css"

   export const metadata: Metadata = {
     title: "Relay - Internal Skill Marketplace",
     description: "Connect with colleagues who have the skills you need",
   }

   export default function RootLayout({
     children,
   }: Readonly<{
     children: React.ReactNode
   }>) {
     return (
       <html lang="en">
         <body className="antialiased">
           <Providers>{children}</Providers>
         </body>
       </html>
     )
   }
   ```
  </action>
  <verify>
    - `cat apps/web/middleware.ts` shows auth import from auth.config, matcher excludes static assets
    - `cat apps/web/components/providers.tsx` shows SessionProvider
    - `cat apps/web/app/layout.tsx` shows Providers wrapper
    - `pnpm typecheck` passes
  </verify>
  <done>
    - Middleware protects all routes except /login, /api/auth/*, and static assets
    - Unauthenticated users redirected to /login with callbackUrl preserved
    - Authenticated users redirected away from /login to /
    - SessionProvider wraps app for client-side useSession hook
  </done>
</task>

<task type="auto">
  <name>Task 2: Create login page with Google sign-in</name>
  <files>
    - apps/web/app/(auth)/login/page.tsx
  </files>
  <action>
1. Create apps/web/app/(auth)/login/page.tsx:
   ```typescript
   import { signIn } from "@/auth"

   interface LoginPageProps {
     searchParams: Promise<{ callbackUrl?: string; error?: string }>
   }

   export default async function LoginPage({ searchParams }: LoginPageProps) {
     const { callbackUrl, error } = await searchParams

     return (
       <div className="min-h-screen flex items-center justify-center bg-gray-50">
         <div className="max-w-md w-full space-y-8 p-8">
           <div className="text-center">
             <h1 className="text-3xl font-bold text-gray-900">
               Welcome to Relay
             </h1>
             <p className="mt-2 text-gray-600">
               Internal Skill Marketplace
             </p>
           </div>

           {error && (
             <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
               {error === "AccessDenied" ? (
                 <p>Access denied. Please sign in with your company email.</p>
               ) : (
                 <p>An error occurred. Please try again.</p>
               )}
             </div>
           )}

           <form
             action={async () => {
               "use server"
               await signIn("google", {
                 redirectTo: callbackUrl || "/",
               })
             }}
             className="mt-8"
           >
             <button
               type="submit"
               className="w-full flex items-center justify-center gap-3 px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
             >
               <svg className="w-5 h-5" viewBox="0 0 24 24">
                 <path
                   fill="#4285F4"
                   d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                 />
                 <path
                   fill="#34A853"
                   d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                 />
                 <path
                   fill="#FBBC05"
                   d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                 />
                 <path
                   fill="#EA4335"
                   d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                 />
               </svg>
               Sign in with Google
             </button>
           </form>

           <p className="text-center text-sm text-gray-500">
             Sign in with your company Google account
           </p>
         </div>
       </div>
     )
   }
   ```

2. Ensure the (auth) route group directory structure is created:
   - The parentheses in (auth) make it a route group (doesn't affect URL)
   - /login URL maps to app/(auth)/login/page.tsx
  </action>
  <verify>
    - `cat apps/web/app/\(auth\)/login/page.tsx` shows signIn server action with "google" provider
    - Login page handles error query param for access denied messages
    - `pnpm typecheck` passes
    - `pnpm build` succeeds
  </verify>
  <done>
    - Login page at /login with Google sign-in button
    - Server action triggers Google OAuth flow
    - Error handling for AccessDenied (wrong domain)
    - callbackUrl preserved for post-login redirect
    - Clean, minimal UI with Tailwind styling
  </done>
</task>

</tasks>

<verification>
Run from project root:

1. TypeScript compiles:
   ```bash
   pnpm typecheck
   ```

2. Build succeeds:
   ```bash
   pnpm build
   ```

3. Files exist with correct patterns:
   ```bash
   grep -l "NextAuth" apps/web/middleware.ts
   grep -l "signIn" apps/web/app/\(auth\)/login/page.tsx
   grep -l "SessionProvider" apps/web/components/providers.tsx
   ```

4. Start dev server and verify:
   - Visiting http://localhost:3000 redirects to /login
   - Login page displays Google sign-in button
   - Static assets (images, favicon) load without redirect
</verification>

<success_criteria>
- Middleware redirects unauthenticated users to /login
- Middleware allows /api/auth/* routes for OAuth callbacks
- Middleware excludes static assets from protection
- Login page displays Google sign-in button with company branding
- Error messages shown for access denied (wrong domain)
- SessionProvider wraps application for client-side session access
- TypeScript compiles without errors
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-02-SUMMARY.md`
</output>
