---
phase: 44-admin-global-skills
plan: 02
type: execute
wave: 2
depends_on: ["44-01"]
files_modified:
  - apps/web/components/company-approved-badge.tsx
  - apps/web/components/skill-detail.tsx
  - apps/web/components/skills-table.tsx
  - apps/web/components/skills-table-row.tsx
  - apps/web/components/trending-section.tsx
  - apps/web/lib/search-skills.ts
  - apps/web/lib/trending.ts
  - apps/web/lib/company-approved.ts
  - apps/web/components/company-approved-section.tsx
  - apps/web/app/(protected)/page.tsx
  - apps/web/app/(protected)/skills/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Company Approved badge appears on skill detail page next to skill name"
    - "Company Approved badge appears in browse table rows and trending cards"
    - "Homepage shows a Company Recommended section with approved skills between Platform Stats and Trending"
    - "Homepage hides the Company Recommended section when no skills are approved"
  artifacts:
    - path: "apps/web/components/company-approved-badge.tsx"
      provides: "Indigo shield-check badge component with sm/md sizes"
      contains: "CompanyApprovedBadge"
    - path: "apps/web/lib/company-approved.ts"
      provides: "getCompanyApprovedSkills query function"
      contains: "getCompanyApprovedSkills"
    - path: "apps/web/components/company-approved-section.tsx"
      provides: "Homepage section rendering approved skill cards"
      contains: "CompanyApprovedSection"
  key_links:
    - from: "apps/web/app/(protected)/page.tsx"
      to: "apps/web/lib/company-approved.ts"
      via: "fetches approved skills in Promise.all"
      pattern: "getCompanyApprovedSkills"
    - from: "apps/web/app/(protected)/page.tsx"
      to: "apps/web/components/company-approved-section.tsx"
      via: "renders section between stats and trending"
      pattern: "CompanyApprovedSection"
    - from: "apps/web/components/skill-detail.tsx"
      to: "apps/web/components/company-approved-badge.tsx"
      via: "renders badge next to skill name when companyApproved is true"
      pattern: "CompanyApprovedBadge"
    - from: "apps/web/lib/search-skills.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "includes companyApproved in select fields"
      pattern: "companyApproved"
---

<objective>
Add Company Approved badge everywhere skills appear, and create the homepage Company Recommended section.

Purpose: Users see which skills are company-endorsed via distinctive badges, and discover them on the homepage.
Output: Badge on detail pages, browse table, and trending cards. Homepage section with approved skills.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/44-admin-global-skills/44-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Badge component and display in detail, browse, and trending</name>
  <files>
    apps/web/components/company-approved-badge.tsx
    apps/web/components/skill-detail.tsx
    apps/web/components/skills-table.tsx
    apps/web/components/skills-table-row.tsx
    apps/web/components/trending-section.tsx
    apps/web/lib/search-skills.ts
    apps/web/lib/trending.ts
    apps/web/app/(protected)/skills/[slug]/page.tsx
  </files>
  <action>
1. Create `apps/web/components/company-approved-badge.tsx`:
   - A simple component with `size?: "sm" | "md"` prop (default "sm").
   - Renders an inline-flex span with: `bg-indigo-100 text-indigo-800 border border-indigo-200 rounded-full font-medium`
   - Size classes: sm = `text-xs px-2 py-0.5`, md = `text-sm px-3 py-1`
   - Contains an inline SVG shield-check icon (Heroicons shield-check, 16x16 for sm, 20x20 for md).
   - At md size, include text "Company Approved" after the icon.
   - At sm size, show only the shield icon (tooltip: "Company Approved" via title attribute on the span).

2. Update data flow to pass `companyApproved` through:
   - `apps/web/lib/search-skills.ts`: Add `companyApproved: skills.companyApproved` to the select fields in the `baseQuery`. Add `companyApproved: boolean` to the `SearchSkillResult` interface.
   - `apps/web/lib/trending.ts`: Add `s.company_approved` to the SQL SELECT and add `companyApproved: boolean` to the `TrendingSkill` interface. Map it: `companyApproved: row.company_approved === true`.
   - `apps/web/components/skills-table.tsx`: Add `companyApproved?: boolean` to the `SkillTableRow` interface.

3. Add badge to display components:
   - `apps/web/components/skill-detail.tsx`: Add `companyApproved?: boolean` to `SkillWithAuthor` interface. Import and render `<CompanyApprovedBadge size="md" />` next to `<QualityBadge>` in the header's flex container (line ~82-84), conditionally when `skill.companyApproved` is true.
   - `apps/web/app/(protected)/skills/[slug]/page.tsx`: The skill is fetched via `db.query.skills.findFirst` which returns all columns including `companyApproved`. Pass `companyApproved={skill.companyApproved}` in the skill object passed to `<SkillDetail>`. Since `findFirst` returns all columns, `companyApproved` is already available -- just ensure the prop is included in the spread/object.
   - `apps/web/components/skills-table-row.tsx`: Import `CompanyApprovedBadge`. In the name cell (td with skill.name link), after the loomUrl play icon, add: `{skill.companyApproved && <CompanyApprovedBadge size="sm" />}` with `ml-2` spacing.
   - `apps/web/components/trending-section.tsx`: Import `CompanyApprovedBadge`. Update props interface to accept `TrendingSkill` which now includes `companyApproved`. In the skill card header area (after the category badge span and loom icon), add: `{skill.companyApproved && <CompanyApprovedBadge size="sm" />}` in the badges flex container.
  </action>
  <verify>
    `cd /home/dev/projects/relay && pnpm build` succeeds.
    Visit a skill detail page for an approved skill -- badge appears next to the name.
    Browse table shows small shield icon for approved skills.
  </verify>
  <done>CompanyApprovedBadge component created. Badge renders on skill detail page (md), browse table rows (sm), and trending cards (sm). Data flow updated in search-skills.ts, trending.ts, and skills-table.tsx interfaces.</done>
</task>

<task type="auto">
  <name>Task 2: Homepage Company Recommended section</name>
  <files>
    apps/web/lib/company-approved.ts
    apps/web/components/company-approved-section.tsx
    apps/web/app/(protected)/page.tsx
  </files>
  <action>
1. Create `apps/web/lib/company-approved.ts`:
   ```typescript
   import { db, skills, users } from "@everyskill/db";
   import { eq, and, desc, sql } from "drizzle-orm";

   export interface CompanyApprovedSkill {
     id: string;
     name: string;
     slug: string;
     description: string;
     category: string;
     totalUses: number;
     loomUrl: string | null;
     authorName: string | null;
   }

   export async function getCompanyApprovedSkills(limit = 6): Promise<CompanyApprovedSkill[]> {
     if (!db) return [];
     const rows = await db
       .select({
         id: skills.id,
         name: skills.name,
         slug: skills.slug,
         description: skills.description,
         category: skills.category,
         totalUses: skills.totalUses,
         loomUrl: skills.loomUrl,
         authorName: users.name,
       })
       .from(skills)
       .leftJoin(users, eq(skills.authorId, users.id))
       .where(
         and(
           eq(skills.companyApproved, true),
           eq(skills.status, "published"),
           eq(skills.visibility, "tenant")
         )
       )
       .orderBy(desc(skills.approvedAt))
       .limit(limit);
     return rows;
   }
   ```

2. Create `apps/web/components/company-approved-section.tsx` as a client component:
   - Props: `skills: CompanyApprovedSkill[]` (import the type from `@/lib/company-approved`)
   - If skills array is empty, return null (don't render section at all).
   - Section header: Shield icon (inline SVG) + "Company Recommended" text in indigo color.
   - Grid: `grid gap-4 lg:grid-cols-2` (same layout as TrendingSection).
   - Each card is a Link to `/skills/{slug}` with:
     - Skill name, description (line-clamp-2), category badge
     - CompanyApprovedBadge (sm) next to category badge
     - Author name and total uses in footer
     - Card style: rounded-lg border bg-white p-4 shadow-sm hover:border-indigo-300 hover:shadow-md (indigo accent instead of blue to match the badge)

3. Update `apps/web/app/(protected)/page.tsx`:
   - Import `getCompanyApprovedSkills` from `@/lib/company-approved`.
   - Import `CompanyApprovedSection` from `@/components/company-approved-section`.
   - Add `getCompanyApprovedSkills(6)` to the existing `Promise.all` call (add as 9th element).
   - Destructure the result as `companyApproved`.
   - In the `browseContent` JSX, insert the section BETWEEN the Platform Stats div (mb-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-4) and the Trending/Leaderboard div (mb-8 grid gap-8 lg:grid-cols-3):
     ```tsx
     {/* Company Recommended */}
     {companyApproved.length > 0 && (
       <div className="mb-8">
         <CompanyApprovedSection skills={companyApproved} />
       </div>
     )}
     ```
   - The section only renders when there are approved skills, per the requirement.
  </action>
  <verify>
    `cd /home/dev/projects/relay && pnpm build` succeeds.
    Visit homepage -- if any skills are approved, "Company Recommended" section appears between Platform Stats and Trending.
    If no skills are approved, the section does not render.
  </verify>
  <done>Homepage shows Company Recommended section with approved skills in indigo-accented cards. Section is hidden when no skills are approved. Query fetches published, tenant-visible, company_approved=true skills ordered by approved_at DESC.</done>
</task>

</tasks>

<verification>
1. `pnpm build` -- no type errors
2. CompanyApprovedBadge renders correctly at sm and md sizes
3. Skill detail page shows md badge next to skill name for approved skills
4. Browse table shows sm badge (shield icon) next to name for approved skills
5. Trending cards show sm badge next to category for approved skills
6. Homepage shows "Company Recommended" section when approved skills exist
7. Homepage hides the section when no skills are approved
8. Company Recommended cards link to skill detail pages
</verification>

<success_criteria>
- Badge visible on detail page, browse table, and trending section for approved skills
- Homepage Company Recommended section appears between Platform Stats and Trending
- Section hidden when no approved skills exist
- All data flows include companyApproved field
- No type errors, no hydration errors
</success_criteria>

<output>
After completion, create `.planning/phases/44-admin-global-skills/44-02-SUMMARY.md`
</output>
