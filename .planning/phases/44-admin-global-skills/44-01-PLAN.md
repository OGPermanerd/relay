---
phase: 44-admin-global-skills
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/skills.ts
  - packages/db/src/migrations/0022_add_company_approved.sql
  - packages/db/src/relations/index.ts
  - apps/web/app/actions/admin-skills.ts
  - apps/web/components/admin-skills-table.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can toggle any skill's company-approved status from the admin skills table"
    - "Approval records who approved and when"
    - "Admin skills table shows an Approved column with visual toggle per row"
  artifacts:
    - path: "packages/db/src/schema/skills.ts"
      provides: "companyApproved, approvedAt, approvedBy columns"
      contains: "companyApproved"
    - path: "packages/db/src/migrations/0022_add_company_approved.sql"
      provides: "Migration adding 3 columns + partial index"
      contains: "company_approved"
    - path: "apps/web/app/actions/admin-skills.ts"
      provides: "toggleCompanyApproval server action"
      contains: "toggleCompanyApproval"
    - path: "apps/web/components/admin-skills-table.tsx"
      provides: "Approved column with toggle button"
      contains: "companyApproved"
  key_links:
    - from: "apps/web/components/admin-skills-table.tsx"
      to: "apps/web/app/actions/admin-skills.ts"
      via: "toggleCompanyApproval action bound to approve button"
      pattern: "toggleCompanyApproval"
    - from: "apps/web/app/actions/admin-skills.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "updates companyApproved, approvedAt, approvedBy columns"
      pattern: "companyApproved.*approvedAt.*approvedBy"
---

<objective>
Add company-approved schema columns, migration, server action, and admin toggle UI.

Purpose: Foundation for the Company Approved feature -- schema, data layer, and admin controls.
Output: Admin can toggle approval from /admin/skills; approval state persists with audit trail.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema, migration, and relations</name>
  <files>
    packages/db/src/schema/skills.ts
    packages/db/src/migrations/0022_add_company_approved.sql
    packages/db/src/relations/index.ts
  </files>
  <action>
1. In `packages/db/src/schema/skills.ts`, add 3 columns to the skills table definition (after the `loomUrl` field):
   - `companyApproved: boolean("company_approved").notNull().default(false)`  (note: import `boolean` from `drizzle-orm/pg-core`)
   - `approvedAt: timestamp("approved_at")`
   - `approvedBy: text("approved_by").references(() => users.id)`

2. Create migration `packages/db/src/migrations/0022_add_company_approved.sql`:
   ```sql
   ALTER TABLE skills ADD COLUMN company_approved BOOLEAN NOT NULL DEFAULT false;
   ALTER TABLE skills ADD COLUMN approved_at TIMESTAMP;
   ALTER TABLE skills ADD COLUMN approved_by TEXT REFERENCES users(id);
   CREATE INDEX skills_company_approved_idx ON skills (company_approved) WHERE company_approved = true;
   ```

3. Run migration: `psql "$DATABASE_URL" -f packages/db/src/migrations/0022_add_company_approved.sql`

4. In `packages/db/src/relations/index.ts`, add `approvedByUser` relation to `skillsRelations`:
   ```typescript
   approvedByUser: one(users, {
     fields: [skills.approvedBy],
     references: [users.id],
     relationName: "approvedSkills",
   }),
   ```
   This needs `relationName` to avoid conflict with the existing `author` relation to users.
  </action>
  <verify>
    `psql "$DATABASE_URL" -c "SELECT company_approved, approved_at, approved_by FROM skills LIMIT 1"` returns columns without error.
    `cd /home/dev/projects/relay && pnpm build` succeeds (schema types compile).
  </verify>
  <done>skills table has company_approved (bool default false), approved_at (timestamp), approved_by (text FK) columns. Partial index exists. Relations updated.</done>
</task>

<task type="auto">
  <name>Task 2: Server action and admin table toggle</name>
  <files>
    apps/web/app/actions/admin-skills.ts
    apps/web/components/admin-skills-table.tsx
  </files>
  <action>
1. In `apps/web/app/actions/admin-skills.ts`:
   - Add `companyApproved: boolean` to the `AdminSkill` type.
   - In `getAdminSkills()`, add `companyApproved: skills.companyApproved` to the select fields and map it through to the return value.
   - Add new action type and action:
     ```typescript
     export type ToggleApprovalState = {
       success?: boolean;
       error?: string;
     };

     export async function toggleCompanyApproval(
       prevState: ToggleApprovalState,
       formData: FormData
     ): Promise<ToggleApprovalState> {
       const session = await auth();
       if (!session?.user?.id || !isAdmin(session)) {
         return { error: "Unauthorized" };
       }
       const skillId = formData.get("skillId") as string;
       const currentlyApproved = formData.get("currentlyApproved") === "true";
       if (!skillId) {
         return { error: "Skill ID is required" };
       }

       // Toggle: if currently approved, remove approval; otherwise, approve
       if (currentlyApproved) {
         await db.update(skills).set({
           companyApproved: false,
           approvedAt: null,
           approvedBy: null,
         }).where(eq(skills.id, skillId));
       } else {
         await db.update(skills).set({
           companyApproved: true,
           approvedAt: new Date(),
           approvedBy: session.user.id,
         }).where(eq(skills.id, skillId));
       }

       revalidatePath("/admin/skills");
       revalidatePath("/");  // Homepage Company Recommended section
       return { success: true };
     }
     ```
   - Import `boolean` type is not needed at runtime; the `skills.companyApproved` field is already typed by Drizzle.

2. In `apps/web/components/admin-skills-table.tsx`:
   - Import `toggleCompanyApproval` and `ToggleApprovalState` from the actions file.
   - Add a new `useActionState` for the toggle action.
   - Add an "Approved" column header between "Uses" and "Created" in the thead.
   - In each row, add a td for the approved status with a form containing:
     - Hidden input for `skillId` and `currentlyApproved`
     - A button styled as a toggle indicator:
       - When approved: green shield-check icon with "Approved" text, clicking unapproves
       - When not approved: gray dash, clicking approves
     - Use `useActionState` with the `toggleCompanyApproval` action.
   - Since the table is a single client component, use a single `useActionState` and pass `skillId` + `currentlyApproved` via hidden fields in per-row forms (same pattern as deleteSkillAdminAction).
  </action>
  <verify>
    `cd /home/dev/projects/relay && pnpm build` succeeds.
    Visit `http://localhost:2002/admin/skills` -- table shows "Approved" column with toggle buttons. Clicking a toggle changes the skill's approval state (page reloads with new state).
  </verify>
  <done>Admin skills table shows approval column. Clicking toggle calls toggleCompanyApproval action which sets/clears companyApproved + audit fields. Both /admin/skills and / paths revalidated.</done>
</task>

</tasks>

<verification>
1. `psql "$DATABASE_URL" -c "SELECT company_approved, approved_at, approved_by FROM skills LIMIT 1"` -- columns exist
2. `pnpm build` -- no type errors
3. Admin table at /admin/skills shows Approved column with per-row toggles
4. Toggling a skill sets company_approved=true, approved_at=NOW(), approved_by=admin user ID
5. Toggling again sets company_approved=false, approved_at=null, approved_by=null
</verification>

<success_criteria>
- Schema has 3 new columns with partial index
- toggleCompanyApproval server action works with admin auth guard
- Admin skills table displays and toggles approval state per skill
- Both /admin/skills and / paths are revalidated on toggle
</success_criteria>

<output>
After completion, create `.planning/phases/44-admin-global-skills/44-01-SUMMARY.md`
</output>
