---
phase: 15-embeddings-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/embeddings.ts
  - apps/web/package.json
autonomous: true
user_setup:
  - service: voyage-ai
    why: "Embedding generation for semantic search"
    env_vars:
      - name: VOYAGE_API_KEY
        source: "Voyage AI Dashboard -> API Keys (https://dash.voyageai.com/api-keys)"
    dashboard_config: []

must_haves:
  truths:
    - "generateEmbedding function returns 1024-dimension array"
    - "generateEmbeddingsBatch handles multiple texts with throttling"
    - "API errors are caught and re-thrown with context"
  artifacts:
    - path: "apps/web/lib/embeddings.ts"
      provides: "Voyage AI client wrapper"
      exports: ["generateEmbedding", "generateEmbeddingsBatch", "EMBEDDING_MODEL", "EMBEDDING_DIMENSIONS"]
    - path: "apps/web/package.json"
      provides: "voyageai dependency"
      contains: "voyageai"
  key_links:
    - from: "apps/web/lib/embeddings.ts"
      to: "process.env.VOYAGE_API_KEY"
      via: "environment variable"
      pattern: "VOYAGE_API_KEY"
---

<objective>
Create the Voyage AI embedding service with batch support.

Purpose: Provide the embedding generation capability needed for both new skill publishing and backfill migration.
Output: Typed wrapper around Voyage AI SDK with single and batch embedding functions.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-embeddings-foundation/15-CONTEXT.md
@.planning/phases/15-embeddings-foundation/15-RESEARCH.md
@apps/web/lib/content-hash.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install voyageai SDK</name>
  <files>apps/web/package.json</files>
  <action>
Add the official Voyage AI TypeScript SDK to the web app.

Command:
```bash
pnpm --filter web add voyageai
```

The voyageai package provides:
- TypeScript types for API responses
- Built-in retry handling for 429/5XX errors
- Batch embedding support
  </action>
  <verify>`pnpm --filter web list voyageai` shows the package installed</verify>
  <done>voyageai SDK is installed in apps/web</done>
</task>

<task type="auto">
  <name>Task 2: Create embedding service</name>
  <files>apps/web/lib/embeddings.ts</files>
  <action>
Create the Voyage AI wrapper with single and batch embedding functions.

File: apps/web/lib/embeddings.ts

Constants to export:
- EMBEDDING_MODEL = "voyage-code-3"
- EMBEDDING_DIMENSIONS = 1024
- EMBEDDING_VERSION = "1.0"

Functions:

1. generateEmbedding(text: string): Promise<number[]>
   - Creates VoyageAIClient with process.env.VOYAGE_API_KEY
   - Calls client.embed with:
     - input: [text]
     - model: EMBEDDING_MODEL
     - inputType: "document"
     - outputDimension: EMBEDDING_DIMENSIONS
   - Returns response.data[0].embedding
   - Catches VoyageAIError and re-throws with context
   - Throws if VOYAGE_API_KEY is not set

2. generateEmbeddingsBatch(texts: string[], delayMs = 150): Promise<number[][]>
   - For backfill migration with throttling
   - Batch size: 128 (optimal per Voyage docs)
   - Processes in batches, adds delayMs between batches
   - Returns array of embeddings in same order as input texts
   - Uses inputType: "document" for all

Import VoyageAIClient and VoyageAIError from "voyageai" package.
  </action>
  <verify>
- `pnpm --filter web typecheck` passes
- File exports generateEmbedding, generateEmbeddingsBatch, constants
- Error handling wraps VoyageAIError
  </verify>
  <done>Embedding service created with single and batch functions, proper error handling</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `pnpm --filter web typecheck`
2. voyageai is in package.json dependencies
3. embeddings.ts exports all required functions and constants
4. Error handling is implemented for VoyageAIError
</verification>

<success_criteria>
- generateEmbedding accepts text, returns number[] of length 1024
- generateEmbeddingsBatch handles arrays with throttling between batches
- Constants exported for model name, dimensions, version
- API key validation throws clear error if missing
</success_criteria>

<output>
After completion, create `.planning/phases/15-embeddings-foundation/15-02-SUMMARY.md`
</output>
