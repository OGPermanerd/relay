---
phase: 15-embeddings-foundation
plan: 03
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - packages/db/src/services/skill-embeddings.ts
  - packages/db/src/services/index.ts
  - apps/web/app/actions/skills.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "New skills receive embeddings on publish"
    - "Embedding generation failure fails skill creation"
    - "Embedded content includes name, description, content, and tags"
  artifacts:
    - path: "packages/db/src/services/skill-embeddings.ts"
      provides: "Embedding CRUD operations"
      exports: ["createSkillEmbedding", "getSkillEmbedding", "findSimilarSkills"]
    - path: "apps/web/app/actions/skills.ts"
      provides: "Updated createSkill with embedding generation"
      contains: "generateEmbedding"
  key_links:
    - from: "apps/web/app/actions/skills.ts"
      to: "apps/web/lib/embeddings.ts"
      via: "import generateEmbedding"
      pattern: "import.*generateEmbedding.*from.*embeddings"
    - from: "apps/web/app/actions/skills.ts"
      to: "packages/db/src/services/skill-embeddings.ts"
      via: "import createSkillEmbedding"
      pattern: "createSkillEmbedding"
---

<objective>
Hook embedding generation into the skill publish flow.

Purpose: Ensure every new skill automatically receives a vector embedding for similarity search.
Output: Updated createSkill action that generates and stores embeddings, plus database service functions.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-embeddings-foundation/15-CONTEXT.md
@.planning/phases/15-embeddings-foundation/15-RESEARCH.md
@packages/db/src/services/skill-metrics.ts
@apps/web/app/actions/skills.ts
@apps/web/lib/content-hash.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create embedding database service</name>
  <files>packages/db/src/services/skill-embeddings.ts, packages/db/src/services/index.ts</files>
  <action>
Create database service functions for skill embeddings following the pattern in skill-metrics.ts.

File: packages/db/src/services/skill-embeddings.ts

Functions to implement:

1. createSkillEmbedding(params: CreateEmbeddingParams): Promise<void>
   - params: { skillId, embedding, modelName, modelVersion, inputHash }
   - Insert into skillEmbeddings table
   - Check if db is configured (like skill-metrics.ts pattern)

2. getSkillEmbedding(skillId: string): Promise<SkillEmbedding | null>
   - Return embedding record for a skill
   - Return null if not found

3. findSimilarSkills(queryEmbedding: number[], options?: FindSimilarOptions): Promise<SimilarSkillResult[]>
   - options: { threshold?: number, limit?: number, excludeSkillId?: string }
   - Default threshold: 0.7, default limit: 10
   - Use cosineDistance from drizzle-orm
   - Calculate similarity as: 1 - cosineDistance
   - Filter by gt(similarity, threshold)
   - Order by similarity desc
   - Return { skillId, similarity } array
   - Join with skills table to get skill name if needed

Import cosineDistance, desc, gt, sql, eq from drizzle-orm.
Import skillEmbeddings from schema.
Import db from client.

Update packages/db/src/services/index.ts to export the new service functions.
  </action>
  <verify>
- `pnpm --filter @everyskill/db typecheck` passes
- Functions exported from @everyskill/db/services
- findSimilarSkills uses cosineDistance correctly
  </verify>
  <done>Embedding database service created with create, get, and similarity search functions</done>
</task>

<task type="auto">
  <name>Task 2: Update createSkill to generate embeddings</name>
  <files>apps/web/app/actions/skills.ts</files>
  <action>
Add embedding generation to the createSkill server action.

Modifications to apps/web/app/actions/skills.ts:

1. Import at top:
   - import { generateEmbedding, EMBEDDING_MODEL, EMBEDDING_VERSION } from "@/lib/embeddings";
   - import { createSkillEmbedding } from "@everyskill/db/services/skill-embeddings";
   - import { hashContent } from "@/lib/content-hash"; (already imported)

2. After successful skill creation (after the skill insert), add embedding generation:

   Build embedding input by concatenating fields (per CONTEXT.md decision):
   ```typescript
   const embeddingInput = [
     name,
     description,
     content,
     ...(parsed.data.tags || [])
   ].join(" ");
   ```

3. Generate embedding and store it:
   ```typescript
   try {
     const embedding = await generateEmbedding(embeddingInput);
     const inputHash = await hashContent(embeddingInput);
     await createSkillEmbedding({
       skillId: newSkill.id,
       embedding,
       modelName: EMBEDDING_MODEL,
       modelVersion: EMBEDDING_VERSION,
       inputHash,
     });
   } catch (error) {
     // Log error for debugging
     console.error("Failed to generate embedding:", error);
     // Per CONTEXT.md: embedding failure should fail skill creation
     // Delete the skill we just created to maintain consistency
     await db.delete(skills).where(eq(skills.id, newSkill.id));
     return {
       message: "Failed to generate embedding for skill. Please try again.",
     };
   }
   ```

4. Add eq import from drizzle-orm if not already imported.

The embedding is generated AFTER the skill is created but BEFORE redirect.
If embedding fails, the skill is deleted and error returned to user.
  </action>
  <verify>
- `pnpm --filter web typecheck` passes
- createSkill imports embedding functions
- Embedding generated with combined name + description + content + tags
- Error handling deletes skill if embedding fails
  </verify>
  <done>createSkill action generates and stores embeddings for new skills</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `pnpm typecheck`
2. createSkill action imports and calls generateEmbedding
3. Database service exports all required functions
4. Error handling properly cleans up on embedding failure
</verification>

<success_criteria>
- New skill creation generates embedding automatically
- Embedding includes name + description + content + tags concatenated
- Failed embedding generation fails the skill creation (atomic)
- findSimilarSkills function ready for Phase 16 to use
</success_criteria>

<output>
After completion, create `.planning/phases/15-embeddings-foundation/15-03-SUMMARY.md`
</output>
