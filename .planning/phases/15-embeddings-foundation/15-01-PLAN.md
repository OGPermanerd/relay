---
phase: 15-embeddings-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/skill-embeddings.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/migrations/0001_enable_pgvector.sql
autonomous: true
user_setup: []

must_haves:
  truths:
    - "pgvector extension enabled in PostgreSQL"
    - "skill_embeddings table exists with vector column"
    - "HNSW index exists on embedding column"
  artifacts:
    - path: "packages/db/src/schema/skill-embeddings.ts"
      provides: "Embedding table schema with vector column"
      exports: ["skillEmbeddings", "SkillEmbedding", "NewSkillEmbedding"]
    - path: "packages/db/src/migrations/0001_enable_pgvector.sql"
      provides: "pgvector extension creation"
      contains: "CREATE EXTENSION"
  key_links:
    - from: "packages/db/src/schema/skill-embeddings.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "foreign key reference"
      pattern: "references.*skills\\.id"
---

<objective>
Create the skill_embeddings database schema with pgvector support.

Purpose: Establish the storage infrastructure for vector embeddings before implementing the Voyage AI integration.
Output: skill_embeddings table with 1024-dimension vector column, HNSW index, and model versioning fields.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-embeddings-foundation/15-CONTEXT.md
@.planning/phases/15-embeddings-foundation/15-RESEARCH.md
@packages/db/src/schema/skills.ts
@packages/db/drizzle.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable pgvector extension</name>
  <files>packages/db/src/migrations/0001_enable_pgvector.sql</files>
  <action>
Create a manual SQL migration file to enable the pgvector extension.

The file must run BEFORE any schema that uses the vector type. Contents:
```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

This is a manual migration because Drizzle doesn't auto-create PostgreSQL extensions.
The migration number (0001) ensures it runs after the initial schema but the extension
itself is idempotent.

Note: Run `pnpm --filter @relay/db db:push` after creating schema to apply changes
(db:push handles extensions gracefully in dev environments).
  </action>
  <verify>File exists at packages/db/src/migrations/0001_enable_pgvector.sql with CREATE EXTENSION statement</verify>
  <done>pgvector extension migration file exists and is ready for deployment</done>
</task>

<task type="auto">
  <name>Task 2: Create skill_embeddings schema</name>
  <files>packages/db/src/schema/skill-embeddings.ts, packages/db/src/schema/index.ts</files>
  <action>
Create the skill_embeddings table schema following existing patterns in packages/db/src/schema/.

File: packages/db/src/schema/skill-embeddings.ts

Import vector from drizzle-orm/pg-core (native support since v0.31, no customType needed).

Table structure:
- id: text, primary key, UUID default
- skillId: text, not null, unique, references skills.id with onDelete cascade
- embedding: vector({ dimensions: 1024 }), not null
- modelName: text, not null (e.g., "voyage-code-3")
- modelVersion: text, not null (e.g., "1.0")
- inputHash: text, not null (SHA-256 hash of embedded content for change detection)
- createdAt: timestamp, not null, defaultNow()
- updatedAt: timestamp, not null, defaultNow()

Add HNSW index on embedding column using vector_cosine_ops for cosine similarity:
```typescript
index("skill_embeddings_embedding_idx").using("hnsw", table.embedding.op("vector_cosine_ops"))
```

Export types: SkillEmbedding, NewSkillEmbedding

Update packages/db/src/schema/index.ts to export the new schema.
  </action>
  <verify>
- `pnpm --filter @relay/db typecheck` passes
- Schema exports SkillEmbedding type
- Vector column has 1024 dimensions
- Index uses HNSW with cosine ops
  </verify>
  <done>skill_embeddings schema defined with vector column, model versioning fields, and HNSW index</done>
</task>

<task type="auto">
  <name>Task 3: Apply schema to database</name>
  <files>None (database operation)</files>
  <action>
Run Drizzle push to apply the schema changes to the development database.

Commands:
1. `pnpm --filter @relay/db db:push` - Apply schema changes

This creates the skill_embeddings table and HNSW index. The pgvector extension
will be created if not already present (Neon PostgreSQL has pgvector pre-installed).

If db:push fails with "type 'vector' does not exist", manually run the extension
migration first via Drizzle studio or psql.
  </action>
  <verify>
- db:push completes without errors
- `pnpm --filter @relay/db db:studio` shows skill_embeddings table
- Table has embedding column of type vector(1024)
  </verify>
  <done>skill_embeddings table exists in development database with vector column and index</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `pnpm --filter @relay/db typecheck`
2. Schema is exported from @relay/db package
3. Database has skill_embeddings table with vector(1024) column
4. HNSW index exists on embedding column
</verification>

<success_criteria>
- skill_embeddings table exists with all required fields
- Vector column accepts 1024-dimension arrays
- HNSW index is created for efficient similarity queries
- Schema integrates with existing @relay/db package exports
</success_criteria>

<output>
After completion, create `.planning/phases/15-embeddings-foundation/15-01-SUMMARY.md`
</output>
