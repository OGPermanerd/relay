---
phase: 24-extended-mcp-search
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - apps/mcp/src/tools/search.ts
  - apps/mcp/test/setup.ts
  - apps/mcp/test/tools.test.ts
  - apps/web/app/api/mcp/[transport]/route.ts
autonomous: true

must_haves:
  truths:
    - "MCP stdio search_skills calls searchSkillsByQuery instead of in-memory filtering"
    - "Web remote MCP search_skills calls searchSkillsByQuery instead of in-memory filtering"
    - "Both MCP tool descriptions mention matching against author name and tags"
    - "Both MCP search_skills tools accept max limit of 50"
    - "MCP unit tests pass with the new service-based search"
    - "Playwright E2E tests verify search functionality works end-to-end"
  artifacts:
    - path: "apps/mcp/src/tools/search.ts"
      provides: "MCP stdio search using shared service"
      contains: "searchSkillsByQuery"
    - path: "apps/web/app/api/mcp/[transport]/route.ts"
      provides: "Web remote MCP search using shared service"
      contains: "searchSkillsByQuery"
    - path: "apps/mcp/test/setup.ts"
      provides: "Mock for search-skills service"
      contains: "search-skills"
    - path: "apps/mcp/test/tools.test.ts"
      provides: "Updated search tests using service mock"
  key_links:
    - from: "apps/mcp/src/tools/search.ts"
      to: "packages/db/src/services/search-skills.ts"
      via: "import searchSkillsByQuery"
      pattern: "import.*searchSkillsByQuery.*from.*search-skills"
    - from: "apps/web/app/api/mcp/[transport]/route.ts"
      to: "packages/db/src/services/search-skills.ts"
      via: "import searchSkillsByQuery"
      pattern: "import.*searchSkillsByQuery.*from.*search-skills"
---

<objective>
Wire both MCP search implementations (stdio and web remote) to use the shared searchSkillsByQuery service, update tool descriptions and limits, and update tests.

Purpose: Replace in-memory name+desc-only filtering with SQL-based matching across name, description, author, and tags. This achieves feature parity between MCP search and web search.

Output: Both MCP search_skills tools use the shared service; tests pass; Playwright verifies E2E.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@apps/mcp/src/tools/search.ts
@apps/web/app/api/mcp/[transport]/route.ts
@apps/mcp/test/setup.ts
@apps/mcp/test/tools.test.ts
@apps/mcp/test/mocks.ts
@.planning/phases/24-extended-mcp-search/24-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MCP stdio search and web remote MCP search to use shared service</name>
  <files>
    apps/mcp/src/tools/search.ts
    apps/web/app/api/mcp/[transport]/route.ts
  </files>
  <action>
**MCP stdio search (`apps/mcp/src/tools/search.ts`):**

1. Add import: `import { searchSkillsByQuery } from "@everyskill/db/services/search-skills";`
2. Remove the `db` import from `"@everyskill/db"` (no longer needed for search — check if other code in the file uses it; if only search uses it, remove)
3. Replace the in-memory search logic in `handleSearchSkills`:
   - Remove: `const queryLower = query.toLowerCase();`
   - Remove: `const allResults = await db.query.skills.findMany(...)`
   - Remove: `const filtered = allResults.filter(...)`
   - Remove: `const results = filtered.slice(0, limit);`
   - Replace with: `const results = await searchSkillsByQuery({ query, category, limit });`
   - Keep the `if (!db)` guard but change it to check results directly — OR remove the db guard since the service handles `if (!db)` internally. The simplest approach: remove the `if (!db)` block from `handleSearchSkills` since `searchSkillsByQuery` already returns `[]` when db is null.
4. Update tool description: `"Search for skills in the Relay marketplace by query. Matches against name, description, author name, and tags."`
5. Update query input description: `"Search query (matches name, description, author, tags)"`
6. Update limit max from 25 to 50: `z.number().min(1).max(50).default(10)`

**Web remote MCP search (`apps/web/app/api/mcp/[transport]/route.ts`):**

1. Add import at top with existing imports: `import { searchSkillsByQuery } from "@everyskill/db/services/search-skills";`
2. In the `search_skills` tool handler (around lines 175-228):
   - Remove: `const queryLower = query.toLowerCase();`
   - Remove: `const allResults = await db.query.skills.findMany(...)`
   - Remove: `const filtered = allResults.filter(...)`
   - Remove: `const results = filtered.slice(0, limit);`
   - Replace with: `const results = await searchSkillsByQuery({ query, category, limit });`
   - Remove the `if (!db)` block from this handler since the service handles it internally. If results are empty, the response is already correct.
3. Update tool description: `"Search for skills in the Relay marketplace by query. Matches against name, description, author name, and tags."`
4. Update query input description: `"Search query (matches name, description, author, tags)"`
5. Update limit max from 25 to 50: `z.number().min(1).max(50).default(10)`

Keep ALL other logic unchanged (tracking, nudge messages, rate limiting, CORS, auth, etc).
  </action>
  <verify>
Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json` to verify the web app compiles.
Check that the MCP app builds: `cd /home/dev/projects/relay/apps/mcp && npx tsup src/index.ts --format cjs --dts 2>&1 | tail -5` (or `npx tsc --noEmit` if tsconfig supports it).
  </verify>
  <done>
Both MCP search_skills handlers call `searchSkillsByQuery` instead of in-memory filtering. Tool descriptions mention author and tags. Limit max is 50.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MCP tests and run Playwright E2E</name>
  <files>
    apps/mcp/test/setup.ts
    apps/mcp/test/tools.test.ts
  </files>
  <action>
**Update test setup (`apps/mcp/test/setup.ts`):**

Add a mock for the new search-skills service:
```typescript
vi.mock("@everyskill/db/services/search-skills", () => ({
  searchSkillsByQuery: vi.fn(),
}));
```

**Update test file (`apps/mcp/test/tools.test.ts`):**

1. Import the mocked service:
```typescript
import { searchSkillsByQuery } from "@everyskill/db/services/search-skills";
const mockSearchSkills = vi.mocked(searchSkillsByQuery);
```

2. Update the `search_skills` describe block:
   - In `beforeEach`: Add `mockSearchSkills.mockResolvedValue([])` as default (empty results)
   - Update "returns matching skills for query" test: mock `mockSearchSkills.mockResolvedValue([{ id: "skill-1", name: "Code Review Assistant", description: "Automated code review with best practices", category: "prompt", hoursSaved: 2 }])`. Assert the result, and verify `mockSearchSkills` was called with `{ query: "review", category: undefined, limit: 10 }`.
   - Update "search is case-insensitive" test: The service handles case-insensitivity via ILIKE, so mock a result and verify the service was called with the original-case query. The test now verifies the handler passes the query through correctly.
   - Update "returns empty array when no matches" test: mock returns `[]`, assert count=0 and skills is empty.
   - Update "combines search with category filter" test: mock returns the filtered result, verify `mockSearchSkills` was called with `{ query: "test", category: "prompt", limit: 10 }`.
   - Update "tracks usage after searching" test: mock returns one result, verify `trackUsage` is called with `resultCount: 1`.

3. Ensure existing list_skills and deploy_skill tests are NOT affected (they still use `mockDb.query.skills.findMany`).

**Run tests:**
```bash
cd /home/dev/projects/relay/apps/mcp && npx vitest run
```

**Run Playwright E2E:**
```bash
cd /home/dev/projects/relay/apps/web && npx playwright test
```

All tests must pass.
  </action>
  <verify>
1. `cd /home/dev/projects/relay/apps/mcp && npx vitest run` — all MCP unit tests pass
2. `cd /home/dev/projects/relay/apps/web && npx playwright test` — all Playwright E2E tests pass
  </verify>
  <done>
MCP unit tests pass with new service mocks. Playwright E2E tests confirm search works end-to-end. All existing tests remain green.
  </done>
</task>

</tasks>

<verification>
1. MCP stdio search calls `searchSkillsByQuery` — grep for `searchSkillsByQuery` in `apps/mcp/src/tools/search.ts`
2. Web remote MCP search calls `searchSkillsByQuery` — grep for `searchSkillsByQuery` in `apps/web/app/api/mcp/[transport]/route.ts`
3. Both tool descriptions mention "author name, and tags"
4. Both limit max values are 50
5. MCP unit tests pass: `cd /home/dev/projects/relay/apps/mcp && npx vitest run`
6. Playwright tests pass: `cd /home/dev/projects/relay/apps/web && npx playwright test`
</verification>

<success_criteria>
- Searching for an author's name via MCP returns that author's skills (SRCH-01)
- Searching for a tag via MCP returns skills with that tag (SRCH-02)
- MCP tool descriptions updated to mention author and tag matching
- Max result limit increased to 50
- All MCP unit tests pass
- All Playwright E2E tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/24-extended-mcp-search/24-02-SUMMARY.md`
</output>
