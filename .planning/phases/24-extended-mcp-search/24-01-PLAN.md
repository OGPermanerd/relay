---
phase: 24-extended-mcp-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/services/search-skills.ts
  - packages/db/src/services/index.ts
autonomous: true

must_haves:
  truths:
    - "searchSkillsByQuery function matches name, description, author name, and tags using ILIKE"
    - "Field-weighted scoring orders results: title(4) > description(3) > author(2) > tags(1)"
    - "escapeLike prevents SQL injection via % and _ characters in user input"
    - "LEFT JOIN on users ensures skills without authors still appear in results"
  artifacts:
    - path: "packages/db/src/services/search-skills.ts"
      provides: "Shared SQL-based skill search with ILIKE + field-weighted scoring"
      exports: ["searchSkillsByQuery", "SearchSkillsParams", "SearchSkillResult"]
    - path: "packages/db/src/services/index.ts"
      provides: "Re-exports searchSkillsByQuery and types"
      contains: "search-skills"
  key_links:
    - from: "packages/db/src/services/search-skills.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "import skills schema for ILIKE queries"
      pattern: "import.*skills.*from.*schema"
    - from: "packages/db/src/services/search-skills.ts"
      to: "packages/db/src/schema/users.ts"
      via: "import users schema for LEFT JOIN on authorId"
      pattern: "import.*users.*from.*schema"
    - from: "packages/db/src/services/index.ts"
      to: "packages/db/src/services/search-skills.ts"
      via: "re-export"
      pattern: "export.*from.*search-skills"
---

<objective>
Create a shared search service in packages/db that performs SQL-based skill search matching name, description, author name, and tags with field-weighted relevance scoring.

Purpose: Centralize search logic so both MCP stdio and web remote MCP can call a single service instead of duplicating in-memory filtering. This is the foundation for Plan 24-02 which wires the service into both MCP search paths.

Output: `packages/db/src/services/search-skills.ts` with `searchSkillsByQuery` function exported from the services index.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@packages/db/src/services/index.ts
@packages/db/src/services/skill-metrics.ts
@packages/db/src/client.ts
@packages/db/src/schema/skills.ts
@packages/db/src/schema/users.ts
@apps/web/lib/search-skills.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create searchSkillsByQuery service</name>
  <files>packages/db/src/services/search-skills.ts</files>
  <action>
Create `packages/db/src/services/search-skills.ts` with the following:

1. **escapeLike helper** â€” escapes `%`, `_`, and `\` characters in user input to prevent ILIKE injection:
```typescript
function escapeLike(str: string): string {
  return str.replace(/[%_\\]/g, "\\$&");
}
```

2. **Interfaces:**
```typescript
export interface SearchSkillsParams {
  query: string;
  category?: string;
  limit?: number;  // default 50
}

export interface SearchSkillResult {
  id: string;
  name: string;
  description: string;
  category: string;
  hoursSaved: number | null;
}
```

3. **searchSkillsByQuery function:**
- Import `db` from `"../client"`, `skills` from `"../schema/skills"`, `users` from `"../schema/users"`, and `sql`, `eq`, `and` from `"drizzle-orm"`
- Guard: `if (!db) return [];`
- Build `likePattern` = `%${escapeLike(query)}%`
- WHERE condition: `skills.name ILIKE pattern OR skills.description ILIKE pattern OR users.name ILIKE pattern OR array_to_string(skills.tags, ' ') ILIKE pattern`
- Optional category filter: `AND skills.category = category`
- Field-weighted scoring SQL: `(CASE WHEN name ILIKE THEN 4 ELSE 0 END) + (CASE WHEN description ILIKE THEN 3 ELSE 0 END) + (CASE WHEN users.name ILIKE THEN 2 ELSE 0 END) + (CASE WHEN array_to_string(tags, ' ') ILIKE THEN 1 ELSE 0 END)`
- ORDER BY score DESC
- LEFT JOIN users on skills.authorId = users.id (LEFT JOIN so skills without authors still appear)
- LIMIT defaults to 50
- Select only: id, name, description, category, hoursSaved

Follow the pattern from `apps/web/lib/search-skills.ts` for the SQL structure, but keep it simpler (no full-text search, no quality scoring, no sort options). This service is for MCP's simpler needs.
  </action>
  <verify>
Run `cd /home/dev/projects/relay && npx tsc --noEmit -p packages/db/tsconfig.json` to verify TypeScript compilation. The file should have zero new errors.
  </verify>
  <done>
`searchSkillsByQuery` function exists in `packages/db/src/services/search-skills.ts`, accepts query/category/limit params, performs ILIKE matching across 4 fields with field-weighted scoring, and compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export from services index</name>
  <files>packages/db/src/services/index.ts</files>
  <action>
Add re-exports for the new search service to `packages/db/src/services/index.ts`:

```typescript
export {
  searchSkillsByQuery,
  type SearchSkillsParams,
  type SearchSkillResult,
} from "./search-skills";
```

Append after the existing exports. Follow the same pattern as the other service re-exports (e.g., skill-embeddings, api-keys).
  </action>
  <verify>
Run `cd /home/dev/projects/relay && npx tsc --noEmit -p packages/db/tsconfig.json` to confirm the index exports compile cleanly.
  </verify>
  <done>
`searchSkillsByQuery`, `SearchSkillsParams`, and `SearchSkillResult` are re-exported from `packages/db/src/services/index.ts`.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd /home/dev/projects/relay && npx tsc --noEmit -p packages/db/tsconfig.json`
2. The service file exists and exports `searchSkillsByQuery`, `SearchSkillsParams`, `SearchSkillResult`
3. The services index re-exports the new service
</verification>

<success_criteria>
- `searchSkillsByQuery` function compiles and matches 4 fields (name, description, author, tags) via ILIKE
- Field-weighted scoring implemented (title=4, desc=3, author=2, tags=1)
- LEFT JOIN for users table
- escapeLike helper prevents ILIKE injection
- Exported from services index
</success_criteria>

<output>
After completion, create `.planning/phases/24-extended-mcp-search/24-01-SUMMARY.md`
</output>
