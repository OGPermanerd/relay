---
phase: 53-skill-recommendations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/skill-recommendations.ts
  - apps/web/app/actions/recommendations.ts
autonomous: true

must_haves:
  truths:
    - "AI analyzes email category breakdown and generates targeted search queries for high-time categories"
    - "Hybrid search executes for each query and returns matching skills"
    - "Results are deduplicated and ranked by projected weekly time savings"
    - "Top 5 recommendations include personalized reasoning explaining the match"
  artifacts:
    - path: "apps/web/lib/skill-recommendations.ts"
      provides: "AI recommendation engine with query generation and ranking"
      exports: ["generateSkillRecommendations", "SkillRecommendation"]
      min_lines: 150
    - path: "apps/web/app/actions/recommendations.ts"
      provides: "Server action wrapper for recommendations"
      exports: ["getRecommendations"]
      min_lines: 30
  key_links:
    - from: "apps/web/app/actions/recommendations.ts"
      to: "apps/web/lib/skill-recommendations.ts"
      via: "generateSkillRecommendations call"
      pattern: "generateSkillRecommendations\\("
    - from: "apps/web/lib/skill-recommendations.ts"
      to: "@anthropic-ai/sdk"
      via: "Claude Haiku query generation"
      pattern: "claude-haiku-4-5-20251022"
    - from: "apps/web/lib/skill-recommendations.ts"
      to: "apps/web/lib/search-skills.ts"
      via: "searchSkills for each query"
      pattern: "searchSkills\\("
---

<objective>
Create AI-powered recommendation engine that analyzes email diagnostic results and suggests skills with personalized reasoning and time savings projections.

Purpose: Connect email diagnostic insights to actionable automation opportunities by matching high-time email categories to relevant skills in the library.

Output: Recommendation engine library and server action that returns top 5 skill recommendations with projected weekly savings and personalized explanations.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-skill-recommendations/53-RESEARCH.md

# Existing patterns
@apps/web/lib/ai-review.ts
@apps/web/lib/email-classifier.ts
@apps/web/lib/search-skills.ts
@apps/web/lib/categories.ts
@packages/db/src/services/email-diagnostics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create recommendation engine library</name>
  <files>apps/web/lib/skill-recommendations.ts</files>
  <action>
Create `apps/web/lib/skill-recommendations.ts` with AI recommendation engine:

**Types:**
```typescript
export interface SkillRecommendation {
  skillId: string;
  name: string;
  slug: string;
  description: string;
  category: string;
  hoursSaved: number | null;
  totalUses: number;
  averageRating: number | null;
  matchedCategories: string[]; // email categories matched
  projectedWeeklySavings: number; // hours/week
  personalizedReason: string;
}
```

**Implementation steps:**

1. **Query Generation Function** - `generateSearchQueries(categoryBreakdown, estimatedHoursPerWeek)`:
   - Use Claude Haiku 4.5 (`claude-haiku-4-5-20251022`) with structured output
   - System prompt (from RESEARCH.md Pattern 1): Maps email categories to automation search queries
   - Input: CategoryBreakdownItem[] (from email diagnostics), total hours/week
   - Filter to high-time categories: percentage > 10% OR estimatedMinutes > 30
   - Generate 1-2 search queries per high-time category
   - Output schema: `{ queries: Array<{ emailCategory, searchQuery, reasoning, estimatedTimeSavings }> }`
   - Use Anthropic client pattern from ai-review.ts (getClient, output_config with json_schema)

2. **Search and Rank Function** - `searchAndRankSkills(queries, userId, categoryBreakdown)`:
   - Execute `searchSkills({ query: q.searchQuery, userId })` for each query
   - Take top 10 results per query
   - Deduplicate by skill ID, tracking which queries matched each skill
   - Calculate projected savings: category time (hrs/week) × avg estimated savings percentage
   - Generate personalized reason: "You spend time on {categories} — this skill could automate that and save ~{X} hrs/week"
   - Rank by projectedWeeklySavings descending
   - Return top 5

3. **Main Export** - `generateSkillRecommendations(categoryBreakdown, estimatedHoursPerWeek, userId, tenantId)`:
   - Call generateSearchQueries
   - If no queries returned (all categories low-time), return empty array
   - Call searchAndRankSkills
   - Return SkillRecommendation[]

**Error handling:**
- Wrap Anthropic calls in try/catch, throw descriptive errors
- If AI fails, throw error (no fallback - let server action handle)
- If search returns no results, return empty recommendations array (not an error)

**Cost optimization:**
- Use Haiku 4.5 (cheapest model) not Sonnet
- Max tokens: 2048 (sufficient for query generation)
- Only analyze high-time categories to minimize input tokens

**Import patterns:**
- Import Anthropic client pattern from ai-review.ts
- Import searchSkills from @/lib/search-skills
- Import CategoryBreakdownItem type from @everyskill/db/services/email-diagnostics
  </action>
  <verify>
```bash
# Check file exists and exports correct functions
grep -E "export.*generateSkillRecommendations|export.*SkillRecommendation" apps/web/lib/skill-recommendations.ts

# Check uses Claude Haiku model
grep "claude-haiku-4-5-20251022" apps/web/lib/skill-recommendations.ts

# Check integrates with search-skills
grep "searchSkills" apps/web/lib/skill-recommendations.ts

# TypeScript compiles without errors
cd apps/web && npx tsc --noEmit --skipLibCheck
```
  </verify>
  <done>
- File apps/web/lib/skill-recommendations.ts exists with 150+ lines
- Exports generateSkillRecommendations function and SkillRecommendation type
- Uses Claude Haiku 4.5 for query generation with structured output schema
- Calls searchSkills for each generated query
- Deduplicates by skill ID and ranks by projected savings
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create recommendations server action</name>
  <files>apps/web/app/actions/recommendations.ts</files>
  <action>
Create `apps/web/app/actions/recommendations.ts` server action wrapper:

**Structure:**
```typescript
"use server";

import { auth } from "@/auth";
import { getLatestDiagnostic } from "@everyskill/db/services/email-diagnostics";
import { generateSkillRecommendations } from "@/lib/skill-recommendations";

export async function getRecommendations() {
  // Auth check
  const session = await auth();
  if (!session?.user?.id) {
    return { error: "Not authenticated" };
  }

  // Load latest diagnostic
  const diagnostic = await getLatestDiagnostic(session.user.id);
  if (!diagnostic) {
    return { error: "No diagnostic scan found. Run a scan first." };
  }

  // Generate recommendations
  try {
    const recommendations = await generateSkillRecommendations(
      diagnostic.categoryBreakdown,
      diagnostic.estimatedHoursPerWeek / 10, // stored as tenths
      session.user.id,
      session.user.tenantId || "default-tenant-000-0000-000000000000"
    );
    return { recommendations };
  } catch (error) {
    console.error("Recommendation generation failed:", error);
    return { error: "Failed to generate recommendations. Please try again." };
  }
}
```

**Return type:** `{ recommendations: SkillRecommendation[] } | { error: string }`

**Error states:**
- Not authenticated → "Not authenticated"
- No diagnostic found → "No diagnostic scan found. Run a scan first."
- AI/search failure → "Failed to generate recommendations. Please try again."

**Pattern:** Matches existing server actions in apps/web/app/actions/email-diagnostic.ts
  </action>
  <verify>
```bash
# Check file exists with "use server" directive
head -5 apps/web/app/actions/recommendations.ts | grep "use server"

# Check exports getRecommendations
grep "export.*getRecommendations" apps/web/app/actions/recommendations.ts

# Check calls generateSkillRecommendations
grep "generateSkillRecommendations" apps/web/app/actions/recommendations.ts

# TypeScript compiles
cd apps/web && npx tsc --noEmit --skipLibCheck
```
  </verify>
  <done>
- File apps/web/app/actions/recommendations.ts exists with "use server" directive
- Exports getRecommendations async function
- Checks authentication and loads latest diagnostic
- Calls generateSkillRecommendations and handles errors
- Returns { recommendations } or { error } union type
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. Recommendation engine generates AI queries for high-time email categories
2. Hybrid search executes for each query and returns skills
3. Results deduplicated and ranked by projected savings
4. Server action integrates with auth and diagnostic data
5. TypeScript compiles without errors
</verification>

<success_criteria>
- AI recommendation engine exists and uses Claude Haiku for query generation
- Search integration calls existing searchSkills for each query
- Deduplication by skill ID with multiple matched categories tracked
- Ranking by projected weekly time savings (category time × AI percentage)
- Server action provides authenticated access to recommendations
- Error handling for missing diagnostics, AI failures, and auth issues
- Top 5 recommendations returned with personalized reasoning
</success_criteria>

<output>
After completion, create `.planning/phases/53-skill-recommendations/53-01-SUMMARY.md`
</output>
