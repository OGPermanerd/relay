---
phase: 43-user-preferences
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/user-preferences.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/services/user-preferences.ts
  - packages/db/src/services/index.ts
  - packages/db/src/relations/index.ts
  - packages/db/src/migrations/0020_add_user_preferences.sql
  - apps/web/lib/preferences-defaults.ts
autonomous: true

must_haves:
  truths:
    - "user_preferences table exists in the database with JSONB preferences column"
    - "getOrCreate and update services work for user preferences"
    - "Zod schema validates preferences on write and merges defaults on read"
  artifacts:
    - path: "packages/db/src/schema/user-preferences.ts"
      provides: "Table definition with JSONB column, tenant_id FK, userId unique"
      contains: "userPreferences"
    - path: "packages/db/src/services/user-preferences.ts"
      provides: "getOrCreateUserPreferences and updateUserPreferences functions"
      contains: "getOrCreateUserPreferences"
    - path: "apps/web/lib/preferences-defaults.ts"
      provides: "Zod schema, SKILL_CATEGORIES, SORT_OPTIONS, PREFERENCES_DEFAULTS"
      contains: "userPreferencesSchema"
    - path: "packages/db/src/migrations/0020_add_user_preferences.sql"
      provides: "Migration creating user_preferences table with RLS"
      contains: "CREATE TABLE user_preferences"
  key_links:
    - from: "packages/db/src/services/user-preferences.ts"
      to: "packages/db/src/schema/user-preferences.ts"
      via: "imports userPreferences table"
      pattern: "from.*schema/user-preferences"
    - from: "packages/db/src/schema/index.ts"
      to: "packages/db/src/schema/user-preferences.ts"
      via: "re-exports schema"
      pattern: "export.*user-preferences"
---

<objective>
Create the database foundation for user preferences: schema, JSONB Zod validation, service layer, migration, and shared defaults.

Purpose: PREF-02 requires server-side JSONB storage with Zod-validated schema and code-defined defaults. This plan establishes the data layer that Plans 02 and 03 build upon.
Output: Working DB table, service functions, shared Zod schema with defaults.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/schema/notification-preferences.ts (mirror this pattern)
@packages/db/src/services/notification-preferences.ts (mirror this pattern)
@packages/db/src/schema/index.ts (add export)
@packages/db/src/services/index.ts (add export)
@packages/db/src/relations/index.ts (add relation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema, service, shared defaults, migration, and exports</name>
  <files>
    packages/db/src/schema/user-preferences.ts
    packages/db/src/services/user-preferences.ts
    packages/db/src/schema/index.ts
    packages/db/src/services/index.ts
    packages/db/src/relations/index.ts
    packages/db/src/migrations/0020_add_user_preferences.sql
    apps/web/lib/preferences-defaults.ts
  </files>
  <action>
    **1. Create shared Zod schema and defaults** at `apps/web/lib/preferences-defaults.ts`:
    - Export `SKILL_CATEGORIES = ["prompt", "workflow", "agent", "mcp"] as const`
    - Export `SORT_OPTIONS = ["uses", "quality", "rating", "days_saved"] as const`
    - Export Zod schema `userPreferencesSchema` validating:
      - `preferredCategories`: `z.array(z.enum(SKILL_CATEGORIES)).default([])`
      - `defaultSort`: `z.enum(SORT_OPTIONS).default("days_saved")`
      - `claudeMdWorkflowNotes`: `z.string().max(2000).default("")`
    - Export `type UserPreferencesData = z.infer<typeof userPreferencesSchema>`
    - Export `PREFERENCES_DEFAULTS: UserPreferencesData` with empty categories, "days_saved" sort, empty workflow notes
    - This file is NOT a "use server" file -- it's a shared lib for importing in both actions and client components (avoids the re-export bundler bug documented in MEMORY.md)

    **2. Create DB schema** at `packages/db/src/schema/user-preferences.ts`:
    - Mirror `notification-preferences.ts` exactly for structure
    - Table name: `user_preferences`
    - Columns: `id` (text PK, crypto.randomUUID), `tenant_id` (text NOT NULL FK to tenants), `user_id` (text NOT NULL UNIQUE FK to users), `preferences` (jsonb NOT NULL default `{}`), `updated_at` (timestamptz NOT NULL defaultNow)
    - Use `.$type<UserPreferencesData>()` on the jsonb column -- import `UserPreferencesData` as a type-only import from the interface definition (define the interface in THIS file too, mirroring the shape, to avoid cross-package import issues; the Zod schema in apps/web is the validation layer)
    - Index on `tenant_id`
    - RLS policy `tenant_isolation` identical to notification-preferences
    - Export `UserPreference` (select type) and `NewUserPreference` (insert type)

    **3. Create service** at `packages/db/src/services/user-preferences.ts`:
    - `getOrCreateUserPreferences(userId: string, tenantId: string)`: Mirror `getOrCreatePreferences` from notification-preferences. Find existing row by userId, if not found insert with `onConflictDoNothing`, re-fetch. Return the row merged with code defaults: `{ ...PREFERENCES_DEFAULTS, ...row.preferences }` -- import PREFERENCES_DEFAULTS and UserPreferencesData type from a local definition (define them inline in this file, duplicating the shape, since this is packages/db and cannot import from apps/web). Returns `UserPreferencesData | null`.
    - `updateUserPreferences(userId: string, preferences: UserPreferencesData)`: Update the preferences jsonb and updatedAt. Validate with Zod before writing (import zod, define the schema inline or use a simple validation). Actually, to keep it simple: just do the DB update. Validation happens in the server action layer (apps/web).

    **4. Update exports:**
    - `packages/db/src/schema/index.ts`: Add `export * from "./user-preferences";`
    - `packages/db/src/services/index.ts`: Add `export { getOrCreateUserPreferences, updateUserPreferences } from "./user-preferences";`

    **5. Add relation** in `packages/db/src/relations/index.ts`:
    - Import `userPreferences` from `"../schema"`
    - Add `userPreferencesRelations` (same pattern as notificationPreferencesRelations): tenant one-to-one, user one-to-one
    - Add `userPreferences: many(userPreferences)` to `usersRelations` and `tenantsRelations`

    **6. Create migration** at `packages/db/src/migrations/0020_add_user_preferences.sql`:
    ```sql
    CREATE TABLE user_preferences (
      id TEXT PRIMARY KEY,
      tenant_id TEXT NOT NULL REFERENCES tenants(id),
      user_id TEXT NOT NULL UNIQUE REFERENCES users(id),
      preferences JSONB NOT NULL DEFAULT '{}',
      updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
    CREATE INDEX user_preferences_tenant_id_idx ON user_preferences(tenant_id);
    ALTER TABLE user_preferences ENABLE ROW LEVEL SECURITY;
    CREATE POLICY tenant_isolation ON user_preferences
      AS RESTRICTIVE FOR ALL
      USING (tenant_id = current_setting('app.current_tenant_id', true))
      WITH CHECK (tenant_id = current_setting('app.current_tenant_id', true));
    ```

    **7. Run migration** via `psql` directly (drizzle-kit migrate replays all, fails on existing tables -- per project decisions):
    ```bash
    psql "$DATABASE_URL" -f packages/db/src/migrations/0020_add_user_preferences.sql
    ```

    **Important:** Define `UserPreferencesData` interface and `PREFERENCES_DEFAULTS` in BOTH `packages/db/src/services/user-preferences.ts` (for DB layer) and `apps/web/lib/preferences-defaults.ts` (for app layer with Zod). The DB service layer should not depend on apps/web. Keep the shapes identical.
  </action>
  <verify>
    1. `psql "$DATABASE_URL" -c "\d user_preferences"` shows table with expected columns
    2. `cd apps/web && npx tsc --noEmit` compiles without errors
    3. `cd packages/db && npx tsc --noEmit` compiles without errors
  </verify>
  <done>
    user_preferences table exists with JSONB column, RLS policy, and tenant_id index. Service functions getOrCreateUserPreferences and updateUserPreferences are exported. Shared Zod schema with PREFERENCES_DEFAULTS available in apps/web/lib. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
- `psql "$DATABASE_URL" -c "SELECT * FROM user_preferences LIMIT 0"` succeeds
- `psql "$DATABASE_URL" -c "SELECT polname FROM pg_policy WHERE polrelid = 'user_preferences'::regclass"` returns `tenant_isolation`
- TypeScript compilation passes in both packages/db and apps/web
</verification>

<success_criteria>
- user_preferences table with JSONB column, RLS, unique user_id constraint
- getOrCreateUserPreferences returns merged defaults + stored preferences
- updateUserPreferences writes validated preferences to JSONB column
- Zod schema with SKILL_CATEGORIES, SORT_OPTIONS, PREFERENCES_DEFAULTS exported from apps/web/lib
- All schema/service/relation exports registered
</success_criteria>

<output>
After completion, create `.planning/phases/43-user-preferences/43-01-SUMMARY.md`
</output>
