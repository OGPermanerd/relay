---
phase: 43-user-preferences
plan: 02
type: execute
wave: 2
depends_on: ["43-01"]
files_modified:
  - apps/web/app/(protected)/settings/layout.tsx
  - apps/web/app/(protected)/settings/page.tsx
  - apps/web/app/(protected)/settings/preferences/page.tsx
  - apps/web/app/(protected)/settings/preferences/preferences-form.tsx
  - apps/web/app/actions/user-preferences.ts
  - apps/web/app/(protected)/profile/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /settings/preferences and see a form with category checkboxes, sort dropdown, and workflow notes textarea"
    - "User can save preferences and see a success message"
    - "Preferences persist across page refreshes"
    - "Profile page has links to Settings (Preferences, Notifications, Export)"
    - "Settings layout has sub-navigation between Preferences, Notifications, and Export tabs"
  artifacts:
    - path: "apps/web/app/(protected)/settings/layout.tsx"
      provides: "Settings sub-navigation layout with Preferences, Notifications, Export tabs"
      contains: "preferences"
    - path: "apps/web/app/(protected)/settings/preferences/page.tsx"
      provides: "Server component that fetches and renders preferences form"
      contains: "getMyUserPreferences"
    - path: "apps/web/app/(protected)/settings/preferences/preferences-form.tsx"
      provides: "Client form with category checkboxes, sort select, workflow textarea"
      contains: "useActionState"
    - path: "apps/web/app/actions/user-preferences.ts"
      provides: "Server actions getMyUserPreferences and saveMyUserPreferences"
      contains: "saveMyUserPreferences"
  key_links:
    - from: "apps/web/app/(protected)/settings/preferences/page.tsx"
      to: "apps/web/app/actions/user-preferences.ts"
      via: "calls getMyUserPreferences"
      pattern: "getMyUserPreferences"
    - from: "apps/web/app/(protected)/settings/preferences/preferences-form.tsx"
      to: "apps/web/app/actions/user-preferences.ts"
      via: "form action calls saveMyUserPreferences"
      pattern: "saveMyUserPreferences"
    - from: "apps/web/app/actions/user-preferences.ts"
      to: "packages/db/src/services/user-preferences.ts"
      via: "imports getOrCreateUserPreferences, updateUserPreferences"
      pattern: "getOrCreateUserPreferences"
---

<objective>
Build the settings UI with sub-navigation and preferences form so users can configure preferred categories, default sort, and workflow notes.

Purpose: PREF-01 requires a preferences page with these settings. This plan creates the settings layout (shared by notifications and export pages), the preferences form, and the server actions.
Output: Working /settings/preferences page with save functionality and settings navigation.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/app/(protected)/settings/notifications/page.tsx (existing settings page pattern)
@apps/web/app/(protected)/settings/notifications/notification-preferences-form.tsx (form pattern)
@apps/web/app/actions/notification-preferences.ts (server action pattern)
@apps/web/lib/preferences-defaults.ts (created in Plan 01 -- Zod schema + defaults)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Settings layout, preferences page, form, and server actions</name>
  <files>
    apps/web/app/(protected)/settings/layout.tsx
    apps/web/app/(protected)/settings/page.tsx
    apps/web/app/(protected)/settings/preferences/page.tsx
    apps/web/app/(protected)/settings/preferences/preferences-form.tsx
    apps/web/app/actions/user-preferences.ts
  </files>
  <action>
    **1. Create settings layout** at `apps/web/app/(protected)/settings/layout.tsx`:
    - Server component wrapping `{children}` with a settings header and tab navigation
    - Title: "Settings" with subtitle "Manage your account preferences"
    - Tab-style sub-nav links: Preferences (`/settings/preferences`), Notifications (`/settings/notifications`), Export (`/settings/export`)
    - Use `usePathname` from `next/navigation` to highlight active tab -- WAIT, this is a server component. Use a client component for the nav, or read the pathname from the URL. Actually, make the layout a server component and extract the tab nav into a small `"use client"` component that uses `usePathname()`.
    - Tab styling: inline link pills similar to the existing notification page style. Active tab has `bg-blue-50 text-blue-700`, inactive has `text-gray-600 hover:text-gray-900 hover:bg-gray-50`.
    - Max width `max-w-2xl mx-auto px-4 py-8 sm:px-6 lg:px-8` (matching existing notifications page)

    **2. Create settings redirect** at `apps/web/app/(protected)/settings/page.tsx`:
    - Import `redirect` from `next/navigation`
    - Default export that calls `redirect("/settings/preferences")` -- when users hit `/settings` they go to preferences tab

    **3. Create server action** at `apps/web/app/actions/user-preferences.ts`:
    - `"use server"` directive
    - Import `auth` from `@/auth`
    - Import `getOrCreateUserPreferences`, `updateUserPreferences` from `@everyskill/db/services/user-preferences`
    - Import `userPreferencesSchema`, `PREFERENCES_DEFAULTS`, `SKILL_CATEGORIES` from `@/lib/preferences-defaults`
    - Use `const DEFAULT_TENANT_ID = "default-tenant-000-0000-000000000000"` (same pattern as notification-preferences action)

    - `getMyUserPreferences()`: Get session, call `getOrCreateUserPreferences(userId, tenantId)`, return the merged preferences object (plain data, no Dates). Return type: `UserPreferencesData | null`.

    - `saveMyUserPreferences(formData: FormData)`: Get session, parse FormData:
      - `preferredCategories`: For each category in SKILL_CATEGORIES, check `formData.get("cat_" + cat) === "on"`, collect checked ones into array
      - `defaultSort`: `formData.get("defaultSort") as string` (validated by Zod)
      - `claudeMdWorkflowNotes`: `formData.get("claudeMdWorkflowNotes") as string || ""`
      - Validate with `userPreferencesSchema.safeParse(...)`. If invalid, return `{ error: "Invalid preferences" }`.
      - Call `updateUserPreferences(userId, validatedData)`.
      - Return `{ success: true }`.
    - Export `type SaveUserPreferencesResult = { success?: boolean; error?: string }`

    **4. Create preferences form** at `apps/web/app/(protected)/settings/preferences/preferences-form.tsx`:
    - `"use client"` directive
    - Mirror `notification-preferences-form.tsx` pattern exactly: `useActionState` with `saveMyUserPreferences`
    - Props: `initialPreferences: { preferredCategories: string[]; defaultSort: string; claudeMdWorkflowNotes: string }`

    - **Section 1: Preferred Skill Categories**
      - Heading: "Preferred Categories", subtitle: "Select the skill types you work with most"
      - Four checkboxes, one per category: Prompts (name="cat_prompt"), Workflows (name="cat_workflow"), Agents (name="cat_agent"), MCP (name="cat_mcp")
      - `defaultChecked={initialPreferences.preferredCategories.includes("prompt")}` etc.
      - Same checkbox styling as notification-preferences-form

    - **Section 2: Default Sort Order**
      - Heading: "Default Sort", subtitle: "How skills are sorted by default in browse views"
      - `<select name="defaultSort" defaultValue={initialPreferences.defaultSort}>` with options:
        - "Most Used" (value="uses"), "Highest Quality" (value="quality"), "Best Rated" (value="rating"), "Most Time Saved" (value="days_saved")
      - Same select styling as notification-preferences trendingDigest select

    - **Section 3: Workflow Notes for AI Export**
      - Heading: "Workflow Notes", subtitle: "Personal notes about your workflow preferences (included in CLAUDE.md export)"
      - `<textarea name="claudeMdWorkflowNotes" defaultValue={initialPreferences.claudeMdWorkflowNotes} maxLength={2000} rows={4}>` with character count
      - Styling: full-width textarea with border, rounded, focus ring

    - Success/error messages and save button: identical pattern to notification-preferences-form

    **5. Create preferences server page** at `apps/web/app/(protected)/settings/preferences/page.tsx`:
    - Mirror `notifications/page.tsx` exactly
    - Import `auth`, `redirect`, `getMyUserPreferences`, `PreferencesForm`
    - Fetch preferences, pass to form with fallback to PREFERENCES_DEFAULTS
    - No additional heading needed (layout provides the settings chrome)
    - Just render the form directly since the layout handles the header/nav
  </action>
  <verify>
    1. `cd apps/web && npx tsc --noEmit` compiles without errors
    2. Start dev server, navigate to `http://localhost:2002/settings/preferences` -- form loads with defaults
    3. Check all four category checkboxes, change sort to "uses", type workflow notes, click Save -- success message appears
    4. Refresh page -- saved values persist
    5. Navigate to `/settings/notifications` -- existing notification preferences page loads within settings layout
  </verify>
  <done>
    Settings layout with sub-nav renders at /settings/*. Preferences form at /settings/preferences shows category checkboxes, sort dropdown, and workflow textarea. Saving persists to DB and survives refresh. Profile page not yet updated (deferred to keep task lean).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Settings links to Profile page</name>
  <files>
    apps/web/app/(protected)/profile/page.tsx
  </files>
  <action>
    Edit `apps/web/app/(protected)/profile/page.tsx` to add a "Settings" section between "My Skills" and "Account Information" sections:

    - Section heading: "Settings" (same `text-lg font-semibold text-gray-900` style)
    - Three links in a `rounded-lg bg-white p-6 shadow-sm` card:
      - "Preferences" -> `/settings/preferences` with description "Preferred categories, default sort, workflow notes"
      - "Notifications" -> `/settings/notifications` with description "Email and in-app notification settings"
      - "AI Export" -> `/settings/export` with description "Generate a CLAUDE.md file from your skills"
    - Each link: flex row with link text (blue-600, font-medium) and gray-500 description text, with right arrow
    - Divide links with `border-b border-gray-100` except the last one
  </action>
  <verify>
    1. Navigate to `http://localhost:2002/profile` -- "Settings" section visible with three links
    2. Click "Preferences" -- navigates to /settings/preferences
    3. Click "Notifications" -- navigates to /settings/notifications
  </verify>
  <done>
    Profile page has a Settings section with links to Preferences, Notifications, and AI Export pages. All links navigate correctly.
  </done>
</task>

</tasks>

<verification>
- `/settings` redirects to `/settings/preferences`
- `/settings/preferences` shows form with category checkboxes, sort dropdown, workflow textarea
- `/settings/notifications` loads existing notification preferences within new settings layout
- Saving preferences persists across page refresh
- Profile page shows Settings links
- TypeScript compiles cleanly
</verification>

<success_criteria>
- Settings layout with Preferences/Notifications/Export tabs works at /settings/*
- Preferences form saves and loads preferred categories, default sort, workflow notes
- Profile page links to all three settings pages
- Existing notification preferences page unmodified and still functional within layout
</success_criteria>

<output>
After completion, create `.planning/phases/43-user-preferences/43-02-SUMMARY.md`
</output>
