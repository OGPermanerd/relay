---
phase: 43-user-preferences
plan: 03
type: execute
wave: 2
depends_on: ["43-01"]
files_modified:
  - apps/web/app/actions/export-claude-md.ts
  - apps/web/app/(protected)/settings/export/page.tsx
  - apps/web/app/(protected)/settings/export/claude-md-preview.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /settings/export and see a generated CLAUDE.md preview"
    - "Generated CLAUDE.md includes user name, skill portfolio, preferred categories, and workflow notes"
    - "User can copy the CLAUDE.md content to clipboard"
    - "User can download the content as a CLAUDE.md file"
  artifacts:
    - path: "apps/web/app/actions/export-claude-md.ts"
      provides: "Server action that queries user skills + preferences and generates markdown"
      contains: "generateClaudeMd"
    - path: "apps/web/app/(protected)/settings/export/page.tsx"
      provides: "Server page that calls generateClaudeMd and renders preview"
      contains: "generateClaudeMd"
    - path: "apps/web/app/(protected)/settings/export/claude-md-preview.tsx"
      provides: "Client component with preview textarea, copy button, download button"
      contains: "clipboard"
  key_links:
    - from: "apps/web/app/(protected)/settings/export/page.tsx"
      to: "apps/web/app/actions/export-claude-md.ts"
      via: "calls generateClaudeMd server action"
      pattern: "generateClaudeMd"
    - from: "apps/web/app/actions/export-claude-md.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "queries skills table for user's published skills"
      pattern: "skills"
---

<objective>
Build the CLAUDE.md export feature so users can generate a portable AI configuration file from their skill portfolio and preferences.

Purpose: PREF-04 and PREF-05 require generating a CLAUDE.md file that includes skill references and personal workflow preferences. This gives users a portable file they can place in any project for cross-AI use.
Output: Working /settings/export page with preview, copy, and download.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/schema/skills.ts (skills table -- authorId, name, category, description, tags, totalUses, avgHoursSaved)
@apps/web/lib/preferences-defaults.ts (created in Plan 01 -- Zod schema + defaults)
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLAUDE.md generation server action</name>
  <files>
    apps/web/app/actions/export-claude-md.ts
  </files>
  <action>
    Create `apps/web/app/actions/export-claude-md.ts` with `"use server"` directive.

    **Function: `generateClaudeMd()`**
    - Import `auth` from `@/auth`
    - Import `db` from `@everyskill/db/client`
    - Import `skills` from `@everyskill/db/schema`
    - Import `getOrCreateUserPreferences` from `@everyskill/db/services/user-preferences`
    - Import `PREFERENCES_DEFAULTS` from `@/lib/preferences-defaults`
    - Use `const DEFAULT_TENANT_ID = "default-tenant-000-0000-000000000000"`

    Steps:
    1. Get session. If no user, return `{ error: "Must be signed in" }`.
    2. Fetch user preferences via `getOrCreateUserPreferences(userId, tenantId)`. Merge with PREFERENCES_DEFAULTS.
    3. Query published skills: `db.select().from(skills).where(and(eq(skills.authorId, userId), eq(skills.status, 'published'))).orderBy(desc(skills.totalUses))`. Select: `name`, `category`, `description`, `tags`, `totalUses`, `avgHoursSaved`.
    4. Build markdown string using template literals (NOT string concatenation):

    ```
    # {userName}'s AI Configuration

    Generated from EverySkill profile on {YYYY-MM-DD}.

    ## About Me
    {claudeMdWorkflowNotes -- only include section if non-empty}

    ## My Skill Areas
    {If preferredCategories non-empty: "I primarily work with {categories joined with 'and'}." Otherwise omit section.}

    ## Skills Portfolio

    ### {skill.name}
    - **Category:** {category}
    - **Description:** {description}
    - **Tags:** {tags joined with ", "}
    - **Impact:** {totalUses} uses, {avgHoursSaved}h saved per use

    {Repeat for each published skill. If no skills, show "No published skills yet."}

    ## Workflow Preferences
    - Default skill sort: {human-readable sort label}
    - Preferred categories: {joined or "All categories"}

    ---
    *Generated by EverySkill (everyskill.ai)*
    ```

    5. Return `{ markdown: string }` on success or `{ error: string }` on failure.

    **Human-readable sort labels:** "uses" -> "Most Used", "quality" -> "Highest Quality", "rating" -> "Best Rated", "days_saved" -> "Most Time Saved"

    **Date formatting:** Use manual UTC format (per MEMORY.md hydration prevention): `YYYY-MM-DD` via `new Date().toISOString().split('T')[0]`

    Return type: `{ markdown: string } | { error: string }`
  </action>
  <verify>
    `cd apps/web && npx tsc --noEmit` compiles without errors
  </verify>
  <done>
    generateClaudeMd server action builds markdown from user's published skills and preferences, with proper template sections and human-readable labels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export page and preview component</name>
  <files>
    apps/web/app/(protected)/settings/export/page.tsx
    apps/web/app/(protected)/settings/export/claude-md-preview.tsx
  </files>
  <action>
    **1. Create preview component** at `apps/web/app/(protected)/settings/export/claude-md-preview.tsx`:
    - `"use client"` directive
    - Props: `{ markdown: string }`
    - State: `copied` boolean for clipboard feedback
    - Render:
      - Info banner at top: "This file can be placed in any project as CLAUDE.md to give AI assistants context about your skills and preferences."
      - Read-only `<textarea>` showing the full markdown, styled with monospace font (`font-mono text-sm`), full width, 20 rows, bg-gray-50 border rounded
      - Two action buttons side by side:
        - "Copy to Clipboard": onClick calls `navigator.clipboard.writeText(markdown)`, sets `copied` to true for 2 seconds, button text changes to "Copied!" while active. Styling: outlined button (border-gray-300, text-gray-700).
        - "Download CLAUDE.md": onClick creates a Blob with the markdown content, creates a URL via `URL.createObjectURL`, creates a temporary `<a>` element with `download="CLAUDE.md"`, clicks it, revokes the URL. Styling: primary blue button (bg-blue-600 text-white).
      - Button row: `flex gap-3 mt-4`

    **2. Create export page** at `apps/web/app/(protected)/settings/export/page.tsx`:
    - Server component
    - Import `auth`, `redirect`, `generateClaudeMd`, `ClaudeMdPreview`
    - Get session, redirect if not authed
    - Call `generateClaudeMd()`. If error, show error message.
    - Render `<ClaudeMdPreview markdown={result.markdown} />`
    - No extra heading needed (settings layout provides chrome)
    - Add a "Regenerate" link that's just `<a href="/settings/export">` (forces server re-render) for when user updates preferences and wants fresh output. Style as a small text link below the preview.
  </action>
  <verify>
    1. `cd apps/web && npx tsc --noEmit` compiles without errors
    2. Start dev server, navigate to `http://localhost:2002/settings/export` -- preview loads with generated CLAUDE.md
    3. Click "Copy to Clipboard" -- button changes to "Copied!", paste confirms content
    4. Click "Download CLAUDE.md" -- file downloads with correct content
    5. Preview includes user name, any published skills, and preferences
  </verify>
  <done>
    Export page at /settings/export shows generated CLAUDE.md preview. Copy and download buttons work. Content includes user profile, published skills, and workflow preferences.
  </done>
</task>

</tasks>

<verification>
- `/settings/export` loads and shows CLAUDE.md preview
- Generated content includes user name, date, skills portfolio (if any published), preferences
- Copy to clipboard works and shows feedback
- Download produces a valid CLAUDE.md file
- TypeScript compiles cleanly
</verification>

<success_criteria>
- Server action generates complete CLAUDE.md from user data, skills, and preferences
- Export page renders preview with monospace textarea
- Copy button copies to clipboard with "Copied!" feedback
- Download button saves as CLAUDE.md file
- Empty states handled (no skills, no preferences, no workflow notes)
</success_criteria>

<output>
After completion, create `.planning/phases/43-user-preferences/43-03-SUMMARY.md`
</output>
