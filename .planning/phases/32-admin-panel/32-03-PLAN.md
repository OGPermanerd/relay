---
phase: 32-admin-panel
plan: 03
type: execute
wave: 3
depends_on: ["32-06"]
files_modified:
  - apps/web/app/(protected)/admin/layout.tsx
  - apps/web/app/(protected)/admin/settings/page.tsx
  - apps/web/app/(protected)/admin/merge/page.tsx
  - apps/web/app/(protected)/admin/keys/page.tsx
  - apps/web/components/admin-settings-form.tsx
  - apps/web/app/actions/admin-tenant.ts
autonomous: true

must_haves:
  truths:
    - "Admin settings page shows tenant configuration (name, domain, logo) alongside existing site settings"
    - "Admin can update tenant name, domain, and logo URL via form submission"
    - "Shared admin layout provides navigation between admin sub-pages"
    - "Non-admins are redirected away from all admin pages via layout-level gate"
  artifacts:
    - path: "apps/web/app/(protected)/admin/layout.tsx"
      provides: "Shared admin layout with role gate and sub-navigation"
      contains: "isAdmin"
    - path: "apps/web/app/actions/admin-tenant.ts"
      provides: "updateTenantSettings server action with role check and Zod validation"
      exports: ["updateTenantSettingsAction"]
    - path: "apps/web/app/(protected)/admin/settings/page.tsx"
      provides: "Tenant config form with name, domain, logo fields"
      contains: "tenant"
  key_links:
    - from: "apps/web/app/actions/admin-tenant.ts"
      to: "packages/db/src/schema/tenants.ts"
      via: "Drizzle update on tenants table"
      pattern: "update.*tenants"
    - from: "apps/web/app/(protected)/admin/layout.tsx"
      to: "apps/web/lib/admin.ts"
      via: "isAdmin session check for layout-level gating"
      pattern: "isAdmin"
---

<objective>
Create a shared admin layout with sub-navigation and role gate, verify the gate works, then remove redundant per-page admin checks. Enhance the settings page with tenant configuration (name, domain, logo).

Purpose: Delivers ADMIN-01 (tenant settings management) and provides the admin layout shell that all admin sub-pages will use. Gate verification ensures security before removing per-page checks.
Output: Admin layout with nav, tenant settings form, and updateTenantSettings server action.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/32-admin-panel/32-06-SUMMARY.md
@apps/web/app/(protected)/admin/settings/page.tsx
@apps/web/components/admin-settings-form.tsx
@packages/db/src/schema/tenants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin layout with role gate + verify gate redirects non-admins</name>
  <files>
    apps/web/app/(protected)/admin/layout.tsx
  </files>
  <action>
1. Create `apps/web/app/(protected)/admin/layout.tsx`:
   - Import `auth` from `@/auth`, `redirect` from `next/navigation`, `isAdmin` from `@/lib/admin`
   - Check session + isAdmin(session), redirect("/") if not admin
   - Render a layout with:
     - `<h1>` "Admin" heading
     - Horizontal sub-nav with links: Settings, Skills, Merge, API Keys, Compliance
     - Use `<Link>` from next/link for each nav item
     - Style with Tailwind: `flex gap-4` nav, `text-sm font-medium text-gray-600 hover:text-gray-900` links
     - Each link: `/admin/settings`, `/admin/skills`, `/admin/merge`, `/admin/keys`, `/admin/compliance`
     - Render `{children}` below nav

2. VERIFY the gate works BEFORE proceeding to Task 2:
   - Run `cd /home/dev/projects/relay && pnpm build` to confirm it compiles
   - The layout gate uses isAdmin(session) which checks session.user.role === "admin"
   - Verify the redirect logic is correct by reading the file back and confirming:
     a. `const session = await auth()` is called
     b. `if (!isAdmin(session)) { redirect("/"); }` (or equivalent) is present
     c. This runs server-side before any children render
   - This is a Next.js layout — it wraps ALL /admin/* routes, so any non-admin will be redirected before reaching any admin page
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm build` compiles. Read back the layout file and confirm the redirect-on-non-admin pattern is present. The layout gate is the SOLE security boundary for admin pages.
  </verify>
  <done>
Admin layout exists at /admin/layout.tsx with role-based gate that redirects non-admins. Sub-navigation links to all admin sections. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove per-page admin checks + add tenant settings form</name>
  <files>
    apps/web/app/(protected)/admin/settings/page.tsx
    apps/web/app/(protected)/admin/merge/page.tsx
    apps/web/app/(protected)/admin/keys/page.tsx
    apps/web/components/admin-settings-form.tsx
    apps/web/app/actions/admin-tenant.ts
  </files>
  <action>
PREREQUISITE: Task 1 must be complete and verified — the admin layout gate is the security boundary.

1. Remove redundant isAdmin checks from admin pages (layout now handles auth gating):
   - `admin/settings/page.tsx`: Remove the `isAdmin` import and the `if (!session?.user?.id || !isAdmin(session))` redirect block. Keep `await auth()` since session data is used.
   - `admin/merge/page.tsx`: Same — remove isAdmin import and check. Keep auth() call.
   - `admin/keys/page.tsx`: Same — remove isAdmin import and check. Keep auth() call.

2. Create `apps/web/app/actions/admin-tenant.ts`:
   - "use server" directive
   - Import auth, db, tenants, eq, revalidatePath, z
   - Import isAdmin from @/lib/admin
   - Define Zod schema: `tenantSettingsSchema = z.object({ name: z.string().min(1).max(100), domain: z.string().min(1).max(100).optional().or(z.literal("")), logo: z.string().url().optional().or(z.literal("")) })`
   - Export type `TenantSettingsState = { success?: boolean; error?: string }`
   - Export `async function updateTenantSettingsAction(_prev: TenantSettingsState, formData: FormData): Promise<TenantSettingsState>`
     - Check session + isAdmin(session), return error if unauthorized
     - Parse formData with Zod schema
     - Update tenants table: `db.update(tenants).set({ name, domain: domain || null, logo: logo || null, updatedAt: new Date() }).where(eq(tenants.id, session.user.tenantId!))`
     - revalidatePath("/admin/settings")
     - Return { success: true } or { error: message }

3. Update `apps/web/app/(protected)/admin/settings/page.tsx`:
   - Query tenants table for current tenant data: `db.select().from(tenants).where(eq(tenants.id, session.user.tenantId!)).limit(1)`
   - Add a "Tenant Settings" section rendered ABOVE the existing Ollama settings
   - Pass tenant data to TenantSettingsForm component

4. Add `TenantSettingsForm` to `apps/web/components/admin-settings-form.tsx`:
   - Keep existing `AdminSettingsForm` unchanged
   - Add new exported component `TenantSettingsForm`
   - Props: `initialTenant: { name: string; domain: string | null; logo: string | null }`
   - Uses `useActionState` with `updateTenantSettingsAction`
   - Three input fields: name, domain, logo
   - Save button with pending state
   - Success/error messages
   - Style consistent with existing AdminSettingsForm (same Tailwind classes)
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm build` compiles. Grep confirms no remaining `isAdmin` imports in admin/settings/page.tsx, admin/merge/page.tsx, admin/keys/page.tsx:
`grep -l "isAdmin" apps/web/app/\(protected\)/admin/settings/page.tsx apps/web/app/\(protected\)/admin/merge/page.tsx apps/web/app/\(protected\)/admin/keys/page.tsx` should return nothing.
  </verify>
  <done>
Per-page admin checks removed (layout gates). Tenant settings form allows admins to update tenant name, domain, and logo. Server action validates with Zod and checks role. Form shows current values and provides feedback.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- /admin/settings shows tenant config (name, domain, logo) section
- Admin sub-nav visible on all admin pages
- Non-admins are redirected from /admin/* routes via layout gate
- Updating tenant name persists to database
- No redundant isAdmin checks in admin page files
</verification>

<success_criteria>
- Admin layout with sub-nav wraps all admin pages
- Layout gate redirects non-admins before any admin page renders
- Tenant settings form displays and saves tenant name, domain, logo
- Server action validates input with Zod and checks role
</success_criteria>

<output>
After completion, create `.planning/phases/32-admin-panel/32-03-SUMMARY.md`
</output>
