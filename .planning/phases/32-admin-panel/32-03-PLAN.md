---
phase: 32-admin-panel
plan: 03
type: execute
wave: 3
depends_on: ["32-02"]
files_modified:
  - apps/web/app/(protected)/admin/layout.tsx
  - apps/web/app/(protected)/admin/settings/page.tsx
  - apps/web/components/admin-settings-form.tsx
  - apps/web/app/actions/admin-tenant.ts
autonomous: true

must_haves:
  truths:
    - "Admin settings page shows tenant configuration (name, domain, logo) alongside existing site settings"
    - "Admin can update tenant name, domain, and logo URL via form submission"
    - "Shared admin layout provides navigation between admin sub-pages"
    - "Non-admins are redirected away from all admin pages via layout-level gate"
  artifacts:
    - path: "apps/web/app/(protected)/admin/layout.tsx"
      provides: "Shared admin layout with role gate and sub-navigation"
      contains: "isAdmin"
    - path: "apps/web/app/actions/admin-tenant.ts"
      provides: "updateTenantSettings server action with role check and Zod validation"
      exports: ["updateTenantSettingsAction"]
    - path: "apps/web/app/(protected)/admin/settings/page.tsx"
      provides: "Tenant config form with name, domain, logo fields"
      contains: "tenant"
  key_links:
    - from: "apps/web/app/actions/admin-tenant.ts"
      to: "packages/db/src/schema/tenants.ts"
      via: "Drizzle update on tenants table"
      pattern: "update.*tenants"
    - from: "apps/web/app/(protected)/admin/layout.tsx"
      to: "apps/web/lib/admin.ts"
      via: "isAdmin session check for layout-level gating"
      pattern: "isAdmin"
---

<objective>
Create a shared admin layout with sub-navigation and enhance the settings page with tenant configuration (name, domain, logo). Add a server action for updating tenant settings.

Purpose: Delivers ADMIN-01 (tenant settings management) and provides the admin layout shell that all admin sub-pages will use.
Output: Admin layout with nav, tenant settings form, and updateTenantSettings server action.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/32-admin-panel/32-02-SUMMARY.md
@apps/web/app/(protected)/admin/settings/page.tsx
@apps/web/components/admin-settings-form.tsx
@packages/db/src/schema/tenants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin layout with role gate and sub-navigation</name>
  <files>
    apps/web/app/(protected)/admin/layout.tsx
    apps/web/app/(protected)/admin/settings/page.tsx
    apps/web/app/(protected)/admin/merge/page.tsx
    apps/web/app/(protected)/admin/keys/page.tsx
  </files>
  <action>
1. Create `apps/web/app/(protected)/admin/layout.tsx`:
   - Import `auth` from `@/auth`, `redirect` from `next/navigation`, `isAdmin` from `@/lib/admin`
   - Check session + isAdmin(session), redirect("/") if not admin
   - Render a layout with:
     - `<h1>` "Admin" heading
     - Horizontal sub-nav with links: Settings, Skills, Merge, API Keys, Compliance
     - Use `<Link>` from next/link for each nav item
     - Style with Tailwind: `flex gap-4` nav, `text-sm font-medium text-gray-600 hover:text-gray-900` links
     - Each link: `/admin/settings`, `/admin/skills`, `/admin/merge`, `/admin/keys`, `/admin/compliance`
     - Render `{children}` below nav
   - This layout-level gate means individual admin pages NO LONGER need their own isAdmin checks

2. Remove the redundant isAdmin checks from the three existing admin pages:
   - `admin/settings/page.tsx`: Remove the `isAdmin` import and the `if (!session?.user?.id || !isAdmin(session))` block. Keep the `await auth()` call since it's used for session data.
   - `admin/merge/page.tsx`: Same — remove isAdmin import and check. Keep auth() call.
   - `admin/keys/page.tsx`: Same — remove isAdmin import and check. Keep auth() call.

   The layout handles auth gating for all admin sub-routes.
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm build` compiles. Navigate to /admin/settings — should show admin sub-nav above content.
  </verify>
  <done>
Admin layout gates all /admin/* routes by role. Sub-navigation links to all 5 admin sections. Individual page redundant auth checks removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Tenant settings form + server action</name>
  <files>
    apps/web/app/actions/admin-tenant.ts
    apps/web/app/(protected)/admin/settings/page.tsx
    apps/web/components/admin-settings-form.tsx
  </files>
  <action>
1. Create `apps/web/app/actions/admin-tenant.ts`:
   - "use server" directive
   - Import auth, db, tenants, eq, revalidatePath, z
   - Import isAdmin from @/lib/admin
   - Define Zod schema: `tenantSettingsSchema = z.object({ name: z.string().min(1).max(100), domain: z.string().min(1).max(100).optional().or(z.literal("")), logo: z.string().url().optional().or(z.literal("")) })`
   - Export type `TenantSettingsState = { success?: boolean; error?: string }`
   - Export `async function updateTenantSettingsAction(_prev: TenantSettingsState, formData: FormData): Promise<TenantSettingsState>`
     - Check session + isAdmin(session), return error if unauthorized
     - Parse formData with Zod schema
     - Update tenants table: `db.update(tenants).set({ name, domain: domain || null, logo: logo || null, updatedAt: new Date() }).where(eq(tenants.id, session.user.tenantId!))`
     - revalidatePath("/admin/settings")
     - Return { success: true } or { error: message }

2. Update `apps/web/app/(protected)/admin/settings/page.tsx`:
   - Import `getTenantBySlug` or query tenants table directly for current tenant data
   - Query: `db.select().from(tenants).where(eq(tenants.id, session.user.tenantId!)).limit(1)`
   - Pass tenant data to a new section in the page, rendered ABOVE the existing Ollama settings
   - Render a "Tenant Settings" section with:
     - A client component section using TenantSettingsForm (add to admin-settings-form.tsx or create inline)
     - Fields: name (text input), domain (text input, placeholder "company.com"), logo (text input, placeholder URL)
     - Pre-filled with current tenant values
     - Submit button "Save Tenant Settings"
     - Success/error feedback

3. Update `apps/web/components/admin-settings-form.tsx`:
   - Add a new exported component `TenantSettingsForm` (keep existing `AdminSettingsForm` unchanged)
   - Props: `initialTenant: { name: string; domain: string | null; logo: string | null }`
   - Uses `useActionState` with `updateTenantSettingsAction`
   - Three input fields: name, domain, logo
   - Save button with pending state
   - Success/error messages
   - Style consistent with existing AdminSettingsForm (same Tailwind classes)
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm build` compiles. The settings page renders tenant config form above the existing Ollama settings section.
  </verify>
  <done>
Tenant settings form allows admins to update tenant name, domain, and logo. Server action validates with Zod, checks role, updates tenants table. Form shows current values and provides feedback on save.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- /admin/settings shows tenant config (name, domain, logo) section
- Admin sub-nav visible on all admin pages
- Non-admin users redirected from /admin/* routes
- Updating tenant name persists to database
</verification>

<success_criteria>
- Admin layout with sub-nav wraps all admin pages
- Tenant settings form displays and saves tenant name, domain, logo
- Role-based gate at layout level protects all admin routes
- Server action validates input with Zod and checks role
</success_criteria>

<output>
After completion, create `.planning/phases/32-admin-panel/32-03-SUMMARY.md`
</output>
