---
phase: 32-admin-panel
plan: 06
type: execute
wave: 3
depends_on: ["32-02"]
files_modified:
  - apps/web/app/(protected)/layout.tsx
  - apps/web/app/actions/admin-settings.ts
  - apps/web/app/actions/api-keys.ts
  - apps/web/app/actions/merge-skills.ts
  - apps/web/app/actions/delete-skill.ts
  - apps/web/app/(protected)/skills/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "All isAdmin callers pass session instead of email"
    - "Nav bar shows Admin link based on session role, not email list"
    - "Server actions check role via isAdmin(session) for authorization"
    - "No references to ADMIN_EMAILS remain in application code"
  artifacts:
    - path: "apps/web/app/(protected)/layout.tsx"
      provides: "Nav with role-based admin link"
      contains: "isAdmin(session)"
    - path: "apps/web/app/actions/admin-settings.ts"
      provides: "Admin settings actions with session-based role check"
      contains: "isAdmin(session)"
    - path: "apps/web/app/actions/api-keys.ts"
      provides: "API key actions with session-based role check"
      contains: "isAdmin(session)"
    - path: "apps/web/app/actions/merge-skills.ts"
      provides: "Merge skills actions with session-based role check"
      contains: "isAdmin(session)"
    - path: "apps/web/app/actions/delete-skill.ts"
      provides: "Delete skill action with session-based role check"
      contains: "isAdmin(session)"
  key_links:
    - from: "apps/web/app/(protected)/layout.tsx"
      to: "apps/web/lib/admin.ts"
      via: "isAdmin(session) for nav visibility"
      pattern: "isAdmin\\(session\\)"
    - from: "apps/web/app/actions/admin-settings.ts"
      to: "apps/web/lib/admin.ts"
      via: "isAdmin(session) for action authorization"
      pattern: "isAdmin\\(session\\)"
---

<objective>
Migrate all isAdmin(email) callers to use the new isAdmin(session) signature introduced in plan 32-02. This is a mechanical find-and-replace across 6 files.

Purpose: Completes the RBAC transition (ADMIN-02). After this plan, role-based access replaces the ADMIN_EMAILS env var everywhere in the codebase.
Output: All isAdmin callers updated, build passes, no references to ADMIN_EMAILS in application code.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/32-admin-panel/32-02-SUMMARY.md
@apps/web/lib/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate layout and server action isAdmin callers</name>
  <files>
    apps/web/app/(protected)/layout.tsx
    apps/web/app/actions/admin-settings.ts
    apps/web/app/actions/api-keys.ts
    apps/web/app/actions/merge-skills.ts
    apps/web/app/actions/delete-skill.ts
    apps/web/app/(protected)/skills/[slug]/page.tsx
  </files>
  <action>
All files currently call `isAdmin(session.user.email)` or `isAdmin(user.email)`. Change every call to `isAdmin(session)`. The new `isAdmin` signature is `isAdmin(session: Session | null): boolean` and checks `session?.user?.role === "admin"`.

Specific changes per file:

**Layout** `(protected)/layout.tsx`:
- Line 34: Change `{isAdmin(user.email) && ...}` to `{isAdmin(session) && ...}`
- The `session` variable is already available from `await auth()` at line ~12
- Keep the existing `isAdmin` import from `@/lib/admin`

**Server actions** (each already calls `await auth()` and has `session` available):

- `app/actions/admin-settings.ts` — 3 occurrences at lines ~21, ~76, ~116:
  - Change `!isAdmin(session.user.email)` to `!isAdmin(session)` in each guard clause

- `app/actions/api-keys.ts` — 3 occurrences at lines ~43, ~100, ~206:
  - Change `!isAdmin(session.user.email)` to `!isAdmin(session)`
  - Line ~100: `existing.userId !== session.user.id && !isAdmin(session.user.email)` becomes `existing.userId !== session.user.id && !isAdmin(session)`

- `app/actions/merge-skills.ts` — 2 occurrences at lines ~20, ~51:
  - Change `!isAdmin(session.user.email)` to `!isAdmin(session)`

- `app/actions/delete-skill.ts` — 1 occurrence at line ~41:
  - Change `isAdmin(session.user.email)` to `isAdmin(session)` (note: this one uses the positive form, not negated)

**Skill detail page** `skills/[slug]/page.tsx`:
- Line ~181: Change `isAdmin(session.user.email)` to `isAdmin(session)`
- The `session` variable is available from `await auth()` earlier in the component

After all changes, verify no remaining `ADMIN_EMAILS` references in application code:
- Remove from `.env.example` if present (keep in `.env` for now as fallback, but the code no longer reads it)
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm build` compiles without errors. Verify with grep:
- `grep -r "isAdmin(session.user.email\|isAdmin(user.email" apps/web/app apps/web/lib` returns nothing
- `grep -r "ADMIN_EMAILS" apps/web/app apps/web/lib` returns nothing
- `grep -r "isAdmin(session)" apps/web/app apps/web/lib` returns 12+ matches (all migrated callers)
  </verify>
  <done>
All 12+ isAdmin callers migrated from email-based to session-based checks across 6 files. No remaining references to ADMIN_EMAILS in application code. Admin nav link in layout uses session.user.role. Build passes cleanly.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds with zero type errors
- `grep -r "ADMIN_EMAILS" apps/web/app apps/web/lib` returns nothing
- `grep -r "isAdmin(session.user.email" apps/web/` returns nothing
- `grep -r "isAdmin(user.email" apps/web/` returns nothing
- All isAdmin calls now pass session object
</verification>

<success_criteria>
- All 12+ isAdmin callers use isAdmin(session) signature
- ADMIN_EMAILS env var no longer referenced in application code
- Build passes cleanly
- Nav bar admin link and all server action guards use role-based check
</success_criteria>

<output>
After completion, create `.planning/phases/32-admin-panel/32-06-SUMMARY.md`
</output>
