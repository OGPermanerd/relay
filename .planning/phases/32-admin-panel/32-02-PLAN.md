---
phase: 32-admin-panel
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - apps/web/auth.ts
  - apps/web/types/next-auth.d.ts
  - apps/web/lib/admin.ts
autonomous: true

must_haves:
  truths:
    - "JWT contains role claim, session exposes session.user.role"
    - "First user to sign in for a tenant gets role='admin' automatically"
    - "isAdmin() accepts a session object and checks session.user.role === 'admin'"
  artifacts:
    - path: "apps/web/auth.ts"
      provides: "First-user-becomes-admin in jwt callback + role in JWT/session"
      contains: "isFirstUserInTenant"
    - path: "apps/web/lib/admin.ts"
      provides: "Role-based isAdmin() accepting session instead of email"
      contains: "session.user.role"
    - path: "apps/web/types/next-auth.d.ts"
      provides: "role field on Session.user and JWT types"
      contains: "role.*admin.*member"
  key_links:
    - from: "apps/web/auth.ts"
      to: "packages/db/src/services/user.ts"
      via: "isFirstUserInTenant import for first-user admin check"
      pattern: "isFirstUserInTenant"
    - from: "apps/web/lib/admin.ts"
      to: "apps/web/auth.ts"
      via: "session type with role field"
      pattern: "Session"
---

<objective>
Wire role into auth flow (JWT callback assigns role on first sign-in, session exposes it) and rewrite isAdmin() to accept session instead of email.

Purpose: Provides the auth foundation (ADMIN-02) that all subsequent plans depend on. Changes the isAdmin signature from email-based to session-based. Callers are migrated in plan 32-06.
Output: Auth callback with first-user-becomes-admin logic, updated type augmentation, and rewritten isAdmin().
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-admin-panel/32-01-SUMMARY.md
@apps/web/auth.ts
@apps/web/types/next-auth.d.ts
@apps/web/lib/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auth callback role assignment + type augmentation</name>
  <files>
    apps/web/auth.ts
    apps/web/types/next-auth.d.ts
  </files>
  <action>
1. Update `apps/web/types/next-auth.d.ts`:
   - Add `role?: "admin" | "member"` to both `Session.user` and `JWT` interfaces

2. Update `apps/web/auth.ts` jwt callback:
   - Import `isFirstUserInTenant` and `setUserRole` from `@everyskill/db`
   - After the existing tenantId resolution block (the `if (account && profile?.email)` block around line 53), add first-user-admin logic:
     ```
     if (account && user?.id && token.tenantId) {
       const isFirst = await isFirstUserInTenant(token.tenantId as string);
       const role = isFirst ? "admin" as const : "member" as const;
       await setUserRole(user.id, role);
       token.role = role;
     }
     ```
   - In the existing lazy-migration block (the `if (!token.tenantId && token.id)` section around line 72), also lazy-load role:
     - Extend the select to include `role: users.role`
     - After setting tenantId, also set `token.role = dbUser.role`
   - Add a SEPARATE lazy-load block for role if token has tenantId but no role (handles existing sessions after migration):
     ```
     if (!token.role && token.id) {
       try {
         const [dbUser] = await db!.select({ role: users.role }).from(users).where(eq(users.id, token.id as string)).limit(1);
         if (dbUser?.role) token.role = dbUser.role;
       } catch { /* Non-fatal */ }
     }
     ```

3. Update `apps/web/auth.ts` session callback:
   - After setting tenantId on session.user, add: `if (token.role) { session.user.role = token.role as "admin" | "member"; }`
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm build` — TypeScript compiles. Check that `Session["user"]["role"]` type exists.
  </verify>
  <done>
JWT callback assigns role on first sign-in (first user = admin). Session exposes role. Type augmentation includes role field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite isAdmin to session-based check</name>
  <files>
    apps/web/lib/admin.ts
  </files>
  <action>
Rewrite `apps/web/lib/admin.ts`:
   - Remove the ADMIN_EMAILS env var approach entirely
   - New implementation:
     ```typescript
     import type { Session } from "next-auth";

     export function isAdmin(session: Session | null): boolean {
       return session?.user?.role === "admin";
     }
     ```
   - This changes the signature from `isAdmin(email: string)` to `isAdmin(session: Session | null)`.
   - NOTE: This WILL break all existing callers. That is intentional — callers are migrated in plan 32-06.
   - The build will NOT pass after this plan alone; it requires 32-06 to complete. Verify this plan by checking that the file compiles in isolation: `npx tsc --noEmit apps/web/lib/admin.ts` or check that the import resolves.

Actually, since pnpm build will fail with broken callers, verify differently:
   - Confirm the file is syntactically valid by reading it back
   - Confirm `Session` type import resolves: `grep -c "next-auth" apps/web/lib/admin.ts` returns 1
  </action>
  <verify>
Read back `apps/web/lib/admin.ts` and confirm it exports `isAdmin(session: Session | null): boolean` with `session?.user?.role === "admin"` logic. The ADMIN_EMAILS pattern must be completely removed.
Note: Full `pnpm build` will fail until 32-06 migrates callers. This is expected.
  </verify>
  <done>
isAdmin() now accepts session object and checks role instead of email list. ADMIN_EMAILS env var dependency removed from application code.
  </done>
</task>

</tasks>

<verification>
- `apps/web/lib/admin.ts` exports session-based isAdmin
- `apps/web/auth.ts` sets role in JWT on first sign-in and lazy-loads for existing sessions
- `apps/web/types/next-auth.d.ts` includes role on Session.user and JWT
- ADMIN_EMAILS no longer referenced in lib/admin.ts
</verification>

<success_criteria>
- JWT carries role claim, session exposes session.user.role
- First sign-in for a tenant auto-assigns admin role
- isAdmin() signature changed to accept Session
- Type augmentation includes role field
</success_criteria>

<output>
After completion, create `.planning/phases/32-admin-panel/32-02-SUMMARY.md`
</output>
