---
phase: 32-admin-panel
plan: 05
type: execute
wave: 3
depends_on: ["32-02"]
files_modified:
  - apps/web/app/(protected)/admin/compliance/page.tsx
  - apps/web/components/admin-compliance-table.tsx
  - packages/db/src/services/usage-tracking.ts
autonomous: true

must_haves:
  truths:
    - "Admin can see a table of users with their hook compliance status"
    - "Users with recent hook events (last 30 days) show as compliant with event count and last activity"
    - "Users without hook events show as non-compliant"
    - "Compliance data is tenant-scoped"
  artifacts:
    - path: "apps/web/app/(protected)/admin/compliance/page.tsx"
      provides: "Server component rendering hook compliance dashboard"
      contains: "compliance"
    - path: "apps/web/components/admin-compliance-table.tsx"
      provides: "Client component showing users and their hook status"
      contains: "compliant"
    - path: "packages/db/src/services/usage-tracking.ts"
      provides: "getHookComplianceStatus() function querying usage_events metadata"
      exports: ["getHookComplianceStatus"]
  key_links:
    - from: "packages/db/src/services/usage-tracking.ts"
      to: "packages/db/src/schema/usage-events.ts"
      via: "JSONB metadata query for source='hook'"
      pattern: "metadata.*source.*hook"
    - from: "apps/web/app/(protected)/admin/compliance/page.tsx"
      to: "packages/db/src/services/usage-tracking.ts"
      via: "getHookComplianceStatus import"
      pattern: "getHookComplianceStatus"
---

<objective>
Build a compliance dashboard showing which users in the tenant have PostToolUse hooks actively firing callbacks. Query usage_events where metadata.source = 'hook' grouped by userId, cross-referenced with tenant user list.

Purpose: Delivers ADMIN-05 (admin can view hook compliance status per user). Provides visibility into which employees have tracking hooks properly configured.
Output: Compliance page, compliance table component, and getHookComplianceStatus DB service function.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/32-admin-panel/32-02-SUMMARY.md
@packages/db/src/services/usage-tracking.ts
@packages/db/src/schema/usage-events.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Hook compliance DB service + page + table component</name>
  <files>
    packages/db/src/services/usage-tracking.ts
    packages/db/src/services/index.ts
    apps/web/app/(protected)/admin/compliance/page.tsx
    apps/web/components/admin-compliance-table.tsx
  </files>
  <action>
1. Add to `packages/db/src/services/usage-tracking.ts`:
   - Import `users` from "../schema" and `and` from "drizzle-orm" (if not already imported)
   - Add function `getHookComplianceStatus(tenantId: string)`:
     ```typescript
     export async function getHookComplianceStatus(tenantId: string) {
       if (!db) return [];

       // Get all users in tenant
       const allUsers = await db
         .select({ id: users.id, name: users.name, email: users.email })
         .from(users)
         .where(eq(users.tenantId, tenantId));

       // Get users with hook events in last 30 days
       const hookUsers = await db
         .select({
           userId: usageEvents.userId,
           lastHookEvent: sql<string>`MAX(${usageEvents.createdAt})::text`,
           hookEventCount: sql<number>`COUNT(*)::int`,
         })
         .from(usageEvents)
         .where(
           and(
             eq(usageEvents.tenantId, tenantId),
             sql`${usageEvents.metadata}->>'source' = 'hook'`,
             sql`${usageEvents.createdAt} > NOW() - INTERVAL '30 days'`
           )
         )
         .groupBy(usageEvents.userId);

       // Merge: all users + their hook status
       const hookMap = new Map(hookUsers.map(h => [h.userId, h]));

       return allUsers.map(u => ({
         userId: u.id,
         userName: u.name,
         userEmail: u.email,
         isCompliant: hookMap.has(u.id),
         lastHookEvent: hookMap.get(u.id)?.lastHookEvent || null,
         hookEventCount: hookMap.get(u.id)?.hookEventCount || 0,
       }));
     }
     ```
   - Cast `lastHookEvent` as string (ISO) for serialization safety. Use `::text` in SQL.

2. Update `packages/db/src/services/index.ts`:
   - Add `getHookComplianceStatus` to the usage-tracking export line

3. Create `apps/web/app/(protected)/admin/compliance/page.tsx`:
   - Server component
   - Get session via auth() (layout already gates role)
   - Call `getHookComplianceStatus(session.user.tenantId!)` from @everyskill/db
   - Compute summary stats: total users, compliant count, non-compliant count
   - Render:
     - "Hook Compliance" heading
     - Summary cards: Total Users, Compliant (green), Non-Compliant (red/amber)
     - Pass data to `<AdminComplianceTable data={complianceData} />`

4. Create `apps/web/components/admin-compliance-table.tsx` ("use client"):
   - Props: `data: Array<{ userId: string; userName: string | null; userEmail: string; isCompliant: boolean; lastHookEvent: string | null; hookEventCount: number }>`
   - Render table with columns: User, Email, Status, Last Activity, Event Count
   - Status column: Green "Compliant" badge or Red "Non-Compliant" badge
   - Last Activity: `<RelativeTime date={lastHookEvent} />` if available, else "--"
   - Event Count: number or 0
   - Sort compliant users to top, non-compliant to bottom
   - Style consistent with other admin tables: Tailwind, divide-y, text-sm
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm build` compiles. Navigate to /admin/compliance â€” shows user table with compliance status. Users with hook events show green "Compliant" badge with event count and last activity time.
  </verify>
  <done>
Compliance dashboard shows all tenant users with their hook compliance status. Compliant users (hook events in last 30 days) show green badge with count and last activity. Non-compliant users show red badge. Summary stats at top.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- /admin/compliance renders with user compliance table
- Users with usage_events where metadata.source='hook' show as compliant
- Users without hook events show as non-compliant
- Data is filtered by current tenant
</verification>

<success_criteria>
- Compliance page accessible at /admin/compliance
- Shows all tenant users with compliant/non-compliant status
- Compliant = has hook events in last 30 days
- Last activity and event count displayed for compliant users
- Tenant-scoped (only shows current tenant's users and events)
</success_criteria>

<output>
After completion, create `.planning/phases/32-admin-panel/32-05-SUMMARY.md`
</output>
