---
phase: 32-admin-panel
plan: 04
type: execute
wave: 3
depends_on: ["32-02"]
files_modified:
  - apps/web/app/(protected)/admin/skills/page.tsx
  - apps/web/components/admin-skills-table.tsx
  - apps/web/app/actions/admin-skills.ts
autonomous: true

must_haves:
  truths:
    - "Admin can see a table of all skills in their tenant with name, author, uses, created date"
    - "Admin can delete individual skills from the table"
    - "Admin can select multiple skills via checkboxes and merge them under a chosen parent"
    - "Bulk merge uses a database transaction so partial failures roll back"
  artifacts:
    - path: "apps/web/app/(protected)/admin/skills/page.tsx"
      provides: "Server component listing all tenant skills for admin management"
      contains: "skills"
    - path: "apps/web/components/admin-skills-table.tsx"
      provides: "Client component with checkboxes, delete buttons, and bulk merge form"
      contains: "checkbox"
    - path: "apps/web/app/actions/admin-skills.ts"
      provides: "deleteSkillAdmin and bulkMergeSkills server actions with role checks"
      exports: ["deleteSkillAdminAction", "bulkMergeSkillsAction"]
  key_links:
    - from: "apps/web/app/actions/admin-skills.ts"
      to: "packages/db/src/services/skill-delete.ts"
      via: "deleteSkill service import"
      pattern: "deleteSkill"
    - from: "apps/web/app/actions/admin-skills.ts"
      to: "packages/db/src/services/skill-merge.ts"
      via: "mergeSkills service import for bulk merge"
      pattern: "mergeSkills"
---

<objective>
Create an admin skills management page where admins can view all tenant skills in a table, delete individual skills, and select multiple skills to merge under a parent skill via checkbox multi-select.

Purpose: Delivers ADMIN-03 (review/delete skills) and ADMIN-04 (multi-select merge). Provides a unified skill management interface replacing the separate merge-only page.
Output: Admin skills page, client-side multi-select table, and server actions for delete and bulk merge.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/32-admin-panel/32-02-SUMMARY.md
@packages/db/src/services/skill-delete.ts
@packages/db/src/services/skill-merge.ts
@apps/web/components/admin-merge-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin skills server actions (delete + bulk merge)</name>
  <files>
    apps/web/app/actions/admin-skills.ts
  </files>
  <action>
1. Create `apps/web/app/actions/admin-skills.ts` with "use server" directive.

2. Import: auth, db, skills, eq, and, isAdmin from @/lib/admin, revalidatePath, mergeSkills from @everyskill/db, deleteSkill from @everyskill/db

3. `deleteSkillAdminAction(formData: FormData)`:
   - Extract skillId from formData.get("skillId")
   - Check session + isAdmin(session), return { error: "Unauthorized" } if not
   - Call `deleteSkill(skillId)` (existing service in packages/db/src/services/skill-delete.ts)
   - revalidatePath("/admin/skills")
   - Return { success: true } or { error: message }
   - Type: `export type DeleteSkillState = { success?: boolean; error?: string }`

4. `bulkMergeSkillsAction(formData: FormData)`:
   - Extract: `skillIds = formData.getAll("skillIds")` as string[], `targetId = formData.get("targetId")` as string
   - Check session + isAdmin(session)
   - Validate: at least 1 skillId, targetId must exist, targetId must not be in skillIds
   - Use `db.transaction()` to merge each selected skill into targetId:
     ```
     await db.transaction(async (tx) => {
       for (const sourceId of skillIds) {
         if (sourceId === targetId) continue;
         await mergeSkills(sourceId, targetId); // existing service handles usage/rating/fork transfer
       }
     });
     ```
   - If mergeSkills doesn't accept a transaction arg, call them sequentially outside tx. Check the existing mergeSkills signature. If it uses its own db instance internally, wrap the whole thing in try/catch and note that partial failure is possible (acceptable for admin operations with small batch sizes).
   - revalidatePath("/admin/skills")
   - Return { success: true, merged: skillIds.length } or { error: message }
   - Type: `export type BulkMergeState = { success?: boolean; merged?: number; error?: string }`

5. `getAdminSkills()` — NOT a server action, just an exported async function:
   - Query all skills for current tenant: `db.select({ id, name, slug, authorId, totalUses, createdAt }).from(skills).where(eq(skills.tenantId, tenantId)).orderBy(desc(skills.createdAt))`
   - Join with users to get author name: `leftJoin(users, eq(skills.authorId, users.id))`
   - Return array of skill rows with author name
   - Get tenantId from session
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm build` compiles. Actions are importable from `@/app/actions/admin-skills`.
  </verify>
  <done>
Server actions for admin skill delete and bulk merge exist with role checks. getAdminSkills fetches all tenant skills with author names.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin skills page with multi-select table</name>
  <files>
    apps/web/app/(protected)/admin/skills/page.tsx
    apps/web/components/admin-skills-table.tsx
  </files>
  <action>
1. Create `apps/web/app/(protected)/admin/skills/page.tsx`:
   - Server component that calls `getAdminSkills()` from the admin-skills action file (or query inline)
   - Pass skills array to `<AdminSkillsTable skills={skills} />`
   - Wrap in standard admin page structure: heading "Skill Management", description text

2. Create `apps/web/components/admin-skills-table.tsx` ("use client"):
   - Props: `skills: Array<{ id: string; name: string; slug: string; authorName: string | null; totalUses: number; createdAt: string }>`
   - NOTE: Pass createdAt as ISO string (server-to-client serialization rule)
   - State: `selected: Set<string>` for multi-select checkboxes
   - Render HTML table with columns: Checkbox, Name, Author, Uses, Created, Actions
   - Each row has:
     - Checkbox input (controlled by selected state)
     - Skill name
     - Author name (or "Unknown")
     - Total uses count
     - Created date using `<RelativeTime date={skill.createdAt} />`
     - Delete button (individual, with confirmation) — uses `deleteSkillAdminAction` via form with hidden input
   - "Select All" checkbox in header that toggles all
   - Below table, when selected.size >= 2, show bulk merge section:
     - Dropdown/select to choose "Merge into:" target skill (from the selected set)
     - Hidden inputs for each selected skillId (except targetId)
     - Hidden input for targetId
     - "Merge N skills into [target]" button
     - Confirmation dialog before submission (useState toggle, not window.confirm)
   - Use `useActionState` for both delete and merge actions with pending states
   - Style: Tailwind table with `divide-y`, `text-sm`, consistent with existing admin pages

3. Serialization: In the server component, map skills to pass `.createdAt.toISOString()` before passing to client component.
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm build` compiles. Navigate to /admin/skills — table renders with checkboxes. Select 2+ skills shows merge controls.
  </verify>
  <done>
Admin skills page shows all tenant skills in a table. Individual delete works with confirmation. Multi-select checkboxes enable bulk merge with target selection. All operations have role checks.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- /admin/skills shows table of all tenant skills
- Clicking delete on a skill removes it after confirmation
- Selecting 2+ skills and choosing a merge target triggers bulk merge
- Merged skills transfer usage/ratings/forks to target
</verification>

<success_criteria>
- Skills table displays all tenant skills with name, author, uses, date
- Individual skill deletion works with role-checked server action
- Multi-select with checkboxes allows bulk merge under a parent skill
- Bulk merge uses transaction (or sequential with error handling)
- All operations scoped to current tenant
</success_criteria>

<output>
After completion, create `.planning/phases/32-admin-panel/32-04-SUMMARY.md`
</output>
