---
phase: 32-admin-panel
plan: 04
type: execute
wave: 4
depends_on: ["32-06"]
files_modified:
  - apps/web/app/actions/admin-skills.ts
  - apps/web/app/(protected)/admin/skills/page.tsx
  - apps/web/components/admin-skills-table.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see a table of all skills in their tenant with name, author, uses, created date"
    - "Admin can delete individual skills from the table"
    - "Admin can select multiple skills via checkboxes and merge them under a chosen parent"
    - "Bulk merge calls mergeSkills sequentially with error accumulation so partial success is visible"
  artifacts:
    - path: "apps/web/app/(protected)/admin/skills/page.tsx"
      provides: "Server component listing all tenant skills for admin management"
      contains: "skills"
    - path: "apps/web/components/admin-skills-table.tsx"
      provides: "Client component with checkboxes, delete buttons, and bulk merge form"
      contains: "checkbox"
    - path: "apps/web/app/actions/admin-skills.ts"
      provides: "deleteSkillAdmin, bulkMergeSkills, and getAdminSkills functions with role checks"
      exports: ["deleteSkillAdminAction", "bulkMergeSkillsAction", "getAdminSkills"]
  key_links:
    - from: "apps/web/app/actions/admin-skills.ts"
      to: "packages/db/src/services/skill-delete.ts"
      via: "import { deleteSkill } from '@everyskill/db'"
      pattern: "deleteSkill"
    - from: "apps/web/app/actions/admin-skills.ts"
      to: "packages/db/src/services/skill-merge.ts"
      via: "import { mergeSkills } from '@everyskill/db'"
      pattern: "mergeSkills"
    - from: "apps/web/app/(protected)/admin/skills/page.tsx"
      to: "apps/web/app/actions/admin-skills.ts"
      via: "import { getAdminSkills } from '@/app/actions/admin-skills'"
      pattern: "getAdminSkills"
---

<objective>
Create an admin skills management page where admins can view all tenant skills in a table, delete individual skills, and select multiple skills to merge under a parent skill via checkbox multi-select.

Purpose: Delivers ADMIN-03 (review/delete skills) and ADMIN-04 (multi-select merge). Provides a unified skill management interface.
Output: Admin skills page, client-side multi-select table, and server actions for delete and bulk merge.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/32-admin-panel/32-06-SUMMARY.md
@packages/db/src/services/skill-delete.ts
@packages/db/src/services/skill-merge.ts
@apps/web/components/admin-merge-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin skills server actions (delete + bulk merge + query)</name>
  <files>
    apps/web/app/actions/admin-skills.ts
  </files>
  <action>
1. Create `apps/web/app/actions/admin-skills.ts` with "use server" directive.

2. Imports:
   - `auth` from `@/auth`
   - `isAdmin` from `@/lib/admin`
   - `{ mergeSkills }` from `@everyskill/db` (re-exported from packages/db/src/services/index.ts)
   - `{ deleteSkill }` from `@everyskill/db` (re-exported from packages/db/src/services/index.ts)
   - `{ db }` from `@everyskill/db`
   - `{ skills, users }` from `@everyskill/db` (schema)
   - `{ eq, desc }` from `drizzle-orm`
   - `{ revalidatePath }` from `next/cache`

3. `deleteSkillAdminAction(formData: FormData)`:
   - Type: `export type DeleteSkillState = { success?: boolean; error?: string }`
   - Extract skillId from formData.get("skillId") as string
   - Check session + isAdmin(session), return { error: "Unauthorized" } if not
   - Wrap in try/catch:
     ```
     try {
       const result = await deleteSkill(skillId);
       if (!result.success) return { error: result.error || "Delete failed" };
       revalidatePath("/admin/skills");
       return { success: true };
     } catch (e) {
       return { error: e instanceof Error ? e.message : "Delete failed" };
     }
     ```

4. `bulkMergeSkillsAction(formData: FormData)`:
   - Type: `export type BulkMergeState = { success?: boolean; merged?: number; errors?: string[]; error?: string }`
   - Extract: `skillIds = formData.getAll("skillIds")` as string[], `targetId = formData.get("targetId")` as string
   - Check session + isAdmin(session), return { error: "Unauthorized" } if not
   - Validate: skillIds.length >= 1, targetId must be non-empty, targetId must not be in skillIds
   - IMPORTANT: `mergeSkills(sourceId, targetId)` signature takes two string args and returns `Promise<{success: boolean; error?: string}>`. It manages its OWN internal db.transaction(). Do NOT wrap in an outer transaction.
   - Call mergeSkills sequentially for each source skill, accumulating errors:
     ```
     const errors: string[] = [];
     let merged = 0;
     for (const sourceId of skillIds) {
       if (sourceId === targetId) continue;
       try {
         const result = await mergeSkills(sourceId, targetId);
         if (result.success) {
           merged++;
         } else {
           errors.push(`Failed to merge skill ${sourceId}: ${result.error || "Unknown error"}`);
         }
       } catch (e) {
         errors.push(`Error merging skill ${sourceId}: ${e instanceof Error ? e.message : "Unknown error"}`);
       }
     }
     revalidatePath("/admin/skills");
     if (errors.length > 0) {
       return { success: merged > 0, merged, errors, error: `${errors.length} merge(s) failed` };
     }
     return { success: true, merged };
     ```

5. `getAdminSkills()` — NOT a server action, just an exported async function:
   - Import `leftJoin` from `drizzle-orm` if needed, or use Drizzle's query builder with join
   - Query: select skills with author name via left join on users:
     ```
     const session = await auth();
     if (!session?.user?.tenantId) return [];
     const rows = await db!
       .select({
         id: skills.id,
         name: skills.name,
         slug: skills.slug,
         authorName: users.name,
         totalUses: skills.totalUses,
         createdAt: skills.createdAt,
       })
       .from(skills)
       .leftJoin(users, eq(skills.authorId, users.id))
       .where(eq(skills.tenantId, session.user.tenantId))
       .orderBy(desc(skills.createdAt));
     return rows;
     ```
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm build` compiles. The three exports (deleteSkillAdminAction, bulkMergeSkillsAction, getAdminSkills) are importable from `@/app/actions/admin-skills`.
  </verify>
  <done>
Server actions for admin skill delete and bulk merge exist with role checks and try/catch error handling. Bulk merge calls mergeSkills sequentially with error accumulation. getAdminSkills fetches all tenant skills with author names via left join.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin skills page with multi-select table</name>
  <files>
    apps/web/app/(protected)/admin/skills/page.tsx
    apps/web/components/admin-skills-table.tsx
  </files>
  <action>
1. Create `apps/web/app/(protected)/admin/skills/page.tsx`:
   - Server component
   - Import `getAdminSkills` from `@/app/actions/admin-skills`
   - Call `const skills = await getAdminSkills()`
   - Serialize dates: `skills.map(s => ({ ...s, createdAt: s.createdAt.toISOString() }))`
   - Pass serialized array to `<AdminSkillsTable skills={serializedSkills} />`
   - Wrap in standard admin page structure: heading "Skill Management", description text

2. Create `apps/web/components/admin-skills-table.tsx` ("use client"):
   - Props type:
     ```
     type AdminSkill = {
       id: string;
       name: string;
       slug: string;
       authorName: string | null;
       totalUses: number;
       createdAt: string; // ISO string
     };
     type Props = { skills: AdminSkill[] };
     ```
   - State: `selected: Set<string>` for multi-select checkboxes, `showMergeConfirm: boolean`
   - Render HTML table with columns: Checkbox, Name, Author, Uses, Created, Actions
   - Each row has:
     - Checkbox input (controlled by selected state)
     - Skill name (text)
     - Author name (or "Unknown")
     - Total uses count
     - Created date formatted as relative time or simple date string
     - Delete button (individual) — uses form with hidden skillId input, action={deleteSkillAdminAction}
   - "Select All" checkbox in header that toggles all rows
   - Below table, when selected.size >= 2, show bulk merge section:
     - `<select>` dropdown to choose "Merge into:" target skill (populated from selected skills)
     - Form with hidden inputs: one for each selected skillId (except targetId), plus targetId
     - "Merge N skills into [target]" submit button
     - Confirmation: show/hide merge form behind a confirmation toggle (useState, not window.confirm)
   - Use `useActionState` for delete action with pending state
   - Use `useActionState` for merge action with pending state, display errors[] if present
   - Style: Tailwind table with `divide-y`, `text-sm`, consistent with existing admin pages
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm build` compiles. Navigate to /admin/skills — table renders with skill data. Checkboxes are functional. Selecting 2+ skills shows merge controls below table.
  </verify>
  <done>
Admin skills page shows all tenant skills in a table with checkboxes. Individual delete works via form submission. Multi-select enables bulk merge with target selection and confirmation. Error messages display for partial failures.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- /admin/skills shows table of all tenant skills
- Clicking delete on a skill removes it
- Selecting 2+ skills and choosing a merge target triggers bulk merge
- Partial merge failures display error messages for failed items
- Merged skills transfer usage/ratings/forks to target
</verification>

<success_criteria>
- Skills table displays all tenant skills with name, author, uses, date
- Individual skill deletion works with role-checked server action
- Multi-select with checkboxes allows bulk merge under a parent skill
- Bulk merge calls mergeSkills sequentially with try/catch error accumulation
- All operations scoped to current tenant
</success_criteria>

<output>
After completion, create `.planning/phases/32-admin-panel/32-04-SUMMARY.md`
</output>
