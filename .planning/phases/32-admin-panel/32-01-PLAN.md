---
phase: 32-admin-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/users.ts
  - packages/db/src/services/user.ts
  - packages/db/src/services/index.ts
  - packages/db/src/migrations/0011_add_user_roles.sql
autonomous: true

must_haves:
  truths:
    - "Users table has a role column with enum type ('admin' | 'member'), default 'member'"
    - "Existing users have role set; first user per tenant is 'admin' via migration backfill"
    - "isFirstUserInTenant() service function exists and returns boolean"
  artifacts:
    - path: "packages/db/src/schema/users.ts"
      provides: "roleEnum pgEnum + role column on users table"
      contains: "pgEnum.*user_role"
    - path: "packages/db/src/services/user.ts"
      provides: "isFirstUserInTenant() and getUserRole() functions"
      exports: ["isFirstUserInTenant", "getUserRole"]
    - path: "packages/db/src/migrations/0011_add_user_roles.sql"
      provides: "Migration adding role enum and column with backfill"
      contains: "CREATE TYPE user_role"
  key_links:
    - from: "packages/db/src/schema/users.ts"
      to: "packages/db/src/services/user.ts"
      via: "users table import for queries"
      pattern: "import.*users.*from.*schema"
---

<objective>
Add a `role` enum column ('admin' | 'member') to the users table with a migration that backfills existing users (first user per tenant becomes admin, rest become member). Create DB service functions for role queries.

Purpose: Foundation for role-based access control (ADMIN-02). All subsequent plans depend on this role column existing.
Output: Schema change, migration, and DB service functions for role management.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@packages/db/src/schema/users.ts
@packages/db/src/schema/index.ts
@packages/db/src/services/index.ts
@packages/db/src/migrations/0010_create_skill_messages.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add role pgEnum and column to users schema + migration</name>
  <files>
    packages/db/src/schema/users.ts
    packages/db/src/migrations/0011_add_user_roles.sql
  </files>
  <action>
1. In `packages/db/src/schema/users.ts`:
   - Import `pgEnum` from `drizzle-orm/pg-core`
   - Create `export const roleEnum = pgEnum('user_role', ['admin', 'member']);`
   - Add `role: roleEnum("role").notNull().default("member")` to the users table columns, positioned after `email`
   - Update the `User` type export (already inferred, but verify it now includes `role: "admin" | "member"`)

2. Create migration `packages/db/src/migrations/0011_add_user_roles.sql`:
```sql
-- Migration 0011: Add user roles (admin/member)
-- Phase 32: Admin Panel - RBAC foundation

-- Create the enum type
DO $$ BEGIN
  CREATE TYPE user_role AS ENUM ('admin', 'member');
EXCEPTION
  WHEN duplicate_object THEN NULL;
END $$;

-- Add role column with default 'member'
ALTER TABLE users ADD COLUMN IF NOT EXISTS role user_role NOT NULL DEFAULT 'member';

-- Backfill: first user per tenant (by created_at) becomes admin
WITH first_users AS (
  SELECT DISTINCT ON (tenant_id) id
  FROM users
  ORDER BY tenant_id, created_at ASC
)
UPDATE users
SET role = 'admin'
WHERE id IN (SELECT id FROM first_users)
  AND role = 'member';
```

The migration is idempotent (IF NOT EXISTS, DO/EXCEPTION, WHERE role = 'member' guard).
  </action>
  <verify>
Run `cd /home/dev/projects/relay && pnpm build` to confirm schema compiles. Then run the migration:
`cd /home/dev/projects/relay/packages/db && npx tsx src/migrate.ts`
Verify with: `psql $DATABASE_URL -c "SELECT id, email, role, tenant_id FROM users ORDER BY created_at LIMIT 10;"` — first user per tenant should show 'admin'.
  </verify>
  <done>
users table has `role` column of type `user_role` enum ('admin' | 'member'). All existing users backfilled. TypeScript infers `role: "admin" | "member"` on User type.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create user DB service with role query functions</name>
  <files>
    packages/db/src/services/user.ts
    packages/db/src/services/index.ts
  </files>
  <action>
1. Create `packages/db/src/services/user.ts`:
   - `isFirstUserInTenant(tenantId: string): Promise<boolean>` — counts users WHERE tenant_id = tenantId, returns true if count === 0. Uses `sql<number>\`COUNT(*)::int\`` pattern. Returns false on error.
   - `getUserRole(userId: string): Promise<"admin" | "member" | null>` — selects role from users WHERE id = userId, returns null if not found or on error.
   - `setUserRole(userId: string, role: "admin" | "member"): Promise<boolean>` — updates role, returns true on success. Used by auth callback and future admin promote/demote.
   - `getUsersInTenant(tenantId: string): Promise<Array<{id: string, name: string | null, email: string, role: "admin" | "member", image: string | null, createdAt: Date}>>` — lists all users in tenant. For admin user management.
   - All functions guard with `if (!db) return ...` pattern (consistent with existing services).
   - Import db from "../client", users from "../schema", eq/sql from "drizzle-orm".

2. Update `packages/db/src/services/index.ts`:
   - Add export line: `export { isFirstUserInTenant, getUserRole, setUserRole, getUsersInTenant } from "./user";`
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm build` compiles without errors. Functions are importable: `import { isFirstUserInTenant } from "@everyskill/db"`.
  </verify>
  <done>
Four user service functions exported from @everyskill/db. isFirstUserInTenant returns boolean, getUserRole returns role or null, setUserRole updates role, getUsersInTenant lists tenant users.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- Migration 0011 applied: `\d users` shows `role` column of type `user_role`
- `SELECT role, COUNT(*) FROM users GROUP BY role;` shows at least 1 admin
- TypeScript: `User["role"]` infers as `"admin" | "member"`
</verification>

<success_criteria>
- users table has role enum column with 'admin'/'member' values
- First user per tenant is admin after migration
- DB service functions (isFirstUserInTenant, getUserRole, setUserRole, getUsersInTenant) exist and compile
- All exported from @everyskill/db package
</success_criteria>

<output>
After completion, create `.planning/phases/32-admin-panel/32-01-SUMMARY.md`
</output>
