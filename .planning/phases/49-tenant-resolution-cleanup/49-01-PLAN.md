---
phase: 49-tenant-resolution-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/tests/e2e/auth.setup.ts
  - apps/web/app/api/dev-login/route.ts
  - apps/web/lib/embedding-generator.ts
  - apps/web/lib/greeting-pool.ts
  - apps/web/app/actions/skills.ts
  - apps/web/app/actions/fork-skill.ts
  - apps/web/app/actions/admin-settings.ts
  - apps/web/app/(protected)/page.tsx
autonomous: true

must_haves:
  truths:
    - "E2E test sessions carry tenantId in JWT so session.user.tenantId is available in all server actions/components"
    - "Dev-login sessions carry tenantId in JWT for local development"
    - "generateSkillEmbedding accepts tenantId parameter and all callers pass it"
    - "getGreeting accepts tenantId parameter and caller passes it"
  artifacts:
    - path: "apps/web/tests/e2e/auth.setup.ts"
      provides: "JWT token with tenantId claim for E2E tests"
      contains: "tenantId"
    - path: "apps/web/app/api/dev-login/route.ts"
      provides: "JWT token with tenantId for dev login"
      contains: "tenantId"
    - path: "apps/web/lib/embedding-generator.ts"
      provides: "generateSkillEmbedding with tenantId parameter"
      contains: "tenantId: string"
    - path: "apps/web/lib/greeting-pool.ts"
      provides: "getGreeting and loadOrRefreshPool with tenantId parameter"
      contains: "tenantId: string"
  key_links:
    - from: "apps/web/app/actions/skills.ts"
      to: "apps/web/lib/embedding-generator.ts"
      via: "generateSkillEmbedding(id, name, desc, tenantId)"
      pattern: "generateSkillEmbedding\\(.+tenantId"
    - from: "apps/web/app/(protected)/page.tsx"
      to: "apps/web/lib/greeting-pool.ts"
      via: "getGreeting(userId, firstName, context, tenantId)"
      pattern: "getGreeting\\(.+tenantId"
---

<objective>
Add tenantId to test JWT tokens and update utility function signatures to accept tenantId as a parameter.

Purpose: This is the prerequisite for all other tenant resolution work. Without tenantId in the JWT, all E2E tests will break when server actions start requiring it. Without tenantId parameters on utility functions, callers cannot pass session-derived tenantId through.

Output: auth.setup.ts and dev-login emit JWT with tenantId claim; embedding-generator.ts and greeting-pool.ts accept tenantId parameter; all callers updated.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/49-tenant-resolution-cleanup/49-RESEARCH.md (patterns: Example 5, Example 6)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tenantId to test and dev JWT tokens</name>
  <files>apps/web/tests/e2e/auth.setup.ts, apps/web/app/api/dev-login/route.ts</files>
  <action>
In `apps/web/tests/e2e/auth.setup.ts`:
- The file already defines `const DEFAULT_TENANT_ID = "default-tenant-000-0000-000000000000"` at line 12
- Add `tenantId: DEFAULT_TENANT_ID` to the JWT token payload object (inside `encode({ token: { ... } })`) at line 60-68, alongside the existing `id`, `email`, `name`, `sub`, `iat`, `exp` fields

In `apps/web/app/api/dev-login/route.ts`:
- The file already defines `const DEFAULT_TENANT_ID = "default-tenant-000-0000-000000000000"` at line 12
- Add `tenantId: DEFAULT_TENANT_ID` to the JWT token payload object (inside `encode({ token: { ... } })`) at line 58-66, alongside the existing `id`, `email`, `name`, `sub`, `iat`, `exp` fields

Both files keep their existing `DEFAULT_TENANT_ID` constant -- these are test/dev infrastructure, not runtime code paths.
  </action>
  <verify>Run `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` to confirm no type errors. Grep both files for `tenantId` to confirm it appears in the token payload.</verify>
  <done>Both auth.setup.ts and dev-login/route.ts encode tenantId in the JWT, so session.user.tenantId is populated for all test and dev sessions.</done>
</task>

<task type="auto">
  <name>Task 2: Add tenantId parameter to utility functions and update all callers</name>
  <files>apps/web/lib/embedding-generator.ts, apps/web/lib/greeting-pool.ts, apps/web/app/actions/skills.ts, apps/web/app/actions/fork-skill.ts, apps/web/app/actions/admin-settings.ts, apps/web/app/(protected)/page.tsx</files>
  <action>
**embedding-generator.ts:**
- Remove the local `const DEFAULT_TENANT_ID` constant (line 5)
- Remove the `import { ... DEFAULT_TENANT_ID }` if present (currently uses local const, not import)
- Add `tenantId: string` as the 4th parameter to `generateSkillEmbedding`: `export async function generateSkillEmbedding(skillId: string, name: string, description: string, tenantId: string)`
- Change the `upsertSkillEmbedding` call (line 39) from `tenantId: DEFAULT_TENANT_ID` to `tenantId`

**greeting-pool.ts:**
- Remove the import of `DEFAULT_TENANT_ID` from `@everyskill/db` (line 2 -- keep `db` and `userPreferences` imports)
- Add `tenantId: string` parameter to `loadOrRefreshPool` function signature (line 94): `async function loadOrRefreshPool(userId: string, tenantId: string, context: { ... })`
- In the `db.insert(userPreferences).values()` call (line 132), change `tenantId: DEFAULT_TENANT_ID` to `tenantId`
- Add `tenantId: string` parameter to the exported `getGreeting` function signature (line 164): `export async function getGreeting(userId: string, firstName: string, context: { ... }, tenantId: string)`
- Update the `loadOrRefreshPool` call inside `getGreeting` (line 175) to pass `tenantId`: `const pool = await loadOrRefreshPool(userId, tenantId, context)`

**Update callers -- apps/web/app/actions/skills.ts (3 call sites):**
- Line 147: `generateSkillEmbedding(skillId, name, ..., tenantId).catch(() => {})` -- the local `tenantId` variable should already exist in scope from session resolution (will be added in Plan 02, but for now ensure the call compiles by using the existing DEFAULT_TENANT_ID or session.user.tenantId if already present). Since Plan 01 runs before Plan 02: if skills.ts already has a session-derived tenantId variable in scope near these call sites, use it. Otherwise, for THIS plan only, add `const tenantId = session.user.tenantId ?? DEFAULT_TENANT_ID;` near each usage in skills.ts as a transitional pattern. Plan 02 will remove the fallback.
- Line 306: same pattern
- Line 514: same pattern

**Update callers -- apps/web/app/actions/fork-skill.ts (1 call site):**
- Line 137: `generateSkillEmbedding(newSkill.id, forkName, parent.description, tenantId).catch(() => {})` -- same transitional pattern as skills.ts if needed.

**Update callers -- apps/web/app/actions/admin-settings.ts (1 call site):**
- Line 143: `await generateSkillEmbedding(skill.id, skill.name, skill.description, tenantId)` -- admin-settings.ts should have a session and tenantId from it. Add session-derived tenantId if not present, with DEFAULT_TENANT_ID fallback as transitional.

**Update caller -- apps/web/app/(protected)/page.tsx (1 call site for getGreeting):**
- Line 49: `const greeting = await getGreeting(user.id!, firstName, { ... }, tenantId)` -- this is a server component that calls `await auth()`. Extract `const tenantId = session.user.tenantId ?? DEFAULT_TENANT_ID;` (transitional, Plan 02 will make strict). Import DEFAULT_TENANT_ID from @everyskill/db if not already imported.

NOTE: The transitional `?? DEFAULT_TENANT_ID` fallbacks in callers are intentional for Plan 01. Plan 02 will convert all of them to strict session-only resolution. This plan's job is just to change the function signatures without breaking anything.
  </action>
  <verify>Run `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` to confirm no type errors from the signature changes. Grep for `DEFAULT_TENANT_ID` in embedding-generator.ts to confirm it's removed (should have zero hits). Grep for `tenantId: string` in both utility files to confirm the parameter exists.</verify>
  <done>generateSkillEmbedding and getGreeting accept tenantId as a parameter. All 5 callers pass tenantId. No DEFAULT_TENANT_ID usage remains in the utility function implementations. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
- `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` passes with zero errors
- `grep -n "tenantId" apps/web/tests/e2e/auth.setup.ts` shows tenantId in token payload
- `grep -n "tenantId" apps/web/app/api/dev-login/route.ts` shows tenantId in token payload
- `grep -n "DEFAULT_TENANT_ID" apps/web/lib/embedding-generator.ts` returns no results
- `grep -c "tenantId: string" apps/web/lib/embedding-generator.ts` returns 1
- `grep -c "tenantId: string" apps/web/lib/greeting-pool.ts` returns 2 (loadOrRefreshPool + getGreeting)
</verification>

<success_criteria>
1. JWT tokens for E2E tests and dev-login include tenantId claim
2. generateSkillEmbedding requires tenantId parameter, no internal DEFAULT_TENANT_ID
3. getGreeting requires tenantId parameter, no internal DEFAULT_TENANT_ID
4. All callers of both utility functions pass tenantId
5. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/49-tenant-resolution-cleanup/49-01-SUMMARY.md`
</output>
