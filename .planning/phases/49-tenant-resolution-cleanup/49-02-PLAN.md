---
phase: 49-tenant-resolution-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["49-01"]
files_modified:
  - apps/web/app/actions/skills.ts
  - apps/web/app/actions/ratings.ts
  - apps/web/app/actions/fork-skill.ts
  - apps/web/app/actions/api-keys.ts
  - apps/web/app/actions/user-preferences.ts
  - apps/web/app/actions/notification-preferences.ts
  - apps/web/app/actions/export-claude-md.ts
  - apps/web/app/actions/skill-messages.ts
  - apps/web/app/actions/discover.ts
  - apps/web/app/actions/get-skill-content.ts
  - apps/web/app/(protected)/admin/layout.tsx
  - apps/web/app/(protected)/admin/reviews/page.tsx
  - apps/web/app/(protected)/admin/reviews/[skillId]/page.tsx
  - apps/web/app/(protected)/admin/search/page.tsx
  - apps/web/app/(protected)/skills/page.tsx
  - packages/db/src/services/skill-reviews.ts
autonomous: true

must_haves:
  truths:
    - "All server actions derive tenantId from session.user.tenantId with no DEFAULT_TENANT_ID fallback"
    - "All admin/protected server components derive tenantId from session.user.tenantId with no fallback"
    - "skill-reviews.ts upsertSkillReview requires tenantId (not optional with inline fallback)"
    - "Requests without a resolved tenantId return an error instead of silently using a default"
  artifacts:
    - path: "apps/web/app/actions/skills.ts"
      provides: "Skill CRUD actions with session-derived tenantId"
      contains: "session.user.tenantId"
    - path: "apps/web/app/actions/ratings.ts"
      provides: "Rating actions with session-derived tenantId"
      contains: "session.user.tenantId"
    - path: "packages/db/src/services/skill-reviews.ts"
      provides: "upsertSkillReview with required tenantId"
      contains: "tenantId: string"
  key_links:
    - from: "apps/web/app/actions/skills.ts"
      to: "packages/db/src/services/skill-reviews.ts"
      via: "upsertSkillReview({ tenantId, ... })"
      pattern: "upsertSkillReview\\(\\{.*tenantId"
---

<objective>
Replace all DEFAULT_TENANT_ID usage in server actions, server components, and the skill-reviews DB service with session-derived tenantId.

Purpose: This is the core refactoring -- 16 files that currently hardcode or fallback to DEFAULT_TENANT_ID will instead derive tenant from the authenticated session. This eliminates the most common anti-pattern across the codebase.

Output: All web app runtime code paths use session.user.tenantId with strict error handling.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/49-tenant-resolution-cleanup/49-RESEARCH.md (patterns: Example 1, Example 2)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace DEFAULT_TENANT_ID in all 10 server action files</name>
  <files>apps/web/app/actions/skills.ts, apps/web/app/actions/ratings.ts, apps/web/app/actions/fork-skill.ts, apps/web/app/actions/api-keys.ts, apps/web/app/actions/user-preferences.ts, apps/web/app/actions/notification-preferences.ts, apps/web/app/actions/export-claude-md.ts, apps/web/app/actions/skill-messages.ts, apps/web/app/actions/discover.ts, apps/web/app/actions/get-skill-content.ts</files>
  <action>
For EACH of the 10 server action files, apply this pattern:

1. **Remove** the local `const DEFAULT_TENANT_ID = "default-tenant-000-0000-000000000000"` declaration (if present)
2. **Remove** any `import { ... DEFAULT_TENANT_ID ... }` from `@everyskill/db` (clean up the import -- keep other imports from the same line)
3. **After** the existing `session?.user?.id` check (which returns early with an auth error), add the tenantId resolution:
   ```typescript
   const tenantId = session.user.tenantId;
   if (!tenantId) return { error: "Tenant not resolved" };
   ```
   Use the same error return shape the file already uses for auth errors (some use `{ message: "..." }`, some use `{ error: "..." }` -- match the existing pattern in each file).
4. **Replace** every `DEFAULT_TENANT_ID` or `session?.user?.tenantId ?? DEFAULT_TENANT_ID` or `session.user.tenantId || DEFAULT_TENANT_ID` usage with the local `tenantId` variable.

**File-specific notes:**

- **skills.ts** (6 uses): Has 3 `generateSkillEmbedding` calls that Plan 01 already updated to pass `tenantId`. Remove the transitional `?? DEFAULT_TENANT_ID` fallback from the tenantId variable if Plan 01 added one. The `tenantId` variable from step 3 above should be used everywhere.
- **ratings.ts** (2 uses): Used in `db.insert(ratings).values()` and notification creation.
- **fork-skill.ts** (3 uses): Used in skill insert, version insert, and `generateSkillEmbedding` call. Plan 01 already updated the embedding call -- just ensure `tenantId` comes from session.
- **api-keys.ts** (2 uses): Used in API key insert and rotate.
- **user-preferences.ts** (1 use): Currently has `session.user.tenantId || DEFAULT_TENANT_ID` -- change to strict.
- **notification-preferences.ts** (1 use): Same fallback pattern -- change to strict.
- **export-claude-md.ts** (1 use): Same fallback pattern -- change to strict.
- **skill-messages.ts** (1 use): Same fallback pattern -- change to strict.
- **discover.ts** (1 use): Uses `session?.user?.tenantId ?? DEFAULT_TENANT_ID` -- change to strict.
- **get-skill-content.ts** (1 use): Import from @everyskill/db -- change to strict session resolution.

**Also update page.tsx (homepage)**: `apps/web/app/(protected)/page.tsx` -- Plan 01 added a transitional `?? DEFAULT_TENANT_ID` fallback for the `getGreeting` call. Remove the fallback and make it strict: `const tenantId = session.user.tenantId; if (!tenantId) redirect("/");` -- then pass `tenantId` to `getGreeting`.
  </action>
  <verify>Run `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` to confirm no type errors. Run `grep -rn "DEFAULT_TENANT_ID" apps/web/app/actions/` to confirm zero hits across all action files. Run `grep -rn "DEFAULT_TENANT_ID" "apps/web/app/(protected)/page.tsx"` to confirm zero hits.</verify>
  <done>All 10 server action files + homepage derive tenantId strictly from session.user.tenantId. No DEFAULT_TENANT_ID references remain in any action file. Missing tenantId returns an error response.</done>
</task>

<task type="auto">
  <name>Task 2: Replace DEFAULT_TENANT_ID in 5 server components and skill-reviews DB service</name>
  <files>apps/web/app/(protected)/admin/layout.tsx, apps/web/app/(protected)/admin/reviews/page.tsx, apps/web/app/(protected)/admin/reviews/[skillId]/page.tsx, apps/web/app/(protected)/admin/search/page.tsx, apps/web/app/(protected)/skills/page.tsx, packages/db/src/services/skill-reviews.ts</files>
  <action>
**Server components (5 files)** -- apply this pattern to each:

1. **Remove** any local `const DEFAULT_TENANT_ID` or import of `DEFAULT_TENANT_ID`
2. These are server components that call `await auth()`. After the session check, add:
   ```typescript
   const tenantId = session.user.tenantId;
   if (!tenantId) redirect("/");
   ```
   Use `redirect("/")` for server components (not return error) since these are page renders.
3. Replace all `DEFAULT_TENANT_ID` or fallback patterns with the local `tenantId` variable.

**File-specific notes:**
- **admin/layout.tsx** (1 use): Already has `session.user.tenantId || DEFAULT_TENANT_ID` fallback -- change to strict with redirect
- **admin/reviews/page.tsx** (1 use): Same pattern
- **admin/reviews/[skillId]/page.tsx** (1 use): Same pattern
- **admin/search/page.tsx** (1 use): Has local const -- remove and use session
- **skills/page.tsx** (1 use): Used for search logging -- change to session-derived

**DB service -- packages/db/src/services/skill-reviews.ts:**

1. In the `UpsertSkillReviewParams` interface (line 9-20), change `tenantId?: string` to `tenantId: string` (remove the optional `?`)
2. In the `upsertSkillReview` function (line 57), change `${data.tenantId ?? "default-tenant-000-0000-000000000000"}` to just `${data.tenantId}` -- the caller is now required to provide it
3. Verify all callers of `upsertSkillReview` pass tenantId. The main caller is `apps/web/lib/ai-review.ts` (the `autoGenerateReview` function). Check if it passes tenantId already -- if not, add `tenantId: string` parameter to `autoGenerateReview` and update its callers in `skills.ts` to pass the session-derived tenantId.
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json` to confirm no type errors. Run `grep -rn "DEFAULT_TENANT_ID" "apps/web/app/(protected)/admin/" "apps/web/app/(protected)/skills/page.tsx" "packages/db/src/services/skill-reviews.ts"` to confirm zero hits.</verify>
  <done>All 5 admin/protected server components derive tenantId from session with redirect on failure. skill-reviews.ts requires tenantId (no optional, no inline fallback). All callers pass tenantId from session. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
- `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` passes with zero errors
- `grep -rn "DEFAULT_TENANT_ID" apps/web/app/actions/` returns no results
- `grep -rn "DEFAULT_TENANT_ID" "apps/web/app/(protected)/"` returns no results
- `grep -rn "DEFAULT_TENANT_ID" packages/db/src/services/skill-reviews.ts` returns no results
- `grep -c "session.user.tenantId" apps/web/app/actions/skills.ts` returns 1+ (confirming session-derived)
</verification>

<success_criteria>
1. Zero DEFAULT_TENANT_ID references in any server action file
2. Zero DEFAULT_TENANT_ID references in any admin/protected server component
3. skill-reviews.ts tenantId parameter is required (not optional)
4. All files compile without TypeScript errors
5. Every authenticated code path has a tenantId guard that returns error/redirects on missing tenant
</success_criteria>

<output>
After completion, create `.planning/phases/49-tenant-resolution-cleanup/49-02-SUMMARY.md`
</output>
