---
phase: 49-tenant-resolution-cleanup
plan: 03
type: execute
wave: 2
depends_on: ["49-01"]
files_modified:
  - apps/mcp/src/tools/create.ts
  - apps/mcp/src/tools/update-skill.ts
  - apps/mcp/src/tools/review-skill.ts
  - apps/mcp/src/tools/submit-for-review.ts
  - apps/mcp/src/tracking/events.ts
  - apps/web/app/api/mcp/[transport]/route.ts
  - apps/web/app/api/install-callback/route.ts
autonomous: true

must_haves:
  truths:
    - "MCP stdio tools derive tenantId strictly from getTenantId() with no DEFAULT_TENANT_ID fallback"
    - "MCP HTTP route derives tenantId from API key validation and passes it through trackUsage"
    - "install-callback route uses API key tenantId when available, keeps DEFAULT_TENANT_ID only for truly anonymous installs"
    - "MCP tracking (events.ts) uses getTenantId() strictly, skipping tracking if no tenant resolved"
  artifacts:
    - path: "apps/mcp/src/tools/create.ts"
      provides: "MCP create tool with strict tenant resolution"
      contains: "if (!tenantId)"
    - path: "apps/mcp/src/tracking/events.ts"
      provides: "MCP usage tracking with strict tenant resolution"
      contains: "getTenantId()"
    - path: "apps/web/app/api/mcp/[transport]/route.ts"
      provides: "HTTP MCP route with tenant from API key auth"
      contains: "tenantId"
  key_links:
    - from: "apps/mcp/src/tools/create.ts"
      to: "apps/mcp/src/auth.ts"
      via: "getTenantId()"
      pattern: "getTenantId\\(\\)"
    - from: "apps/web/app/api/mcp/[transport]/route.ts"
      to: "@everyskill/db/services/api-keys"
      via: "validateApiKey returns tenantId in extra"
      pattern: "tenantId.*result\\.tenantId"
---

<objective>
Replace DEFAULT_TENANT_ID in MCP tools, MCP tracking, HTTP MCP route, and install-callback route with strict tenant resolution.

Purpose: MCP tools and API routes use a different auth pattern (API key via getTenantId() instead of session.user.tenantId). This plan handles the non-session tenant resolution paths, ensuring MCP operations are properly tenant-scoped.

Output: All MCP and API route code paths resolve tenant from API key validation, not hardcoded constant.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/49-tenant-resolution-cleanup/49-RESEARCH.md (patterns: Example 3, Example 4)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace DEFAULT_TENANT_ID in MCP stdio tools and tracking</name>
  <files>apps/mcp/src/tools/create.ts, apps/mcp/src/tools/update-skill.ts, apps/mcp/src/tools/review-skill.ts, apps/mcp/src/tools/submit-for-review.ts, apps/mcp/src/tracking/events.ts</files>
  <action>
**MCP tool files (4 files: create.ts, update-skill.ts, review-skill.ts, submit-for-review.ts):**

Each file currently has a pattern like:
```typescript
import { DEFAULT_TENANT_ID } from "@everyskill/db";
const tenantId = getTenantId() || DEFAULT_TENANT_ID;
```

For EACH file:
1. **Remove** the `DEFAULT_TENANT_ID` import from `@everyskill/db` (keep other imports from same line like `db`, `sql`, etc.)
2. **Replace** the fallback pattern with a strict check:
   ```typescript
   const tenantId = getTenantId();
   if (!tenantId) {
     return {
       content: [{ type: "text" as const, text: JSON.stringify({
         error: "Tenant not resolved",
         message: "API key does not have a tenant association. Please re-generate your API key."
       })}],
       isError: true,
     };
   }
   ```
3. Make sure the error return is placed BEFORE any DB operations in the tool handler.

**File-specific notes:**
- **create.ts**: `getTenantId()` is called and used for skill insert + version insert + `trackUsage`. The error return should be at the top of the tool handler, before file parsing.
- **update-skill.ts**: Same pattern -- error return before DB update.
- **review-skill.ts**: Uses `tenantId` variable (may get from a different variable name) -- check exact variable name and apply same pattern.
- **submit-for-review.ts**: Same pattern as review-skill.ts.

**MCP tracking -- apps/mcp/src/tracking/events.ts:**

Currently (line 23):
```typescript
const tenantId = event.tenantId || getTenantId() || DEFAULT_TENANT_ID;
```

Change to:
```typescript
const tenantId = event.tenantId || getTenantId();
if (!tenantId) {
  console.warn("[tracking] Skipping usage tracking: no tenant resolved");
  return;
}
```

Also:
1. **Remove** the local `const DEFAULT_TENANT_ID = "default-tenant-000-0000-000000000000"` constant (line 8)
2. Usage tracking is non-critical (fire-and-forget), so silently skipping when no tenant is available is the correct behavior.
  </action>
  <verify>Run `cd /home/dev/projects/relay/apps/mcp && npx tsc --noEmit` to confirm no type errors. Run `grep -rn "DEFAULT_TENANT_ID" apps/mcp/src/` to confirm zero hits across all MCP source files.</verify>
  <done>All 4 MCP tool files return error when getTenantId() returns null. events.ts skips tracking when no tenant resolved. No DEFAULT_TENANT_ID references remain in apps/mcp/src/.</done>
</task>

<task type="auto">
  <name>Task 2: Replace DEFAULT_TENANT_ID in HTTP MCP route and install-callback</name>
  <files>apps/web/app/api/mcp/[transport]/route.ts, apps/web/app/api/install-callback/route.ts</files>
  <action>
**HTTP MCP route -- apps/web/app/api/mcp/[transport]/route.ts:**

1. **Remove** the local `const DEFAULT_TENANT_ID = "default-tenant-000-0000-000000000000"` (line 16)
2. **Update the auth handler** (line 451-465) to include `tenantId` in the extra object:
   ```typescript
   const authHandler = withMcpAuth(
     handler,
     async (_req: Request, bearerToken?: string) => {
       if (!bearerToken) return undefined;
       const result = await validateApiKey(bearerToken);
       if (!result) return undefined;
       return {
         token: bearerToken,
         clientId: result.keyId,
         scopes: [],
         extra: { userId: result.userId, tenantId: result.tenantId },
       };
     },
     { required: true }
   );
   ```
3. **Add a helper function** to extract tenantId from extra (alongside the existing `extractUserId`):
   ```typescript
   function extractTenantId(extra: {
     authInfo?: { extra?: Record<string, unknown> };
   }): string | undefined {
     return extra.authInfo?.extra?.tenantId as string | undefined;
   }
   ```
4. **Update the `trackUsage` function** (line 56-82) to accept and use tenantId:
   - Change the function signature to accept a `tenantId` field in the event parameter
   - Replace `tenantId: DEFAULT_TENANT_ID` (line 67) with the passed tenantId
   - Replace `tenantId: DEFAULT_TENANT_ID` in writeAuditLog (line 74) with the passed tenantId
   - If no tenantId is available, skip tracking (same pattern as events.ts): `if (!tenantId) return;`
5. **Update all `trackUsage` calls** in the tool handlers to pass tenantId:
   ```typescript
   const tenantId = extractTenantId(extra);
   // ... then pass in trackUsage call:
   await trackUsage({ tenantId, toolName: "list_skills", userId, metadata: { ... } });
   ```
   There are 5 trackUsage calls (list_skills, search_skills, deploy_skill, confirm_install, log_skill_usage). Each needs the tenantId extracted from extra and passed through.

**install-callback route -- apps/web/app/api/install-callback/route.ts:**

This route is special: it accepts anonymous requests (no API key). The research recommends keeping DEFAULT_TENANT_ID for truly anonymous installs as an "unattributed" bucket.

1. **Keep** the local `const DEFAULT_TENANT_ID` -- this is the ONE legitimate runtime use of the constant (anonymous install tracking)
2. **Add a comment** clarifying this is intentional:
   ```typescript
   // Anonymous installs (no API key) are tracked under the default tenant as "unattributed".
   // This is the only legitimate runtime use of DEFAULT_TENANT_ID -- all authenticated
   // code paths resolve tenant from session or API key.
   const DEFAULT_TENANT_ID = "default-tenant-000-0000-000000000000";
   ```
3. The existing logic (lines 39-52) already correctly resolves tenantId from API key when available and falls back to DEFAULT_TENANT_ID for anonymous -- this is correct behavior. No change needed to the logic, only the comment.
  </action>
  <verify>Run `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` to confirm no type errors. Run `grep -n "DEFAULT_TENANT_ID" "apps/web/app/api/mcp/[transport]/route.ts"` to confirm zero hits. Run `grep -c "DEFAULT_TENANT_ID" apps/web/app/api/install-callback/route.ts` to confirm exactly 2 hits (the const declaration and the usage on the `let tenantId` line).</verify>
  <done>HTTP MCP route derives tenantId from API key validation via extra.tenantId, no DEFAULT_TENANT_ID. install-callback keeps DEFAULT_TENANT_ID only for anonymous installs (documented as intentional). TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
- `cd /home/dev/projects/relay/apps/mcp && npx tsc --noEmit` passes
- `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` passes
- `grep -rn "DEFAULT_TENANT_ID" apps/mcp/src/` returns no results
- `grep -rn "DEFAULT_TENANT_ID" "apps/web/app/api/mcp/"` returns no results
- `grep -c "DEFAULT_TENANT_ID" apps/web/app/api/install-callback/route.ts` returns exactly 2 (const + usage, both documented as intentional anonymous fallback)
- Run full E2E test suite: `cd /home/dev/projects/relay/apps/web && npx playwright test` -- all tests pass
- Run MCP tests: `cd /home/dev/projects/relay/apps/mcp && npm test` -- all tests pass
</verification>

<success_criteria>
1. Zero DEFAULT_TENANT_ID references in apps/mcp/src/
2. Zero DEFAULT_TENANT_ID references in HTTP MCP route
3. install-callback has exactly one intentional DEFAULT_TENANT_ID for anonymous installs (documented)
4. HTTP MCP route passes tenantId from API key through to trackUsage and writeAuditLog
5. MCP tools return clear error when getTenantId() fails
6. All TypeScript compiles, E2E tests pass, MCP tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/49-tenant-resolution-cleanup/49-03-SUMMARY.md`
</output>
