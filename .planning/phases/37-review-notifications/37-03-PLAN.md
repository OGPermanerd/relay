---
phase: 37-review-notifications
plan: 03
type: execute
wave: 2
depends_on: ["37-01", "37-02"]
files_modified:
  - apps/web/app/actions/submit-for-review.ts
  - apps/web/app/actions/admin-reviews.ts
autonomous: true

must_haves:
  truths:
    - "When a skill is submitted and NOT auto-approved, all tenant admins receive a review_submitted notification (RVNT-01)"
    - "When a skill is auto-approved, the author receives a review_published notification instead of review_submitted (RVNT-05)"
    - "When an admin approves a skill, the author receives a review_published notification (RVNT-05 only, not double RVNT-02+05)"
    - "When an admin rejects a skill, the author receives a review_rejected notification with notes (RVNT-03)"
    - "When an admin requests changes, the author receives a review_changes_requested notification with notes (RVNT-04)"
    - "All notification dispatches happen AFTER DB transactions commit, not inside them"
  artifacts:
    - path: "apps/web/app/actions/submit-for-review.ts"
      provides: "RVNT-01 and RVNT-05 dispatch wiring"
      contains: "notifyReviewEvent"
    - path: "apps/web/app/actions/admin-reviews.ts"
      provides: "RVNT-02, RVNT-03, RVNT-04, RVNT-05 dispatch wiring"
      contains: "notifyReviewEvent"
  key_links:
    - from: "apps/web/app/actions/submit-for-review.ts"
      to: "apps/web/lib/notifications.ts"
      via: "import notifyReviewEvent"
      pattern: "notifyReviewEvent"
    - from: "apps/web/app/actions/admin-reviews.ts"
      to: "apps/web/lib/notifications.ts"
      via: "import notifyReviewEvent"
      pattern: "notifyReviewEvent"
    - from: "apps/web/app/actions/admin-reviews.ts"
      to: "@everyskill/db"
      via: "getAdminsInTenant import (not needed here -- only submit uses it)"
      pattern: "skill\\.authorId"
---

<objective>
Wire notifyReviewEvent dispatch calls into submit-for-review.ts and admin-reviews.ts server actions.

Purpose: This connects the dispatch infrastructure (Plan 02) to the actual review lifecycle events. Without this wiring, no notifications are sent.
Output: Notification dispatch calls in both server actions, covering RVNT-01 through RVNT-05.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire submit-for-review.ts (RVNT-01 + RVNT-05)</name>
  <files>apps/web/app/actions/submit-for-review.ts</files>
  <action>
Modify `apps/web/app/actions/submit-for-review.ts`:

1. Add imports at the top:
   ```typescript
   import { notifyReviewEvent } from "@/lib/notifications";
   import { getAdminsInTenant } from "@everyskill/db";
   import { users } from "@everyskill/db";
   ```
   Note: `db` and `eq` are already imported.

2. Expand the skill query columns (line ~26-35) to also fetch `slug` and `tenantId`:
   ```typescript
   columns: {
     id: true,
     status: true,
     name: true,
     description: true,
     content: true,
     category: true,
     slug: true,       // NEW: needed for notification actionUrl
   },
   ```
   Note: `tenantId` is available from `session.user.tenantId` so we don't need it from the skill query.

3. After the `revalidatePath("/my-skills");` line (line 107) and before `return { success: true, autoApproved };`, add notification dispatch:
   ```typescript
   // --- Notification dispatch (fire-and-forget, AFTER all DB work) ---
   const tenantId = session.user.tenantId!;
   if (autoApproved) {
     // RVNT-05: Notify author their skill was auto-published
     notifyReviewEvent({
       tenantId,
       recipientId: session.user.id,
       recipientEmail: session.user.email!,
       recipientName: session.user.name || "there",
       type: "review_published",
       skillName: skill.name,
       skillSlug: skill.slug ?? skillId,
     }).catch(() => {});
   } else {
     // RVNT-01: Notify all tenant admins that a skill needs review
     const admins = await getAdminsInTenant(tenantId);
     for (const admin of admins) {
       notifyReviewEvent({
         tenantId,
         recipientId: admin.id,
         recipientEmail: admin.email,
         recipientName: admin.name || "there",
         type: "review_submitted",
         skillName: skill.name,
         skillSlug: skill.slug ?? skillId,
         reviewerName: session.user.name || "A team member",
       }).catch(() => {});
     }
   }
   ```

Key decisions:
- Auto-approved: send ONLY RVNT-05 (published) to author, NOT RVNT-01 (no admin review needed)
- Not auto-approved: send RVNT-01 to ALL admins in tenant
- Fire-and-forget: `.catch(() => {})` -- never block the return
- tenantId from `session.user.tenantId` (available from JWT per Phase 26)
  </action>
  <verify>
    Run `pnpm --filter web exec tsc --noEmit` to confirm the modified action compiles.
  </verify>
  <done>submit-for-review.ts dispatches RVNT-01 to admins (when not auto-approved) and RVNT-05 to author (when auto-approved), all fire-and-forget after DB work.</done>
</task>

<task type="auto">
  <name>Task 2: Wire admin-reviews.ts (RVNT-02/03/04/05)</name>
  <files>apps/web/app/actions/admin-reviews.ts</files>
  <action>
Modify `apps/web/app/actions/admin-reviews.ts`:

1. Add imports at the top:
   ```typescript
   import { notifyReviewEvent } from "@/lib/notifications";
   import { users } from "@everyskill/db";
   ```
   Note: `db` and `eq` are already imported.

2. In ALL THREE actions (approveSkillAction, rejectSkillAction, requestChangesAction), expand the skill query columns to include `authorId`, `name`, and `slug`. Currently they select `{ id, status, tenantId, content }`. Change to:
   ```typescript
   columns: { id: true, status: true, tenantId: true, content: true, authorId: true, name: true, slug: true },
   ```
   This appears on line ~41 (approve), ~113 (reject), ~183 (requestChanges).

3. In `approveSkillAction`, AFTER the `await db.transaction(...)` block (line ~82) and BEFORE `revalidatePath`, add:
   ```typescript
   // Fetch author info for notification
   const author = await db.query.users.findFirst({
     where: eq(users.id, skill.authorId),
     columns: { id: true, email: true, name: true },
   });
   if (author) {
     // RVNT-05 only: author is notified of publication (approval is implicit)
     // Do NOT send separate RVNT-02 (approved) to avoid double notification
     notifyReviewEvent({
       tenantId: skill.tenantId,
       recipientId: author.id,
       recipientEmail: author.email,
       recipientName: author.name || "there",
       type: "review_published",
       skillName: skill.name,
       skillSlug: skill.slug ?? skillId,
       notes: notes || undefined,
       reviewerName: session.user.name || "Admin",
     }).catch(() => {});
   }
   ```

4. In `rejectSkillAction`, AFTER the `await db.transaction(...)` block (line ~152) and BEFORE `revalidatePath`, add:
   ```typescript
   // Fetch author info for notification
   const author = await db.query.users.findFirst({
     where: eq(users.id, skill.authorId),
     columns: { id: true, email: true, name: true },
   });
   if (author) {
     // RVNT-03: Notify author of rejection with reason
     notifyReviewEvent({
       tenantId: skill.tenantId,
       recipientId: author.id,
       recipientEmail: author.email,
       recipientName: author.name || "there",
       type: "review_rejected",
       skillName: skill.name,
       skillSlug: skill.slug ?? skillId,
       notes: notesResult.data,
       reviewerName: session.user.name || "Admin",
     }).catch(() => {});
   }
   ```

5. In `requestChangesAction`, AFTER the `await db.transaction(...)` block (line ~222) and BEFORE `revalidatePath`, add:
   ```typescript
   // Fetch author info for notification
   const author = await db.query.users.findFirst({
     where: eq(users.id, skill.authorId),
     columns: { id: true, email: true, name: true },
   });
   if (author) {
     // RVNT-04: Notify author that changes are requested
     notifyReviewEvent({
       tenantId: skill.tenantId,
       recipientId: author.id,
       recipientEmail: author.email,
       recipientName: author.name || "there",
       type: "review_changes_requested",
       skillName: skill.name,
       skillSlug: skill.slug ?? skillId,
       notes: notesResult.data,
       reviewerName: session.user.name || "Admin",
     }).catch(() => {});
   }
   ```

Key decisions:
- approveSkillAction sends ONLY review_published (not review_approved + review_published) to avoid double notification
- All dispatch happens AFTER the transaction, never inside it
- Author lookup is a separate query (not part of transaction)
- All dispatches are fire-and-forget with `.catch(() => {})`
- `notesResult.data` used for reject/changes_requested (the validated notes string)
  </action>
  <verify>
    Run `pnpm --filter web exec tsc --noEmit` to confirm all three actions compile with the new columns and dispatch calls.
  </verify>
  <done>All three admin review actions dispatch notifications to the skill author: RVNT-05 (approve/publish), RVNT-03 (reject), RVNT-04 (changes requested). All fire-and-forget, outside transactions.</done>
</task>

</tasks>

<verification>
- `pnpm --filter web exec tsc --noEmit` passes
- submit-for-review.ts imports and calls notifyReviewEvent
- admin-reviews.ts imports and calls notifyReviewEvent in all 3 actions
- All skill queries now select authorId, name, slug
- No notification dispatch inside any db.transaction() block
</verification>

<success_criteria>
All 5 review notification events (RVNT-01 through RVNT-05) are wired to their trigger points. Notifications fire after DB operations complete.
</success_criteria>

<output>
After completion, create `.planning/phases/37-review-notifications/37-03-SUMMARY.md`
</output>
