---
phase: 37-review-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/notification-preferences.ts
  - packages/db/src/services/notifications.ts
  - packages/db/src/services/notification-preferences.ts
  - packages/db/src/services/user.ts
  - packages/db/src/services/index.ts
  - packages/db/src/migrations/0016_add_review_notification_prefs.sql
autonomous: true

must_haves:
  truths:
    - "CreateNotificationParams type accepts review_submitted, review_approved, review_rejected, review_changes_requested, review_published"
    - "notification_preferences table has review_notifications_email and review_notifications_in_app columns defaulting to true"
    - "getAdminsInTenant returns only users with role=admin in the given tenant"
    - "updatePreferences accepts reviewNotificationsEmail and reviewNotificationsInApp fields"
  artifacts:
    - path: "packages/db/src/migrations/0016_add_review_notification_prefs.sql"
      provides: "Migration adding 2 boolean columns"
      contains: "review_notifications_email"
    - path: "packages/db/src/services/user.ts"
      provides: "getAdminsInTenant function"
      exports: ["getAdminsInTenant"]
  key_links:
    - from: "packages/db/src/schema/notification-preferences.ts"
      to: "packages/db/src/migrations/0016_add_review_notification_prefs.sql"
      via: "Schema columns match migration columns"
      pattern: "review_notifications_email"
    - from: "packages/db/src/services/index.ts"
      to: "packages/db/src/services/user.ts"
      via: "re-export"
      pattern: "getAdminsInTenant"
---

<objective>
Add review notification DB infrastructure: schema columns, migration, expanded type union, admin discovery query, and preference service updates.

Purpose: All downstream plans (dispatch, wiring, UI) depend on these DB-layer changes existing first.
Output: Migration file, updated schema, expanded service types, getAdminsInTenant function.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema, migration, and type union expansion</name>
  <files>
    packages/db/src/schema/notification-preferences.ts
    packages/db/src/services/notifications.ts
    packages/db/src/migrations/0016_add_review_notification_prefs.sql
  </files>
  <action>
1. In `packages/db/src/schema/notification-preferences.ts`, add two new columns to the `notificationPreferences` table definition, between the `platformUpdatesInApp` line and the `updatedAt` line:
   ```
   reviewNotificationsEmail: boolean("review_notifications_email").notNull().default(true),
   reviewNotificationsInApp: boolean("review_notifications_in_app").notNull().default(true),
   ```

2. Create migration file `packages/db/src/migrations/0016_add_review_notification_prefs.sql`:
   ```sql
   ALTER TABLE notification_preferences
     ADD COLUMN review_notifications_email boolean NOT NULL DEFAULT true;

   ALTER TABLE notification_preferences
     ADD COLUMN review_notifications_in_app boolean NOT NULL DEFAULT true;
   ```

3. In `packages/db/src/services/notifications.ts`, expand the `type` field in `CreateNotificationParams` interface to:
   ```typescript
   type: "grouping_proposal" | "trending_digest" | "platform_update"
       | "review_submitted" | "review_approved" | "review_rejected"
       | "review_changes_requested" | "review_published";
   ```

4. Run the migration: `cd /home/dev/projects/relay && pnpm --filter @everyskill/db exec drizzle-kit push`
  </action>
  <verify>
    Run `pnpm --filter @everyskill/db exec tsc --noEmit` to confirm schema types compile. Run a quick SQL check: `psql everyskill -c "SELECT column_name FROM information_schema.columns WHERE table_name='notification_preferences' AND column_name LIKE 'review%';"` should return 2 rows.
  </verify>
  <done>notification_preferences table has review_notifications_email and review_notifications_in_app columns. CreateNotificationParams accepts all 5 review notification types.</done>
</task>

<task type="auto">
  <name>Task 2: getAdminsInTenant and preference service expansion</name>
  <files>
    packages/db/src/services/user.ts
    packages/db/src/services/index.ts
    packages/db/src/services/notification-preferences.ts
  </files>
  <action>
1. In `packages/db/src/services/user.ts`, add a new function after `getUsersInTenant`:
   ```typescript
   /**
    * Get all admin users in a tenant.
    * Returns id, email, and name for notification dispatch.
    */
   export async function getAdminsInTenant(tenantId: string) {
     if (!db) return [];
     try {
       return await db
         .select({
           id: users.id,
           email: users.email,
           name: users.name,
         })
         .from(users)
         .where(and(eq(users.tenantId, tenantId), eq(users.role, "admin")));
     } catch {
       return [];
     }
   }
   ```
   Import `and` from `drizzle-orm` (already imported as `asc` exists -- add `and` to the import).

2. In `packages/db/src/services/index.ts`, update the user.ts export line from:
   ```
   export { isFirstUserInTenant, getUserRole, setUserRole, getUsersInTenant } from "./user";
   ```
   to:
   ```
   export { isFirstUserInTenant, getUserRole, setUserRole, getUsersInTenant, getAdminsInTenant } from "./user";
   ```

3. In `packages/db/src/services/notification-preferences.ts`, expand the `updatePreferences` function's `updates` parameter type to include:
   ```typescript
   updates: Partial<{
     groupingProposalEmail: boolean;
     groupingProposalInApp: boolean;
     trendingDigest: "none" | "daily" | "weekly";
     platformUpdatesEmail: boolean;
     platformUpdatesInApp: boolean;
     reviewNotificationsEmail: boolean;
     reviewNotificationsInApp: boolean;
   }>
   ```
  </action>
  <verify>
    Run `pnpm --filter @everyskill/db exec tsc --noEmit` to confirm all types compile. Check the export: `grep "getAdminsInTenant" packages/db/src/services/index.ts` should match.
  </verify>
  <done>getAdminsInTenant function exists and is exported. updatePreferences accepts reviewNotificationsEmail and reviewNotificationsInApp fields.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @everyskill/db exec tsc --noEmit` passes
- Migration 0016 exists and has been applied
- Schema columns match migration columns
- Type union includes all 5 review types
- getAdminsInTenant is exported from @everyskill/db
</verification>

<success_criteria>
All DB-layer changes for review notifications are in place: schema, migration applied, expanded types, admin query, preference service expanded.
</success_criteria>

<output>
After completion, create `.planning/phases/37-review-notifications/37-01-SUMMARY.md`
</output>
