---
phase: 64-ip-valuation-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/ip-valuation.ts
  - apps/web/lib/ip-dashboard-queries.ts
  - apps/web/app/actions/export-ip-report.ts
autonomous: true

must_haves:
  truths:
    - "Replacement cost formula produces a positive number from usage, hours, content length, and rating inputs"
    - "SQL query returns per-skill valuation ingredients (total_uses, hours_saved, content_length, average_rating, author, risk_level) for all published skills in a tenant"
    - "Server action fetches all data needed for PDF/CSV export in a single call (stats, skills, risk, trends)"
  artifacts:
    - path: "apps/web/lib/ip-valuation.ts"
      provides: "Replacement cost formula, types, constants"
      exports: ["calculateReplacementCost", "HOURLY_RATE", "SkillValuation", "IpReportData"]
    - path: "apps/web/lib/ip-dashboard-queries.ts"
      provides: "getSkillValuationData query"
      exports: ["getSkillValuationData", "SkillValuationRow"]
    - path: "apps/web/app/actions/export-ip-report.ts"
      provides: "Server action fetching all export data"
      exports: ["fetchIpReportData"]
  key_links:
    - from: "apps/web/app/actions/export-ip-report.ts"
      to: "apps/web/lib/ip-dashboard-queries.ts"
      via: "imports getIpDashboardStats, getSkillValuationData, getIpRiskEmployees, getAtRiskSkillAlerts, getQualityTrends"
      pattern: "import.*from.*ip-dashboard-queries"
    - from: "apps/web/app/actions/export-ip-report.ts"
      to: "auth"
      via: "session check + admin guard"
      pattern: "auth\\(\\).*isAdmin"
---

<objective>
Add the replacement cost formula, SQL query for skill valuation data, and a server action that fetches all data needed for IP report export.

Purpose: Provide the data layer that the UI (Plan 02) will consume to display replacement costs and generate PDF/CSV exports.
Output: Three files — ip-valuation.ts (formula + types), extended ip-dashboard-queries.ts (new query), export-ip-report.ts (server action)
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@apps/web/lib/ip-dashboard-queries.ts
@apps/web/components/csv-export-button.tsx
@apps/web/app/actions/export-analytics.ts
@.planning/phases/64-ip-valuation-export/64-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create replacement cost formula and types</name>
  <files>apps/web/lib/ip-valuation.ts</files>
  <action>
Create a NEW file `apps/web/lib/ip-valuation.ts` with:

1. **Constants:**
   - `HOURLY_RATE = 150` — knowledge worker hourly rate

2. **Types:**
   - `SkillValuationRow` — raw data from SQL: skillId, name, slug, category, authorName, authorEmail, totalUses, hoursSaved, contentLength, averageRating (number|null), riskLevel ("critical"|"high"|null)
   - `SkillValuation` — extends SkillValuationRow with computed `replacementCost: number`
   - `IpReportData` — the full report payload: { totalValue: number, stats: IpDashboardStats, skills: SkillValuation[], riskEmployees: IpRiskEmployee[], riskAlerts: AtRiskSkillAlert[], trends: QualityTrendPoint[] }
   - Import the referenced types from `@/lib/ip-dashboard-queries` as TYPE-ONLY imports (they are erased at build time, so safe from "use client" modules)

3. **Formula function:**
   ```typescript
   export function calculateReplacementCost(
     totalUses: number,
     hoursSaved: number,
     contentLength: number,
     averageRating: number | null,
   ): number
   ```
   - Base value = hoursSaved * totalUses * HOURLY_RATE
   - Complexity multiplier = 1 + Math.log10(Math.max(contentLength, 1000) / 1000), clamped to [1.0, 2.0]
   - Quality: normalize averageRating (stored as rating*100, range 0-500) to 0-1; null defaults to 0.6
   - Quality multiplier = 0.5 + (normalizedQuality * 0.5), range [0.5, 1.0]
   - Return Math.round(baseValue * complexityMultiplier * qualityMultiplier)

4. **Helper function:**
   ```typescript
   export function computeSkillValuations(rows: SkillValuationRow[]): SkillValuation[]
   ```
   Maps each row to include the computed replacementCost.

5. **Currency formatting helper (hydration-safe):**
   ```typescript
   export function formatCurrency(value: number): string
   ```
   Returns value with 2 decimal places and comma separators using manual regex (NOT toLocaleString). Example: `1234567.89` -> `"1,234,567.89"`.

This file is NOT "use server" and NOT "use client" — it's a pure utility module importable from both.
  </action>
  <verify>
Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30` — no errors related to ip-valuation.ts.
  </verify>
  <done>ip-valuation.ts exports calculateReplacementCost, computeSkillValuations, formatCurrency, HOURLY_RATE, and all types. Formula handles null ratings, clamps multipliers correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Add skill valuation SQL query and server action</name>
  <files>
    apps/web/lib/ip-dashboard-queries.ts
    apps/web/app/actions/export-ip-report.ts
  </files>
  <action>
**Part A: Add `getSkillValuationData()` to ip-dashboard-queries.ts**

Add a new exported async function at the bottom of the file (after `getEmployeeAtRiskSkills`):

```typescript
export async function getSkillValuationData(tenantId: string): Promise<SkillValuationRow[]>
```

Import `SkillValuationRow` from `@/lib/ip-valuation` (type-only import).

SQL query:
```sql
SELECT
  s.id AS skill_id,
  s.name,
  s.slug,
  s.category,
  s.total_uses,
  COALESCE(s.hours_saved, 1) AS hours_saved,
  LENGTH(s.content) AS content_length,
  s.average_rating,
  u.name AS author_name,
  COALESCE(u.email, '') AS author_email,
  CASE
    WHEN s.total_uses >= {CRITICAL_USAGE_THRESHOLD} AND NOT EXISTS (
      SELECT 1 FROM skills fork WHERE fork.forked_from_id = s.id AND fork.status = 'published' AND fork.tenant_id = s.tenant_id
    ) THEN 'critical'
    WHEN s.total_uses >= {HIGH_USAGE_THRESHOLD} AND NOT EXISTS (
      SELECT 1 FROM skills fork WHERE fork.forked_from_id = s.id AND fork.status = 'published' AND fork.tenant_id = s.tenant_id
    ) THEN 'high'
    ELSE NULL
  END AS risk_level
FROM skills s
LEFT JOIN users u ON u.id = s.author_id
WHERE s.tenant_id = ${tenantId}
  AND s.status = 'published'
ORDER BY s.total_uses DESC
```

Use the existing `HIGH_USAGE_THRESHOLD` and `CRITICAL_USAGE_THRESHOLD` constants (already in the file). Map rows to `SkillValuationRow[]` following the same casting pattern as existing functions.

If `!db` return empty array (same guard as existing functions).

**Part B: Create server action `export-ip-report.ts`**

Create NEW file `apps/web/app/actions/export-ip-report.ts` with `"use server"` directive.

```typescript
"use server";

import { auth } from "@/auth";
import { isAdmin } from "@/lib/admin";
import {
  getIpDashboardStats,
  getSkillValuationData,
  getIpRiskEmployees,
  getAtRiskSkillAlerts,
  getQualityTrends,
} from "@/lib/ip-dashboard-queries";
import { computeSkillValuations } from "@/lib/ip-valuation";
import type { IpReportData } from "@/lib/ip-valuation";

export async function fetchIpReportData(): Promise<IpReportData> {
  const session = await auth();
  if (!session?.user?.id) throw new Error("Unauthorized");
  if (!isAdmin(session)) throw new Error("Forbidden");
  const tenantId = session.user.tenantId;
  if (!tenantId) throw new Error("Unauthorized");

  const [stats, rawSkills, riskEmployees, riskAlerts, trends] = await Promise.all([
    getIpDashboardStats(tenantId),
    getSkillValuationData(tenantId),
    getIpRiskEmployees(tenantId),
    getAtRiskSkillAlerts(tenantId),
    getQualityTrends(tenantId, new Date(Date.now() - 365 * 24 * 60 * 60 * 1000)),
  ]);

  const skills = computeSkillValuations(rawSkills);
  const totalValue = skills.reduce((sum, s) => sum + s.replacementCost, 0);

  return { totalValue, stats, skills, riskEmployees, riskAlerts, trends };
}
```

The trends fetch uses 1-year lookback (same as the dashboard default for quality trends in the export context).
  </action>
  <verify>
Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30` — no type errors.
Run `cd /home/dev/projects/relay && pnpm build --filter @everyskill/web 2>&1 | tail -20` — build succeeds.
  </verify>
  <done>getSkillValuationData returns raw skill data with content_length and risk_level for all published skills. fetchIpReportData server action returns complete IpReportData payload with computed replacement costs and total IP value.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit --project apps/web/tsconfig.json` passes with no errors
2. `pnpm build --filter @everyskill/web` succeeds
3. ip-valuation.ts exports: calculateReplacementCost, computeSkillValuations, formatCurrency, HOURLY_RATE, SkillValuationRow, SkillValuation, IpReportData
4. ip-dashboard-queries.ts exports: getSkillValuationData (in addition to all existing exports)
5. export-ip-report.ts exports: fetchIpReportData
</verification>

<success_criteria>
- Replacement cost formula is implemented and handles edge cases (null rating, zero content length, zero uses)
- SQL query returns all published skills with valuation ingredients
- Server action fetches complete export data with auth + admin guards
- All existing exports and functionality in ip-dashboard-queries.ts are unchanged
- Build passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/64-ip-valuation-export/64-01-SUMMARY.md`
</output>
