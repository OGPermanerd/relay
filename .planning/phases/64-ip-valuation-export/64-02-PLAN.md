---
phase: 64-ip-valuation-export
plan: 02
type: execute
wave: 2
depends_on: ["64-01"]
files_modified:
  - apps/web/app/(protected)/leverage/ip-dashboard/page.tsx
  - apps/web/components/ip-dashboard-view.tsx
  - apps/web/components/ip-valuation-table.tsx
  - apps/web/components/ip-export-buttons.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees total estimated IP value as a hero stat card on the IP dashboard"
    - "Admin sees a table of high-value skills with individual replacement cost estimates"
    - "Admin can click Export PDF and download a PDF IP Report with executive summary, top skills, risk assessment, quality trends, and contributor highlights"
    - "Admin can click Export CSV and download a CSV with all skill-level IP data (name, author, uses, hours saved, replacement cost, risk level)"
  artifacts:
    - path: "apps/web/components/ip-valuation-table.tsx"
      provides: "Table of skills with replacement cost column"
      contains: "replacementCost"
    - path: "apps/web/components/ip-export-buttons.tsx"
      provides: "PDF and CSV export buttons with dynamic jsPDF import"
      contains: "import.*jspdf"
    - path: "apps/web/components/ip-dashboard-view.tsx"
      provides: "Updated dashboard with total IP value hero stat and export buttons"
      contains: "totalIpValue"
    - path: "apps/web/app/(protected)/leverage/ip-dashboard/page.tsx"
      provides: "Updated page fetching valuation data"
      contains: "getSkillValuationData"
  key_links:
    - from: "apps/web/components/ip-export-buttons.tsx"
      to: "apps/web/app/actions/export-ip-report.ts"
      via: "fetchIpReportData server action call"
      pattern: "fetchIpReportData"
    - from: "apps/web/components/ip-export-buttons.tsx"
      to: "jspdf"
      via: "dynamic import in click handler"
      pattern: "await import.*jspdf"
    - from: "apps/web/app/(protected)/leverage/ip-dashboard/page.tsx"
      to: "apps/web/lib/ip-dashboard-queries.ts"
      via: "getSkillValuationData import"
      pattern: "getSkillValuationData"
    - from: "apps/web/components/ip-dashboard-view.tsx"
      to: "apps/web/components/ip-valuation-table.tsx"
      via: "component composition"
      pattern: "<IpValuationTable"
---

<objective>
Add the IP valuation UI: total IP value hero stat, skill valuation table, and PDF/CSV export buttons to the IP dashboard.

Purpose: Admins can see per-skill replacement costs and export complete IP reports for board presentations.
Output: Updated dashboard page with hero stat, valuation table, and working PDF + CSV export downloads.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@apps/web/components/ip-dashboard-view.tsx
@apps/web/components/ip-risk-section.tsx
@apps/web/components/csv-export-button.tsx
@apps/web/app/(protected)/leverage/ip-dashboard/page.tsx
@.planning/phases/64-ip-valuation-export/64-RESEARCH.md
@.planning/phases/64-ip-valuation-export/64-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install jsPDF dependencies and create valuation table + export buttons components</name>
  <files>
    apps/web/components/ip-valuation-table.tsx
    apps/web/components/ip-export-buttons.tsx
  </files>
  <action>
**Step 0: Install jsPDF**
```bash
cd /home/dev/projects/relay/apps/web && pnpm add jspdf jspdf-autotable
```

**Step 1: Create `ip-valuation-table.tsx`**

A "use client" component displaying a table of skills sorted by replacement cost descending.

Props: `{ skills: SkillValuation[] }` — import `SkillValuation` type from `@/lib/ip-valuation` (type-only, safe).

Table columns:
- Skill Name (link to `/skills/{slug}`)
- Author
- Category
- Total Uses
- Hours Saved (totalUses * hoursSaved)
- Est. Replacement Cost (formatted with `$` and commas)
- Risk Level (badge: critical=red, high=amber, none=gray dash)

Show top 20 skills by replacement cost (slice on client after sorting). Below the table, show a muted text: "Showing top 20 of {total} skills. Export CSV for complete data."

Format currency using inline manual regex formatter (NOT toLocaleString):
```typescript
function formatCurrency(value: number): string {
  return value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
```

Use Tailwind table styles matching the existing `ip-risk-section.tsx` table styling (border-collapse, hover:bg-gray-50, text-sm, etc.).

**Step 2: Create `ip-export-buttons.tsx`**

A "use client" component with two buttons: "Export PDF" and "Export CSV".

Props: none (fetches data via server action on click).

Import `fetchIpReportData` from `@/app/actions/export-ip-report`.

**CSV Export handler:**
1. Call `fetchIpReportData()` to get data
2. Build CSV with headers: Skill Name, Author, Category, Total Uses, Hours Saved/Use, Total Hours Saved, Replacement Cost, Risk Level, Average Rating
3. Include ALL skills (not just top 20)
4. Use inline `escapeCSV()` helper (same implementation as csv-export-button.tsx)
5. Blob download with filename `ip-report-YYYY-MM-DD.csv`

**PDF Export handler:**
1. Call `fetchIpReportData()` to get data
2. Dynamic import jsPDF: `const { default: jsPDF } = await import("jspdf")`
3. Dynamic import autoTable: `const { default: autoTable } = await import("jspdf-autotable")`
4. Build PDF with these sections:
   - **Title:** "IP Report — EverySkill" (fontSize 20) + generation date (fontSize 10, gray)
   - **Executive Summary** (fontSize 14 heading):
     - Total Estimated IP Value: ${totalValue} (formatted with commas)
     - Skills Captured: {count}
     - Total Uses: {count}
     - Hours Saved: {hours}
     - Active Contributors: {count}
   - **Top Skills by Estimated Value** (autoTable):
     - head: ["Skill", "Author", "Uses", "Hrs Saved", "Est. Value", "Risk"]
     - body: top 20 skills by replacementCost
     - headStyles: { fillColor: [11, 22, 36] } (matching header brand color)
     - styles: { fontSize: 9 }
   - **Risk Assessment** (new page if needed):
     - "At-Risk Skills" count from riskAlerts
     - "Employees with Concentrated IP" count from riskEmployees
     - autoTable of top 10 at-risk skills: ["Skill", "Author", "Uses", "Risk Level"]
   - **Quality Trends** (autoTable):
     - head: ["Month", "Avg Rating", "Sentiment %", "Benchmark"]
     - body: trends data (show "--" for null values)
   - **Contributor Highlights** (autoTable):
     - head: ["Name", "Email", "At-Risk Skills", "Total At-Risk Uses"]
     - body: top 10 risk employees
5. Blob download with filename `ip-report-YYYY-MM-DD.pdf`

Both buttons show loading spinner while exporting (same pattern as CsvExportButton). Use `useState` for `isExportingPdf` and `isExportingCsv` separately.

Button styling: match existing CsvExportButton style (border, shadow-sm, hover:bg-gray-50). Add download icon SVG (same as CsvExportButton).

**CRITICAL: Constants must be inlined.** Do NOT import HOURLY_RATE from ip-valuation.ts at runtime in this "use client" component — the formula is already computed server-side in the server action. The export buttons just display pre-computed values.

Format currency values with inline helper (same regex as valuation table).
  </action>
  <verify>
Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30` — no type errors.
Verify jspdf is installed: `ls /home/dev/projects/relay/apps/web/node_modules/jspdf/package.json`
  </verify>
  <done>ip-valuation-table.tsx renders top 20 skills with replacement cost. ip-export-buttons.tsx has working PDF and CSV export with dynamic jsPDF import, server action data fetch, and blob download.</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard page and view to include valuation data, hero stat, and exports</name>
  <files>
    apps/web/app/(protected)/leverage/ip-dashboard/page.tsx
    apps/web/components/ip-dashboard-view.tsx
  </files>
  <action>
**Part A: Update page.tsx**

1. Add import for `getSkillValuationData` from `@/lib/ip-dashboard-queries`
2. Add import for `computeSkillValuations` from `@/lib/ip-valuation`
3. Add `getSkillValuationData(tenantId)` to the existing `Promise.all` call
4. Compute valuations: `const skills = computeSkillValuations(rawSkills)`
5. Compute total IP value: `const totalIpValue = skills.reduce((sum, s) => sum + s.replacementCost, 0)`
6. Pass `totalIpValue` and `skills` as new props to `<IpDashboardView>`

The updated Promise.all should be:
```typescript
const [stats, trendData, riskEmployees, atRiskAlerts, rawSkills] = await Promise.all([
  getIpDashboardStats(tenantId),
  getQualityTrends(tenantId, startDate),
  getIpRiskEmployees(tenantId),
  getAtRiskSkillAlerts(tenantId),
  getSkillValuationData(tenantId),
]);
const skills = computeSkillValuations(rawSkills);
const totalIpValue = skills.reduce((sum, s) => sum + s.replacementCost, 0);
```

**Part B: Update ip-dashboard-view.tsx**

1. Add imports for `IpValuationTable` and `IpExportButtons`
2. Import `SkillValuation` type from `@/lib/ip-valuation` (type-only)
3. Update `IpDashboardViewProps` to add: `totalIpValue: number`, `skills: SkillValuation[]`
4. Add a new hero stat card for "Total IP Value" — positioned FIRST in the grid (most important stat):
   - Label: "Estimated IP Value"
   - Value: formatted as `$X,XXX,XXX` using inline manual regex formatter (same formatNumber pattern but with $ prefix and no decimals)
   - Icon: a dollar/currency SVG icon (create inline like existing icons)
   - This makes the grid 5 cards; on lg use `lg:grid-cols-5` instead of `lg:grid-cols-4`
5. Add export buttons section between the hero stats and the risk section:
   ```tsx
   <div className="flex items-center justify-between">
     <h3 className="text-sm font-medium text-gray-500">IP Valuation</h3>
     <IpExportButtons />
   </div>
   ```
6. Add the valuation table after the export buttons header:
   ```tsx
   <IpValuationTable skills={skills} />
   ```
7. Section order should be:
   - Hero stat cards (5 cards including IP Value)
   - IP Valuation header with export buttons + valuation table
   - IP Risk Section (existing)
   - Quality Trends Chart (existing)
  </action>
  <verify>
Run `cd /home/dev/projects/relay && pnpm build --filter @everyskill/web 2>&1 | tail -20` — build succeeds.
Run Playwright tests: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/ip-dashboard.spec.ts 2>&1 | tail -20` — if test exists, it passes. If no test exists, note the gap.
Start dev server and verify page loads: `curl -s http://localhost:2002/leverage/ip-dashboard | head -5` shows HTML (not error).
  </verify>
  <done>IP dashboard shows "Estimated IP Value" hero stat, skill valuation table with top 20 skills and replacement costs, and working PDF/CSV export buttons. Existing dashboard functionality (stats, risk, trends) is unchanged.</done>
</task>

</tasks>

<verification>
1. `pnpm build --filter @everyskill/web` succeeds with no errors
2. IP dashboard page loads at `/leverage/ip-dashboard` for admin users
3. "Estimated IP Value" hero stat card shows a dollar-formatted total
4. Skill valuation table shows top 20 skills with replacement cost column
5. "Export PDF" button downloads a PDF file with executive summary, top skills table, risk assessment, quality trends, and contributor highlights
6. "Export CSV" button downloads a CSV file with ALL skills (not just top 20) and all IP data columns
7. PDF uses dynamic import (not in main bundle) — verify build output for ip-dashboard page bundle size < 300KB
8. All existing dashboard features (stats, risk section, quality trends) still work
9. No hydration mismatches (no toLocaleString usage)
</verification>

<success_criteria>
- Total IP value hero stat displays formatted dollar amount on the IP dashboard
- Valuation table shows top 20 skills by replacement cost with name, author, uses, hours, cost, risk
- PDF export contains all required sections: executive summary, top skills, risk, trends, contributors
- CSV export contains all skills with all IP data columns
- jsPDF dynamically imported (not in page bundle)
- No hydration mismatches
- Build passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/64-ip-valuation-export/64-02-SUMMARY.md`
</output>
