---
phase: 74-adaptive-query-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/search-queries.ts
  - packages/db/src/migrations/0042_add_route_type.sql
  - packages/db/src/migrations/meta/_journal.json
  - apps/web/lib/query-classifier.ts
  - apps/web/lib/search-router.ts
autonomous: true

must_haves:
  truths:
    - "classifyQuery returns keyword for 1-2 word queries without question words"
    - "classifyQuery returns semantic for question-patterned queries"
    - "classifyQuery returns hybrid for 3+ word natural language queries"
    - "classifyQuery returns browse for empty queries"
    - "routeSearch dispatches to the correct backend based on classification"
    - "Keyword route falls back to hybrid when zero results returned"
    - "search_queries table has route_type column with NOT NULL constraint"
  artifacts:
    - path: "apps/web/lib/query-classifier.ts"
      provides: "Pure-function query classifier"
      exports: ["classifyQuery", "RouteType", "ClassificationResult"]
    - path: "apps/web/lib/search-router.ts"
      provides: "Search dispatcher with fallback logic"
      exports: ["routeSearch", "RouteResult"]
    - path: "packages/db/src/migrations/0042_add_route_type.sql"
      provides: "Migration adding route_type column"
    - path: "packages/db/src/schema/search-queries.ts"
      provides: "Updated schema with routeType field"
  key_links:
    - from: "apps/web/lib/search-router.ts"
      to: "apps/web/lib/query-classifier.ts"
      via: "import classifyQuery"
      pattern: "classifyQuery"
    - from: "apps/web/lib/search-router.ts"
      to: "@everyskill/db hybrid-search"
      via: "import hybridSearchSkills, keywordSearchSkills"
      pattern: "(hybrid|keyword)SearchSkills"
---

<objective>
Create the query classification and routing foundation: a pure-function classifier, a search router with fallback logic, and a schema migration for route type tracking.

Purpose: Establish the infrastructure that search entry points will use to dispatch queries to the optimal retrieval strategy (ROUTE-01, ROUTE-02, ROUTE-04).
Output: query-classifier.ts, search-router.ts, migration 0042, updated search-queries schema.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/lib/search-skills.ts
@packages/db/src/services/hybrid-search.ts
@packages/db/src/schema/search-queries.ts
@packages/db/src/services/search-analytics.ts
@apps/web/lib/ollama.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration + classifier + router</name>
  <files>
    packages/db/src/schema/search-queries.ts
    packages/db/src/migrations/0042_add_route_type.sql
    packages/db/src/migrations/meta/_journal.json
    apps/web/lib/query-classifier.ts
    apps/web/lib/search-router.ts
    packages/db/src/services/search-analytics.ts
  </files>
  <action>
    1. Create migration `packages/db/src/migrations/0042_add_route_type.sql`:
       - `ALTER TABLE search_queries ADD COLUMN route_type text;`
       - `UPDATE search_queries SET route_type = 'hybrid' WHERE route_type IS NULL;`
       - `ALTER TABLE search_queries ALTER COLUMN route_type SET NOT NULL;`
       - `ALTER TABLE search_queries ALTER COLUMN route_type SET DEFAULT 'hybrid';`
       - `CREATE INDEX search_queries_route_type_idx ON search_queries (route_type);`
       - Update the `_journal.json` meta file with entry for 0042.

    2. Update `packages/db/src/schema/search-queries.ts`:
       - Add `routeType: text("route_type").notNull().default("hybrid")` field to the table definition.

    3. Update `packages/db/src/services/search-analytics.ts`:
       - Add `routeType?: string` to the `SearchQueryEntry` interface (optional for backward compat with MCP).
       - In `logSearchQuery`, include `routeType` in the insert when present (spread or conditional).
       - Add exported function `getRouteTypeBreakdown(tenantId: string, since: Date)` that returns `{ routeType: string; count: number; avgResults: number }[]` grouped by route_type, using the pattern from existing analytics queries.

    4. Create `apps/web/lib/query-classifier.ts`:
       - Export `type RouteType = "keyword" | "semantic" | "hybrid" | "browse"`.
       - Export `interface ClassificationResult { routeType: RouteType; confidence: number; reason: string; }`.
       - Export `function classifyQuery(query: string): ClassificationResult` implementing rules from research:
         - Empty/whitespace => browse (confidence 1.0)
         - 1 word => keyword (0.95)
         - 2 words, no question word => keyword (0.85)
         - Has question word (how/what/why/when/where/which/can/does/is/are/should) or ends with "?" => semantic (0.8)
         - 3+ words with NL markers (for/to/with/in/a/the/that/and/or/of) => hybrid (0.8)
         - 3 words or fewer, no NL markers => keyword (0.7)
         - Default (4+ words, no NL markers) => hybrid (0.6)
       - This is a pure function with zero dependencies.

    5. Create `apps/web/lib/search-router.ts`:
       - Export `interface RouteResult<T> { results: T[]; routeType: RouteType; fellBack: boolean; classificationReason: string; }`.
       - Export `async function routeSearch(query, params)` that:
         a. Calls `classifyQuery(query)` to get the route.
         b. Checks `getSiteSettings()?.semanticSimilarityEnabled` — if disabled, downgrades "semantic" and "hybrid" routes to "keyword" (Pitfall 4).
         c. For "browse": delegates to existing browse behavior (return empty results array — caller handles browse).
         d. For "keyword": calls `keywordSearchSkills({ query, userId, limit })`. If zero results, generates embedding via `generateEmbedding()` and falls back to `hybridSearchSkills()`. Sets `fellBack = true`. This satisfies ROUTE-04.
         e. For "semantic": generates embedding, calls `semanticSearchSkills()`. If zero results, falls back to hybrid (embedding already computed — no double generation per Pitfall 2).
         f. For "hybrid": generates embedding, calls `hybridSearchSkills()`.
         g. Returns `RouteResult` with the actual route used (not classified route, if fallback occurred).
       - Import from `@everyskill/db` for `hybridSearchSkills`, `keywordSearchSkills`, `semanticSearchSkills`, `getSiteSettings`.
       - Import `generateEmbedding` from `@/lib/ollama`.
       - The router handles embedding generation centrally to avoid double-generation (Pitfall 2).
       - Keep `searchSkills()` in search-skills.ts untouched for now — Plan 02 will wire callers.

    6. Run migration: `cd /home/dev/projects/relay && pnpm db:migrate`

    7. Run typecheck: `cd /home/dev/projects/relay && pnpm turbo typecheck`
  </action>
  <verify>
    - `pnpm db:migrate` completes without errors
    - `pnpm turbo typecheck` passes
    - `psql` confirms: `\d search_queries` shows `route_type text NOT NULL DEFAULT 'hybrid'` column
    - `SELECT DISTINCT route_type FROM search_queries;` returns `hybrid` (all backfilled)
  </verify>
  <done>
    - query-classifier.ts exports classifyQuery as a pure function with all 7 rules
    - search-router.ts exports routeSearch with keyword fallback logic (ROUTE-04)
    - Migration 0042 applied: route_type column exists, backfilled, indexed
    - Schema and analytics service updated to accept routeType
    - Typecheck passes
  </done>
</task>

</tasks>

<verification>
- Migration 0042 applied successfully
- `pnpm turbo typecheck` passes with no errors
- query-classifier.ts is a pure function with no external dependencies
- search-router.ts correctly composes existing search backends without modifying them
</verification>

<success_criteria>
- The route_type column exists in search_queries with NOT NULL constraint and hybrid default
- classifyQuery correctly categorizes: "excel" => keyword, "how to automate email" => semantic, "" => browse, "automate invoice processing workflow" => hybrid
- routeSearch dispatches to correct backend and falls back from keyword to hybrid on zero results
- All existing code continues to typecheck (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/74-adaptive-query-routing/74-01-SUMMARY.md`
</output>
