---
phase: 74-adaptive-query-routing
plan: 03
type: execute
wave: 2
depends_on: ["74-01"]
files_modified:
  - packages/db/src/services/index.ts
  - apps/web/app/(protected)/admin/search/page.tsx
  - apps/web/components/admin-search-table.tsx
autonomous: true

must_haves:
  truths:
    - "Admin search analytics page shows route type breakdown with counts and average results"
    - "Route type breakdown is visible as a row of summary cards or a table section"
    - "getRouteTypeBreakdown is exported from @everyskill/db barrel"
  artifacts:
    - path: "apps/web/app/(protected)/admin/search/page.tsx"
      provides: "Admin page with route type breakdown section"
      contains: "routeTypeBreakdown|getRouteTypeBreakdown"
    - path: "apps/web/components/admin-search-table.tsx"
      provides: "Updated component with route breakdown tab or section"
      contains: "routeType|Route"
    - path: "packages/db/src/services/index.ts"
      provides: "Barrel export for getRouteTypeBreakdown"
      contains: "getRouteTypeBreakdown"
  key_links:
    - from: "apps/web/app/(protected)/admin/search/page.tsx"
      to: "@everyskill/db getRouteTypeBreakdown"
      via: "import and call"
      pattern: "getRouteTypeBreakdown"
    - from: "apps/web/app/(protected)/admin/search/page.tsx"
      to: "apps/web/components/admin-search-table.tsx"
      via: "routeBreakdown prop"
      pattern: "routeBreakdown"
---

<objective>
Add route type analytics to the admin search dashboard so admins can see how queries are being classified and which retrieval strategies are used.

Purpose: Deliver ROUTE-03 visibility — admins can observe the route type distribution in the search analytics dashboard.
Output: Updated admin search page and table component showing route type breakdown.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/74-adaptive-query-routing/74-01-SUMMARY.md
@apps/web/app/(protected)/admin/search/page.tsx
@apps/web/components/admin-search-table.tsx
@packages/db/src/services/search-analytics.ts
@packages/db/src/services/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add route breakdown to barrel exports</name>
  <files>packages/db/src/services/index.ts</files>
  <action>
    Add `getRouteTypeBreakdown` to the existing search-analytics export line in `packages/db/src/services/index.ts`:
    ```typescript
    export {
      logSearchQuery,
      getSearchSummaryStats,
      getTopQueries,
      getZeroResultQueries,
      getTrendingQueries,
      getRouteTypeBreakdown,
      type SearchQueryEntry,
    } from "./search-analytics";
    ```
    (The function itself was created in Plan 01 Task 1.)
  </action>
  <verify>`pnpm turbo typecheck` passes</verify>
  <done>getRouteTypeBreakdown is importable from @everyskill/db</done>
</task>

<task type="auto">
  <name>Task 2: Display route type breakdown in admin dashboard</name>
  <files>
    apps/web/app/(protected)/admin/search/page.tsx
    apps/web/components/admin-search-table.tsx
  </files>
  <action>
    **Admin Search Page (`apps/web/app/(protected)/admin/search/page.tsx`):**

    1. Import `getRouteTypeBreakdown` from `@everyskill/db`.
    2. Add it to the existing `Promise.all` data fetch:
       ```typescript
       const [stats, topQueries, zeroResultQueries, trendingQueries, routeBreakdown] = await Promise.all([
         getSearchSummaryStats(tenantId, thirtyDaysAgo),
         getTopQueries(tenantId, thirtyDaysAgo, 50),
         getZeroResultQueries(tenantId, thirtyDaysAgo, 30),
         getTrendingQueries(tenantId, sevenDaysAgo, 20),
         getRouteTypeBreakdown(tenantId, thirtyDaysAgo),
       ]);
       ```
    3. Add a "Query Routing" section BETWEEN the summary cards and the tabbed table. Display as a row of small cards (matching the existing summary card style):
       ```tsx
       {/* Route type breakdown */}
       {routeBreakdown && routeBreakdown.length > 0 && (
         <div className="mt-6">
           <h3 className="text-sm font-medium text-gray-700">Query Routing</h3>
           <div className="mt-2 grid grid-cols-2 gap-3 sm:grid-cols-4">
             {routeBreakdown.map((r) => (
               <div key={r.routeType} className="rounded-lg border border-gray-200 bg-white p-3 shadow-sm">
                 <p className="text-xs font-medium text-gray-500 capitalize">{r.routeType}</p>
                 <p className="mt-1 text-xl font-semibold text-gray-900">{r.count}</p>
                 <p className="text-xs text-gray-400">avg {r.avgResults} results</p>
               </div>
             ))}
           </div>
         </div>
       )}
       ```
    4. Serialize `routeBreakdown` for the client component if needed, or render it directly in the server component (preferred — keep it in the server page, no need to pass to AdminSearchTable).

    **AdminSearchTable (`apps/web/components/admin-search-table.tsx`):**

    No changes needed — the route breakdown cards are rendered directly in the server page component above the client-side tabbed table. This avoids unnecessary client component complexity.

    Run `pnpm turbo typecheck` and `pnpm lint` after changes.
  </action>
  <verify>
    - `pnpm turbo typecheck` passes
    - `pnpm lint` passes
    - Visit http://localhost:2002/admin/search — page loads without errors
    - Route type breakdown cards appear (may show only "hybrid" initially if no new searches have been performed yet)
    - Run Playwright tests: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/admin.spec.ts` (if admin search page is covered)
  </verify>
  <done>
    - Admin search analytics page shows route type breakdown with counts and avg results per route
    - Cards render in a 4-column grid matching existing UI style
    - getRouteTypeBreakdown exported from @everyskill/db barrel
    - Page loads without errors
  </done>
</task>

</tasks>

<verification>
- Admin search page at /admin/search loads without errors
- Route type breakdown section is visible between summary cards and query table
- Each route type shows count and average results
- `pnpm turbo typecheck` and `pnpm lint` pass
</verification>

<success_criteria>
- Admin can see how many searches used each route type (keyword, semantic, hybrid, browse)
- Average result count per route type is displayed
- Page renders correctly with zero data (breakdown section hidden)
- Typecheck and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/74-adaptive-query-routing/74-03-SUMMARY.md`
</output>
