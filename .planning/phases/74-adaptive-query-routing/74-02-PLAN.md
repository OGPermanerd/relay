---
phase: 74-adaptive-query-routing
plan: 02
type: execute
wave: 2
depends_on: ["74-01"]
files_modified:
  - apps/web/app/actions/discover.ts
  - apps/web/app/actions/search.ts
  - apps/web/app/(protected)/skills/page.tsx
autonomous: true

must_haves:
  truths:
    - "Discover action uses classifier to route queries instead of always generating embeddings"
    - "Quick search action uses classifier to skip embedding for short keyword queries"
    - "Skills page uses classifier to route queries and logs the route type"
    - "All three entry points log routeType alongside existing searchType"
    - "Keyword queries for 1-2 word terms skip embedding generation (ROUTE-02)"
    - "Zero-result keyword searches automatically fall back to hybrid (ROUTE-04)"
  artifacts:
    - path: "apps/web/app/actions/discover.ts"
      provides: "Discover action with query routing"
      contains: "classifyQuery|routeSearch"
    - path: "apps/web/app/actions/search.ts"
      provides: "Quick search with query routing"
      contains: "classifyQuery|routeSearch"
    - path: "apps/web/app/(protected)/skills/page.tsx"
      provides: "Skills page with route-aware logging"
      contains: "routeType"
  key_links:
    - from: "apps/web/app/actions/discover.ts"
      to: "apps/web/lib/search-router.ts"
      via: "import routeSearch or classifyQuery"
      pattern: "classifyQuery|routeSearch"
    - from: "apps/web/app/actions/search.ts"
      to: "apps/web/lib/query-classifier.ts"
      via: "import classifyQuery"
      pattern: "classifyQuery"
    - from: "all three entry points"
      to: "logSearchQuery"
      via: "routeType field in log entry"
      pattern: "routeType"
---

<objective>
Wire the query classifier and router into all three web search entry points (discover, quick search, skills page) so every search query is classified, routed to the optimal backend, and logged with its route type.

Purpose: Deliver ROUTE-01 (classification), ROUTE-02 (keyword skips embedding), ROUTE-03 (route logged), ROUTE-04 (keyword fallback) across all user-facing search paths.
Output: Modified discover.ts, search.ts, skills/page.tsx with routing integration.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/74-adaptive-query-routing/74-01-SUMMARY.md
@apps/web/app/actions/discover.ts
@apps/web/app/actions/search.ts
@apps/web/app/(protected)/skills/page.tsx
@apps/web/lib/search-skills.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire routing into discover action</name>
  <files>apps/web/app/actions/discover.ts</files>
  <action>
    Modify `discoverSkills()` in `apps/web/app/actions/discover.ts` to use the classifier:

    1. Import `classifyQuery` from `@/lib/query-classifier` and `routeSearch` from `@/lib/search-router`.

    2. Replace the current embedding-first logic (lines ~101-139 where it tries embedding then hybrid/keyword) with:
       - Call `classifyQuery(trimmed)` to get the route type.
       - Use routing logic per route type:
         - "keyword": call `keywordSearchSkills()` directly. If zero results, generate embedding and fall back to `hybridSearchSkills()`.
         - "semantic": generate embedding, call `hybridSearchSkills()` (hybrid includes semantic, better coverage for discover).
         - "hybrid" (default): generate embedding, call `hybridSearchSkills()`. If zero results, fall back to `keywordSearchSkills()`.
         - "browse": should not happen (discoverSkills returns [] for empty query already).
       - Track actual `routeType` used (update if fallback occurred).

    3. Update the `logSearchQuery` call to include `routeType`:
       ```typescript
       logSearchQuery({
         tenantId,
         userId,
         query: trimmed,
         normalizedQuery: trimmed.toLowerCase(),
         resultCount: finalResults.length,
         searchType: "discover",
         routeType: actualRouteType,
       }).catch(() => {});
       ```

    4. Keep the existing preference boost logic, rationale generation, and result mapping unchanged.

    IMPORTANT per Pitfall 1: The discover action does NOT have sortBy, so routing is safe here.
    IMPORTANT per Pitfall 4: Check `getSiteSettings()?.semanticSimilarityEnabled` before attempting embedding. If disabled, force keyword route.
  </action>
  <verify>
    - `pnpm turbo typecheck` passes
    - Manual test: search "excel" in discover => should use keyword route (no embedding delay)
    - Manual test: search "how to automate emails" => should use semantic/hybrid route
  </verify>
  <done>
    - Discover action classifies queries and routes to optimal backend
    - Keyword queries skip embedding generation
    - Route type is logged with each discover search
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire routing into quick search and skills page</name>
  <files>
    apps/web/app/actions/search.ts
    apps/web/app/(protected)/skills/page.tsx
  </files>
  <action>
    **Quick Search (`apps/web/app/actions/search.ts`):**

    1. Import `classifyQuery` from `@/lib/query-classifier`.
    2. Before calling `searchSkills()`, classify the query.
    3. For "keyword" route: the existing `searchSkills()` already does full-text + ILIKE, which is fine for keyword queries. The optimization is that we do NOT need to call `getSemanticSkillIds()` inside `searchSkills()`. However, since `searchSkills()` calls semantic supplement internally and we cannot easily skip it without modifying `searchSkills()`, take this approach:
       - For keyword-classified queries: still call `searchSkills()` as-is (it handles semantic supplement gracefully if Ollama is slow/down). The value is in the logging, not performance optimization for quick search (which is already fast due to result limit of 10).
       - The primary performance win is in the discover action (Plan 02 Task 1) where hybrid search is the heavy path.
    4. Update `logSearchQuery` call to include `routeType: classification.routeType`:
       ```typescript
       const classification = classifyQuery(trimmed);
       // ... existing searchSkills call ...
       logSearchQuery({
         tenantId,
         userId: session?.user?.id ?? null,
         query: trimmed,
         normalizedQuery: trimmed.toLowerCase(),
         resultCount: mapped.length,
         searchType: "quick",
         routeType: classification.routeType,
       }).catch(() => {});
       ```

    **Skills Page (`apps/web/app/(protected)/skills/page.tsx`):**

    1. Import `classifyQuery` from `@/lib/query-classifier`.
    2. After parsing search params, classify the query (only when query is non-empty).
    3. Per Pitfall 1: When `sortBy` is specified, always use the existing `searchSkills()` path (it handles sort correctly). Only apply route type for LOGGING, not for changing the search behavior. The skills page has complex sort/filter/quality-tier logic that `searchSkills()` handles. Routing optimization would break these features.
    4. Update the `logSearchQuery` call to include `routeType`:
       ```typescript
       const routeType = query ? classifyQuery(query).routeType : "browse";
       logSearchQuery({
         tenantId: session.user.tenantId,
         userId: session.user.id,
         query,
         normalizedQuery: query.toLowerCase().trim(),
         resultCount: skills.length,
         searchType: "browse",
         routeType,
       }).catch(() => {});
       ```
    5. When no query is present (pure browsing with filters), log routeType as "browse".

    Run `pnpm turbo typecheck` and `pnpm lint` after all changes.
  </action>
  <verify>
    - `pnpm turbo typecheck` passes
    - `pnpm lint` passes (no errors)
    - Skills page loads without errors at http://localhost:2002/skills
    - Quick search dropdown works when typing in the search bar
    - `SELECT route_type, count(*) FROM search_queries GROUP BY route_type;` shows entries beyond just "hybrid" after performing searches
  </verify>
  <done>
    - All 3 search entry points (discover, quick, browse) classify queries and log routeType (ROUTE-03)
    - Keyword queries in discover action skip embedding generation (ROUTE-02)
    - Skills page respects existing sort/filter behavior (Pitfall 1 avoided)
    - Typecheck and lint pass
  </done>
</task>

</tasks>

<verification>
- All three entry points import and use the classifier
- Every logSearchQuery call includes routeType
- Skills page sort dropdown still works correctly
- Discover action keyword queries are faster (no embedding call)
- Zero-result keyword searches in discover fall back to hybrid
</verification>

<success_criteria>
- Searching "excel" in discover uses keyword route and skips embedding
- Searching "how to build automation" in discover uses hybrid/semantic route
- All search queries logged with both searchType and routeType
- Skills page with sortBy parameter still returns correctly sorted results
- `pnpm turbo typecheck` and `pnpm lint` pass
</success_criteria>

<output>
After completion, create `.planning/phases/74-adaptive-query-routing/74-02-SUMMARY.md`
</output>
