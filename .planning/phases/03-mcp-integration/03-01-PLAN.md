---
phase: 03-mcp-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mcp/package.json
  - apps/mcp/tsconfig.json
  - apps/mcp/src/index.ts
  - apps/mcp/src/server.ts
  - packages/db/src/schema/usage-events.ts
  - packages/db/src/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "MCP server starts without errors on stdio"
    - "Server responds to MCP protocol list_tools request"
    - "usageEvents table exists in database"
  artifacts:
    - path: "apps/mcp/src/server.ts"
      provides: "McpServer instance with stdio transport"
      contains: "McpServer"
    - path: "apps/mcp/src/index.ts"
      provides: "Entry point that starts server"
      contains: "main()"
    - path: "packages/db/src/schema/usage-events.ts"
      provides: "Usage events table for analytics"
      contains: "pgTable"
  key_links:
    - from: "apps/mcp/src/index.ts"
      to: "apps/mcp/src/server.ts"
      via: "import and connect"
      pattern: "import.*server"
    - from: "packages/db/src/schema/index.ts"
      to: "packages/db/src/schema/usage-events.ts"
      via: "re-export"
      pattern: "export.*usage-events"
---

<objective>
Create the MCP server scaffold using the official TypeScript SDK with stdio transport, plus the usageEvents schema for tracking tool invocations.

Purpose: Establishes the foundation for all MCP tools and analytics - without this, no tools can be registered or usage tracked.
Output: Running MCP server that responds to protocol handshake, plus database schema for usage events.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-mcp-integration/03-RESEARCH.md

# Database patterns from Phase 1
@packages/db/src/schema/users.ts
@packages/db/src/index.ts
@packages/db/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create apps/mcp package with MCP SDK</name>
  <files>
    apps/mcp/package.json
    apps/mcp/tsconfig.json
  </files>
  <action>
Create new apps/mcp directory as a TypeScript package.

**package.json:**
- name: "@relay/mcp"
- bin: { "relay-mcp": "./dist/index.js" }
- scripts: { "dev": "tsx src/index.ts", "build": "tsup src/index.ts --format cjs --dts", "typecheck": "tsc --noEmit" }
- dependencies: @modelcontextprotocol/sdk ^1.25.0, zod ^3.25.0, @relay/db workspace:*
- devDependencies: tsx ^4.19.0, tsup ^8.3.0, @types/node ^22.10.0, typescript ^5.7.0

**tsconfig.json:**
- extends from root config pattern
- compilerOptions: module "NodeNext", moduleResolution "NodeNext", target "ES2022"
- include: ["src/**/*"]

Run `pnpm install` from project root after creating files.
  </action>
  <verify>
    `pnpm --filter @relay/mcp typecheck` passes
    `ls apps/mcp/node_modules/@modelcontextprotocol` shows sdk installed
  </verify>
  <done>
    apps/mcp package exists with MCP SDK and Zod dependencies installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement MCP server with stdio transport</name>
  <files>
    apps/mcp/src/server.ts
    apps/mcp/src/index.ts
  </files>
  <action>
**src/server.ts:**
```typescript
import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";

export const server = new McpServer({
  name: "relay-skills",
  version: "1.0.0",
});

// Tools will be registered by importing tool modules
export type { McpServer };
```

**src/index.ts:**
```typescript
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
import { server } from "./server.js";

async function main() {
  const transport = new StdioServerTransport();
  await server.connect(transport);
  // CRITICAL: Use console.error, never console.log (corrupts stdio protocol)
  console.error("Relay MCP Server running on stdio");
}

main().catch((error) => {
  console.error("Fatal error:", error);
  process.exit(1);
});
```

**CRITICAL:** Never use console.log in stdio servers - it corrupts JSON-RPC protocol.
  </action>
  <verify>
    `pnpm --filter @relay/mcp dev` starts without error (Ctrl+C to stop)
    No stdout output (only stderr logging)
  </verify>
  <done>
    MCP server starts on stdio and responds to protocol initialization
  </done>
</task>

<task type="auto">
  <name>Task 3: Add usageEvents schema to @relay/db</name>
  <files>
    packages/db/src/schema/usage-events.ts
    packages/db/src/schema/index.ts
  </files>
  <action>
**packages/db/src/schema/usage-events.ts:**
```typescript
import { pgTable, text, timestamp, jsonb, uuid } from "drizzle-orm/pg-core";
import { users } from "./users";

/**
 * Usage events track MCP tool invocations for analytics
 * Supports both anonymous (no userId) and authenticated usage
 */
export const usageEvents = pgTable("usage_events", {
  id: uuid("id").primaryKey().defaultRandom(),
  toolName: text("tool_name").notNull(),
  skillId: text("skill_id"),  // text to match skills table (created in Plan 02)
  userId: text("user_id").references(() => users.id),
  metadata: jsonb("metadata").$type<Record<string, unknown>>(),
  createdAt: timestamp("created_at").notNull().defaultNow(),
});

export type UsageEvent = typeof usageEvents.$inferSelect;
export type NewUsageEvent = typeof usageEvents.$inferInsert;
```

**packages/db/src/schema/index.ts:**
Add export: `export * from "./usage-events";`

Run `pnpm --filter @relay/db db:push` to sync schema to database.

Note: skillId is text (not uuid) to match the skills table that will be created in Plan 02. The reference constraint will be added when skills table exists.
  </action>
  <verify>
    `pnpm --filter @relay/db typecheck` passes
    `pnpm --filter @relay/db db:push` shows usage_events table created/updated
  </verify>
  <done>
    usageEvents table exists in database schema, types exported from @relay/db
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @relay/mcp typecheck` - MCP package compiles
2. `pnpm --filter @relay/mcp dev` starts server (use Ctrl+C to exit after ~2 seconds)
3. `pnpm --filter @relay/db typecheck` - DB package compiles with new schema
4. Database has usage_events table (verify with db:push output)
</verification>

<success_criteria>
- apps/mcp/ package exists with @modelcontextprotocol/sdk dependency
- MCP server starts on stdio without errors
- usageEvents table schema exists in @relay/db
- All typecheck commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-integration/03-01-SUMMARY.md`
</output>
