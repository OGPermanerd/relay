---
phase: 03-mcp-integration
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - apps/mcp/src/tools/deploy.ts
  - apps/mcp/src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "deploy_skill tool returns skill content with save instructions"
    - "Invalid skillId returns error response"
    - "Deployment is tracked in usageEvents"
  artifacts:
    - path: "apps/mcp/src/tools/deploy.ts"
      provides: "deploy_skill MCP tool"
      contains: "registerTool"
  key_links:
    - from: "apps/mcp/src/tools/deploy.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "database query for skill content"
      pattern: "skills"
    - from: "apps/mcp/src/tools/deploy.ts"
      to: "apps/mcp/src/tracking/events.ts"
      via: "trackUsage call"
      pattern: "trackUsage"
---

<objective>
Implement the deploy_skill tool that retrieves skill content and provides save instructions for Claude Code to execute.

Purpose: Users can get skill content from Relay to deploy locally - this is the core "one-click deploy" capability.
Output: deploy_skill tool that returns skill content with instructions for Claude to save it.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-mcp-integration/03-RESEARCH.md
@.planning/phases/03-mcp-integration/03-02-SUMMARY.md

# Existing code
@apps/mcp/src/server.ts
@apps/mcp/src/tools/list.ts
@apps/mcp/src/tracking/events.ts
@packages/db/src/schema/skills.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement deploy_skill tool</name>
  <files>
    apps/mcp/src/tools/deploy.ts
  </files>
  <action>
**apps/mcp/src/tools/deploy.ts:**
```typescript
import { z } from "zod";
import { server } from "../server.js";
import { db } from "@everyskill/db";
import { skills } from "@everyskill/db/schema";
import { eq } from "drizzle-orm";
import { trackUsage } from "../tracking/events.js";

server.registerTool(
  "deploy_skill",
  {
    description: "Deploy a skill from Relay to your local Claude environment. Returns the skill content and filename for you to save. Use the skill ID from list_skills or search_skills results.",
    inputSchema: {
      skillId: z.string().describe("Skill ID from search/list results"),
    },
  },
  async ({ skillId }) => {
    // Fetch skill with content
    const skill = await db.query.skills.findFirst({
      where: eq(skills.id, skillId),
    });

    if (!skill) {
      return {
        content: [{
          type: "text",
          text: JSON.stringify({
            success: false,
            error: "Skill not found",
            message: `No skill found with ID: ${skillId}. Use list_skills or search_skills to find valid skill IDs.`,
          }, null, 2),
        }],
        isError: true,
      };
    }

    // Track deployment
    await trackUsage({
      toolName: "deploy_skill",
      skillId: skill.id,
      metadata: {
        skillName: skill.name,
        skillCategory: skill.category,
      },
    });

    // Return skill content for Claude to save
    // Claude Code will handle file writing with user confirmation
    return {
      content: [{
        type: "text",
        text: JSON.stringify({
          success: true,
          skill: {
            id: skill.id,
            name: skill.name,
            category: skill.category,
            filename: `${skill.slug}.md`,
            content: skill.content,
            hoursSaved: skill.hoursSaved,
          },
          instructions: [
            `Save this skill to your project's .claude/skills/ directory`,
            `Suggested path: .claude/skills/${skill.slug}.md`,
            `After saving, the skill will be available in your Claude Code session`,
          ],
        }, null, 2),
      }],
    };
  }
);
```

**Key design decisions:**
- Returns skill content + instructions rather than writing files directly (Claude Code handles file ops)
- Uses slug for filename (safe for filesystem)
- Includes clear error message for invalid IDs
- Tracks deployment with skill metadata for analytics
  </action>
  <verify>
    `pnpm --filter @everyskill/mcp typecheck` passes
  </verify>
  <done>
    deploy_skill tool returns skill content with save instructions
  </done>
</task>

<task type="auto">
  <name>Task 2: Register deploy tool and verify full tool set</name>
  <files>
    apps/mcp/src/tools/index.ts
  </files>
  <action>
**Update apps/mcp/src/tools/index.ts:**
```typescript
// Import tools to register them with the server
import "./list.js";
import "./search.js";
import "./deploy.js";
```

After adding, verify all three tools are properly registered by starting the server.
  </action>
  <verify>
    `pnpm --filter @everyskill/mcp typecheck` passes
    `pnpm --filter @everyskill/mcp dev` starts without errors (Ctrl+C to exit)
    Server logs show no import/registration errors
  </verify>
  <done>
    All three MCP tools (list_skills, search_skills, deploy_skill) registered
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @everyskill/mcp typecheck` - MCP compiles with deploy tool
2. `pnpm --filter @everyskill/mcp dev` - Server starts with all tools
3. No console.log statements in tool code (only console.error)
</verification>

<success_criteria>
- deploy_skill tool exists and compiles
- Tool returns skill content with filename and instructions
- Invalid skillId returns structured error (not exception)
- Deployment events tracked in usageEvents table
</success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-integration/03-03-SUMMARY.md`
</output>
