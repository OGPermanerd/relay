---
phase: 26-auth-subdomain-routing
plan: 03
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - apps/web/middleware.ts
  - apps/web/app/(auth)/login/page.tsx
autonomous: true

must_haves:
  truths:
    - "Middleware extracts tenant slug from Host header (subdomain.everyskill.ai)"
    - "Middleware sets x-tenant-slug request header for downstream consumption"
    - "Middleware redirects unauthenticated users to /login (except exempt paths)"
    - "Middleware works in development with tenant-slug.localhost:2000"
    - "Auth API routes (/api/auth/*) pass through without auth check"
    - "MCP, dev-login, install-callback, validate-key routes remain exempt"
    - "Login page displays tenant context appropriately"
  artifacts:
    - path: "apps/web/middleware.ts"
      provides: "Unwrapped middleware with subdomain extraction and tenant header injection"
      contains: "x-tenant-slug"
    - path: "apps/web/app/(auth)/login/page.tsx"
      provides: "Login page with tenant-aware messaging"
  key_links:
    - from: "apps/web/middleware.ts"
      to: "Host header"
      via: "extractSubdomain function"
      pattern: "extractSubdomain"
    - from: "apps/web/middleware.ts"
      to: "x-tenant-slug header"
      via: "requestHeaders.set"
      pattern: "x-tenant-slug"
    - from: "apps/web/middleware.ts"
      to: "session cookie"
      via: "cookie presence check for auth"
      pattern: "session-token"
---

<objective>
Rewrite middleware.ts to use unwrapped (non-auth-wrapped) middleware with subdomain extraction and tenant header injection. Update the login page for multi-tenant context.

Purpose: This implements TENANT-06 (subdomain routing). The middleware extracts the tenant slug from the Host header and injects it as an x-tenant-slug request header. It does NOT use the auth() wrapper (known Auth.js v5 bug with subdomains -- GitHub issues #9631, #10915, #11450). Auth is checked via cookie presence instead.

Output: Rewritten middleware.ts and updated login page
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/web/middleware.ts
@apps/web/app/(auth)/login/page.tsx
@apps/web/auth.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite middleware with subdomain extraction (no auth() wrapper)</name>
  <files>apps/web/middleware.ts</files>
  <action>
**Completely rewrite** `apps/web/middleware.ts`. Remove the auth() wrapper pattern entirely.

**CRITICAL: Do NOT import NextAuth or auth(). Do NOT wrap middleware with auth().** Auth.js v5 beta.30 has bugs where auth() rewrites req.url, breaking subdomain routing (GitHub #9631, #10915, #11450).

The new middleware is a plain Next.js middleware function:

```typescript
import { NextRequest, NextResponse } from "next/server";

const ROOT_DOMAIN = process.env.NEXT_PUBLIC_ROOT_DOMAIN || "everyskill.ai";

export default async function middleware(req: NextRequest) {
  const host = req.headers.get("host") || "";
  const pathname = req.nextUrl.pathname;

  // === Exempt paths: skip entirely ===
  // Auth API routes must be accessible for OAuth flow
  // Also exempt: dev-login, install-callback, MCP, validate-key
  if (
    pathname.startsWith("/api/auth") ||
    pathname === "/api/dev-login" ||
    pathname.startsWith("/api/install-callback") ||
    pathname.startsWith("/api/mcp") ||
    pathname === "/api/validate-key"
  ) {
    return NextResponse.next();
  }

  // === Extract subdomain ===
  const subdomain = extractSubdomain(host, ROOT_DOMAIN);

  // === Set tenant context headers ===
  const requestHeaders = new Headers(req.headers);
  if (subdomain) {
    requestHeaders.set("x-tenant-slug", subdomain);
  }

  // === Auth check via cookie presence ===
  // Check for session token cookie (conditional name based on environment)
  const sessionToken =
    req.cookies.get("__Secure-authjs.session-token")?.value ||
    req.cookies.get("authjs.session-token")?.value;

  const isLoginPage = pathname === "/login";

  // Redirect unauthenticated users to login (except login page itself)
  if (!sessionToken && !isLoginPage) {
    const loginUrl = new URL("/login", req.url);
    loginUrl.searchParams.set("callbackUrl", pathname);
    return NextResponse.redirect(loginUrl);
  }

  // Redirect authenticated users away from login page
  if (sessionToken && isLoginPage) {
    return NextResponse.redirect(new URL("/", req.url));
  }

  // Forward request with tenant headers
  return NextResponse.next({
    request: { headers: requestHeaders },
  });
}
```

**extractSubdomain helper function:**
```typescript
function extractSubdomain(host: string, rootDomain: string): string | null {
  const hostname = host.split(":")[0]; // Remove port

  // Development: acme.localhost
  if (hostname.endsWith("localhost") || hostname.endsWith("localhost")) {
    const parts = hostname.split(".");
    // "acme.localhost" => ["acme", "localhost"]
    if (parts.length >= 2 && parts[parts.length - 1] === "localhost") {
      const sub = parts.slice(0, -1).join(".");
      return sub === "www" ? null : sub || null;
    }
    return null;
  }

  // Production: acme.everyskill.ai
  if (hostname === rootDomain || hostname === `www.${rootDomain}`) {
    return null; // Apex or www = no subdomain
  }
  if (hostname.endsWith(`.${rootDomain}`)) {
    const sub = hostname.replace(`.${rootDomain}`, "");
    return sub === "www" ? null : sub || null;
  }

  return null;
}
```

**Keep the existing matcher** (it's correct):
```typescript
export const config = {
  matcher: ["/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)"],
};
```

**Key differences from old middleware:**
1. NO auth() wrapper -- plain NextResponse-based middleware
2. Subdomain extraction from Host header
3. x-tenant-slug header injection for downstream routes
4. Auth check via cookie presence (not auth() session)
5. All existing exempt paths preserved (api/auth, dev-login, install-callback, mcp, validate-key)
  </action>
  <verify>
1. Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json 2>&1 | head -30` -- no type errors
2. Verify middleware.ts does NOT import NextAuth or auth
3. Verify middleware.ts contains extractSubdomain, x-tenant-slug, and cookie-based auth check
4. Run `cd /home/dev/projects/relay/apps/web && npm run build 2>&1 | tail -20` -- build succeeds
  </verify>
  <done>
    - Middleware uses plain NextResponse (no auth() wrapper)
    - extractSubdomain handles both localhost:2000 (dev) and everyskill.ai (prod)
    - x-tenant-slug header set for subdomain requests
    - Cookie-based auth check redirects unauthenticated users to /login
    - All existing exempt paths preserved
    - matcher config unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Update login page for multi-tenant context</name>
  <files>apps/web/app/(auth)/login/page.tsx</files>
  <action>
Update the login page to work in the multi-tenant context:

1. **Update the sign-in call** to include a `redirectTo` that preserves the current origin (subdomain). The form action should pass `redirectTo: callbackUrl` which Auth.js will use for the redirect callback.

2. **Update error messaging** from "company email" to more generic "organization email":
   - Change "Access denied. Please sign in with a company email address." to "Access denied. Your email domain is not associated with any organization."
   - Change "Use your company email to sign in" to "Sign in with your organization email"

3. **Update the subtitle** from "Internal Skill Marketplace" to "Skills Marketplace" (no longer purely internal).

4. **Keep the Google sign-in button** and form action pattern unchanged. The signIn server action already accepts redirectTo which Auth.js will handle through the redirect callback.

5. **Read the x-tenant-slug header** via `headers()` from `next/headers` to optionally display the tenant name on the login page. Since this is a server component, you can access request headers.
   - Import `headers` from `next/headers`
   - Read `x-tenant-slug` header: `const headersList = await headers(); const tenantSlug = headersList.get("x-tenant-slug");`
   - If tenantSlug exists, display it above the sign-in form as context (e.g., "Signing in to {tenantSlug}")
   - This is a UX enhancement, not a security gate -- the signIn callback handles actual validation

The login page is a server component (no "use client" directive), so headers() works directly.
  </action>
  <verify>
1. Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json 2>&1 | head -30` -- no type errors
2. Run `cd /home/dev/projects/relay/apps/web && npm run build 2>&1 | tail -20` -- build succeeds
3. Verify login page no longer references "company email" or "Internal Skill Marketplace"
  </verify>
  <done>
    - Login page shows "Skills Marketplace" instead of "Internal Skill Marketplace"
    - Error messages reference "organization" instead of "company"
    - Tenant slug displayed when accessing via subdomain
    - Sign-in redirectTo preserved for cross-subdomain redirect
    - Page compiles and builds without errors
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes for apps/web
2. Next.js build succeeds
3. middleware.ts has no auth() wrapper import
4. middleware.ts extracts subdomain and sets x-tenant-slug header
5. Login page references organization (not company)
6. Run existing Playwright E2E tests: `cd /home/dev/projects/relay/apps/web && node_modules/.bin/playwright test --timeout 60000 2>&1 | tail -30` -- existing tests should still pass (they run on localhost without subdomain, so extractSubdomain returns null and behavior is backwards-compatible)
</verification>

<success_criteria>
- Subdomain extraction works for both dev (*.localhost:2000) and prod (*.everyskill.ai)
- x-tenant-slug header injected for downstream routes
- Cookie-based auth check replaces auth() wrapper
- Login page is multi-tenant aware
- Existing E2E tests continue to pass (backwards compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/26-auth-subdomain-routing/26-03-SUMMARY.md`
</output>
