---
phase: 26-auth-subdomain-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/services/tenant.ts
  - apps/web/types/next-auth.d.ts
  - apps/web/auth.config.ts
autonomous: true

must_haves:
  truths:
    - "Tenant lookup by slug returns the correct tenant record"
    - "Tenant lookup by domain returns the correct tenant record"
    - "Auth.js session type includes tenantId field"
    - "Auth.js JWT type includes tenantId field"
    - "Session cookies use __Secure- prefix in production with domain scoping"
    - "Session maxAge is 8 hours (28800 seconds)"
    - "Google OAuth no longer restricts to single hd domain"
  artifacts:
    - path: "packages/db/src/services/tenant.ts"
      provides: "Tenant lookup by slug and domain"
      exports: ["getTenantBySlug", "getTenantByDomain"]
    - path: "apps/web/types/next-auth.d.ts"
      provides: "Module augmentation for tenantId on Session and JWT"
      contains: "tenantId"
    - path: "apps/web/auth.config.ts"
      provides: "Edge-compatible auth config with domain-scoped cookies and 8h session"
      contains: "__Secure-"
  key_links:
    - from: "packages/db/src/services/tenant.ts"
      to: "packages/db/src/schema/tenants.ts"
      via: "drizzle query"
      pattern: "from\\(tenants\\)"
    - from: "apps/web/auth.config.ts"
      to: "session cookies"
      via: "cookies config object"
      pattern: "sessionToken|callbackUrl|csrfToken"
---

<objective>
Create the foundation layer for Phase 26: tenant lookup service, TypeScript type augmentations, and Edge-compatible auth configuration with domain-scoped cookies.

Purpose: These three artifacts are prerequisites for the auth callback rewrite (Plan 02) and middleware rewrite (Plan 03). The tenant service provides DB lookup functions. The type augmentation adds tenantId to Auth.js types. The auth.config changes enable cross-subdomain cookie sharing and SOC2-compliant session timeout.

Output: Three files -- tenant DB service, next-auth type declarations, updated auth.config.ts
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/schema/tenants.ts
@packages/db/src/client.ts
@apps/web/auth.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tenant lookup service and NextAuth type augmentation</name>
  <files>
    packages/db/src/services/tenant.ts
    apps/web/types/next-auth.d.ts
  </files>
  <action>
1. Create `packages/db/src/services/tenant.ts` with two functions:
   - `getTenantBySlug(slug: string)`: queries `tenants` table WHERE `slug = slug` AND `isActive = true`, returns tenant or null. Uses drizzle `eq` and `and` operators.
   - `getTenantByDomain(domain: string)`: queries `tenants` table WHERE `domain = domain` AND `isActive = true`, returns tenant or null.
   - Both functions: import `db` from `../client`, `tenants` from `../schema`, `eq` and `and` from `drizzle-orm`.
   - Guard: if `!db` return null (consistent with other services in the codebase).
   - Export the `Tenant` type re-export from schema for convenience.

2. Create `apps/web/types/next-auth.d.ts` with module augmentation:
   - Augment `next-auth` module: add `tenantId?: string` to `Session.user` (extend `DefaultSession["user"]`)
   - Augment `next-auth/jwt` module: add `id?: string` and `tenantId?: string` to `JWT` interface
   - This enables type-safe access to `session.user.tenantId` and `token.tenantId` throughout the app.

Note: The `types/` directory does not exist yet under `apps/web/` -- create it.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json 2>&1 | head -30` to confirm no type errors from the new files. Also verify the tenant service compiles: `cd packages/db && npx tsc --noEmit 2>&1 | head -20`.
  </verify>
  <done>
    - getTenantBySlug and getTenantByDomain exported from packages/db/src/services/tenant.ts
    - next-auth.d.ts declares tenantId on Session.user and JWT
    - No TypeScript compilation errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update auth.config.ts with domain-scoped cookies and 8h session</name>
  <files>apps/web/auth.config.ts</files>
  <action>
Rewrite `apps/web/auth.config.ts` to add cross-subdomain cookie configuration and SOC2 session timeout. This file must remain Edge-compatible (NO database imports).

Changes:
1. **Remove `hd` parameter** from Google provider config. Multi-tenant means multiple email domains -- domain restriction now happens in the signIn callback (auth.ts, Plan 02). Remove the `authorization.params.hd` and `AUTH_ALLOWED_DOMAIN` usage entirely.

2. **Add session config** with `strategy: "jwt"` and `maxAge: 8 * 60 * 60` (8 hours = 28800 seconds, SOC2-04 compliance).

3. **Add `trustHost: true`** at the top level. Required for Auth.js to derive host from request headers instead of AUTH_URL.

4. **Add `cookies` configuration** for cross-subdomain session sharing:
   - Compute `isSecure = process.env.NODE_ENV === "production"` and `rootDomain = process.env.NEXT_PUBLIC_ROOT_DOMAIN || "everyskill.ai"`
   - `sessionToken`: name is `__Secure-authjs.session-token` (prod) or `authjs.session-token` (dev). Options: httpOnly true, sameSite "lax", path "/", domain `.${rootDomain}` (prod) or undefined (dev), secure matches isSecure.
   - `callbackUrl`: name is `__Secure-authjs.callback-url` (prod) or `authjs.callback-url` (dev). Same options pattern.
   - `csrfToken`: name is `authjs.csrf-token` (NO __Secure- prefix -- CSRF tokens need to be readable). Options same pattern for domain/path.

5. **Keep** `pages: { signIn: "/login", error: "/login" }` unchanged.

6. **Keep** `callbacks.authorized` unchanged (returns !!auth).

CRITICAL: Do NOT import any database modules. This file runs in Edge middleware. Do NOT add `adapter` here. Only Edge-safe code.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json 2>&1 | head -30` to confirm auth.config.ts compiles cleanly. Verify the file does NOT contain any `@everyskill/db` or `drizzle` imports.
  </verify>
  <done>
    - auth.config.ts has no hd parameter
    - session.strategy is "jwt" with maxAge 28800
    - trustHost is true
    - Three cookie configs (sessionToken, callbackUrl, csrfToken) with conditional __Secure- prefix and domain scoping
    - No database imports in the file
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes for both apps/web and packages/db
2. auth.config.ts contains no DB imports (Edge-safe)
3. Tenant service exports getTenantBySlug and getTenantByDomain
4. next-auth.d.ts augments Session.user and JWT with tenantId
5. Session maxAge is 28800 (8 hours)
</verification>

<success_criteria>
- Foundation layer complete: tenant service, type augmentation, auth config
- All three files compile without errors
- Ready for Plan 02 (auth callbacks) and Plan 03 (middleware) to consume these artifacts
</success_criteria>

<output>
After completion, create `.planning/phases/26-auth-subdomain-routing/26-01-SUMMARY.md`
</output>
