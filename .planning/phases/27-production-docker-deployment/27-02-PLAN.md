---
phase: 27-production-docker-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/Dockerfile
  - docker/Dockerfile.caddy
  - docker/Caddyfile
autonomous: true

must_haves:
  truths:
    - "Dockerfile builds Next.js app from monorepo using 4-stage turbo prune pipeline"
    - "Dockerfile.caddy builds custom Caddy with Hetzner DNS module for wildcard certs"
    - "Caddyfile routes *.everyskill.ai and everyskill.ai to the web service with proper headers"
    - "Production image runs as non-root user"
  artifacts:
    - path: "docker/Dockerfile"
      provides: "4-stage Next.js standalone build"
      contains: "turbo prune web --docker"
    - path: "docker/Dockerfile.caddy"
      provides: "Custom Caddy with caddy-dns/hetzner"
      contains: "caddy-dns/hetzner"
    - path: "docker/Caddyfile"
      provides: "Wildcard subdomain routing + HTTPS"
      contains: "*.everyskill.ai"
  key_links:
    - from: "docker/Dockerfile"
      to: "apps/web/server.js"
      via: "CMD in runner stage"
      pattern: "node.*apps/web/server.js"
    - from: "docker/Caddyfile"
      to: "web:2000"
      via: "reverse_proxy directive"
      pattern: "reverse_proxy.*web:2000"
---

<objective>
Create the Docker build files for Next.js and Caddy, plus the Caddyfile for wildcard HTTPS routing.

Purpose: These are the core container definitions. The Dockerfile produces a ~150MB standalone Next.js image via turbo prune. The Caddy Dockerfile builds a custom image with the Hetzner DNS module required for wildcard certificate DNS-01 challenges. The Caddyfile configures wildcard subdomain routing.

Output: docker/Dockerfile, docker/Dockerfile.caddy, docker/Caddyfile
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfiles and Caddyfile</name>
  <files>
    docker/Dockerfile
    docker/Dockerfile.caddy
    docker/Caddyfile
  </files>
  <action>
1. Create `docker/Dockerfile` -- 4-stage build for pnpm + turbo monorepo:

```dockerfile
# Stage 1: Prune monorepo to only web app and its workspace dependencies
FROM node:22-alpine AS pruner
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate
RUN pnpm install -g turbo@^2
WORKDIR /app
COPY . .
RUN turbo prune web --docker

# Stage 2: Install dependencies (cached layer)
FROM node:22-alpine AS installer
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate
WORKDIR /app
COPY --from=pruner /app/out/json/ .
COPY --from=pruner /app/out/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=pruner /app/out/pnpm-workspace.yaml ./pnpm-workspace.yaml
RUN pnpm install --frozen-lockfile

# Stage 3: Build the application
FROM node:22-alpine AS builder
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate
WORKDIR /app
COPY --from=installer /app/ .
COPY --from=pruner /app/out/full/ .
COPY turbo.json turbo.json
ENV NEXT_TELEMETRY_DISABLED=1
RUN pnpm turbo build --filter=web

# Stage 4: Production runner (~150MB)
FROM node:22-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/static ./apps/web/.next/static
# Uncomment when apps/web/public/ exists:
# COPY --from=builder --chown=nextjs:nodejs /app/apps/web/public ./apps/web/public
USER nextjs
EXPOSE 2000
ENV PORT=2000 HOSTNAME=0.0.0.0
CMD ["node", "apps/web/server.js"]
```

Key details:
- pnpm@9.15.0 matches the project's packageManager field exactly
- turbo prune --docker splits output into json/ (package.json files) and full/ (source) for optimal layer caching
- pnpm-lock.yaml and pnpm-workspace.yaml must be copied explicitly from pruner output root
- Stage 4 runs as non-root user `nextjs` (UID 1001)
- Port 2000 matches the project's dev server port
- The public/ COPY is commented out because apps/web/public/ does not exist yet

2. Create `docker/Dockerfile.caddy` -- custom Caddy with Hetzner DNS module:

```dockerfile
FROM caddy:2-builder AS builder
RUN xcaddy build --with github.com/caddy-dns/hetzner/v2

FROM caddy:2-alpine
COPY --from=builder /usr/bin/caddy /usr/bin/caddy
```

3. Create `docker/Caddyfile` -- wildcard subdomain routing:

```caddyfile
*.everyskill.ai, everyskill.ai {
    tls {
        dns hetzner {env.HETZNER_DNS_API_TOKEN}
    }

    reverse_proxy web:2000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}
```

Key details:
- Wildcard + apex domain in single block
- DNS-01 challenge via Hetzner DNS API for wildcard cert
- Passes original Host header for subdomain extraction in middleware
- X-Forwarded-* headers for proper client IP logging
  </action>
  <verify>
Verify all 3 files exist and contain expected content:
- `grep "turbo prune web --docker" /home/dev/projects/relay/docker/Dockerfile`
- `grep "caddy-dns/hetzner" /home/dev/projects/relay/docker/Dockerfile.caddy`
- `grep "everyskill.ai" /home/dev/projects/relay/docker/Caddyfile`
- `grep "USER nextjs" /home/dev/projects/relay/docker/Dockerfile`
  </verify>
  <done>
docker/Dockerfile has 4-stage build with turbo prune, non-root user, standalone output. docker/Dockerfile.caddy builds custom Caddy with Hetzner DNS module. docker/Caddyfile routes wildcard subdomains with proper headers.
  </done>
</task>

</tasks>

<verification>
- docker/Dockerfile contains 4 FROM stages (pruner, installer, builder, runner)
- docker/Dockerfile uses pnpm@9.15.0 and turbo prune web --docker
- docker/Dockerfile runs as non-root user nextjs
- docker/Dockerfile.caddy builds with caddy-dns/hetzner/v2
- docker/Caddyfile handles *.everyskill.ai with DNS-01 TLS
</verification>

<success_criteria>
All three Docker/Caddy files exist with correct content. Dockerfile produces a standalone Next.js image. Caddy Dockerfile includes Hetzner DNS module. Caddyfile configures wildcard HTTPS routing.
</success_criteria>

<output>
After completion, create `.planning/phases/27-production-docker-deployment/27-02-SUMMARY.md`
</output>
