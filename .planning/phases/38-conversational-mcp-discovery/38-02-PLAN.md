---
phase: 38-conversational-mcp-discovery
plan: 02
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - apps/mcp/src/tools/recommend.ts
  - apps/mcp/src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "recommend_skills returns semantically relevant published skills when Ollama is available"
    - "recommend_skills falls back to ILIKE text search when Ollama is unreachable or returns no results"
    - "recommend_skills never returns unpublished skills regardless of search method"
    - "Response includes searchMethod field indicating 'semantic' or 'text'"
  artifacts:
    - path: "apps/mcp/src/tools/recommend.ts"
      provides: "recommend_skills MCP tool with semantic search + ILIKE fallback"
      exports: ["handleRecommendSkills"]
  key_links:
    - from: "apps/mcp/src/tools/recommend.ts"
      to: "packages/db/src/services/semantic-search.ts"
      via: "semanticSearchSkills import"
      pattern: "semanticSearchSkills"
    - from: "apps/mcp/src/tools/recommend.ts"
      to: "apps/mcp/src/lib/ollama.ts"
      via: "generateEmbedding import"
      pattern: "generateEmbedding"
    - from: "apps/mcp/src/tools/recommend.ts"
      to: "packages/db/src/services/search-skills.ts"
      via: "searchSkillsByQuery import (ILIKE fallback)"
      pattern: "searchSkillsByQuery"
---

<objective>
Create the `recommend_skills` MCP tool that performs semantic search with ILIKE fallback.

Purpose: DISC-01 (semantic search), DISC-05 (graceful fallback), DISC-06 (published-only filter)
Output: Working `recommend_skills` tool registered with MCP server
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/38-conversational-mcp-discovery/38-01-SUMMARY.md
@apps/mcp/src/tools/search.ts
@apps/mcp/src/auth.ts
@apps/mcp/src/tracking/events.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create recommend_skills MCP tool</name>
  <files>apps/mcp/src/tools/recommend.ts, apps/mcp/src/tools/index.ts</files>
  <action>
Create `apps/mcp/src/tools/recommend.ts` following the exact pattern from `search.ts`:

1. Imports:
   - `z` from "zod"
   - `server` from "../server.js"
   - `semanticSearchSkills` from "@everyskill/db/services/semantic-search"
   - `searchSkillsByQuery` from "@everyskill/db/services/search-skills"
   - `generateEmbedding, OLLAMA_DEFAULTS` from "../lib/ollama.js"
   - `trackUsage` from "../tracking/events.js"
   - `getUserId, getTenantId, shouldNudge, incrementAnonymousCount, getFirstAuthMessage` from "../auth.js"

2. Export `handleRecommendSkills` function:
   ```
   async function handleRecommendSkills({
     query, category, limit, userId, skipNudge,
   }: {
     query: string; category?: string; limit: number;
     userId?: string; skipNudge?: boolean;
   })
   ```

   Implementation:
   a. `const tenantId = getTenantId()`
   b. Try semantic search first:
      - `const embedding = await generateEmbedding(query, OLLAMA_DEFAULTS)`
      - If embedding is not null, call `semanticSearchSkills({ queryEmbedding: embedding, limit, category, tenantId: tenantId ?? undefined })`
      - Set `searchMethod = "semantic"`
   c. Fallback to ILIKE if embedding is null OR semantic results are empty:
      - Call `searchSkillsByQuery({ query, category, limit, tenantId: tenantId ?? undefined })`
      - Set `searchMethod = "text"`
   d. Anonymous nudge: if (!userId && !skipNudge) incrementAnonymousCount()
   e. Track usage: `await trackUsage({ toolName: "recommend_skills", userId, metadata: { query, category, searchMethod, resultCount: results.length } })`
   f. Build response JSON: `{ query, searchMethod, count: results.length, skills: results }`
   g. Append auth/nudge messages (same pattern as search.ts)
   h. Return `{ content }` array

3. Register tool:
   ```
   server.registerTool("recommend_skills", {
     description: "Discover skills using natural language. Describe what you need and get semantically relevant recommendations. Uses AI-powered search when available, falls back to text matching.",
     inputSchema: {
       query: z.string().min(1).describe("Natural language description of what you need (e.g., 'help me write better code reviews')"),
       category: z.enum(["prompt", "workflow", "agent", "mcp"]).optional().describe("Filter by skill category"),
       limit: z.number().min(1).max(20).default(5).describe("Maximum number of recommendations"),
     },
   }, async ({ query, category, limit }) =>
     handleRecommendSkills({ query, category, limit, userId: getUserId() ?? undefined })
   );
   ```

4. Add import to `apps/mcp/src/tools/index.ts`:
   - Add `import "./recommend.js";` after the existing search import

CRITICAL: No console.log anywhere -- only console.error. All queries must filter published-only (handled by semanticSearchSkills and searchSkillsByQuery services).
  </action>
  <verify>
Run `cd /home/dev/projects/relay/apps/mcp && npx tsc --noEmit 2>&1 | grep -c "error TS"` -- should show 0 new errors (ignore pre-existing packages/db resolution errors by checking recommend.ts specifically: `npx tsc --noEmit 2>&1 | grep "recommend"` should return nothing).

Then run `cd /home/dev/projects/relay && pnpm build` to verify full build passes.
  </verify>
  <done>recommend_skills tool registered, tries semantic search first, falls back to ILIKE, response includes searchMethod, only returns published skills</done>
</task>

</tasks>

<verification>
- `recommend_skills` tool registered in MCP server (visible in index.ts imports)
- Semantic search path: generateEmbedding -> semanticSearchSkills
- Fallback path: searchSkillsByQuery (existing ILIKE)
- Response JSON includes `searchMethod: "semantic" | "text"`
- Published-only filter enforced by both service functions
- No console.log in file
</verification>

<success_criteria>
- recommend_skills MCP tool compiles and is registered
- Semantic search with ILIKE fallback works end-to-end
- DISC-01, DISC-05, DISC-06 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/38-conversational-mcp-discovery/38-02-SUMMARY.md`
</output>
