---
phase: 38-conversational-mcp-discovery
plan: 04
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - packages/db/src/services/search-skills.ts
  - apps/mcp/src/tools/search.ts
autonomous: true

must_haves:
  truths:
    - "search_skills returns enhanced metadata including averageRating, totalUses, and qualityTier for each result"
    - "qualityTier is correctly derived: gold (4.0+ stars, 10+ uses), silver (3.0+, 5+), bronze (2.0+), null otherwise"
    - "Existing search_skills functionality (ILIKE matching, field-weighted scoring, published-only filter) is preserved"
  artifacts:
    - path: "packages/db/src/services/search-skills.ts"
      provides: "Enhanced SearchSkillResult with rating/usage/tier metadata"
      exports: ["searchSkillsByQuery", "SearchSkillResult"]
    - path: "apps/mcp/src/tools/search.ts"
      provides: "Enhanced search_skills tool with quality tier in response"
  key_links:
    - from: "packages/db/src/services/search-skills.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "skills.averageRating and skills.totalUses columns in select"
      pattern: "averageRating.*totalUses"
    - from: "apps/mcp/src/tools/search.ts"
      to: "packages/db/src/services/search-skills.ts"
      via: "searchSkillsByQuery import with enhanced results"
      pattern: "searchSkillsByQuery"
---

<objective>
Enhance the existing `search_skills` tool and its underlying service to include richer metadata (ratings, usage stats, quality tier) in responses.

Purpose: DISC-04 (enhanced search metadata)
Output: Enhanced SearchSkillResult type and search_skills response
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@packages/db/src/services/search-skills.ts
@apps/mcp/src/tools/search.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance search service with rating/usage/tier metadata</name>
  <files>packages/db/src/services/search-skills.ts, apps/mcp/src/tools/search.ts</files>
  <action>
**Part A: Update `packages/db/src/services/search-skills.ts`**

1. Expand the `SearchSkillResult` interface to include:
   ```typescript
   export interface SearchSkillResult {
     id: string;
     name: string;
     description: string;
     category: string;
     hoursSaved: number | null;
     slug: string;              // NEW
     averageRating: number | null;  // NEW (raw integer * 100)
     totalUses: number;          // NEW
     qualityTier: string | null; // NEW: "gold" | "silver" | "bronze" | null
   }
   ```

2. Add a pure function `deriveQualityTier` (not exported, local helper):
   ```typescript
   function deriveQualityTier(averageRating: number | null, totalUses: number): string | null {
     if (averageRating !== null && averageRating >= 400 && totalUses >= 10) return "gold";
     if (averageRating !== null && averageRating >= 300 && totalUses >= 5) return "silver";
     if (averageRating !== null && averageRating >= 200) return "bronze";
     return null;
   }
   ```

3. Update the `db.select()` in `searchSkillsByQuery` to include additional fields:
   - Add `skills.slug` to select
   - Add `skills.averageRating` to select
   - Add `skills.totalUses` to select

4. Map results to include qualityTier:
   ```typescript
   return results.map(r => ({
     ...r,
     qualityTier: deriveQualityTier(r.averageRating, r.totalUses),
   }));
   ```

**Part B: Update `apps/mcp/src/tools/search.ts`**

The tool already returns `results` directly as JSON -- the enhanced fields will flow through automatically since SearchSkillResult now includes them. No code change needed in search.ts itself UNLESS you want to format the rating for display.

Add a post-processing step in `handleSearchSkills` to format the rating:
- After getting results, map each result to include `displayRating`:
  ```typescript
  const enriched = results.map(r => ({
    ...r,
    displayRating: r.averageRating !== null ? (r.averageRating / 100).toFixed(1) : null,
  }));
  ```
- Use `enriched` instead of `results` in the JSON response
- Keep the `resultCount` based on `results.length`

This preserves backward compatibility (all existing fields still present) while adding the new metadata.
  </action>
  <verify>
Run `cd /home/dev/projects/relay && pnpm --filter @everyskill/db exec tsc --noEmit` -- no type errors.
Run `cd /home/dev/projects/relay && pnpm build` -- full build passes.
Verify the slug, averageRating, totalUses, qualityTier fields appear in the select by reading the file.
  </verify>
  <done>SearchSkillResult includes slug, averageRating, totalUses, qualityTier; search_skills response includes displayRating; all existing functionality preserved</done>
</task>

</tasks>

<verification>
- SearchSkillResult interface has 9 fields (5 existing + 4 new)
- deriveQualityTier thresholds: gold 400/10, silver 300/5, bronze 200
- searchSkillsByQuery returns enhanced results with qualityTier computed
- search_skills tool response includes displayRating human-readable string
- Published-only filter still present
- Full build passes
</verification>

<success_criteria>
- search_skills responses now include averageRating, totalUses, qualityTier, slug, displayRating
- Quality tier derivation matches spec: gold (4.0+/10 uses), silver (3.0+/5 uses), bronze (2.0+)
- Zero regression in existing search behavior
- DISC-04 requirement addressed
</success_criteria>

<output>
After completion, create `.planning/phases/38-conversational-mcp-discovery/38-04-SUMMARY.md`
</output>
