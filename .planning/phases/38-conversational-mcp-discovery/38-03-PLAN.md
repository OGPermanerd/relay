---
phase: 38-conversational-mcp-discovery
plan: 03
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - apps/mcp/src/tools/describe.ts
  - apps/mcp/src/tools/guide.ts
  - apps/mcp/src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "describe_skill returns comprehensive details for a published skill including AI review scores, ratings, usage stats, fork count, similar skills, and install instructions"
    - "describe_skill returns error for non-published or non-existent skills (never leaks draft/pending data)"
    - "guide_skill returns the skill content plus category-specific usage guidance"
    - "guide_skill returns error for non-published or non-existent skills"
  artifacts:
    - path: "apps/mcp/src/tools/describe.ts"
      provides: "describe_skill MCP tool with rich metadata"
      exports: ["handleDescribeSkill"]
    - path: "apps/mcp/src/tools/guide.ts"
      provides: "guide_skill MCP tool with usage guidance"
      exports: ["handleGuideSkill"]
  key_links:
    - from: "apps/mcp/src/tools/describe.ts"
      to: "packages/db/src/services/skill-reviews.ts"
      via: "getSkillReview for AI scores"
      pattern: "getSkillReview"
    - from: "apps/mcp/src/tools/describe.ts"
      to: "packages/db/src/services/skill-forks.ts"
      via: "getForkCount for fork stats"
      pattern: "getForkCount"
    - from: "apps/mcp/src/tools/describe.ts"
      to: "packages/db/src/services/semantic-search.ts"
      via: "semanticSearchSkills for similar skills"
      pattern: "semanticSearchSkills"
---

<objective>
Create `describe_skill` and `guide_skill` MCP tools for comprehensive skill information and post-install guidance.

Purpose: DISC-02 (rich skill details) and DISC-03 (usage guidance after install)
Output: Two new MCP tools registered with the server
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/38-conversational-mcp-discovery/38-01-SUMMARY.md
@apps/mcp/src/tools/search.ts
@apps/mcp/src/auth.ts
@packages/db/src/services/skill-reviews.ts
@packages/db/src/services/skill-forks.ts
@packages/db/src/services/skill-metrics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create describe_skill MCP tool</name>
  <files>apps/mcp/src/tools/describe.ts, apps/mcp/src/tools/index.ts</files>
  <action>
Create `apps/mcp/src/tools/describe.ts`:

1. Imports:
   - `z` from "zod"
   - `server` from "../server.js"
   - `db` from "@everyskill/db"
   - `skills` from "@everyskill/db/schema/skills"
   - `ratings` from "@everyskill/db/schema/ratings" (for rating count)
   - `eq, and, sql, count` from "drizzle-orm"
   - `getSkillReview` from "@everyskill/db/services/skill-reviews"
   - `getForkCount` from "@everyskill/db/services/skill-forks"
   - `getSkillEmbedding` from "@everyskill/db/services/skill-embeddings"
   - `semanticSearchSkills` from "@everyskill/db/services/semantic-search"
   - `formatRating` from "@everyskill/db/services/skill-metrics"
   - `trackUsage` from "../tracking/events.js"
   - `getUserId, getTenantId` from "../auth.js"

2. Helper function `deriveQualityTier(averageRating: number | null, totalUses: number): string | null`:
   - gold: averageRating >= 400 AND totalUses >= 10
   - silver: averageRating >= 300 AND totalUses >= 5
   - bronze: averageRating >= 200
   - null: insufficient data

3. Export `handleDescribeSkill({ skillId }: { skillId: string })`:
   a. Guard: if (!db) return error
   b. Fetch skill: `db.query.skills.findFirst({ where: and(eq(skills.id, skillId), eq(skills.status, "published")), with: { author: { columns: { id: true, name: true } } } })`
   c. If not found, return `{ error: "Skill not found or not published" }` with isError: true
   d. Run in parallel (Promise.all):
      - `getSkillReview(skillId)` -- AI review scores
      - `getForkCount(skillId)` -- fork count
      - Rating count: `db.select({ count: sql<number>'count(*)::int' }).from(ratings).where(eq(ratings.skillId, skillId))` -- total ratings
      - `getSkillEmbedding(skillId)` -- for similar skills lookup
   e. Similar skills: if embedding exists, call `semanticSearchSkills({ queryEmbedding: embedding.embedding, limit: 4, tenantId: getTenantId() ?? undefined })` then filter out the current skill, take first 3. If no embedding, similar = [].
   f. Build response object:
      ```
      {
        skill: {
          id, name, slug, description, category, tags,
          author: { name },
          hoursSaved,
          totalUses,
          averageRating: formatRating(skill.averageRating),
          ratingCount,
          qualityTier: deriveQualityTier(skill.averageRating, skill.totalUses),
          forkCount,
          createdAt: skill.createdAt.toISOString(),
        },
        aiReview: review ? {
          quality: review.categories.quality,
          clarity: review.categories.clarity,
          completeness: review.categories.completeness,
          summary: review.summary,
        } : null,
        similarSkills: similarResults.map(s => ({
          id: s.id, name: s.name, slug: s.slug,
          similarity: s.similarity.toFixed(2),
        })),
        install: {
          mcpCommand: `Use deploy_skill with ID "${skillId}" to install this skill`,
        },
      }
      ```
   g. Track usage: `await trackUsage({ toolName: "describe_skill", skillId, userId: getUserId() ?? undefined, metadata: { skillName: skill.name } })`
   h. Return `{ content: [{ type: "text", text: JSON.stringify(response, null, 2) }] }`

4. Register tool:
   ```
   server.registerTool("describe_skill", {
     description: "Get comprehensive details about a skill including AI review scores, ratings, usage statistics, similar skills, and install instructions. Use a skill ID from search_skills or recommend_skills results.",
     inputSchema: {
       skillId: z.string().describe("Skill ID to describe"),
     },
   }, async ({ skillId }) => handleDescribeSkill({ skillId }));
   ```

5. Add `import "./describe.js";` to `apps/mcp/src/tools/index.ts`

CRITICAL: Only return data for published skills. No console.log.
  </action>
  <verify>Run `cd /home/dev/projects/relay/apps/mcp && npx tsc --noEmit 2>&1 | grep "describe"` -- should return no errors.</verify>
  <done>describe_skill returns skill details, AI review scores, ratings, fork count, similar skills, install instructions; returns error for non-published skills</done>
</task>

<task type="auto">
  <name>Task 2: Create guide_skill MCP tool</name>
  <files>apps/mcp/src/tools/guide.ts, apps/mcp/src/tools/index.ts</files>
  <action>
Create `apps/mcp/src/tools/guide.ts`:

1. Imports:
   - `z` from "zod"
   - `server` from "../server.js"
   - `db` from "@everyskill/db"
   - `skills` from "@everyskill/db/schema/skills"
   - `eq, and` from "drizzle-orm"
   - `trackUsage` from "../tracking/events.js"
   - `getUserId, getTenantId` from "../auth.js"

2. Helper function `getCategoryGuidance(category: string): string`:
   Returns category-specific usage tips:
   - "prompt": "This is a prompt skill. To use it:\n1. Copy the content below into your conversation\n2. Customize any placeholder values marked with [brackets]\n3. The prompt will guide Claude's response format and approach"
   - "workflow": "This is a workflow skill. To use it:\n1. Follow the steps outlined in the content below\n2. Each step builds on the previous one\n3. Adapt the workflow to your specific context"
   - "agent": "This is an agent configuration. To use it:\n1. The content defines Claude's behavior and capabilities\n2. It will be active for the duration of your conversation\n3. You can reference the agent's specific instructions as needed"
   - "mcp": "This is an MCP tool skill. To use it:\n1. The skill is already installed and available as an MCP tool\n2. You can invoke it directly in conversation\n3. Check the content below for usage examples and parameters"
   - default: "Review the skill content below for usage instructions."

3. Export `handleGuideSkill({ skillId }: { skillId: string })`:
   a. Guard: if (!db) return error
   b. Fetch skill: `db.query.skills.findFirst({ where: and(eq(skills.id, skillId), eq(skills.status, "published")), columns: { id: true, name: true, slug: true, category: true, content: true, hoursSaved: true, tags: true } })`
      - Add tenantId filter if getTenantId() is not null
   c. If not found, return `{ error: "Skill not found or not published" }` with isError: true
   d. Build response:
      ```
      {
        skill: { id, name, category },
        guidance: getCategoryGuidance(skill.category),
        estimatedTimeSaved: `${skill.hoursSaved ?? 1} hour(s) per use`,
        tags: skill.tags ?? [],
        content: skill.content,
        tips: [
          "Rate this skill after use to help others discover quality content",
          "Fork this skill if you want to customize it for your specific needs",
          "Usage is automatically tracked when deployed via MCP",
        ],
      }
      ```
   e. Track usage: `await trackUsage({ toolName: "guide_skill", skillId, userId: getUserId() ?? undefined, metadata: { skillName: skill.name } })`
   f. Return `{ content: [{ type: "text", text: JSON.stringify(response, null, 2) }] }`

4. Register tool:
   ```
   server.registerTool("guide_skill", {
     description: "Get usage guidance and implementation instructions for an installed skill. Returns the skill content along with category-specific tips on how to use it effectively.",
     inputSchema: {
       skillId: z.string().describe("Skill ID to get guidance for"),
     },
   }, async ({ skillId }) => handleGuideSkill({ skillId }));
   ```

5. Add `import "./guide.js";` to `apps/mcp/src/tools/index.ts` (after the describe import added in Task 1)

CRITICAL: Only return data for published skills. No console.log.
  </action>
  <verify>Run `cd /home/dev/projects/relay/apps/mcp && npx tsc --noEmit 2>&1 | grep "guide"` -- should return no errors. Then `cd /home/dev/projects/relay && pnpm build` to verify full build.</verify>
  <done>guide_skill returns skill content, category-specific guidance, and usage tips; returns error for non-published skills</done>
</task>

</tasks>

<verification>
- describe_skill registered and returns: skill details, AI review scores (quality/clarity/completeness), averageRating, totalUses, forkCount, similar skills, install command
- guide_skill registered and returns: skill content, category-specific guidance text, tips
- Both tools filter by status='published' and return isError for non-published/missing skills
- Both tools imported in index.ts
- No console.log in either file
- Full build passes
</verification>

<success_criteria>
- describe_skill and guide_skill MCP tools compile and register
- describe_skill aggregates data from 4+ services (skill, review, forks, embeddings)
- guide_skill returns skill content with contextual guidance
- DISC-02 and DISC-03 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/38-conversational-mcp-discovery/38-03-SUMMARY.md`
</output>
