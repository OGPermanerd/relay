---
phase: 04-data-model-storage
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/db/src/relations/index.ts
  - packages/db/src/client.ts
  - packages/db/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Drizzle relations enable type-safe nested queries"
    - "db.query.skills supports with: { versions, publishedVersion, author }"
    - "db.query.skillVersions supports with: { skill, createdBy }"
    - "db.query.ratings supports with: { skill, user }"
  artifacts:
    - path: "packages/db/src/relations/index.ts"
      provides: "Drizzle relation definitions"
      exports: ["skillsRelations", "skillVersionsRelations", "ratingsRelations", "usersRelations"]
    - path: "packages/db/src/client.ts"
      provides: "Drizzle client with relations"
      contains: "drizzle(client, { schema:"
  key_links:
    - from: "packages/db/src/relations/index.ts"
      to: "packages/db/src/schema/index.ts"
      via: "import schema tables"
      pattern: "import.*from.*schema"
    - from: "packages/db/src/client.ts"
      to: "packages/db/src/relations/index.ts"
      via: "import relations"
      pattern: "import.*relations"
---

<objective>
Add Drizzle relations for type-safe nested queries

Purpose: Relations enable db.query.skills.findFirst({ with: { author, versions } }) pattern without manual joins. This is critical for fetching skills with their version history efficiently.
Output: Relations definitions and updated client with relational query support
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-data-model-storage/04-RESEARCH.md

@packages/db/src/schema/skills.ts
@packages/db/src/schema/skill-versions.ts
@packages/db/src/schema/ratings.ts
@packages/db/src/schema/users.ts
@packages/db/src/schema/usage-events.ts
@packages/db/src/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Drizzle relations definitions</name>
  <files>
    packages/db/src/relations/index.ts
  </files>
  <action>
Create packages/db/src/relations/ directory.

Create relations/index.ts with Drizzle v2 relations API:

```typescript
import { relations } from "drizzle-orm";
import { skills, skillVersions, ratings, users, usageEvents } from "../schema";

/**
 * Skills relations
 * - author: one-to-one with users
 * - versions: one-to-many with skillVersions
 * - publishedVersion: one-to-one with skillVersions (nullable)
 * - ratings: one-to-many with ratings
 * - usageEvents: one-to-many with usageEvents
 */
export const skillsRelations = relations(skills, ({ one, many }) => ({
  author: one(users, {
    fields: [skills.authorId],
    references: [users.id],
  }),
  versions: many(skillVersions),
  publishedVersion: one(skillVersions, {
    fields: [skills.publishedVersionId],
    references: [skillVersions.id],
    relationName: "publishedVersion",
  }),
  draftVersion: one(skillVersions, {
    fields: [skills.draftVersionId],
    references: [skillVersions.id],
    relationName: "draftVersion",
  }),
  ratings: many(ratings),
  usageEvents: many(usageEvents),
}));

/**
 * SkillVersions relations
 * - skill: many-to-one with skills
 * - createdByUser: one-to-one with users
 */
export const skillVersionsRelations = relations(skillVersions, ({ one }) => ({
  skill: one(skills, {
    fields: [skillVersions.skillId],
    references: [skills.id],
  }),
  createdByUser: one(users, {
    fields: [skillVersions.createdBy],
    references: [users.id],
  }),
}));

/**
 * Ratings relations
 * - skill: many-to-one with skills
 * - user: many-to-one with users
 */
export const ratingsRelations = relations(ratings, ({ one }) => ({
  skill: one(skills, {
    fields: [ratings.skillId],
    references: [skills.id],
  }),
  user: one(users, {
    fields: [ratings.userId],
    references: [users.id],
  }),
}));

/**
 * Users relations
 * - skills: one-to-many skills authored
 * - skillVersions: one-to-many versions created
 * - ratings: one-to-many ratings given
 * - usageEvents: one-to-many usage events
 */
export const usersRelations = relations(users, ({ many }) => ({
  skills: many(skills),
  skillVersions: many(skillVersions),
  ratings: many(ratings),
  usageEvents: many(usageEvents),
}));

/**
 * UsageEvents relations
 * - skill: many-to-one with skills (nullable)
 * - user: many-to-one with users (nullable)
 */
export const usageEventsRelations = relations(usageEvents, ({ one }) => ({
  skill: one(skills, {
    fields: [usageEvents.skillId],
    references: [skills.id],
  }),
  user: one(users, {
    fields: [usageEvents.userId],
    references: [users.id],
  }),
}));
```

Note: Drizzle v2 relations use the object destructuring syntax ({ one, many }) instead of r.one/r.many from older examples.
  </action>
  <verify>
    pnpm --filter @relay/db typecheck
  </verify>
  <done>
    relations/index.ts exports all relation definitions, TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update client and package exports</name>
  <files>
    packages/db/src/client.ts
    packages/db/src/index.ts
  </files>
  <action>
Update client.ts to include relations in drizzle schema:

```typescript
/**
 * Database client setup with Drizzle ORM
 */

import { drizzle } from "drizzle-orm/postgres-js";
import postgres from "postgres";
import * as schema from "./schema";
import * as relations from "./relations";

// Connection string from environment
const connectionString = process.env.DATABASE_URL;

// Create postgres client (lazy initialization)
const client = connectionString ? postgres(connectionString) : null;

// Create drizzle instance with schema AND relations for type-safe queries
// Merging schema and relations enables db.query.* relational queries
export const db = client
  ? drizzle(client, { schema: { ...schema, ...relations } })
  : null;

// Helper for checking database connection
export function isDatabaseConfigured(): boolean {
  return !!connectionString && !!client;
}
```

Update index.ts to export relations:

Add after existing exports:
```typescript
export * from "./relations";
```

This enables consumers to import relation types if needed.
  </action>
  <verify>
    pnpm --filter @relay/db typecheck && pnpm --filter @relay/db lint
  </verify>
  <done>
    client.ts includes relations in drizzle schema, index.ts exports relations, db.query.* supports relational queries, typecheck and lint pass
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm --filter @relay/db typecheck` - should pass
2. Run `pnpm --filter @relay/db lint` - should pass
3. Verify relations/index.ts exports skillsRelations, skillVersionsRelations, ratingsRelations, usersRelations, usageEventsRelations
4. Verify client.ts merges schema and relations: `{ ...schema, ...relations }`
5. Verify index.ts exports relations module
</verification>

<success_criteria>
- [ ] packages/db/src/relations/index.ts exists with all relation definitions
- [ ] skillsRelations defines author, versions, publishedVersion, draftVersion, ratings, usageEvents
- [ ] skillVersionsRelations defines skill, createdByUser
- [ ] ratingsRelations defines skill, user
- [ ] usersRelations defines skills, skillVersions, ratings, usageEvents
- [ ] usageEventsRelations defines skill, user
- [ ] client.ts merges schema and relations for db instance
- [ ] TypeScript compiles without errors
- [ ] ESLint passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-model-storage/04-03-SUMMARY.md`
</output>
