---
phase: 04-data-model-storage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/skills.ts
  - packages/db/src/schema/skill-versions.ts
  - packages/db/src/schema/ratings.ts
  - packages/db/src/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "skillVersions table stores immutable version records"
    - "skills table has publishedVersionId and draftVersionId references"
    - "ratings table supports 1-5 star ratings with optional comments"
    - "Schema compiles without type errors"
  artifacts:
    - path: "packages/db/src/schema/skill-versions.ts"
      provides: "Immutable version records with content URL, hash, metadata"
      exports: ["skillVersions", "SkillVersion", "NewSkillVersion"]
    - path: "packages/db/src/schema/ratings.ts"
      provides: "Skill ratings with user reference"
      exports: ["ratings", "Rating", "NewRating"]
    - path: "packages/db/src/schema/skills.ts"
      provides: "Extended skills table with version references"
      contains: "publishedVersionId"
  key_links:
    - from: "packages/db/src/schema/skill-versions.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "skillId foreign key"
      pattern: "references.*skills\\.id"
    - from: "packages/db/src/schema/ratings.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "skillId foreign key"
      pattern: "references.*skills\\.id"
---

<objective>
Create the versioned data model with immutable skillVersions and ratings tables

Purpose: Enable wiki-style versioning where new versions create records (never modify) and users can rate skills. This is the foundation for all skill management features.
Output: Extended schema files ready for database push
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-data-model-storage/04-RESEARCH.md

@packages/db/src/schema/skills.ts
@packages/db/src/schema/users.ts
@packages/db/src/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create skillVersions and ratings tables</name>
  <files>
    packages/db/src/schema/skill-versions.ts
    packages/db/src/schema/ratings.ts
  </files>
  <action>
Create skill-versions.ts with immutable version records:
- id: text primary key with UUID default
- skillId: text, references skills.id with onDelete: cascade
- version: integer, sequential version number (1, 2, 3...)
- contentUrl: text, R2 object key for skill content
- contentHash: text, SHA-256 hash for integrity verification
- contentType: text, MIME type (text/markdown, application/json)
- name: text, snapshot of name at version creation
- description: text, snapshot of description at version creation
- metadata: jsonb for format-specific data (optional)
- createdBy: text, references users.id
- createdAt: timestamp with timezone, precision 3, defaultNow

Create ratings.ts:
- id: text primary key with UUID default
- skillId: text, references skills.id with onDelete: cascade
- userId: text, references users.id with onDelete: cascade
- rating: integer (1-5 constraint NOT needed at schema level, enforce in app)
- comment: text (optional)
- hoursSavedEstimate: integer (optional, user's estimate of time saved)
- createdAt: timestamp with timezone, precision 3, defaultNow

Export types: SkillVersion, NewSkillVersion, Rating, NewRating

Follow existing patterns in skills.ts and users.ts for timestamp format and ID generation.
  </action>
  <verify>
    pnpm --filter @everyskill/db typecheck
  </verify>
  <done>
    skill-versions.ts and ratings.ts exist with correct schema definitions, types exported, no TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend skills table and update exports</name>
  <files>
    packages/db/src/schema/skills.ts
    packages/db/src/schema/index.ts
  </files>
  <action>
Update skills.ts:
1. Add publishedVersionId: text (optional, references skillVersions.id - but we can't add FK here due to circular reference, will handle in relations)
2. Add draftVersionId: text (optional, same pattern)
3. Add totalUses: integer default 0 (denormalized aggregate from usageEvents)
4. Add averageRating: integer (optional, denormalized aggregate from ratings, stored as rating * 100 for precision)
5. Keep existing content field for now (backward compatibility with MCP tools), mark with comment that it will be deprecated after migration

DO NOT remove the existing content field yet - the MCP tools use it. We'll migrate in a later plan.

Update index.ts:
- Add exports for skill-versions and ratings modules

Ensure all imports resolve correctly (users import for references).
  </action>
  <verify>
    pnpm --filter @everyskill/db typecheck && pnpm --filter @everyskill/db lint
  </verify>
  <done>
    skills.ts has version reference fields and denormalized counters, index.ts exports all schema modules, lint and typecheck pass
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm --filter @everyskill/db typecheck` - should pass
2. Run `pnpm --filter @everyskill/db lint` - should pass
3. Verify skill-versions.ts exports skillVersions table and types
4. Verify ratings.ts exports ratings table and types
5. Verify skills.ts has publishedVersionId, draftVersionId, totalUses, averageRating fields
6. Verify index.ts re-exports all new modules
</verification>

<success_criteria>
- [ ] skillVersions table defined with all required fields (id, skillId, version, contentUrl, contentHash, contentType, name, description, metadata, createdBy, createdAt)
- [ ] ratings table defined with all required fields (id, skillId, userId, rating, comment, hoursSavedEstimate, createdAt)
- [ ] skills table extended with publishedVersionId, draftVersionId, totalUses, averageRating
- [ ] All schema files export table definitions and inferred types
- [ ] TypeScript compiles without errors
- [ ] ESLint passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-model-storage/04-01-SUMMARY.md`
</output>
