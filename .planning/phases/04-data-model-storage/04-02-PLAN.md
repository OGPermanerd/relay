---
phase: 04-data-model-storage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/storage/package.json
  - packages/storage/tsconfig.json
  - packages/storage/src/index.ts
  - packages/storage/src/r2-client.ts
  - packages/storage/src/presigned-urls.ts
  - pnpm-workspace.yaml
autonomous: true

user_setup:
  - service: cloudflare-r2
    why: "Object storage for skill content"
    env_vars:
      - name: R2_ENDPOINT
        source: "Cloudflare Dashboard -> R2 -> Overview -> S3 API endpoint (format: https://<account-id>.r2.cloudflarestorage.com)"
      - name: R2_ACCESS_KEY_ID
        source: "Cloudflare Dashboard -> R2 -> Manage R2 API Tokens -> Create API token"
      - name: R2_SECRET_ACCESS_KEY
        source: "Same as above, shown once on creation"
      - name: R2_BUCKET_NAME
        source: "Cloudflare Dashboard -> R2 -> Create bucket (e.g., 'everyskill-skills')"
    dashboard_config:
      - task: "Create R2 bucket"
        location: "Cloudflare Dashboard -> R2 -> Create bucket"
      - task: "Configure CORS for browser uploads"
        location: "Cloudflare Dashboard -> R2 -> [bucket] -> Settings -> CORS policy"

must_haves:
  truths:
    - "R2 client can generate upload presigned URLs"
    - "R2 client can generate download presigned URLs"
    - "Storage package exports typed functions for skill content operations"
  artifacts:
    - path: "packages/storage/src/r2-client.ts"
      provides: "S3Client configured for R2"
      exports: ["getR2Client", "isStorageConfigured"]
    - path: "packages/storage/src/presigned-urls.ts"
      provides: "Presigned URL generation functions"
      exports: ["generateUploadUrl", "generateDownloadUrl"]
    - path: "packages/storage/src/index.ts"
      provides: "Package entry point"
      exports: ["generateUploadUrl", "generateDownloadUrl", "isStorageConfigured"]
  key_links:
    - from: "packages/storage/src/presigned-urls.ts"
      to: "packages/storage/src/r2-client.ts"
      via: "import getR2Client"
      pattern: "import.*getR2Client"
---

<objective>
Create the storage package for R2 object storage integration

Purpose: Skill content (especially larger content like workflows) should be stored in object storage, not in the database. R2 provides S3-compatible storage with Cloudflare's edge network.
Output: @everyskill/storage package with presigned URL generation for uploads and downloads
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-data-model-storage/04-RESEARCH.md

@packages/db/package.json (for reference on package structure)
@pnpm-workspace.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold storage package</name>
  <files>
    packages/storage/package.json
    packages/storage/tsconfig.json
    packages/storage/src/index.ts
    pnpm-workspace.yaml
  </files>
  <action>
Create packages/storage/ directory structure.

Create package.json:
- name: "@everyskill/storage"
- version: "0.0.1"
- private: true
- main: "./src/index.ts"
- types: "./src/index.ts"
- exports pattern matching @everyskill/db
- dependencies:
  - @aws-sdk/client-s3: ^3.700.0
  - @aws-sdk/s3-request-presigner: ^3.700.0
- devDependencies:
  - typescript: ^5.7.0
  - @types/node: ^22.10.0
- scripts:
  - typecheck: tsc --noEmit
  - lint: eslint .

Create tsconfig.json extending ../../tsconfig.json (copy pattern from @everyskill/db).

Create src/index.ts as placeholder export file.

Verify pnpm-workspace.yaml already includes packages/* pattern (it should, but verify).

Run pnpm install to link the new package.
  </action>
  <verify>
    pnpm install && pnpm --filter @everyskill/storage typecheck
  </verify>
  <done>
    packages/storage/ exists with package.json, tsconfig.json, src/index.ts; pnpm install succeeds; typecheck passes (may be trivial with empty exports)
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement R2 client and presigned URL functions</name>
  <files>
    packages/storage/src/r2-client.ts
    packages/storage/src/presigned-urls.ts
    packages/storage/src/index.ts
  </files>
  <action>
Create r2-client.ts:
```typescript
import { S3Client } from "@aws-sdk/client-s3";

// Lazy-initialized client
let client: S3Client | null = null;

export function getR2Client(): S3Client | null {
  if (client) return client;

  const endpoint = process.env.R2_ENDPOINT;
  const accessKeyId = process.env.R2_ACCESS_KEY_ID;
  const secretAccessKey = process.env.R2_SECRET_ACCESS_KEY;

  if (!endpoint || !accessKeyId || !secretAccessKey) {
    return null;
  }

  client = new S3Client({
    region: "auto",
    endpoint,
    credentials: { accessKeyId, secretAccessKey },
  });

  return client;
}

export function isStorageConfigured(): boolean {
  return !!(
    process.env.R2_ENDPOINT &&
    process.env.R2_ACCESS_KEY_ID &&
    process.env.R2_SECRET_ACCESS_KEY &&
    process.env.R2_BUCKET_NAME
  );
}
```

Create presigned-urls.ts:
```typescript
import { PutObjectCommand, GetObjectCommand } from "@aws-sdk/client-s3";
import { getSignedUrl } from "@aws-sdk/s3-request-presigner";
import { getR2Client } from "./r2-client";

const BUCKET = () => process.env.R2_BUCKET_NAME!;
const DEFAULT_EXPIRY = 3600; // 1 hour

export interface UploadUrlResult {
  uploadUrl: string;
  objectKey: string;
}

/**
 * Generate presigned URL for uploading skill content
 * Key pattern: skills/{skillId}/v{version}/content
 */
export async function generateUploadUrl(
  skillId: string,
  version: number,
  contentType: string
): Promise<UploadUrlResult | null> {
  const client = getR2Client();
  if (!client) return null;

  const objectKey = `skills/${skillId}/v${version}/content`;

  const command = new PutObjectCommand({
    Bucket: BUCKET(),
    Key: objectKey,
    ContentType: contentType,
  });

  const uploadUrl = await getSignedUrl(client, command, { expiresIn: DEFAULT_EXPIRY });

  return { uploadUrl, objectKey };
}

/**
 * Generate presigned URL for downloading skill content
 */
export async function generateDownloadUrl(objectKey: string): Promise<string | null> {
  const client = getR2Client();
  if (!client) return null;

  const command = new GetObjectCommand({
    Bucket: BUCKET(),
    Key: objectKey,
  });

  return getSignedUrl(client, command, { expiresIn: DEFAULT_EXPIRY });
}
```

Update src/index.ts:
```typescript
export { getR2Client, isStorageConfigured } from "./r2-client";
export { generateUploadUrl, generateDownloadUrl } from "./presigned-urls";
export type { UploadUrlResult } from "./presigned-urls";
```

Follow graceful null-handling pattern from @everyskill/db (returns null when not configured).
  </action>
  <verify>
    pnpm --filter @everyskill/storage typecheck && pnpm --filter @everyskill/storage lint
  </verify>
  <done>
    r2-client.ts and presigned-urls.ts implement R2 integration with graceful null handling, index.ts exports all public functions, typecheck and lint pass
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm --filter @everyskill/storage typecheck` - should pass
2. Run `pnpm --filter @everyskill/storage lint` - should pass
3. Verify isStorageConfigured() returns false when env vars not set
4. Verify generateUploadUrl and generateDownloadUrl are exported from index.ts
5. Run `pnpm turbo build` to ensure package integrates with monorepo build
</verification>

<success_criteria>
- [ ] packages/storage/ exists with proper package.json and tsconfig.json
- [ ] @aws-sdk/client-s3 and @aws-sdk/s3-request-presigner installed
- [ ] r2-client.ts exports getR2Client() and isStorageConfigured()
- [ ] presigned-urls.ts exports generateUploadUrl() and generateDownloadUrl()
- [ ] Functions return null gracefully when R2 not configured
- [ ] TypeScript compiles without errors
- [ ] ESLint passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-model-storage/04-02-SUMMARY.md`
</output>
