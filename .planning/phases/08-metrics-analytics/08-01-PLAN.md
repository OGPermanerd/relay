---
phase: 08-metrics-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/platform-stats.ts
autonomous: true

must_haves:
  truths:
    - "getPlatformStats returns totalContributors count"
    - "getPlatformStats returns totalDownloads (sum of all skill uses)"
    - "getPlatformStats returns totalUses (same as downloads)"
    - "getPlatformStats returns totalFteDaysSaved aggregated from all skills"
  artifacts:
    - path: "apps/web/lib/platform-stats.ts"
      provides: "Platform-wide statistics aggregation"
      exports: ["getPlatformStats", "PlatformStats"]
      min_lines: 40
  key_links:
    - from: "apps/web/lib/platform-stats.ts"
      to: "@relay/db"
      via: "Drizzle query for skills and users"
      pattern: "from\\(skills\\)"
---

<objective>
Create platform-wide statistics aggregation service

Purpose: Aggregate all skill metrics to show total platform value (contributors, uses, FTE Days Saved)
Output: apps/web/lib/platform-stats.ts with getPlatformStats function
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-metrics-analytics/08-RESEARCH.md

# Key existing patterns
@apps/web/lib/skill-stats.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform statistics service</name>
  <files>apps/web/lib/platform-stats.ts</files>
  <action>
Create platform-stats.ts following the research Pattern 4 (Platform-Wide Aggregations from Denormalized Fields).

Implementation:
1. Export PlatformStats interface with:
   - totalContributors: number
   - totalDownloads: number
   - totalUses: number
   - totalFteDaysSaved: number

2. Export async function getPlatformStats(): Promise<PlatformStats>

3. Handle null db case - return all zeros (follow existing pattern in skill-stats.ts)

4. Use two parallel queries with Promise.all:
   - Query 1 (skillStats): SELECT SUM(total_uses), SUM(total_uses * hours_saved) / 8.0 FROM skills WHERE published_version_id IS NOT NULL
   - Query 2 (userStats): SELECT COUNT(DISTINCT users.id) FROM users INNER JOIN skills ON author_id = users.id WHERE published_version_id IS NOT NULL

5. Use COALESCE to handle NULL values in SQL
   - sql`COALESCE(SUM(${skills.totalUses}), 0)`
   - sql`COALESCE(SUM(${skills.totalUses} * ${skills.hoursSaved}) / 8.0, 0)`

6. Round totalFteDaysSaved to 1 decimal: Math.round(value * 10) / 10

Import from @relay/db and @relay/db/schema following existing patterns.
  </action>
  <verify>
Run `cd /home/claude/projects/relay && pnpm tsc --noEmit -p apps/web/tsconfig.json` - no type errors
  </verify>
  <done>
getPlatformStats function exists and exports correctly, compiles without errors, returns PlatformStats with 4 numeric fields
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `pnpm tsc --noEmit -p apps/web/tsconfig.json`
2. File exists at apps/web/lib/platform-stats.ts
3. Exports getPlatformStats and PlatformStats type
</verification>

<success_criteria>
- Platform stats service created with correct aggregation queries
- Handles null db gracefully (returns zeros)
- Uses COALESCE to prevent NULL arithmetic issues
- Only counts published skills (publishedVersionId IS NOT NULL)
</success_criteria>

<output>
After completion, create `.planning/phases/08-metrics-analytics/08-01-SUMMARY.md`
</output>
