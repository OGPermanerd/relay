---
phase: 08-metrics-analytics
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/user-stats.ts
  - apps/web/app/(protected)/profile/page.tsx
autonomous: true

must_haves:
  truths:
    - "User profile displays real skillsShared count"
    - "User profile displays real totalUses count"
    - "User profile displays real avgRating (or dash if none)"
    - "User profile displays real fteDaysSaved value"
  artifacts:
    - path: "apps/web/lib/user-stats.ts"
      provides: "User-specific contribution statistics"
      exports: ["getUserStats", "UserStats"]
      min_lines: 40
    - path: "apps/web/app/(protected)/profile/page.tsx"
      provides: "Profile page with real statistics"
      min_lines: 50
  key_links:
    - from: "apps/web/app/(protected)/profile/page.tsx"
      to: "apps/web/lib/user-stats.ts"
      via: "getUserStats import and call"
      pattern: "getUserStats\\(session\\.user\\.id"
---

<objective>
Complete user profile statistics with real data

Purpose: Replace placeholder profile stats with actual contribution data from database
Output: apps/web/lib/user-stats.ts + updated profile page
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-metrics-analytics/08-RESEARCH.md

# Existing files to update
@apps/web/app/(protected)/profile/page.tsx
@apps/web/lib/skill-stats.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user statistics service</name>
  <files>apps/web/lib/user-stats.ts</files>
  <action>
Create user-stats.ts following research Pattern 5 (User Profile Statistics Aggregation).

Implementation:
1. Export UserStats interface with:
   - skillsShared: number
   - totalUses: number
   - avgRating: string | null (formatted "4.5" or null)
   - fteDaysSaved: number

2. Export async function getUserStats(userId: string): Promise<UserStats>

3. Handle null db case - return default values:
   { skillsShared: 0, totalUses: 0, avgRating: null, fteDaysSaved: 0 }

4. Use Drizzle query builder:

```typescript
const result = await db
  .select({
    skillsShared: sql<number>`COUNT(DISTINCT ${skills.id})`,
    totalUses: sql<number>`COALESCE(SUM(${skills.totalUses}), 0)`,
    avgRating: sql<string>`AVG(${skills.averageRating})`,
    fteDaysSaved: sql<number>`COALESCE(SUM(${skills.totalUses} * ${skills.hoursSaved}) / 8.0, 0)`,
  })
  .from(skills)
  .where(
    and(
      eq(skills.authorId, userId),
      isNotNull(skills.publishedVersionId)
    )
  );
```

5. Parse avgRating with parseFloat (avg() returns string in Drizzle)
   - If non-null, divide by 100 and format with .toFixed(1)
   - Return null if no ratings

6. Round fteDaysSaved to 1 decimal: Math.round(value * 10) / 10

Import from drizzle-orm: sql, eq, and, isNotNull
Import from @everyskill/db and @everyskill/db/schema
  </action>
  <verify>
Run `cd /home/claude/projects/relay && pnpm tsc --noEmit -p apps/web/tsconfig.json` - no type errors
  </verify>
  <done>
getUserStats function exists, compiles without errors, aggregates user's skill statistics correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Update profile page with real statistics</name>
  <files>apps/web/app/(protected)/profile/page.tsx</files>
  <action>
Update profile page to fetch and display real user statistics.

Changes:
1. Import getUserStats from "@/lib/user-stats"

2. After auth check, call getUserStats:
   const userStats = await getUserStats(session.user.id);

3. Replace hardcoded stats array with data from userStats:

```typescript
const stats = [
  {
    label: "Skills Shared",
    value: userStats.skillsShared.toString(),
    description: "Skills you've contributed"
  },
  {
    label: "Total Uses",
    value: userStats.totalUses.toString(),
    description: "Times your skills were used"
  },
  {
    label: "Avg Rating",
    value: userStats.avgRating ?? "-",
    description: "Average rating received"
  },
  {
    label: "FTE Days Saved",
    value: userStats.fteDaysSaved.toString(),
    description: "Days saved for the org"
  },
];
```

4. Keep all existing UI structure and styling unchanged - only data source changes
  </action>
  <verify>
Run `cd /home/claude/projects/relay && pnpm tsc --noEmit -p apps/web/tsconfig.json` - no type errors
  </verify>
  <done>
Profile page imports getUserStats and displays real statistics from database
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `pnpm tsc --noEmit -p apps/web/tsconfig.json`
2. apps/web/lib/user-stats.ts exists with getUserStats export
3. Profile page imports and uses getUserStats
</verification>

<success_criteria>
- User stats service created with correct aggregation query
- Profile page shows real statistics instead of placeholder zeros
- avgRating displays "-" when no ratings exist
- Only counts published skills in statistics
</success_criteria>

<output>
After completion, create `.planning/phases/08-metrics-analytics/08-05-SUMMARY.md`
</output>
