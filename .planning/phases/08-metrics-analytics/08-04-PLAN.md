---
phase: 08-metrics-analytics
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/leaderboard.ts
autonomous: true

must_haves:
  truths:
    - "getLeaderboard returns contributors ranked by FTE Days Saved"
    - "Each entry shows rank, name, image, skillsShared, totalUses, avgRating, fteDaysSaved"
    - "Only contributors with published skills appear on leaderboard"
    - "Rankings use PostgreSQL RANK() window function"
  artifacts:
    - path: "apps/web/lib/leaderboard.ts"
      provides: "Contributor ranking with window functions"
      exports: ["getLeaderboard", "LeaderboardEntry"]
      min_lines: 60
  key_links:
    - from: "apps/web/lib/leaderboard.ts"
      to: "@everyskill/db"
      via: "Raw SQL CTE with RANK() window function"
      pattern: "RANK\\(\\) OVER"
---

<objective>
Create contributor leaderboard with PostgreSQL window functions

Purpose: Rank top contributors by FTE Days Saved to recognize and incentivize skill sharing
Output: apps/web/lib/leaderboard.ts with getLeaderboard function
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-metrics-analytics/08-RESEARCH.md

# Key existing patterns
@apps/web/lib/skill-stats.ts
@packages/db/src/schema/users.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create leaderboard service</name>
  <files>apps/web/lib/leaderboard.ts</files>
  <action>
Create leaderboard.ts following research Pattern 2 (PostgreSQL Window Functions for Leaderboards).

Implementation:
1. Export LeaderboardEntry interface with:
   - rank: number
   - userId: string
   - name: string
   - image: string | null
   - skillsShared: number
   - totalUses: number
   - avgRating: string | null (formatted "4.5" or null)
   - fteDaysSaved: number

2. Export async function getLeaderboard(limit: number = 10): Promise<LeaderboardEntry[]>

3. Handle null db case - return empty array

4. Use raw SQL with db.execute(sql`...`) for the CTE query:

```sql
WITH contributor_stats AS (
  SELECT
    u.id as user_id,
    u.name,
    u.image,
    COUNT(DISTINCT s.id) as skills_shared,
    COALESCE(SUM(s.total_uses), 0) as total_uses,
    COALESCE(AVG(s.average_rating), 0) as avg_rating,
    COALESCE(SUM(s.total_uses * s.hours_saved) / 8.0, 0) as fte_days_saved
  FROM users u
  LEFT JOIN skills s ON s.author_id = u.id
    AND s.published_version_id IS NOT NULL
  GROUP BY u.id, u.name, u.image
)
SELECT
  RANK() OVER (ORDER BY fte_days_saved DESC, skills_shared DESC) as rank,
  user_id,
  name,
  image,
  skills_shared::integer,
  total_uses::integer,
  CASE
    WHEN avg_rating > 0 THEN (avg_rating / 100)::numeric(3,1)::text
    ELSE NULL
  END as avg_rating,
  ROUND(fte_days_saved::numeric, 1)::double precision as fte_days_saved
FROM contributor_stats
WHERE skills_shared > 0
ORDER BY rank
LIMIT ${limit}
```

Key implementation notes:
- Use LEFT JOIN to include all users, then filter WHERE skills_shared > 0
- RANK() creates gaps for ties (1, 1, 3), which is acceptable per research
- Secondary sort by skills_shared for tie-breaking
- avg_rating is stored as integer * 100, divide by 100 for display
- Cast to appropriate types for TypeScript compatibility

5. Return results.rows cast to LeaderboardEntry[]
  </action>
  <verify>
Run `cd /home/claude/projects/relay && pnpm tsc --noEmit -p apps/web/tsconfig.json` - no type errors
  </verify>
  <done>
getLeaderboard function exists, compiles without errors, uses RANK() window function with proper tie-breaking
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `pnpm tsc --noEmit -p apps/web/tsconfig.json`
2. File exists at apps/web/lib/leaderboard.ts
3. Exports getLeaderboard and LeaderboardEntry type
</verification>

<success_criteria>
- Leaderboard service created with RANK() window function
- Primary ranking by FTE Days Saved, secondary by skills shared
- Only includes contributors with published skills
- Formats average rating as "4.5" string
- Handles null db gracefully (returns empty array)
</success_criteria>

<output>
After completion, create `.planning/phases/08-metrics-analytics/08-04-SUMMARY.md`
</output>
