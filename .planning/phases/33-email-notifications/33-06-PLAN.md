---
phase: 33-email-notifications
plan: 06
type: execute
wave: 3
depends_on: ["33-02", "33-03"]
files_modified:
  - apps/web/app/actions/skill-messages.ts
  - apps/web/lib/notifications.ts
autonomous: true

must_haves:
  truths:
    - "When sendGroupingProposal succeeds, an in-app notification is created for the recipient"
    - "When sendGroupingProposal succeeds, a stubbed email is logged to console for the recipient"
    - "Notifications respect user preferences (skip if user disabled grouping_proposal_email or _in_app)"
  artifacts:
    - path: "apps/web/lib/notifications.ts"
      provides: "Notification dispatch helper combining in-app + email"
      exports: ["notifyGroupingProposal"]
    - path: "apps/web/app/actions/skill-messages.ts"
      provides: "Updated sendGroupingProposal calling notification dispatch"
  key_links:
    - from: "apps/web/app/actions/skill-messages.ts"
      to: "apps/web/lib/notifications.ts"
      via: "import notifyGroupingProposal"
      pattern: "import.*notifyGroupingProposal"
    - from: "apps/web/lib/notifications.ts"
      to: "apps/web/lib/email.ts"
      via: "import sendEmail"
      pattern: "import.*sendEmail"
    - from: "apps/web/lib/notifications.ts"
      to: "packages/db/src/services/notifications.ts"
      via: "import createNotification"
      pattern: "import.*createNotification"
---

<objective>
Wire the grouping proposal action to create in-app notifications and send (stubbed) emails when someone proposes skill grouping.

Purpose: NOTIF-04 requires that when someone proposes grouping a skill, the original author gets both an in-app notification and an email. This wires the existing sendGroupingProposal server action to the notification system.
Output: Notification dispatch helper and updated skill-messages action.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/web/app/actions/skill-messages.ts
@apps/web/lib/email.ts (from Plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification dispatch helper and wire to grouping proposal</name>
  <files>
    apps/web/lib/notifications.ts
    apps/web/app/actions/skill-messages.ts
  </files>
  <action>
Create `apps/web/lib/notifications.ts`:
- NOT a "use server" file -- this is a regular lib module callable from server actions
- Import createNotification from "@everyskill/db/services/notifications"
- Import getOrCreatePreferences from "@everyskill/db/services/notification-preferences"
- Import sendEmail from "@/lib/email"
- Import render from "@react-email/render"
- Import GroupingProposalEmail from "@/emails/grouping-proposal"

Export async function notifyGroupingProposal(params: {
  tenantId: string;
  recipientId: string;
  recipientEmail: string;
  recipientName: string;
  proposerName: string;
  skillName: string;
  parentSkillName: string;
  message: string;
}):
  1. Load recipient preferences: getOrCreatePreferences(params.recipientId, params.tenantId)
  2. If preferences.groupingProposalInApp is not false:
     - Call createNotification({
         tenantId: params.tenantId,
         userId: params.recipientId,
         type: "grouping_proposal",
         title: "Skill Grouping Request",
         message: `${params.proposerName} wants to group "${params.skillName}" under "${params.parentSkillName}"`,
         actionUrl: "/messages",
         metadata: { skillName: params.skillName, parentSkillName: params.parentSkillName, proposerName: params.proposerName }
       })
  3. If preferences.groupingProposalEmail is not false:
     - Render GroupingProposalEmail with props
     - Call sendEmail({ to: params.recipientEmail, subject: `${params.proposerName} wants to group a skill under yours`, html })
  4. Fire-and-forget pattern: wrap entire function body in try/catch, log errors but never throw (same pattern as writeAuditLog). Notifications should not break the grouping proposal flow.

Update `apps/web/app/actions/skill-messages.ts`:
- Import notifyGroupingProposal from "@/lib/notifications"
- Import db user lookup: need to resolve recipient's email and name from toUserId. Import db and users schema, or import a user service function. Check if packages/db/src/services/user.ts has a getUserById or similar. If not, do a direct db.select query inline.
- After successful sendSkillMessage (inside the try block, after the id check):
  1. Look up the recipient user to get their email and name
  2. Look up the subject skill name and proposed parent skill name (import from skills schema)
  3. Call notifyGroupingProposal({ tenantId: DEFAULT_TENANT_ID (or session.user.tenantId if available), recipientId: toUserId, recipientEmail, recipientName, proposerName: session.user.name or session.user.email, skillName, parentSkillName, message })
  4. Wrap the notification call in its own try/catch -- if it fails, log but still return { success: true } since the message was sent successfully

NOTE: Use session.user.tenantId if available from the session, falling back to DEFAULT_TENANT_ID. Check how other action files access tenantId from session.
  </action>
  <verify>cd /home/dev/projects/relay/apps/web && pnpm exec tsc --noEmit 2>&1 | head -20 && pnpm build 2>&1 | tail -10</verify>
  <done>sendGroupingProposal creates both an in-app notification and logs a stubbed email when a grouping proposal is sent. Notification failures don't break the message flow.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- sendGroupingProposal server action imports and calls notifyGroupingProposal
- notifyGroupingProposal checks preferences before creating notification/email
- Email is logged to console with [EMAIL STUB] prefix
- Notification failures don't propagate to caller
</verification>

<success_criteria>
- Grouping proposal creates in-app notification for recipient
- Grouping proposal logs email to console (stub mode)
- User preferences are respected (skip if disabled)
- Notification failure does not break message sending
</success_criteria>

<output>
After completion, create `.planning/phases/33-email-notifications/33-06-SUMMARY.md`
</output>
