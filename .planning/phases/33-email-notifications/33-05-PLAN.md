---
phase: 33-email-notifications
plan: 05
type: execute
wave: 3
depends_on: ["33-03"]
files_modified:
  - apps/web/app/(protected)/settings/notifications/page.tsx
  - apps/web/app/actions/notification-preferences.ts
autonomous: true

must_haves:
  truths:
    - "User can view their current notification preferences on /settings/notifications"
    - "User can toggle email/in-app for each notification type"
    - "User can select digest frequency (none, daily, weekly)"
    - "Saving preferences persists to database and shows success feedback"
  artifacts:
    - path: "apps/web/app/(protected)/settings/notifications/page.tsx"
      provides: "Notification preferences settings page"
    - path: "apps/web/app/actions/notification-preferences.ts"
      provides: "Server actions for loading and saving preferences"
      exports: ["getMyPreferences", "saveMyPreferences"]
  key_links:
    - from: "apps/web/app/actions/notification-preferences.ts"
      to: "packages/db/src/services/notification-preferences.ts"
      via: "import service functions"
      pattern: "import.*getOrCreatePreferences|updatePreferences"
    - from: "apps/web/app/(protected)/settings/notifications/page.tsx"
      to: "apps/web/app/actions/notification-preferences.ts"
      via: "server action calls"
      pattern: "import.*notification-preferences"
---

<objective>
Create the notification preferences settings page where users configure per-type notification toggles and digest frequency.

Purpose: NOTIF-03 requires users to control their notification preferences. This page provides toggle switches for email/in-app per notification type and a digest frequency selector.
Output: Settings page at /settings/notifications and server actions for preference management.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/web/app/(protected)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preferences server actions and settings page</name>
  <files>
    apps/web/app/actions/notification-preferences.ts
    apps/web/app/(protected)/settings/notifications/page.tsx
  </files>
  <action>
Create `apps/web/app/actions/notification-preferences.ts` ("use server"):
- Import auth from "@/auth"
- Import getOrCreatePreferences, updatePreferences from "@everyskill/db/services/notification-preferences"

Functions:
1. `getMyPreferences()` - Get session, return getOrCreatePreferences(session.user.id, session.user.tenantId or DEFAULT_TENANT_ID). Return plain object with boolean fields and string digestFrequency (no Date objects).
2. `saveMyPreferences(formData: FormData)` - Get session, parse form data:
   - groupingProposalEmail: formData.get("groupingProposalEmail") === "on"
   - groupingProposalInApp: formData.get("groupingProposalInApp") === "on"
   - trendingDigest: formData.get("trendingDigest") as "none" | "daily" | "weekly"
   - platformUpdatesEmail: formData.get("platformUpdatesEmail") === "on"
   - platformUpdatesInApp: formData.get("platformUpdatesInApp") === "on"
   - Call updatePreferences(session.user.id, updates)
   - Return { success: true }
   - Wrap in try/catch, return { error: "Failed to save" } on failure

Create `apps/web/app/(protected)/settings/notifications/page.tsx`:
- Server component that loads initial preferences via getMyPreferences()
- Renders a client component NotificationPreferencesForm with initialPreferences prop

The NotificationPreferencesForm ("use client" inline or separate):
- State initialized from props
- Three sections with clear headers:

**Section 1: "Skill Grouping Requests"** (NOTIF-04)
- Description: "When someone proposes grouping a skill under yours"
- Toggle: Email notifications (checkbox)
- Toggle: In-app notifications (checkbox)

**Section 2: "Trending Skills Digest"** (NOTIF-05)
- Description: "Regular digest of trending skills in your organization"
- Select: Frequency (None / Daily / Weekly) -- use native <select>

**Section 3: "Platform Updates"** (NOTIF-06)
- Description: "Feature releases and platform improvements"
- Toggle: Email notifications (checkbox)
- Toggle: In-app notifications (checkbox)

Form layout:
- White card with sections separated by dividers (border-b)
- Each section: heading (font-medium), description (text-sm text-gray-500), then toggles
- Toggles use styled checkboxes with labels
- Save button at bottom (blue primary, full width on mobile)
- Use native form action with saveMyPreferences server action
- Show success/error toast or inline message after save

Styling: Match existing admin settings page patterns (white card, padded sections, consistent typography). Use Tailwind classes consistent with existing pages.

IMPORTANT: Do NOT use toLocaleDateString() anywhere. The DEFAULT_TENANT_ID constant should be defined locally in the server action file (same pattern as other action files).
  </action>
  <verify>cd /home/dev/projects/relay/apps/web && pnpm exec tsc --noEmit 2>&1 | head -20 && pnpm build 2>&1 | tail -10</verify>
  <done>/settings/notifications page renders with all three preference sections. Saving persists to DB.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- /settings/notifications page renders three sections
- Toggling checkboxes and saving persists values
- Page loads existing preferences on revisit
</verification>

<success_criteria>
- Preferences page accessible at /settings/notifications
- All five preference fields editable (2 email toggles, 2 in-app toggles, 1 digest frequency)
- Save persists to notification_preferences table
- Page loads existing preferences for returning users
- New users get default preferences created on first visit
</success_criteria>

<output>
After completion, create `.planning/phases/33-email-notifications/33-05-SUMMARY.md`
</output>
