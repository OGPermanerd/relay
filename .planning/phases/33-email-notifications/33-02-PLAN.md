---
phase: 33-email-notifications
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/email.ts
  - apps/web/emails/components/email-layout.tsx
  - apps/web/emails/grouping-proposal.tsx
  - apps/web/emails/trending-digest.tsx
  - apps/web/emails/platform-update.tsx
autonomous: true

must_haves:
  truths:
    - "sendEmail() function logs to console when RESEND_API_KEY is missing"
    - "sendEmail() sends via Resend API when RESEND_API_KEY is set"
    - "Three email templates render to valid HTML via React Email"
  artifacts:
    - path: "apps/web/lib/email.ts"
      provides: "Stubbed Resend email client with sendEmail function"
      exports: ["sendEmail"]
    - path: "apps/web/emails/grouping-proposal.tsx"
      provides: "Grouping proposal email template"
      exports: ["default"]
    - path: "apps/web/emails/trending-digest.tsx"
      provides: "Trending digest email template"
      exports: ["default"]
    - path: "apps/web/emails/platform-update.tsx"
      provides: "Platform update email template"
      exports: ["default"]
  key_links:
    - from: "apps/web/lib/email.ts"
      to: "resend"
      via: "npm dependency"
      pattern: "new Resend"
    - from: "apps/web/emails/grouping-proposal.tsx"
      to: "apps/web/emails/components/email-layout.tsx"
      via: "import EmailLayout"
      pattern: "import.*EmailLayout"
---

<objective>
Install Resend + React Email dependencies and create the stubbed email infrastructure with all three email templates.

Purpose: NOTIF-01 requires email infrastructure. Per user decision, emails are STUBBED to console.log until a Resend API key is added. Templates are fully built so wiring Resend later requires only adding the env var.
Output: Email client lib, shared layout component, three email templates (grouping proposal, trending digest, platform update).
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install deps and create stubbed email client</name>
  <files>
    apps/web/lib/email.ts
    apps/web/emails/components/email-layout.tsx
  </files>
  <action>
Install dependencies in apps/web:
```bash
cd /home/dev/projects/relay/apps/web && pnpm add resend @react-email/components @react-email/render
```

Create `apps/web/lib/email.ts`:
- Import Resend from 'resend'
- Detect stub mode: `const STUB_MODE = !process.env.RESEND_API_KEY`
- Create resend instance only when not stubbed: `const resend = STUB_MODE ? null : new Resend(process.env.RESEND_API_KEY)`
- Export async function sendEmail({ to, subject, html }: { to: string; subject: string; html: string }): Promise<{ success: boolean; id: string }>
  - If STUB_MODE: console.log('[EMAIL STUB]', { to, subject, htmlPreview: html.substring(0, 200), timestamp: new Date().toISOString() }), return { success: true, id: 'stub-' + Date.now() }
  - Otherwise: call resend!.emails.send({ from: process.env.RESEND_FROM_EMAIL || 'EverySkill <notifications@everyskill.ai>', to, subject, html })
  - Wrap in try/catch, log errors, return { success: false, id: '' } on failure
- Do NOT re-export React Email types (avoid "use server" bundler issues)

Create `apps/web/emails/components/email-layout.tsx`:
- Shared layout wrapping all email templates
- Uses Html, Head, Body, Container, Section, Text, Link from @react-email/components
- White background card on light gray body (#f9fafb)
- Footer with copyright and link to /settings/notifications for preference management
- Props: { children: React.ReactNode; previewText?: string }
- Include Preview component if previewText provided
  </action>
  <verify>cd /home/dev/projects/relay/apps/web && pnpm exec tsc --noEmit 2>&1 | grep -E "(email|Email)" | head -10; echo "---"; node -e "const r = require('resend'); console.log('resend loaded:', typeof r.Resend)"</verify>
  <done>resend and @react-email packages installed, email.ts compiles, sendEmail logs to console in stub mode.</done>
</task>

<task type="auto">
  <name>Task 2: Create three email templates</name>
  <files>
    apps/web/emails/grouping-proposal.tsx
    apps/web/emails/trending-digest.tsx
    apps/web/emails/platform-update.tsx
  </files>
  <action>
Create `apps/web/emails/grouping-proposal.tsx` (NOTIF-04):
- Props interface: { recipientName: string; proposerName: string; skillName: string; parentSkillName: string; message: string; actionUrl: string }
- Uses EmailLayout wrapper
- Content: heading "Skill Grouping Request", paragraph explaining who wants to group what, the proposal message in a quoted block, CTA button "View Request" linking to actionUrl
- Inline styles only (email clients don't support CSS classes)
- Export default function and the props interface type

Create `apps/web/emails/trending-digest.tsx` (NOTIF-05):
- Props interface: { recipientName: string; skills: Array<{ name: string; uses: number; slug: string }>; period: 'daily' | 'weekly'; baseUrl: string }
- Uses EmailLayout wrapper
- Content: heading "Your {period} Trending Skills", list of top skills with use counts, CTA button "View All Skills"
- Each skill is a row with name + use count

Create `apps/web/emails/platform-update.tsx` (NOTIF-06):
- Props interface: { recipientName: string; title: string; description: string; version?: string; actionUrl?: string }
- Uses EmailLayout wrapper
- Content: heading with title, description paragraph, optional version badge, optional CTA button
- Clean professional layout

All templates must:
- Use inline styles (no Tailwind or CSS modules)
- Import from @react-email/components (Html, Head, Body, etc. come from layout, just use Section, Text, Button, Link, Hr)
- Be renderable via `await render(<Template {...props} />)` from @react-email/render
  </action>
  <verify>cd /home/dev/projects/relay/apps/web && pnpm exec tsc --noEmit 2>&1 | grep -c "error" || echo "0 errors"</verify>
  <done>Three email templates compile and follow React Email patterns. Each exports a default component and props interface.</done>
</task>

</tasks>

<verification>
- `pnpm exec tsc --noEmit` in apps/web passes (or only pre-existing errors)
- `resend` and `@react-email/components` in package.json dependencies
- `apps/web/lib/email.ts` exports sendEmail
- All three template files exist and compile
</verification>

<success_criteria>
- sendEmail() logs to console with [EMAIL STUB] prefix when RESEND_API_KEY is not set
- All three React Email templates render valid HTML
- No new TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/33-email-notifications/33-02-SUMMARY.md`
</output>
