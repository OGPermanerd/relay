---
phase: 33-email-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/notifications.ts
  - packages/db/src/schema/notification-preferences.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/relations/index.ts
  - packages/db/src/migrations/0012_create_notifications.sql
autonomous: true

must_haves:
  truths:
    - "notifications table exists with tenant_id, user_id, type, title, message, is_read columns"
    - "notification_preferences table exists with per-type toggles and digest frequency"
    - "Both tables have RLS policies matching existing tenant isolation pattern"
    - "Migration 0012 creates both tables with indexes"
  artifacts:
    - path: "packages/db/src/schema/notifications.ts"
      provides: "notifications table definition with RLS"
      exports: ["notifications", "Notification", "NewNotification"]
    - path: "packages/db/src/schema/notification-preferences.ts"
      provides: "notification_preferences table with digest enum"
      exports: ["notificationPreferences", "digestFrequencyEnum", "NotificationPreference"]
    - path: "packages/db/src/migrations/0012_create_notifications.sql"
      provides: "SQL migration for both tables"
      contains: "CREATE TABLE"
  key_links:
    - from: "packages/db/src/schema/notifications.ts"
      to: "packages/db/src/schema/tenants.ts"
      via: "FK reference tenantId -> tenants.id"
      pattern: "references.*tenants\\.id"
    - from: "packages/db/src/schema/index.ts"
      to: "packages/db/src/schema/notifications.ts"
      via: "re-export"
      pattern: "export.*notifications"
---

<objective>
Create the notifications and notification_preferences database tables with tenant isolation.

Purpose: Foundation for all notification features (NOTIF-01 through NOTIF-06) -- both tables must exist before services or UI can be built.
Output: Two new schema files, updated schema index, updated relations, and migration 0012.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/schema/skill-messages.ts (reference for RLS pattern + table structure)
@packages/db/src/schema/index.ts
@packages/db/src/relations/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notifications and notification_preferences schemas</name>
  <files>
    packages/db/src/schema/notifications.ts
    packages/db/src/schema/notification-preferences.ts
    packages/db/src/schema/index.ts
    packages/db/src/relations/index.ts
  </files>
  <action>
Create `packages/db/src/schema/notifications.ts`:
- pgTable "notifications" with columns:
  - id: text PK with crypto.randomUUID() default
  - tenantId: text NOT NULL FK to tenants.id
  - userId: text NOT NULL FK to users.id
  - type: text NOT NULL (values: "grouping_proposal" | "trending_digest" | "platform_update")
  - title: text NOT NULL
  - message: text NOT NULL
  - actionUrl: text (nullable)
  - metadata: text (nullable, JSON string for type-specific data)
  - isRead: boolean NOT NULL default false
  - createdAt: timestamp withTimezone NOT NULL defaultNow()
  - readAt: timestamp withTimezone (nullable)
- Indexes: user_id, tenant_id, composite (userId, isRead) for unread count optimization
- RLS pgPolicy matching skill-messages.ts pattern exactly: `tenant_id = current_setting('app.current_tenant_id', true)`
- Export types: Notification (inferSelect), NewNotification (inferInsert)

Create `packages/db/src/schema/notification-preferences.ts`:
- Create digestFrequencyEnum pgEnum with values: "none", "daily", "weekly"
- pgTable "notification_preferences" with columns:
  - id: text PK with crypto.randomUUID() default
  - tenantId: text NOT NULL FK to tenants.id
  - userId: text NOT NULL unique FK to users.id (one row per user)
  - groupingProposalEmail: boolean NOT NULL default true
  - groupingProposalInApp: boolean NOT NULL default true
  - trendingDigest: digestFrequencyEnum NOT NULL default "weekly"
  - platformUpdatesEmail: boolean NOT NULL default true
  - platformUpdatesInApp: boolean NOT NULL default true
  - updatedAt: timestamp withTimezone NOT NULL defaultNow()
- Indexes: tenant_id
- RLS pgPolicy matching same pattern
- Export types: NotificationPreference (inferSelect), NewNotificationPreference (inferInsert)

Update `packages/db/src/schema/index.ts`: Add `export * from "./notifications"` and `export * from "./notification-preferences"`

Update `packages/db/src/relations/index.ts`:
- Import notifications, notificationPreferences from schema
- Add notificationsRelations: tenant -> tenants, user -> users
- Add notificationPreferencesRelations: tenant -> tenants, user -> users
- Add to usersRelations: notifications many, notificationPreferences (one or many)
- Add to tenantsRelations: notifications many, notificationPreferences many
  </action>
  <verify>cd /home/dev/projects/relay && pnpm exec tsc --noEmit -p packages/db/tsconfig.json 2>&1 | head -20</verify>
  <done>Both schema files compile, are exported from index, and relations are wired.</done>
</task>

<task type="auto">
  <name>Task 2: Create migration 0012 for notifications tables</name>
  <files>packages/db/src/migrations/0012_create_notifications.sql</files>
  <action>
Create SQL migration `packages/db/src/migrations/0012_create_notifications.sql`:

1. Create digest_frequency enum type (IF NOT EXISTS):
```sql
DO $$ BEGIN
  CREATE TYPE digest_frequency AS ENUM ('none', 'daily', 'weekly');
EXCEPTION WHEN duplicate_object THEN NULL;
END $$;
```

2. Create notifications table:
```sql
CREATE TABLE IF NOT EXISTS notifications (
  id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
  tenant_id TEXT NOT NULL REFERENCES tenants(id),
  user_id TEXT NOT NULL REFERENCES "user"(id),
  type TEXT NOT NULL,
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  action_url TEXT,
  metadata TEXT,
  is_read BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  read_at TIMESTAMPTZ
);
```

3. Create notification_preferences table:
```sql
CREATE TABLE IF NOT EXISTS notification_preferences (
  id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
  tenant_id TEXT NOT NULL REFERENCES tenants(id),
  user_id TEXT NOT NULL UNIQUE REFERENCES "user"(id),
  grouping_proposal_email BOOLEAN NOT NULL DEFAULT true,
  grouping_proposal_in_app BOOLEAN NOT NULL DEFAULT true,
  trending_digest digest_frequency NOT NULL DEFAULT 'weekly',
  platform_updates_email BOOLEAN NOT NULL DEFAULT true,
  platform_updates_in_app BOOLEAN NOT NULL DEFAULT true,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

4. Create indexes:
```sql
CREATE INDEX IF NOT EXISTS notifications_user_id_idx ON notifications(user_id);
CREATE INDEX IF NOT EXISTS notifications_tenant_id_idx ON notifications(tenant_id);
CREATE INDEX IF NOT EXISTS notifications_user_unread_idx ON notifications(user_id, is_read);
CREATE INDEX IF NOT EXISTS notification_preferences_tenant_id_idx ON notification_preferences(tenant_id);
```

5. Enable RLS and create policies (matching existing pattern from 0005):
```sql
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE notification_preferences ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation ON notifications AS RESTRICTIVE FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true))
  WITH CHECK (tenant_id = current_setting('app.current_tenant_id', true));

CREATE POLICY tenant_isolation ON notification_preferences AS RESTRICTIVE FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true))
  WITH CHECK (tenant_id = current_setting('app.current_tenant_id', true));
```

IMPORTANT: Check users table name -- look at existing migrations to confirm the FK target is "user" (with quotes) not "users". Match the convention in 0010_create_skill_messages.sql.

Run the migration: `cd /home/dev/projects/relay && psql -d everyskill -f packages/db/src/migrations/0012_create_notifications.sql`
  </action>
  <verify>psql -d everyskill -c "\d notifications" && psql -d everyskill -c "\d notification_preferences" && psql -d everyskill -c "SELECT polname FROM pg_policy WHERE polrelid = 'notifications'::regclass"</verify>
  <done>Both tables exist in DB with all columns, indexes, RLS policies active, and FK constraints.</done>
</task>

</tasks>

<verification>
- `pnpm exec tsc --noEmit -p packages/db/tsconfig.json` passes
- `psql -d everyskill -c "\d notifications"` shows all columns
- `psql -d everyskill -c "\d notification_preferences"` shows all columns
- RLS policies visible via `pg_policy` catalog
</verification>

<success_criteria>
- notifications and notification_preferences tables exist in the database
- Schema types are exported from packages/db/src/schema/index.ts
- Relations are defined for both tables
- RLS policies prevent cross-tenant access
- Migration 0012 is idempotent (safe to re-run)
</success_criteria>

<output>
After completion, create `.planning/phases/33-email-notifications/33-01-SUMMARY.md`
</output>
