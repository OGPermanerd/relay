---
phase: 33-email-notifications
plan: 03
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - packages/db/src/services/notifications.ts
  - packages/db/src/services/notification-preferences.ts
  - packages/db/src/services/index.ts
autonomous: true

must_haves:
  truths:
    - "createNotification inserts a notification row with tenant_id and returns the record"
    - "getUserNotifications returns paginated list ordered by createdAt desc"
    - "getUnreadCount returns integer count using composite index"
    - "markAsRead updates isRead=true and sets readAt timestamp"
    - "getOrCreatePreferences returns existing prefs or creates default row"
    - "updatePreferences saves user toggle changes"
  artifacts:
    - path: "packages/db/src/services/notifications.ts"
      provides: "Notification CRUD operations"
      exports: ["createNotification", "getUserNotifications", "getUnreadNotificationCount", "markNotificationAsRead", "markAllNotificationsAsRead"]
    - path: "packages/db/src/services/notification-preferences.ts"
      provides: "Notification preference management"
      exports: ["getOrCreatePreferences", "updatePreferences"]
    - path: "packages/db/src/services/index.ts"
      provides: "Re-exports notification services"
  key_links:
    - from: "packages/db/src/services/notifications.ts"
      to: "packages/db/src/schema/notifications.ts"
      via: "import notifications table"
      pattern: "import.*notifications.*from.*schema"
    - from: "packages/db/src/services/notification-preferences.ts"
      to: "packages/db/src/schema/notification-preferences.ts"
      via: "import notificationPreferences table"
      pattern: "import.*notificationPreferences.*from.*schema"
---

<objective>
Create database service functions for notification CRUD and preference management.

Purpose: All notification features (bell icon, preferences page, grouping proposal wiring, digest crons) need these services. Building them as a standalone plan keeps each downstream plan focused on UI/wiring only.
Output: Two service files with full CRUD operations, re-exported from services index.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@packages/db/src/services/skill-messages.ts (reference for service pattern)
@packages/db/src/schema/notifications.ts (from Plan 01)
@packages/db/src/schema/notification-preferences.ts (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification and preference service functions</name>
  <files>
    packages/db/src/services/notifications.ts
    packages/db/src/services/notification-preferences.ts
    packages/db/src/services/index.ts
  </files>
  <action>
Create `packages/db/src/services/notifications.ts`:

Import db from "../client", notifications from "../schema", eq/and/desc/count/sql from "drizzle-orm".

Define and export CreateNotificationParams interface:
```
tenantId: string
userId: string
type: "grouping_proposal" | "trending_digest" | "platform_update"
title: string
message: string
actionUrl?: string
metadata?: Record<string, unknown>
```

Export async functions:

1. `createNotification(params: CreateNotificationParams)` - Insert into notifications, stringify metadata if present, return the inserted row via .returning()

2. `getUserNotifications(userId: string, limit = 50, offset = 0)` - Select from notifications where userId matches, order by createdAt desc, apply limit and offset. Return array of notification rows with all fields. Serialize createdAt and readAt to ISO strings before returning.

3. `getUnreadNotificationCount(userId: string): Promise<number>` - SELECT count(*) FROM notifications WHERE user_id = userId AND is_read = false. Return number. Uses the composite index.

4. `markNotificationAsRead(notificationId: string)` - UPDATE notifications SET is_read = true, read_at = new Date() WHERE id = notificationId.

5. `markAllNotificationsAsRead(userId: string)` - UPDATE notifications SET is_read = true, read_at = new Date() WHERE user_id = userId AND is_read = false.

Create `packages/db/src/services/notification-preferences.ts`:

Import db from "../client", notificationPreferences from "../schema", eq from "drizzle-orm".

Export async functions:

1. `getOrCreatePreferences(userId: string, tenantId: string)` - SELECT from notification_preferences WHERE user_id = userId. If found, return it. If not, INSERT with defaults (all true, trending_digest = "weekly") and return. Use ON CONFLICT (user_id) DO NOTHING to avoid race conditions, then re-select.

2. `updatePreferences(userId: string, updates: Partial<{ groupingProposalEmail: boolean; groupingProposalInApp: boolean; trendingDigest: "none" | "daily" | "weekly"; platformUpdatesEmail: boolean; platformUpdatesInApp: boolean }>)` - UPDATE notification_preferences SET ...updates, updated_at = new Date() WHERE user_id = userId. Return updated row.

Update `packages/db/src/services/index.ts`:
- Add exports for createNotification, getUserNotifications, getUnreadNotificationCount, markNotificationAsRead, markAllNotificationsAsRead, CreateNotificationParams
- Add exports for getOrCreatePreferences, updatePreferences
  </action>
  <verify>cd /home/dev/projects/relay && pnpm exec tsc --noEmit -p packages/db/tsconfig.json 2>&1 | head -20</verify>
  <done>All 7 service functions compile and are exported from packages/db/src/services/index.ts. Types match schema columns.</done>
</task>

</tasks>

<verification>
- `pnpm exec tsc --noEmit -p packages/db/tsconfig.json` passes
- notifications.ts exports 5 functions + 1 type
- notification-preferences.ts exports 2 functions
- services/index.ts re-exports all
</verification>

<success_criteria>
- createNotification can insert a notification row
- getUserNotifications returns paginated, ordered results
- getUnreadNotificationCount returns an integer
- markNotificationAsRead and markAllNotificationsAsRead update correctly
- getOrCreatePreferences handles first-time and existing users
- updatePreferences saves partial updates
</success_criteria>

<output>
After completion, create `.planning/phases/33-email-notifications/33-03-SUMMARY.md`
</output>
