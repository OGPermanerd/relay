---
phase: 33-email-notifications
plan: 07
type: execute
wave: 3
depends_on: ["33-02", "33-03"]
files_modified:
  - apps/web/app/api/cron/daily-digest/route.ts
  - apps/web/app/api/cron/weekly-digest/route.ts
  - apps/web/app/actions/admin-notifications.ts
  - apps/web/middleware.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/cron/daily-digest generates trending digest notifications for users with daily preference"
    - "GET /api/cron/weekly-digest generates trending digest notifications for users with weekly preference"
    - "Both cron endpoints verify CRON_SECRET for security"
    - "Platform update notifications can be created by admins"
    - "Cron endpoints are exempt from auth middleware"
  artifacts:
    - path: "apps/web/app/api/cron/daily-digest/route.ts"
      provides: "Daily trending digest cron endpoint"
      exports: ["GET"]
    - path: "apps/web/app/api/cron/weekly-digest/route.ts"
      provides: "Weekly trending digest cron endpoint"
      exports: ["GET"]
    - path: "apps/web/app/actions/admin-notifications.ts"
      provides: "Admin action to send platform update notifications"
      exports: ["sendPlatformUpdate"]
  key_links:
    - from: "apps/web/app/api/cron/daily-digest/route.ts"
      to: "packages/db/src/services/notifications.ts"
      via: "import createNotification"
      pattern: "import.*createNotification"
    - from: "apps/web/middleware.ts"
      to: "apps/web/app/api/cron"
      via: "path exemption"
      pattern: "api/cron"
---

<objective>
Create cron API endpoints for trending skill digests and an admin action for platform update notifications.

Purpose: NOTIF-05 requires scheduled trending digests (daily/weekly). NOTIF-06 requires platform update notifications. This plan creates the cron endpoints and admin dispatch action.
Output: Two cron route handlers, admin notification action, middleware update.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/web/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cron digest endpoints + middleware exemption</name>
  <files>
    apps/web/app/api/cron/daily-digest/route.ts
    apps/web/app/api/cron/weekly-digest/route.ts
    apps/web/middleware.ts
  </files>
  <action>
Update `apps/web/middleware.ts`:
- Add cron API path exemption. In the exempt paths condition, add:
  `pathname.startsWith("/api/cron")`
- This allows cron endpoints to bypass auth cookie check (they use CRON_SECRET instead)

Create `apps/web/app/api/cron/daily-digest/route.ts`:
- Export async function GET(request: NextRequest)
- Security: verify Authorization header matches `Bearer ${process.env.CRON_SECRET}`. If missing or wrong, return 401 JSON.
- If CRON_SECRET is not set in env, log warning and return 200 with { skipped: true, reason: "CRON_SECRET not configured" } (allows dev testing)
- Query trending skills using the `total_uses` column (Drizzle field: `totalUses`). NOTE: There is NO per-usage timestamp â€” `total_uses` is a denormalized integer aggregate on the skills table. Query: `SELECT name, slug, total_uses FROM skills ORDER BY total_uses DESC LIMIT 10`. Import `skills` from `@everyskill/db` schema, `db` from `@everyskill/db`.
- Query users with daily digest preference: SELECT from notification_preferences WHERE trending_digest = 'daily'. Join with users to get user_id and email. Import `notificationPreferences` and `users` from `@everyskill/db` schema.
- For each user: create in-app notification of type "trending_digest" with title "Daily Trending Skills" and message listing top 3 skill names. Also render TrendingDigestEmail and call sendEmail (stubbed).
- Log summary: `[DAILY DIGEST] Sent to N users, M skills trending`
- Return 200 JSON with { success: true, usersNotified: N }
- Wrap everything in try/catch, return 500 on error

Create `apps/web/app/api/cron/weekly-digest/route.ts`:
- Same structure as daily but:
  - Query preferences WHERE trending_digest = 'weekly'
  - Title: "Weekly Trending Skills"
  - Log: `[WEEKLY DIGEST]`
  </action>
  <verify>cd /home/dev/projects/relay/apps/web && pnpm exec tsc --noEmit 2>&1 | head -20 && pnpm build 2>&1 | tail -10</verify>
  <done>Both cron endpoints compile and return JSON responses. Middleware exempts /api/cron paths.</done>
</task>

<task type="auto">
  <name>Task 2: Create admin platform update notification action</name>
  <files>
    apps/web/app/actions/admin-notifications.ts
  </files>
  <action>
Create `apps/web/app/actions/admin-notifications.ts` ("use server"):
- Import auth from "@/auth", isAdmin from "@/lib/admin"
- Import createNotification from "@everyskill/db/services/notifications"
- Import sendEmail from "@/lib/email", render from "@react-email/render", PlatformUpdateEmail from "@/emails/platform-update"
- Import db and relevant tables to query all users in tenant
- Import getOrCreatePreferences from "@everyskill/db/services/notification-preferences"

Export async function sendPlatformUpdate(formData: FormData):
  - Verify admin: session + isAdmin(session) check, return error if not admin
  - Parse: title (string), description (string), version (string optional)
  - Query all users in the admin's tenant
  - For each user: check preferences (platformUpdatesInApp, platformUpdatesEmail)
  - If in-app enabled: createNotification with type "platform_update"
  - If email enabled: render PlatformUpdateEmail, call sendEmail
  - Return { success: true, notified: N }
  - Fire-and-forget style: accumulate errors, don't stop on individual failure
  </action>
  <verify>cd /home/dev/projects/relay/apps/web && pnpm exec tsc --noEmit 2>&1 | head -20</verify>
  <done>Admin action can dispatch platform update notifications to all tenant users with preference checks.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- `curl http://localhost:2000/api/cron/daily-digest` returns JSON (with skipped or unauthorized)
- middleware.ts exempts /api/cron paths
- admin-notifications.ts exports sendPlatformUpdate
</verification>

<success_criteria>
- Daily digest cron endpoint creates notifications for users with daily preference
- Weekly digest cron endpoint creates notifications for users with weekly preference
- Both cron endpoints protected by CRON_SECRET
- Admin can send platform update notifications to all tenant users
- Cron endpoints exempt from auth middleware
- All emails logged to console in stub mode
</success_criteria>

<output>
After completion, create `.planning/phases/33-email-notifications/33-07-SUMMARY.md`
</output>
