---
phase: 55-schema-foundation-data-sanitization
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/sanitize-payload.ts
  - apps/web/lib/__tests__/sanitize-payload.test.ts
autonomous: true

must_haves:
  truths:
    - "sanitizePayload() detects and strips AWS access keys, GitHub tokens, Anthropic keys, OpenAI keys, Bearer tokens, generic API key assignments, password assignments, PEM private keys, and connection strings"
    - "sanitizePayload() returns a list of which secret pattern types were found"
    - "sanitizePayload() does NOT strip legitimate text that contains words like 'password' or 'token' without assignment context"
    - "sanitizeObject() recursively sanitizes all string values in nested objects and arrays"
  artifacts:
    - path: "apps/web/lib/sanitize-payload.ts"
      provides: "Secret detection and stripping utility"
      exports: ["sanitizePayload", "sanitizeObject", "SanitizeResult"]
    - path: "apps/web/lib/__tests__/sanitize-payload.test.ts"
      provides: "Comprehensive unit tests for sanitization"
      contains: "describe.*sanitizePayload"
  key_links:
    - from: "apps/web/lib/__tests__/sanitize-payload.test.ts"
      to: "apps/web/lib/sanitize-payload.ts"
      via: "import { sanitizePayload, sanitizeObject }"
      pattern: "import.*sanitizePayload.*sanitize-payload"
---

<objective>
Build a payload sanitization utility that detects and strips known secret patterns from arbitrary text input, using TDD to ensure comprehensive coverage of both true positives (real secrets) and true negatives (legitimate text).

Purpose: Prevents API keys, passwords, tokens, and connection strings from accidentally entering the skill_feedback and token_measurements tables via user-submitted content. Required by SCHEMA-06.
Output: `sanitizePayload()` and `sanitizeObject()` functions with full unit test coverage.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/55-schema-foundation-data-sanitization/55-RESEARCH.md

# Existing test pattern:
@apps/web/lib/__tests__/quality-score.test.ts
@apps/web/vitest.config.ts
</context>

<feature>
  <name>Payload Sanitization Utility</name>
  <files>apps/web/lib/sanitize-payload.ts, apps/web/lib/__tests__/sanitize-payload.test.ts</files>
  <behavior>
Expected behavior in testable terms:

**sanitizePayload(input: string) -> { sanitized: string, secretsFound: string[] }**

True positive cases (MUST detect and replace with "[REDACTED]"):
- AWS access key: "key=AKIAIOSFODNN7EXAMPLE" -> "key=[REDACTED]"
- AWS secret key: "aws_secret_access_key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY" -> "[REDACTED]"
- GitHub PAT classic: "token: ghp_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghij1234" -> "token: [REDACTED]"
- GitHub fine-grained: "github_pat_11ABCDEF0abcdefghijklmnopqrstuvwxyz1234567890" (starts with ghp_, gho_, ghu_, ghs_, ghr_)
- Anthropic key: "sk-ant-api03-abcdefghijklmnopqrstuvwxyz" -> "[REDACTED]"
- OpenAI key: "sk-proj-abcdefghijklmnopqrstuvwxyz1234" -> "[REDACTED]"
- Bearer token: "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.payload.signature" -> "Authorization: [REDACTED]"
- Generic API key: "api_key=abcdef1234567890abcdef" -> "[REDACTED]"
- Password assignment: "password=MyS3cur3P@ssw0rd!" -> "[REDACTED]"
- PEM private key: "-----BEGIN PRIVATE KEY-----\nMIIEvQIB...\n-----END PRIVATE KEY-----" -> "[REDACTED]"
- Connection string: "postgres://admin:secret123@db.example.com:5432/mydb" -> "[REDACTED]"

True negative cases (MUST NOT strip):
- "The password policy requires 12 characters" -> unchanged
- "Use a strong password for your account" -> unchanged
- "This token represents a unit of work" -> unchanged
- "The API key management page is at /settings" -> unchanged (no assignment context)
- "GitHub uses personal access tokens for auth" -> unchanged
- Normal code: "const result = await fetchData();" -> unchanged
- Short strings: "sk-12" -> unchanged (too short for OpenAI key pattern)

**sanitizeObject(obj: Record<string, unknown>) -> { sanitized: Record<string, unknown>, secretsFound: string[] }**
- Recursively sanitizes all string values
- Handles nested objects: { config: { db: "postgres://user:pass@host/db" } }
- Handles arrays: { keys: ["AKIAIOSFODNN7EXAMPLE", "safe-value"] }
- Passes through non-string values: numbers, booleans, null
- Returns deduplicated secretsFound list

Edge cases:
- Empty string -> { sanitized: "", secretsFound: [] }
- String with multiple secret types -> all replaced, all types listed
- Very long base64 (100+ chars) -> detected as potential encoded secret
  </behavior>
  <implementation>
Create `apps/web/lib/sanitize-payload.ts` with:

1. `SECRET_PATTERNS` array of `{ name: string, pattern: RegExp }[]` — patterns require assignment context (key=value, "key": "value") or known prefixes (AKIA, ghp_, sk-ant-, Bearer) to avoid false positives. All patterns use `/g` flag.

2. `sanitizePayload(input: string): SanitizeResult` — iterates over patterns, tests each, replaces matches with "[REDACTED]", collects matched pattern names. Reset regex lastIndex before each test and replace.

3. `sanitizeObject(obj)` — recursive traversal: strings get sanitizePayload(), arrays get mapped, objects get recursed, primitives pass through. Returns deduplicated secretsFound.

Secret patterns (from research):
- `AKIA[0-9A-Z]{16}` (AWS access key)
- `(?:aws_secret_access_key|secret_key)\s*[=:]\s*["']?[A-Za-z0-9/+=]{40}["']?` (AWS secret)
- `gh[pousr]_[A-Za-z0-9_]{36,}` (GitHub tokens)
- `sk-ant-[A-Za-z0-9_-]{20,}` (Anthropic)
- `sk-[A-Za-z0-9]{20,}` (OpenAI — note: must come AFTER Anthropic pattern to avoid double-matching)
- `Bearer\s+[A-Za-z0-9._~+/=-]{20,}` (Bearer tokens)
- `(?:api[_-]?key|apikey|api[_-]?secret|auth[_-]?token|access[_-]?token)\s*[=:]\s*["']?[A-Za-z0-9_\-.]{16,}["']?` (generic API key)
- `(?:password|passwd|pwd)\s*[=:]\s*["']?[^\s"']{8,}["']?` (password assignment)
- `-----BEGIN\s+(RSA\s+)?PRIVATE\s+KEY-----[\s\S]*?-----END\s+(RSA\s+)?PRIVATE\s+KEY-----` (PEM key)
- `(?:postgres|mysql|mongodb|redis):\/\/[^:]+:[^@]+@[^\s]+` (connection string)
- `[A-Za-z0-9+/]{100,}={0,2}` (long base64)
  </implementation>
</feature>

<verification>
1. All tests pass: `cd /home/dev/projects/relay/apps/web && npx vitest run lib/__tests__/sanitize-payload.test.ts`
2. True positives: Every secret pattern type has at least one test case that detects it
3. True negatives: Legitimate text containing "password", "token", "key" as words is NOT stripped
4. sanitizeObject handles nested objects, arrays, and mixed types
5. Exports are importable from other modules
</verification>

<success_criteria>
- `sanitizePayload()` and `sanitizeObject()` exported from `apps/web/lib/sanitize-payload.ts`
- Unit tests cover all 11 secret pattern types with true positive tests
- Unit tests include at least 5 true negative cases
- All tests pass via `npx vitest run`
</success_criteria>

<output>
After completion, create `.planning/phases/55-schema-foundation-data-sanitization/55-02-SUMMARY.md`
</output>
