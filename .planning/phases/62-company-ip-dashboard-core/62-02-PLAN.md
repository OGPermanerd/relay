---
phase: 62-company-ip-dashboard-core
plan: 02
type: execute
wave: 2
depends_on: ["62-01"]
files_modified:
  - apps/web/app/(protected)/leverage/ip-dashboard/page.tsx
  - apps/web/components/ip-dashboard-view.tsx
  - apps/web/components/quality-trend-chart.tsx
autonomous: true

must_haves:
  truths:
    - "Admin navigates to /leverage/ip-dashboard and sees hero stat cards: total skills captured, total uses, total hours saved, and active contributors"
    - "Admin sees a quality trends chart with three lines: avg rating, feedback sentiment, and benchmark score over monthly intervals"
    - "Non-admin users are redirected away from the IP dashboard page"
    - "Quality trend chart responds to the TimeRangeSelector URL parameter"
    - "Empty data states are handled gracefully (no crashes, shows placeholder messages)"
  artifacts:
    - path: "apps/web/app/(protected)/leverage/ip-dashboard/page.tsx"
      provides: "Admin-gated server component page for IP dashboard"
      exports: ["default"]
    - path: "apps/web/components/ip-dashboard-view.tsx"
      provides: "Client component rendering hero stat cards grid and quality trends chart container"
      exports: ["IpDashboardView"]
    - path: "apps/web/components/quality-trend-chart.tsx"
      provides: "Multi-line Recharts LineChart for quality trends (rating, sentiment, benchmark)"
      exports: ["QualityTrendChart"]
  key_links:
    - from: "apps/web/app/(protected)/leverage/ip-dashboard/page.tsx"
      to: "apps/web/lib/ip-dashboard-queries.ts"
      via: "import { getIpDashboardStats, getQualityTrends }"
      pattern: "getIpDashboardStats|getQualityTrends"
    - from: "apps/web/components/ip-dashboard-view.tsx"
      to: "apps/web/components/quality-trend-chart.tsx"
      via: "import { QualityTrendChart }"
      pattern: "QualityTrendChart"
    - from: "apps/web/app/(protected)/leverage/ip-dashboard/page.tsx"
      to: "apps/web/components/ip-dashboard-view.tsx"
      via: "<IpDashboardView stats={stats} trendData={trendData} />"
      pattern: "IpDashboardView"
---

<objective>
Build the IP dashboard page, stat cards view, and quality trend chart.

Purpose: Wire the query functions from Plan 01 into a fully functional admin-only page with hero KPI stat cards and a multi-line quality trends chart, completing the IP Dashboard Core phase.

Output:
- `apps/web/app/(protected)/leverage/ip-dashboard/page.tsx` (admin-gated server component)
- `apps/web/components/ip-dashboard-view.tsx` (client container with stat cards + chart)
- `apps/web/components/quality-trend-chart.tsx` (multi-line Recharts LineChart)
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-company-ip-dashboard-core/62-01-SUMMARY.md
@apps/web/app/(protected)/leverage/employees/page.tsx
@apps/web/components/overview-tab.tsx
@apps/web/components/stat-card.tsx
@apps/web/components/cost-trend-chart.tsx
@apps/web/components/time-range-selector.tsx
@apps/web/lib/ip-dashboard-queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IP dashboard page and client view component</name>
  <files>
    apps/web/app/(protected)/leverage/ip-dashboard/page.tsx
    apps/web/components/ip-dashboard-view.tsx
  </files>
  <action>
**File 1: `apps/web/app/(protected)/leverage/ip-dashboard/page.tsx`**

Create an admin-gated server component following the EXACT pattern from `employees/page.tsx`:

```typescript
import { Suspense } from "react";
import { redirect } from "next/navigation";
import { auth } from "@/auth";
import { isAdmin } from "@/lib/admin";
import { IpDashboardView } from "@/components/ip-dashboard-view";
import { TimeRangeSelector } from "@/components/time-range-selector";
import { getIpDashboardStats, getQualityTrends } from "@/lib/ip-dashboard-queries";
import { getStartDate, type TimeRange } from "@/lib/analytics-queries";

export const metadata = { title: "IP Dashboard | EverySkill" };

interface IpDashboardPageProps {
  searchParams: Promise<{ range?: string }>;
}

export default async function IpDashboardPage({ searchParams }: IpDashboardPageProps) {
  const session = await auth();
  if (!session?.user?.id) redirect("/login");
  if (!isAdmin(session)) redirect("/leverage");

  const tenantId = session.user.tenantId;
  if (!tenantId) redirect("/login");

  const params = await searchParams;
  const range = (params.range || "30d") as TimeRange;
  const startDate = getStartDate(range);

  // Hero stats are all-time (no date filter); quality trends use the time range
  const [stats, trendData] = await Promise.all([
    getIpDashboardStats(tenantId),
    getQualityTrends(tenantId, startDate),
  ]);

  return (
    <>
      <div className="mb-6 flex items-center justify-end">
        <Suspense fallback={<div className="h-10 w-64 animate-pulse rounded bg-gray-200" />}>
          <TimeRangeSelector />
        </Suspense>
      </div>
      <IpDashboardView stats={stats} trendData={trendData} />
    </>
  );
}
```

**File 2: `apps/web/components/ip-dashboard-view.tsx`**

Create a "use client" component following the exact pattern from `overview-tab.tsx`:

1. Import `StatCard` from `./stat-card` and `QualityTrendChart` from `./quality-trend-chart`.
2. Import types: `IpDashboardStats`, `QualityTrendPoint` from `@/lib/ip-dashboard-queries`.
3. Define inline SVG icon components for 4 stat cards (similar to overview-tab.tsx):
   - `DatabaseIcon` (for Total Skills Captured) -- cube/database style
   - `ChartBarIcon` (for Total Uses) -- bar chart style
   - `ClockIcon` (for Total Hours Saved) -- clock, reuse same SVG from overview-tab
   - `UserGroupIcon` (for Active Contributors) -- people/group style
4. Props interface: `{ stats: IpDashboardStats; trendData: QualityTrendPoint[] }`
5. Render a stat cards grid (4 cards in a 2x2 on sm, 4 cols on lg):
   ```tsx
   <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
     <StatCard label="Skills Captured" value={stats.totalSkillsCaptured} icon={<DatabaseIcon />} />
     <StatCard label="Total Uses" value={stats.totalUses.toLocaleString()} icon={<ChartBarIcon />} />
     <StatCard label="Hours Saved" value={stats.totalHoursSaved.toFixed(1)} icon={<ClockIcon />} />
     <StatCard label="Active Contributors" value={stats.activeContributors} icon={<UserGroupIcon />} />
   </div>
   ```
   NOTE: `toLocaleString()` on numbers is safe for formatting (it's `toLocaleDateString()` on Dates that causes hydration issues). However, to be extra safe, use a simple comma formatter: `value={stats.totalUses.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}` instead of `toLocaleString()`.

6. Below the stat cards, render the quality trends chart in a card container:
   ```tsx
   <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
     <h3 className="mb-4 text-sm font-medium text-gray-500">Quality Trends</h3>
     <QualityTrendChart data={trendData} />
   </div>
   ```
  </action>
  <verify>
Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | grep -E "ip-dashboard|quality-trend" | head -20` to verify no type errors.
  </verify>
  <done>
Admin-gated IP dashboard page renders at `/leverage/ip-dashboard` with hero stat cards grid and quality trends chart container. Non-admins are redirected. Stats are all-time; trend chart responds to TimeRangeSelector.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create multi-line quality trend chart component</name>
  <files>apps/web/components/quality-trend-chart.tsx</files>
  <action>
Create `apps/web/components/quality-trend-chart.tsx` as a "use client" component. Follow the pattern from `cost-trend-chart.tsx` but use a multi-line LineChart instead of a single-series AreaChart.

1. Imports:
   ```typescript
   import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from "recharts";
   import type { QualityTrendPoint } from "@/lib/ip-dashboard-queries";
   ```

2. Props interface:
   ```typescript
   interface QualityTrendChartProps {
     data: QualityTrendPoint[];
     height?: number;
   }
   ```

3. UTC date formatter for month labels (YYYY-MM -> "Jan 2026"):
   ```typescript
   const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
   function formatMonth(ym: string): string {
     const [year, month] = ym.split("-");
     return MONTHS[parseInt(month, 10) - 1] + " " + year;
   }
   ```
   This is hydration-safe because it operates on a YYYY-MM string, not a Date object.

4. Empty state: If `data.length === 0`, render a dashed border placeholder:
   ```tsx
   <div className="flex h-[300px] items-center justify-center rounded-lg border border-dashed border-gray-300 bg-gray-50">
     <p className="text-sm text-gray-500">No quality data for this period</p>
   </div>
   ```

5. Chart rendering with 3 Line series:
   ```tsx
   <div style={{ height }} className="w-full">
     <ResponsiveContainer width="100%" height="100%">
       <LineChart data={data} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
         <CartesianGrid strokeDasharray="3 3" className="stroke-gray-200" />
         <XAxis dataKey="date" tick={{ fontSize: 12 }} tickFormatter={formatMonth} />
         <YAxis tick={{ fontSize: 12 }} domain={[0, 100]} tickFormatter={(v) => `${v}%`} />
         <Tooltip
           labelFormatter={(label) => formatMonth(String(label))}
           formatter={(value: number, name: string) => [value != null ? `${value.toFixed(1)}%` : "N/A", name]}
           contentStyle={{ borderRadius: "0.5rem", border: "1px solid #e5e7eb" }}
         />
         <Legend />
         <Line type="monotone" dataKey="avgRating" stroke="#3b82f6" name="Avg Rating" strokeWidth={2} dot={false} connectNulls />
         <Line type="monotone" dataKey="sentimentPct" stroke="#10b981" name="Positive Sentiment" strokeWidth={2} dot={false} connectNulls />
         <Line type="monotone" dataKey="benchmarkScore" stroke="#8b5cf6" name="Benchmark Score" strokeWidth={2} dot={false} connectNulls />
       </LineChart>
     </ResponsiveContainer>
   </div>
   ```

Key details:
- Y axis domain is [0, 100] since all series are normalized to 0-100 scale
- Y axis shows percentage formatting
- `connectNulls` prop on each Line handles months where one series has no data
- Colors: blue (#3b82f6) for rating, green (#10b981) for sentiment, purple (#8b5cf6) for benchmark -- matches codebase palette
- `dot={false}` for clean lines (matching cost-trend-chart.tsx style)
- Legend shows which line is which
- Default height is 300px (same as cost-trend-chart.tsx)
  </action>
  <verify>
Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | grep -i "quality-trend" | head -10` to verify no type errors.

Then run Playwright E2E tests for the leverage pages:
`cd /home/dev/projects/relay/apps/web && node_modules/.bin/playwright test tests/e2e/leverage.spec.ts --reporter=line 2>&1 | tail -20`
If no leverage-specific test file exists, run a build check instead:
`cd /home/dev/projects/relay && pnpm build 2>&1 | tail -30`
  </verify>
  <done>
Quality trend chart renders a multi-line LineChart with 3 series (avg rating, positive sentiment, benchmark score) normalized to 0-100 scale. Empty state shows placeholder message. Chart uses UTC-safe date formatting. All series use `connectNulls` for partial data graceful handling.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes with zero errors across all new/modified files
2. Build succeeds (`pnpm build`)
3. Admin can navigate to `/leverage/ip-dashboard` and see stat cards + quality trend chart
4. Non-admin users are redirected to `/leverage`
5. TimeRangeSelector changes the quality trend chart data window
6. Empty data states render gracefully (no crashes)
7. No hydration-unsafe patterns (no toLocaleDateString on Date objects)
8. Playwright E2E tests pass (or build-level verification if no specific test exists)
</verification>

<success_criteria>
- IP Dashboard page renders at `/leverage/ip-dashboard` with 4 hero stat cards and a quality trends chart
- Page is admin-only (redirects non-admins)
- Chart shows 3 data series (rating, sentiment, benchmark) on a 0-100 scale
- TimeRangeSelector controls the chart's time window
- All data is tenant-scoped
- Empty states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/62-company-ip-dashboard-core/62-02-SUMMARY.md`
</output>
