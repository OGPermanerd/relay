---
phase: 62-company-ip-dashboard-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/ip-dashboard-queries.ts
  - apps/web/app/(protected)/leverage/leverage-nav.tsx
autonomous: true

must_haves:
  truths:
    - "IP dashboard query module returns hero stats (total skills, uses, hours saved, active contributors) scoped to a tenant"
    - "IP dashboard query module returns monthly quality trend data with rating, sentiment, and benchmark series normalized to 0-100"
    - "IP Dashboard tab appears in leverage nav for admin users only"
  artifacts:
    - path: "apps/web/lib/ip-dashboard-queries.ts"
      provides: "SQL aggregation queries for IP dashboard stats and quality trends"
      exports: ["getIpDashboardStats", "getQualityTrends", "IpDashboardStats", "QualityTrendPoint"]
    - path: "apps/web/app/(protected)/leverage/leverage-nav.tsx"
      provides: "IP Dashboard tab in admin nav"
      contains: "ip-dashboard"
  key_links:
    - from: "apps/web/lib/ip-dashboard-queries.ts"
      to: "@everyskill/db"
      via: "db.execute(sql`...`) with tenant_id filtering"
      pattern: "db\\.execute\\(sql"
---

<objective>
Create the IP dashboard data layer (SQL aggregation queries) and add the nav tab.

Purpose: Establish the query functions that power the hero KPI stat cards and quality trend chart, plus wire up navigation so the IP Dashboard tab appears for admin users.

Output:
- `apps/web/lib/ip-dashboard-queries.ts` with `getIpDashboardStats()` and `getQualityTrends()` functions
- Updated `leverage-nav.tsx` with IP Dashboard tab (adminOnly: true)
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/lib/analytics-queries.ts
@apps/web/app/(protected)/leverage/leverage-nav.tsx
@packages/db/src/schema/skills.ts
@packages/db/src/schema/ratings.ts
@packages/db/src/schema/skill-feedback.ts
@packages/db/src/schema/benchmarks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IP dashboard query module with hero stats and quality trends</name>
  <files>apps/web/lib/ip-dashboard-queries.ts</files>
  <action>
Create `apps/web/lib/ip-dashboard-queries.ts` following the exact pattern from `analytics-queries.ts`:

1. Import `db` from `@everyskill/db` and `sql` from `drizzle-orm`.

2. Define and export `IpDashboardStats` interface:
   - `totalSkillsCaptured: number` (COUNT of published skills)
   - `totalUses: number` (COUNT of usage_events)
   - `totalHoursSaved: number` (SUM of hours_saved * total_uses from skills)
   - `activeContributors: number` (COUNT DISTINCT author_id from published skills)

3. Implement `getIpDashboardStats(tenantId: string): Promise<IpDashboardStats>`:
   - Guard: `if (!db) return { totalSkillsCaptured: 0, totalUses: 0, totalHoursSaved: 0, activeContributors: 0 };`
   - Use a single SQL query with subselects (no time filter -- these are all-time cumulative KPIs):
     ```sql
     SELECT
       (SELECT COUNT(*)::integer FROM skills WHERE tenant_id = ${tenantId} AND status = 'published') AS total_skills,
       (SELECT COUNT(*)::integer FROM usage_events WHERE tenant_id = ${tenantId}) AS total_uses,
       (SELECT COALESCE(SUM(COALESCE(hours_saved, 1) * total_uses), 0)::double precision
        FROM skills WHERE tenant_id = ${tenantId} AND status = 'published') AS total_hours_saved,
       (SELECT COUNT(DISTINCT author_id)::integer FROM skills WHERE tenant_id = ${tenantId} AND author_id IS NOT NULL AND status = 'published') AS active_contributors
     ```
   - Cast result: `const rows = result as unknown as Record<string, unknown>[]; const row = rows[0];`
   - Return typed object with `Number(row?.field ?? 0)` for each field.

4. Define and export `QualityTrendPoint` interface:
   - `date: string` (YYYY-MM format)
   - `avgRating: number | null` (normalized 0-100 from ratings 1-5 scale, null if no data)
   - `sentimentPct: number | null` (0-100% positive feedback, null if no data)
   - `benchmarkScore: number | null` (0-100 from benchmark_results, null if no data)

5. Implement `getQualityTrends(tenantId: string, startDate: Date): Promise<QualityTrendPoint[]>`:
   - Guard: `if (!db) return [];`
   - Convert startDate: `const startDateStr = startDate.toISOString();`
   - Run three separate SQL queries (simpler than a complex multi-table JOIN):

   Query 1 (ratings by month -- normalize 1-5 to 0-100 by multiplying by 20):
   ```sql
   SELECT to_char(date_trunc('month', created_at), 'YYYY-MM') AS month,
          (AVG(rating) * 20)::double precision AS avg_rating_pct
   FROM ratings
   WHERE tenant_id = ${tenantId} AND created_at >= ${startDateStr}
   GROUP BY date_trunc('month', created_at)
   ORDER BY month
   ```

   Query 2 (feedback sentiment by month -- thumbs_up percentage):
   ```sql
   SELECT to_char(date_trunc('month', created_at), 'YYYY-MM') AS month,
          CASE WHEN COUNT(*) FILTER (WHERE feedback_type IN ('thumbs_up','thumbs_down')) > 0
            THEN (COUNT(*) FILTER (WHERE feedback_type = 'thumbs_up') * 100.0 /
                  COUNT(*) FILTER (WHERE feedback_type IN ('thumbs_up','thumbs_down')))::double precision
            ELSE NULL
          END AS sentiment_pct
   FROM skill_feedback
   WHERE tenant_id = ${tenantId} AND created_at >= ${startDateStr}
   GROUP BY date_trunc('month', created_at)
   ORDER BY month
   ```

   Query 3 (benchmark quality by month):
   ```sql
   SELECT to_char(date_trunc('month', br.created_at), 'YYYY-MM') AS month,
          AVG(bres.quality_score)::double precision AS avg_benchmark
   FROM benchmark_runs br
   JOIN benchmark_results bres ON bres.benchmark_run_id = br.id
   WHERE br.tenant_id = ${tenantId} AND br.created_at >= ${startDateStr}
     AND bres.quality_score IS NOT NULL
   GROUP BY date_trunc('month', br.created_at)
   ORDER BY month
   ```

   - Merge results by month: collect all unique months from all 3 queries, create a Map keyed by month, then produce a sorted array of `QualityTrendPoint` objects with null for any series missing that month.
   - Sort final array by date ascending.

IMPORTANT: Follow the exact `db.execute(sql`...`)` pattern from analytics-queries.ts. Use `as unknown as Record<string, unknown>[]` for result casting. NEVER use `toLocaleDateString()`.
  </action>
  <verify>
Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | grep -i "ip-dashboard" | head -20` to verify no type errors in the new file.
  </verify>
  <done>
`ip-dashboard-queries.ts` exports `getIpDashboardStats` and `getQualityTrends` functions with proper TypeScript interfaces. Both functions are tenant-scoped (require tenantId parameter). Hero stats are all-time (no date filter). Quality trends accept a startDate and return monthly data points with all three series normalized to 0-100 scale.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add IP Dashboard tab to leverage navigation</name>
  <files>apps/web/app/(protected)/leverage/leverage-nav.tsx</files>
  <action>
In `apps/web/app/(protected)/leverage/leverage-nav.tsx`, add a new entry to the `tabs` array:

```typescript
{ label: "IP Dashboard", href: "/leverage/ip-dashboard", adminOnly: true },
```

Add it after the existing "Skills" tab entry (last position in the array).

This is a one-line change. The existing `LeverageNav` component already handles `adminOnly` filtering -- no other changes needed.
  </action>
  <verify>
Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | grep -i "leverage-nav" | head -5` to verify no type errors. Grep the file to confirm the new tab: `grep "ip-dashboard" apps/web/app/\(protected\)/leverage/leverage-nav.tsx`
  </verify>
  <done>
Leverage nav shows "IP Dashboard" tab for admin users, linking to `/leverage/ip-dashboard`. Non-admin users do not see the tab.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes with no errors in the new/modified files
2. `ip-dashboard-queries.ts` exports all 4 items: `getIpDashboardStats`, `getQualityTrends`, `IpDashboardStats`, `QualityTrendPoint`
3. `leverage-nav.tsx` includes the IP Dashboard tab with `adminOnly: true`
4. All SQL queries include `tenant_id = ${tenantId}` filtering
</verification>

<success_criteria>
- Query module compiles and exports typed functions for hero stats and quality trends
- Nav tab is registered and only visible to admin users
- No hydration-unsafe patterns (no toLocaleDateString)
</success_criteria>

<output>
After completion, create `.planning/phases/62-company-ip-dashboard-core/62-01-SUMMARY.md`
</output>
