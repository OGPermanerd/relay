---
phase: 70-mcp-preference-sync
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mcp/src/tools/search.ts
  - apps/mcp/src/tools/recommend.ts
  - apps/mcp/src/tools/list.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated MCP search results boost skills in user's preferred categories to top of results"
    - "Authenticated MCP recommend results boost skills in user's preferred categories via similarity score multiplier"
    - "Authenticated MCP list results respect user's defaultSort preference"
    - "Anonymous (no API key) MCP search/recommend/list still works without errors (no boost, default sort)"
  artifacts:
    - path: "apps/mcp/src/tools/search.ts"
      provides: "Preference boost reranking for text search"
      contains: "getOrCreateUserPreferences"
    - path: "apps/mcp/src/tools/recommend.ts"
      provides: "Preference boost for semantic search via PREFERENCE_BOOST multiplier"
      contains: "PREFERENCE_BOOST"
    - path: "apps/mcp/src/tools/list.ts"
      provides: "defaultSort preference applied to list ordering"
      contains: "getOrCreateUserPreferences"
  key_links:
    - from: "apps/mcp/src/tools/search.ts"
      to: "@everyskill/db/services/user-preferences"
      via: "getOrCreateUserPreferences"
      pattern: "getOrCreateUserPreferences"
    - from: "apps/mcp/src/tools/recommend.ts"
      to: "@everyskill/db/services/user-preferences"
      via: "getOrCreateUserPreferences"
      pattern: "getOrCreateUserPreferences"
    - from: "apps/mcp/src/tools/list.ts"
      to: "@everyskill/db/services/user-preferences"
      via: "getOrCreateUserPreferences for defaultSort"
      pattern: "getOrCreateUserPreferences"
---

<objective>
Add preference-based boosting to MCP search, recommend, and list handlers.

Purpose: Satisfies VIS-07 (MCP search applies user preference boosts when authenticated). Authenticated users' preferred categories boost search/recommend results, and their defaultSort preference controls list ordering -- matching the web UI behavior.

Output: Modified search.ts, recommend.ts, and list.ts with preference integration.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/mcp/src/tools/search.ts
@apps/mcp/src/tools/recommend.ts
@apps/mcp/src/tools/list.ts
@apps/mcp/src/auth.ts
@packages/db/src/services/user-preferences.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add preference boost to search handler</name>
  <files>apps/mcp/src/tools/search.ts</files>
  <action>
Modify `apps/mcp/src/tools/search.ts` to apply preference-based reranking for authenticated users.

**Add imports:**
```typescript
import { getOrCreateUserPreferences } from "@everyskill/db/services/user-preferences";
```

**After the existing `searchSkillsByQuery` call and before tracking**, add preference boost logic:

1. Check if `userId && tenantId` are both truthy
2. If so, wrap in try/catch (preference failure must not break search):
   - `const prefs = await getOrCreateUserPreferences(userId, tenantId)`
   - `const preferred = prefs?.preferredCategories ?? []`
   - If `preferred.length > 0`:
     - Map results to add `isBoosted: preferred.includes(r.category)` field
     - Stable sort: boosted items move up while preserving relative order among boosted and non-boosted groups
     - Use this sort comparator: `(a, b) => { if (a.isBoosted && !b.isBoosted) return -1; if (!a.isBoosted && b.isBoosted) return 1; return 0; }`
3. If no userId or tenantId, skip boost entirely (anonymous path unchanged)

**Why stable reranking (not score multiplication):** MCP text search (`searchSkillsByQuery`) returns ILIKE-matched results ordered by a SQL expression. The score is not exposed in the result set, so there's no numeric score to multiply. Instead, promote preferred-category results within the relevance order. This is the research recommendation for text search.

The `enriched` map that adds `displayRating` should operate on the boosted results (not original).
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm turbo typecheck` -- no errors in apps/mcp.
  </verify>
  <done>
- search.ts imports getOrCreateUserPreferences
- Preference boost applied after searchSkillsByQuery, before tracking
- Anonymous users unaffected (guarded by userId && tenantId check)
- Boost failure caught in try/catch (doesn't break search)
- TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Add preference boost to recommend handler and defaultSort to list handler</name>
  <files>
    apps/mcp/src/tools/recommend.ts
    apps/mcp/src/tools/list.ts
  </files>
  <action>
**A. Modify `apps/mcp/src/tools/recommend.ts`:**

Add imports:
```typescript
import { getOrCreateUserPreferences } from "@everyskill/db/services/user-preferences";
```

Add constant:
```typescript
const PREFERENCE_BOOST = 1.3;
```
This matches the web UI's boost factor in `apps/web/app/actions/discover.ts`.

**After** the results are collected (after both semantic and text fallback paths, but before tracking), add boost logic:

1. Check `userId && tenantId`
2. Wrap in try/catch
3. Load preferences, get `preferredCategories`
4. If `preferred.length > 0`:
   - For semantic results (`searchMethod === "semantic"`): multiply `similarity` score by `PREFERENCE_BOOST` for preferred categories, then re-sort by similarity descending
   - For text fallback results: use stable reranking (same as search.ts -- no score to multiply)
5. Assign boosted results back

**Why score multiplication for semantic:** Unlike text search, semantic search exposes `similarity` scores. Multiplying by 1.3 and re-sorting matches the web's RRF boost pattern exactly.

**B. Modify `apps/mcp/src/tools/list.ts`:**

Add imports:
```typescript
import { getOrCreateUserPreferences } from "@everyskill/db/services/user-preferences";
import { desc, asc } from "drizzle-orm";
```
(Check if `desc`/`asc` are already imported; add only if missing.)

**Before the DB query**, load user's `defaultSort` preference:
1. Check `userId && tenantId`
2. Wrap in try/catch
3. Load preferences, get `defaultSort` (default: `"days_saved"`)

**Apply `defaultSort` to the DB query** by adding `.orderBy()`:
- `"uses"` -> `desc(skills.totalUses)`
- `"quality"` -> `desc(skills.qualityScore)` (check if `skills.qualityScore` exists; if not, fall back to `desc(skills.averageRating)`)
- `"rating"` -> `desc(skills.averageRating)`
- `"days_saved"` -> `desc(skills.hoursSaved)`

If no authenticated user or preference load fails, keep current behavior (no explicit orderBy, which uses SQL default).

Also add `hoursSaved` is already in the select. Add `totalUses` and `averageRating` to the select if not already present -- they're needed for sorting and are useful for display.
  </action>
  <verify>
`cd /home/dev/projects/relay && pnpm turbo typecheck` -- no errors in apps/mcp.
`cd /home/dev/projects/relay && pnpm lint` -- no errors.
  </verify>
  <done>
- recommend.ts has PREFERENCE_BOOST = 1.3 and applies it to semantic similarity scores
- recommend.ts falls back to stable reranking for text results
- list.ts loads defaultSort from user preferences and applies orderBy to DB query
- Both files handle anonymous users gracefully (no boost, no custom sort)
- Both files catch preference loading errors in try/catch
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo typecheck` passes with no errors
2. `pnpm lint` passes with no errors
3. search.ts: grep for `getOrCreateUserPreferences` confirms preference loading
4. recommend.ts: grep for `PREFERENCE_BOOST` confirms 1.3 boost factor
5. list.ts: grep for `defaultSort` confirms sort preference wiring
6. All three files: grep for `try.*catch` around preference loading confirms graceful degradation
</verification>

<success_criteria>
- Authenticated MCP search results promote preferred-category skills to top via stable reranking
- Authenticated MCP recommend results boost preferred-category similarity scores by 1.3x
- Authenticated MCP list results sort by user's defaultSort preference
- Anonymous users experience no change (no errors, no boost, default sort)
- PREFERENCE_BOOST = 1.3 matches web UI value exactly
</success_criteria>

<output>
After completion, create `.planning/phases/70-mcp-preference-sync/70-02-SUMMARY.md`
</output>
