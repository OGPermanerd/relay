---
phase: 70-mcp-preference-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mcp/src/tools/preferences.ts
  - apps/mcp/src/tools/everyskill.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated MCP user can call get_preferences and receive their preferredCategories and defaultSort"
    - "Authenticated MCP user can call set_preferences with preferredCategories and/or defaultSort and the change persists"
    - "set_preferences preserves claudeMdWorkflowNotes and trainingDataConsent fields (read-modify-write)"
    - "Unauthenticated MCP user calling get_preferences or set_preferences receives a clear auth error"
  artifacts:
    - path: "apps/mcp/src/tools/preferences.ts"
      provides: "handleGetPreferences and handleSetPreferences handler functions"
      exports: ["handleGetPreferences", "handleSetPreferences"]
    - path: "apps/mcp/src/tools/everyskill.ts"
      provides: "get_preferences and set_preferences in ACTIONS, schema fields, switch cases"
      contains: "get_preferences"
  key_links:
    - from: "apps/mcp/src/tools/everyskill.ts"
      to: "apps/mcp/src/tools/preferences.ts"
      via: "import handleGetPreferences, handleSetPreferences"
      pattern: "import.*handleGetPreferences.*preferences"
    - from: "apps/mcp/src/tools/preferences.ts"
      to: "@everyskill/db/services/user-preferences"
      via: "getOrCreateUserPreferences, updateUserPreferences"
      pattern: "getOrCreateUserPreferences|updateUserPreferences"
---

<objective>
Add get_preferences and set_preferences actions to the unified everyskill MCP tool.

Purpose: Satisfies VIS-06 (MCP tools can read and write user search preferences). Users can manage their preferredCategories and defaultSort from within MCP clients, with changes visible in the web UI.

Output: New preferences.ts handler file + updated everyskill.ts with two new actions wired in.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/mcp/src/tools/everyskill.ts
@apps/mcp/src/auth.ts
@packages/db/src/services/user-preferences.ts
@packages/db/src/schema/user-preferences.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preferences handler and wire into unified tool</name>
  <files>
    apps/mcp/src/tools/preferences.ts
    apps/mcp/src/tools/everyskill.ts
  </files>
  <action>
**1. Create `apps/mcp/src/tools/preferences.ts`:**

Create a new file with two exported handler functions:

`handleGetPreferences({ userId })`:
- If `!userId`, return `{ content: [{ type: "text", text: JSON.stringify({ error: "Authentication required", message: "Set EVERYSKILL_API_KEY to access your preferences" }) }], isError: true }`
- Get `tenantId` from `getTenantId()` (import from `../auth.js`). If `!tenantId`, return same auth error.
- Call `getOrCreateUserPreferences(userId, tenantId)` from `@everyskill/db/services/user-preferences`
- Track usage: `trackUsage({ toolName: "get_preferences", userId, metadata: {} })` from `../tracking/events.js`
- Return `{ content: [{ type: "text", text: JSON.stringify({ preferredCategories: prefs?.preferredCategories ?? [], defaultSort: prefs?.defaultSort ?? "days_saved" }, null, 2) }] }`

`handleSetPreferences({ userId, preferredCategories, defaultSort })`:
- Same auth guard as above
- **CRITICAL: Read-modify-write** to avoid overwriting claudeMdWorkflowNotes and trainingDataConsent:
  1. `const current = await getOrCreateUserPreferences(userId, tenantId)`
  2. Build merged object: spread current, then conditionally spread `preferredCategories` and `defaultSort` only if they were provided (not undefined)
  3. Type-cast merged result as `UserPreferencesData` (import from `@everyskill/db/schema/user-preferences`)
  4. Call `updateUserPreferences(userId, merged)`
- Track usage with toolName `"set_preferences"`
- Return success JSON with the updated `preferredCategories` and `defaultSort` values

Import `type UserPreferencesData` from `@everyskill/db/schema/user-preferences`.
All logging must use `console.error` (never console.log -- MCP stdio corruption).

**2. Update `apps/mcp/src/tools/everyskill.ts`:**

a. Add imports at top:
```typescript
import { handleGetPreferences, handleSetPreferences } from "./preferences.js";
```

b. Add to ACTIONS array (after "feedback"):
```typescript
"get_preferences",
"set_preferences",
```

c. Add to `EverySkillInputSchema` (after `comment` field):
```typescript
preferredCategories: z.array(
  z.enum(["productivity", "wiring", "doc-production", "data-viz", "code"])
).optional().describe("Preferred skill categories (used by: set_preferences)"),
defaultSort: z.enum(["uses", "quality", "rating", "days_saved"])
  .optional().describe("Default sort order (used by: set_preferences)"),
```

d. Add to `EverySkillArgs` type:
```typescript
preferredCategories?: ("productivity" | "wiring" | "doc-production" | "data-viz" | "code")[];
defaultSort?: "uses" | "quality" | "rating" | "days_saved";
```

e. Add switch cases before `default:`:
```typescript
case "get_preferences": {
  return handleGetPreferences({ userId });
}
case "set_preferences": {
  return handleSetPreferences({
    userId,
    preferredCategories: args.preferredCategories,
    defaultSort: args.defaultSort,
  });
}
```

f. Update the `action` field's `.describe()` string to include the two new actions.

g. Update the `description` string in `server.registerTool("everyskill", ...)` to mention preference management.
  </action>
  <verify>
Run `cd /home/dev/projects/relay && pnpm turbo typecheck` -- must pass with no errors in `apps/mcp`.
Run `cd /home/dev/projects/relay && pnpm lint` -- must pass with no errors.
  </verify>
  <done>
- `preferences.ts` exists with handleGetPreferences and handleSetPreferences exported
- everyskill.ts has "get_preferences" and "set_preferences" in ACTIONS array
- EverySkillInputSchema has preferredCategories and defaultSort fields
- EverySkillArgs type includes the new optional fields
- Switch cases route to the handler functions
- TypeScript compiles without errors
- set_preferences uses read-modify-write pattern (not full replace)
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo typecheck` passes
2. `pnpm lint` passes
3. `preferences.ts` imports from `@everyskill/db/services/user-preferences` and `../auth.js`
4. Both handlers check userId AND tenantId before DB access
5. `set_preferences` reads current prefs before writing (grep for `getOrCreateUserPreferences` inside `handleSetPreferences`)
</verification>

<success_criteria>
- Two new actions (get_preferences, set_preferences) registered in the unified everyskill tool
- Both actions require authentication (API key)
- set_preferences preserves non-exposed JSONB fields via read-modify-write
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/70-mcp-preference-sync/70-01-SUMMARY.md`
</output>
