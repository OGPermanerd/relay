---
phase: 60-token-cost-measurement
plan: 03
type: execute
wave: 2
depends_on: ["60-01"]
files_modified:
  - apps/web/lib/skill-stats.ts
  - apps/web/components/skill-detail.tsx
  - apps/web/app/(protected)/skills/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Skill detail page displays average cost per use when token measurements exist"
    - "Skill detail page displays total estimated cost when token measurements exist"
    - "Cost stats show graceful empty state (no cost cards) when no measurements exist"
    - "Existing stat cards and layout are unchanged"
  artifacts:
    - path: "apps/web/lib/skill-stats.ts"
      provides: "Extended getSkillStats that includes cost data"
      contains: "getSkillCostStats"
    - path: "apps/web/components/skill-detail.tsx"
      provides: "Cost StatCards in the stats grid"
      contains: "Avg Cost"
    - path: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      provides: "Cost stats fetched and passed to SkillDetail"
      contains: "costStats"
  key_links:
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "packages/db/src/services/token-measurements.ts"
      via: "getSkillCostStats call in parallel data fetch"
      pattern: "getSkillCostStats"
    - from: "apps/web/components/skill-detail.tsx"
      to: "apps/web/lib/pricing-table.ts"
      via: "formatCostMicrocents for display"
      pattern: "formatCostMicrocents"
---

<objective>
Display per-skill cost aggregation on the skill detail page.

Purpose: TOKEN-06 -- users see average cost per use and total estimated cost for each skill, derived from token_measurements data.
Output: Cost StatCards on skill detail page with graceful empty state.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@apps/web/components/skill-detail.tsx
@apps/web/app/(protected)/skills/[slug]/page.tsx
@apps/web/lib/skill-stats.ts
@.planning/phases/60-token-cost-measurement/60-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fetch cost stats and display on skill detail page</name>
  <files>
    apps/web/lib/skill-stats.ts
    apps/web/components/skill-detail.tsx
    apps/web/app/(protected)/skills/[slug]/page.tsx
  </files>
  <action>
    1. In `apps/web/app/(protected)/skills/[slug]/page.tsx`:
       - Import `getSkillCostStats` from `@everyskill/db/services` (it's exported from the services index in Plan 01).
       - Import `SkillCostStats` type from `@everyskill/db/services`.
       - Add `getSkillCostStats(skill.id)` to the existing parallel `Promise.all` data fetch (alongside getSkillStats, getSkillDetailTrends, etc.). Assign result to `costStats`.
       - Pass `costStats` as a new prop to `<SkillDetail>`.

    2. In `apps/web/components/skill-detail.tsx`:
       - Import `formatCostMicrocents` from `@/lib/pricing-table`.
       - Add `costStats` to the `SkillDetailProps` interface as optional: `costStats?: { totalCostMicrocents: number; avgCostPerUseMicrocents: number; measurementCount: number; predominantModel: string | null }`.
       - In the stats grid (the `grid grid-cols-2 gap-4 sm:grid-cols-4` div), add two conditional StatCards AFTER the existing cards (before the forkCount card):
         - Only render if `costStats && costStats.measurementCount > 0`:
           - `<StatCard label="Avg Cost / Use" value={formatCostMicrocents(costStats.avgCostPerUseMicrocents)} />`
           - `<StatCard label="Total Est. Cost" value={formatCostMicrocents(costStats.totalCostMicrocents)} suffix={costStats.predominantModel ? costStats.predominantModel.replace('claude-', '').split('-202')[0] : undefined} />`
       - This keeps the grid clean when no measurements exist (no empty cards).

    3. In `apps/web/lib/pricing-table.ts` (created in Plan 01):
       - Verify it re-exports `estimateCostMicrocents` from `@everyskill/db/services/pricing` and exports `formatCostMicrocents`.
       - If Plan 01 put formatCostMicrocents here, no changes needed. If not, add it:
         ```typescript
         export function formatCostMicrocents(microcents: number): string {
           if (microcents === 0) return "$0.00";
           const dollars = microcents / 100_000_000;
           if (dollars < 0.01) return "<$0.01";
           if (dollars < 1) return "$" + dollars.toFixed(2);
           return "$" + dollars.toFixed(2);
         }
         ```

    IMPORTANT: Do NOT use `toLocaleString()` or any locale-dependent formatting in the client component (hydration mismatch risk per project memory). Use simple string concatenation with toFixed().
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && pnpm build` to verify no TypeScript errors.
    Run Playwright tests for the skill detail page: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/skill-detail.spec.ts` (or the relevant test file) to confirm the page loads without errors.
  </verify>
  <done>
    Skill detail page shows "Avg Cost / Use" and "Total Est. Cost" StatCards when token_measurements exist for the skill. When no measurements exist, no cost cards appear. Existing cards and layout unchanged. Page loads without hydration errors.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- Skill detail page loads without errors (Playwright)
- Cost cards appear only when measurementCount > 0
- formatCostMicrocents produces readable dollar amounts
- No hydration mismatches (no locale-dependent formatting)
</verification>

<success_criteria>
TOKEN-06: Per-skill cost aggregation visible on skill detail page (avg cost per use, total cost)
</success_criteria>

<output>
After completion, create `.planning/phases/60-token-cost-measurement/60-03-SUMMARY.md`
</output>
