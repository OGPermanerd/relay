---
phase: 20-api-key-management
plan: 03
type: execute
wave: 2
depends_on: ["20-01", "20-02"]
files_modified:
  - apps/web/app/api/auth/validate-key/route.ts
  - apps/web/app/actions/api-keys.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/auth/validate-key returns userId for valid keys and 401 for invalid"
    - "Validation endpoint works without Auth.js session (public route)"
    - "Server actions require authenticated session"
    - "Raw key returned exactly once from generate/rotate"
  artifacts:
    - path: "apps/web/app/api/auth/validate-key/route.ts"
      exports: ["POST"]
    - path: "apps/web/app/actions/api-keys.ts"
      exports: ["generateApiKey", "revokeApiKeyAction", "rotateApiKey", "listApiKeysAction", "listAllApiKeysAction"]
---

<objective>
Create the validation endpoint and server actions for API key operations.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@packages/db/src/schema/api-keys.ts
@apps/web/lib/api-key-crypto.ts
@apps/web/lib/admin.ts
@apps/web/app/actions/skills.ts
@apps/web/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Create validate-key route handler</name>
  <files>apps/web/app/api/auth/validate-key/route.ts</files>
  <action>
Create `apps/web/app/api/auth/validate-key/route.ts`:

- Export async POST handler accepting NextRequest
- Parse JSON body, extract `key` field
- If key missing or not string, return 400 `{ error: "Missing key" }`
- Import `validateApiKey` from `@relay/db/services/api-keys`
- Call validateApiKey(key)
- If null, return 401 `{ error: "Invalid or expired key" }`
- If valid, return 200 `{ userId, keyId }`
- NO auth session check -- this route must work without a session (middleware already allows /api/auth/* paths through)
  </action>
  <verify>`npx tsc --noEmit -p apps/web/tsconfig.json` passes</verify>
  <done>Validation endpoint at /api/auth/validate-key accepts POST, returns userId or 401.</done>
</task>

<task type="auto">
  <name>Create api-keys server actions</name>
  <files>apps/web/app/actions/api-keys.ts</files>
  <action>
Create `apps/web/app/actions/api-keys.ts` with "use server" directive. Follow the pattern from `apps/web/app/actions/skills.ts` for auth checks.

**generateApiKey(formData: FormData): Promise<{ key?: string; error?: string }>**
- Require session via `auth()`. Parse `name` (string 1-100, zod) and optional `forUserId`.
- If forUserId differs from session.user.id, check `isAdmin(session.user.email)` -- error if not admin.
- Call `generateRawApiKey()`, `hashApiKey()`, `extractPrefix()` from `@/lib/api-key-crypto`.
- Insert via `db.insert(apiKeys).values(...)` (import apiKeys from `@relay/db`).
- `revalidatePath("/profile")`. Return `{ key: rawKey }`.

**revokeApiKeyAction(keyId: string): Promise<{ success?: boolean; error?: string }>**
- Require session. Query key by id to verify ownership or admin status.
- Call `revokeApiKey(keyId)` from service layer. Revalidate.

**rotateApiKey(formData: FormData): Promise<{ key?: string; error?: string }>**
- Require session. Call `setKeyExpiry(session.user.id, 24)` to expire old keys.
- Generate new key (same as generateApiKey but always for self). Revalidate.

**listApiKeysAction(): Promise<{ keys?: Array<any>; error?: string }>**
- Require session. Call `listUserKeys(session.user.id)`.

**listAllApiKeysAction(): Promise<{ keys?: Array<any>; error?: string }>**
- Require session + isAdmin check. Query all keys with user info join.
  </action>
  <verify>`npx tsc --noEmit -p apps/web/tsconfig.json` passes</verify>
  <done>Five server actions: generate, revoke, rotate, list, listAll. All auth-guarded.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p apps/web/tsconfig.json` passes
2. Validation endpoint exports POST handler
3. Server actions start with "use server"
</verification>

<success_criteria>
- POST /api/auth/validate-key works without session, returns userId or 401
- generateApiKey returns raw key exactly once
- rotateApiKey expires old keys with 24h grace period
- Admin operations gate on isAdmin
</success_criteria>

<output>
After completion, create `.planning/phases/20-api-key-management/20-03-SUMMARY.md`
</output>
