---
phase: 20-api-key-management
plan: 03
type: execute
wave: 3
depends_on: ["20-02"]
files_modified:
  - apps/web/app/(protected)/profile/page.tsx
  - apps/web/components/api-key-manager.tsx
autonomous: true

must_haves:
  truths:
    - "Employee can generate a personal API key from their profile page"
    - "Full raw key is displayed exactly once at creation, with copy button"
    - "Profile page shows list of existing keys with prefix, name, status, and last used"
    - "Employee can revoke their own keys from the profile page"
    - "Employee can rotate keys -- new key generated while old keys get grace period expiry"
  artifacts:
    - path: "apps/web/components/api-key-manager.tsx"
      provides: "Client component for key generation, display, revocation, and rotation"
      min_lines: 80
    - path: "apps/web/app/(protected)/profile/page.tsx"
      provides: "Updated profile page with API Keys section"
      contains: "ApiKeyManager"
  key_links:
    - from: "apps/web/components/api-key-manager.tsx"
      to: "apps/web/app/actions/api-keys.ts"
      via: "server action calls for generate, revoke, rotate, list"
      pattern: "generateApiKey|revokeApiKeyAction|rotateApiKey|listApiKeysAction"
    - from: "apps/web/app/(protected)/profile/page.tsx"
      to: "apps/web/components/api-key-manager.tsx"
      via: "component import and render"
      pattern: "ApiKeyManager"
---

<objective>
Add an API key management section to the employee profile page where users can generate, view, revoke, and rotate their personal API keys.

Purpose: This delivers KEY-05 (employee self-service key generation) and KEY-06 (key rotation with grace period). The profile page becomes the primary self-service interface for API key management.
Output: Updated profile page with interactive API key management component
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-api-key-management/20-RESEARCH.md
@.planning/phases/20-api-key-management/20-02-SUMMARY.md

@apps/web/app/(protected)/profile/page.tsx
@apps/web/app/actions/api-keys.ts
@apps/web/components/sign-out-button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ApiKeyManager client component</name>
  <files>
    apps/web/components/api-key-manager.tsx
  </files>
  <action>
Create `apps/web/components/api-key-manager.tsx` as a "use client" component.

**Props:** `initialKeys: Array<{ id: string; keyPrefix: string; name: string; lastUsedAt: string | null; createdAt: string; revokedAt: string | null; expiresAt: string | null }>`

**State management:**
- `keys`: the list of keys (initialized from props, refreshed after mutations)
- `newKey`: string | null (the raw key shown exactly once after generation)
- `isGenerating`: boolean loading state
- `isRotating`: boolean loading state
- `showGenerateForm`: boolean toggle
- `copied`: boolean for copy feedback

**Generate key flow:**
- Form with a text input for key name (default: "Default") and a "Generate Key" button
- On submit, call `generateApiKey(formData)` server action
- On success, set `newKey` to the returned raw key
- Display the raw key in a prominent box with monospace font, a "Copy" button, and a warning: "Copy this key now. You will not be able to see it again."
- After the user dismisses (clicks "Done" or navigates away), clear `newKey` from state
- Refresh the keys list by calling `listApiKeysAction()`

**Key rotation flow:**
- "Rotate Key" button that shows a confirmation dialog explaining: "This will generate a new key and expire your existing keys after a grace period (24 hours by default). Both old and new keys will work during the transition."
- On confirm, call `rotateApiKey(formData)` with name and gracePeriodHours
- Display the new raw key (same show-once pattern as generation)
- Refresh keys list

**Key list display:**
- Table or card list showing each key: keyPrefix (monospace, truncated display), name, status badge (Active/Revoked/Expiring), lastUsedAt (relative time or "Never"), createdAt
- Status logic: if revokedAt is set -> "Revoked" (red badge); if expiresAt is set and in the future -> "Expiring" (yellow badge with time remaining); else -> "Active" (green badge)
- Each active/expiring key has a "Revoke" button
- On revoke click, call `revokeApiKeyAction(keyId)` then refresh list

**Styling:** Use Tailwind classes consistent with the existing profile page (white cards, gray-50 background, text-gray-900/600/500 hierarchy, rounded-lg, shadow-sm). Use the same card pattern from the Contribution Statistics section.

**Important behavioral details:**
- The raw key (`newKey`) must NEVER be stored in localStorage, cookies, or any persistent storage -- React state only
- Copy button should use `navigator.clipboard.writeText(newKey)` and show "Copied!" feedback for 2 seconds
- Empty state: "No API keys yet. Generate one to authenticate your MCP sessions."
  </action>
  <verify>
1. `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json` passes
2. Component file has "use client" directive
3. Component imports server actions from `@/app/actions/api-keys`
4. Raw key display includes copy functionality and warning text
5. Keys list never shows keyHash
  </verify>
  <done>ApiKeyManager component handles generate, rotate, revoke, and list. Raw key shown once with copy button and warning. Key list shows status badges. All mutations refresh the list.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ApiKeyManager into profile page and run Playwright tests</name>
  <files>
    apps/web/app/(protected)/profile/page.tsx
  </files>
  <action>
Update `apps/web/app/(protected)/profile/page.tsx`:

1. Import `listApiKeysAction` from `@/app/actions/api-keys`
2. Import `ApiKeyManager` from `@/components/api-key-manager`
3. After the existing "Account Information" section, add a new section:
   - Heading: "API Keys" with subheading: "Manage keys for MCP authentication"
   - Render `<ApiKeyManager initialKeys={keys} />` where `keys` comes from calling `listApiKeysAction()` in the server component
4. Serialize the keys data (convert Date objects to ISO strings) before passing as props to the client component

Keep all existing profile page content unchanged. The new section adds below the Account Information section.

After implementing, run Playwright tests to verify the profile page still loads correctly:
```bash
cd /home/dev/projects/relay && npx playwright test tests/e2e/profile.spec.ts
```

If the profile test passes, also verify the build compiles:
```bash
cd /home/dev/projects/relay && npx next build --no-lint 2>&1 | tail -20
```
  </action>
  <verify>
1. `npx playwright test tests/e2e/profile.spec.ts` passes
2. Profile page renders API Keys section below Account Information
3. `npx tsc --noEmit -p apps/web/tsconfig.json` passes
4. The page is a server component (no "use client") that fetches keys server-side and passes to client component
  </verify>
  <done>Profile page displays API Keys section with the interactive ApiKeyManager component. Existing profile content unchanged. Playwright tests pass.</done>
</task>

</tasks>

<verification>
1. Profile page at /profile shows API Keys section with generate form
2. Key generation flow shows raw key exactly once with copy button
3. Key rotation sets grace period on old keys and generates new key
4. Key revocation immediately marks key as revoked
5. Key list shows status badges (Active/Revoked/Expiring)
6. Playwright profile tests pass
7. TypeScript compiles cleanly
</verification>

<success_criteria>
- Employee can generate a personal API key from profile page (KEY-05)
- Raw key displayed once with copy button and "never shown again" warning
- Key rotation generates new key, old keys expire after 24h grace period (KEY-06)
- Employee can revoke their own keys
- Key list shows prefix, name, status, last used time
- Existing profile page content preserved
</success_criteria>

<output>
After completion, create `.planning/phases/20-api-key-management/20-03-SUMMARY.md`
</output>
