---
phase: 20-api-key-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/api-keys.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/relations/index.ts
  - apps/web/lib/api-key-crypto.ts
  - apps/web/lib/admin.ts
autonomous: true

must_haves:
  truths:
    - "api_keys table exists in the database with correct columns"
    - "Crypto utilities generate rlk_-prefixed keys and SHA-256 hashes"
    - "Admin check resolves against ADMIN_EMAILS env var"
  artifacts:
    - path: "packages/db/src/schema/api-keys.ts"
      provides: "apiKeys table definition with id, userId, keyHash, keyPrefix, name, lastUsedAt, createdAt, revokedAt, expiresAt"
      contains: "pgTable"
    - path: "apps/web/lib/api-key-crypto.ts"
      provides: "generateRawApiKey, hashApiKey, extractPrefix functions"
      exports: ["generateRawApiKey", "hashApiKey", "extractPrefix"]
    - path: "apps/web/lib/admin.ts"
      provides: "isAdmin helper checking ADMIN_EMAILS env var"
      exports: ["isAdmin"]
  key_links:
    - from: "packages/db/src/schema/api-keys.ts"
      to: "packages/db/src/schema/users.ts"
      via: "userId foreign key reference"
      pattern: "references.*users\\.id"
    - from: "packages/db/src/schema/index.ts"
      to: "packages/db/src/schema/api-keys.ts"
      via: "re-export"
      pattern: "export.*api-keys"
    - from: "packages/db/src/relations/index.ts"
      to: "packages/db/src/schema/api-keys.ts"
      via: "apiKeys relations definition"
      pattern: "apiKeysRelations"
---

<objective>
Create the database schema for API keys, crypto utility functions for key generation/hashing, and the admin authorization helper.

Purpose: This is the foundation layer for all API key management. The schema defines storage, the crypto utils handle key generation and hashing, and the admin helper gates privileged operations. Every subsequent plan depends on these artifacts.
Output: api_keys table in database, crypto utility module, admin check module
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-api-key-management/20-RESEARCH.md

@packages/db/src/schema/users.ts
@packages/db/src/schema/index.ts
@packages/db/src/schema/usage-events.ts
@packages/db/src/relations/index.ts
@packages/db/src/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create api-keys schema, update exports, add relations, run migration</name>
  <files>
    packages/db/src/schema/api-keys.ts
    packages/db/src/schema/index.ts
    packages/db/src/relations/index.ts
  </files>
  <action>
Create `packages/db/src/schema/api-keys.ts` with a Drizzle pgTable definition for `api_keys`:
- `id`: uuid, primaryKey, defaultRandom
- `userId`: text("user_id"), notNull, references users.id with onDelete cascade
- `keyHash`: text("key_hash"), notNull, unique (SHA-256 hex digest)
- `keyPrefix`: text("key_prefix"), notNull (first 12 chars of raw key for display: "rlk_" + 8 hex)
- `name`: text("name"), notNull, default "Default" (user-assigned label)
- `lastUsedAt`: timestamp("last_used_at") (nullable -- updated on validation)
- `createdAt`: timestamp("created_at"), notNull, defaultNow
- `revokedAt`: timestamp("revoked_at") (nullable -- null means active, set means revoked)
- `expiresAt`: timestamp("expires_at") (nullable -- null means no expiry, set for grace period rotation)

Add two indexes:
- `api_keys_key_hash_idx` on keyHash (for fast validation lookups)
- `api_keys_user_id_idx` on userId (for listing user's keys)

Export `ApiKey` and `NewApiKey` types via $inferSelect and $inferInsert.

Follow the exact pattern from `packages/db/src/schema/usage-events.ts` for import style and structure. Import `index` from `drizzle-orm/pg-core` for the index helper.

Update `packages/db/src/schema/index.ts` to add: `export * from "./api-keys";`

Update `packages/db/src/relations/index.ts`:
- Import `apiKeys` from the schema
- Add `apiKeysRelations` defining: user (many-to-one with users via userId)
- Update `usersRelations` to add: `apiKeys: many(apiKeys)`

After all files are saved, run the migration:
```bash
cd packages/db && pnpm db:generate && pnpm db:migrate
```

Important: The users table uses `text("id")` not uuid. Match that type for the userId foreign key reference.
  </action>
  <verify>
1. `cd /home/dev/projects/relay && npx tsc --noEmit -p packages/db/tsconfig.json` passes with no errors
2. Migration files exist in `packages/db/src/migrations/`
3. `pnpm db:migrate` completes without errors
  </verify>
  <done>api_keys table exists in database with all columns, indexes, and foreign key to users. Schema exports and relations are wired.</done>
</task>

<task type="auto">
  <name>Task 2: Create api-key-crypto and admin utility modules</name>
  <files>
    apps/web/lib/api-key-crypto.ts
    apps/web/lib/admin.ts
  </files>
  <action>
Create `apps/web/lib/api-key-crypto.ts`:
- Import `randomBytes`, `createHash` from `crypto`
- Export constant `KEY_PREFIX = "rlk_"`
- Export constant `KEY_BYTE_LENGTH = 32` (256 bits of entropy)
- Export function `generateRawApiKey(): string` -- generates `rlk_` + 64 hex chars using `randomBytes(32).toString("hex")`
- Export function `hashApiKey(rawKey: string): string` -- returns `createHash("sha256").update(rawKey).digest("hex")`
- Export function `extractPrefix(rawKey: string): string` -- returns `rawKey.substring(0, 12)` (captures "rlk_" + first 8 hex chars)

Do NOT use base62 encoding. Use hex. Do NOT import from any external library -- only Node.js built-in `crypto`.

Create `apps/web/lib/admin.ts`:
- Parse `process.env.ADMIN_EMAILS` as comma-separated list, trim whitespace, filter empty strings
- Export function `isAdmin(userEmail: string | null | undefined): boolean` -- returns false if no email, checks inclusion in parsed list
- Handle edge cases: undefined env var, empty string, extra whitespace around emails
  </action>
  <verify>
1. `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json` passes
2. Manually verify the crypto module uses only `crypto` imports (no external deps)
3. Verify admin.ts reads from `process.env.ADMIN_EMAILS`
  </verify>
  <done>Both utility modules export their functions. generateRawApiKey produces rlk_-prefixed 68-char keys. hashApiKey produces 64-char hex SHA-256 digests. isAdmin checks against ADMIN_EMAILS env var.</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes for both packages/db and apps/web
2. Database migration applied successfully -- api_keys table exists
3. Schema exports apiKeys, ApiKey, NewApiKey types
4. Relations connect apiKeys to users bidirectionally
5. Crypto utils use only Node.js built-in crypto module
</verification>

<success_criteria>
- api_keys table in database with id, userId, keyHash (unique), keyPrefix, name, lastUsedAt, createdAt, revokedAt, expiresAt
- Indexes on keyHash and userId
- api-key-crypto.ts exports generateRawApiKey, hashApiKey, extractPrefix
- admin.ts exports isAdmin
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/20-api-key-management/20-01-SUMMARY.md`
</output>
