---
phase: 20-api-key-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/api-key-crypto.ts
  - apps/web/lib/admin.ts
autonomous: true

must_haves:
  truths:
    - "Crypto utilities generate rlk_-prefixed keys and SHA-256 hashes"
    - "Admin check resolves against ADMIN_EMAILS env var"
  artifacts:
    - path: "apps/web/lib/api-key-crypto.ts"
      exports: ["generateRawApiKey", "hashApiKey", "extractPrefix"]
    - path: "apps/web/lib/admin.ts"
      exports: ["isAdmin"]
---

<objective>
Create crypto utility and admin helper modules. The api_keys schema, exports, and relations already exist.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@packages/db/src/schema/api-keys.ts
</context>

<tasks>

<task type="auto">
  <name>Create api-key-crypto.ts</name>
  <files>apps/web/lib/api-key-crypto.ts</files>
  <action>
Create `apps/web/lib/api-key-crypto.ts` using only Node.js built-in `crypto`:

```typescript
import { randomBytes, createHash } from "crypto";

export const KEY_PREFIX = "rlk_";
const KEY_BYTE_LENGTH = 32;

export function generateRawApiKey(): string {
  return `${KEY_PREFIX}${randomBytes(KEY_BYTE_LENGTH).toString("hex")}`;
}

export function hashApiKey(rawKey: string): string {
  return createHash("sha256").update(rawKey).digest("hex");
}

export function extractPrefix(rawKey: string): string {
  return rawKey.substring(0, 12);
}
```
  </action>
  <verify>`npx tsc --noEmit -p apps/web/tsconfig.json` passes</verify>
  <done>Crypto utils export generateRawApiKey (rlk_ + 64 hex), hashApiKey (SHA-256), extractPrefix (first 12 chars).</done>
</task>

<task type="auto">
  <name>Create admin.ts</name>
  <files>apps/web/lib/admin.ts</files>
  <action>
Create `apps/web/lib/admin.ts`:

```typescript
const ADMIN_EMAILS = (process.env.ADMIN_EMAILS || "")
  .split(",")
  .map((e) => e.trim())
  .filter(Boolean);

export function isAdmin(userEmail: string | null | undefined): boolean {
  if (!userEmail) return false;
  return ADMIN_EMAILS.includes(userEmail);
}
```
  </action>
  <verify>`npx tsc --noEmit -p apps/web/tsconfig.json` passes</verify>
  <done>Admin helper checks email against ADMIN_EMAILS env var.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p apps/web/tsconfig.json` passes
2. Both modules use no external dependencies
</verification>

<success_criteria>
- api-key-crypto.ts exports generateRawApiKey, hashApiKey, extractPrefix
- admin.ts exports isAdmin
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/20-api-key-management/20-01-SUMMARY.md`
</output>
