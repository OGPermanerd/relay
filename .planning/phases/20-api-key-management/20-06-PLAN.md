---
phase: 20-api-key-management
plan: 06
type: execute
wave: 4
depends_on: ["20-03"]
files_modified:
  - apps/web/app/(protected)/admin/keys/page.tsx
  - apps/web/components/admin-key-manager.tsx
  - apps/web/app/(protected)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Admin page at /admin/keys shows all keys across all users"
    - "Non-admin users are redirected away"
    - "Admin can generate keys for any user and revoke any key"
    - "Admin nav link only visible to admin users"
  artifacts:
    - path: "apps/web/app/(protected)/admin/keys/page.tsx"
      provides: "Admin key management page"
    - path: "apps/web/components/admin-key-manager.tsx"
      provides: "Client component for admin key management"
---

<objective>
Create the admin key management page, admin component, and add admin nav link to the header.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@apps/web/app/(protected)/layout.tsx
@apps/web/app/actions/api-keys.ts
@apps/web/lib/admin.ts
@apps/web/components/api-key-manager.tsx
</context>

<tasks>

<task type="auto">
  <name>Create admin keys page and component</name>
  <files>
    apps/web/app/(protected)/admin/keys/page.tsx
    apps/web/components/admin-key-manager.tsx
  </files>
  <action>
**Admin page** (`apps/web/app/(protected)/admin/keys/page.tsx`, server component):
- Get session, check `isAdmin(session.user.email)` -- redirect to "/" if not admin
- Query users list: `db.select({ id: users.id, name: users.name, email: users.email }).from(users)` (import users from `@relay/db`)
- Call `listAllApiKeysAction()` to get all keys
- Render `<AdminKeyManager initialKeys={keys} users={users} />`
- Page title: "API Key Management" with subtitle "Generate and manage API keys for all employees"

**AdminKeyManager** (`apps/web/components/admin-key-manager.tsx`, "use client"):
- Props: `initialKeys` (array with user info) and `users` (array of {id, name, email})
- **Features:**
  1. Key list table: User (name+email), Key Prefix (mono), Name, Status badge, Last Used, Created, Revoke button
  2. Generate-for-user form: user dropdown + key name input + Generate button. Calls `generateApiKey(formData)` with forUserId. Same show-once key display.
  3. Text filter matching user name, email, or key prefix
- Styling: Tailwind, match existing patterns
  </action>
  <verify>`npx tsc --noEmit -p apps/web/tsconfig.json` passes</verify>
  <done>Admin keys page with full management. Non-admins redirected.</done>
</task>

<task type="auto">
  <name>Add admin nav link to layout</name>
  <files>apps/web/app/(protected)/layout.tsx</files>
  <action>
Update `apps/web/app/(protected)/layout.tsx`:

1. Import `isAdmin` from `@/lib/admin`
2. Inside the `<nav>` element, after the Profile link, add:
```tsx
{isAdmin(user.email) && (
  <Link href="/admin/keys" className="text-sm font-medium text-gray-600 transition hover:text-gray-900">
    Admin
  </Link>
)}
```

After implementing, run Playwright:
```bash
cd /home/dev/projects/relay && npx playwright test tests/e2e/home.spec.ts tests/e2e/profile.spec.ts
```
  </action>
  <verify>
1. `npx playwright test tests/e2e/home.spec.ts tests/e2e/profile.spec.ts` passes
2. Admin link only shown for admin emails
  </verify>
  <done>Admin nav link in header, visible only to admins. Playwright passes.</done>
</task>

</tasks>

<verification>
1. Admin page accessible at /admin/keys for admin users
2. Non-admins redirected
3. Admin nav link conditional
4. Playwright tests pass
</verification>

<success_criteria>
- Admin can view/generate/revoke all keys (KEY-01, KEY-04)
- Non-admin redirected from /admin/keys
- Admin link in nav for admin users only
- Playwright passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-api-key-management/20-06-SUMMARY.md`
</output>
