---
phase: 20-api-key-management
plan: 06
type: execute
wave: 4
depends_on: ["20-03"]
files_modified:
  - apps/web/app/(protected)/admin/keys/page.tsx
  - apps/web/components/admin-key-manager.tsx
autonomous: true

must_haves:
  truths:
    - "Admin page at /admin/keys shows all keys across all users"
    - "Non-admin users are redirected away"
    - "Admin can generate keys for any user and revoke any key"
  artifacts:
    - path: "apps/web/app/(protected)/admin/keys/page.tsx"
      provides: "Admin key management page"
    - path: "apps/web/components/admin-key-manager.tsx"
      provides: "Client component for admin key management"
---

<objective>
Create the admin key management page and AdminKeyManager component.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<tasks>

<task type="auto">
  <name>Create admin keys page and AdminKeyManager component</name>
  <files>
    apps/web/app/(protected)/admin/keys/page.tsx
    apps/web/components/admin-key-manager.tsx
  </files>
  <action>
Create TWO files:

**1. Admin page** at `apps/web/app/(protected)/admin/keys/page.tsx` (server component):

```tsx
import { auth } from "@/auth";
import { redirect } from "next/navigation";
import { isAdmin } from "@/lib/admin";
import { listAllApiKeysAction } from "@/app/actions/api-keys";
import { db, users } from "@relay/db";
import { AdminKeyManager } from "@/components/admin-key-manager";

export default async function AdminKeysPage() {
  const session = await auth();
  if (!session?.user?.id || !isAdmin(session.user.email)) {
    redirect("/");
  }

  const keysResult = await listAllApiKeysAction();
  const keys = keysResult.keys || [];

  const userList = db
    ? await db.select({ id: users.id, name: users.name, email: users.email }).from(users)
    : [];

  return (
    <div className="mx-auto max-w-6xl px-4 py-8 sm:px-6 lg:px-8">
      <h1 className="text-2xl font-bold text-gray-900">API Key Management</h1>
      <p className="mt-1 text-sm text-gray-600">Generate and manage API keys for all employees</p>
      <div className="mt-8">
        <AdminKeyManager initialKeys={keys} users={userList} />
      </div>
    </div>
  );
}
```

**2. AdminKeyManager** at `apps/web/components/admin-key-manager.tsx` ("use client"):

Model it closely after the existing `api-key-manager.tsx` component pattern. Props:
- `initialKeys`: array with fields `id, userId, keyPrefix, name, lastUsedAt, createdAt, revokedAt, expiresAt, userName, userEmail` (dates as `string | Date | null`)
- `users`: array of `{id: string, name: string | null, email: string}`

Features:
1. **Key list table** — each row: User (name+email), Key Prefix (mono), Name, Status badge (reuse same pattern: active/revoked/expiring), Last Used, Created, Revoke button
2. **Generate-for-user form** — user dropdown (`<select>`) + key name input + Generate button. Calls `generateApiKey(formData)` with hidden `forUserId` field. Show-once key display in amber box (same pattern as api-key-manager).
3. **Text filter** — input that filters rows matching user name, email, or key prefix

Import actions from `@/app/actions/api-keys`: `generateApiKey`, `revokeApiKeyAction`, `listAllApiKeysAction`.

Styling: Tailwind, match existing codebase patterns. Use `rounded-lg bg-white p-4 shadow-sm` for cards.

After creating both files, run: `cd /home/dev/projects/relay/apps/web && node_modules/.bin/tsc --noEmit`
  </action>
  <verify>`cd /home/dev/projects/relay/apps/web && node_modules/.bin/tsc --noEmit` passes</verify>
  <done>Admin keys page and AdminKeyManager component created. TypeScript compiles.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles
2. Admin page exists at apps/web/app/(protected)/admin/keys/page.tsx
3. AdminKeyManager component created with table, filter, and generate-for-user form
</verification>

<success_criteria>
- Admin page at /admin/keys shows all keys across all users
- Non-admin users redirected
- Admin can generate keys for any user and revoke any key
- TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/20-api-key-management/20-06-SUMMARY.md`
</output>
