---
phase: 20-api-key-management
plan: 04
type: execute
wave: 3
depends_on: ["20-02"]
files_modified:
  - apps/web/app/(protected)/admin/keys/page.tsx
  - apps/web/components/admin-key-manager.tsx
  - apps/web/app/(protected)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view all API keys across all users"
    - "Admin can generate API keys for any employee"
    - "Admin can revoke any API key immediately"
    - "Non-admin users cannot access the admin keys page"
    - "Admin link appears in navigation only for admin users"
  artifacts:
    - path: "apps/web/app/(protected)/admin/keys/page.tsx"
      provides: "Admin page for managing all API keys"
      min_lines: 30
    - path: "apps/web/components/admin-key-manager.tsx"
      provides: "Client component for admin key management"
      min_lines: 60
  key_links:
    - from: "apps/web/app/(protected)/admin/keys/page.tsx"
      to: "apps/web/lib/admin.ts"
      via: "isAdmin check before rendering"
      pattern: "isAdmin"
    - from: "apps/web/components/admin-key-manager.tsx"
      to: "apps/web/app/actions/api-keys.ts"
      via: "server action calls for generate, revoke, listAll"
      pattern: "generateApiKey|revokeApiKeyAction|listAllApiKeysAction"
    - from: "apps/web/app/(protected)/layout.tsx"
      to: "apps/web/lib/admin.ts"
      via: "conditional admin nav link"
      pattern: "isAdmin"
---

<objective>
Create an admin interface for managing API keys across all employees, with the ability to generate keys for any user and revoke any key.

Purpose: This delivers KEY-01 (admin can generate keys for employees) and KEY-04 (admin can revoke any key). It also adds admin navigation to the header for admin users.
Output: Admin keys page with full key management capabilities, admin nav link in header
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-api-key-management/20-RESEARCH.md
@.planning/phases/20-api-key-management/20-02-SUMMARY.md

@apps/web/app/(protected)/layout.tsx
@apps/web/app/actions/api-keys.ts
@apps/web/lib/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin keys page and AdminKeyManager component</name>
  <files>
    apps/web/app/(protected)/admin/keys/page.tsx
    apps/web/components/admin-key-manager.tsx
  </files>
  <action>
Create `apps/web/app/(protected)/admin/keys/page.tsx` as a server component:
- Import `auth` from `@/auth`, `redirect` from `next/navigation`, `isAdmin` from `@/lib/admin`
- Get session, check `isAdmin(session.user.email)` -- if not admin, redirect to "/" with no error message
- Query all users who have at least one API key, or all users (for the "generate for user" dropdown). Use a direct Drizzle query: select users.id, users.name, users.email from users table
- Call `listAllApiKeysAction()` to get all keys with user info
- Render page title "API Key Management" with description "Generate and manage API keys for all employees"
- Render `<AdminKeyManager initialKeys={keys} users={users} />`

Create `apps/web/components/admin-key-manager.tsx` as a "use client" component:

**Props:**
- `initialKeys`: Array of keys with user info (id, keyPrefix, name, status, userId, userName, userEmail, lastUsedAt, createdAt, revokedAt, expiresAt)
- `users`: Array of { id: string; name: string | null; email: string }

**Features:**

1. **Key list table** with columns: User (name + email), Key Prefix (monospace), Key Name, Status (Active/Revoked/Expiring badges), Last Used, Created, Actions (Revoke button)
   - Sort by user name, then by createdAt DESC
   - Revoked keys shown with strikethrough and muted styling
   - "Revoke" button only on active/expiring keys

2. **Generate key for user** section:
   - Dropdown select for user (show name + email)
   - Text input for key name
   - "Generate Key" button
   - On success, show the raw key with copy button and warning (same show-once pattern as profile)
   - Calls `generateApiKey(formData)` with `forUserId` set to the selected user

3. **Filter/search:**
   - Text filter that matches user name, email, or key prefix
   - Status filter: All / Active / Revoked / Expiring

**Styling:** Same Tailwind patterns as the rest of the app. White card backgrounds, rounded-lg, shadow-sm. Use a proper HTML table for the key list (consistent with the skills table pattern).

**Admin authorization is server-side only** -- the page component checks isAdmin before rendering. The client component does not need to re-check admin status since it is only rendered within the admin page.
  </action>
  <verify>
1. `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json` passes
2. Admin page checks isAdmin and redirects non-admins
3. AdminKeyManager shows user info alongside each key
4. Generate-for-user form includes forUserId field
  </verify>
  <done>Admin keys page renders for admin users only. Lists all keys across all users. Generate-for-user form works. Revoke button on any active key.</done>
</task>

<task type="auto">
  <name>Task 2: Add admin nav link and run Playwright verification</name>
  <files>
    apps/web/app/(protected)/layout.tsx
  </files>
  <action>
Update `apps/web/app/(protected)/layout.tsx`:
1. Import `isAdmin` from `@/lib/admin`
2. In the nav section (after the existing Home and Profile links), conditionally render an "Admin" link:
   ```tsx
   {isAdmin(user.email) && (
     <Link
       href="/admin/keys"
       className="text-sm font-medium text-gray-600 transition hover:text-gray-900"
     >
       Admin
     </Link>
   )}
   ```
3. The `isAdmin` check uses the session user's email which is already available in the layout

After implementing, run Playwright tests to verify no regressions:
```bash
cd /home/dev/projects/relay && npx playwright test tests/e2e/home.spec.ts tests/e2e/profile.spec.ts
```

Then verify the build compiles:
```bash
cd /home/dev/projects/relay && npx next build --no-lint 2>&1 | tail -20
```
  </action>
  <verify>
1. `npx playwright test tests/e2e/home.spec.ts tests/e2e/profile.spec.ts` passes
2. Layout shows Admin link only when user email is in ADMIN_EMAILS
3. Build compiles successfully
4. Non-admin users do not see the Admin link
  </verify>
  <done>Admin nav link visible only to admin users. Admin keys page accessible at /admin/keys. Non-admins redirected. Playwright tests pass. Build succeeds.</done>
</task>

</tasks>

<verification>
1. Admin page at /admin/keys shows all keys across all users
2. Non-admin users are redirected away from /admin/keys
3. Admin can generate key for any user via dropdown
4. Admin can revoke any key with immediate effect
5. Admin nav link only appears for ADMIN_EMAILS users
6. Playwright tests pass for home and profile pages
7. Next.js build compiles successfully
</verification>

<success_criteria>
- Admin can generate API keys for any employee (KEY-01)
- Admin can revoke any API key immediately (KEY-04)
- Non-admin users cannot access admin features
- Admin nav link conditionally rendered in header
- All existing Playwright tests pass
- Build compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/20-api-key-management/20-04-SUMMARY.md`
</output>
