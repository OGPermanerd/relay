---
phase: 39-fork-detection
plan: 04
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - apps/web/components/drift-indicator.tsx
  - apps/web/components/skill-detail.tsx
  - apps/web/app/(protected)/skills/[slug]/page.tsx
  - apps/web/app/(protected)/skills/[slug]/compare/page.tsx
autonomous: true

must_haves:
  truths:
    - "Fork detail pages show a drift indicator when the fork has diverged from its parent"
    - "The /skills/[slug]/compare page shows side-by-side content comparison between fork and parent"
    - "Forks without forkedAtContentHash show unknown drift status"
    - "Forks whose parent was deleted show a graceful message on the compare page"
  artifacts:
    - path: "apps/web/components/drift-indicator.tsx"
      provides: "DriftIndicator badge component"
      contains: "DriftIndicator"
    - path: "apps/web/app/(protected)/skills/[slug]/compare/page.tsx"
      provides: "Side-by-side comparison page"
      contains: "ReviewDiffView"
  key_links:
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "apps/web/components/drift-indicator.tsx"
      via: "DriftIndicator component import"
      pattern: "DriftIndicator"
    - from: "apps/web/app/(protected)/skills/[slug]/compare/page.tsx"
      to: "apps/web/components/review-diff-view.tsx"
      via: "ReviewDiffView for diff rendering"
      pattern: "ReviewDiffView"
---

<objective>
Add drift indicator to fork detail pages and create a side-by-side comparison page at `/skills/[slug]/compare`.

Purpose: Users need visual feedback about fork divergence and the ability to compare content (FORK-06, FORK-07).
Output: DriftIndicator component on skill detail, compare page reusing ReviewDiffView.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/web/app/(protected)/skills/[slug]/page.tsx
@apps/web/components/skill-detail.tsx
@apps/web/components/review-diff-view.tsx
@apps/web/components/fork-attribution.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DriftIndicator component and wire into skill detail page</name>
  <files>
    apps/web/components/drift-indicator.tsx
    apps/web/components/skill-detail.tsx
    apps/web/app/(protected)/skills/[slug]/page.tsx
  </files>
  <action>
1. **Create `apps/web/components/drift-indicator.tsx`:**
   - No "use client" needed (stateless server component).
   - Import `Link` from next/link.
   - Interface:
     ```typescript
     interface DriftIndicatorProps {
       driftStatus: "diverged" | "current" | "unknown";
       compareSlug?: string; // slug for the compare page link
     }
     ```
   - Component logic:
     - If `driftStatus === "current"`, render a green badge: "In sync with parent"
     - If `driftStatus === "diverged"`, render an amber badge: "Diverged from parent" with a "Compare" link to `/skills/${compareSlug}/compare`
     - If `driftStatus === "unknown"`, render a gray badge: "Drift status unknown" (no link -- old forks without hash)
   - Use Tailwind: `inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-xs font-medium`
   - Colors: green-100/green-700 for current, amber-100/amber-700 for diverged, gray-100/gray-600 for unknown.

2. **Update `apps/web/app/(protected)/skills/[slug]/page.tsx`:**
   - Import `DriftIndicator` from `@/components/drift-indicator`.
   - Import `hashContent` from `@/lib/content-hash` (already imported).
   - In the skill fetch query, add `forkedAtContentHash: true` to the columns. Since we use `db.query.skills.findFirst` without explicit columns, the full skill object is already returned. Verify `forkedAtContentHash` is on the Skill type -- it will be after plan 01 runs the schema change.
   - After the parallel Promise.all block, compute drift status ONLY if this skill is a fork (has `forkedFromId`):
     ```typescript
     let driftStatus: "diverged" | "current" | "unknown" = "unknown";
     if (skill.forkedFromId && skill.forkedAtContentHash) {
       // Strip frontmatter helper (inline, same regex as MCP)
       const stripFm = (c: string) => {
         const m = c.match(/^---\n[\s\S]*?\n---\n/);
         return m ? c.slice(m[0].length) : c;
       };
       const currentBodyHash = await hashContent(stripFm(skill.content));
       driftStatus = currentBodyHash === skill.forkedAtContentHash ? "current" : "diverged";
     } else if (skill.forkedFromId && !skill.forkedAtContentHash) {
       driftStatus = "unknown"; // Old fork without hash anchor
     }
     ```
   - Pass `driftStatus` and `skill.slug` to `SkillDetail` as new props: `driftStatus={skill.forkedFromId ? driftStatus : undefined}` and `compareSlug={skill.slug}`.

3. **Update `apps/web/components/skill-detail.tsx`:**
   - Import `DriftIndicator` from `@/components/drift-indicator`.
   - Add to `SkillDetailProps`: `driftStatus?: "diverged" | "current" | "unknown"` and `compareSlug?: string`.
   - Render `<DriftIndicator>` right after the `<ForkAttribution>` line (around line 69), only when `driftStatus` is defined:
     ```tsx
     {parentSkill && <ForkAttribution parentSkill={parentSkill} />}
     {driftStatus && <DriftIndicator driftStatus={driftStatus} compareSlug={compareSlug} />}
     ```
  </action>
  <verify>
Run: `cd apps/web && npx tsc --noEmit 2>&1 | head -20` -- no type errors.
Run: `cd apps/web && pnpm build 2>&1 | tail -10` -- build succeeds.
  </verify>
  <done>Fork detail pages display a drift indicator badge showing "In sync", "Diverged" (with compare link), or "Unknown" status.</done>
</task>

<task type="auto">
  <name>Task 2: Create side-by-side comparison page</name>
  <files>
    apps/web/app/(protected)/skills/[slug]/compare/page.tsx
  </files>
  <action>
Create `apps/web/app/(protected)/skills/[slug]/compare/page.tsx`:

1. **Server component** (no "use client").

2. **Imports:** `notFound` from next/navigation, `db`, `skills` from @everyskill/db, `eq` from drizzle-orm, `ReviewDiffView` from @/components/review-diff-view, `Link` from next/link, `auth` from @/auth, `isAdmin` from @/lib/admin.

3. **Page function:**
   ```typescript
   interface ComparePageProps {
     params: Promise<{ slug: string }>;
   }

   export default async function ComparePage(props: ComparePageProps) {
     const params = await props.params;
   ```

4. **Fetch the fork skill:**
   ```typescript
   if (!db) return <p>Database not configured</p>;

   const [fork, session] = await Promise.all([
     db.query.skills.findFirst({
       where: eq(skills.slug, params.slug),
     }),
     auth(),
   ]);

   if (!fork) notFound();
   ```

5. **Access control:** Same as skill detail page -- non-published requires author or admin:
   ```typescript
   const isPublished = fork.status === "published";
   const isAuthor = session?.user?.id === fork.authorId;
   if (!isPublished && !isAuthor && !isAdmin(session)) notFound();
   ```

6. **Validate this is a fork:**
   ```typescript
   if (!fork.forkedFromId) {
     return (
       <div className="mx-auto max-w-4xl px-4 py-8">
         <p className="text-gray-600">This skill is not a fork. Comparison is only available for forked skills.</p>
         <Link href={`/skills/${params.slug}`} className="mt-4 inline-block text-blue-600 hover:underline">
           Back to skill
         </Link>
       </div>
     );
   }
   ```

7. **Fetch parent skill:**
   ```typescript
   const parent = await db.query.skills.findFirst({
     where: eq(skills.id, fork.forkedFromId),
     columns: { id: true, name: true, slug: true, content: true },
   });
   ```

8. **Handle deleted parent:**
   ```typescript
   if (!parent) {
     return (
       <div className="mx-auto max-w-4xl px-4 py-8">
         <h1 className="text-2xl font-bold mb-4">Compare: {fork.name}</h1>
         <div className="rounded-lg border border-gray-200 p-6 text-center">
           <p className="text-gray-500">Parent skill is no longer available. Comparison cannot be shown.</p>
         </div>
         <Link href={`/skills/${params.slug}`} className="mt-4 inline-block text-blue-600 hover:underline">
           Back to skill
         </Link>
       </div>
     );
   }
   ```

9. **Strip frontmatter from both contents** for clean comparison:
   ```typescript
   const stripFm = (c: string) => {
     const m = c.match(/^---\n[\s\S]*?\n---\n/);
     return m ? c.slice(m[0].length) : c;
   };
   const parentContent = stripFm(parent.content);
   const forkContent = stripFm(fork.content);
   ```

10. **Render page:**
    ```tsx
    return (
      <div className="mx-auto max-w-4xl px-4 py-8">
        <div className="mb-6">
          <Link href={`/skills/${params.slug}`} className="text-sm text-gray-600 hover:text-blue-600">
            &larr; Back to {fork.name}
          </Link>
          <h1 className="mt-2 text-2xl font-bold">Content Comparison</h1>
          <p className="mt-1 text-sm text-gray-500">
            Comparing <span className="font-medium">{fork.name}</span> against parent{" "}
            <Link href={`/skills/${parent.slug}`} className="font-medium text-blue-600 hover:underline">
              {parent.name}
            </Link>
          </p>
        </div>
        <ReviewDiffView
          oldContent={parentContent}
          newContent={forkContent}
          oldLabel={`Parent: ${parent.name}`}
          newLabel={`Fork: ${fork.name}`}
        />
      </div>
    );
    ```
  </action>
  <verify>
Run: `cd apps/web && npx tsc --noEmit 2>&1 | head -20` -- no type errors.
Run: `cd apps/web && pnpm build 2>&1 | tail -10` -- build succeeds, compare page route compiled.
  </verify>
  <done>
`/skills/[slug]/compare` page shows side-by-side diff between fork and parent using `ReviewDiffView`. Handles non-fork skills gracefully, handles deleted parent gracefully.
  </done>
</task>

</tasks>

<verification>
1. DriftIndicator component renders correct badge for diverged/current/unknown states
2. Skill detail page shows drift indicator for fork skills
3. Compare page at `/skills/[slug]/compare` renders diff using ReviewDiffView
4. Compare page handles non-fork skills, deleted parents, access control
5. Frontmatter stripped from both sides in diff view
6. Full build passes
</verification>

<success_criteria>
- Fork skill detail pages show visual drift indicator (FORK-06)
- `/skills/[slug]/compare` shows side-by-side content comparison (FORK-07)
- Old forks without `forkedAtContentHash` show "Drift status unknown"
- Deleted parent forks show graceful "Parent not available" message
- Build passes, no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/39-fork-detection/39-04-SUMMARY.md`
</output>
