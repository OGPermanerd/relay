---
phase: 39-fork-detection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mcp/src/tools/check-skill-status.ts
  - apps/mcp/src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "check_skill_status compares a local file's content hash against the DB published version"
    - "Hash comparison strips YAML frontmatter before hashing so tracking hook changes do not trigger false drift"
  artifacts:
    - path: "apps/mcp/src/tools/check-skill-status.ts"
      provides: "check_skill_status MCP tool"
      exports: ["handleCheckSkillStatus"]
    - path: "apps/mcp/src/tools/index.ts"
      provides: "Tool registration import"
      contains: "check-skill-status"
  key_links:
    - from: "apps/mcp/src/tools/check-skill-status.ts"
      to: "@everyskill/db"
      via: "skill query by ID"
      pattern: "skills\\.id"
    - from: "apps/mcp/src/tools/check-skill-status.ts"
      to: "local filesystem"
      via: "fs.readFileSync for local skill file"
      pattern: "fs\\.readFileSync"
---

<objective>
Create the `check_skill_status` MCP tool that reads a local skill file, strips frontmatter from both local and DB content, hashes both, and reports whether the skill has diverged.

Purpose: Users need to know if their local copy of an installed skill has been modified (FORK-01, FORK-02).
Output: New MCP tool registered and importable.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/mcp/src/tools/create.ts
@apps/mcp/src/tools/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create check_skill_status MCP tool</name>
  <files>
    apps/mcp/src/tools/check-skill-status.ts
    apps/mcp/src/tools/index.ts
  </files>
  <action>
Create `apps/mcp/src/tools/check-skill-status.ts` following the exact MCP tool pattern from create.ts:

1. **Imports:** `z` from zod, `fs` from node:fs, `path` from node:path, `os` from node:os, `server` from ../server.js, `db` from @everyskill/db, `skills` from @everyskill/db/schema/skills, `eq` from drizzle-orm, `getUserId` from ../auth.js.

2. **Self-contained helpers** (copy from create.ts -- MCP server runs standalone, no cross-app imports):
   ```typescript
   function stripFrontmatter(content: string): string {
     const match = content.match(/^---\n[\s\S]*?\n---\n/);
     return match ? content.slice(match[0].length) : content;
   }

   async function hashContent(content: string): Promise<string> {
     const data = new TextEncoder().encode(content);
     const hashBuffer = await crypto.subtle.digest("SHA-256", data);
     return Array.from(new Uint8Array(hashBuffer))
       .map((b) => b.toString(16).padStart(2, "0"))
       .join("");
   }
   ```

3. **Exported handler** `handleCheckSkillStatus`:
   - Parameters: `{ skillId: string; filePath?: string }`
   - DB null check (return error if !db)
   - Auth check: `const userId = getUserId();` -- allow unauthenticated for status check (read-only), but userId used for access control
   - Fetch skill: `const skill = await db.select({ id: skills.id, slug: skills.slug, name: skills.name, content: skills.content, status: skills.status, authorId: skills.authorId }).from(skills).where(eq(skills.id, skillId)).limit(1);`
   - If no skill found, return error: `{ error: "Skill not found", skillId }`
   - Access control: skill must be published OR user must be author. If `skill.status !== "published" && skill.authorId !== userId`, return error.
   - Determine local file path: `filePath || path.join(os.homedir(), ".claude", "skills", skill.slug + ".md")`
   - Check file exists with `fs.existsSync()`. If not, return `{ status: "not_installed", skillId, name: skill.name, expectedPath }`.
   - Read local file: `fs.readFileSync(localPath, "utf-8")`
   - **CRITICAL for FORK-02:** Strip frontmatter from BOTH local content AND DB content before hashing:
     ```typescript
     const localBody = stripFrontmatter(localContent);
     const dbBody = stripFrontmatter(skill.content);
     const localHash = await hashContent(localBody);
     const dbHash = await hashContent(dbBody);
     ```
   - Compare: `const hasDiverged = localHash !== dbHash;`
   - Return result:
     ```typescript
     {
       status: hasDiverged ? "diverged" : "current",
       skillId,
       name: skill.name,
       localHash,
       dbHash,
       filePath: localPath,
       message: hasDiverged
         ? `Local file has been modified. Use update_skill to push changes back.`
         : `Local file matches the published version.`
     }
     ```

4. **Tool registration:**
   ```typescript
   server.registerTool(
     "check_skill_status",
     {
       description: "Check if a locally installed skill has diverged from the published version. Compares content (ignoring frontmatter tracking hooks) to detect modifications.",
       inputSchema: {
         skillId: z.string().describe("Skill ID to check"),
         filePath: z.string().optional().describe("Custom file path. Defaults to ~/.claude/skills/{slug}.md"),
       },
     },
     async ({ skillId, filePath }) => handleCheckSkillStatus({ skillId, filePath })
   );
   ```

5. **Register in index.ts:** Add `import "./check-skill-status.js";` to `apps/mcp/src/tools/index.ts`.
  </action>
  <verify>
Run: `cd apps/mcp && npx tsc --noEmit 2>&1 | grep -v "node_modules" | head -20` -- no new errors from this file (pre-existing module resolution errors from @everyskill/db are acceptable per STATE.md note).
Run: `grep "check-skill-status" apps/mcp/src/tools/index.ts` -- import exists.
  </verify>
  <done>
`check_skill_status` MCP tool exists, strips frontmatter from both local and DB content before hashing, reports "current", "diverged", or "not_installed" status.
  </done>
</task>

</tasks>

<verification>
1. Tool file exists at `apps/mcp/src/tools/check-skill-status.ts`
2. Tool imported in `apps/mcp/src/tools/index.ts`
3. Frontmatter stripping applied to BOTH local file and DB content before hash comparison
4. Returns "not_installed" when file doesn't exist, "current" when hashes match, "diverged" when they differ
5. TypeScript compiles (no new errors)
</verification>

<success_criteria>
- `check_skill_status` tool registered with MCP server
- Frontmatter-stripping hash comparison prevents false drift from tracking hooks (FORK-02)
- File-not-found returns actionable "not_installed" status with expected path
- Published-or-author access control enforced
</success_criteria>

<output>
After completion, create `.planning/phases/39-fork-detection/39-02-SUMMARY.md`
</output>
