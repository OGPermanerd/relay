---
phase: 52-diagnostic-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["52-01"]
files_modified:
  - apps/web/app/(protected)/my-leverage/email-diagnostic/page.tsx
  - apps/web/app/(protected)/my-leverage/email-diagnostic/diagnostic-dashboard.tsx
  - apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard page accessible at /my-leverage/email-diagnostic"
    - "User sees total email hours per week as hero KPI"
    - "User sees category pie chart and time bar chart"
    - "User can click Re-run Diagnostic to trigger fresh analysis"
    - "Dashboard shows date of last scan"
  artifacts:
    - path: "apps/web/app/(protected)/my-leverage/email-diagnostic/page.tsx"
      provides: "Server component route for dashboard"
      min_lines: 40
    - path: "apps/web/app/(protected)/my-leverage/email-diagnostic/diagnostic-dashboard.tsx"
      provides: "Client dashboard with charts and re-run button"
      min_lines: 80
    - path: "apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx"
      provides: "Updated with View Full Dashboard link"
      contains: "View Full Dashboard"
  key_links:
    - from: "page.tsx"
      to: "getLatestDiagnostic"
      via: "server component fetch"
      pattern: "await getLatestDiagnostic"
    - from: "diagnostic-dashboard.tsx"
      to: "CategoryPieChart + TimeBarChart"
      via: "component imports"
      pattern: "@/components/category-pie-chart"
    - from: "diagnostic-dashboard.tsx"
      to: "runEmailDiagnostic server action"
      via: "re-run button onClick"
      pattern: "await runEmailDiagnostic"
---

<objective>
Create the diagnostic dashboard page with visual charts and re-run capability.

Purpose: Display email diagnostic results using the chart components from plan 52-01, with hero KPI, pattern insights, and re-run functionality
Output: Full dashboard page at /my-leverage/email-diagnostic with integrated charts and updated email-diagnostic-card link
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/app/(protected)/my-leverage/page.tsx
@apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx
@packages/db/src/services/email-diagnostics.ts
@apps/web/app/actions/email-diagnostic.ts
</context>

<tasks>

<task type="auto">
  <name>Create dashboard page route</name>
  <files>apps/web/app/(protected)/my-leverage/email-diagnostic/page.tsx</files>
  <action>
Create a server component page at `/my-leverage/email-diagnostic` that fetches and displays diagnostic data.

**Structure:**
- Async server component
- Check auth: `const session = await auth(); if (!session?.user?.id) redirect("/login");`
- Fetch latest diagnostic: `const diagnostic = await getLatestDiagnostic(session.user.id);`
- Import from: `@/auth`, `next/navigation`, `@everyskill/db/services/email-diagnostics`, `./diagnostic-dashboard`

**Layout:**
- Back link to /my-leverage (text-blue-600, hover:underline)
- Page header: "Email Time Diagnostic" (text-3xl font-bold)
- Description: "Visual breakdown of where your email time goes" (text-gray-600)

**Conditional rendering:**
- If `diagnostic` exists: render `<DiagnosticDashboard diagnostic={diagnostic} userId={session.user.id} />`
- If `diagnostic` is null: show empty state with message "No diagnostic data yet. Go to My Leverage to run your first scan." with link to /my-leverage

**Metadata:** export metadata with title "Email Time Diagnostic | EverySkill"

**Pattern reference:** Follow apps/web/app/(protected)/my-leverage/page.tsx structure (auth, data fetching, layout)
  </action>
  <verify>
Check file exists and is server component (no "use client"):
```bash
test -f apps/web/app/(protected)/my-leverage/email-diagnostic/page.tsx && echo "EXISTS"
```

Verify auth check and data fetch:
```bash
grep "await auth()" apps/web/app/(protected)/my-leverage/email-diagnostic/page.tsx
grep "getLatestDiagnostic" apps/web/app/(protected)/my-leverage/email-diagnostic/page.tsx
```
  </verify>
  <done>page.tsx exists as server component with auth check, diagnostic fetch, conditional rendering (dashboard or empty state), and metadata</done>
</task>

<task type="auto">
  <name>Create dashboard client component with charts and re-run</name>
  <files>apps/web/app/(protected)/my-leverage/email-diagnostic/diagnostic-dashboard.tsx</files>
  <action>
Create a client component that renders the full diagnostic dashboard with hero KPI, charts, insights, and re-run button.

**Structure:**
- "use client" directive
- Import chart components: `@/components/category-pie-chart`, `@/components/time-bar-chart`
- Import types: `EmailDiagnostic` from `@everyskill/db/schema/email-diagnostics`
- Import action: `runEmailDiagnostic` from `@/app/actions/email-diagnostic`
- Accept props: `{ diagnostic: EmailDiagnostic; userId: string }`
- useState for loading state

**Hero KPI section:**
```tsx
<div className="rounded-lg bg-gradient-to-br from-blue-50 to-purple-50 p-6">
  <p className="text-sm font-medium text-gray-700">Total Email Time</p>
  <p className="mt-2 text-4xl font-bold text-gray-900">{hoursPerWeek} hours</p>
  <p className="text-sm text-gray-600">per week</p>
</div>
```

**CRITICAL: Convert estimatedHoursPerWeek from tenths:**
```typescript
const hoursPerWeek = (diagnostic.estimatedHoursPerWeek / 10).toFixed(1);
```
Database stores as integer tenths (125 = 12.5 hours). Must divide by 10 before display.

**Date formatting (avoid hydration issues):**
Do NOT use toLocaleDateString(). Format manually:
```typescript
const d = new Date(diagnostic.scanDate);
const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const scanDateFormatted = `${MONTHS[d.getUTCMonth()]} ${d.getUTCDate()}, ${d.getUTCFullYear()}`;
```

**Layout sections (space-y-6):**
1. Hero KPI (gradient card)
2. Category Pie Chart (white card with border, h2 title "Email Category Distribution")
3. Time Bar Chart (white card with border, h2 title "Time Per Category")
4. Pattern Insights (white card with border, h2 title "Email Patterns"):
   - Busiest time: `{busiestDayOfWeek}s at {busiestHour}:00`
   - Last scanned: `{scanDateFormatted}`
   - Messages analyzed: `{totalMessages} messages analyzed over {scanPeriodDays} days`
5. Re-run button (full width, blue bg-blue-600, onClick triggers runEmailDiagnostic then window.location.reload())

**Re-run handler:**
```typescript
async function handleRerun() {
  setLoading(true);
  await runEmailDiagnostic();
  window.location.reload(); // Refresh to show new data
}
```

**Button state:**
- Loading: "Running Diagnostic..." with disabled state
- Default: "Re-run Diagnostic"

**Pattern reference:** Follow email-diagnostic-card.tsx patterns for loading state, error handling, and card styling
  </action>
  <verify>
Check file exists and is client component:
```bash
head -1 apps/web/app/(protected)/my-leverage/email-diagnostic/diagnostic-dashboard.tsx
```

Verify estimatedHoursPerWeek conversion (critical for correct display):
```bash
grep "estimatedHoursPerWeek / 10" apps/web/app/(protected)/my-leverage/email-diagnostic/diagnostic-dashboard.tsx
```

Verify chart imports:
```bash
grep "category-pie-chart" apps/web/app/(protected)/my-leverage/email-diagnostic/diagnostic-dashboard.tsx
grep "time-bar-chart" apps/web/app/(protected)/my-leverage/email-diagnostic/diagnostic-dashboard.tsx
```
  </verify>
  <done>diagnostic-dashboard.tsx exists with hero KPI (correctly dividing tenths), CategoryPieChart, TimeBarChart, pattern insights, and re-run button with loading state</done>
</task>

<task type="auto">
  <name>Add View Full Dashboard link to email-diagnostic-card</name>
  <files>apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx</files>
  <action>
Update email-diagnostic-card.tsx to add a "View Full Dashboard" link when diagnostic results exist.

**Change location:** In the results state (when `results` is truthy), after the "Run New Diagnostic" button.

**Add link:**
```tsx
<Link
  href="/my-leverage/email-diagnostic"
  className="mt-2 block w-full rounded-md border border-blue-600 bg-white px-4 py-2 text-center text-sm font-medium text-blue-600 shadow-sm hover:bg-blue-50"
>
  View Full Dashboard →
</Link>
```

**Import:** Add `import Link from "next/link";` at top of file if not already present.

**Styling:** Secondary button style (border, no bg-color, blue text) to differentiate from primary "Run New Diagnostic" button above it.

**CRITICAL fix:** The existing card shows `results.estimatedHoursPerWeek` directly. This is WRONG — it displays raw tenths (e.g., "125 hours" instead of "12.5 hours").

**Fix the hero stat display:**
Change line 96 from:
```tsx
{results.estimatedHoursPerWeek} hours
```
To:
```tsx
{(results.estimatedHoursPerWeek / 10).toFixed(1)} hours
```

This fixes the display bug where tenths are shown as whole numbers.
  </action>
  <verify>
Check Link import exists:
```bash
grep "from \"next/link\"" apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx
```

Verify View Full Dashboard link exists:
```bash
grep "View Full Dashboard" apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx
```

Verify estimatedHoursPerWeek conversion fix:
```bash
grep "estimatedHoursPerWeek / 10" apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx
```
  </verify>
  <done>email-diagnostic-card.tsx updated with View Full Dashboard link and estimatedHoursPerWeek display bug fixed (dividing by 10)</done>
</task>

</tasks>

<verification>
Full verification flow:
1. Navigate to /my-leverage — email-diagnostic-card shows results with corrected hours display
2. Click "View Full Dashboard" → navigates to /my-leverage/email-diagnostic
3. Dashboard shows hero KPI with correct hours (divided by 10)
4. Dashboard shows category pie chart with colored slices
5. Dashboard shows time bar chart with horizontal bars sorted by hours
6. Dashboard shows pattern insights and last scan date
7. Click "Re-run Diagnostic" → triggers fresh analysis and reloads page
</verification>

<success_criteria>
- Dashboard page accessible at /my-leverage/email-diagnostic
- Hero KPI displays estimatedHoursPerWeek correctly (divided by 10)
- CategoryPieChart and TimeBarChart render diagnostic data
- Pattern insights show busiest time and scan date (no hydration issues)
- Re-run button triggers runEmailDiagnostic and reloads
- Email-diagnostic-card has View Full Dashboard link
- Email-diagnostic-card hero stat displays hours correctly (bug fixed)
- Requirements DASH-01, DASH-02, DASH-03, DASH-04 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/52-diagnostic-dashboard/52-02-SUMMARY.md`
</output>
