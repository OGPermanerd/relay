---
phase: 65-individual-skills-portfolio
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/portfolio-queries.ts
  - apps/web/app/(protected)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Portfolio query functions return skills authored, total uses, total hours saved for a user"
    - "Portfolio query returns portable vs company IP breakdown grouped by visibility"
    - "Contribution ranking query returns rank, percentile, and total contributors within tenant"
    - "Portfolio nav link appears in header between Leverage and Profile"
  artifacts:
    - path: "apps/web/lib/portfolio-queries.ts"
      provides: "SQL query functions for portfolio stats, skill list, and contribution ranking"
      exports: ["getPortfolioStats", "getPortfolioSkills", "getContributionRanking"]
    - path: "apps/web/app/(protected)/layout.tsx"
      provides: "Portfolio NavLink in header nav"
      contains: "Portfolio"
  key_links:
    - from: "apps/web/lib/portfolio-queries.ts"
      to: "@everyskill/db"
      via: "db.execute(sql`...`) and drizzle query builder"
      pattern: "db\\.execute|from\\(skills\\)"
    - from: "apps/web/app/(protected)/layout.tsx"
      to: "/portfolio"
      via: "NavLink href"
      pattern: 'href="/portfolio"'
---

<objective>
Create the data layer for the Individual Skills Portfolio: three query functions (portfolio stats, skill list with visibility, contribution ranking) and add the "Portfolio" NavLink to the header nav.

Purpose: Provides all data needed for the portfolio page (Plan 02) and makes the route discoverable in navigation.
Output: `portfolio-queries.ts` with 3 exported functions + updated header layout with Portfolio link.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/lib/user-stats.ts
@apps/web/lib/leaderboard.ts
@apps/web/lib/my-leverage.ts
@apps/web/app/(protected)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create portfolio-queries.ts with three query functions</name>
  <files>apps/web/lib/portfolio-queries.ts</files>
  <action>
Create `apps/web/lib/portfolio-queries.ts` with three functions:

**1. `getPortfolioStats(userId: string): Promise<PortfolioStats>`**
Returns aggregate stats for user's published skills. Adapt from `getUserStats()` in `user-stats.ts` but add visibility breakdown.

Interface PortfolioStats:
```typescript
interface PortfolioStats {
  skillsAuthored: number;       // COUNT published skills
  totalUses: number;            // SUM total_uses
  totalHoursSaved: number;      // SUM(total_uses * COALESCE(hours_saved, 1))
  avgRating: string | null;     // AVG(average_rating) / 100, formatted "4.5"
  portableSkills: number;       // COUNT WHERE visibility = 'personal'
  portableHoursSaved: number;   // SUM hours saved WHERE visibility = 'personal'
  companySkills: number;        // COUNT WHERE visibility = 'tenant'
  companyHoursSaved: number;    // SUM hours saved WHERE visibility = 'tenant'
}
```

Use a single SQL query with conditional aggregation (CASE WHEN or FILTER WHERE) to get both overall and per-visibility stats in one pass. Filter to `published_version_id IS NOT NULL AND status = 'published'`. Use COALESCE for null safety. Pattern from `user-stats.ts`.

**2. `getPortfolioSkills(userId: string): Promise<PortfolioSkill[]>`**
Returns list of user's published skills with visibility scope for badge rendering.

Interface PortfolioSkill:
```typescript
interface PortfolioSkill {
  id: string;
  name: string;
  slug: string;
  category: string;
  totalUses: number;
  hoursSaved: number;           // per-use hours saved
  totalHoursSaved: number;      // totalUses * hoursSaved
  avgRating: string | null;     // formatted "4.5"
  visibility: string;           // "personal" or "tenant"
  createdAt: string;            // ISO string
}
```

Query with `db.execute(sql`...)` — select skills WHERE author_id = userId AND published. Order by totalHoursSaved DESC (highest impact first). Serialize createdAt to ISO string to avoid hydration issues.

**3. `getContributionRanking(userId: string, tenantId: string): Promise<ContributionRanking>`**
Returns user's contribution ranking within their tenant.

Interface ContributionRanking:
```typescript
interface ContributionRanking {
  rank: number;                 // absolute rank (1-based)
  totalContributors: number;    // total people with published skills in tenant
  percentile: number;           // 0-100 float from PERCENT_RANK()
  label: string;                // "Top 15%" for teams >20, "3rd of 12" for teams <=20
}
```

Use CTE pattern from `leaderboard.ts`:
- CTE `contributor_stats`: Aggregate per-user FTE days saved for all users in the tenant, using ONLY `visibility = 'tenant'` skills (matching leaderboard behavior — personal skills are private, shouldn't factor into ranking against others).
- CTE `ranked`: Apply RANK() and PERCENT_RANK() over contributor_stats ordered by fte_days_saved DESC, skills_shared DESC.
- Final SELECT: Return only the current user's row.

For the label:
- If totalContributors > 20: Use percentile — "Top 5%", "Top 10%", "Top 15%", "Top 25%", "Top 50%", "Bottom Half"
- If totalContributors <= 20: Use absolute rank — "1st of 12", "2nd of 12", "3rd of 12", "4th of 12" etc.
- Handle edge case where user has no published skills: return rank 0, label "No published skills yet"

Guard against null db: return safe defaults (zeros, empty string label).

Export all interfaces and functions.
  </action>
  <verify>
Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30` to verify no type errors in portfolio-queries.ts.
  </verify>
  <done>
Three functions exported: getPortfolioStats, getPortfolioSkills, getContributionRanking. All use existing DB patterns with proper null safety and tenant scoping. Interfaces exported for use by portfolio-view component.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Portfolio NavLink to header navigation</name>
  <files>apps/web/app/(protected)/layout.tsx</files>
  <action>
In `apps/web/app/(protected)/layout.tsx`, add a "Portfolio" NavLink between the "Leverage" and "Profile" links in the header nav.

Find the nav section (lines ~59-77) and add:
```tsx
<NavLink href="/portfolio" theme={HEADER_THEME}>
  Portfolio
</NavLink>
```

Place it AFTER the Leverage NavLink and BEFORE the Profile NavLink. This is visible to all authenticated users (not admin-gated).

Do NOT modify any other part of the layout. The change is exactly one NavLink addition.
  </action>
  <verify>
Run `cd /home/dev/projects/relay && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | grep layout` to check for errors. Also visually confirm the NavLink is in the correct position by reading the file.
  </verify>
  <done>
"Portfolio" NavLink appears in header nav between "Leverage" and "Profile" for all authenticated users.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit --project apps/web/tsconfig.json` passes without errors in portfolio-queries.ts or layout.tsx
2. portfolio-queries.ts exports 3 functions and 3 interfaces
3. layout.tsx has Portfolio NavLink between Leverage and Profile
</verification>

<success_criteria>
- portfolio-queries.ts exists with getPortfolioStats, getPortfolioSkills, getContributionRanking
- All three functions handle null db and empty results gracefully
- getContributionRanking uses tenant-scoped ranking (visibility = 'tenant' only)
- getPortfolioStats includes both overall and per-visibility breakdown
- Portfolio NavLink appears in header between Leverage and Profile
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/65-individual-skills-portfolio/65-01-SUMMARY.md`
</output>
