---
phase: 51-email-analysis-pipeline
plan: 05
type: execute
wave: 3
depends_on: [51-04]
files_modified:
  - apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx
  - apps/web/app/(protected)/my-leverage/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees diagnostic card in /my-leverage with 'Run Diagnostic' button"
    - "Button shows loading state during 60-90 second scan"
    - "Success shows estimated hours per week and category breakdown preview"
    - "Error states handled (not connected, revoked, generic failure)"
  artifacts:
    - path: "apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx"
      provides: "EmailDiagnosticCard component with run button and results"
      exports: ["EmailDiagnosticCard"]
    - path: "apps/web/app/(protected)/my-leverage/page.tsx"
      provides: "Renders EmailDiagnosticCard on /my-leverage page"
      contains: "EmailDiagnosticCard"
  key_links:
    - from: "apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx"
      to: "apps/web/app/actions/email-diagnostic.ts"
      via: "import runEmailDiagnostic"
      pattern: "runEmailDiagnostic"
---

<objective>
Create UI for triggering email diagnostic scan with loading state and results preview.

Purpose: User-facing trigger for analyze-and-discard pipeline. Shows progress during 60-90 second scan, displays estimated hours per week and category breakdown after completion.
Output: EmailDiagnosticCard component on /my-leverage page.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/app/actions/email-diagnostic.ts
@apps/web/app/(protected)/my-leverage/page.tsx
@apps/web/components/gmail-connection-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email diagnostic card component</name>
  <files>
apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx
  </files>
  <action>
Create `apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx`:

"use client" directive at top.

Import:
- useState from "react"
- runEmailDiagnostic from "@/app/actions/email-diagnostic"
- Card, CardHeader, CardTitle, CardDescription, CardContent from "@/components/ui/card"
- Button from "@/components/ui/button"

Component EmailDiagnosticCard():

State:
- loading: boolean (default false)
- results: AggregateResults | null (default null)
- error: string | null (default null)

Handler async function handleRunDiagnostic():
1. Set loading = true, error = null
2. Call runEmailDiagnostic()
3. If success: set results = response.data
4. If error: set error = response.error
5. Finally: set loading = false

Render:
- Card wrapper
- CardHeader with:
  - CardTitle: "Email Time Diagnostic"
  - CardDescription: "Analyze where your email time goes"
- CardContent:
  - If loading:
    - "Analyzing your last 90 days of emails... This takes about 60-90 seconds."
    - Progress spinner or loading animation
  - Else if error:
    - Error message in red text
    - If error includes "not connected": show link to /my-leverage (Gmail connection card)
  - Else if results:
    - Hero stat: "You spend approximately {results.estimatedHoursPerWeek} hours per week on email"
    - Category breakdown preview (top 3 categories by count):
      - Category name, count, percentage
    - Button: "View Full Report" (link to /my-leverage/diagnostic when Phase 52 ships)
  - Else (initial state):
    - "Run a diagnostic scan to see how much time you spend on email and what types of messages you receive most."
    - Button: "Run Diagnostic" (onClick handleRunDiagnostic)

Use Tailwind classes following existing card patterns from gmail-connection-card.tsx.

Export default EmailDiagnosticCard.
  </action>
  <verify>
grep '"use client"' apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx
grep "runEmailDiagnostic" apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx
grep "EmailDiagnosticCard" apps/web/app/(protected)/my-leverage/email-diagnostic-card.tsx
  </verify>
  <done>
EmailDiagnosticCard component created with run button, loading state, results preview, and error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add diagnostic card to my-leverage page</name>
  <files>
apps/web/app/(protected)/my-leverage/page.tsx
  </files>
  <action>
Update `apps/web/app/(protected)/my-leverage/page.tsx`:

1. Import EmailDiagnosticCard from "./email-diagnostic-card"
2. Add EmailDiagnosticCard component to page layout (after existing cards, before footer)
3. Wrap in same grid/flex pattern as other cards on the page

Follow existing layout patterns from the page. Place diagnostic card logically (after Gmail connection card if present, or at bottom of card list).
  </action>
  <verify>
grep "EmailDiagnosticCard" apps/web/app/(protected)/my-leverage/page.tsx
  </verify>
  <done>
EmailDiagnosticCard rendered on /my-leverage page.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Email diagnostic card UI on /my-leverage page with "Run Diagnostic" button, loading state, and results preview.

Automated work:
- Created EmailDiagnosticCard component with:
  - "Run Diagnostic" button (initial state)
  - Loading state: "Analyzing your last 90 days of emails... This takes about 60-90 seconds." with spinner
  - Results preview: estimated hours per week + top 3 categories
  - Error handling: not connected, revoked, generic errors
- Added card to /my-leverage page layout
  </what-built>
  <how-to-verify>
1. Ensure dev server is running: `cd /home/dev/projects/relay/apps/web && pnpm dev`
2. Open browser to http://localhost:2002/my-leverage
3. Verify EmailDiagnosticCard appears on page
4. Test initial state:
   - Card shows "Email Time Diagnostic" title
   - Description: "Analyze where your email time goes"
   - Button: "Run Diagnostic" visible and enabled
5. Test NOT CONNECTED error (if Gmail not connected):
   - Click "Run Diagnostic"
   - Should show error: "Gmail account not connected. Please connect your Gmail account first."
6. Test CONNECTED scan (if Gmail connected):
   - Click "Run Diagnostic"
   - Should show loading state: "Analyzing your last 90 days of emails... This takes about 60-90 seconds."
   - After 60-90 seconds, should show results:
     - "You spend approximately X.X hours per week on email"
     - Top 3 categories with counts and percentages
7. Test visual consistency:
   - Card styling matches other cards on /my-leverage page
   - Loading spinner is visible and animated
   - Results are readable and well-formatted

Expected behavior:
- Initial state: button enabled, no loading, no results
- Loading state: button disabled, spinner visible, message clear
- Results state: hours per week displayed, categories listed
- Error state: error message visible, actionable if "not connected"
  </how-to-verify>
  <resume-signal>
Type "approved" if diagnostic card works correctly, or describe any issues with the UI, loading state, or results display.
  </resume-signal>
</task>

</tasks>

<verification>
1. EmailDiagnosticCard component exists with run button and state management
2. Loading state shows progress message during 60-90 second scan
3. Results state displays estimated hours per week and category breakdown
4. Error handling for not connected, revoked, and generic failures
5. Card rendered on /my-leverage page
</verification>

<success_criteria>
- User sees "Run Diagnostic" button on /my-leverage page
- Button triggers runEmailDiagnostic server action
- Loading state shows "Analyzing... This takes about 60-90 seconds" with spinner
- Success shows estimated hours per week and top 3 categories
- Error states handled (not connected, revoked, generic)
- Visual consistency with other cards on page
</success_criteria>

<output>
After completion, create `.planning/phases/51-email-analysis-pipeline/51-05-SUMMARY.md`
</output>
