---
phase: 51-email-analysis-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/email-diagnostics.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/services/email-diagnostics.ts
  - packages/db/src/services/index.ts
  - packages/db/src/relations/index.ts
  - packages/db/src/migrations/0029_add_email_diagnostics.sql
autonomous: true

must_haves:
  truths:
    - "email_diagnostics table exists with JSONB columns for aggregate data only"
    - "No individual email metadata columns (no From, Subject, or Date columns)"
    - "Service layer provides upsert and query functions for diagnostics"
    - "Schema exports types for category breakdown and pattern insights"
  artifacts:
    - path: "packages/db/src/schema/email-diagnostics.ts"
      provides: "emailDiagnostics table with RLS policy"
      contains: "pgTable"
    - path: "packages/db/src/services/email-diagnostics.ts"
      provides: "saveEmailDiagnostic, getLatestDiagnostic, getDiagnosticHistory"
      exports: ["saveEmailDiagnostic", "getLatestDiagnostic", "getDiagnosticHistory"]
    - path: "packages/db/src/migrations/0029_add_email_diagnostics.sql"
      provides: "CREATE TABLE email_diagnostics with RLS"
      contains: "CREATE TABLE"
  key_links:
    - from: "packages/db/src/services/email-diagnostics.ts"
      to: "packages/db/src/schema/email-diagnostics.ts"
      via: "import emailDiagnostics table"
      pattern: "import.*emailDiagnostics"
---

<objective>
Create the email_diagnostics schema and service layer for storing aggregate-only email analysis results.

Purpose: Foundation for privacy-first email analysis -- table stores ONLY computed statistics (category counts, time estimates, behavioral patterns), never individual email metadata (From, Subject, Date).
Output: emailDiagnostics table schema, CRUD service, migration SQL, exported types.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/schema/gmail-tokens.ts
@packages/db/src/services/gmail-tokens.ts
@packages/db/src/schema/index.ts
@packages/db/src/services/index.ts
@packages/db/src/relations/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email_diagnostics schema and migration</name>
  <files>
packages/db/src/schema/email-diagnostics.ts
packages/db/src/schema/index.ts
packages/db/src/relations/index.ts
packages/db/src/migrations/0029_add_email_diagnostics.sql
  </files>
  <action>
Create `packages/db/src/schema/email-diagnostics.ts`:
- pgTable "email_diagnostics" with columns:
  - id (text, primary key, UUID default)
  - tenant_id (text, NOT NULL, FK to tenants)
  - user_id (text, NOT NULL, FK to users with onDelete: cascade)
  - scan_date (timestamptz, NOT NULL, defaultNow)
  - scan_period_days (integer, NOT NULL) -- e.g., 90
  - total_messages (integer, NOT NULL)
  - estimated_hours_per_week (integer, NOT NULL) -- stored as tenths (e.g., 125 = 12.5 hours)
  - category_breakdown (jsonb, NOT NULL) -- typed as array of {category: string, count: number, percentage: number, estimatedMinutes: number}
  - pattern_insights (jsonb, nullable) -- typed as {busiestHour: number, busiestDayOfWeek: string, averageResponseTimeHours: number | null, threadDepthAverage: number}
  - created_at (timestamptz, NOT NULL, defaultNow)
- Indexes on: user_id, tenant_id, scan_date
- RLS policy "tenant_isolation" (restrictive, for all, using/withCheck tenant_id = current_setting('app.current_tenant_id', true))
- Export EmailDiagnostic and NewEmailDiagnostic types

Add table comment in SQL: "Aggregate email analysis results. Does NOT store individual email metadata -- only computed statistics per scan."

Update `packages/db/src/schema/index.ts` to export emailDiagnostics.

Update `packages/db/src/relations/index.ts` to add relations:
- emailDiagnostics.relations with user (one user.id -> userId) and tenant (one tenants.id -> tenantId)
- users.relations add emailDiagnostics (many)
- tenants.relations add emailDiagnostics (many)

Create migration `packages/db/src/migrations/0029_add_email_diagnostics.sql`:
- CREATE TABLE email_diagnostics (exactly matching schema)
- CREATE INDEX statements (user_id, tenant_id, scan_date)
- ALTER TABLE email_diagnostics ENABLE ROW LEVEL SECURITY
- CREATE POLICY tenant_isolation (AS RESTRICTIVE FOR ALL ...)
- COMMENT ON TABLE and key columns explaining aggregate-only storage
  </action>
  <verify>
cd packages/db && pnpm db:generate -- verify schema matches SQL
grep "emailDiagnostics" packages/db/src/schema/index.ts
grep "emailDiagnostics" packages/db/src/relations/index.ts
  </verify>
  <done>
Schema file exists with all columns, migration SQL creates table with RLS, schema exports in index.ts, relations updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create email diagnostics service layer</name>
  <files>
packages/db/src/services/email-diagnostics.ts
packages/db/src/services/index.ts
  </files>
  <action>
Create `packages/db/src/services/email-diagnostics.ts`:

Types:
- SaveEmailDiagnosticParams with userId, tenantId, scanDate, scanPeriodDays, totalMessages, categoryBreakdown, estimatedHoursPerWeek, patternInsights
- CategoryBreakdownItem with category, count, percentage, estimatedMinutes
- PatternInsights with busiestHour, busiestDayOfWeek, averageResponseTimeHours, threadDepthAverage

Functions:
1. `saveEmailDiagnostic(params: SaveEmailDiagnosticParams): Promise<EmailDiagnostic>` -- inserts a new diagnostic row, returns created record
2. `getLatestDiagnostic(userId: string): Promise<EmailDiagnostic | null>` -- returns most recent diagnostic for user ordered by scan_date DESC
3. `getDiagnosticHistory(userId: string, limit = 10): Promise<EmailDiagnostic[]>` -- returns last N diagnostics ordered by scan_date DESC

Use db.insert/query patterns from gmail-tokens.ts. All queries filter by userId. RLS enforces tenant isolation automatically.

Update `packages/db/src/services/index.ts` to export all three functions.
  </action>
  <verify>
grep -E "export.*saveEmailDiagnostic|getLatestDiagnostic|getDiagnosticHistory" packages/db/src/services/email-diagnostics.ts
grep "email-diagnostics" packages/db/src/services/index.ts
  </verify>
  <done>
Service file exports three functions (save, getLatest, getHistory), types defined, exported from services/index.ts.
  </done>
</task>

</tasks>

<verification>
1. Schema file has emailDiagnostics table with JSONB columns (not individual email fields)
2. Migration SQL creates table with RLS and indexes
3. Service layer provides insert and query functions
4. Schema and service exported from index files
5. Relations updated for users and tenants
</verification>

<success_criteria>
- email_diagnostics table schema exists with aggregate-only columns (no From/Subject/Date)
- Migration SQL ready to create table with RLS policy
- Service layer provides saveEmailDiagnostic, getLatestDiagnostic, getDiagnosticHistory
- Types exported for use in app layer
- All files follow existing patterns from gmail-tokens phase
</success_criteria>

<output>
After completion, create `.planning/phases/51-email-analysis-pipeline/51-01-SUMMARY.md`
</output>
