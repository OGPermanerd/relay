---
phase: 59-suggestion-to-fork-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["59-01"]
files_modified:
  - apps/web/components/suggestion-card.tsx
  - apps/web/app/actions/submit-for-review.ts
  - apps/web/app/actions/admin-reviews.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Author sees Accept & Fork button on pending and accepted suggestions"
    - "Author sees Apply Inline button when suggestion has suggestedContent"
    - "Accept & Fork navigates to new fork page with improve mode"
    - "Apply Inline refreshes page showing updated content"
    - "Implemented suggestions show link to the resulting fork or skill"
    - "Suggestion status auto-transitions to implemented when linked fork is published"
  artifacts:
    - path: "apps/web/components/suggestion-card.tsx"
      provides: "Accept & Fork and Apply Inline buttons, implemented-by link"
      contains: "acceptAndForkSuggestion"
    - path: "apps/web/app/actions/submit-for-review.ts"
      provides: "Auto-implement hook after auto-approve publish"
      contains: "autoImplementLinkedSuggestions"
    - path: "apps/web/app/actions/admin-reviews.ts"
      provides: "Auto-implement hook after admin approve publish"
      contains: "autoImplementLinkedSuggestions"
  key_links:
    - from: "apps/web/components/suggestion-card.tsx"
      to: "apps/web/app/actions/skill-feedback.ts"
      via: "import acceptAndForkSuggestion, applyInlineSuggestion"
      pattern: "acceptAndForkSuggestion|applyInlineSuggestion"
    - from: "apps/web/app/actions/submit-for-review.ts"
      to: "packages/db/src/services/skill-feedback.ts"
      via: "import autoImplementLinkedSuggestions"
      pattern: "autoImplementLinkedSuggestions"
    - from: "apps/web/app/actions/admin-reviews.ts"
      to: "packages/db/src/services/skill-feedback.ts"
      via: "import autoImplementLinkedSuggestions"
      pattern: "autoImplementLinkedSuggestions"
---

<objective>
Wire the suggestion-to-fork UI buttons into the suggestion card component and add auto-implemented hooks to both publish paths (submitForReview auto-approve and admin approveSkillAction).

Purpose: Complete the user-facing pipeline -- author can Accept & Fork or Apply Inline directly from suggestion cards, and published forks automatically mark their linked suggestions as "implemented."
Output: Updated suggestion-card.tsx with new action buttons and traceability link, updated publish flows with auto-implement hooks.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/59-suggestion-to-fork-pipeline/59-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Suggestion card UI -- Accept & Fork, Apply Inline, and traceability link</name>
  <files>
    apps/web/components/suggestion-card.tsx
  </files>
  <action>
Update `apps/web/components/suggestion-card.tsx`:

1. **Add imports** at top:
   ```ts
   import { acceptAndForkSuggestion, applyInlineSuggestion } from "@/app/actions/skill-feedback";
   import Link from "next/link";
   ```

2. **Extend SuggestionCardData interface** to include:
   ```ts
   implementedBySkillId: string | null;
   implementedBySkillSlug: string | null;
   implementedBySkillName: string | null;
   ```

3. **Add handler functions** inside the component (follow the existing `handleStatusUpdate` async pattern with `setPending`/`setError`/`router.refresh()`):

   a) `handleAcceptAndFork()`:
      - `setPending("fork")`
      - Call `await acceptAndForkSuggestion(suggestion.id)`
      - If result has `error`, `setError(result.error)`
      - No need to call `router.refresh()` because the action does `redirect()` which navigates away
      - The redirect happens server-side so the catch block should handle the NEXT_REDIRECT error gracefully. Use: `try { ... } catch(e) { if (typeof e === 'object' && e !== null && 'digest' in e) throw e; setError("..."); } finally { setPending(null); }`
      - This re-throws redirect "errors" (which are actually navigation signals) and only catches real errors

   b) `handleApplyInline()`:
      - `setPending("inline")`
      - Call `await applyInlineSuggestion(suggestion.id)`
      - If result has `error`, `setError(result.error)`, else `router.refresh()`
      - `setPending(null)` in finally

4. **Update "pending" status actions section** -- replace the current Accept button with two new buttons:

   ```tsx
   {status === "pending" && (
     <>
       <button
         onClick={handleAcceptAndFork}
         disabled={pending !== null}
         className="rounded-md bg-green-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
       >
         {pending === "fork" ? "Forking..." : "Accept & Fork"}
       </button>
       {suggestion.suggestedContent && (
         <button
           onClick={handleApplyInline}
           disabled={pending !== null}
           className="rounded-md bg-emerald-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed"
         >
           {pending === "inline" ? "Applying..." : "Apply Inline"}
         </button>
       )}
       <button
         onClick={() => handleStatusUpdate("dismissed")}
         disabled={pending !== null}
         className="rounded-md bg-gray-500 px-3 py-1.5 text-xs font-medium text-white hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
       >
         {pending === "dismissed" ? "Dismissing..." : "Dismiss"}
       </button>
       <button
         onClick={() => setShowReply(!showReply)}
         disabled={pending !== null}
         className="rounded-md bg-blue-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
       >
         Reply
       </button>
     </>
   )}
   ```

5. **Update "accepted" status actions section** -- add Accept & Fork and Apply Inline alongside existing Mark Implemented:
   ```tsx
   {status === "accepted" && (
     <>
       <button
         onClick={handleAcceptAndFork}
         disabled={pending !== null}
         className="rounded-md bg-green-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
       >
         {pending === "fork" ? "Forking..." : "Accept & Fork"}
       </button>
       {suggestion.suggestedContent && (
         <button
           onClick={handleApplyInline}
           disabled={pending !== null}
           className="rounded-md bg-emerald-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed"
         >
           {pending === "inline" ? "Applying..." : "Apply Inline"}
         </button>
       )}
       <button
         onClick={() => handleStatusUpdate("implemented")}
         disabled={pending !== null}
         className="rounded-md bg-blue-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
       >
         {pending === "implemented" ? "Marking..." : "Mark Implemented"}
       </button>
       <button
         onClick={() => handleStatusUpdate("dismissed")}
         disabled={pending !== null}
         className="rounded-md bg-gray-500 px-3 py-1.5 text-xs font-medium text-white hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
       >
         {pending === "dismissed" ? "Dismissing..." : "Dismiss"}
       </button>
       <button
         onClick={() => setShowReply(!showReply)}
         disabled={pending !== null}
         className="rounded-md bg-blue-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
       >
         Reply
       </button>
     </>
   )}
   ```

6. **Add traceability link** -- after the author reply section and before the error display, add:
   ```tsx
   {/* Traceability: link to implemented fork/skill */}
   {suggestion.implementedBySkillId && suggestion.implementedBySkillSlug && (
     <div className="mb-3 flex items-center gap-2 text-sm">
       <span className="text-gray-500">Implemented in:</span>
       <Link
         href={`/skills/${suggestion.implementedBySkillSlug}`}
         className="text-blue-600 hover:text-blue-800 hover:underline font-medium"
       >
         {suggestion.implementedBySkillName || "View Skill"}
       </Link>
     </div>
   )}
   ```

7. **Update data source** -- the suggestion list page that passes data to SuggestionCard needs to include the new fields. Find where `getSuggestionsForSkill` results are mapped to `SuggestionCardData` and add the three new fields. This is likely in the skill detail page or suggestion-list component.

   Check `apps/web/components/suggestion-list.tsx` for the data mapping. The `SuggestionWithUser` type from the DB service now includes `implementedBySkillId`. For `implementedBySkillSlug` and `implementedBySkillName`, the query in `getSuggestionsForSkill` needs a left join to skills on `implementedBySkillId`.

   Update `getSuggestionsForSkill` in `packages/db/src/services/skill-feedback.ts` to:
   - Create `const implementedSkillAlias = alias(skills, "implementedSkill")`
   - Add `.leftJoin(implementedSkillAlias, eq(skillFeedback.implementedBySkillId, implementedSkillAlias.id))`
   - Select `implementedSkillSlug: implementedSkillAlias.slug`, `implementedSkillName: implementedSkillAlias.name`
   - Add these to `SuggestionWithUser`: `implementedBySkillSlug: string | null`, `implementedBySkillName: string | null`
   - Map them in the return

   Then update the suggestion-list or skill detail page to pass these through to SuggestionCardData. Dates must use `.toISOString()` when passing from server to client component.
  </action>
  <verify>
    - `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` passes
    - Dev server starts and skill detail page with suggestions tab loads without error
    - Suggestion cards render with "Accept & Fork" and "Apply Inline" buttons for pending suggestions
  </verify>
  <done>
    - Pending suggestions show "Accept & Fork" (always) and "Apply Inline" (when suggestedContent exists) buttons
    - Accepted suggestions show "Accept & Fork", "Apply Inline" (conditional), and "Mark Implemented" buttons
    - Implemented suggestions with `implementedBySkillId` show "Implemented in: [Skill Name]" link
    - SuggestionCardData interface includes implementedBySkillId/Slug/Name
    - getSuggestionsForSkill returns implemented-by skill metadata via join
  </done>
</task>

<task type="auto">
  <name>Task 2: Auto-implement hooks in publish flows</name>
  <files>
    apps/web/app/actions/submit-for-review.ts
    apps/web/app/actions/admin-reviews.ts
  </files>
  <action>
Add auto-implement hooks to both publish paths so that when a fork is published, any suggestions linked to it via `implementedBySkillId` automatically transition from "accepted" to "implemented."

1. **`apps/web/app/actions/submit-for-review.ts`**:
   - Add import: `import { autoImplementLinkedSuggestions } from "@everyskill/db/services/skill-feedback";`
   - After the `if (autoApproved)` block where status is set to "published" (around line 109, after the three status updates), add:
     ```ts
     // SFORK-04: Auto-mark linked suggestions as implemented
     autoImplementLinkedSuggestions(skillId).catch(() => {});
     ```
   - Place this right after the publish status update and before the embedding generation. It is fire-and-forget (`.catch(() => {})`) so it does not block the response.

2. **`apps/web/app/actions/admin-reviews.ts`**:
   - Add import: `import { autoImplementLinkedSuggestions } from "@everyskill/db/services/skill-feedback";`
   - In `approveSkillAction`, after the transaction commits (after `await db.transaction(...)` closes, around line 93), add:
     ```ts
     // SFORK-04: Auto-mark linked suggestions as implemented
     autoImplementLinkedSuggestions(skillId).catch(() => {});
     ```
   - Place this right after the transaction and before the embedding generation fire-and-forget.
   - Only add to `approveSkillAction` (not reject or requestChanges -- those don't publish).
  </action>
  <verify>
    - `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` passes
    - `pnpm build` succeeds (full Next.js build)
    - Grep confirms both files contain `autoImplementLinkedSuggestions`: `grep -r "autoImplementLinkedSuggestions" apps/web/app/actions/`
  </verify>
  <done>
    - `submitForReview` calls `autoImplementLinkedSuggestions(skillId)` after auto-approve publish
    - `approveSkillAction` calls `autoImplementLinkedSuggestions(skillId)` after admin approve + publish
    - Both calls are fire-and-forget (non-blocking)
    - When a fork linked to a suggestion is published, the suggestion's status auto-transitions to "implemented"
  </done>
</task>

</tasks>

<verification>
- Typecheck passes for both packages/db and apps/web
- Full `pnpm build` succeeds
- Suggestion card renders Accept & Fork and Apply Inline buttons
- Both publish paths have the autoImplementLinkedSuggestions hook
- Run relevant Playwright tests: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/skill-detail.spec.ts` (if exists)
</verification>

<success_criteria>
- SFORK-01: "Accept & Fork" button visible on pending/accepted suggestions, clicking it creates a fork and redirects to it
- SFORK-02: "Apply Inline" button visible when suggestedContent exists, clicking it updates content and creates version
- SFORK-03: Implemented suggestions show "Implemented in: [Skill Name]" link to the resulting fork/skill
- SFORK-04: Publishing a linked fork auto-transitions suggestion to "implemented" via both submitForReview and approveSkillAction paths
- Manual "Mark Implemented" button retained as fallback on accepted suggestions
</success_criteria>

<output>
After completion, create `.planning/phases/59-suggestion-to-fork-pipeline/59-02-SUMMARY.md`
</output>
