---
phase: 67-skills-resume
plan: 02
type: execute
wave: 2
depends_on: ["67-01"]
files_modified:
  - apps/web/components/resume-view.tsx
  - apps/web/components/resume-pdf-button.tsx
  - apps/web/components/resume-share-controls.tsx
  - apps/web/app/(protected)/portfolio/resume/page.tsx
  - apps/web/app/r/[token]/page.tsx
  - apps/web/tests/e2e/portfolio.spec.ts
autonomous: true

must_haves:
  truths:
    - "User visits /portfolio/resume and sees a professionally formatted resume with skills, impact stats, quality badges, and contribution span"
    - "Resume defaults to showing only portable/personal skills"
    - "User can toggle to include company skills and the resume updates"
    - "User can generate a shareable public URL and copy it to clipboard"
    - "User can revoke the public share link"
    - "Visiting /r/[token] shows the resume without authentication"
    - "Visiting /r/[token] with a revoked or invalid token shows a 404 page"
    - "User can download the resume as a PDF"
    - "Resume emphasizes quantified impact: hours saved, people helped, estimated value"
    - "Quality achievements show Gold/Silver/Bronze badge counts"
  artifacts:
    - path: "apps/web/components/resume-view.tsx"
      provides: "Shared resume rendering component used by both auth and public pages"
      min_lines: 80
    - path: "apps/web/components/resume-pdf-button.tsx"
      provides: "PDF download button using jsPDF dynamic import"
      min_lines: 40
    - path: "apps/web/components/resume-share-controls.tsx"
      provides: "Generate/copy/revoke share link controls"
      min_lines: 40
    - path: "apps/web/app/(protected)/portfolio/resume/page.tsx"
      provides: "Authenticated resume preview page"
      exports: ["default"]
    - path: "apps/web/app/r/[token]/page.tsx"
      provides: "Public read-only resume page"
      exports: ["default"]
  key_links:
    - from: "apps/web/app/(protected)/portfolio/resume/page.tsx"
      to: "apps/web/lib/resume-queries.ts"
      via: "getResumeData call"
      pattern: "getResumeData"
    - from: "apps/web/app/r/[token]/page.tsx"
      to: "apps/web/lib/resume-queries.ts"
      via: "getResumeByToken call"
      pattern: "getResumeByToken"
    - from: "apps/web/components/resume-share-controls.tsx"
      to: "apps/web/app/actions/resume-share.ts"
      via: "createResumeShare/revokeResumeShare server actions"
      pattern: "createResumeShare|revokeResumeShare"
    - from: "apps/web/components/resume-pdf-button.tsx"
      to: "jspdf"
      via: "dynamic import in click handler"
      pattern: "await import.*jspdf"
---

<objective>
Build the Skills Resume UI: a shared resume view component, authenticated preview page with share/PDF controls, and a public read-only page accessible via token URL.

Purpose: Users can preview, share, and download their skills resume for professional use.
Output: /portfolio/resume page, /r/[token] public page, PDF download, share link management, E2E tests.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/67-skills-resume/67-01-SUMMARY.md
@apps/web/lib/resume-queries.ts
@apps/web/app/actions/resume-share.ts
@apps/web/components/ip-export-buttons.tsx
@apps/web/components/portfolio-view.tsx
@apps/web/lib/quality-score.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Resume view component and PDF download button</name>
  <files>
    apps/web/components/resume-view.tsx
    apps/web/components/resume-pdf-button.tsx
  </files>
  <action>
1. Create `apps/web/components/resume-view.tsx` ("use client"):

   Props interface:
   ```typescript
   interface ResumeViewProps {
     data: ResumeData;
     isPublic?: boolean; // hides share controls on public page
   }
   ```

   Layout — professional, clean, no internal jargon. Structure:

   a) **Header section**: User name (large, bold), "Skills Resume" subtitle, "Generated via EverySkill" small text.

   b) **Impact Summary row** (grid 2x2 on mobile, 4-col on lg):
      - "Skills Authored" with `data.skillsAuthored`
      - "Hours Saved" with `data.totalHoursSaved.toFixed(0)` (use formatNumber helper for commas — manual regex `value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")`, NOT toLocaleString)
      - "People Helped" with `data.peopleHelped`
      - "Estimated Value" with `$${formatNumber(data.estimatedValue)}`

   c) **Quality Achievements section** (only if any gold/silver/bronze > 0):
      - Row of badge counts: Gold (gold circle icon), Silver, Bronze
      - Format: "2 Gold, 3 Silver, 1 Bronze" as pill badges with appropriate colors
      - Gold: bg-yellow-100 text-yellow-800, Silver: bg-gray-100 text-gray-700, Bronze: bg-orange-100 text-orange-800

   d) **Contribution Timeline** (simple text, not a chart):
      - "Active since {first date}" to "Latest contribution {latest date}"
      - Format dates manually: `MONTHS[d.getUTCMonth()] + " " + d.getUTCFullYear()` (no getUTCDate — month/year sufficient)
      - MONTHS array: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]

   e) **Skills table/list** — ordered by totalHoursSaved DESC:
      - Each skill: name, category, "X uses", "Y hours saved", quality badge pill
      - Use a clean card-per-skill layout or table. Cards preferred for professional look:
        ```
        [Skill Name]                    [Gold badge]
        Category · 45 uses · 120 hours saved
        ```
      - If visibility is "personal", show small "Portable" green badge. If company, show "Company" blue badge.
      - No skills state: "No skills to display"

   f) **Footer**: "View full profile at everyskill.ai" (only on public page)

   Styling: Use white background, clean borders, professional typography. Card style: `rounded-lg bg-white shadow-sm border border-gray-200 p-6`. Overall container: `max-w-3xl mx-auto` for readable width.

   IMPORTANT: Do NOT use `toLocaleDateString()`, `toLocaleString()`, or `Intl.DateTimeFormat` — hydration mismatch risk. Use manual formatting.

2. Create `apps/web/components/resume-pdf-button.tsx` ("use client"):

   Follow the exact jsPDF dynamic import pattern from `apps/web/components/ip-export-buttons.tsx`.

   Props: `{ data: ResumeData }` (same ResumeData from resume-queries.ts).

   `handleDownloadPdf`:
   - `const { default: jsPDF } = await import("jspdf")`
   - `const { default: autoTable } = await import("jspdf-autotable")`
   - Build PDF:
     - Title: user name (22pt), "Skills Resume" subtitle (12pt gray)
     - Date: `Generated ${today}` (today = `new Date().toISOString().split("T")[0]`)
     - Impact Summary section: Skills Authored, Hours Saved, People Helped, Estimated Value (formatted with dollar sign and commas)
     - Quality Achievements line: "Gold: X, Silver: Y, Bronze: Z" (skip if all zero)
     - Skills table via autoTable: columns ["Skill", "Category", "Uses", "Hours Saved", "Quality"]
       - headStyles: { fillColor: [11, 22, 36] } (brand color)
       - styles: { fontSize: 9 }
     - Footer: "Generated via EverySkill - everyskill.ai"
   - Save: `doc.save(\`skills-resume-\${today}.pdf\`)`

   Button UI: Same style as ip-export-buttons.tsx — `inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50`. Show spinner while exporting.

   Import DownloadIcon and SpinnerIcon inline (same SVG patterns as ip-export-buttons.tsx — do not import from there since they're not exported).
  </action>
  <verify>
    - `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` compiles
    - Grep resume-view.tsx for "toLocaleDateString" or "toLocaleString" — must return NO results
    - Grep resume-pdf-button.tsx for `await import("jspdf")` — must find the dynamic import
  </verify>
  <done>ResumeView renders professional resume layout; ResumePdfButton generates downloadable PDF via dynamic jsPDF import</done>
</task>

<task type="auto">
  <name>Task 2: Authenticated resume page, share controls, and public page</name>
  <files>
    apps/web/components/resume-share-controls.tsx
    apps/web/app/(protected)/portfolio/resume/page.tsx
    apps/web/app/r/[token]/page.tsx
  </files>
  <action>
1. Create `apps/web/components/resume-share-controls.tsx` ("use client"):

   Props: `{ initialShare: { token: string; includeCompanySkills: boolean; url: string } | null }`

   State:
   - `share` (the current active share or null)
   - `includeCompanySkills` boolean toggle
   - `isGenerating` loading state
   - `isCopied` for "Copied!" feedback
   - `isRevoking` loading state

   UI layout — horizontal row of controls above the resume:

   a) **Toggle**: "Include company skills" checkbox/toggle. When changed AND share exists, regenerate share with new setting. When changed AND no share, just update local state (the preview page passes this to getResumeData).
      - Use a simple checkbox: `<input type="checkbox" checked={includeCompanySkills} onChange={...} />`
      - Label: "Include company skills" with small helper text "(portable skills only by default)"

   b) **Generate/Share button**: If no active share, show "Generate Share Link". If active share exists, show the URL in a readonly input with "Copy" button next to it.
      - On generate: call `createResumeShare(includeCompanySkills)` server action, set share state.
      - On copy: `navigator.clipboard.writeText(fullUrl)`, set isCopied=true for 2 seconds.
      - Full URL: `window.location.origin + share.url` (e.g., "https://everyskill.ai/r/abc123")

   c) **Revoke button**: If active share exists, show small "Revoke" link/button in red. Calls `revokeResumeShare()`, clears share state.

   Export an `onToggleCompanySkills` callback prop so the parent page can refetch data when the toggle changes. Type: `onToggleCompanySkills?: (include: boolean) => void`.

2. Create `apps/web/app/(protected)/portfolio/resume/page.tsx` (server component):

   ```typescript
   import { auth } from "@/auth";
   import { redirect } from "next/navigation";
   import { getResumeData } from "@/lib/resume-queries";
   import { getActiveShare } from "@/app/actions/resume-share";
   import { ResumeView } from "@/components/resume-view";
   import { ResumePdfButton } from "@/components/resume-pdf-button";
   import { ResumeShareControls } from "@/components/resume-share-controls";
   ```

   - Auth check: get session, redirect if not authenticated.
   - Fetch data in parallel: `const [resumeData, activeShare] = await Promise.all([getResumeData(userId), getActiveShare()])`
   - If activeShare exists and includeCompanySkills differs from default, refetch with that setting.
   - Page layout:
     ```
     <h1>Skills Resume</h1>
     <p>Preview and share your professional skills summary</p>
     <div className="flex items-center gap-3">
       <ResumePdfButton data={resumeData} />
       <Link href="/portfolio">Back to Portfolio</Link>
     </div>
     <ResumeShareControls initialShare={activeShare} />
     <ResumeView data={resumeData} />
     ```
   - Metadata: `export const metadata = { title: "Skills Resume | EverySkill" }`

   NOTE: The toggle for "include company skills" changes what data is shown. Since this is a server component, the toggle in ResumeShareControls should trigger a page refresh via `router.refresh()` after creating a new share with updated settings. Alternatively, make the toggle a URL search param (`?include=company`) and read it in the server component to decide the filter. Use the search param approach:
   - Read `searchParams.include === 'company'` to determine includeCompanySkills
   - ResumeShareControls navigates to `?include=company` or removes the param using `router.push`

3. Create `apps/web/app/r/[token]/page.tsx` (server component):

   ```typescript
   import { getResumeByToken } from "@/lib/resume-queries";
   import { ResumeView } from "@/components/resume-view";
   import { ResumePdfButton } from "@/components/resume-pdf-button";
   import { notFound } from "next/navigation";
   ```

   - Extract token from `params` (Next.js 16 pattern: `params` is a Promise, await it).
   - Call `getResumeByToken(token)`. If null, call `notFound()`.
   - Render:
     ```
     <div className="min-h-screen bg-gray-50 py-8">
       <div className="mx-auto max-w-3xl px-4">
         <div className="mb-4 flex justify-end">
           <ResumePdfButton data={resumeData} />
         </div>
         <ResumeView data={resumeData} isPublic />
       </div>
     </div>
     ```
   - Metadata: generate dynamic title from resume data: `export async function generateMetadata({ params }) { ... }` — return `{ title: "${name}'s Skills Resume" }` or fallback "Skills Resume".
   - No auth check — this page is public (middleware already exempts /r/).
  </action>
  <verify>
    - `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` compiles
    - `cd /home/dev/projects/relay/apps/web && pnpm build` completes (verifies both pages render without import errors)
    - Start dev server and visit http://localhost:2002/portfolio/resume — page loads
  </verify>
  <done>Authenticated resume page shows preview with share/PDF controls; public /r/[token] page renders resume without auth; toggle controls portable vs all skills</done>
</task>

<task type="auto">
  <name>Task 3: E2E tests and portfolio page link</name>
  <files>
    apps/web/tests/e2e/portfolio.spec.ts
    apps/web/components/portfolio-view.tsx
  </files>
  <action>
1. Add a "Skills Resume" link to the portfolio page. In `apps/web/components/portfolio-view.tsx`:
   - Add a Link to `/portfolio/resume` in the page header area, next to the "My Portfolio" heading.
   - Style: `inline-flex items-center gap-1 rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-indigo-700`
   - Text: "View Resume" or "Skills Resume"
   - Place in a flex row with the h1: `<div className="flex items-center justify-between"><h1>...</h1><Link href="/portfolio/resume">Skills Resume</Link></div>`

2. Add E2E tests to `apps/web/tests/e2e/portfolio.spec.ts`. Append new test cases:

   ```typescript
   test("should have Skills Resume link on portfolio page", async ({ page }) => {
     await page.goto("/portfolio");
     const resumeLink = page.getByRole("link", { name: /resume/i });
     await expect(resumeLink).toBeVisible();
     await expect(resumeLink).toHaveAttribute("href", "/portfolio/resume");
   });

   test("should load /portfolio/resume page with resume content", async ({ page }) => {
     await page.goto("/portfolio/resume");
     // Page should load without error
     await expect(page.locator("h1")).toContainText("Skills Resume");
     // Impact stats should be present
     await expect(page.getByText("Skills Authored")).toBeVisible();
     await expect(page.getByText("Hours Saved")).toBeVisible();
     await expect(page.getByText("People Helped")).toBeVisible();
     // PDF download button should be present
     await expect(page.getByRole("button", { name: /pdf|download/i })).toBeVisible();
   });

   test("should display share controls on resume page", async ({ page }) => {
     await page.goto("/portfolio/resume");
     // Share controls should be visible (either generate button or existing link)
     const generateBtn = page.getByRole("button", { name: /generate|share/i });
     const shareInput = page.locator("input[readonly]");
     await expect(generateBtn.or(shareInput)).toBeVisible();
   });
   ```

3. Run the E2E tests: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/portfolio.spec.ts`
   - If any tests fail, fix the issues before completing.
   - If the dev server is not running, start it first.
  </action>
  <verify>
    - All portfolio E2E tests pass: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/portfolio.spec.ts`
    - Portfolio page shows "Skills Resume" link
    - /portfolio/resume page loads with resume content
  </verify>
  <done>Portfolio page links to resume; E2E tests verify resume page loads, shows impact stats, PDF button, and share controls</done>
</task>

</tasks>

<verification>
- /portfolio/resume loads and shows professional resume with impact stats, quality badges, skills list
- Default view shows only portable/personal skills
- "Include company skills" toggle changes displayed skills
- "Generate Share Link" creates a public URL
- Visiting /r/[token] shows the resume without authentication
- Invalid/revoked tokens show 404
- PDF download generates a clean document with all resume data
- All E2E tests pass
</verification>

<success_criteria>
- User sees professionally formatted resume at /portfolio/resume with quantified impact (hours saved, people helped, estimated value)
- Quality achievements (Gold/Silver/Bronze counts) display correctly
- Only portable skills shown by default; toggle adds company skills
- Share link generation creates public URL at /r/[token] that works without login
- PDF download produces clean document following ip-export-buttons.tsx pattern
- E2E tests confirm resume page loads, shows stats, has PDF button and share controls
</success_criteria>

<output>
After completion, create `.planning/phases/67-skills-resume/67-02-SUMMARY.md`
</output>
