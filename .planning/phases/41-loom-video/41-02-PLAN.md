---
phase: 41-loom-video
plan: 02
type: execute
wave: 2
depends_on: ["41-01"]
files_modified:
  - apps/web/components/loom-embed.tsx
  - apps/web/app/(protected)/skills/[slug]/page.tsx
  - apps/web/components/skill-detail.tsx
  - apps/web/components/skills-table-row.tsx
  - apps/web/components/trending-section.tsx
autonomous: true

must_haves:
  truths:
    - "Skill detail page shows embedded Loom video player when skill has a loom_url"
    - "Skill detail page renders normally when skill has no loom_url"
    - "Loom oEmbed metadata (title, duration) is displayed alongside the video"
    - "Browse table rows show a play icon indicator when skill has a loom_url"
    - "Trending section cards show a play icon indicator when skill has a loom_url"
    - "Broken or private Loom videos show a graceful fallback, not a broken page"
  artifacts:
    - path: "apps/web/components/loom-embed.tsx"
      provides: "Reusable Loom video embed component"
      contains: "LoomEmbed"
    - path: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      provides: "oEmbed fetch integration on detail page"
      contains: "fetchLoomOEmbed"
    - path: "apps/web/components/skill-detail.tsx"
      provides: "Video embed rendered in detail view"
      contains: "LoomEmbed"
    - path: "apps/web/components/skills-table-row.tsx"
      provides: "Play icon for skills with video"
      contains: "loomUrl"
    - path: "apps/web/components/trending-section.tsx"
      provides: "Play icon for trending skills with video"
      contains: "loomUrl"
  key_links:
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "apps/web/lib/loom.ts"
      via: "fetchLoomOEmbed called server-side"
      pattern: "fetchLoomOEmbed"
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "apps/web/components/skill-detail.tsx"
      via: "loomEmbed prop passed to SkillDetail"
      pattern: "loomEmbed"
    - from: "apps/web/components/skill-detail.tsx"
      to: "apps/web/components/loom-embed.tsx"
      via: "LoomEmbed component rendered conditionally"
      pattern: "LoomEmbed"
---

<objective>
Display embedded Loom video on skill detail pages and show video indicators on browse/trending cards.

Purpose: Viewers watch demo videos inline on skill detail pages (LOOM-02), and browse pages indicate which skills have videos (LOOM-04).
Output: LoomEmbed component, detail page integration, browse page indicators.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/41-loom-video/41-RESEARCH.md
@.planning/phases/41-loom-video/41-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: LoomEmbed component and detail page integration</name>
  <files>
    apps/web/components/loom-embed.tsx
    apps/web/app/(protected)/skills/[slug]/page.tsx
    apps/web/components/skill-detail.tsx
  </files>
  <action>
1. Create `apps/web/components/loom-embed.tsx` as a server component (no "use client"):
   - Props: `{ videoId: string; title?: string; duration?: number }`
   - Render a responsive container with `position: relative` and `padding-bottom: 62.5%` (16:10 Loom aspect ratio)
   - Inside: an `<iframe>` with `src="https://www.loom.com/embed/{videoId}"`, `allowFullScreen`, `allow="encrypted-media *;"`, `className="absolute inset-0 h-full w-full rounded-lg"`, `frameBorder="0"`
   - Below the iframe container, if `title` is provided, render it in a `<p>` with muted styling. If `duration` is provided, format as "Xm Ys" and display next to the title.
   - Wrap everything in a section with a subtle border and rounded corners, matching the codebase style (e.g., `rounded-lg border border-gray-200 p-4`).

2. In `apps/web/app/(protected)/skills/[slug]/page.tsx`:
   - Import `fetchLoomOEmbed` and `extractLoomVideoId` from `@/lib/loom`
   - After the existing parallel `Promise.all` block (line 76-94), add a parallel oEmbed fetch:
     ```typescript
     const loomData = skill.loomUrl
       ? fetchLoomOEmbed(skill.loomUrl)
       : Promise.resolve(null);
     ```
     Add this to the existing `Promise.all` array as a 9th item (after `parentSkill`) to keep it parallel with other fetches.
   - Extract the video ID: `const loomVideoId = skill.loomUrl ? extractLoomVideoId(skill.loomUrl) : null;`
   - Pass `loomVideoId` and `loomEmbed` (the resolved oEmbed data) as props to `<SkillDetail>`:
     ```typescript
     loomVideoId={loomVideoId}
     loomEmbed={loomData_resolved_value}
     ```

3. In `apps/web/components/skill-detail.tsx`:
   - Import `LoomEmbed` from `./loom-embed`
   - Import `LoomOEmbedResponse` type from `@/lib/loom`
   - Add to `SkillDetailProps`:
     ```typescript
     loomVideoId?: string | null;
     loomEmbed?: LoomOEmbedResponse | null;
     ```
   - Add `loomVideoId` and `loomEmbed` to destructured props
   - Render the video ABOVE the "Description" section (before line 141). Conditionally render only when `loomVideoId` is truthy:
     ```tsx
     {loomVideoId && (
       <div className="mt-8">
         <h2 className="mb-2 text-xl font-semibold">Demo Video</h2>
         <LoomEmbed
           videoId={loomVideoId}
           title={loomEmbed?.title}
           duration={loomEmbed?.duration}
         />
       </div>
     )}
     ```
  </action>
  <verify>
    - `npx tsc --noEmit -p apps/web/tsconfig.json` passes
    - Dev server builds without errors
    - A skill page WITHOUT a loom_url renders normally (no video section)
    - Manually insert a test loom_url into a skill: `psql "$DATABASE_URL" -c "UPDATE skills SET loom_url='https://www.loom.com/share/1234567890abcdef1234567890abcdef' WHERE slug='some-existing-slug'"` -- the detail page shows "Demo Video" section with iframe (iframe may show Loom error for fake ID, but the component renders)
  </verify>
  <done>LoomEmbed component renders Loom iframe, skill detail page fetches oEmbed data and displays video when loom_url present, pages without loom_url unaffected</done>
</task>

<task type="auto">
  <name>Task 2: Video indicators on browse table and trending cards</name>
  <files>
    apps/web/components/skills-table-row.tsx
    apps/web/components/skills-table.tsx
    apps/web/components/trending-section.tsx
    apps/web/lib/search-skills.ts
    apps/web/lib/trending.ts
  </files>
  <action>
1. In `apps/web/lib/search-skills.ts`, add `loomUrl: string | null;` to the `SearchSkillResult` interface (after `hoursSaved`). In the `searchSkills` function, ensure `loom_url` is included in the query results -- since the query uses `db.select()` on the `skills` table and the column exists, it should already be included. Verify and add the column to the select if it uses explicit column selection.

2. In `apps/web/lib/trending.ts`, add `loomUrl: string | null;` to the `TrendingSkill` interface. Verify the SQL query includes it -- if using raw SQL, add `s.loom_url as "loomUrl"` to the SELECT clause.

3. In `apps/web/components/skills-table.tsx`, add `loomUrl?: string | null;` to the `SkillTableRow` interface.

4. In `apps/web/components/skills-table-row.tsx`:
   - In the first `<td>` cell (skill name, around line 118-126), add a play icon indicator after the skill name Link:
     ```tsx
     {skill.loomUrl && (
       <span className="ml-2 inline-flex items-center text-blue-500" title="Has demo video">
         <svg className="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
           <path d="M8 5v14l11-7z"/>
         </svg>
       </span>
     )}
     ```
   - The `skill` prop type already extends `SkillTableRow` so `loomUrl` will flow through.

5. In `apps/web/components/trending-section.tsx`:
   - Add a play icon indicator inside each trending card, next to the category badge (around line 46):
     ```tsx
     {skill.loomUrl && (
       <span className="ml-2 inline-flex items-center text-blue-500" title="Has demo video">
         <svg className="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
           <path d="M8 5v14l11-7z"/>
         </svg>
       </span>
     )}
     ```
   - This requires updating `TrendingSkill` import type which was done in step 2.
  </action>
  <verify>
    - `npx tsc --noEmit -p apps/web/tsconfig.json` passes
    - Dev server builds without errors
    - Browse page loads without errors
    - Skills with loom_url show a small blue play icon next to their name in the browse table
    - Trending section cards show play icon for skills with loom_url
    - Skills without loom_url show no icon (no visual change)
  </verify>
  <done>Browse table rows and trending cards display a play icon indicator for skills with a Loom video URL, no oEmbed fetches on browse pages</done>
</task>

</tasks>

<verification>
- Skill detail page with loom_url: shows embedded Loom video player in a "Demo Video" section
- Skill detail page without loom_url: renders exactly as before (no video section)
- Browse table: skills with loom_url show blue play icon next to name
- Trending cards: skills with loom_url show blue play icon next to category badge
- oEmbed fetch only happens on detail page, not on browse/trending pages (no N+1)
- TypeScript compiles without errors across the entire project
</verification>

<success_criteria>
- LoomEmbed component exists and renders responsive iframe
- Detail page fetches oEmbed server-side with 1-hour cache
- Video title and duration shown as metadata
- Play icon indicators visible on browse table and trending cards
- No performance regression on browse page (no oEmbed calls)
- Graceful fallback when oEmbed fails (null handled, no broken pages)
</success_criteria>

<output>
After completion, create `.planning/phases/41-loom-video/41-02-SUMMARY.md`
</output>
