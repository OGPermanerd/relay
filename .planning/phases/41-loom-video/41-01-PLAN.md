---
phase: 41-loom-video
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/skills.ts
  - packages/db/src/migrations/0020_add_loom_url.sql
  - apps/web/lib/loom.ts
  - apps/web/app/actions/skills.ts
  - apps/web/components/skill-upload-form.tsx
autonomous: true

must_haves:
  truths:
    - "Skills table has a loom_url column that accepts nullable text"
    - "Author can enter a Loom URL when creating a skill"
    - "Invalid Loom URLs are rejected with a clear error message"
    - "Valid Loom URLs are stored in the database on skill creation"
  artifacts:
    - path: "packages/db/src/schema/skills.ts"
      provides: "loomUrl column on skills table"
      contains: "loomUrl.*text.*loom_url"
    - path: "packages/db/src/migrations/0020_add_loom_url.sql"
      provides: "Database migration for loom_url column"
      contains: "ADD COLUMN.*loom_url"
    - path: "apps/web/lib/loom.ts"
      provides: "Loom URL validation, oEmbed fetcher, video ID extractor"
      contains: "isValidLoomUrl"
    - path: "apps/web/app/actions/skills.ts"
      provides: "Zod validation for loomUrl field, insert into DB"
      contains: "loomUrl"
    - path: "apps/web/components/skill-upload-form.tsx"
      provides: "Loom URL input field in creation form"
      contains: "loomUrl"
  key_links:
    - from: "apps/web/components/skill-upload-form.tsx"
      to: "apps/web/app/actions/skills.ts"
      via: "form field name='loomUrl' submitted to checkAndCreateSkill"
      pattern: "name=\"loomUrl\""
    - from: "apps/web/app/actions/skills.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "loomUrl inserted into skills table"
      pattern: "loomUrl.*formData"
---

<objective>
Add Loom video URL support to the skills schema, server action, and creation form.

Purpose: Enable authors to attach a Loom demo video when creating a skill (LOOM-01, LOOM-03).
Output: Schema migration applied, validation utility created, form field functional.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/41-loom-video/41-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema, migration, and Loom utility library</name>
  <files>
    packages/db/src/schema/skills.ts
    packages/db/src/migrations/0020_add_loom_url.sql
    apps/web/lib/loom.ts
  </files>
  <action>
1. In `packages/db/src/schema/skills.ts`, add a `loomUrl` column after the `visibility` field (line 48) and before `publishedVersionId` (line 51):
   ```typescript
   loomUrl: text("loom_url"), // Optional Loom video demo URL
   ```

2. Create `packages/db/src/migrations/0020_add_loom_url.sql`:
   ```sql
   ALTER TABLE skills ADD COLUMN IF NOT EXISTS loom_url TEXT;
   ```

3. Run the migration against the dev database:
   ```bash
   psql "$DATABASE_URL" -f packages/db/src/migrations/0020_add_loom_url.sql
   ```

4. Create `apps/web/lib/loom.ts` with three exports:
   - `LOOM_URL_REGEX`: Pattern matching `https://(www.)?loom.com/(share|embed|i)/[a-f0-9]{32}` with optional query params
   - `isValidLoomUrl(url: string): boolean` -- tests URL against regex
   - `extractLoomVideoId(url: string): string | null` -- extracts the 32-char hex video ID
   - `LoomOEmbedResponse` interface with fields: type, html, title, height, width, provider_name, provider_url, thumbnail_url, thumbnail_height, thumbnail_width, duration
   - `fetchLoomOEmbed(loomUrl: string): Promise<LoomOEmbedResponse | null>` -- fetches from `https://www.loom.com/v1/oembed?url={url}` with `{ next: { revalidate: 3600 } }` caching. Returns null on error or non-ok response.
  </action>
  <verify>
    - `psql "$DATABASE_URL" -c "\d skills" | grep loom_url` shows the column exists
    - `npx tsc --noEmit -p apps/web/tsconfig.json` passes (schema types updated)
  </verify>
  <done>skills table has loom_url TEXT column, loom.ts exports validation/fetch utilities, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Zod validation and form field for Loom URL</name>
  <files>
    apps/web/app/actions/skills.ts
    apps/web/components/skill-upload-form.tsx
  </files>
  <action>
1. In `apps/web/app/actions/skills.ts`, add `loomUrl` to the `createSkillSchema` Zod object (after the `visibility` field at line 98):
   ```typescript
   loomUrl: z
     .string()
     .url("Must be a valid URL")
     .regex(
       /^https?:\/\/(www\.)?loom\.com\/(share|embed|i)\/[a-f0-9]{32}(\?.*)?$/,
       "Must be a Loom video URL (e.g. https://www.loom.com/share/...)"
     )
     .optional()
     .or(z.literal("")),
   ```

2. In `checkAndCreateSkill` function, add `loomUrl` to the `safeParse` call (around line 183):
   ```typescript
   loomUrl: formData.get("loomUrl"),
   ```

3. In the `db.insert(skills).values(...)` call (around line 221), add:
   ```typescript
   loomUrl: parsed.data.loomUrl || null,
   ```

4. Also update the standalone `createSkill` function's safeParse and insert similarly (same pattern, around lines 337 and 410).

5. In `apps/web/components/skill-upload-form.tsx`:
   - Add `loomUrl: ""` to the `fields` state object (line 29 area)
   - Add a Loom URL input field after the "Hours Saved" field and before the "Content" field. Use:
     - `type="url"`, `id="loomUrl"`, `name="loomUrl"`
     - Label: "Demo Video (Loom)"
     - Placeholder: "https://www.loom.com/share/..."
     - Help text: "Optional: Add a Loom video demo of this skill"
     - Error display for `errors?.loomUrl`
     - Same styling classes as other input fields in the form
  </action>
  <verify>
    - `npx tsc --noEmit -p apps/web/tsconfig.json` passes
    - Dev server builds without errors
    - Navigate to /skills/new — Loom URL field is visible between Hours Saved and Content
    - Submit form with invalid URL like "https://example.com" in loomUrl field — shows validation error
    - Submit form with empty loomUrl — succeeds (field is optional)
  </verify>
  <done>Loom URL field appears on skill creation form, Zod validates Loom URL format, valid URLs are stored in the skills table on creation</done>
</task>

</tasks>

<verification>
- `psql "$DATABASE_URL" -c "SELECT column_name, data_type FROM information_schema.columns WHERE table_name='skills' AND column_name='loom_url'"` returns one row
- TypeScript compiles without errors
- Skill creation form shows Loom URL field
- Creating a skill with a valid Loom URL stores it in the database
- Creating a skill without a Loom URL works (field is optional)
</verification>

<success_criteria>
- loom_url column exists in skills table (nullable TEXT)
- loom.ts exports isValidLoomUrl, extractLoomVideoId, fetchLoomOEmbed
- Zod schema validates Loom URL format (accepts share/embed/i patterns, rejects non-Loom URLs)
- Skill creation form has working Loom URL input
- Skills created with Loom URLs store the URL in the database
</success_criteria>

<output>
After completion, create `.planning/phases/41-loom-video/41-01-SUMMARY.md`
</output>
