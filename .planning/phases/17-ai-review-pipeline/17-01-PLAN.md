---
phase: 17-ai-review-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/skill-reviews.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/services/skill-reviews.ts
  - packages/db/src/services/index.ts
autonomous: true
user_setup:
  - service: anthropic
    why: "AI review generation via Claude API"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys (https://console.anthropic.com/settings/keys)"

must_haves:
  truths:
    - "skill_reviews table exists in database with correct columns"
    - "CRUD service functions exist for creating, reading, and upserting reviews"
    - "@anthropic-ai/sdk is installed and importable"
  artifacts:
    - path: "packages/db/src/schema/skill-reviews.ts"
      provides: "skillReviews table definition with JSONB categories, content hash, visibility toggle"
      contains: "skillReviews"
    - path: "packages/db/src/services/skill-reviews.ts"
      provides: "getSkillReview, upsertSkillReview functions"
      exports: ["getSkillReview", "upsertSkillReview"]
    - path: "packages/db/src/schema/index.ts"
      provides: "Re-exports skill-reviews schema"
      contains: "skill-reviews"
    - path: "packages/db/src/services/index.ts"
      provides: "Re-exports skill-reviews service"
      contains: "skill-reviews"
  key_links:
    - from: "packages/db/src/schema/skill-reviews.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "foreign key reference"
      pattern: "references.*skills\\.id"
    - from: "packages/db/src/services/skill-reviews.ts"
      to: "packages/db/src/schema/skill-reviews.ts"
      via: "import skillReviews table"
      pattern: "import.*skillReviews"
---

<objective>
Create the database schema, service layer, and install the Anthropic SDK for the AI review pipeline.

Purpose: This is the foundation layer -- the review table stores structured review data (six category scores as JSONB, content hash for change detection, visibility toggle), and the service layer provides clean CRUD operations that the server action and UI will consume.
Output: `skill_reviews` table pushed to database, service functions for get/upsert, `@anthropic-ai/sdk` installed.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-ai-review-pipeline/17-CONTEXT.md
@.planning/phases/17-ai-review-pipeline/17-RESEARCH.md

@packages/db/src/schema/skill-embeddings.ts
@packages/db/src/schema/skills.ts
@packages/db/src/schema/index.ts
@packages/db/src/services/skill-embeddings.ts
@packages/db/src/services/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create skill_reviews schema and service layer</name>
  <files>
    packages/db/src/schema/skill-reviews.ts
    packages/db/src/schema/index.ts
    packages/db/src/services/skill-reviews.ts
    packages/db/src/services/index.ts
  </files>
  <action>
    1. Create `packages/db/src/schema/skill-reviews.ts`:
       - Define `ReviewCategoryScore` interface: `{ score: number; suggestions: string[] }`
       - Define `ReviewCategories` interface with six fields: functionality, quality, security, clarity, completeness, reusability -- each of type `ReviewCategoryScore`
       - Define `skillReviews` table using `pgTable("skill_reviews", {...})`:
         - `id`: text, primaryKey, defaultFn crypto.randomUUID()
         - `skillId`: text, notNull, unique (one review per skill -- latest replaces previous), references skills.id with onDelete cascade
         - `requestedBy`: text, notNull, references users.id
         - `categories`: jsonb.$type<ReviewCategories>(), notNull
         - `summary`: text, notNull (brief overall summary from AI)
         - `reviewedContentHash`: text, notNull (SHA-256 hash of skill content at review time, for change detection)
         - `modelName`: text, notNull (e.g., "claude-haiku-4-5-20241022")
         - `isVisible`: boolean, notNull, default true (author can hide)
         - `createdAt`: timestamp with timezone, precision 3, notNull, defaultNow()
       - Export types: `SkillReview`, `NewSkillReview`, `ReviewCategoryScore`, `ReviewCategories`
       - Follow the pattern from `skill-embeddings.ts` for table definition style

    2. Update `packages/db/src/schema/index.ts`:
       - Add `export * from "./skill-reviews";` at the end

    3. Create `packages/db/src/services/skill-reviews.ts`:
       - Import db, skillReviews, eq from appropriate paths (follow skill-embeddings.ts pattern)
       - `getSkillReview(skillId: string)`: Returns the review for a skill or null. Query by skillId using eq().
       - `upsertSkillReview(data: NewSkillReview)`: Insert or update review using `.onConflictDoUpdate({ target: skillReviews.skillId, set: { ... } })`. Update all fields except id on conflict. Set createdAt to new Date() on update.
       - `toggleReviewVisibility(skillId: string, isVisible: boolean)`: Update isVisible field for a skill's review.

    4. Update `packages/db/src/services/index.ts`:
       - Add re-exports for getSkillReview, upsertSkillReview, toggleReviewVisibility from "./skill-reviews"

    Note: The `db` import pattern in this project uses `import { db } from "../client"` or similar -- check the existing service files for the exact import path.
  </action>
  <verify>
    Run `pnpm build --filter db` to verify schema compiles. Run `npx drizzle-kit push` from the db package to push schema to database. Verify the table exists with `psql` or drizzle studio.
  </verify>
  <done>
    - skill_reviews table exists in database with all columns (id, skillId unique, requestedBy, categories JSONB, summary, reviewedContentHash, modelName, isVisible, createdAt)
    - TypeScript types (SkillReview, NewSkillReview, ReviewCategories, ReviewCategoryScore) are exported
    - Service functions (getSkillReview, upsertSkillReview, toggleReviewVisibility) compile and are re-exported from index
  </done>
</task>

<task type="auto">
  <name>Task 2: Install Anthropic SDK</name>
  <files>
    apps/web/package.json
  </files>
  <action>
    Run `pnpm add @anthropic-ai/sdk --filter web` to install the Anthropic TypeScript SDK in the web app.

    After installation, verify the import works by checking that `@anthropic-ai/sdk` and `@anthropic-ai/sdk/helpers/zod` are resolvable. Create a quick test: `node -e "require('@anthropic-ai/sdk')"` from the web app directory, or check the package.json has the dependency listed.

    Note: Do NOT add ANTHROPIC_API_KEY to any committed file. The user_setup frontmatter handles prompting the user to add it to .env.local.
  </action>
  <verify>
    Run `pnpm ls @anthropic-ai/sdk --filter web` to confirm installation. Check `apps/web/package.json` includes the dependency.
  </verify>
  <done>
    - @anthropic-ai/sdk appears in apps/web/package.json dependencies
    - Package is installed and resolvable
  </done>
</task>

</tasks>

<verification>
- `pnpm build --filter db` succeeds (schema compiles)
- `pnpm ls @anthropic-ai/sdk --filter web` shows the package
- Database has `skill_reviews` table with correct columns
- `packages/db/src/services/index.ts` re-exports all three service functions
</verification>

<success_criteria>
- skill_reviews table exists in database with JSONB categories column, unique skillId constraint, and all required fields
- Service layer provides getSkillReview, upsertSkillReview, toggleReviewVisibility
- @anthropic-ai/sdk installed in web app
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-ai-review-pipeline/17-01-SUMMARY.md`
</output>
