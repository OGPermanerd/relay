---
phase: 17-ai-review-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - apps/web/components/ai-review-display.tsx
  - apps/web/components/ai-review-tab.tsx
  - apps/web/components/skill-detail-tabs.tsx
  - apps/web/app/(protected)/skills/[slug]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Skill detail page has a tabbed layout with 'Details' and 'AI Review' tabs"
    - "Author sees 'Get AI Review' button on the AI Review tab"
    - "Button shows inline loading spinner while review generates"
    - "Completed review displays six category scores with blue/green color palette"
    - "Each category shows 1-2 suggestions alongside the score"
    - "Author can hide/show the review via a toggle"
    - "Non-authors see the review (if visible) but cannot trigger reviews"
    - "Re-review button is disabled when content hasn't changed"
    - "Review is clearly marked with 'AI Review' badge"
  artifacts:
    - path: "apps/web/components/ai-review-tab.tsx"
      provides: "Client component with review trigger button, loading state, visibility toggle"
      contains: "useActionState"
    - path: "apps/web/components/ai-review-display.tsx"
      provides: "Review score cards with blue/green color palette, suggestions, summary"
      contains: "getScoreColor"
    - path: "apps/web/components/skill-detail-tabs.tsx"
      provides: "Client-side tab wrapper with Details and AI Review tabs, ARIA attributes"
      contains: "useState"
    - path: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      provides: "Tab layout wrapping existing detail content and AI review tab"
      contains: "ai-review"
  key_links:
    - from: "apps/web/components/ai-review-tab.tsx"
      to: "apps/web/app/actions/ai-review.ts"
      via: "useActionState with requestAiReview server action"
      pattern: "useActionState.*requestAiReview"
    - from: "apps/web/components/ai-review-tab.tsx"
      to: "apps/web/components/ai-review-display.tsx"
      via: "renders AiReviewDisplay when review exists"
      pattern: "AiReviewDisplay"
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "apps/web/components/skill-detail-tabs.tsx"
      via: "imports and renders tab wrapper component"
      pattern: "SkillDetailTabs"
    - from: "apps/web/components/skill-detail-tabs.tsx"
      to: "apps/web/components/ai-review-tab.tsx"
      via: "renders AiReviewTab as aiReviewContent prop"
      pattern: "aiReviewContent"
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "packages/db/src/services/skill-reviews.ts"
      via: "fetches existing review on page load"
      pattern: "getSkillReview"
---

<objective>
Build the AI Review tab UI on the skill detail page with review trigger, score display, and visibility controls.

Purpose: This is the user-facing layer -- it adds a tabbed layout to the skill detail page with "Details" and "AI Review" tabs. The AI Review tab shows the trigger button (for authors), loading state, review scores with the blue/green color palette, suggestions, and a visibility toggle.
Output: Complete, interactive AI review experience on the skill detail page.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/17-ai-review-pipeline/17-CONTEXT.md
@.planning/phases/17-ai-review-pipeline/17-RESEARCH.md
@.planning/phases/17-ai-review-pipeline/17-01-SUMMARY.md
@.planning/phases/17-ai-review-pipeline/17-02-SUMMARY.md

@apps/web/app/(protected)/skills/[slug]/page.tsx
@apps/web/components/skill-detail.tsx
@apps/web/components/rating-form.tsx
@apps/web/app/actions/ai-review.ts
@packages/db/src/schema/skill-reviews.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI review display component</name>
  <files>apps/web/components/ai-review-display.tsx</files>
  <action>
    Create `apps/web/components/ai-review-display.tsx`:

    A component that renders the review scores and suggestions. Can be server or client component (no interactivity needed in display itself).

    - Import `ReviewCategories` type from `@everyskill/db/schema`
    - **getScoreColor helper** (per CONTEXT -- softened blue/green spectrum, NO red):
      - 8-10: `"text-emerald-600 bg-emerald-50"` (strong green)
      - 6-7: `"text-teal-600 bg-teal-50"` (teal)
      - 4-5: `"text-cyan-600 bg-cyan-50"` (cyan)
      - 1-3: `"text-blue-600 bg-blue-50"` (blue, not red)
    - **getCategoryLabel helper**: Maps camelCase keys to display names: functionality -> "Functionality", quality -> "Quality", security -> "Security", clarity -> "Clarity", completeness -> "Completeness", reusability -> "Reusability"
    - **Props:** `{ categories: ReviewCategories; summary: string; reviewedAt: Date; modelName: string }`
    - **Layout:**
      - "AI Review" badge at top (small pill/badge, e.g., `bg-blue-100 text-blue-700 text-xs font-medium px-2 py-0.5 rounded-full`)
      - Summary text below the badge in a subtle blockquote or card style
      - Six category score cards in a 2-column grid (sm:grid-cols-2, gap-3):
        - Each card: category name (label), score as large number with color background (use getScoreColor), 1-2 suggestion bullets below
        - Score displayed as e.g., "8/10" with the colored background pill
        - Suggestions as a small bulleted list below the score
      - Footer: "Reviewed [date] using [modelName]" in muted text (text-xs text-gray-400)
  </action>
  <verify>
    Run `pnpm build --filter web` to verify the component compiles. Check that the `ReviewCategories` import resolves.
  </verify>
  <done>
    - AiReviewDisplay renders six category scores with blue/green color palette, suggestions, summary, and "AI Review" badge
    - Component compiles without TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AI review tab component</name>
  <files>apps/web/components/ai-review-tab.tsx</files>
  <action>
    Create `apps/web/components/ai-review-tab.tsx`:

    A "use client" component that manages the review trigger, loading state, and visibility toggle.

    - **"use client"** directive
    - Import `useActionState` from "react", `requestAiReview` and `toggleAiReviewVisibility` from `@/app/actions/ai-review`
    - Import `AiReviewDisplay` from `./ai-review-display`
    - Import `ReviewCategories` type from `@everyskill/db/schema`

    - **Props:**
      - `skillId: string`
      - `isAuthor: boolean` -- whether current user is the skill author
      - `existingReview: { categories: ReviewCategories; summary: string; createdAt: Date; modelName: string; isVisible: boolean; reviewedContentHash: string } | null`
      - `currentContentHash: string` -- hash of current skill content
      - `skillSlug: string`

    - **State management:**
      - `useActionState(requestAiReview, { })` for the review trigger form
      - `useActionState(toggleAiReviewVisibility, { })` for the visibility toggle form
      - Derive `contentChanged = !existingReview || existingReview.reviewedContentHash !== currentContentHash`
      - Derive `canRequestReview = isAuthor && contentChanged`

    - **Layout:**
      - If existingReview exists AND (existingReview.isVisible OR isAuthor):
        - Render `<AiReviewDisplay>` with the review data
        - If isAuthor: show visibility toggle below the review (a small form with hidden skillId input, hidden isVisible input toggling the current value, and a button "Hide Review" / "Show Review")
        - If isAuthor AND contentChanged: show "Content has changed. Get a new review?" with a re-review button
      - If no existingReview:
        - If isAuthor: show "Get AI Review" button (form with hidden skillId input)
        - If not author: show "No AI review yet" placeholder text
      - **Loading state:** When the form action is pending (use the `isPending` from useActionState or check formAction pending state), replace the button text with a spinner SVG + "Generating review..." text. Disable the button.
      - **Error state:** If state.error, show error message in a subtle alert (text-amber-600 bg-amber-50 rounded p-3). Note: amber/orange for errors to maintain blue/green visual consistency across the review UI -- the "no red" palette applies broadly here.
      - **Button styling:** Blue-themed button (bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2). Disabled state: bg-gray-300 cursor-not-allowed
      - If isAuthor is false and no review exists: show muted text "No AI review available yet."
      - If isAuthor is false and review exists but isVisible is false: show muted text "AI review has been hidden by the author."

    **Spinner SVG for loading state:**
    Use a simple animated spinner: `<svg className="animate-spin h-4 w-4" ...>` (standard Tailwind spinner pattern).
  </action>
  <verify>
    Run `pnpm build --filter web` to verify the component compiles. Check that all imports resolve.
  </verify>
  <done>
    - AiReviewTab handles review trigger (author only), loading spinner, error states, visibility toggle, and content-change detection
    - Component compiles without TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate AI review tab into skill detail page</name>
  <files>
    apps/web/components/skill-detail-tabs.tsx
    apps/web/app/(protected)/skills/[slug]/page.tsx
  </files>
  <action>
    Modify the skill detail page to add a tabbed layout with "Details" and "AI Review" tabs.

    1. **Add data fetching** (in the existing parallel Promise.all or separately):
       - Import `getSkillReview` from `@everyskill/db/services`
       - Import `hashContent` from `@/lib/content-hash`
       - Fetch `existingReview = await getSkillReview(skill.id)` (add to Promise.all)
       - Compute `currentContentHash = await hashContent(skill.content)` (add to Promise.all)
       - Determine `isAuthor = session?.user?.id === skill.authorId`

    2. **Add tab layout** wrapping the existing content:
       - Create a client-side tab container directly in the page or as a small inline component
       - Two tabs: "Details" (default active) and "AI Review"
       - Per CONTEXT: tab label is just "AI Review" with no score indicator or badge
       - Tab switching uses client state (useState)
       - The tab container should be a "use client" wrapper component. You can either:
         (a) Create a small `SkillDetailTabs` component inline, OR
         (b) Create it in a separate file `apps/web/components/skill-detail-tabs.tsx`
       - Choose option (b) to keep the page clean. The tab component receives `detailsContent` (ReactNode) and `aiReviewContent` (ReactNode) as props.

    3. **Wire the content:**
       - "Details" tab: Contains the existing SkillDetail component, SimilarSkillsSection, RatingForm, and ReviewsList -- everything currently rendered
       - "AI Review" tab: Contains `<AiReviewTab skillId={skill.id} isAuthor={isAuthor} existingReview={existingReview} currentContentHash={currentContentHash} skillSlug={skill.slug} />`
       - The tab bar should sit between the back-button/search row and the main content area

    4. **Handle review data shape:**
       - The `existingReview` from `getSkillReview` returns the full SkillReview row. Map it to the props shape expected by AiReviewTab: `{ categories, summary, createdAt, modelName, isVisible, reviewedContentHash }`

    **Important:** Keep the existing page structure intact. The tab layout wraps the existing content -- do NOT remove or reorganize any existing sections. The "Details" tab should render exactly what the page currently shows.

    **If you create `apps/web/components/skill-detail-tabs.tsx`:**
    - "use client" directive
    - Props: `{ children: ReactNode; aiReviewContent: ReactNode }` (children = details tab content)
    - Uses useState for active tab
    - Proper ARIA: role="tablist", role="tab", aria-selected, role="tabpanel"
    - Tab styling: border-b with active indicator (border-blue-600)
  </action>
  <verify>
    Run `pnpm build --filter web` to verify the page compiles. Start the dev server (`pnpm dev --filter web`) and navigate to a skill detail page to confirm:
    1. Two tabs ("Details" and "AI Review") appear
    2. "Details" tab shows existing content (unchanged)
    3. "AI Review" tab shows trigger button (if author) or placeholder
    4. Tab switching works
  </verify>
  <done>
    - Skill detail page has a tabbed layout with "Details" and "AI Review" tabs
    - Existing page content is preserved under "Details" tab
    - AI Review tab shows AiReviewTab component with correct props
    - Tab switching works with proper ARIA attributes
    - Page compiles and renders without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete AI review pipeline: database schema, Claude API integration with structured output, server actions for triggering/toggling reviews, tabbed UI on skill detail page with score display, loading states, and visibility controls.</what-built>
  <how-to-verify>
    1. Navigate to a skill detail page where you are the author
    2. Verify two tabs appear: "Details" and "AI Review"
    3. Click "AI Review" tab -- should see "Get AI Review" button
    4. Click the button -- should see loading spinner
    5. After review completes, verify:
       - Six category scores display with blue/green colors (no red)
       - Each category has 1-2 suggestions
       - Summary text appears
       - "AI Review" badge is visible
       - "Hide Review" toggle is available (as author)
    6. Navigate away and return -- review should still be visible (persisted)
    7. Click "Hide Review" -- toggle should work
    8. View the same skill while NOT logged in as author -- review should be hidden
    9. Edit the skill content, return to AI Review tab -- "Get new review" option should appear
    10. Switch to "Details" tab -- all existing content (stats, description, content, ratings, similar skills) should be unchanged
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the review display, flow, or styling</resume-signal>
</task>

</tasks>

<verification>
- `pnpm build --filter web` succeeds
- Skill detail page renders two tabs with correct switching
- AI review trigger works for authors only
- Review scores display with correct blue/green color palette
- Review persists across page loads
- Visibility toggle works
- Content change detection enables re-review
</verification>

<success_criteria>
- Author can trigger AI review from dedicated tab on skill detail page (REV-01)
- Review displays six category scores (1-10) with suggestions and summary (REV-02)
- Review is persisted in database and visible on subsequent visits (REV-03)
- Review marked with "AI Review" badge, advisory only, no impact on quality tiers
- Blue/green color palette (no red) per CONTEXT decisions
- Existing skill detail page content unchanged under "Details" tab
</success_criteria>

<output>
After completion, create `.planning/phases/17-ai-review-pipeline/17-03-SUMMARY.md`
</output>
