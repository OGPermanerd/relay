---
phase: 14-mobile-accessibility-polish
plan: 05
type: execute
wave: 2
depends_on: ["14-01", "14-02"]
files_modified:
  - package.json
  - pnpm-lock.yaml
  - apps/web/components/skills-table.tsx
  - apps/web/components/skills-table-row.tsx
  - apps/web/hooks/use-expanded-rows.ts
  - apps/web/components/skill-accordion-content.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate table rows using keyboard (Tab to enter, Arrow keys to move)"
    - "Enter key on focused row navigates to skill detail page"
    - "Focusing a row expands its accordion"
    - "Accordion rows have aria-expanded and aria-controls attributes"
    - "Swipe left/right on mobile copies MCP config without expanding"
  artifacts:
    - path: "apps/web/components/skills-table.tsx"
      provides: "Keyboard-navigable table with roving tabindex"
      contains: "useRovingTabindex"
    - path: "apps/web/components/skills-table-row.tsx"
      provides: "Row with ARIA attributes and swipe gestures"
      contains: "aria-expanded"
    - path: "apps/web/hooks/use-expanded-rows.ts"
      provides: "Focus-triggered expand/collapse"
      exports: ["useExpandedRows"]
  key_links:
    - from: "skills-table.tsx"
      to: "use-roving-tabindex.ts"
      via: "import hook"
      pattern: "useRovingTabindex"
    - from: "skills-table-row.tsx"
      to: "skill-accordion-content.tsx"
      via: "aria-controls references id"
      pattern: "accordion-"
    - from: "skills-table-row.tsx"
      to: "react-swipeable"
      via: "useSwipeable hook"
      pattern: "useSwipeable"
---

<objective>
Integrate keyboard navigation, ARIA attributes, and swipe gestures into the skills table for full accessibility and mobile touch support.

Purpose: Satisfies A11Y-01 (keyboard navigation), A11Y-02 (accordion ARIA), and mobile swipe-to-install
Output: Fully accessible, keyboard-navigable, swipeable skills table
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-mobile-accessibility-polish/14-CONTEXT.md
@.planning/phases/14-mobile-accessibility-polish/14-RESEARCH.md
@.planning/phases/14-mobile-accessibility-polish/14-02-SUMMARY.md
@apps/web/components/skills-table.tsx
@apps/web/components/skills-table-row.tsx
@apps/web/hooks/use-expanded-rows.ts
@apps/web/components/skill-accordion-content.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-swipeable</name>
  <files>package.json, pnpm-lock.yaml</files>
  <action>
Install react-swipeable v7.0.2 for touch gesture handling.

Run:
```bash
cd /home/claude/projects/relay && pnpm add react-swipeable@^7.0.2 --filter web
```

This adds the dependency to the apps/web package.json. The library provides a hook-based API for swipe detection with configurable thresholds and passive event listeners.
  </action>
  <verify>
Check package.json: `grep -n "react-swipeable" apps/web/package.json`
Check it's installed: `ls node_modules/react-swipeable 2>/dev/null || pnpm list react-swipeable --filter web`
  </verify>
  <done>
react-swipeable v7.x is installed in the web app.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update useExpandedRows for focus-triggered expansion</name>
  <files>apps/web/hooks/use-expanded-rows.ts</files>
  <action>
Extend useExpandedRows to support focus-triggered expand and blur-triggered collapse.

Update the hook to add expandRow and collapseRow functions:

```typescript
"use client";

import { useState, useCallback } from "react";

export function useExpandedRows() {
  const [expandedIds, setExpandedIds] = useState<Set<string>>(new Set());

  const toggleRow = useCallback((skillId: string) => {
    setExpandedIds((prev) => {
      const next = new Set(prev);
      if (next.has(skillId)) {
        next.delete(skillId);
      } else {
        next.add(skillId);
      }
      return next;
    });
  }, []);

  const expandRow = useCallback((skillId: string) => {
    setExpandedIds((prev) => {
      if (prev.has(skillId)) return prev;
      const next = new Set(prev);
      next.add(skillId);
      return next;
    });
  }, []);

  const collapseRow = useCallback((skillId: string) => {
    setExpandedIds((prev) => {
      if (!prev.has(skillId)) return prev;
      const next = new Set(prev);
      next.delete(skillId);
      return next;
    });
  }, []);

  const isExpanded = useCallback(
    (skillId: string) => expandedIds.has(skillId),
    [expandedIds]
  );

  return { toggleRow, expandRow, collapseRow, isExpanded };
}
```

The new functions:
- `expandRow`: Only adds to set if not already present (no-op if expanded)
- `collapseRow`: Only removes from set if present (no-op if collapsed)

These enable the focus-to-expand, blur-to-collapse behavior without toggling.
  </action>
  <verify>
Grep for expandRow: `grep -n "expandRow\|collapseRow" apps/web/hooks/use-expanded-rows.ts`
TypeScript compiles: `cd /home/claude/projects/relay && pnpm exec tsc --noEmit`
  </verify>
  <done>
useExpandedRows provides expandRow and collapseRow functions for focus-triggered behavior.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add keyboard navigation and ARIA to SkillsTable</name>
  <files>apps/web/components/skills-table.tsx</files>
  <action>
Integrate roving tabindex for keyboard navigation and pass focus handlers to rows.

1. Add imports:
```typescript
import { useMemo, useEffect, useRef, useCallback } from "react";
import { useRouter } from "next/navigation";
import { useRovingTabindex } from "@/hooks/use-roving-tabindex";
```

2. Update destructuring from useExpandedRows to include new functions:
```typescript
const { toggleRow, expandRow, collapseRow, isExpanded } = useExpandedRows();
```

3. Add router for Enter key navigation:
```typescript
const router = useRouter();
```

4. Add roving tabindex hook:
```typescript
const handleRowFocus = useCallback(
  (rowIndex: number) => {
    const skill = sortedSkills[rowIndex];
    if (skill) {
      expandRow(skill.id);
    }
  },
  [sortedSkills, expandRow]
);

const {
  getTabIndex,
  handleKeyDown: handleGridKeyDown,
  registerCell,
  setActiveCell,
} = useRovingTabindex({
  rowCount: sortedSkills.length,
  colCount: 1, // Treat each row as single focusable unit
  onFocusChange: handleRowFocus,
});
```

5. Add Enter key handler:
```typescript
const handleRowKeyDown = useCallback(
  (e: React.KeyboardEvent, skill: SkillTableRow) => {
    // Let roving tabindex handle arrow keys
    handleGridKeyDown(e);

    // Enter navigates to skill detail
    if (e.key === "Enter") {
      e.preventDefault();
      router.push(`/skills/${skill.slug}`);
    }
  },
  [handleGridKeyDown, router]
);
```

6. Add role="grid" to table and update row rendering to pass new props:
```tsx
<table className="min-w-full divide-y divide-gray-200" role="grid">
  {/* thead unchanged */}
  <tbody className="divide-y divide-gray-200 bg-white" role="rowgroup">
    {sortedSkills.map((skill, index) => (
      <SkillsTableRow
        key={skill.id}
        skill={skill}
        trend={usageTrends.get(skill.id) || []}
        isExpanded={isExpanded(skill.id)}
        onToggle={() => toggleRow(skill.id)}
        onCollapse={() => collapseRow(skill.id)}
        isCopied={isCopied(skill.id)}
        onInstall={() => copyToClipboard(skill.id, generateMcpConfig(skill))}
        rowIndex={index}
        tabIndex={getTabIndex(index, 0)}
        onKeyDown={(e) => handleRowKeyDown(e, skill)}
        registerRef={(el) => registerCell(index, 0, el)}
      />
    ))}
  </tbody>
</table>
```

The keyboard behavior:
- Tab into table focuses first row
- Arrow Up/Down moves between rows
- Focus on row expands its accordion
- Enter navigates to skill detail page
- Tab out exits table (single tab stop)
  </action>
  <verify>
Grep for useRovingTabindex: `grep -n "useRovingTabindex" apps/web/components/skills-table.tsx`
Grep for role="grid": `grep -n 'role="grid"' apps/web/components/skills-table.tsx`
Grep for handleRowKeyDown: `grep -n "handleRowKeyDown" apps/web/components/skills-table.tsx`
TypeScript compiles: `cd /home/claude/projects/relay && pnpm exec tsc --noEmit`
  </verify>
  <done>
SkillsTable has keyboard navigation via roving tabindex, Enter to navigate, focus-to-expand behavior.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add ARIA attributes and swipe gestures to SkillsTableRow</name>
  <files>apps/web/components/skills-table-row.tsx, apps/web/components/skill-accordion-content.tsx</files>
  <action>
Add ARIA attributes for accordion accessibility and swipe gesture support.

**SkillsTableRow updates:**

1. Add imports:
```typescript
import { useRef, FocusEvent } from "react";
import { useSwipeable } from "react-swipeable";
```

2. Update interface:
```typescript
interface SkillsTableRowProps {
  skill: SkillTableRow & {
    description: string;
    category: string;
    tags?: string[] | null;
  };
  trend: number[];
  isExpanded: boolean;
  onToggle: () => void;
  onCollapse: () => void;  // NEW
  isCopied: boolean;
  onInstall: () => void;
  rowIndex: number;
  tabIndex: 0 | -1;  // NEW
  onKeyDown: (e: React.KeyboardEvent) => void;  // NEW
  registerRef: (el: HTMLTableRowElement | null) => void;  // NEW
}
```

3. Add swipe handlers:
```typescript
const swipeHandlers = useSwipeable({
  onSwipedLeft: () => onInstall(),
  onSwipedRight: () => onInstall(),
  delta: 80, // 80px threshold for install action
  trackTouch: true,
  trackMouse: false,
  preventScrollOnSwipe: true,
});
```

4. Add blur handler for collapse-on-focus-leave:
```typescript
const handleBlur = (e: FocusEvent<HTMLTableRowElement>) => {
  // Check if focus is moving outside this row and its accordion content
  const accordionId = `accordion-${skill.id}`;
  const accordion = document.getElementById(accordionId);

  // If focus is moving to the accordion content, don't collapse
  if (accordion?.contains(e.relatedTarget as Node)) {
    return;
  }

  // If focus is staying in the current row, don't collapse
  if (e.currentTarget.contains(e.relatedTarget as Node)) {
    return;
  }

  onCollapse();
};
```

5. Update the main `<tr>` element:
```tsx
<tr
  ref={registerRef}
  tabIndex={tabIndex}
  role="row"
  aria-expanded={isExpanded}
  aria-controls={`accordion-${skill.id}`}
  onClick={onToggle}
  onKeyDown={onKeyDown}
  onBlur={handleBlur}
  className={`${rowBg} ${expandedStyles} cursor-pointer transition-colors hover:bg-blue-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-inset`}
  {...swipeHandlers}
>
```

6. The skill name link should keep stopPropagation but also add aria-label:
```tsx
<Link
  href={`/skills/${skill.slug}`}
  className="text-sm font-medium text-gray-900 hover:text-blue-600"
  onClick={(e) => e.stopPropagation()}
  aria-label={`View details for ${skill.name}`}
>
  {skill.name}
</Link>
```

**SkillAccordionContent updates:**

Add id attribute for aria-controls linkage:

```tsx
// In skill-accordion-content.tsx, update the wrapper tr:
<tr
  id={`accordion-${skill.id}`}
  className="bg-blue-50"
  role="row"
>
```

The `id` matches the `aria-controls` on the parent row.
  </action>
  <verify>
Grep for aria-expanded: `grep -n "aria-expanded" apps/web/components/skills-table-row.tsx`
Grep for aria-controls: `grep -n "aria-controls" apps/web/components/skills-table-row.tsx`
Grep for useSwipeable: `grep -n "useSwipeable" apps/web/components/skills-table-row.tsx`
Grep for id in accordion: `grep -n 'id=.*accordion' apps/web/components/skill-accordion-content.tsx`
TypeScript compiles: `cd /home/claude/projects/relay && pnpm exec tsc --noEmit`
  </verify>
  <done>
SkillsTableRow has ARIA attributes (aria-expanded, aria-controls), focus ring, blur-to-collapse, and swipe-to-install gesture.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm exec tsc --noEmit` passes
2. Tab into table focuses first row with visible focus ring
3. Arrow Up/Down moves between rows
4. Focusing a row expands its accordion
5. Leaving focus collapses the row (unless focus moved to accordion content)
6. Enter on focused row navigates to skill detail page
7. aria-expanded and aria-controls are present and correctly linked
8. Swipe left/right on mobile triggers install action
</verification>

<success_criteria>
- react-swipeable installed
- Keyboard navigation works (Arrow keys, Enter, Tab)
- Focus on row expands accordion
- Blur from row collapses accordion (unless focus in accordion)
- aria-expanded on rows, aria-controls linking to accordion id
- Swipe gesture triggers install on mobile
- Focus ring visible (ring-2 ring-blue-500)
</success_criteria>

<output>
After completion, create `.planning/phases/14-mobile-accessibility-polish/14-05-SUMMARY.md`
</output>
