---
phase: 29-tenant-scoped-analytics-mcp
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/analytics-queries.ts
  - apps/web/app/(protected)/analytics/page.tsx
  - apps/web/app/actions/export-analytics.ts
  - apps/web/app/actions/get-employee-activity.ts
  - apps/web/app/actions/get-skill-trend.ts
autonomous: true

must_haves:
  truths:
    - "All 6 analytics query functions filter by tenantId instead of email domain matching"
    - "Analytics page passes session.user.tenantId to all query functions"
    - "Server actions pass tenantId for defense-in-depth on drill-down queries"
    - "No email domain subquery patterns remain in analytics-queries.ts"
  artifacts:
    - path: "apps/web/lib/analytics-queries.ts"
      provides: "Tenant-scoped analytics queries"
      contains: "tenantId: string"
    - path: "apps/web/app/(protected)/analytics/page.tsx"
      provides: "Tenant-aware analytics page"
      contains: "session.user.tenantId"
  key_links:
    - from: "apps/web/app/(protected)/analytics/page.tsx"
      to: "apps/web/lib/analytics-queries.ts"
      via: "tenantId parameter"
      pattern: "getOverviewStats\\(tenantId"
    - from: "apps/web/app/actions/export-analytics.ts"
      to: "apps/web/lib/analytics-queries.ts"
      via: "tenantId parameter"
      pattern: "getExportData\\(.*tenantId"
---

<objective>
Convert all 6 analytics query functions from email-domain matching to direct tenant_id filtering, and update all 4 callers to pass session.user.tenantId instead of session.user.id.

Purpose: Eliminate cross-tenant data leakage in analytics dashboards (TENANT-12)
Output: Tenant-isolated analytics queries with no email domain subquery patterns remaining
</objective>

<execution_context>
@/home/dev/.claude/agents/gsd-planner.md
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@apps/web/lib/analytics-queries.ts
@apps/web/app/(protected)/analytics/page.tsx
@apps/web/app/actions/export-analytics.ts
@apps/web/app/actions/get-employee-activity.ts
@apps/web/app/actions/get-skill-trend.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate all 6 analytics query functions to tenant_id filtering</name>
  <files>apps/web/lib/analytics-queries.ts</files>
  <action>
Change ALL 6 query function signatures from `orgId: string` to `tenantId: string`. Replace every email-domain subquery pattern with direct `tenant_id` filtering. Specific changes per function:

1. **getOverviewStats(tenantId, startDate)** — 3 replacements:
   - Main WHERE: Replace `u.email LIKE '%@' || (SELECT split_part(u6.email, '@', 2) FROM users u6 WHERE u6.id = ${orgId} LIMIT 1)` with `ue.tenant_id = ${tenantId}`
   - most_used_skill subquery: Replace `u2.email LIKE '%@' || (SELECT split_part(u3.email, '@', 2) FROM users u3 WHERE u3.id = ${orgId} LIMIT 1)` with `ue2.tenant_id = ${tenantId}`
   - highest_saver subquery: Replace `u4.email LIKE '%@' || (SELECT split_part(u5.email, '@', 2) FROM users u5 WHERE u5.id = ${orgId} LIMIT 1)` with `ue3.tenant_id = ${tenantId}`
   - Keep `ue.user_id IS NOT NULL` checks. Remove unnecessary `LEFT JOIN users u` from subqueries where only tenant_id filtering is needed (but keep user joins where we SELECT user fields).

2. **getUsageTrend(tenantId, startDate, granularity)** — 1 replacement:
   - Replace the `u.email LIKE ...` with `ue.tenant_id = ${tenantId}`. Remove the `LEFT JOIN users u ON u.id = ue.user_id` since we no longer need users table for filtering.

3. **getEmployeeUsage(tenantId, startDate)** — 1 replacement:
   - Replace `u.email LIKE '%@' || (SELECT split_part(u2.email, '@', 2) FROM users u2 WHERE u2.id = ${orgId} LIMIT 1)` with `u.tenant_id = ${tenantId}` (filter on users table since we GROUP BY user).

4. **getSkillUsage(tenantId, startDate)** — 2 replacements:
   - Main query: Replace `u.email LIKE ...` with `ue.tenant_id = ${tenantId}`. Remove `LEFT JOIN users u ON u.id = ue.user_id` if only used for domain filtering.
   - Breakdown query: Replace `u.email LIKE ...` with `ue.tenant_id = ${tenantId}`.

5. **getExportData(tenantId, startDate)** — 1 replacement:
   - Replace `u.email LIKE ...` with `ue.tenant_id = ${tenantId}`.

6. **getEmployeeActivity(tenantId, userId, startDate)** — Add tenantId param for defense-in-depth:
   - Add `tenantId: string` as first parameter.
   - Add `AND ue.tenant_id = ${tenantId}` to the existing WHERE clause (keeps userId filter too).

7. **getSkillTrend(tenantId, skillId, startDate, granularity)** — Add tenantId param for defense-in-depth:
   - Add `tenantId: string` as first parameter.
   - Add `AND ue.tenant_id = ${tenantId}` to the existing WHERE clause (keeps skillId filter too).

Update JSDoc comments to reference tenantId instead of orgId. Do NOT change query structure, COALESCE chains, JOIN logic, or result mapping — only change WHERE clauses and parameter signatures.

Anti-patterns to avoid:
- Don't use withTenant() — these are raw SQL queries with explicit WHERE clauses
- Don't restructure queries — only change filters and param names
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json 2>&1 | head -30` to check for type errors. Grep for any remaining email domain patterns: `grep -n "split_part.*email" apps/web/lib/analytics-queries.ts` should return zero results.</verify>
  <done>All 6 query functions accept tenantId, zero email-domain subquery patterns remain in analytics-queries.ts, all queries filter by tenant_id column</done>
</task>

<task type="auto">
  <name>Task 2: Update all analytics callers to pass tenantId</name>
  <files>
    apps/web/app/(protected)/analytics/page.tsx
    apps/web/app/actions/export-analytics.ts
    apps/web/app/actions/get-employee-activity.ts
    apps/web/app/actions/get-skill-trend.ts
  </files>
  <action>
Update all 4 callers that invoke analytics query functions:

1. **analytics/page.tsx** (line 31):
   - Replace `const orgId = session.user.id;` with:
     ```
     const tenantId = session.user.tenantId;
     if (!tenantId) redirect("/login");
     ```
   - Update all 4 Promise.all calls: `getOverviewStats(tenantId, startDate)`, `getUsageTrend(tenantId, startDate, granularity)`, `getEmployeeUsage(tenantId, startDate)`, `getSkillUsage(tenantId, startDate)`
   - Remove the comment about "orgId — query functions derive the email domain internally"

2. **export-analytics.ts** (line 24):
   - Replace `getExportData(session.user.id, startDate)` with:
     ```
     const tenantId = session.user.tenantId;
     if (!tenantId) throw new Error("Unauthorized");
     const data = await getExportData(tenantId, startDate);
     ```

3. **get-employee-activity.ts** (line 31):
   - Add tenantId guard: `const tenantId = session.user.tenantId; if (!tenantId) throw new Error("Unauthorized");`
   - Update call: `getEmployeeActivity(tenantId, userId, startDate)` (tenantId is now first param)

4. **get-skill-trend.ts** (line 27):
   - Add tenantId guard: `const tenantId = session.user.tenantId; if (!tenantId) throw new Error("Unauthorized");`
   - Update call: `getSkillTrend(tenantId, skillId, startDate, granularity)` (tenantId is now first param)
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json 2>&1 | head -30`. Grep for remaining orgId references: `grep -rn "orgId\|session.user.id" apps/web/app/\(protected\)/analytics/ apps/web/app/actions/export-analytics.ts apps/web/app/actions/get-employee-activity.ts apps/web/app/actions/get-skill-trend.ts` should return zero results.</verify>
  <done>All analytics callers pass session.user.tenantId with guard clauses, no orgId references remain in analytics entry points</done>
</task>

</tasks>

<verification>
1. `cd /home/dev/projects/relay && pnpm build` passes with no errors
2. `grep -rn "split_part.*email" apps/web/lib/analytics-queries.ts` returns zero matches
3. `grep -rn "orgId" apps/web/lib/analytics-queries.ts apps/web/app/\(protected\)/analytics/page.tsx apps/web/app/actions/export-analytics.ts apps/web/app/actions/get-employee-activity.ts apps/web/app/actions/get-skill-trend.ts` returns zero matches
4. `grep -c "tenant_id\|tenantId" apps/web/lib/analytics-queries.ts` returns 8+ matches (one per query function + defense-in-depth)
</verification>

<success_criteria>
- All 6 analytics query functions accept tenantId parameter and filter by tenant_id column
- Zero email-domain subquery patterns remain in the analytics codebase
- All 4 callers pass session.user.tenantId with null guard
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/29-tenant-scoped-analytics-mcp/29-01-SUMMARY.md`
</output>
