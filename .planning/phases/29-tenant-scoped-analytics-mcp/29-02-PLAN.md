---
phase: 29-tenant-scoped-analytics-mcp
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mcp/src/auth.ts
  - apps/mcp/src/tracking/events.ts
  - apps/mcp/src/tools/search.ts
  - apps/mcp/src/tools/list.ts
  - apps/mcp/src/tools/deploy.ts
  - packages/db/src/services/search-skills.ts
autonomous: true

must_haves:
  truths:
    - "MCP auth module caches tenantId alongside userId from validateApiKey"
    - "MCP tracking uses cached tenantId instead of hardcoded DEFAULT_TENANT_ID"
    - "MCP search, list, and deploy tools filter skills by tenant"
    - "Anonymous MCP users still see default-tenant skills (no breakage)"
  artifacts:
    - path: "apps/mcp/src/auth.ts"
      provides: "Tenant ID caching and getter"
      contains: "getTenantId"
    - path: "apps/mcp/src/tracking/events.ts"
      provides: "Tenant-aware usage tracking"
      contains: "getTenantId"
    - path: "packages/db/src/services/search-skills.ts"
      provides: "Tenant-filtered skill search"
      contains: "tenantId"
  key_links:
    - from: "apps/mcp/src/tools/list.ts"
      to: "apps/mcp/src/auth.ts"
      via: "getTenantId import"
      pattern: "getTenantId"
    - from: "apps/mcp/src/tracking/events.ts"
      to: "apps/mcp/src/auth.ts"
      via: "getTenantId import"
      pattern: "getTenantId"
    - from: "apps/mcp/src/tools/search.ts"
      to: "packages/db/src/services/search-skills.ts"
      via: "tenantId parameter"
      pattern: "tenantId"
---

<objective>
Add tenant scoping to the MCP server: cache tenantId in auth, use it in tracking events, and filter all 3 tool operations (search, list, deploy) to the authenticated user's tenant.

Purpose: Prevent cross-tenant data leakage via MCP tool operations (TENANT-13)
Output: Tenant-isolated MCP tools where each authenticated user sees only their tenant's skills
</objective>

<execution_context>
@/home/dev/.claude/agents/gsd-planner.md
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@apps/mcp/src/auth.ts
@apps/mcp/src/tracking/events.ts
@apps/mcp/src/tools/search.ts
@apps/mcp/src/tools/list.ts
@apps/mcp/src/tools/deploy.ts
@packages/db/src/services/search-skills.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tenantId caching to MCP auth and tracking</name>
  <files>
    apps/mcp/src/auth.ts
    apps/mcp/src/tracking/events.ts
  </files>
  <action>
**auth.ts changes:**
1. Add `let cachedTenantId: string | null = null;` alongside existing `cachedUserId`.
2. In `resolveUserId()`, after `cachedUserId = result.userId;`, add `cachedTenantId = result.tenantId;`
3. Add a new exported function:
   ```typescript
   export function getTenantId(): string | null {
     return cachedTenantId;
   }
   ```

**events.ts changes:**
1. Add import: `import { getTenantId } from "../auth.js";`
2. In `trackUsage()`, change the tenantId resolution from always using `DEFAULT_TENANT_ID` to:
   ```typescript
   const tenantId = event.tenantId || getTenantId() || DEFAULT_TENANT_ID;
   ```
   This uses: explicit event tenantId first, then cached auth tenantId, then fallback for anonymous.
3. Keep the DEFAULT_TENANT_ID constant as fallback for anonymous users.
4. Update the TODO comment to note this is now a fallback only for anonymous MCP usage.
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/mcp/tsconfig.json 2>&1 | head -20` to check types. Grep for the new export: `grep "getTenantId" apps/mcp/src/auth.ts` should show the function definition and export.</verify>
  <done>auth.ts exports getTenantId(), events.ts uses cached tenantId with DEFAULT_TENANT_ID as anonymous fallback only</done>
</task>

<task type="auto">
  <name>Task 2: Add tenant filtering to MCP tools and search service</name>
  <files>
    apps/mcp/src/tools/search.ts
    apps/mcp/src/tools/list.ts
    apps/mcp/src/tools/deploy.ts
    packages/db/src/services/search-skills.ts
  </files>
  <action>
**search-skills.ts (packages/db):**
1. Add optional `tenantId?: string` to the `SearchSkillsParams` interface.
2. In `searchSkillsByQuery()`, if `tenantId` is provided, add `eq(skills.tenantId, tenantId)` to the conditions array (alongside existing matchCondition and optional category filter).
3. Import `skills.tenantId` is already available from the skills schema.

**search.ts (MCP tool):**
1. Add import: `import { getTenantId } from "../auth.js";`
2. In `handleSearchSkills()`, get tenantId: `const tenantId = getTenantId();`
3. Pass tenantId to searchSkillsByQuery: `await searchSkillsByQuery({ query, category, limit, tenantId: tenantId ?? undefined })`

**list.ts (MCP tool):**
1. Add import: `import { getTenantId } from "../auth.js";`
2. Add import: `import { eq } from "drizzle-orm";` and `import { skills } from "@everyskill/db/schema/skills";`
3. In `handleListSkills()`, get tenantId: `const tenantId = getTenantId();`
4. Add `where` clause to `db.query.skills.findMany()`:
   ```typescript
   where: tenantId ? eq(skills.tenantId, tenantId) : undefined,
   ```
   When tenantId is null (anonymous), no filter is applied (keeps current behavior).

**deploy.ts (MCP tool):**
1. Add import: `import { getTenantId } from "../auth.js";`
2. Add import: `import { eq, and } from "drizzle-orm";` and `import { skills } from "@everyskill/db/schema/skills";`
3. In `handleDeploySkill()`, get tenantId: `const tenantId = getTenantId();`
4. Replace the current `db.query.skills.findMany()` + `.find()` pattern with a tenant-filtered query:
   ```typescript
   const allSkills = await db.query.skills.findMany({
     where: tenantId ? and(eq(skills.id, skillId), eq(skills.tenantId, tenantId)) : eq(skills.id, skillId),
   });
   const skill = allSkills[0];
   ```
   This prevents a user from deploying a skill from another tenant by guessing the ID.

For all 3 tools: when tenantId is null (anonymous/no API key), keep current behavior (no tenant filter) â€” anonymous users see default-tenant skills via RLS.
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/mcp/tsconfig.json 2>&1 | head -20`. Grep for tenant filtering: `grep -n "tenantId\|getTenantId" apps/mcp/src/tools/search.ts apps/mcp/src/tools/list.ts apps/mcp/src/tools/deploy.ts` should show tenant filtering in all 3 files.</verify>
  <done>All 3 MCP tools filter by tenantId when authenticated, search service accepts optional tenantId, anonymous users retain existing behavior</done>
</task>

</tasks>

<verification>
1. `cd /home/dev/projects/relay && pnpm build` passes with no errors
2. `grep -n "getTenantId" apps/mcp/src/auth.ts apps/mcp/src/tracking/events.ts apps/mcp/src/tools/search.ts apps/mcp/src/tools/list.ts apps/mcp/src/tools/deploy.ts` shows usage in all 5 files
3. `grep -n "tenantId" packages/db/src/services/search-skills.ts` shows optional tenantId parameter
4. The hardcoded DEFAULT_TENANT_ID in events.ts is now only used as fallback for anonymous users
</verification>

<success_criteria>
- MCP auth caches and exposes tenantId via getTenantId()
- MCP tracking uses cached tenantId (falls back to DEFAULT for anonymous)
- All 3 MCP tools (search, list, deploy) filter skills by tenantId when authenticated
- Anonymous users see default-tenant skills (no breakage)
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/29-tenant-scoped-analytics-mcp/29-02-SUMMARY.md`
</output>
