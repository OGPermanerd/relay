---
phase: 11-e2e-test-coverage
plan: 01
subsystem: testing
tags: [playwright, jwt, nextauth, e2e, authentication]

# Dependency graph
requires:
  - phase: 02-authentication
    provides: NextAuth JWT session strategy, authjs.session-token cookie
provides:
  - Playwright auth setup project for seeding test users
  - JWT session token generation for E2E tests
  - storageState file for authenticated test contexts
affects: [11-02, 11-03, 11-04]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Playwright setup project for authentication"
    - "Direct JWT encoding bypassing OAuth flow for E2E tests"
    - "storageState persistence between test runs"

key-files:
  created:
    - apps/web/tests/e2e/auth.setup.ts
    - apps/web/playwright/.auth/.gitkeep
    - apps/web/.gitignore
  modified:
    - apps/web/playwright.config.ts

key-decisions:
  - "Use @relay/db instead of direct postgres import for type safety"
  - "authjs.session-token cookie name matches NextAuth v5 development mode"
  - "24-hour JWT expiry for test session tokens"

patterns-established:
  - "E2E test user id: e2e-test-user, email: e2e-test@company.com"
  - "storageState path: playwright/.auth/user.json"
  - "Setup project runs before chromium tests via dependencies array"

# Metrics
duration: 6min
completed: 2026-01-31
---

# Phase 11 Plan 01: Playwright Auth Setup Summary

**Playwright authentication infrastructure with JWT session injection for authenticated E2E tests**

## Performance

- **Duration:** 6 min
- **Started:** 2026-01-31T23:43:44Z
- **Completed:** 2026-01-31T23:49:49Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments

- Created auth.setup.ts that seeds e2e-test-user to database and generates valid JWT
- Configured Playwright with setup project dependency and storageState
- Validated JWT generation and storageState file creation manually

## Task Commits

Each task was committed atomically:

1. **Task 1: Create auth.setup.ts with test user seeding and JWT session** - `a73ea9f` (feat)
2. **Task 2: Update playwright.config.ts with setup project** - `db16f4d` (feat)
3. **Task 3: Validate auth setup runs successfully** - `1007503` (fix - refactored to use @relay/db)

## Files Created/Modified

- `apps/web/tests/e2e/auth.setup.ts` - Seeds test user, encodes JWT, saves storageState
- `apps/web/playwright.config.ts` - Added setup project with storageState dependency
- `apps/web/playwright/.auth/.gitkeep` - Placeholder for auth state directory
- `apps/web/.gitignore` - Excludes playwright/.auth/ and test artifacts

## Decisions Made

1. **Use @relay/db instead of direct postgres import**
   - Original plan specified direct postgres/drizzle imports
   - apps/web doesn't have postgres as direct dependency
   - Using shared db client from @relay/db is cleaner and type-safe

2. **authjs.session-token cookie name**
   - NextAuth v5 uses "authjs.session-token" in development
   - Production may use different prefix, but tests run in dev mode

3. **24-hour JWT expiry**
   - Long enough for full test suite runs
   - Short enough to not persist between dev sessions

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Refactored imports to use @relay/db**
- **Found during:** Task 1 (TypeScript compilation)
- **Issue:** Plan specified `import postgres from 'postgres'` and `import { drizzle } from 'drizzle-orm/postgres-js'`, but these modules aren't dependencies of apps/web
- **Fix:** Changed to `import { db, users } from '@relay/db'` to use the existing shared database client
- **Files modified:** apps/web/tests/e2e/auth.setup.ts
- **Verification:** TypeScript compilation passes
- **Committed in:** 1007503 (Task 3 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Auto-fix necessary for TypeScript compilation. No scope creep.

## Issues Encountered

- **pnpm not available in execution environment:** Playwright webServer config uses pnpm but execution environment only has npm. Verified auth setup logic manually using node scripts instead of running full Playwright test.
- **Development server had stale .next cache:** Server returned 500 errors due to drizzle-orm version mismatch in cached chunks. This is a dev environment issue, not a code issue.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Auth setup infrastructure complete, ready for authenticated E2E tests
- storageState file can be generated by running `pnpm exec playwright test --project=setup`
- Chromium tests will automatically depend on setup and use authenticated context

---
*Phase: 11-e2e-test-coverage*
*Completed: 2026-01-31*
