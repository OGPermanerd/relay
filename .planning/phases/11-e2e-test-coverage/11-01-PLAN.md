---
phase: 11-e2e-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/tests/e2e/auth.setup.ts
  - apps/web/playwright.config.ts
  - apps/web/playwright/.auth/.gitkeep
  - apps/web/.gitignore
autonomous: true

must_haves:
  truths:
    - "Playwright can authenticate as a test user before running tests"
    - "Auth state is persisted in storageState file for reuse"
    - "Authenticated tests have access to protected routes"
  artifacts:
    - path: "apps/web/tests/e2e/auth.setup.ts"
      provides: "Authentication setup that seeds test user and creates valid session"
      min_lines: 40
    - path: "apps/web/playwright.config.ts"
      provides: "Playwright config with setup project and authenticated browser context"
      contains: "storageState"
  key_links:
    - from: "apps/web/playwright.config.ts"
      to: "apps/web/tests/e2e/auth.setup.ts"
      via: "setup project dependency"
      pattern: "dependencies.*setup"
    - from: "apps/web/tests/e2e/auth.setup.ts"
      to: "playwright/.auth/user.json"
      via: "storageState persistence"
      pattern: "storageState.*path"
---

<objective>
Set up Playwright authentication infrastructure for E2E tests

Purpose: Enable authenticated E2E tests by creating a test user and injecting a valid JWT session. This is the foundation for all authenticated flow tests (TEST-01 through TEST-04).

Output: auth.setup.ts that seeds test user and creates authenticated session, updated playwright.config.ts with setup project dependency
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@apps/web/playwright.config.ts
@apps/web/auth.ts
@apps/web/auth.config.ts
@packages/db/src/seed.ts
@packages/db/src/schema/users.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth.setup.ts with test user seeding and JWT session</name>
  <files>apps/web/tests/e2e/auth.setup.ts, apps/web/playwright/.auth/.gitkeep, apps/web/.gitignore</files>
  <action>
Create auth setup file that:

1. Seeds a test user in the database (reuse pattern from packages/db/src/seed.ts):
   - id: "e2e-test-user"
   - email: "e2e-test@company.com" (must match AUTH_ALLOWED_DOMAIN)
   - name: "E2E Test User"

2. Creates a valid JWT session token using NextAuth's encode function:
   - Import { encode } from "next-auth/jwt"
   - Use AUTH_SECRET from process.env
   - Token payload: { id: userId, email, name, sub: userId }
   - Set expiry to 24 hours from now

3. Stores session cookie in Playwright storageState:
   - Cookie name: "authjs.session-token" (or "next-auth.session-token" for production)
   - Cookie value: encoded JWT
   - Path: /
   - Domain: localhost
   - Save to playwright/.auth/user.json

4. Add to .gitignore:
   - playwright/.auth/

Note: The app uses JWT strategy (not database sessions), so we create the token directly rather than seeding the sessions table.

Key pattern from auth.ts:
```typescript
session: { strategy: "jwt" },
callbacks: {
  async jwt({ token, user }) {
    if (user) { token.id = user.id; }
    return token;
  },
  async session({ session, token }) {
    if (session.user && token.id) {
      session.user.id = token.id as string;
    }
    return session;
  },
}
```
  </action>
  <verify>
Run `cat apps/web/tests/e2e/auth.setup.ts` and verify:
- Imports encode from next-auth/jwt
- Seeds user to database
- Creates JWT with correct payload
- Saves storageState to playwright/.auth/user.json
  </verify>
  <done>auth.setup.ts exists with complete test user seeding and JWT session creation logic</done>
</task>

<task type="auto">
  <name>Task 2: Update playwright.config.ts with setup project</name>
  <files>apps/web/playwright.config.ts</files>
  <action>
Update Playwright config to:

1. Add setup project that runs auth.setup.ts:
```typescript
{
  name: 'setup',
  testMatch: /.*\.setup\.ts/,
},
```

2. Update chromium project to depend on setup and use storageState:
```typescript
{
  name: 'chromium',
  use: {
    ...devices['Desktop Chrome'],
    storageState: 'playwright/.auth/user.json',
  },
  dependencies: ['setup'],
},
```

3. Ensure testDir remains "./tests/e2e"

4. Add globalSetup to ensure test database is available (optional - skip if too complex)

Keep existing config (fullyParallel, retries, reporter, webServer).
  </action>
  <verify>
Run `cat apps/web/playwright.config.ts | grep -A5 "name: 'setup'" && cat apps/web/playwright.config.ts | grep "storageState"`
Verify setup project exists and storageState is configured.
  </verify>
  <done>playwright.config.ts has setup project, chromium depends on setup, storageState configured</done>
</task>

<task type="auto">
  <name>Task 3: Validate auth setup runs successfully</name>
  <files>-</files>
  <action>
Run auth setup in isolation to verify it works:

1. Ensure database is running: `docker compose up -d` (if not already)
2. Run just the setup: `cd apps/web && pnpm exec playwright test --project=setup`
3. Verify storageState file was created: `cat apps/web/playwright/.auth/user.json`
4. Check the file contains valid cookies and origin data

If setup fails:
- Check AUTH_SECRET is set in .env
- Check DATABASE_URL is correct
- Check test user email matches AUTH_ALLOWED_DOMAIN

Note: The webServer config will start the dev server automatically during test runs.
  </action>
  <verify>
Run `ls -la apps/web/playwright/.auth/` to confirm user.json exists.
Run `cat apps/web/playwright/.auth/user.json | head -20` to verify it contains cookies array with session token.
  </verify>
  <done>Auth setup runs and creates valid storageState file with session cookie</done>
</task>

</tasks>

<verification>
- [ ] auth.setup.ts creates test user and valid JWT session
- [ ] playwright.config.ts has setup project with dependency chain
- [ ] storageState file is created at playwright/.auth/user.json
- [ ] .gitignore includes playwright/.auth/
- [ ] Running `pnpm exec playwright test --project=setup` succeeds
</verification>

<success_criteria>
- Auth setup creates authenticated session for E2E tests
- Subsequent tests can access protected routes without manual login
- Auth state persists across test runs (regenerated fresh each run)
</success_criteria>

<output>
After completion, create `.planning/phases/11-e2e-test-coverage/11-01-SUMMARY.md`
</output>
