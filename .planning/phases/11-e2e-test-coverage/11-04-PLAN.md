---
phase: 11-e2e-test-coverage
plan: 04
type: execute
wave: 3
depends_on: [11-02, 11-03]
files_modified:
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "All E2E tests pass in CI pipeline"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI workflow with E2E test job"
      contains: "playwright"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "apps/web/playwright.config.ts"
      via: "pnpm exec playwright test command"
      pattern: "playwright test"
---

<objective>
Add E2E tests to CI pipeline

Purpose: Ensure all E2E tests run automatically on every PR/push, providing continuous validation of authenticated user flows.

Output: Updated CI workflow with Playwright E2E test job
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/11-e2e-test-coverage/11-02-SUMMARY.md
@.planning/phases/11-e2e-test-coverage/11-03-SUMMARY.md

@.github/workflows/ci.yml
@apps/web/playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Playwright E2E job to CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Add E2E test job to CI workflow. If .github/workflows/ci.yml doesn't exist, create it.

The job should:

1. Run on ubuntu-latest
2. Set up Node.js and pnpm
3. Start PostgreSQL service for database
4. Install dependencies
5. Run database migrations
6. Seed test data
7. Install Playwright browsers
8. Run Playwright tests
9. Upload test report artifacts on failure

```yaml
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: relay_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/relay_test
      AUTH_SECRET: test-secret-at-least-32-characters-long
      AUTH_ALLOWED_DOMAIN: company.com
      NEXT_PUBLIC_APP_URL: http://localhost:2000

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run database migrations
        run: pnpm --filter @relay/db db:push

      - name: Seed database
        run: pnpm --filter @relay/db db:seed

      - name: Build application
        run: pnpm --filter web build

      - name: Install Playwright browsers
        run: pnpm --filter web exec playwright install --with-deps chromium

      - name: Run E2E tests
        run: pnpm --filter web exec playwright test

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 7
```

Key configuration:
- postgres service matches DATABASE_URL
- AUTH_SECRET must be 32+ chars
- AUTH_ALLOWED_DOMAIN matches test user email
- Build before running tests (playwright.config uses `pnpm start` in CI)
- Upload report on failure for debugging
  </action>
  <verify>
Run `cat .github/workflows/ci.yml | grep -A3 "Run E2E"` to verify E2E test step exists.
Validate YAML syntax: `npx yaml-lint .github/workflows/ci.yml` or just check GitHub Actions syntax highlighting.
  </verify>
  <done>CI workflow has E2E test job with database service, migrations, and Playwright execution</done>
</task>

<task type="auto">
  <name>Task 2: Run full E2E test suite locally</name>
  <files>-</files>
  <action>
Run the complete E2E test suite to verify all tests pass:

1. Ensure database is running: `docker compose up -d`
2. Run all E2E tests: `cd apps/web && pnpm exec playwright test`
3. Check test results - all should pass

Expected tests:
- auth.setup.ts (setup project)
- home.spec.ts (existing basic tests)
- skill-upload.spec.ts (TEST-01)
- skill-rating.spec.ts (TEST-02)
- skill-search.spec.ts (TEST-03)
- profile.spec.ts (TEST-04)

If any tests fail:
- Review error output
- Check Playwright report: `pnpm exec playwright show-report`
- Fix failing tests in their respective spec files

Document test count and results.
  </action>
  <verify>
Run `cd apps/web && pnpm exec playwright test --reporter=list 2>&1 | tail -10`
Output should show "X passed" with 0 failures.
  </verify>
  <done>All E2E tests pass locally, test suite is complete and ready for CI</done>
</task>

</tasks>

<verification>
- [ ] .github/workflows/ci.yml has e2e job with all required steps
- [ ] CI job includes postgres service and proper env vars
- [ ] Full test suite passes locally
- [ ] Playwright report shows all tests passing
</verification>

<success_criteria>
- All E2E tests pass in CI pipeline (requirement TEST-01 through TEST-04)
- CI workflow is complete and will run on PR/push
- Test artifacts uploaded on failure for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/11-e2e-test-coverage/11-04-SUMMARY.md`
</output>
