---
phase: 72-community-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/skill-communities.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/relations/index.ts
  - packages/db/src/migrations/0040_create_skill_communities.sql
autonomous: true

must_haves:
  truths:
    - "skill_communities table exists in PostgreSQL with RLS enabled"
    - "Schema, relations, and types are importable from @everyskill/db barrel exports"
    - "graphology and graphology-communities-louvain packages are installed in packages/db"
  artifacts:
    - path: "packages/db/src/schema/skill-communities.ts"
      provides: "skillCommunities table definition with tenant_id, skill_id, community_id, modularity, detected_at"
      exports: ["skillCommunities", "SkillCommunity", "NewSkillCommunity"]
    - path: "packages/db/src/migrations/0040_create_skill_communities.sql"
      provides: "Migration with table, indexes, RLS policy"
      contains: "CREATE TABLE IF NOT EXISTS skill_communities"
  key_links:
    - from: "packages/db/src/schema/index.ts"
      to: "packages/db/src/schema/skill-communities.ts"
      via: "export * from"
      pattern: 'export.*skill-communities'
    - from: "packages/db/src/relations/index.ts"
      to: "packages/db/src/schema"
      via: "skillCommunities import and relations definition"
      pattern: "skillCommunitiesRelations"
---

<objective>
Create the skill_communities database foundation: schema, migration, relations, barrel exports, and install graphology packages.

Purpose: Provides the persistence layer for community detection results. All subsequent plans depend on this table existing.
Output: New table in PostgreSQL, Drizzle schema/types, graphology packages installed.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/72-community-detection/72-RESEARCH.md (Schema section, Migration SQL section)
@packages/db/src/schema/user-skill-views.ts (pattern reference for table definition with RLS)
@packages/db/src/schema/index.ts (barrel exports -- add new export)
@packages/db/src/relations/index.ts (relations -- add new relations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install graphology packages and create skill_communities schema + migration</name>
  <files>
    packages/db/src/schema/skill-communities.ts
    packages/db/src/schema/index.ts
    packages/db/src/relations/index.ts
    packages/db/src/migrations/0040_create_skill_communities.sql
    packages/db/package.json
  </files>
  <action>
    1. Install graphology packages:
       `cd /home/dev/projects/relay/packages/db && pnpm add graphology graphology-communities-louvain graphology-types`

    2. Create `packages/db/src/schema/skill-communities.ts` following the user-skill-views.ts pattern:
       - Table `skill_communities` with columns:
         - id: text PK with crypto.randomUUID default
         - tenant_id: text NOT NULL FK to tenants(id)
         - skill_id: text NOT NULL FK to skills(id) with onDelete cascade
         - community_id: integer NOT NULL (Louvain-assigned index)
         - community_label: text nullable (for future AI-generated labels)
         - modularity: real nullable (overall modularity for the detection run)
         - detected_at: timestamp with timezone, precision 3, NOT NULL, defaultNow
       - Indexes:
         - uniqueIndex on (tenant_id, skill_id) named "skill_communities_tenant_skill_unique"
         - index on (tenant_id) named "skill_communities_tenant_id_idx"
         - index on (tenant_id, community_id) named "skill_communities_community_idx"
       - RLS policy "tenant_isolation" matching the exact pattern from user-skill-views.ts (restrictive, for all, using/withCheck on current_setting)
       - Export types: SkillCommunity, NewSkillCommunity

    3. Add `export * from "./skill-communities";` to `packages/db/src/schema/index.ts`

    4. Add skillCommunities relations in `packages/db/src/relations/index.ts`:
       - Import `skillCommunities` from "../schema"
       - Add `skillCommunitiesRelations = relations(skillCommunities, ({ one }) => ({...}))`
         with: tenant (FK tenants), skill (FK skills)
       - Add `communities: many(skillCommunities)` to existing `skillsRelations`
       - Add `skillCommunities: many(skillCommunities)` to existing `tenantsRelations`

    5. Create migration `packages/db/src/migrations/0040_create_skill_communities.sql`:
       - CREATE TABLE IF NOT EXISTS skill_communities (all columns above)
       - CREATE UNIQUE INDEX, CREATE INDEX (all 3 indexes)
       - ALTER TABLE ... ENABLE ROW LEVEL SECURITY
       - CREATE POLICY tenant_isolation (restrictive, for all, using/withCheck on current_setting)
       - Use TIMESTAMPTZ(3) for detected_at

    6. Run the migration: `cd /home/dev/projects/relay && pnpm db:migrate`

    7. Verify typecheck: `cd /home/dev/projects/relay && pnpm turbo typecheck`
  </action>
  <verify>
    - `pnpm turbo typecheck` passes with no errors
    - `pnpm db:migrate` completes without errors
    - `psql` shows skill_communities table with RLS enabled:
      `psql -d everyskill -c "\d skill_communities"` shows all columns
      `psql -d everyskill -c "SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = 'skill_communities'"` shows rowsecurity=true
  </verify>
  <done>
    skill_communities table exists in PostgreSQL with correct schema, indexes, and RLS. Drizzle schema exports SkillCommunity/NewSkillCommunity types. Relations wired for skills and tenants. graphology + graphology-communities-louvain installed. Migration 0040 applied. Typecheck passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm turbo typecheck` passes
- Migration 0040 applied successfully
- `psql -d everyskill -c "\d skill_communities"` shows expected columns and indexes
- `node -e "import('graphology').then(m => console.log('graphology OK'))"` succeeds (or verify via pnpm list)
</verification>

<success_criteria>
- skill_communities table exists with all columns, indexes, and RLS policy
- Schema types (SkillCommunity, NewSkillCommunity) importable from @everyskill/db/schema
- Relations wired (skills -> communities, tenants -> skillCommunities)
- graphology + graphology-communities-louvain in packages/db dependencies
- Full typecheck passes
</success_criteria>

<output>
After completion, create `.planning/phases/72-community-detection/72-01-SUMMARY.md`
</output>
