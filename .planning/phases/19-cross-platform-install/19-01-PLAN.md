---
phase: 19-cross-platform-install
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/os-detection.ts
  - apps/web/lib/install-script.ts
  - apps/web/lib/mcp-config.ts
  - apps/web/components/platform-install-modal.tsx
autonomous: true

must_haves:
  truths:
    - "Platform selection modal shows 4 platform cards in a grid (Claude Chat, Claude Code, Other IDE, Other Systems)"
    - "Clicking a platform card reveals platform-specific JSON config with a copy button"
    - "User's OS is auto-detected and the matching platform card is pre-selected"
    - "User can download an install script appropriate for their detected OS"
    - "Modal stays open after copy or download so user can select another platform"
    - "Detected OS label is shown near top of modal"
  artifacts:
    - path: "apps/web/lib/os-detection.ts"
      provides: "OS detection utility"
      exports: ["detectOS", "DetectedOS"]
    - path: "apps/web/lib/install-script.ts"
      provides: "Install script generation and download"
      exports: ["generateInstallScript", "downloadScript"]
    - path: "apps/web/lib/mcp-config.ts"
      provides: "Platform-specific MCP config generation"
      exports: ["generatePlatformConfig", "getConfigFilePath"]
    - path: "apps/web/components/platform-install-modal.tsx"
      provides: "Platform selection modal component"
      exports: ["PlatformInstallModal"]
      min_lines: 100
  key_links:
    - from: "apps/web/components/platform-install-modal.tsx"
      to: "apps/web/lib/os-detection.ts"
      via: "useEffect calling detectOS on mount"
      pattern: "detectOS"
    - from: "apps/web/components/platform-install-modal.tsx"
      to: "apps/web/lib/mcp-config.ts"
      via: "generatePlatformConfig with window.location.origin"
      pattern: "generatePlatformConfig"
    - from: "apps/web/components/platform-install-modal.tsx"
      to: "apps/web/lib/install-script.ts"
      via: "downloadScript on button click"
      pattern: "downloadScript|generateInstallScript"
    - from: "apps/web/components/platform-install-modal.tsx"
      to: "apps/web/hooks/use-clipboard-copy.ts"
      via: "useClipboardCopy hook for copy feedback"
      pattern: "useClipboardCopy|copyToClipboard"
---

<objective>
Build the platform selection modal and all supporting utilities for cross-platform MCP install.

Purpose: This is the core deliverable of Phase 19 -- a modal that replaces the existing single-platform copy button with a multi-platform install experience. Users see 4 platform cards, get OS-auto-detected pre-selection, can copy platform-specific JSON config, and download install scripts.

Output: 3 utility modules (OS detection, install scripts, platform configs) and the PlatformInstallModal component, all ready for integration.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-cross-platform-install/19-RESEARCH.md
@apps/web/lib/mcp-config.ts
@apps/web/hooks/use-clipboard-copy.ts
@apps/web/components/fork-button.tsx
@apps/web/components/install-button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create utility modules (OS detection, platform configs, install scripts)</name>
  <files>
    apps/web/lib/os-detection.ts
    apps/web/lib/install-script.ts
    apps/web/lib/mcp-config.ts
  </files>
  <action>
Create three utility modules:

**1. `apps/web/lib/os-detection.ts`** -- OS detection utility.
- Export type `DetectedOS = "macos" | "windows" | "linux"`
- Export function `detectOS(): DetectedOS`
- Check `navigator.userAgentData?.platform` first (Chromium), fall back to `navigator.userAgent` string parsing
- Return `"macos"` as default when `navigator` is undefined (SSR) or OS cannot be detected
- IMPORTANT: This function must only be called inside `useEffect` to avoid SSR hydration mismatches. Add a JSDoc comment stating this.

**2. `apps/web/lib/mcp-config.ts`** -- Extend existing file with platform-specific config generation.
- Keep existing `generateMcpConfig` function unchanged (backward compat)
- Add type `Platform = "claude-chat" | "claude-code" | "other-ide" | "other-systems"`
- Add function `generatePlatformConfig(platform: Platform, origin: string): string` that returns JSON config as a formatted string
- Platform configs (all use `JSON.stringify(obj, null, 2)`):
  - **claude-chat** (treated as Claude Desktop per INST-02): stdio config with `npx -y @relay/mcp` command. This is the Claude Desktop app that uses `claude_desktop_config.json`.
  - **claude-code**: Same stdio config format, used in `~/.claude.json` or via `claude mcp add`
  - **other-ide** and **other-systems**: Generic MCP `mcpServers` JSON block with same stdio config
- All configs use the same structure: `{ mcpServers: { "relay-skills": { command: "npx", args: ["-y", "@relay/mcp"] } } }`
- Add function `getConfigFilePath(platform: Platform, os: DetectedOS): string` returning the config file path per platform+OS combo:
  - claude-chat + macos: `~/Library/Application Support/Claude/claude_desktop_config.json`
  - claude-chat + windows: `%APPDATA%\\Claude\\claude_desktop_config.json`
  - claude-chat + linux: `~/.config/Claude/claude_desktop_config.json`
  - claude-code: `~/.claude.json` (all OS)
  - other-ide/other-systems: Return generic text like "Your MCP client's config file"
- Add function `getConfigInstructions(platform: Platform): string` returning brief setup instruction text per platform:
  - claude-chat: "Add to your Claude Desktop config file, then restart Claude Desktop."
  - claude-code: "Add to ~/.claude.json or run: claude mcp add relay-skills -- npx -y @relay/mcp"
  - other-ide: "Add to your IDE's MCP configuration file."
  - other-systems: "Add to your MCP client's configuration."
- Export the `Platform` type.

**3. `apps/web/lib/install-script.ts`** -- Install script generation and client-side download.
- Export function `generateInstallScript(os: DetectedOS): { content: string; filename: string }`
  - For macos/linux: Generate a bash script (`install-relay-mcp.sh`) that:
    - Sets `set -e`
    - Determines config dir: macOS = `$HOME/Library/Application Support/Claude`, Linux = `$HOME/.config/Claude`
    - Creates dir with `mkdir -p`
    - Reads existing config or starts with `{}`
    - Uses `node -e` to JSON-merge `relay-skills` into `mcpServers` (preserves existing servers)
    - Prints success message with config path and "Restart Claude Desktop to activate"
  - For windows: Generate a PowerShell script (`install-relay-mcp.ps1`) that:
    - Sets `$ErrorActionPreference = "Stop"`
    - Config dir: `$env:APPDATA\Claude`
    - Creates dir if needed
    - Reads existing config or starts with `{}`
    - Uses `node -e` to JSON-merge same as bash
    - Prints success message
  - Use the exact script content from the RESEARCH.md code examples (verified patterns)
- Export function `downloadScript(content: string, filename: string): void`
  - Creates Blob with `application/octet-stream` type
  - Creates anchor element with `download` attribute
  - Triggers click, cleans up with `URL.revokeObjectURL`
- Export function `getRunInstructions(os: DetectedOS): string`
  - macos/linux: `chmod +x install-relay-mcp.sh && ./install-relay-mcp.sh`
  - windows: `powershell -ExecutionPolicy Bypass -File install-relay-mcp.ps1`
  </action>
  <verify>
Run `npx tsc --noEmit` from `apps/web/` to confirm all three files compile without type errors. Verify each file exports the expected functions by checking the compiled output.
  </verify>
  <done>
Three utility modules exist with correct types and exports. OS detection handles SSR safely. Platform config generates correct JSON for all 4 platforms. Install scripts for macOS/Linux (sh) and Windows (ps1) use safe JSON-merge via node. Download utility creates and triggers Blob download.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build PlatformInstallModal component</name>
  <files>
    apps/web/components/platform-install-modal.tsx
  </files>
  <action>
Create `apps/web/components/platform-install-modal.tsx` -- the main modal component.

**Component signature:**
```tsx
interface PlatformInstallModalProps {
  onClose: () => void;
}
export function PlatformInstallModal({ onClose }: PlatformInstallModalProps)
```

**Structure (follow the fork-button.tsx modal pattern exactly):**
- Outer div: `fixed inset-0 z-50 flex items-center justify-center bg-black/50` with `onClick={onClose}`
- Inner div: `mx-4 w-full max-w-2xl rounded-lg bg-white p-6 shadow-xl` with `onClick={(e) => e.stopPropagation()}`

**State:**
- `selectedPlatform: Platform | null` -- initially null, set when user clicks a card
- `detectedOS: DetectedOS` -- initialized to `"macos"`, updated in `useEffect` via `detectOS()`
- Use `useClipboardCopy` hook for copy feedback

**Layout (top to bottom):**

1. **Header row**: Title "Install Relay MCP Server" on left, close X button on right, detected OS label below title (e.g., "Detected: macOS" in small gray text). Only show detected OS label after `useEffect` has run (avoid hydration mismatch by using a `mounted` state flag).

2. **Platform cards grid**: 4 cards in a `grid grid-cols-2 gap-3` layout. Each card is a button with:
   - Icon/emoji (use simple unicode or SVG): Claude Chat = desktop monitor icon, Claude Code = terminal icon, Other IDE = code brackets icon, Other Systems = server/gear icon
   - Platform name in medium font
   - Brief description in small gray text:
     - Claude Chat: "Desktop app"
     - Claude Code: "CLI tool"
     - Other IDE: "Cursor, VS Code, etc."
     - Other Systems: "Any MCP client"
   - Styling: `rounded-lg border-2 p-4 text-left transition-colors`
   - Selected state: `border-blue-500 bg-blue-50`, unselected: `border-gray-200 hover:border-gray-300`
   - Auto-select the detected OS appropriate platform on mount: if macOS or linux detected, pre-select "claude-chat" (Claude Desktop); all OS: no change to default null until useEffect runs, then set based on OS

3. **Config section** (only shown when `selectedPlatform` is not null):
   - Config file path in small monospace gray text (from `getConfigFilePath`)
   - Setup instruction text (from `getConfigInstructions`)
   - JSON config in a `pre` block with `bg-gray-50 rounded-lg p-4 text-sm font-mono overflow-x-auto` styling
   - Config generated via `generatePlatformConfig(selectedPlatform, window.location.origin)`
   - **Copy Config button**: Blue button that calls `copyToClipboard("platform-config", configJson)`. Show "Copied!" with checkmark when `isCopied("platform-config")` is true (button turns green).
   - **Download Install Script button** (only for claude-chat platform, since that's the one with OS-specific config paths): Secondary outlined button. On click, calls `generateInstallScript(detectedOS)` then `downloadScript(content, filename)`. After download, show the run instructions from `getRunInstructions(detectedOS)` in a small code block below with its own copy button.
   - **Verification hint**: Small gray italic text at bottom, e.g., "After installing, restart your app and check for Relay in your MCP servers."

**Key implementation details:**
- "use client" directive at top
- Import `useClipboardCopy` from `@/hooks/use-clipboard-copy`
- Import `detectOS`, `DetectedOS` from `@/lib/os-detection`
- Import `generatePlatformConfig`, `getConfigFilePath`, `getConfigInstructions`, `Platform` from `@/lib/mcp-config`
- Import `generateInstallScript`, `downloadScript`, `getRunInstructions` from `@/lib/install-script`
- Use `useState` and `useEffect` from React
- `useEffect` on mount: call `detectOS()`, set `detectedOS` state, set `mounted` to true, pre-select `"claude-chat"` as default platform
- All button clicks inside the modal must call `e.stopPropagation()` to prevent modal close
- Modal must NOT close on copy or download -- only closes via backdrop click or X button
- Keep SVG icons inline (no external icon library) -- use simple Heroicons-style paths matching existing codebase patterns
  </action>
  <verify>
Run `npx tsc --noEmit` from `apps/web/` to confirm the component compiles. Run the dev server with `npm run dev` and manually verify the component can be imported (no runtime errors on import).
  </verify>
  <done>
PlatformInstallModal component renders a modal with 4 platform cards, shows OS detection label, displays platform-specific JSON config on card selection, has working copy button with "Copied!" feedback, has download script button for Claude Desktop platform, and stays open after all interactions. Component compiles without TypeScript errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in apps/web/ with zero errors
2. All 4 new/modified files exist with correct exports
3. `os-detection.ts` exports `detectOS` and `DetectedOS`
4. `mcp-config.ts` exports `generatePlatformConfig`, `getConfigFilePath`, `getConfigInstructions`, `Platform` (plus original `generateMcpConfig`)
5. `install-script.ts` exports `generateInstallScript`, `downloadScript`, `getRunInstructions`
6. `platform-install-modal.tsx` exports `PlatformInstallModal`
</verification>

<success_criteria>
- All utility functions produce correct output for each platform/OS combination
- Modal component follows established fork-button.tsx pattern (overlay, stopPropagation, white card)
- OS detection runs only client-side via useEffect (no SSR hydration risk)
- Config JSON uses `window.location.origin` dynamically (not hardcoded URLs)
- Install scripts safely merge into existing config (never overwrite)
- Copy button shows "Copied!" feedback using existing useClipboardCopy hook
- No new npm dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/19-cross-platform-install/19-01-SUMMARY.md`
</output>
