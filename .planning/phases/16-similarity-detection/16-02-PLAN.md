---
phase: 16-similarity-detection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/(protected)/skills/[slug]/page.tsx
  - apps/web/components/similar-skills-section.tsx
autonomous: true

must_haves:
  truths:
    - "Skill detail page shows Similar Skills section"
    - "Similar skills display with similarity percentages"
    - "Section gracefully handles skills with no similar matches"
  artifacts:
    - path: "apps/web/components/similar-skills-section.tsx"
      provides: "Similar Skills display component for detail page"
      exports: ["SimilarSkillsSection"]
    - path: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      provides: "Updated skill detail page with similar skills query"
  key_links:
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "@relay/db/services/skill-embeddings"
      via: "server-side query"
      pattern: "getSkillEmbedding|findSimilarSkills"
    - from: "apps/web/components/similar-skills-section.tsx"
      to: "/skills/[slug]"
      via: "Link component"
      pattern: "href.*skills"
---

<objective>
Add a "Similar Skills" section to the skill detail page.

Purpose: Help users discover related skills, increasing engagement and showcasing the breadth of the skill library. Similar skills are queried server-side using the existing embedding for the current skill.

Output: New section on skill detail page showing up to 5 similar skills with similarity percentages.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@apps/web/app/(protected)/skills/[slug]/page.tsx
@apps/web/components/skill-detail.tsx
@packages/db/src/services/skill-embeddings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SimilarSkillsSection component</name>
  <files>apps/web/components/similar-skills-section.tsx</files>
  <action>
Create a server component that displays similar skills on the detail page.

1. Create `apps/web/components/similar-skills-section.tsx`:
   - NO "use client" directive (server component for direct data access)
   - Props: `similarSkills: { skillId: string; skillName: string; skillSlug: string; similarity: number }[]`

2. UI structure:
   - Section header: "Similar Skills" with heading style matching other sections
   - If empty array: Don't render anything (no "no similar skills" message needed)
   - If has skills: Grid/list of skill cards

3. Each similar skill card shows:
   - Skill name as link to `/skills/{slug}`
   - Similarity badge: `{Math.round(similarity * 100)}% similar` (muted style, gray/blue pill)
   - Subtle hover effect

4. Styling:
   - Match existing section styles in skill-detail.tsx (mt-8, text-xl font-semibold for header)
   - Cards: rounded border, padding, hover:bg-gray-50 transition
   - Similarity badge: text-sm, rounded-full, bg-gray-100 text-gray-600
   - Responsive: stack on mobile, 2-3 columns on larger screens
  </action>
  <verify>
- File exists at `apps/web/components/similar-skills-section.tsx`
- TypeScript compiles: `cd apps/web && npx tsc --noEmit`
  </verify>
  <done>
- `SimilarSkillsSection` component exported
- Shows skill names with clickable links
- Shows similarity percentages
- Gracefully handles empty array (renders nothing)
- Styling matches existing detail page sections
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate similar skills into detail page</name>
  <files>apps/web/app/(protected)/skills/[slug]/page.tsx</files>
  <action>
Query similar skills server-side and display on the skill detail page.

1. Add imports to skill detail page:
   - Import `getSkillEmbedding` and `findSimilarSkills` from `@relay/db/services`
   - Import `SimilarSkillsSection` from `@/components/similar-skills-section`

2. Add similar skills query in the page component (after skill query succeeds):
   ```typescript
   // Query similar skills using the skill's embedding
   let similarSkills: SimilarSkillResult[] = [];
   try {
     const embedding = await getSkillEmbedding(skill.id);
     if (embedding?.embedding) {
       similarSkills = await findSimilarSkills(embedding.embedding, {
         threshold: 0.7,
         limit: 5,
         excludeSkillId: skill.id, // Don't show current skill as similar to itself
       });
     }
   } catch (error) {
     // Log but don't fail - similar skills is enhancement, not critical
     console.warn("Failed to fetch similar skills:", error);
   }
   ```

3. Add SimilarSkillsSection to the page JSX:
   - Place AFTER the SkillDetail component (before rating form)
   - Only render if similarSkills.length > 0
   ```tsx
   {similarSkills.length > 0 && (
     <div className="mt-8">
       <SimilarSkillsSection similarSkills={similarSkills} />
     </div>
   )}
   ```

4. Handle edge cases:
   - New skills without embeddings: query returns null, similarSkills stays empty
   - Query failures: caught and logged, page still renders normally
   - No similar skills above threshold: section doesn't render
  </action>
  <verify>
- TypeScript compiles: `cd apps/web && npx tsc --noEmit`
- Lint passes: `cd apps/web && npm run lint`
- Manual test: Visit /skills/{slug} for a skill
  - If skill has similar matches: Similar Skills section appears
  - If no similar skills: Section doesn't appear (no error)
  </verify>
  <done>
- Skill detail page queries similar skills on load
- SimilarSkillsSection displays when matches exist (SIM-04)
- Page loads normally even if similar skills query fails
- Similar skills show with similarity percentages (SIM-02)
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `cd apps/web && npx tsc --noEmit` passes
2. Lint: `cd apps/web && npm run lint` passes
3. Manual test:
   - Visit skill detail page for skill with similar skills -> section shows
   - Visit skill detail page for unique skill -> no similar skills section (clean)
   - Similar skills are clickable links to their detail pages
   - Similarity percentages display correctly (e.g., "85% similar")
</verification>

<success_criteria>
- SIM-04: Skill detail page shows "Similar Skills" section with related skills
- SIM-02: Similar skills display similarity percentage
- Graceful degradation: Section doesn't render if no similar skills or on query failure
- No blocking: Similar skills query failure doesn't break page load
- Performance: Query uses existing embedding (no new embedding generation on page load)
</success_criteria>

<output>
After completion, create `.planning/phases/16-similarity-detection/16-02-SUMMARY.md`
</output>
