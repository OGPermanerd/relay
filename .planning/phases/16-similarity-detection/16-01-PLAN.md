---
phase: 16-similarity-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/components/skill-upload-form.tsx
  - apps/web/components/similar-skills-warning.tsx
  - apps/web/app/actions/skills.ts
  - apps/web/lib/similar-skills.ts
autonomous: true

must_haves:
  truths:
    - "User sees top 3 similar skills when publishing a new skill"
    - "Similar skills display similarity percentage (e.g., 87% similar)"
    - "User can bypass similarity warning and publish anyway"
    - "Similarity detection does not block publishing (advisory only)"
  artifacts:
    - path: "apps/web/components/similar-skills-warning.tsx"
      provides: "Warning UI showing similar skills with percentages"
      exports: ["SimilarSkillsWarning"]
    - path: "apps/web/lib/similar-skills.ts"
      provides: "Server-side function to check for similar skills"
      exports: ["checkSimilarSkills", "SimilarSkillResult"]
    - path: "apps/web/components/skill-upload-form.tsx"
      provides: "Two-step form with preview and warning"
  key_links:
    - from: "apps/web/components/skill-upload-form.tsx"
      to: "apps/web/lib/similar-skills.ts"
      via: "server action call"
      pattern: "checkSimilarSkills"
    - from: "apps/web/lib/similar-skills.ts"
      to: "@everyskill/db/services/skill-embeddings"
      via: "findSimilarSkills import"
      pattern: "findSimilarSkills"
---

<objective>
Add similarity detection to the skill publish flow with advisory warnings.

Purpose: Help users discover existing similar skills before publishing, reducing duplicates while never blocking contributions. Users see top 3 similar skills with percentages and can choose to proceed anyway.

Output: Enhanced skill upload form with preview step showing similar skills warning when matches found.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@apps/web/components/skill-upload-form.tsx
@apps/web/app/actions/skills.ts
@packages/db/src/services/skill-embeddings.ts
@apps/web/lib/embeddings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create similar skills check function</name>
  <files>apps/web/lib/similar-skills.ts</files>
  <action>
Create a server-side function that checks for similar skills given form data.

1. Create `apps/web/lib/similar-skills.ts` with:
   - Export `SimilarSkillResult` type re-exported from `@everyskill/db/services`
   - Export `checkSimilarSkills(formData: { name: string; description: string; content: string; tags?: string[] })` async function

2. Implementation:
   - Combine name, description, content, and tags into embedding input string (same as createSkill)
   - Call `generateEmbedding(embeddingInput)` from `@/lib/embeddings`
   - Call `findSimilarSkills(embedding, { threshold: 0.7, limit: 3 })` from `@everyskill/db/services`
   - Return the array of similar skills (may be empty)

3. Handle errors gracefully:
   - If embedding generation fails, log warning and return empty array (never block)
   - If findSimilarSkills fails, log warning and return empty array (never block)

Key principle: This function should NEVER throw. Failure = empty array = no warning shown.
  </action>
  <verify>
- File exists at `apps/web/lib/similar-skills.ts`
- TypeScript compiles: `cd apps/web && npx tsc --noEmit`
- Function signature matches specification
  </verify>
  <done>
- `checkSimilarSkills` function exported
- Returns `SimilarSkillResult[]` (skillId, skillName, skillSlug, similarity)
- Never throws, returns empty array on any failure
  </done>
</task>

<task type="auto">
  <name>Task 2: Create similar skills warning component</name>
  <files>apps/web/components/similar-skills-warning.tsx</files>
  <action>
Create a client component that displays similar skills as an advisory warning.

1. Create `apps/web/components/similar-skills-warning.tsx`:
   - "use client" directive at top
   - Props: `similarSkills: SimilarSkillResult[]`, `onProceed: () => void`, `onCancel: () => void`
   - Import `Link` from `next/link` for skill links

2. UI structure (yellow/amber warning style):
   - Warning header: "Similar skills found" with info icon
   - Explanatory text: "These existing skills look similar to what you're creating:"
   - List of up to 3 similar skills, each showing:
     - Skill name as link to `/skills/{slug}` (opens in new tab)
     - Similarity badge: `{Math.round(similarity * 100)}% similar` (amber/yellow pill)
   - Two buttons at bottom:
     - "View Similar Skills" (secondary, calls onCancel to let user review)
     - "Publish Anyway" (primary, calls onProceed)
   - Small text below: "This is just a heads up - you can always publish your skill."

3. Styling:
   - Use Tailwind: `bg-amber-50 border-amber-200 text-amber-800` for warning container
   - Rounded corners, padding, clear visual hierarchy
   - Skills list with hover states on links
  </action>
  <verify>
- File exists at `apps/web/components/similar-skills-warning.tsx`
- Component renders without errors
- TypeScript compiles: `cd apps/web && npx tsc --noEmit`
  </verify>
  <done>
- `SimilarSkillsWarning` component exported
- Shows skill names with clickable links
- Shows similarity percentages as badges
- Has "Publish Anyway" and "View Similar Skills" buttons
- Advisory tone (not blocking)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add two-step flow to upload form</name>
  <files>apps/web/components/skill-upload-form.tsx, apps/web/app/actions/skills.ts</files>
  <action>
Modify the skill upload form to add a preview step with similarity check.

1. Create new server action in `apps/web/app/actions/skills.ts`:
   - Add `checkSimilarity` server action that:
     - Takes FormData, validates with existing schema (without inserting)
     - If validation fails, return `{ errors }` (same as createSkill)
     - If valid, call `checkSimilarSkills({ name, description, content, tags })`
     - Return `{ similarSkills: SimilarSkillResult[] }` (empty array if none found)

2. Modify `apps/web/components/skill-upload-form.tsx`:
   - Add state: `step: "form" | "preview"` (default: "form")
   - Add state: `similarSkills: SimilarSkillResult[]` (default: [])
   - Add state: `formDataCache: FormData | null` for storing form between steps

3. Form submission flow:
   - When user clicks "Create Skill" button:
     - If step is "form": call `checkSimilarity` action
       - If errors returned, show them (existing behavior)
       - If similarSkills.length > 0, set step to "preview" and cache formData
       - If similarSkills.length === 0, proceed directly to `createSkill`
     - If step is "preview": call `createSkill` with cached formData

4. Preview step UI:
   - Show form fields as read-only summary (name, description, category)
   - Show `SimilarSkillsWarning` component if similarSkills exist
   - "Publish Anyway" button triggers createSkill with cached formData
   - "Edit" button returns to form step (preserves entered data)

5. If no similar skills found:
   - Skip preview step entirely, publish immediately (no friction for unique skills)
  </action>
  <verify>
- TypeScript compiles: `cd apps/web && npx tsc --noEmit`
- Form renders without errors
- Manual test: Navigate to /skills/new, fill form, submit
  - If similar skills exist: warning shown with proceed option
  - If no similar skills: publishes immediately
  </verify>
  <done>
- Form has two-step flow: form -> preview (if similar) -> publish
- Similar skills warning displays when matches found
- User can publish anyway (SIM-03)
- User sees top 3 similar skills with percentages (SIM-01, SIM-02)
- Unique skills publish immediately (no unnecessary friction)
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `cd apps/web && npx tsc --noEmit` passes
2. Lint: `cd apps/web && npm run lint` passes
3. Manual test flow:
   - Create skill with unique name/content -> publishes immediately
   - Create skill similar to existing -> warning shown with similar skills
   - Click "Publish Anyway" -> skill publishes successfully
   - Similar skills show as clickable links with percentage badges
</verification>

<success_criteria>
- SIM-01: User sees top 3 similar skills when publishing (if any exist above 0.7 threshold)
- SIM-02: Similar skills display similarity percentage (e.g., "87% similar")
- SIM-03: User can bypass similarity warning and publish anyway
- Advisory only: Similarity check never blocks, failures return empty array
- No regression: Existing upload flow works for unique skills without added friction
</success_criteria>

<output>
After completion, create `.planning/phases/16-similarity-detection/16-01-SUMMARY.md`
</output>
