---
phase: 05-skill-publishing
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/web/lib/content-hash.ts
  - apps/web/app/actions/skills.ts
autonomous: true

must_haves:
  truths:
    - "Skill content is uploaded to R2 object storage"
    - "Skill version record is created with content URL and hash"
    - "Skill's publishedVersionId points to the new version"
    - "Content hash is SHA-256 of skill content"
    - "Upload gracefully degrades when R2 is not configured"
  artifacts:
    - path: "apps/web/lib/content-hash.ts"
      provides: "SHA-256 hash generation using Web Crypto API"
      exports: ["hashContent"]
    - path: "apps/web/app/actions/skills.ts"
      provides: "Enhanced createSkill with R2 upload and version creation"
      contains: "generateUploadUrl"
  key_links:
    - from: "apps/web/app/actions/skills.ts"
      to: "@relay/storage"
      via: "generateUploadUrl call"
      pattern: "generateUploadUrl"
    - from: "apps/web/app/actions/skills.ts"
      to: "skillVersions table"
      via: "db.insert(skillVersions)"
      pattern: "insert.*skillVersions"
---

<objective>
Integrate R2 object storage into the skill upload workflow with versioning.

Purpose: Persist skill content in object storage with immutable version records for wiki-style history.
Output: Upload action creates R2 object, skillVersion record, and links to skill.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-skill-publishing/05-RESEARCH.md
@.planning/phases/05-skill-publishing/05-01-SUMMARY.md

# Existing infrastructure
@packages/storage/src/presigned-urls.ts
@packages/db/src/schema/skill-versions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content hash utility</name>
  <files>apps/web/lib/content-hash.ts</files>
  <action>
Create apps/web/lib/content-hash.ts with SHA-256 hash generation:

```typescript
/**
 * Generate SHA-256 hash of content using Web Crypto API
 * Works in both Node.js and Edge runtime
 */
export async function hashContent(content: string): Promise<string> {
  const encoder = new TextEncoder()
  const data = encoder.encode(content)
  const hashBuffer = await crypto.subtle.digest('SHA-256', data)
  const hashArray = Array.from(new Uint8Array(hashBuffer))
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
}
```

This uses the Web Crypto API which is available in:
- Node.js (global crypto.subtle)
- Edge runtime
- Browser

No external dependencies needed.
  </action>
  <verify>
TypeScript compilation passes: `pnpm --filter @relay/web exec tsc --noEmit`
  </verify>
  <done>
hashContent function generates SHA-256 hashes compatible with Edge runtime.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance createSkill with R2 upload and versioning</name>
  <files>apps/web/app/actions/skills.ts</files>
  <action>
Modify the existing createSkill Server Action to add R2 upload and version creation:

Add imports at top of file:
```typescript
import { generateUploadUrl } from '@relay/storage'
import { skillVersions } from '@relay/db'
import { eq } from 'drizzle-orm'
import { hashContent } from '@/lib/content-hash'
```

After the skill insert (inside the try block, before revalidatePath calls), add version creation logic:

```typescript
// Generate content hash
const contentHash = await hashContent(data.content)

// Attempt R2 upload (gracefully handles missing config)
const uploadResult = await generateUploadUrl(newSkill.id, 1, 'text/markdown')

if (uploadResult) {
  // Upload content to R2
  const uploadResponse = await fetch(uploadResult.uploadUrl, {
    method: 'PUT',
    headers: { 'Content-Type': 'text/markdown' },
    body: data.content,
  })

  if (uploadResponse.ok) {
    // Create version record
    const [version] = await db!.insert(skillVersions).values({
      skillId: newSkill.id,
      version: 1,
      contentUrl: uploadResult.objectKey,
      contentHash,
      contentType: 'text/markdown',
      name: data.name,
      description: data.description,
      metadata: {
        tags: data.tags,
        usageInstructions: data.usageInstructions,
      },
      createdBy: session.user.id,
    }).returning({ id: skillVersions.id })

    // Update skill with published version reference
    await db!.update(skills)
      .set({ publishedVersionId: version.id })
      .where(eq(skills.id, newSkill.id))
  } else {
    console.warn('R2 upload failed, skill created without version record')
  }
} else {
  console.warn('R2 not configured, skill created without version record')
}
```

Key patterns from research:
1. generateUploadUrl returns null when R2 is not configured - handle gracefully
2. Insert skill first (no version refs), then version, then update skill - avoids circular FK issue
3. Store objectKey (not full URL) in contentUrl - matches existing pattern
4. Use RETURNING clause to get version ID for skill update
5. Content is still saved in skills.content for backward compat with MCP tools

Error handling:
- If R2 upload fails, skill is still created (degraded mode)
- Log warnings for debugging but don't fail the request
- The skill.content field provides fallback access

The redirect call should remain at the end, after the try/catch block.
  </action>
  <verify>
1. TypeScript passes: `pnpm --filter @relay/web exec tsc --noEmit`
2. Build succeeds: `pnpm --filter @relay/web build`
  </verify>
  <done>
createSkill uploads content to R2, creates skillVersion record, and updates skill.publishedVersionId. Gracefully degrades when R2 unavailable.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `pnpm --filter @relay/web exec tsc --noEmit` passes
2. Build: `pnpm --filter @relay/web build` succeeds
3. Linting: `pnpm lint` passes
4. Content hash generates correct SHA-256 format (64 hex characters)
</verification>

<success_criteria>
- hashContent utility generates valid SHA-256 hashes
- Server Action uploads content to R2 via presigned URL
- skillVersion record created with contentUrl and contentHash
- skill.publishedVersionId updated to reference new version
- Workflow gracefully handles missing R2 configuration
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-skill-publishing/05-03-SUMMARY.md`
</output>
