---
phase: 05-skill-publishing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/slug.ts
  - apps/web/app/actions/skills.ts
  - apps/web/components/skill-upload-form.tsx
  - apps/web/app/(protected)/skills/new/page.tsx
  - apps/web/app/(protected)/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /skills/new from home page"
    - "User can fill out skill upload form with name, description, category, tags"
    - "User can provide usage instructions and estimated time saved"
    - "Form shows validation errors for invalid input"
    - "Form shows pending state during submission"
    - "Successful submission creates skill in database"
  artifacts:
    - path: "apps/web/lib/slug.ts"
      provides: "URL-safe slug generation with uniqueness handling"
      exports: ["generateSlug", "generateUniqueSlug"]
    - path: "apps/web/app/actions/skills.ts"
      provides: "Server action for skill creation with Zod validation"
      exports: ["createSkill", "CreateSkillState"]
    - path: "apps/web/components/skill-upload-form.tsx"
      provides: "Client component form with useActionState"
      exports: ["SkillUploadForm"]
    - path: "apps/web/app/(protected)/skills/new/page.tsx"
      provides: "Upload form page route"
      min_lines: 15
    - path: "apps/web/app/(protected)/page.tsx"
      provides: "Home page with link to /skills/new"
      contains: "/skills/new"
  key_links:
    - from: "apps/web/components/skill-upload-form.tsx"
      to: "apps/web/app/actions/skills.ts"
      via: "useActionState(createSkill)"
      pattern: "useActionState.*createSkill"
    - from: "apps/web/app/(protected)/page.tsx"
      to: "/skills/new"
      via: "Link href"
      pattern: 'href.*skills/new'
---

<objective>
Create the skill upload form with Server Action and supporting utilities.

Purpose: Enable users to contribute new skills to the marketplace with validated metadata.
Output: Working upload form at /skills/new that creates skills in the database.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-skill-publishing/05-RESEARCH.md

# Existing infrastructure
@packages/db/src/schema/skills.ts
@packages/db/src/validation/skill-formats.ts
@apps/web/auth.ts
@apps/web/app/(protected)/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create slug generation utility</name>
  <files>apps/web/lib/slug.ts</files>
  <action>
Create slug generation utility at apps/web/lib/slug.ts with two functions:

1. `generateSlug(name: string): string`
   - Convert to lowercase
   - Normalize with NFD and remove diacritics (regex: /[\u0300-\u036f]/g)
   - Replace non-alphanumeric with hyphens (regex: /[^a-z0-9]+/g)
   - Trim leading/trailing hyphens
   - Limit to 50 characters
   - Return empty string fallback as 'skill'

2. `generateUniqueSlug(name: string, db: typeof import("@relay/db").db): Promise<string>`
   - Generate base slug from name
   - Query database for skills with slug starting with base slug
   - If collision exists, append 8-char UUID suffix (crypto.randomUUID().slice(0, 8))
   - Return unique slug

Use drizzle `like` operator for collision check. Handle null db case by returning base slug.

TypeScript patterns:
- Export both functions
- Use Web Crypto API (crypto.randomUUID) for UUID
- Import eq, like from drizzle-orm
  </action>
  <verify>
TypeScript compilation passes. Run: `pnpm --filter @relay/web exec tsc --noEmit`
  </verify>
  <done>
Slug utility exports generateSlug and generateUniqueSlug functions with proper TypeScript types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create skill upload Server Action</name>
  <files>apps/web/app/actions/skills.ts</files>
  <action>
Create Server Action at apps/web/app/actions/skills.ts with 'use server' directive:

1. Define Zod schema for form validation:
   - name: string, min 1, max 100
   - description: string, min 1, max 2000
   - category: enum ['prompt', 'workflow', 'agent', 'mcp']
   - tags: string (comma-separated, transform to array, filter empty, max 10 items)
   - usageInstructions: string, max 5000, optional
   - hoursSaved: coerce to number, min 0, max 1000, default 1
   - content: string, min 1 (required - the skill content)

2. Export type `CreateSkillState`:
   ```typescript
   export type CreateSkillState = {
     errors?: Record<string, string[]>
     message?: string
   }
   ```

3. Export async function `createSkill(prevState: CreateSkillState, formData: FormData): Promise<CreateSkillState>`:
   - Get session with auth() - return error message if not authenticated
   - Parse formData with Zod schema using safeParse
   - Return { errors: flatten().fieldErrors } if validation fails
   - Generate unique slug using generateUniqueSlug
   - Insert skill into database using db.insert(skills).values():
     - id: let database generate
     - name, slug, description, category from parsed data
     - content: parsed content (for backward compat with MCP)
     - hoursSaved: parsed hoursSaved
     - authorId: session.user.id
   - Use .returning({ id: skills.id, slug: skills.slug })
   - Call revalidatePath('/skills') and revalidatePath('/')
   - Call redirect(`/skills/${slug}`)
   - Wrap in try/catch, return { message: 'Failed to create skill...' } on error

IMPORTANT: The redirect() call should be AFTER the try block ends (throw happens on success and redirect is outside try/catch). See Next.js docs on Server Actions.

Imports needed:
- 'use server' at top
- { auth } from '@/auth'
- { db, skills } from '@relay/db'
- { revalidatePath } from 'next/cache'
- { redirect } from 'next/navigation'
- { z } from 'zod'
- { generateUniqueSlug } from '@/lib/slug'
  </action>
  <verify>
TypeScript compilation passes. Run: `pnpm --filter @relay/web exec tsc --noEmit`
  </verify>
  <done>
Server Action createSkill exported with proper Zod validation, database insert, and redirect.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create upload form, page, and home page link</name>
  <files>apps/web/components/skill-upload-form.tsx, apps/web/app/(protected)/skills/new/page.tsx, apps/web/app/(protected)/page.tsx</files>
  <action>
Create three files:

**1. apps/web/components/skill-upload-form.tsx** (client component):

```typescript
'use client'

import { useActionState } from 'react'
import { createSkill, CreateSkillState } from '@/app/actions/skills'

const initialState: CreateSkillState = {}

export function SkillUploadForm() {
  const [state, formAction, isPending] = useActionState(createSkill, initialState)

  return (
    <form action={formAction} className="space-y-6">
      {state.message && (
        <div className="rounded-md bg-red-50 p-4 text-red-700">{state.message}</div>
      )}

      {/* Name field */}
      <div>
        <label htmlFor="name" className="block text-sm font-medium text-gray-700">
          Name <span className="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="name"
          name="name"
          required
          disabled={isPending}
          className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100"
          placeholder="My Awesome Skill"
        />
        {state.errors?.name && (
          <p className="mt-1 text-sm text-red-600">{state.errors.name[0]}</p>
        )}
      </div>

      {/* Description field (textarea) */}
      {/* Category field (select with prompt/workflow/agent/mcp) */}
      {/* Tags field (input, comma-separated hint) */}
      {/* Usage Instructions field (textarea, optional) */}
      {/* Hours Saved field (number input, default 1) */}
      {/* Content field (textarea, required) */}

      <button
        type="submit"
        disabled={isPending}
        className="w-full rounded-md bg-blue-600 px-4 py-2 text-white font-medium hover:bg-blue-700 disabled:bg-blue-300"
      >
        {isPending ? 'Creating Skill...' : 'Create Skill'}
      </button>
    </form>
  )
}
```

Follow the same pattern for all fields. Use appropriate HTML5 input types. Show validation errors from state.errors.

**2. apps/web/app/(protected)/skills/new/page.tsx**:

```typescript
import { SkillUploadForm } from '@/components/skill-upload-form'

export default function NewSkillPage() {
  return (
    <div className="mx-auto max-w-2xl px-4 py-8">
      <h1 className="text-2xl font-bold text-gray-900">Share a New Skill</h1>
      <p className="mt-2 text-gray-600">
        Contribute to the skill marketplace by sharing your expertise.
      </p>
      <div className="mt-8">
        <SkillUploadForm />
      </div>
    </div>
  )
}
```

**3. Update apps/web/app/(protected)/page.tsx**:

Add a new navigation card for "Share a Skill" that links to /skills/new:
- Title: "Share a Skill"
- Description: "Upload your prompts, workflows, and agent configurations"
- href: "/skills/new"
- Icon: Plus icon (PlusIcon SVG)
- disabled: false (remove disabled state)

Also update the existing "Browse Skills" card to remain disabled for now (Phase 6).
  </action>
  <verify>
1. TypeScript passes: `pnpm --filter @relay/web exec tsc --noEmit`
2. Build succeeds: `pnpm --filter @relay/web build`
3. Manually verify form renders at /skills/new (if dev server available)
  </verify>
  <done>
Upload form component renders with all fields, validation errors display, pending state works, home page has link to /skills/new.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `pnpm --filter @relay/web exec tsc --noEmit` passes
2. Build: `pnpm --filter @relay/web build` succeeds
3. Linting: `pnpm lint` passes
4. All files exist at expected paths
</verification>

<success_criteria>
- Slug utility generates URL-safe slugs with uniqueness handling
- Server Action validates input with Zod and creates skills in database
- Upload form uses useActionState for pending/error states
- Form page exists at /skills/new
- Home page links to /skills/new
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-skill-publishing/05-01-SUMMARY.md`
</output>
