---
phase: 58-training-data-golden-dataset
plan: 02
type: execute
wave: 2
depends_on: ["58-01"]
files_modified:
  - apps/web/components/training-example-form.tsx
  - apps/web/components/training-example-list.tsx
  - apps/web/components/skill-detail-tabs.tsx
  - apps/web/app/(protected)/skills/[slug]/page.tsx
  - apps/web/components/admin-settings-form.tsx
  - apps/web/app/actions/admin-settings.ts
autonomous: true

must_haves:
  truths:
    - "Author sees a Training tab on their skill detail page with golden example form"
    - "Author can fill in Input and Expected Output fields and submit a training example"
    - "Training example count is displayed on the Training tab label"
    - "Training examples are listed below the form showing input/output pairs"
    - "Admin can toggle training_data_capture_enabled in admin settings"
    - "Non-authors do not see the Training tab"
  artifacts:
    - path: "apps/web/components/training-example-form.tsx"
      provides: "Form for seeding golden examples (input/output pairs)"
      min_lines: 50
    - path: "apps/web/components/training-example-list.tsx"
      provides: "List display of existing training examples"
      min_lines: 30
    - path: "apps/web/components/skill-detail-tabs.tsx"
      provides: "Extended tabs with 'training' tab"
      contains: "training"
  key_links:
    - from: "apps/web/components/training-example-form.tsx"
      to: "apps/web/app/actions/skill-feedback.ts"
      via: "submitTrainingExample import"
      pattern: "submitTrainingExample"
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "packages/db/src/services/skill-feedback.ts"
      via: "getTrainingExamplesForSkill and getTrainingExampleCount"
      pattern: "getTrainingExample"
---

<objective>
UI components for golden example management: training example form, list, tab extension, page wiring, and admin settings toggle.

Purpose: Gives authors a visual way to seed golden examples (TRAIN-01, TRAIN-05) and gives admins the tenant-level control (TRAIN-06).
Output: TrainingExampleForm and TrainingExampleList components, extended SkillDetailTabs, wired skill detail page, admin settings toggle.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/web/components/suggestion-form.tsx
@apps/web/components/skill-detail-tabs.tsx
@apps/web/app/(protected)/skills/[slug]/page.tsx
@apps/web/components/admin-settings-form.tsx
@apps/web/app/actions/admin-settings.ts
@.planning/phases/58-training-data-golden-dataset/58-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Training example form, list, and tab extension</name>
  <files>
    apps/web/components/training-example-form.tsx
    apps/web/components/training-example-list.tsx
    apps/web/components/skill-detail-tabs.tsx
  </files>
  <action>
1. Create `apps/web/components/training-example-form.tsx` following the SuggestionForm pattern:
   - "use client" component
   - Props: `{ skillId: string; skillSlug: string }`
   - Uses `useActionState` with `submitTrainingExample` from `@/app/actions/skill-feedback`
   - Hidden fields: skillId, skillSlug
   - Two textarea fields:
     - "Example Input" (name="exampleInput", required, minLength=1, maxLength=5000, rows=4, placeholder="The input or prompt given to the skill...")
     - "Expected Output" (name="exampleOutput", required, minLength=1, maxLength=5000, rows=4, placeholder="The ideal output the skill should produce...")
   - Optional quality score: number input 1-10 (name="qualityScore", not required)
   - Submit button: "Add Training Example" / "Adding..."
   - Success/error message display matching SuggestionForm pattern
   - Heading: "Add Golden Example"

2. Create `apps/web/components/training-example-list.tsx`:
   - "use client" component
   - Props: `{ examples: Array<{ id: string; exampleInput: string; exampleOutput: string | null; expectedOutput: string | null; qualityScore: number | null; source: string; status: string; createdAt: string; user: { name: string | null; image: string | null } | null }> }`
   - Render each example as a card with:
     - Source badge: "Golden" (source=web, green) or "Captured" (source=usage_capture, blue)
     - Status badge: "Approved" (green) or "Pending" (yellow)
     - Input section: label "Input:" + pre/code block with the text (whitespace-pre-wrap)
     - Output section: label "Expected Output:" + pre/code block
     - Quality score if present (e.g., "Quality: 8/10")
     - Submitted by user name + relative date
   - If no examples: render "No training examples yet. Add golden examples above to establish expected behavior."
   - Use Tailwind classes consistent with existing card patterns (rounded-lg border border-gray-200 p-4)

3. Extend `apps/web/components/skill-detail-tabs.tsx`:
   - Add `"training"` to the `TabKey` union type
   - Add optional props to SkillDetailTabsProps:
     - `trainingContent?: ReactNode`
     - `trainingExampleCount?: number`
     - `showTrainingTab?: boolean` (default false -- only show for authors)
   - Conditionally add the training tab to the `tabs` array only when `showTrainingTab` is true:
     ```typescript
     const tabs: { key: TabKey; label: string }[] = [
       { key: "details", label: "Details" },
       { key: "ai-review", label: "AI Review" },
       { key: "suggestions", label: suggestionCount && suggestionCount > 0 ? `Suggestions (${suggestionCount})` : "Suggestions" },
       ...(showTrainingTab ? [{ key: "training" as TabKey, label: trainingExampleCount && trainingExampleCount > 0 ? `Training (${trainingExampleCount})` : "Training" }] : []),
     ];
     ```
   - Add the training tab panel (after suggestions panel):
     ```jsx
     <div role="tabpanel" id="tabpanel-training" aria-labelledby="tab-training" hidden={activeTab !== "training"}>
       {trainingContent}
     </div>
     ```
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && pnpm build` to confirm TypeScript compiles.
  </verify>
  <done>
    TrainingExampleForm renders input/output textareas with submit. TrainingExampleList renders example cards with source/status badges. SkillDetailTabs has conditional "Training" tab.
  </done>
</task>

<task type="auto">
  <name>Task 2: Page wiring and admin settings toggle</name>
  <files>
    apps/web/app/(protected)/skills/[slug]/page.tsx
    apps/web/components/admin-settings-form.tsx
    apps/web/app/actions/admin-settings.ts
  </files>
  <action>
1. Wire the training tab into `apps/web/app/(protected)/skills/[slug]/page.tsx`:

   a) Add imports:
      - `import { TrainingExampleForm } from "@/components/training-example-form";`
      - `import { TrainingExampleList } from "@/components/training-example-list";`
      - Add `getTrainingExamplesForSkill, getTrainingExampleCount` to the existing `@everyskill/db/services` import (or import from `@everyskill/db/services/skill-feedback`)

   b) Add to the existing Promise.all (where suggestions and feedbackStats are fetched):
      - `getTrainingExamplesForSkill(skill.id)` -- add to destructured result
      - `getTrainingExampleCount(skill.id)` -- add to destructured result

   c) Serialize training examples for client (same Date->ISO pattern as suggestions):
      ```typescript
      const serializedTrainingExamples = trainingExamples.map((t) => ({
        ...t,
        createdAt: t.createdAt.toISOString(),
      }));
      ```

   d) Pass new props to SkillDetailTabs:
      - `showTrainingTab={isAuthor || userIsAdmin}` -- only authors/admins see training tab
      - `trainingExampleCount={trainingExampleCount}`
      - `trainingContent={...}` with:
        ```jsx
        <div className="space-y-6">
          {isAuthor && <TrainingExampleForm skillId={skill.id} skillSlug={skill.slug} />}
          <TrainingExampleList examples={serializedTrainingExamples} />
        </div>
        ```

2. Add training data capture toggle to admin settings:

   a) In `apps/web/components/admin-settings-form.tsx`:
      - Add `trainingDataCaptureEnabled: boolean` to the AdminSettingsFormProps.initialSettings interface
      - Add default: `trainingDataCaptureEnabled: false` to the defaults object
      - Add a new "Training Data Capture" section (after Gmail Diagnostics section), following the same pattern:
        - Card with heading "Training Data Capture"
        - Description: "Allow capturing real skill usage as training examples. Users must also opt in individually via their preferences."
        - form with saveAction
        - Hidden fields preserving ALL other settings: semanticSimilarityEnabled, ollamaUrl, ollamaModel, embeddingDimensions, allowSkillDownload, gmailDiagnosticEnabled
        - Checkbox: `trainingDataCaptureEnabled` defaultChecked from defaults
        - Save button
      - IMPORTANT: Add `trainingDataCaptureEnabled` as a hidden input in the Semantic Similarity, Skill Downloads, and Gmail Diagnostics form sections:
        ```jsx
        <input type="hidden" name="trainingDataCaptureEnabled" value={defaults.trainingDataCaptureEnabled ? "on" : ""} />
        ```

   b) In `apps/web/app/actions/admin-settings.ts`:
      - Add to saveSettingsAction: `const trainingDataCaptureEnabled = formData.get("trainingDataCaptureEnabled") === "on";`
      - Add `trainingDataCaptureEnabled` to the updateSiteSettings call

   c) In `apps/web/app/(protected)/admin/settings/page.tsx` (or wherever the admin settings page is):
      - Pass `trainingDataCaptureEnabled: settings?.trainingDataCaptureEnabled ?? false` to AdminSettingsForm props

3. Add per-user training data consent toggle to user preferences page:
   - Find the user preferences page (likely `apps/web/app/(protected)/preferences/page.tsx` or similar profile/settings page)
   - Add a checkbox: "Allow my skill usage to be captured as training data" (name="trainingDataConsent", defaultChecked from user preferences)
   - Wire it into the existing preferences save action so `trainingDataConsent` is persisted in the user_preferences JSONB
   - This is required by Success Criterion 2: "per-user consent toggle that defaults to off"
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && pnpm build` to confirm TypeScript compiles.
    Run relevant Playwright tests: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/skill-detail.spec.ts` (if it exists) to verify pages load.
  </verify>
  <done>
    Skill detail page shows Training tab (with count) for authors/admins. Form allows adding golden examples. List displays them with source/status badges. Admin settings has training data capture toggle that persists correctly across all form sections.
  </done>
</task>

</tasks>

<verification>
- Skill detail page renders Training tab only for skill authors and admins
- Training tab label shows count when examples exist
- Form submits and creates training_example record (visible in list after refresh)
- Admin settings page shows training data capture toggle
- Toggling setting in admin persists correctly (doesn't reset other settings)
- `pnpm build` passes
</verification>

<success_criteria>
- Author can see Training tab with example form and list on their skill detail page
- Non-authors do NOT see the Training tab
- Training example count appears in tab label when > 0
- Admin can toggle training_data_capture_enabled setting
- All hidden fields correctly preserve other settings across all admin form sections
</success_criteria>

<output>
After completion, create `.planning/phases/58-training-data-golden-dataset/58-02-SUMMARY.md`
</output>
