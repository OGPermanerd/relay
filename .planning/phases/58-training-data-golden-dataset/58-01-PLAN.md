---
phase: 58-training-data-golden-dataset
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/site-settings.ts
  - packages/db/src/schema/user-preferences.ts
  - packages/db/src/services/skill-feedback.ts
  - packages/db/src/services/index.ts
  - packages/db/src/migrations/0034_add_training_data_settings.sql
  - apps/web/app/actions/skill-feedback.ts
  - apps/web/lib/preferences-defaults.ts
autonomous: true

must_haves:
  truths:
    - "createTrainingExample inserts a skill_feedback row with feedbackType='training_example'"
    - "getTrainingExamplesForSkill returns training examples for a given skillId"
    - "getTrainingExampleCount returns integer count of training examples for a skill"
    - "submitTrainingExample server action validates input, sanitizes, checks author, and calls DB service"
    - "site_settings has training_data_capture_enabled boolean column"
    - "UserPreferencesData interface includes trainingDataConsent boolean"
  artifacts:
    - path: "packages/db/src/migrations/0034_add_training_data_settings.sql"
      provides: "training_data_capture_enabled column on site_settings"
    - path: "packages/db/src/services/skill-feedback.ts"
      provides: "createTrainingExample, getTrainingExamplesForSkill, getTrainingExampleCount"
      exports: ["createTrainingExample", "getTrainingExamplesForSkill", "getTrainingExampleCount"]
    - path: "apps/web/app/actions/skill-feedback.ts"
      provides: "submitTrainingExample server action"
      exports: ["submitTrainingExample", "TrainingExampleState"]
  key_links:
    - from: "apps/web/app/actions/skill-feedback.ts"
      to: "packages/db/src/services/skill-feedback.ts"
      via: "createTrainingExample import"
      pattern: "createTrainingExample"
    - from: "apps/web/app/actions/skill-feedback.ts"
      to: "apps/web/lib/sanitize-payload.ts"
      via: "sanitizePayload call on both exampleInput and exampleOutput"
      pattern: "sanitizePayload"
---

<objective>
Backend foundation for training examples: migration, DB service functions, server action, and schema/interface updates.

Purpose: Establishes all backend plumbing so that Plans 02 (UI) and 03 (usage capture) can be built on top.
Output: Migration file, DB service CRUD, server action for golden example submission, schema and interface updates.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/schema/skill-feedback.ts
@packages/db/src/services/skill-feedback.ts
@apps/web/app/actions/skill-feedback.ts
@packages/db/src/schema/site-settings.ts
@packages/db/src/schema/user-preferences.ts
@apps/web/lib/preferences-defaults.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration, schema updates, and DB service functions</name>
  <files>
    packages/db/src/migrations/0034_add_training_data_settings.sql
    packages/db/src/schema/site-settings.ts
    packages/db/src/schema/user-preferences.ts
    packages/db/src/services/skill-feedback.ts
    packages/db/src/services/index.ts
    apps/web/lib/preferences-defaults.ts
  </files>
  <action>
1. Create migration `packages/db/src/migrations/0034_add_training_data_settings.sql`:
   ```sql
   ALTER TABLE site_settings
     ADD COLUMN IF NOT EXISTS training_data_capture_enabled BOOLEAN NOT NULL DEFAULT false;
   ```

2. Run migration: `cd /home/dev/projects/relay && pnpm db:migrate`

3. Add to `packages/db/src/schema/site-settings.ts` in the siteSettings table columns (after gmailDiagnosticEnabled):
   ```typescript
   trainingDataCaptureEnabled: boolean("training_data_capture_enabled").notNull().default(false),
   ```

4. Add `trainingDataConsent` to `UserPreferencesData` interface in `packages/db/src/schema/user-preferences.ts`:
   ```typescript
   export interface UserPreferencesData {
     preferredCategories: ("productivity" | "wiring" | "doc-production" | "data-viz" | "code")[];
     defaultSort: "uses" | "quality" | "rating" | "days_saved";
     claudeMdWorkflowNotes: string;
     trainingDataConsent: boolean;  // matches Zod .default(false) output type (required, not optional)
   }
   ```

5. Add `trainingDataConsent` to defaults in `apps/web/lib/preferences-defaults.ts`:
   - Add `trainingDataConsent: z.boolean().default(false)` to the Zod schema
   - Add `trainingDataConsent: false` to PREFERENCES_DEFAULTS

6. Update PREFERENCES_DEFAULTS in `packages/db/src/services/user-preferences.ts`:
   - Add `trainingDataConsent: false` to the PREFERENCES_DEFAULTS constant (must stay in sync with the web app's copy)

6. Add three functions to `packages/db/src/services/skill-feedback.ts`:

   a) `createTrainingExample(params)` -- Insert a training_example row. Params: tenantId, skillId, userId, exampleInput, exampleOutput, expectedOutput?, qualityScore?, source? (default "web"), status? (default "approved"), usageEventId?. Returns inserted id or null. Follow the exact insertFeedback pattern but use feedbackType: "training_example". Do NOT call updateSkillFeedbackAggregates (training examples don't affect feedback sentiment).

   b) `getTrainingExamplesForSkill(skillId)` -- Query all training_example rows for a skill. Return array of objects: { id, userId, exampleInput, exampleOutput, expectedOutput, qualityScore, source, status, usageEventId, createdAt, user: { name, image } | null }. Use leftJoin on users table. Order by createdAt desc.

   c) `getTrainingExampleCount(skillId)` -- Count training_example rows for a skill. Return integer. Use `count(*)::int` pattern.

   Also create a `TrainingExampleWithUser` interface for the return type of getTrainingExamplesForSkill.

7. Export the new functions and types from `packages/db/src/services/index.ts`:
   Add `createTrainingExample`, `getTrainingExamplesForSkill`, `getTrainingExampleCount`, and `TrainingExampleWithUser` to the skill-feedback export block.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && pnpm build` to confirm TypeScript compiles.
    Verify migration ran: check that the column exists by looking at the migration runner output.
  </verify>
  <done>
    Migration 0034 applied. site_settings has training_data_capture_enabled. UserPreferencesData has trainingDataConsent. Three DB service functions (createTrainingExample, getTrainingExamplesForSkill, getTrainingExampleCount) exported from @everyskill/db/services.
  </done>
</task>

<task type="auto">
  <name>Task 2: Server action for golden example submission</name>
  <files>
    apps/web/app/actions/skill-feedback.ts
  </files>
  <action>
Add to `apps/web/app/actions/skill-feedback.ts`:

1. Add a `TrainingExampleState` type (same shape as SuggestionState):
   ```typescript
   export type TrainingExampleState = {
     errors?: Record<string, string[]>;
     message?: string;
     success?: boolean;
   };
   ```

2. Add a Zod schema `submitTrainingExampleSchema`:
   ```typescript
   const submitTrainingExampleSchema = z.object({
     skillId: z.string().min(1, "Skill ID is required"),
     skillSlug: z.string().min(1, "Skill slug is required"),
     exampleInput: z.string().min(1, "Input example is required").max(5000, "Input must be 5000 characters or less"),
     exampleOutput: z.string().min(1, "Expected output is required").max(5000, "Output must be 5000 characters or less"),
     qualityScore: z.coerce.number().int().min(1).max(10).optional().or(z.literal("").transform(() => undefined)),
   });
   ```

3. Add `submitTrainingExample` server action following the exact `submitSuggestion` pattern:
   - `auth()` check + tenantId check
   - Parse formData with Zod schema
   - Verify the current user is the skill author: query `skills` table by skillId, compare authorId to session.user.id. If not author, return error "Only the skill author can add training examples".
   - Sanitize both exampleInput and exampleOutput via `sanitizePayload()`
   - Call `createTrainingExample({ tenantId, skillId, userId: session.user.id, exampleInput: sanitizedInput, exampleOutput: sanitizedOutput, source: "web", status: "approved" })`
   - `revalidatePath(/skills/${skillSlug})`
   - Return `{ success: true, message: "Training example added" }`

Import `createTrainingExample` from `@everyskill/db/services/skill-feedback` (add to existing import block).
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && pnpm build` to confirm TypeScript compiles with no errors.
  </verify>
  <done>
    submitTrainingExample server action exists, validates with Zod, checks author permission, sanitizes input/output, calls createTrainingExample, and revalidates the skill page.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes with no TypeScript errors
- Migration 0034 is listed in applied migrations
- The 3 new DB functions are importable from `@everyskill/db/services`
- The server action is importable from `@/app/actions/skill-feedback`
</verification>

<success_criteria>
- training_data_capture_enabled column exists on site_settings table
- trainingDataConsent field exists in UserPreferencesData interface
- createTrainingExample, getTrainingExamplesForSkill, getTrainingExampleCount are exported from DB services
- submitTrainingExample server action validates author, sanitizes, persists, and revalidates
- Full project builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/58-training-data-golden-dataset/58-01-SUMMARY.md`
</output>
