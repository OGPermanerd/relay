---
phase: 58-training-data-golden-dataset
plan: 03
type: execute
wave: 2
depends_on: ["58-01"]
files_modified:
  - apps/web/app/api/track/route.ts
  - packages/db/src/services/user-preferences.ts
  - apps/web/lib/preferences-defaults.ts
autonomous: true

must_haves:
  truths:
    - "Usage data is captured as training examples only when BOTH tenant setting and user consent are true"
    - "Captured input and output snippets are sanitized via sanitizePayload before storage"
    - "Usage capture is fire-and-forget (does not block /api/track response)"
    - "When either tenant setting or user consent is false, no training example is created"
  artifacts:
    - path: "apps/web/app/api/track/route.ts"
      provides: "Usage capture as training examples with consent gating"
      contains: "captureUsageAsTraining\\|training_example\\|trainingDataConsent"
  key_links:
    - from: "apps/web/app/api/track/route.ts"
      to: "packages/db/src/services/skill-feedback.ts"
      via: "createTrainingExample call"
      pattern: "createTrainingExample"
    - from: "apps/web/app/api/track/route.ts"
      to: "packages/db/src/services/site-settings.ts"
      via: "getSiteSettings for trainingDataCaptureEnabled check"
      pattern: "trainingDataCaptureEnabled"
    - from: "apps/web/app/api/track/route.ts"
      to: "packages/db/src/services/user-preferences.ts"
      via: "getOrCreateUserPreferences for trainingDataConsent check"
      pattern: "trainingDataConsent"
---

<objective>
Wire usage capture into the /api/track route with dual consent gating (tenant + user) and sanitization.

Purpose: Enables real usage data to automatically become training examples when both tenant and user opt in (TRAIN-03, TRAIN-04, TRAIN-06).
Output: Modified track route with consent-gated, sanitized training data capture.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/web/app/api/track/route.ts
@packages/db/src/services/user-preferences.ts
@packages/db/src/services/site-settings.ts
@apps/web/lib/sanitize-payload.ts
@.planning/phases/58-training-data-golden-dataset/58-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Usage capture with consent gating in track route</name>
  <files>
    apps/web/app/api/track/route.ts
    packages/db/src/services/user-preferences.ts
  </files>
  <action>
1. Update `packages/db/src/services/user-preferences.ts`:
   - The PREFERENCES_DEFAULTS constant needs `trainingDataConsent: false` added to it (to match the updated interface from Plan 01). This ensures getOrCreateUserPreferences merges the new field correctly.

2. Modify `apps/web/app/api/track/route.ts` to add usage capture after the token measurement block:

   a) Add imports at the top:
      - `import { getSiteSettings } from "@everyskill/db/services/site-settings";`
      - `import { getOrCreateUserPreferences } from "@everyskill/db/services/user-preferences";`
      - `import { createTrainingExample } from "@everyskill/db/services/skill-feedback";`
      - `import { sanitizePayload } from "@/lib/sanitize-payload";`

   b) Create a helper function (defined before the POST handler or as a separate async function at module level):
      ```typescript
      async function captureUsageAsTraining(params: {
        tenantId: string;
        userId: string;
        skillId: string;
        inputSnippet: string;
        outputSnippet: string;
      }): Promise<void> {
        try {
          // 1. Check tenant-level setting
          const settings = await getSiteSettings(params.tenantId);
          if (!settings?.trainingDataCaptureEnabled) return;

          // 2. Check per-user consent
          const prefs = await getOrCreateUserPreferences(params.userId, params.tenantId);
          if (!prefs?.trainingDataConsent) return;

          // 3. Sanitize input and output
          const sanitizedInput = sanitizePayload(params.inputSnippet).sanitized;
          const sanitizedOutput = sanitizePayload(params.outputSnippet).sanitized;

          // 4. Insert training example
          await createTrainingExample({
            tenantId: params.tenantId,
            skillId: params.skillId,
            userId: params.userId,
            exampleInput: sanitizedInput,
            exampleOutput: sanitizedOutput,
            source: "usage_capture",
            status: "pending",  // captured examples start as pending for author review
          });
        } catch (err) {
          // Fire-and-forget: log but don't throw
          if (process.env.NODE_ENV === "development") {
            console.error("Failed to capture usage as training data:", err);
          }
        }
      }
      ```

   c) After the token measurement block (after the `if (parsed.data.model_name && ...)` block, around line 97), add:
      ```typescript
      // 7c. Capture usage as training example if consent given (fire-and-forget)
      if (parsed.data.tool_input_snippet && parsed.data.tool_output_snippet) {
        void captureUsageAsTraining({
          tenantId: keyResult.tenantId,
          userId: keyResult.userId,
          skillId: parsed.data.skill_id,
          inputSnippet: parsed.data.tool_input_snippet,
          outputSnippet: parsed.data.tool_output_snippet,
        });
      }
      ```

   The `void` prefix ensures fire-and-forget behavior (same pattern as insertTokenMeasurement). The captureUsageAsTraining function handles all its own error catching internally.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && pnpm build` to confirm TypeScript compiles.
    Verify the track route still works: check that the existing test suite passes (if any), or do a quick manual check that the route doesn't error on normal tracking requests without the snippets.
  </verify>
  <done>
    Track route captures usage as training examples when both tenant trainingDataCaptureEnabled=true AND user trainingDataConsent=true. Captured data is sanitized. Operation is fire-and-forget and does not slow down the tracking response. When either consent is missing, no capture occurs.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes with no TypeScript errors
- Track route POST handler compiles and includes captureUsageAsTraining call
- captureUsageAsTraining checks both tenant setting and user consent before inserting
- sanitizePayload is called on both input and output snippets
- Captured examples use source="usage_capture" and status="pending"
</verification>

<success_criteria>
- Real usage data captured as training_example rows ONLY when dual consent (tenant + user) is present
- Both input and output snippets sanitized before storage
- Fire-and-forget pattern: track route returns 200 before capture completes
- No capture occurs when tenant setting is disabled or user has not opted in
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/58-training-data-golden-dataset/58-03-SUMMARY.md`
</output>
