---
phase: 57-web-feedback-suggestions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/services/skill-feedback.ts
  - packages/db/src/services/notifications.ts
  - packages/db/src/services/index.ts
  - apps/web/app/actions/skill-feedback.ts
autonomous: true

must_haves:
  truths:
    - "Suggestion can be created in DB with category, severity, comment, and tenant/user context"
    - "Suggestion status can be updated (accept, dismiss, implement) with reviewer info"
    - "Author reply can be saved via reviewNotes field"
    - "Notification type union accepts suggestion_received and suggestion_status_changed"
  artifacts:
    - path: "packages/db/src/services/skill-feedback.ts"
      provides: "DB CRUD for suggestions: create, list by skill, update status, add reply"
      exports: ["createSuggestion", "getSuggestionsForSkill", "updateSuggestionStatus", "replySuggestion"]
    - path: "apps/web/app/actions/skill-feedback.ts"
      provides: "Server actions with auth/Zod/sanitize/notifications for submit, update status, reply"
      exports: ["submitSuggestion", "updateSuggestionStatus", "replySuggestion"]
  key_links:
    - from: "apps/web/app/actions/skill-feedback.ts"
      to: "packages/db/src/services/skill-feedback.ts"
      via: "import createSuggestion, updateSuggestionStatus, replySuggestion"
      pattern: "import.*from.*skill-feedback"
    - from: "apps/web/app/actions/skill-feedback.ts"
      to: "packages/db/src/services/notifications.ts"
      via: "createNotification with suggestion types"
      pattern: "createNotification.*suggestion"
---

<objective>
Build the backend layer for skill suggestions: DB service, server actions, and notification type extensions.

Purpose: All data operations (create suggestion, list, update status, reply) must exist before UI components can be wired.
Output: Working DB service + server actions that UI plans (57-02, 57-03) will consume.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@packages/db/src/schema/skill-feedback.ts
@apps/web/app/actions/ratings.ts
@packages/db/src/services/notifications.ts
@packages/db/src/services/index.ts
@apps/web/lib/sanitize-payload.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB service and notification type extension</name>
  <files>
    packages/db/src/services/skill-feedback.ts
    packages/db/src/services/notifications.ts
    packages/db/src/services/index.ts
  </files>
  <action>
1. Create `packages/db/src/services/skill-feedback.ts` with these functions:

**createSuggestion(params)**: Insert into `skillFeedback` with `feedbackType: "suggestion"`, `status: "pending"`, `source: "web"`. Store category and severity as JSON in `suggestedDiff` field: `JSON.stringify({ category, severity })`. Return the inserted row id or null.

Params interface:
```
{ tenantId, skillId, userId, category, severity, comment, suggestedContent? }
```

**getSuggestionsForSkill(skillId)**: Select from `skillFeedback` where `feedbackType = "suggestion"` and `skillId` matches, joined with `users` table to get submitter name/image. Also join `users` for `reviewedBy` to get reviewer name. Order by `createdAt` desc. Return array with: id, userId, comment, suggestedContent, suggestedDiff (parse JSON for category/severity), status, reviewNotes, reviewedBy, reviewedAt, createdAt, user (name, image), reviewer (name).

**updateSuggestionStatus(params)**: Update `skillFeedback` row by id. Set `status`, `reviewedBy`, `reviewedAt: new Date()`. Enforce valid transitions:
- pending -> accepted | dismissed
- accepted -> implemented | dismissed
- dismissed -> pending (reopen)
Return `{ success: boolean, error?: string }`.

Params: `{ id, status, reviewerId }`

**replySuggestion(params)**: Update `skillFeedback` row by id. Set `reviewNotes`, `reviewedBy`, `reviewedAt: new Date()`. Does NOT change status. Return `{ success: boolean }`.

Params: `{ id, reviewNotes, reviewerId }`

2. Add `"suggestion_received"` and `"suggestion_status_changed"` to the `CreateNotificationParams.type` union in `packages/db/src/services/notifications.ts`.

3. Export the new functions from `packages/db/src/services/index.ts`:
```typescript
export {
  createSuggestion,
  getSuggestionsForSkill,
  updateSuggestionStatus,
  replySuggestion,
  type SuggestionWithUser,
} from "./skill-feedback";
```
  </action>
  <verify>Run `cd /home/dev/projects/relay && pnpm build --filter @everyskill/db` to verify TypeScript compiles without errors.</verify>
  <done>DB service exports 4 functions. Notification type union includes suggestion types. Services index re-exports everything. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Server actions for submit, update status, and reply</name>
  <files>
    apps/web/app/actions/skill-feedback.ts
  </files>
  <action>
Create `apps/web/app/actions/skill-feedback.ts` with `"use server"` directive. Follow the exact pattern from `ratings.ts`: auth check, tenant check, Zod validation, DB operation, notification, revalidatePath.

**submitSuggestion(prevState, formData)**:
- Zod schema: `{ skillId: string, skillSlug: string, category: enum("output_quality","missing_feature","error","performance","other"), severity: enum("nice_to_have","important","critical"), comment: string min(10) max(2000), suggestedContent: string max(5000) optional }`
- Auth + tenant guard (return error messages if missing)
- Sanitize `comment` and `suggestedContent` via `sanitizePayload()` from `@/lib/sanitize-payload`
- Call `createSuggestion()` from DB service
- Query skill to get `authorId` and `name` for notification
- Fire-and-forget `createNotification()` to author with type `"suggestion_received"` (skip if user IS the author), title: `New suggestion on ${skillName}`, message includes severity and comment excerpt, actionUrl: `/skills/${skillSlug}`
- `revalidatePath(/skills/${skillSlug})`
- Return `{ success: true, message: "Suggestion submitted" }`

State type: `SuggestionState = { errors?: Record<string, string[]>; message?: string; success?: boolean }`

**updateSuggestionStatus(prevState, formData)**:
- Zod schema: `{ feedbackId: string, skillSlug: string, newStatus: enum("accepted","dismissed","implemented","pending") }`
- Auth + tenant guard
- Query the suggestion row to get userId (the suggester) and skillId
- Query skill to verify current user is author (or admin). Return error if not authorized.
- Call `updateSuggestionStatus()` from DB service
- Fire-and-forget `createNotification()` to the SUGGESTER (not author) with type `"suggestion_status_changed"`, title: `Your suggestion was ${statusLabel}`, actionUrl: `/skills/${skillSlug}`. Skip if suggester is the current user.
- `revalidatePath(/skills/${skillSlug})`
- Return success/error state

**replySuggestion(prevState, formData)**:
- Zod schema: `{ feedbackId: string, skillSlug: string, reviewNotes: string min(1) max(2000) }`
- Auth + tenant guard
- Query skill via the suggestion's skillId to verify current user is author. Return error if not.
- Sanitize `reviewNotes` via `sanitizePayload()`
- Call `replySuggestion()` from DB service
- Fire-and-forget `createNotification()` to the SUGGESTER with type `"suggestion_status_changed"`, title: `Author replied to your suggestion`, actionUrl: `/skills/${skillSlug}`
- `revalidatePath(/skills/${skillSlug})`
- Return success state

Import `isAdmin` from `@/lib/admin` for the authorization check on updateSuggestionStatus. Both author and admin can perform status updates.

Do NOT re-export types from this "use server" file. Export types directly: `export type SuggestionState`, `export type StatusUpdateState`, `export type ReplyState`.
  </action>
  <verify>Run `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` to verify server actions compile. If that is too slow, run `pnpm build` from the monorepo root.</verify>
  <done>Three server actions exist with proper auth, Zod validation, sanitization, DB calls, notifications, and path revalidation. TypeScript compiles.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes from monorepo root (both packages/db and apps/web compile)
- No TypeScript errors in new files
- Notification type union in notifications.ts includes `"suggestion_received" | "suggestion_status_changed"`
- DB service functions are exported from `packages/db/src/services/index.ts`
</verification>

<success_criteria>
- DB service has createSuggestion, getSuggestionsForSkill, updateSuggestionStatus, replySuggestion
- Server actions have submitSuggestion, updateSuggestionStatus, replySuggestion with proper auth/validation/notification
- Category stored as JSON in suggestedDiff field (no migrations)
- Valid status transitions enforced: pending->accepted|dismissed, accepted->implemented|dismissed, dismissed->pending
- All user text sanitized before storage
- Author notified on new suggestion, suggester notified on status change
- Everything builds clean
</success_criteria>

<output>
After completion, create `.planning/phases/57-web-feedback-suggestions/57-01-SUMMARY.md`
</output>
