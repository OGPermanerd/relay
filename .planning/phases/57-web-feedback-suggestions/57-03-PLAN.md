---
phase: 57-web-feedback-suggestions
plan: 03
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - apps/web/components/suggestion-list.tsx
  - apps/web/components/suggestion-card.tsx
  - apps/web/app/(protected)/skills/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Author sees all suggestions for their skill with Accept, Dismiss, and Reply actions"
    - "Non-author users see their own suggestions with current status"
    - "Suggestion status is displayed with colored badge (Open/Accepted/Dismissed/Implemented)"
    - "Author can reply with text via reviewNotes and suggester sees the reply"
    - "Status transitions trigger notifications to the suggester"
  artifacts:
    - path: "apps/web/components/suggestion-list.tsx"
      provides: "Server-data-driven list of suggestion cards, author vs non-author view"
      min_lines: 30
    - path: "apps/web/components/suggestion-card.tsx"
      provides: "Individual suggestion with status badge, severity badge, category label, author action buttons"
      min_lines: 80
  key_links:
    - from: "apps/web/components/suggestion-card.tsx"
      to: "apps/web/app/actions/skill-feedback.ts"
      via: "updateSuggestionStatus and replySuggestion server actions"
      pattern: "updateSuggestionStatus|replySuggestion"
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "apps/web/components/suggestion-list.tsx"
      via: "passes serialized suggestions and isAuthor flag"
      pattern: "SuggestionList"
---

<objective>
Build the suggestion list and card components with author review actions (Accept/Dismiss/Reply), and wire them into the skill detail page.

Purpose: Authors need to see and act on pending suggestions. Suggesters need to see the status of their submissions.
Output: Complete suggestion review workflow visible on the Suggestions tab.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@apps/web/components/admin-review-detail.tsx
@apps/web/app/actions/skill-feedback.ts
@.planning/phases/57-web-feedback-suggestions/57-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Suggestion card and list components</name>
  <files>
    apps/web/components/suggestion-card.tsx
    apps/web/components/suggestion-list.tsx
  </files>
  <action>
**1. Create `apps/web/components/suggestion-card.tsx`** ("use client"):

Props interface:
```typescript
interface SuggestionCardProps {
  suggestion: {
    id: string;
    userId: string | null;
    comment: string | null;
    suggestedContent: string | null;
    category: string;  // parsed from suggestedDiff JSON
    severity: string;  // parsed from suggestedDiff JSON
    status: string;
    reviewNotes: string | null;
    reviewedAt: string | null;  // ISO string
    createdAt: string;          // ISO string
    user: { name: string | null; image: string | null } | null;
    reviewer: { name: string | null } | null;
  };
  isAuthor: boolean;        // skill author, not suggestion author
  currentUserId?: string;
  skillSlug: string;
}
```

Layout (single card, bordered, rounded):
- **Header row**: User name (or "Anonymous"), relative time (manual UTC formatting -- compute "X days ago" from createdAt ISO string, do NOT use toLocaleDateString), status badge, severity badge
- **Category label**: Rendered from CATEGORY_LABELS map (e.g., "Output Quality", "Missing Feature")
- **Comment body**: The suggestion text
- **Suggested content** (if provided): Show in a gray-bg code block or quoted section
- **Author reply** (if reviewNotes exists): Show in a blue-tinted box with reviewer name and reviewedAt date

Status badge colors (use inline Tailwind classes):
- pending: `bg-yellow-100 text-yellow-700` label "Open"
- accepted: `bg-green-100 text-green-700` label "Accepted"
- dismissed: `bg-gray-100 text-gray-600` label "Dismissed"
- implemented: `bg-blue-100 text-blue-700` label "Implemented"

Severity badge colors:
- nice_to_have: `bg-gray-100 text-gray-600` label "Nice to Have"
- important: `bg-amber-100 text-amber-700` label "Important"
- critical: `bg-red-100 text-red-700` label "Critical"

**Author actions** (shown only when `isAuthor` is true):
- Use `useState` for pending state per action type (same pattern as admin-review-detail.tsx lines 151-231)
- Import `updateSuggestionStatus` and `replySuggestion` from `@/app/actions/skill-feedback`
- Use `useActionState` for each action OR direct `useState` + async handler (follow the admin-review-detail pattern with useState + try/catch + router.refresh)

Actions when status is "pending":
- **Accept** button (green): calls updateSuggestionStatus with newStatus="accepted"
- **Dismiss** button (gray): calls updateSuggestionStatus with newStatus="dismissed"
- **Reply** button (blue): toggles a textarea for reviewNotes, submit calls replySuggestion

Actions when status is "accepted":
- **Mark Implemented** button (blue): calls updateSuggestionStatus with newStatus="implemented"
- **Dismiss** button (gray): still available

Actions when status is "dismissed":
- **Reopen** button (yellow): calls updateSuggestionStatus with newStatus="pending"

Use `useRouter` from `next/navigation` for `router.refresh()` after successful actions.

Hidden form fields for each action: `feedbackId`, `skillSlug`, `newStatus` (for status updates) or `reviewNotes` (for reply).

Each action button shows a loading spinner/text when that specific action is pending.

For the Reply action: show a collapsible textarea (toggle with useState). Reply textarea requires at least 1 character. Submit button says "Send Reply" / "Sending...".

**2. Create `apps/web/components/suggestion-list.tsx`** ("use client"):

Props:
```typescript
interface SuggestionListProps {
  suggestions: SuggestionCardProps["suggestion"][];
  isAuthor: boolean;
  currentUserId?: string;
  skillSlug: string;
}
```

Behavior:
- If `isAuthor`: show ALL suggestions, sorted by status (pending first, then accepted, then implemented, then dismissed) within each group by createdAt desc
- If NOT `isAuthor` and `currentUserId`: show only suggestions where `suggestion.userId === currentUserId`. Show message "You haven't submitted any suggestions yet" if none.
- If no currentUserId (not logged in): show nothing (the form already handles this case)

Render each suggestion as a `<SuggestionCard>`.

If no suggestions to show (author with empty list): "No suggestions yet."

Add a simple filter/tab bar at the top for authors: "All", "Open", "Accepted", "Dismissed", "Implemented" using useState. Default to "All". Filter suggestions by status before rendering.
  </action>
  <verify>Run `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` to verify TypeScript compiles.</verify>
  <done>Suggestion list renders cards with status/severity badges. Author sees action buttons. Non-author sees only their own suggestions. Compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Wire suggestion list into skill detail page</name>
  <files>
    apps/web/app/(protected)/skills/[slug]/page.tsx
  </files>
  <action>
Update the skill detail page to pass the suggestion list into the Suggestions tab content.

1. Add import: `import { SuggestionList } from "@/components/suggestion-list";`

2. The `suggestions` data was already fetched in Plan 57-02 (or needs to be added if executing this plan standalone). Ensure `getSuggestionsForSkill(skill.id)` is in the Promise.all block.

3. Serialize suggestions for client components: map each suggestion to convert Date fields to ISO strings:
```typescript
const serializedSuggestions = suggestions.map(s => ({
  ...s,
  createdAt: s.createdAt.toISOString(),
  reviewedAt: s.reviewedAt?.toISOString() ?? null,
  // Parse category/severity from suggestedDiff JSON
  category: (() => { try { return JSON.parse(s.suggestedDiff || "{}").category || "other"; } catch { return "other"; } })(),
  severity: (() => { try { return JSON.parse(s.suggestedDiff || "{}").severity || "nice_to_have"; } catch { return "nice_to_have"; } })(),
}));
```

4. Update the `suggestionsContent` prop on `<SkillDetailTabs>` to include the SuggestionList below the form:

```tsx
suggestionsContent={
  <div className="space-y-6">
    {session?.user && (
      <SuggestionForm skillId={skill.id} skillSlug={skill.slug} />
    )}
    <SuggestionList
      suggestions={serializedSuggestions}
      isAuthor={isAuthor}
      currentUserId={session?.user?.id}
      skillSlug={skill.slug}
    />
    {!session?.user && (
      <p className="text-sm text-gray-500">Sign in to submit and view suggestions.</p>
    )}
  </div>
}
```

NOTE: This task modifies the same file as Plan 57-02 Task 2. If running after 57-02, integrate into existing changes. If running standalone (57-02 not yet done), add all wiring from scratch including the SuggestionForm, tab props, and imports from 57-02's scope.

5. Ensure `isAuthor` variable (already computed as `isAuthorOfSkill` in the page) is passed correctly.
  </action>
  <verify>
Run `cd /home/dev/projects/relay && pnpm build` to verify full build.
Run the relevant Playwright E2E test if one exists for the skills page: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/skills.spec.ts` (if it exists). Otherwise note the gap.
  </verify>
  <done>Skill detail page shows suggestion list below the form on the Suggestions tab. Authors see all suggestions with action buttons. Non-authors see only their own. Build passes.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- Author views skill page -> sees all suggestions with Accept/Dismiss/Reply buttons
- Non-author views skill page -> sees only their own suggestions with status badges
- Accept/Dismiss actions update status and show in the UI after refresh
- Reply saves reviewNotes and displays below the suggestion
- Status badges use correct colors for each state
- No hydration errors (all dates serialized as ISO strings)
</verification>

<success_criteria>
- Author can Accept, Dismiss, and Reply to suggestions
- Status tracks through lifecycle: pending -> accepted -> implemented, or pending -> dismissed -> pending (reopen)
- Suggester sees their suggestion status change
- Author reply text appears on the suggestion card
- Filter bar lets author filter by status
- All notifications fire correctly on status changes
- Complete build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/57-web-feedback-suggestions/57-03-SUMMARY.md`
</output>
