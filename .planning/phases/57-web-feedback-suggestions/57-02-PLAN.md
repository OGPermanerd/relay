---
phase: 57-web-feedback-suggestions
plan: 02
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - apps/web/components/suggestion-form.tsx
  - apps/web/components/skill-detail-tabs.tsx
  - apps/web/app/(protected)/skills/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can submit an improvement suggestion with category, severity, and description"
    - "Suggestions tab appears on skill detail page with pending count badge"
    - "Form shows success/error feedback after submission"
    - "Suggestion form is only visible to authenticated users"
  artifacts:
    - path: "apps/web/components/suggestion-form.tsx"
      provides: "Client form with category select, severity select, comment textarea, optional suggested content"
      min_lines: 60
    - path: "apps/web/components/skill-detail-tabs.tsx"
      provides: "Extended tabs with Suggestions tab and count badge"
      contains: "suggestions"
    - path: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      provides: "Fetches suggestions, passes to tabs and form"
      contains: "getSuggestionsForSkill"
  key_links:
    - from: "apps/web/components/suggestion-form.tsx"
      to: "apps/web/app/actions/skill-feedback.ts"
      via: "useActionState(submitSuggestion)"
      pattern: "useActionState.*submitSuggestion"
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "packages/db/src/services/skill-feedback.ts"
      via: "getSuggestionsForSkill import"
      pattern: "getSuggestionsForSkill"
---

<objective>
Build the suggestion submission form and wire the Suggestions tab into the skill detail page.

Purpose: Users need a way to submit structured improvement suggestions (category + severity + comment) on any skill detail page.
Output: Working suggestion form on a new "Suggestions" tab of the skill detail page.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@apps/web/components/skill-detail-tabs.tsx
@apps/web/app/(protected)/skills/[slug]/page.tsx
@apps/web/components/rating-form.tsx
@.planning/phases/57-web-feedback-suggestions/57-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Suggestion form component and tab extension</name>
  <files>
    apps/web/components/suggestion-form.tsx
    apps/web/components/skill-detail-tabs.tsx
  </files>
  <action>
**1. Create `apps/web/components/suggestion-form.tsx`** ("use client"):

Follow the `rating-form.tsx` pattern exactly:
- `useActionState(submitSuggestion, initialState)` from react
- Import `submitSuggestion` and `SuggestionState` from `@/app/actions/skill-feedback`
- Hidden inputs for `skillId` and `skillSlug`
- Props: `{ skillId: string, skillSlug: string }`

Form fields:
- **Category** (`<select name="category">`): Options: "Output Quality", "Missing Feature", "Error", "Performance", "Other" with values: output_quality, missing_feature, error, performance, other. Required.
- **Severity** (`<select name="severity">`): Options: "Nice to Have", "Important", "Critical" with values: nice_to_have, important, critical. Required.
- **Description** (`<textarea name="comment">` rows=4): Placeholder "Describe your suggestion in detail...", required, min 10 chars. Show char count.
- **Suggested Content** (`<textarea name="suggestedContent">` rows=3): Optional. Placeholder "Optionally provide specific content or wording changes..."

Show field-level errors from `state.errors` (same pattern as rating-form).
Show success message in green bg when `state.success` is true.
Show error message in red bg when `state.message` exists and `!state.success`.
Submit button: "Submit Suggestion" / "Submitting..." when isPending.

Style with Tailwind matching existing form patterns: `rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100`.

Select elements should use the same styling as text inputs.

**2. Extend `apps/web/components/skill-detail-tabs.tsx`**:

- Add `"suggestions"` to `TabKey` union type
- Add `suggestionsContent: ReactNode` and `suggestionCount?: number` props
- Add tab entry: `{ key: "suggestions", label: "Suggestions" }` with badge showing count if > 0: render as `Suggestions (${count})` in the label
- Add tabpanel for suggestions with same hidden/aria pattern as existing panels
- Keep backward compatible: `suggestionsContent` should default to `null` if not provided (make it optional with `?`)
  </action>
  <verify>Run `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` to check TypeScript compiles.</verify>
  <done>Suggestion form renders with category/severity selects, comment textarea, and submit button. Tab bar shows "Suggestions (N)" tab. Both compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Wire suggestions into skill detail page</name>
  <files>
    apps/web/app/(protected)/skills/[slug]/page.tsx
  </files>
  <action>
Modify the skill detail page to fetch suggestions and pass them to the tab system.

1. Add import: `import { getSuggestionsForSkill } from "@everyskill/db/services";`
2. Add import: `import { SuggestionForm } from "@/components/suggestion-form";`

3. In the parallel data fetch block (the big `Promise.all`), add `getSuggestionsForSkill(skill.id)` to fetch suggestions alongside other data. Destructure the result as `suggestions`.

4. Compute `pendingSuggestionCount` = count of suggestions where `status === "pending"`.

5. Update the `<SkillDetailTabs>` component usage to pass `suggestionCount={pendingSuggestionCount}` and `suggestionsContent`:

```tsx
<SkillDetailTabs
  aiReviewContent={...existing...}
  suggestionsContent={
    <div className="space-y-6">
      {session?.user && (
        <SuggestionForm skillId={skill.id} skillSlug={skill.slug} />
      )}
      {/* Suggestion list will be added in Plan 57-03 */}
      {!session?.user && (
        <p className="text-sm text-gray-500">Sign in to submit suggestions.</p>
      )}
    </div>
  }
  suggestionCount={pendingSuggestionCount}
>
```

The suggestion list component (showing existing suggestions with author actions) will be added in Plan 57-03. For now, only the form and a placeholder message for the list are needed.

Serialize suggestion dates: map suggestions to convert `createdAt` and `reviewedAt` to ISO strings before passing to any client component (avoid hydration mismatch).

Do NOT use `toLocaleDateString()` -- use ISO strings and format in client components with manual UTC formatting if needed.
  </action>
  <verify>
Run `cd /home/dev/projects/relay && pnpm build` to verify the full build passes.
Then start dev server and verify the Suggestions tab appears on a skill detail page: `curl -s http://localhost:2002/skills | head -50` (or navigate manually).
  </verify>
  <done>Skill detail page shows a "Suggestions" tab. Authenticated users see the suggestion form. Pending suggestion count shows in tab label. Build passes.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- Skill detail page renders with 3 tabs: Details, AI Review, Suggestions
- Suggestion form has category select, severity select, comment textarea, submit button
- Form submits via useActionState and shows success/error feedback
- Tab badge shows pending count when suggestions exist
</verification>

<success_criteria>
- User can see and interact with the suggestion form on the Suggestions tab
- Category dropdown has 5 options, severity dropdown has 3 options
- Form validates and shows field errors
- Successful submission shows green success message
- Tab label shows "(N)" badge for pending suggestions
- Everything builds and renders without hydration errors
</success_criteria>

<output>
After completion, create `.planning/phases/57-web-feedback-suggestions/57-02-SUMMARY.md`
</output>
