---
phase: 21-employee-usage-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mcp/src/auth.ts
  - apps/mcp/src/tools/search.ts
  - apps/mcp/src/tools/list.ts
  - apps/mcp/src/tools/deploy.ts
  - apps/mcp/src/index.ts
autonomous: true

must_haves:
  truths:
    - "When RELAY_API_KEY is set, trackUsage() calls include userId"
    - "When no RELAY_API_KEY, tools work identically to before (anonymous)"
    - "Every 5th anonymous use appends a nudge message to tool response"
    - "First authenticated use shows confirmation message"
  artifacts:
    - path: "apps/mcp/src/auth.ts"
      provides: "userId resolution from API key + nudge counter"
      exports: ["resolveUserId", "getUserId", "shouldNudge", "incrementAnonymousCount", "getFirstAuthMessage"]
  key_links:
    - from: "apps/mcp/src/auth.ts"
      to: "@relay/db/services/api-keys"
      via: "validateApiKey import"
      pattern: "validateApiKey"
    - from: "apps/mcp/src/tools/search.ts"
      to: "apps/mcp/src/auth.ts"
      via: "getUserId() in trackUsage call"
      pattern: "getUserId\\(\\)"
---

<objective>
Wire MCP tool calls to employee identity via API key resolution.

Purpose: Every MCP tool call gets attributed to the employee who made it (TRK-01, TRK-02, TRK-03).
Output: auth.ts module + updated tool handlers passing userId to trackUsage().
</objective>

<context>
@apps/mcp/src/tracking/events.ts
@apps/mcp/src/tools/search.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MCP auth module and wire userId into tools</name>
  <files>apps/mcp/src/auth.ts, apps/mcp/src/tools/search.ts, apps/mcp/src/tools/list.ts, apps/mcp/src/tools/deploy.ts, apps/mcp/src/index.ts</files>
  <action>
1. Create `apps/mcp/src/auth.ts`:
   - Import `validateApiKey` from `@relay/db/services/api-keys`
   - `resolveUserId()`: reads `process.env.RELAY_API_KEY`, calls `validateApiKey()`, caches result in module-scoped `cachedUserId`. Uses `resolved` flag so it runs at most once. Returns `string | null`. Use `console.error` for ALL logging (never console.log -- corrupts stdio).
   - `getUserId()`: returns `cachedUserId` (sync getter)
   - `anonymousCallCount` module var, `incrementAnonymousCount()` returns ++count
   - `shouldNudge()`: returns true when `cachedUserId === null && anonymousCallCount > 0 && anonymousCallCount % 5 === 0`
   - `getFirstAuthMessage()`: tracks `firstAuthShown` flag. If `cachedUserId` is not null and flag is false, sets flag to true and returns `"Tracking active for your account"`. Otherwise returns null.

2. Update `apps/mcp/src/index.ts`:
   - Import `resolveUserId` from `./auth.js`
   - Call `await resolveUserId()` at start of `main()`, BEFORE `server.connect(transport)` so userId is ready for first tool call. This is fast (single DB query) and fails gracefully.

3. Update each tool handler (search.ts, list.ts, deploy.ts):
   - Import `getUserId`, `shouldNudge`, `incrementAnonymousCount`, `getFirstAuthMessage` from `../auth.js`
   - In each handler, BEFORE the return: if `getUserId()` is null, call `incrementAnonymousCount()`
   - Add `userId: getUserId()` to existing `trackUsage()` call
   - After building `content` array, check `getFirstAuthMessage()` -- if non-null, push text content item with the message
   - Check `shouldNudge()` -- if true, push text content item: `"\n---\nTip: Set RELAY_API_KEY to track your personal skill leverage. Generate one at your Relay profile page."`
  </action>
  <verify>
`cd /home/dev/projects/relay && npx tsc --noEmit -p apps/mcp/tsconfig.json` compiles without errors.
Grep auth.ts for `console.log` -- must find zero matches.
Grep all 3 tool files for `getUserId()` -- must find matches in each.
  </verify>
  <done>
auth.ts exports resolveUserId/getUserId/shouldNudge/incrementAnonymousCount/getFirstAuthMessage. All 3 tool handlers pass userId to trackUsage() and append nudge/first-auth messages when appropriate. Anonymous users see no change except periodic nudge.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles: `npx tsc --noEmit -p apps/mcp/tsconfig.json`
- No console.log in MCP src: `grep -r "console.log" apps/mcp/src/` returns 0 matches
- userId wired: `grep -r "getUserId" apps/mcp/src/tools/` shows all 3 files
</verification>

<success_criteria>
MCP auth module resolves API key to userId at startup. All tool handlers include userId in trackUsage(). Anonymous mode works identically to before. Nudge appears every 5th anonymous call. First-auth confirmation appears once.
</success_criteria>

<output>
After completion, create `.planning/phases/21-employee-usage-tracking/21-01-SUMMARY.md`
</output>
