---
phase: 21-employee-usage-tracking
plan: 03
type: execute
wave: 2
depends_on: ["21-02"]
files_modified:
  - apps/web/lib/install-script.ts
autonomous: true

must_haves:
  truths:
    - "Bash install script sends POST to /api/install-callback after config setup"
    - "PowerShell install script sends POST to /api/install-callback after config setup"
    - "Callback failure is silent -- install succeeds regardless"
    - "Callback includes platform and OS"
  artifacts:
    - path: "apps/web/lib/install-script.ts"
      provides: "Updated install scripts with callback"
      contains: "install-callback"
  key_links:
    - from: "apps/web/lib/install-script.ts"
      to: "/api/install-callback"
      via: "curl/Invoke-WebRequest in generated script"
      pattern: "install-callback"
---

<objective>
Add install callback to generated install scripts so confirmed installations are tracked.

Purpose: Install scripts phone home after successful setup (INST-01).
Output: Updated generateInstallScript() with curl/Invoke-WebRequest callback.
</objective>

<context>
@apps/web/lib/install-script.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add callback to install scripts</name>
  <files>apps/web/lib/install-script.ts</files>
  <action>
1. Update `generateInstallScript` signature to accept `baseUrl: string` parameter (the Relay server URL, e.g., from `process.env.NEXTAUTH_URL`).

2. In the bash script content, add BEFORE the success echo lines:
```
# Report install to Relay (non-blocking, failure OK)
EVERYSKILL_API_KEY=""
if [ -f "$CONFIG_FILE" ]; then
  EVERYSKILL_API_KEY=$(node -e "try{const c=JSON.parse(require('fs').readFileSync(process.argv[1],'utf8'));const s=c.mcpServers&&c.mcpServers['everyskill-skills'];if(s&&s.env&&s.env.EVERYSKILL_API_KEY)console.log(s.env.EVERYSKILL_API_KEY)}catch{}" "$CONFIG_FILE" 2>/dev/null || true)
fi
curl -s -X POST "${baseUrl}/api/install-callback" \
  -H "Content-Type: application/json" \
  -d "{\"key\":\"${EVERYSKILL_API_KEY}\",\"platform\":\"claude-desktop\",\"os\":\"$(uname -s | tr '[:upper:]' '[:lower:]')\"}" \
  > /dev/null 2>&1 || true
```
Note: Use the `baseUrl` parameter interpolated into the script string literal. The key extraction from config is best-effort -- if no API key is configured yet, callback still works (anonymous).

3. In the PowerShell script content, add BEFORE the Write-Host success lines:
```
# Report install to Relay (non-blocking, failure OK)
try {
  $ApiKey = ""
  if (Test-Path $ConfigFile) {
    $Config = Get-Content $ConfigFile -Raw | ConvertFrom-Json
    if ($Config.mcpServers.'everyskill-skills'.env.EVERYSKILL_API_KEY) {
      $ApiKey = $Config.mcpServers.'everyskill-skills'.env.EVERYSKILL_API_KEY
    }
  }
  $Body = @{ key = $ApiKey; platform = "claude-desktop"; os = "windows" } | ConvertTo-Json
  Invoke-WebRequest -Uri "${baseUrl}/api/install-callback" -Method POST -ContentType "application/json" -Body $Body -UseBasicParsing | Out-Null
} catch { }
```

4. Update all callers of `generateInstallScript` to pass `baseUrl`. Search for `generateInstallScript(` to find callers and add the parameter.
  </action>
  <verify>
`cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json` compiles.
Grep install-script.ts for "install-callback" -- must find matches in both script templates.
  </verify>
  <done>
Both bash and PowerShell install scripts include callback to /api/install-callback. Failure is silenced. API key is extracted from config if available.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles
- Both script templates contain "install-callback" string
- Callers updated to pass baseUrl parameter
</verification>

<success_criteria>
Generated install scripts POST to /api/install-callback after config setup. Callback includes platform, OS, and API key if available. Failure does not block installation.
</success_criteria>

<output>
After completion, create `.planning/phases/21-employee-usage-tracking/21-03-SUMMARY.md`
</output>
