---
phase: 21-employee-usage-tracking
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/api/install-callback/route.ts
  - apps/web/middleware.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/install-callback accepts JSON with key/skillId/platform/os and returns 200"
    - "Install callback works without Auth.js session (middleware exemption)"
    - "Valid API key resolves to userId; missing/invalid key still records event with null userId"
    - "Event recorded as toolName 'install_confirmed' distinguishing from 'deploy_skill'"
  artifacts:
    - path: "apps/web/app/api/install-callback/route.ts"
      provides: "Install callback POST handler"
      exports: ["POST"]
    - path: "apps/web/middleware.ts"
      provides: "Auth exemption for /api/install-callback"
      contains: "install-callback"
  key_links:
    - from: "apps/web/app/api/install-callback/route.ts"
      to: "@relay/db/services/api-keys"
      via: "validateApiKey for userId resolution"
      pattern: "validateApiKey"
---

<objective>
Create install callback endpoint so install scripts can report confirmed installations.

Purpose: Distinguish deploy intent (MCP deploy_skill) from confirmed installation (INST-01, INST-02, INST-03).
Output: POST /api/install-callback route + middleware exemption.
</objective>

<context>
@apps/web/app/api/auth/validate-key/route.ts
@apps/web/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create install-callback route and middleware exemption</name>
  <files>apps/web/app/api/install-callback/route.ts, apps/web/middleware.ts</files>
  <action>
1. Create `apps/web/app/api/install-callback/route.ts`:
   - Follow the exact pattern from `apps/web/app/api/auth/validate-key/route.ts`
   - POST handler: parse JSON body with try/catch (return 400 on invalid JSON)
   - Extract `{ key, skillId, platform, os, clientVersion }` from body
   - If `key` is a non-empty string, call `validateApiKey(key)` to get userId. If invalid/missing, userId = null (no error -- anonymous installs are valid)
   - Import `db` from `@relay/db`, `usageEvents` from `@relay/db/schema`
   - Insert into usageEvents: `{ toolName: "install_confirmed", skillId: (string or null), userId, metadata: { platform, os, clientVersion, source: "install-script" } }`
   - Also import and call `incrementSkillUses(skillId)` from `@relay/db/services/skill-metrics` when skillId is provided (same pattern as trackUsage in MCP)
   - Return `NextResponse.json({ ok: true })` on success
   - Wrap DB operations in try/catch, return 500 on DB errors

2. Update `apps/web/middleware.ts`:
   - Add: `const isInstallCallback = req.nextUrl.pathname.startsWith("/api/install-callback");`
   - Update the early return condition: `if (isAuthApi || isDevLogin || isInstallCallback) { return; }`
   - Add after existing `isDevLogin` line, before the if-block
  </action>
  <verify>
`cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json` compiles.
`curl -s -X POST http://localhost:3000/api/install-callback -H "Content-Type: application/json" -d '{"platform":"test","os":"linux"}' | grep ok` returns `"ok":true` (if dev server running).
  </verify>
  <done>
POST /api/install-callback records install events with optional userId resolution. Middleware allows unauthenticated access. toolName "install_confirmed" distinguishes from "deploy_skill" events.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles: `npx tsc --noEmit -p apps/web/tsconfig.json`
- Middleware exempts install-callback: grep middleware.ts for "install-callback"
- Route file exists and exports POST
</verification>

<success_criteria>
Install callback endpoint accepts POST with platform/os/key/skillId, records usage event with toolName "install_confirmed", resolves userId from API key when provided, works without session auth.
</success_criteria>

<output>
After completion, create `.planning/phases/21-employee-usage-tracking/21-02-SUMMARY.md`
</output>
