---
phase: 10-quality-scorecards
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - apps/web/lib/search-skills.ts
  - apps/web/components/quality-filter.tsx
  - apps/web/components/sort-dropdown.tsx
  - apps/web/app/(protected)/skills/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can filter skills by quality tier (Gold, Silver, Bronze)"
    - "User can sort skills by quality score"
    - "Filters update URL for shareable links"
  artifacts:
    - path: "apps/web/components/quality-filter.tsx"
      provides: "Quality tier filter dropdown"
      exports: ["QualityFilter"]
    - path: "apps/web/components/sort-dropdown.tsx"
      provides: "Sort options including quality"
      exports: ["SortDropdown"]
    - path: "apps/web/lib/search-skills.ts"
      provides: "Backend filter and sort by quality"
      contains: "qualityTier"
  key_links:
    - from: "apps/web/app/(protected)/skills/page.tsx"
      to: "apps/web/lib/search-skills.ts"
      via: "passes quality filter params"
      pattern: "qualityTier|sortBy"
    - from: "apps/web/components/quality-filter.tsx"
      to: "URL searchParams"
      via: "updates URL state"
      pattern: "useRouter|useSearchParams"
---

<objective>
Add quality tier filtering and quality score sorting to the browse page.

Purpose: Users can quickly find high-quality skills (QUAL-03 requirement).
Output: Filter dropdown for quality tiers and sort option for quality score.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-quality-scorecards/10-CONTEXT.md
@apps/web/lib/search-skills.ts
@apps/web/app/(protected)/skills/page.tsx
@apps/web/components/category-filter.tsx
@apps/web/lib/quality-score.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add quality filter and sort to searchSkills</name>
  <files>apps/web/lib/search-skills.ts</files>
  <action>
Extend searchSkills to support quality tier filtering and sorting.

1. Update SearchParams interface:
   ```typescript
   export interface SearchParams {
     query?: string;
     category?: string;
     tags?: string[];
     qualityTier?: "gold" | "silver" | "bronze";  // Filter by tier
     sortBy?: "uses" | "quality" | "rating";      // Sort option
   }
   ```

2. Add quality tier filtering:
   The challenge: Quality tier requires computation from multiple fields.

   Approach: Use a SQL CASE expression to compute tier in the query.

   ```typescript
   // Add computed quality score as a SQL expression
   const qualityScoreSql = sql<number>`
     CASE
       WHEN (SELECT count(*) FROM ratings WHERE skill_id = ${skills.id}) < 3 THEN -1
       ELSE (
         LEAST(${skills.totalUses} / 100.0, 1) * 50 +
         COALESCE(${skills.averageRating} / 500.0, 0) * 35 +
         CASE WHEN ${skills.description} != '' AND ${skills.category} != '' THEN 15 ELSE 0 END
       )
     END
   `;
   ```

3. Add tier filter condition:
   ```typescript
   if (params.qualityTier) {
     const tierThresholds = {
       gold: { min: 75, max: 100 },
       silver: { min: 50, max: 74.99 },
       bronze: { min: 25, max: 49.99 },
     };
     const { min, max } = tierThresholds[params.qualityTier];
     conditions.push(sql`${qualityScoreSql} >= ${min} AND ${qualityScoreSql} <= ${max}`);
   }
   ```

4. Add sort by quality:
   ```typescript
   // At the end, modify orderBy logic
   if (params.sortBy === "quality") {
     return filteredQuery.orderBy(sql`${qualityScoreSql} DESC NULLS LAST`);
   } else if (params.sortBy === "rating") {
     return filteredQuery.orderBy(desc(skills.averageRating));
   }
   // Default: orderBy totalUses or search rank (existing logic)
   ```

Note: The subquery for rating count is evaluated per-row. For large datasets, consider denormalizing totalRatings onto the skills table. For v1.1 scale (<1000 skills), this is acceptable.
  </action>
  <verify>Test with curl or browser: `/skills?qualityTier=gold` returns only gold-tier skills</verify>
  <done>searchSkills supports qualityTier filter and sortBy=quality option</done>
</task>

<task type="auto">
  <name>Task 2: Create QualityFilter and SortDropdown components</name>
  <files>apps/web/components/quality-filter.tsx, apps/web/components/sort-dropdown.tsx</files>
  <action>
Create filter and sort UI components.

**QualityFilter** (apps/web/components/quality-filter.tsx):
```tsx
"use client";

import { useRouter, useSearchParams } from "next/navigation";

const QUALITY_OPTIONS = [
  { value: "", label: "All qualities" },
  { value: "gold", label: "Gold" },
  { value: "silver", label: "Silver" },
  { value: "bronze", label: "Bronze" },
];

export function QualityFilter() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const currentTier = searchParams.get("qualityTier") || "";

  const handleChange = (value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) {
      params.set("qualityTier", value);
    } else {
      params.delete("qualityTier");
    }
    router.push(`/skills?${params.toString()}`);
  };

  return (
    <select
      value={currentTier}
      onChange={(e) => handleChange(e.target.value)}
      className="rounded-md border border-gray-300 px-3 py-2 text-sm"
    >
      {QUALITY_OPTIONS.map((opt) => (
        <option key={opt.value} value={opt.value}>
          {opt.label}
        </option>
      ))}
    </select>
  );
}
```

**SortDropdown** (apps/web/components/sort-dropdown.tsx):
```tsx
"use client";

import { useRouter, useSearchParams } from "next/navigation";

const SORT_OPTIONS = [
  { value: "uses", label: "Most Used" },
  { value: "quality", label: "Quality Score" },
  { value: "rating", label: "Highest Rated" },
];

export function SortDropdown() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const currentSort = searchParams.get("sortBy") || "uses";

  const handleChange = (value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value && value !== "uses") {
      params.set("sortBy", value);
    } else {
      params.delete("sortBy"); // uses is default
    }
    router.push(`/skills?${params.toString()}`);
  };

  return (
    <select
      value={currentSort}
      onChange={(e) => handleChange(e.target.value)}
      className="rounded-md border border-gray-300 px-3 py-2 text-sm"
    >
      {SORT_OPTIONS.map((opt) => (
        <option key={opt.value} value={opt.value}>
          {opt.label}
        </option>
      ))}
    </select>
  );
}
```

Both components use Next.js App Router patterns (useSearchParams, useRouter) to update URL state, matching existing patterns like CategoryFilter.
  </action>
  <verify>`npm run build` passes</verify>
  <done>QualityFilter and SortDropdown components created</done>
</task>

<task type="auto">
  <name>Task 3: Integrate filters into browse page</name>
  <files>apps/web/app/(protected)/skills/page.tsx</files>
  <action>
Add quality filter and sort to the skills browse page.

1. Update searchParams type:
   ```typescript
   interface SkillsPageProps {
     searchParams: Promise<{
       q?: string;
       category?: string;
       tags?: string;
       qualityTier?: string;
       sortBy?: string;
     }>;
   }
   ```

2. Parse new parameters:
   ```typescript
   const qualityTier = params.qualityTier as "gold" | "silver" | "bronze" | undefined;
   const sortBy = params.sortBy as "uses" | "quality" | "rating" | undefined;
   ```

3. Pass to searchSkills:
   ```typescript
   const [skills, availableTags] = await Promise.all([
     searchSkills({ query, category, tags, qualityTier, sortBy }),
     getAvailableTags(),
   ]);
   ```

4. Import and render components:
   ```typescript
   import { QualityFilter } from "@/components/quality-filter";
   import { SortDropdown } from "@/components/sort-dropdown";
   ```

5. Add to filter section (after TagFilter):
   ```tsx
   <div className="mb-6 space-y-4">
     <SearchInput />
     <div className="flex flex-wrap items-center gap-4">
       <CategoryFilter />
       <QualityFilter />
       <SortDropdown />
     </div>
     {availableTags.length > 0 && <TagFilter availableTags={availableTags} />}
   </div>
   ```

6. Update hasFilters check:
   ```typescript
   const hasFilters = query || category || tags.length > 0 || qualityTier;
   ```
  </action>
  <verify>Navigate to /skills, verify quality filter and sort dropdown appear and work</verify>
  <done>Browse page includes quality filter and sort options</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Navigate to /skills - filter and sort dropdowns visible
3. Select "Gold" filter - only gold-tier skills shown (or empty if none qualify)
4. Select "Quality Score" sort - skills reorder by quality
5. URL updates with ?qualityTier=gold&sortBy=quality (shareable)
6. Filters combine correctly (category + quality + search)
</verification>

<success_criteria>
- Quality tier filter works for Gold, Silver, Bronze
- Sort by quality score orders skills correctly
- URL state persists across page loads
- Filters integrate with existing category/tag/search filters
</success_criteria>

<output>
After completion, create `.planning/phases/10-quality-scorecards/10-04-SUMMARY.md`
</output>
