---
phase: 01-project-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - docker/docker-compose.yml
  - packages/db/drizzle.config.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/schema/users.ts
  - packages/db/src/client.ts
  - packages/db/src/index.ts
  - packages/db/src/seed/index.ts
  - packages/db/package.json
autonomous: true

must_haves:
  truths:
    - "docker compose up starts PostgreSQL on localhost:5432"
    - "drizzle-kit push applies schema to database without errors"
    - "drizzle-kit studio opens database browser"
    - "Database connection succeeds from @relay/db client"
  artifacts:
    - path: "docker/docker-compose.yml"
      provides: "PostgreSQL container configuration"
      contains: "postgres:16"
    - path: "packages/db/drizzle.config.ts"
      provides: "Drizzle Kit configuration"
      contains: "defineConfig"
    - path: "packages/db/src/schema/users.ts"
      provides: "User table schema"
      contains: "pgTable"
    - path: "packages/db/src/client.ts"
      provides: "Database client export"
      contains: "drizzle"
  key_links:
    - from: "packages/db/drizzle.config.ts"
      to: "packages/db/src/schema/index.ts"
      via: "schema path"
      pattern: 'schema:.*index'
    - from: "packages/db/src/client.ts"
      to: "DATABASE_URL"
      via: "environment variable"
      pattern: "process.env.DATABASE_URL"
---

<objective>
Set up PostgreSQL via Docker Compose and configure Drizzle ORM with initial schema and migrations. Create placeholder user table for future authentication.

Purpose: Establishes database infrastructure that all data-dependent features will use. Enables local development with consistent database state.

Output: Running PostgreSQL container, applied migrations, and working Drizzle client.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-foundation/01-CONTEXT.md
@.planning/phases/01-project-foundation/01-RESEARCH.md
@.planning/phases/01-project-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Docker Compose configuration for PostgreSQL</name>
  <files>
    docker/docker-compose.yml
  </files>
  <action>
    Create docker/docker-compose.yml following the pattern from RESEARCH.md:
    - PostgreSQL 16 Alpine image
    - Container name: relay-postgres
    - Environment: POSTGRES_USER=postgres, POSTGRES_PASSWORD=postgres, POSTGRES_DB=relay
    - Port mapping: 5432:5432
    - Volume: postgres_data for data persistence
    - Healthcheck: pg_isready command with 5s intervals

    Update root package.json scripts (if not already present):
    - docker:up: "docker compose -f docker/docker-compose.yml up -d"
    - docker:down: "docker compose -f docker/docker-compose.yml down"

    Start the container to verify it works:
    - Run pnpm docker:up
    - Verify container is healthy with docker ps
  </action>
  <verify>
    docker ps | grep relay-postgres
    docker exec relay-postgres pg_isready -U postgres
  </verify>
  <done>PostgreSQL container runs and is healthy on localhost:5432</done>
</task>

<task type="auto">
  <name>Task 2: Configure Drizzle ORM with initial schema</name>
  <files>
    packages/db/drizzle.config.ts
    packages/db/src/schema/index.ts
    packages/db/src/schema/users.ts
    packages/db/src/client.ts
    packages/db/src/index.ts
    packages/db/package.json
  </files>
  <action>
    Create packages/db/drizzle.config.ts following Pattern 3 from RESEARCH.md:
    - dialect: "postgresql"
    - schema: "./src/schema/index.ts"
    - out: "./src/migrations"
    - dbCredentials.url from process.env.DATABASE_URL

    Create packages/db/src/schema/users.ts with initial User table:
    - id: uuid, primary key, defaultRandom()
    - email: text, notNull, unique
    - name: text, notNull
    - avatarUrl: text, nullable
    - createdAt: timestamp, defaultNow, notNull
    - updatedAt: timestamp, defaultNow, notNull

    This is a placeholder for Phase 2 Auth - just needs to exist for migrations to work.

    Create packages/db/src/schema/index.ts re-exporting all schema files.

    Update packages/db/src/client.ts:
    - Import postgres from "postgres"
    - Import drizzle from "drizzle-orm/postgres-js"
    - Import schema from "./schema"
    - Create connection string from DATABASE_URL
    - Export db client: drizzle(postgres(connectionString), { schema })

    Update packages/db/src/index.ts to export:
    - db client from "./client"
    - All schema types from "./schema"

    Ensure packages/db/package.json has scripts:
    - db:generate: "drizzle-kit generate"
    - db:migrate: "drizzle-kit migrate"
    - db:push: "drizzle-kit push"
    - db:studio: "drizzle-kit studio"

    Install dependencies if not present:
    - pnpm --filter @relay/db add drizzle-orm postgres
    - pnpm --filter @relay/db add -D drizzle-kit
  </action>
  <verify>
    test -f packages/db/drizzle.config.ts
    test -f packages/db/src/schema/users.ts
    grep -q "pgTable" packages/db/src/schema/users.ts
  </verify>
  <done>Drizzle configuration and initial user schema created</done>
</task>

<task type="auto">
  <name>Task 3: Apply schema and verify database connection</name>
  <files></files>
  <action>
    Ensure .env.local exists in root with:
    DATABASE_URL=postgresql://postgres:postgres@localhost:5432/relay

    Run drizzle-kit push to apply schema directly (dev mode):
    - pnpm --filter @relay/db db:push

    This applies the schema without generating migration files (appropriate for dev setup).

    Verify by running drizzle-kit studio:
    - pnpm --filter @relay/db db:studio
    - Confirm users table appears in the browser interface
    - Stop studio after verification

    Alternatively, verify with psql if available:
    - docker exec -it relay-postgres psql -U postgres -d relay -c "\dt"
    - Should show users table
  </action>
  <verify>
    docker exec relay-postgres psql -U postgres -d relay -c "\dt" | grep users
  </verify>
  <done>Schema applied to database, users table exists and is queryable</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `pnpm docker:up` starts PostgreSQL container
2. `pnpm --filter @relay/db db:push` applies schema without errors
3. `pnpm --filter @relay/db db:studio` opens Drizzle Studio
4. Database contains users table with correct columns
5. Connection from Node.js succeeds (can test with simple script if needed)
</verification>

<success_criteria>
- PostgreSQL 16 runs in Docker on localhost:5432
- Drizzle ORM configured with schema pointing to packages/db/src/schema
- Users table created with id, email, name, avatarUrl, createdAt, updatedAt
- db:push, db:studio scripts work from root via Turborepo
- DATABASE_URL properly configured in .env.local
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-foundation/01-02-SUMMARY.md`
</output>
