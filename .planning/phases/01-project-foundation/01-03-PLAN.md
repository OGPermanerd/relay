---
phase: 01-project-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .github/workflows/ci.yml
  - package.json
autonomous: true

must_haves:
  truths:
    - "Push to main triggers CI workflow"
    - "Pull request to main triggers CI workflow"
    - "CI runs lint, typecheck, unit tests, build, and E2E tests in sequence"
    - "CI fails fast on lint or typecheck errors"
    - "Playwright report uploaded as artifact on E2E failure"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI pipeline"
      contains: "runs-on: ubuntu-latest"
      min_lines: 50
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json"
      via: "pnpm scripts"
      pattern: "pnpm (lint|build|test)"
    - from: ".github/workflows/ci.yml"
      to: "PostgreSQL service"
      via: "services.postgres"
      pattern: "postgres:16"
---

<objective>
Create GitHub Actions CI workflow that runs linting, type checking, unit tests, builds, and E2E tests on every push and pull request.

Purpose: Ensures code quality and prevents regressions from reaching main branch. Provides fast feedback on PRs with detailed test reports.

Output: Working CI pipeline that catches errors before merge.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-foundation/01-CONTEXT.md
@.planning/phases/01-project-foundation/01-RESEARCH.md
@.planning/phases/01-project-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
    Create .github/workflows/ci.yml following the GitHub Actions CI Workflow pattern from RESEARCH.md:

    Triggers:
    - push to main branch
    - pull_request to main branch

    Job configuration:
    - runs-on: ubuntu-latest
    - timeout-minutes: 15

    PostgreSQL service container:
    - image: postgres:16-alpine
    - env: POSTGRES_USER=postgres, POSTGRES_PASSWORD=postgres, POSTGRES_DB=relay_test
    - ports: 5432:5432
    - healthcheck options: pg_isready with 10s interval, 5s timeout, 5 retries

    Steps (in order):
    1. Checkout with fetch-depth: 2
    2. Setup pnpm (uses pnpm/action-setup@v3, version: 9)
    3. Setup Node.js 22 with pnpm cache
    4. Install dependencies: pnpm install --frozen-lockfile
    5. Lint: pnpm lint
    6. Type check: pnpm turbo typecheck (add typecheck script if needed)
    7. Unit tests: pnpm test (placeholder - will pass with no tests)
    8. Build: pnpm build
    9. Install Playwright browsers: pnpm --filter web exec playwright install --with-deps chromium
    10. E2E tests: pnpm test:e2e (env: DATABASE_URL pointing to service container)
    11. Upload Playwright report on failure (uses actions/upload-artifact@v4)

    Ensure fail-fast behavior: steps run sequentially and stop on first failure.
  </action>
  <verify>
    test -f .github/workflows/ci.yml
    grep -q "postgres:16" .github/workflows/ci.yml
    grep -q "pnpm lint" .github/workflows/ci.yml
    grep -q "pnpm build" .github/workflows/ci.yml
  </verify>
  <done>CI workflow file created with all required steps and PostgreSQL service</done>
</task>

<task type="auto">
  <name>Task 2: Add typecheck script to Turborepo pipeline</name>
  <files>
    package.json
    turbo.json
    apps/web/package.json
    packages/core/package.json
    packages/db/package.json
    packages/ui/package.json
  </files>
  <action>
    Add "typecheck" task to turbo.json:
    - dependsOn: ["^build"]
    - No outputs (type checking doesn't produce files)

    Add typecheck script to root package.json:
    - "typecheck": "turbo typecheck"

    Add typecheck script to each package/app package.json:
    - apps/web: "typecheck": "tsc --noEmit"
    - packages/core: "typecheck": "tsc --noEmit"
    - packages/db: "typecheck": "tsc --noEmit"
    - packages/ui: "typecheck": "tsc --noEmit"

    Verify typecheck works:
    - Run pnpm typecheck
    - Should pass without errors (or show expected TS errors to fix)
  </action>
  <verify>
    grep -q '"typecheck"' turbo.json
    grep -q '"typecheck"' package.json
    pnpm typecheck 2>&1 | tail -3
  </verify>
  <done>Typecheck script added to all packages and Turborepo pipeline</done>
</task>

<task type="auto">
  <name>Task 3: Add placeholder test script for unit tests</name>
  <files>
    package.json
    turbo.json
  </files>
  <action>
    Add "test" task to turbo.json if not present:
    - dependsOn: ["^build"]
    - No persistent, no outputs for now

    Add test script to root package.json:
    - "test": "turbo test"

    For now, each package can have a placeholder test script that exits 0:
    - "test": "echo 'No tests yet' && exit 0"

    This ensures CI doesn't fail on test step. Real unit tests will be added as features are built.

    Note: Vitest setup is deferred - will be added when first unit tests are needed (likely Phase 2 or 3).
  </action>
  <verify>
    grep -q '"test"' package.json
    pnpm test 2>&1 | tail -3
  </verify>
  <done>Placeholder test scripts added, CI test step will pass</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `.github/workflows/ci.yml` exists with correct structure
2. CI workflow includes PostgreSQL service container
3. All steps present: checkout, pnpm, node, install, lint, typecheck, test, build, playwright, e2e
4. `pnpm typecheck` runs type checking across all packages
5. `pnpm test` runs without errors (placeholder)
6. Playwright artifact upload configured for failure cases
</verification>

<success_criteria>
- GitHub Actions workflow triggers on push/PR to main
- PostgreSQL service container available during workflow
- CI runs: lint -> typecheck -> test -> build -> e2e (sequential, fail-fast)
- Playwright report uploaded as artifact on E2E failure
- All placeholder scripts exist and pass locally
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-foundation/01-03-SUMMARY.md`
</output>
