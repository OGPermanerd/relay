---
phase: 28-hook-based-usage-tracking
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/site-settings.ts
  - packages/db/src/migrations/0007_add_key_expiry_days.sql
autonomous: true

must_haves:
  truths:
    - "site_settings table has a keyExpiryDays integer column defaulting to 90"
    - "Migration is idempotent (safe to re-run)"
    - "Drizzle schema matches the migration"
  artifacts:
    - path: "packages/db/src/schema/site-settings.ts"
      provides: "keyExpiryDays column definition"
      contains: "keyExpiryDays"
    - path: "packages/db/src/migrations/0007_add_key_expiry_days.sql"
      provides: "ALTER TABLE migration"
      contains: "key_expiry_days"
  key_links: []
---

<objective>
Add per-tenant key expiry configuration column to site_settings.

Purpose: SOC2-05 requires per-tenant configurable key expiry (default 90 days). The site_settings table is the correct location since it already stores per-tenant configuration. This is a schema-only change with an idempotent migration.
Output: Updated schema + migration file ready to be applied.
</objective>

<execution_context>
@/home/dev/.claude/agents/gsd-planner.md
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add keyExpiryDays to site_settings schema and migration</name>
  <files>
    packages/db/src/schema/site-settings.ts
    packages/db/src/migrations/0007_add_key_expiry_days.sql
  </files>
  <action>
**Schema change (packages/db/src/schema/site-settings.ts):**
Add a new column to the siteSettings table definition, after `embeddingDimensions`:
```typescript
keyExpiryDays: integer("key_expiry_days").notNull().default(90),
```
Import `integer` is already in the import list.

**Migration (packages/db/src/migrations/0007_add_key_expiry_days.sql):**
Create an idempotent migration:
```sql
-- Migration 0007: Add per-tenant API key expiry configuration
-- SOC2-05: Default 90-day expiry, configurable per tenant

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'site_settings' AND column_name = 'key_expiry_days'
  ) THEN
    ALTER TABLE site_settings ADD COLUMN key_expiry_days INTEGER NOT NULL DEFAULT 90;
  END IF;
END $$;
```

The migration uses IF NOT EXISTS guard for idempotency (safe to re-run per project convention from Phase 25).
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit -p packages/db/tsconfig.json` to verify schema compiles. Check migration SQL is valid syntax.</verify>
  <done>site_settings has keyExpiryDays column (default 90). Migration is idempotent. Schema and migration are consistent.</done>
</task>

</tasks>

<verification>
- Schema compiles with new column
- Migration SQL uses IF NOT EXISTS guard
- Default value is 90 (matching SOC2-05 requirement)
</verification>

<success_criteria>
- site_settings schema includes keyExpiryDays integer column with default 90
- Migration 0007 creates the column idempotently
- Per-tenant key expiry duration is now configurable via site_settings
</success_criteria>

<output>
After completion, create `.planning/phases/28-hook-based-usage-tracking/28-07-SUMMARY.md`
</output>
