---
phase: 28-hook-based-usage-tracking
plan: 04
type: execute
wave: 2
depends_on: ["28-01", "28-02", "28-03"]
files_modified:
  - apps/web/app/api/track/route.ts
  - apps/web/middleware.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/track accepts hook callbacks with Bearer token auth"
    - "Endpoint validates API key, checks rate limit, verifies HMAC, inserts event"
    - "Rate-limited requests get 429"
    - "Invalid/missing auth gets 401"
    - "Invalid HMAC gets 403"
    - "Malformed body gets 400"
    - "Valid request gets 200 with empty body"
    - "Middleware exempts /api/track from session auth"
  artifacts:
    - path: "apps/web/app/api/track/route.ts"
      provides: "POST /api/track endpoint"
      exports: ["POST"]
    - path: "apps/web/middleware.ts"
      provides: "/api/track exemption"
      contains: "api/track"
  key_links:
    - from: "apps/web/app/api/track/route.ts"
      to: "packages/db/src/services/api-keys.ts"
      via: "validateApiKey import"
      pattern: "validateApiKey"
    - from: "apps/web/app/api/track/route.ts"
      to: "packages/db/src/services/usage-tracking.ts"
      via: "insertTrackingEvent import"
      pattern: "insertTrackingEvent"
    - from: "apps/web/app/api/track/route.ts"
      to: "apps/web/lib/rate-limiter.ts"
      via: "checkRateLimit import"
      pattern: "checkRateLimit"
    - from: "apps/web/app/api/track/route.ts"
      to: "apps/web/lib/hmac.ts"
      via: "verifyHmac import"
      pattern: "verifyHmac"
---

<objective>
Create the POST /api/track endpoint and exempt it from middleware auth.

Purpose: TRACK-01 is the core tracking endpoint. It validates Bearer token, rate limits, verifies HMAC, validates the payload with Zod, enriches, and inserts usage events. This is the server-side receiver for all hook callbacks from Claude Code sessions.
Output: Working /api/track endpoint that accepts hook callbacks and inserts usage events.
</objective>

<execution_context>
@/home/dev/.claude/agents/gsd-planner.md
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create POST /api/track route</name>
  <files>apps/web/app/api/track/route.ts</files>
  <action>
Create `apps/web/app/api/track/route.ts`.

Imports:
- `NextRequest, NextResponse` from "next/server"
- `validateApiKey` from "@everyskill/db/services/api-keys"
- `insertTrackingEvent` from "@everyskill/db/services/usage-tracking"
- `checkRateLimit` from "@/lib/rate-limiter"
- `verifyHmac` from "@/lib/hmac"
- `z` from "zod"

Define Zod schema inline at module level:
```typescript
const trackingPayloadSchema = z.object({
  skill_id: z.string().min(1, "skill_id required"),
  tool_name: z.string().min(1).max(200),
  ts: z.string().refine((val) => !isNaN(Date.parse(val)), "Invalid timestamp"),
  hook_event: z.string().optional(),
  tool_input_snippet: z.string().max(1000).optional(),
  tool_output_snippet: z.string().max(1000).optional(),
});
```

Export `POST` handler:
1. Extract Bearer token from Authorization header. If missing or not "Bearer ", return 401 `{ error: "Missing authorization" }`.
2. Call `validateApiKey(apiKey)`. If null, return 401 `{ error: "Invalid key" }`.
3. Call `checkRateLimit(keyResult.keyId)`. If false, return 429 `{ error: "Rate limited" }`.
4. Parse request body with `request.json()`. Wrap in try/catch -- on parse error return 400 `{ error: "Invalid JSON" }`.
5. Validate with `trackingPayloadSchema.safeParse(body)`. If invalid, return 400 `{ error: "Invalid payload", details: parsed.error.flatten().fieldErrors }`.
6. Get raw body text for HMAC verification. Since we already parsed JSON, stringify the parsed data. Check `X-EverySkill-Signature` header. If present, call `verifyHmac(JSON.stringify(body), signature, apiKey)`. If verification fails, return 403 `{ error: "Invalid signature" }`. If header is MISSING, still allow the request (graceful degradation for clients that don't have openssl).
7. Call `insertTrackingEvent({ tenantId: keyResult.tenantId, userId: keyResult.userId, skillId: parsed.data.skill_id, toolName: parsed.data.tool_name, clientTimestamp: parsed.data.ts, hookEvent: parsed.data.hook_event, metadata: { tool_input_snippet: parsed.data.tool_input_snippet, tool_output_snippet: parsed.data.tool_output_snippet, isExpiredKey: keyResult.isExpired } })`.
8. Return `new NextResponse(null, { status: 200 })`.

Key: HMAC signature is optional (graceful degradation). The endpoint works with or without it. When present, it must be valid.
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json` -- should compile</verify>
  <done>POST /api/track endpoint handles full auth -> rate limit -> validate -> HMAC -> insert pipeline, returns appropriate status codes.</done>
</task>

<task type="auto">
  <name>Task 2: Exempt /api/track from middleware auth</name>
  <files>apps/web/middleware.ts</files>
  <action>
In `apps/web/middleware.ts`, add `/api/track` to the exempt paths block (around line 38-46).

Add this line after `pathname === "/api/health"`:
```typescript
pathname === "/api/track"
```

The /api/track endpoint handles its own authentication via Bearer token (API key), not session cookies. It must be exempt from middleware's cookie-based auth redirect.
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json` and verify the middleware compiles. Then grep for "/api/track" in middleware.ts to confirm the exemption is present.</verify>
  <done>Middleware allows /api/track requests through without session cookie check. The endpoint handles its own Bearer token auth.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- `/api/track` is in middleware exempt list
- Route file exports POST handler
- Zod validation schema covers all required fields
</verification>

<success_criteria>
- POST /api/track returns 200 on valid request with Bearer token
- Returns 401 on missing/invalid auth
- Returns 429 when rate limited
- Returns 403 on invalid HMAC (when signature header is present)
- Returns 400 on malformed body
- Middleware does not redirect /api/track to login
</success_criteria>

<output>
After completion, create `.planning/phases/28-hook-based-usage-tracking/28-04-SUMMARY.md`
</output>
