---
phase: 28-hook-based-usage-tracking
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - apps/web/app/actions/skills.ts
autonomous: true

must_haves:
  truths:
    - "buildEverySkillFrontmatter includes PostToolUse hooks section"
    - "Hook uses async:true and type:command"
    - "Hook fires curl to /api/track with Bearer auth and HMAC signature"
    - "Hook reads PostToolUse input from stdin via jq with bash fallback"
    - "Hook failures are silent (|| true, -o /dev/null)"
    - "Uploaded skills have hook frontmatter in their stored content"
  artifacts:
    - path: "apps/web/app/actions/skills.ts"
      provides: "buildEverySkillFrontmatter with PostToolUse hooks"
      contains: "PostToolUse"
  key_links:
    - from: "apps/web/app/actions/skills.ts"
      to: "/api/track"
      via: "curl URL in hook command"
      pattern: "api/track"
---

<objective>
Modify buildEverySkillFrontmatter to inject PostToolUse tracking hooks into skill YAML frontmatter.

Purpose: TRACK-02 and TRACK-04 require hook injection at upload time. Every skill uploaded gets invisible tracking hooks that fire async curl to /api/track after each tool invocation. The hook is invisible to the skill author.
Output: Updated buildEverySkillFrontmatter that produces YAML with PostToolUse hooks section.
</objective>

<execution_context>
@/home/dev/.claude/agents/gsd-planner.md
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PostToolUse hooks to buildEverySkillFrontmatter</name>
  <files>apps/web/app/actions/skills.ts</files>
  <action>
Modify `buildEverySkillFrontmatter()` in `apps/web/app/actions/skills.ts` (lines 19-34).

The function currently returns YAML frontmatter with 4 everyskill_ fields. Add a `hooks` section after the existing fields.

Determine the tracking endpoint URL dynamically:
```typescript
const trackingUrl = process.env.NEXT_PUBLIC_ROOT_DOMAIN
  ? `https://${process.env.NEXT_PUBLIC_ROOT_DOMAIN}/api/track`
  : "http://localhost:2000/api/track";
```

The hook command must:
1. Read PostToolUse JSON from stdin (contains tool_name, tool_input, tool_response)
2. Extract tool_name using jq with bash grep fallback
3. Build JSON payload with skill_id, tool_name, timestamp
4. Compute HMAC-SHA256 signature using $EVERYSKILL_API_KEY
5. Fire async curl with Bearer auth, HMAC header, and JSON body
6. Log failures to /tmp/everyskill-track.log silently
7. Retry once on failure after 5 seconds (per user decision)

Updated function should produce this YAML structure (as a string array joined with \n):
```
---
everyskill_skill_id: {skillId}
everyskill_skill_name: {name}
everyskill_category: {category}
everyskill_hours_saved: {hoursSaved}
hooks:
  PostToolUse:
    - matcher: "*"
      hooks:
        - type: command
          command: >-
            bash -c '
            INPUT=$(cat);
            TN=$(echo "$INPUT" | jq -r ".tool_name // empty" 2>/dev/null || echo "$INPUT" | grep -o "\"tool_name\":\"[^\"]*\"" | cut -d\" -f4 || echo "unknown");
            PL="{\"skill_id\":\"{SKILL_ID}\",\"tool_name\":\"$TN\",\"ts\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"hook_event\":\"PostToolUse\"}";
            SIG=$(echo -n "$PL" | openssl dgst -sha256 -hmac "${EVERYSKILL_API_KEY:-none}" 2>/dev/null | awk "{print \$NF}");
            RESP=$(curl -s -o /dev/null -w "%{http_code}" -X POST "{TRACKING_URL}" -H "Content-Type: application/json" -H "Authorization: Bearer ${EVERYSKILL_API_KEY:-}" -H "X-EverySkill-Signature: $SIG" -d "$PL" --connect-timeout 5 --max-time 10 2>>/tmp/everyskill-track.log);
            if [ "$RESP" != "200" ] && [ "$RESP" != "000" ]; then sleep 5; curl -s -o /dev/null -X POST "{TRACKING_URL}" -H "Content-Type: application/json" -H "Authorization: Bearer ${EVERYSKILL_API_KEY:-}" -H "X-EverySkill-Signature: $SIG" -d "$PL" --connect-timeout 5 --max-time 10 2>>/tmp/everyskill-track.log; fi;
            true
            '
          async: true
          timeout: 30
---
```

Replace `{SKILL_ID}` with `fields.skillId` and `{TRACKING_URL}` with the computed trackingUrl.

IMPORTANT considerations for shell escaping in the string array approach:
- Use template literals carefully. Each line is a string in the array.
- The YAML `>-` folded scalar handles newlines correctly.
- Test that the generated YAML is valid by visual inspection of the output format.
- The `|| true` at the end ensures the hook never returns a non-zero exit code.
- The retry (`if [ "$RESP" != "200" ]`) implements the "retry once after 5 seconds" decision.
- `async: true` ensures Claude Code fires this in the background (TRACK-03).
- `timeout: 30` gives enough time for retry (10s first attempt + 5s sleep + 10s retry + buffer).

Do NOT modify any other functions in skills.ts. Only change buildEverySkillFrontmatter.
  </action>
  <verify>Run `cd /home/dev/projects/relay && pnpm build` to verify the file compiles. Then visually inspect the function to ensure the YAML output is well-formed (matching indentation, proper quoting).</verify>
  <done>buildEverySkillFrontmatter produces YAML with PostToolUse hooks that fire async curl to /api/track with Bearer auth, HMAC signature, jq+fallback tool_name extraction, retry-once, and silent failure logging.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- Generated frontmatter includes `hooks:` section with PostToolUse
- Hook command includes `async: true`
- Hook includes jq with grep fallback for tool_name extraction
- Hook includes HMAC signature computation
- Hook includes retry-once logic
- Hook failures are silent (|| true, -o /dev/null)
</verification>

<success_criteria>
- Every newly uploaded skill gets PostToolUse tracking hooks in its frontmatter
- Hooks are invisible to the skill author (injected server-side only)
- Hook execution is async and never blocks Claude Code sessions
- Failed hooks retry once after 5 seconds, then silently give up
</success_criteria>

<output>
After completion, create `.planning/phases/28-hook-based-usage-tracking/28-05-SUMMARY.md`
</output>
