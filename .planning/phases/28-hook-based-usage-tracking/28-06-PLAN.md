---
phase: 28-hook-based-usage-tracking
plan: 06
type: execute
wave: 3
depends_on: ["28-05"]
files_modified:
  - apps/mcp/src/tools/deploy.ts
  - apps/mcp/src/tools/log-usage.ts
autonomous: true

must_haves:
  truths:
    - "Deploy tool injects PostToolUse hooks if skill content lacks them"
    - "Deploy tool preserves existing hooks if already present"
    - "Legacy skills (pre-Phase 28) get hooks added on deploy"
    - "log_skill_usage tool is deprecated with a message pointing to hooks"
  artifacts:
    - path: "apps/mcp/src/tools/deploy.ts"
      provides: "Deploy-time hook compliance check and injection"
      contains: "PostToolUse"
    - path: "apps/mcp/src/tools/log-usage.ts"
      provides: "Deprecated tool with notification"
      contains: "deprecated"
  key_links:
    - from: "apps/mcp/src/tools/deploy.ts"
      to: "skill.content"
      via: "hook presence check"
      pattern: "hooks.*PostToolUse"
---

<objective>
Add deploy-time hook compliance check to deploy.ts and deprecate log_skill_usage.

Purpose: TRACK-05 requires deploy-time verification that tracking hooks exist. Legacy skills uploaded before Phase 28 won't have hooks -- deploy should inject them. The old log_skill_usage MCP tool is replaced by deterministic hooks and should be deprecated.
Output: Deploy tool that ensures every deployed skill has tracking hooks. Deprecated log_skill_usage tool.
</objective>

<execution_context>
@/home/dev/.claude/agents/gsd-planner.md
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hook compliance check to deploy.ts</name>
  <files>apps/mcp/src/tools/deploy.ts</files>
  <action>
Modify `apps/mcp/src/tools/deploy.ts` to verify and inject PostToolUse hooks on deploy.

1. Add a helper function `buildHookFrontmatter(skillId: string, skillName: string, category: string, hoursSaved: number): string` at the top of the file. This generates the same YAML frontmatter as `buildEverySkillFrontmatter` in skills.ts but is self-contained (no cross-package import needed for the MCP app). The tracking URL should use `process.env.NEXT_PUBLIC_ROOT_DOMAIN ? "https://${process.env.NEXT_PUBLIC_ROOT_DOMAIN}/api/track" : "https://everyskill.ai/api/track"` (MCP is production-facing, defaults to production URL).

2. Add a helper function `hasTrackingHooks(content: string): boolean` that checks if the content's YAML frontmatter contains a `hooks:` section with `PostToolUse`. Simple regex check: `/hooks:\s*\n\s+PostToolUse:/m.test(content)`.

3. In `handleDeploySkill`, after fetching the skill (around line 52), add the hook compliance check:
   - If `!hasTrackingHooks(skill.content)`: build new frontmatter with hooks using `buildHookFrontmatter(skill.id, skill.name, skill.category, skill.hoursSaved)`, then strip any existing frontmatter from `skill.content` and prepend the new frontmatter with hooks.
   - If hooks already exist: use skill.content as-is.

4. Replace the inline frontmatter construction on lines 70-72 with the hook-aware content. The current code builds frontmatter inline for stdio transport. Replace this with:
   ```typescript
   const contentWithHooks = hasTrackingHooks(skill.content)
     ? skill.content
     : buildHookFrontmatter(skill.id, skill.name, skill.category, skill.hoursSaved) + stripFrontmatter(skill.content);

   const contentWithFrontmatter = transport === "stdio"
     ? contentWithHooks
     : skill.content;
   ```

5. Add a simple `stripFrontmatter(content: string): string` helper that removes `---\n...\n---\n` prefix if present.

6. Update the deploy response instructions (lines 96-101) to REMOVE the line about calling `log_skill_usage` since hooks now handle tracking automatically. Replace with: "Usage tracking is automatic via PostToolUse hooks in the skill frontmatter".

The hook command in `buildHookFrontmatter` should use the exact same bash/curl structure as in skills.ts plan 05, with the production tracking URL.
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/mcp/tsconfig.json 2>&1 | head -20` -- should compile (ignore pre-existing module resolution warnings)</verify>
  <done>Deploy tool verifies hooks exist in deployed skills, injects them for legacy skills, and instructions no longer reference log_skill_usage.</done>
</task>

<task type="auto">
  <name>Task 2: Deprecate log_skill_usage MCP tool</name>
  <files>apps/mcp/src/tools/log-usage.ts</files>
  <action>
Modify `apps/mcp/src/tools/log-usage.ts` to deprecate the tool.

1. Update the tool description to include "[DEPRECATED]": `"[DEPRECATED] Usage is now tracked automatically via PostToolUse hooks. This tool is no longer needed. Kept for backward compatibility."`

2. Modify the handler to return a deprecation notice instead of tracking:
   ```typescript
   async ({ skillId, action }) => {
     return {
       content: [
         {
           type: "text" as const,
           text: JSON.stringify({
             success: true,
             deprecated: true,
             message: "Usage is now tracked automatically via PostToolUse hooks in skill frontmatter. This tool is no longer needed."
           }),
         },
       ],
     };
   }
   ```

3. Remove the `trackUsage` import and call since the tool no longer records events (hooks handle it).
4. Remove the `getUserId` import if no longer used.

Do NOT remove the tool entirely -- it may still be called by older MCP configurations. The deprecation notice tells callers to stop using it.
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/mcp/tsconfig.json 2>&1 | head -20` -- should compile</verify>
  <done>log_skill_usage tool is deprecated with a clear message. It no longer tracks events (hooks handle tracking). Tool still exists for backward compatibility.</done>
</task>

</tasks>

<verification>
- MCP app compiles without new errors
- deploy.ts includes `hasTrackingHooks` check
- deploy.ts injects hooks for skills that lack them
- log-usage.ts returns deprecation notice
- Deploy instructions no longer reference log_skill_usage
</verification>

<success_criteria>
- Legacy skills without hooks get hooks injected on deploy
- Skills with existing hooks pass through unchanged
- log_skill_usage returns deprecation notice without recording events
- Deploy response instructions reference automatic tracking, not manual logging
</success_criteria>

<output>
After completion, create `.planning/phases/28-hook-based-usage-tracking/28-06-SUMMARY.md`
</output>
