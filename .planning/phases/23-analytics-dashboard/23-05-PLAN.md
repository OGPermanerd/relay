---
phase: 23-analytics-dashboard
plan: 05
type: execute
wave: 2
depends_on: ["23-01", "23-02"]
files_modified:
  - apps/web/components/overview-tab.tsx
  - apps/web/components/csv-export-button.tsx
  - apps/web/app/actions/export-analytics.ts
autonomous: true

must_haves:
  truths:
    - "Overview tab shows 6 stat cards with org-wide metrics"
    - "Area chart renders usage trend data below stat cards"
    - "CSV export button downloads all analytics data"
    - "Export respects current time range selection"
  artifacts:
    - path: "apps/web/components/overview-tab.tsx"
      provides: "Stat cards + area chart layout"
      min_lines: 40
    - path: "apps/web/components/csv-export-button.tsx"
      provides: "CSV download button"
      min_lines: 20
    - path: "apps/web/app/actions/export-analytics.ts"
      provides: "Server action to get export data"
      min_lines: 15
  key_links:
    - from: "apps/web/components/overview-tab.tsx"
      to: "apps/web/components/usage-area-chart.tsx"
      via: "component composition"
      pattern: "<UsageAreaChart"
    - from: "apps/web/components/csv-export-button.tsx"
      to: "apps/web/app/actions/export-analytics.ts"
      via: "server action call"
      pattern: "getExportData"
---

<objective>
Create the Overview tab with stat cards and area chart, plus CSV export functionality.

Purpose: Display org-wide analytics summary and enable data export.
Output: OverviewTab component with stats and chart, CsvExportButton with server action
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/23-analytics-dashboard/23-01-SUMMARY.md
@.planning/phases/23-analytics-dashboard/23-02-SUMMARY.md
@apps/web/components/stat-card.tsx (pattern: existing StatCard)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OverviewTab component</name>
  <files>apps/web/components/overview-tab.tsx</files>
  <action>
Create `apps/web/components/overview-tab.tsx`:

```typescript
"use client";

import { StatCard } from "./stat-card";
import { UsageAreaChart } from "./usage-area-chart";

// Icons for stat cards
const ClockIcon = () => (
  <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
);

const UsersIcon = () => (
  <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
  </svg>
);

const CubeIcon = () => (
  <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" />
  </svg>
);

const RocketIcon = () => (
  <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
  </svg>
);

const StarIcon = () => (
  <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
  </svg>
);

const TrophyIcon = () => (
  <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 01-.982-3.172M9.497 14.25a7.454 7.454 0 00.981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 007.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 002.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 012.916.52 6.003 6.003 0 01-5.395 4.972m0 0a6.726 6.726 0 01-2.749 1.35m0 0a6.772 6.772 0 01-3.044 0" />
  </svg>
);

interface OverviewStats {
  totalHoursSaved: number;
  activeEmployees: number;
  skillsDeployed: number;
  deploymentsThisPeriod: number;
  mostUsedSkill: string | null;
  highestSaver: string | null;
}

interface UsageDataPoint {
  date: string;
  hoursSaved: number;
}

interface OverviewTabProps {
  stats: OverviewStats;
  trendData: UsageDataPoint[];
}

export function OverviewTab({ stats, trendData }: OverviewTabProps) {
  return (
    <div className="space-y-6">
      {/* Stat Cards Grid */}
      <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <StatCard
          label="Total Hours Saved"
          value={stats.totalHoursSaved.toFixed(1)}
          icon={<ClockIcon />}
        />
        <StatCard
          label="Active Employees"
          value={stats.activeEmployees}
          icon={<UsersIcon />}
        />
        <StatCard
          label="Skills Deployed"
          value={stats.skillsDeployed}
          icon={<CubeIcon />}
        />
        <StatCard
          label="Deployments This Period"
          value={stats.deploymentsThisPeriod}
          icon={<RocketIcon />}
        />
        <StatCard
          label="Most Used Skill"
          value={stats.mostUsedSkill || "—"}
          icon={<StarIcon />}
        />
        <StatCard
          label="Highest Saver"
          value={stats.highestSaver || "—"}
          icon={<TrophyIcon />}
        />
      </div>

      {/* Usage Trend Chart */}
      <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <h3 className="mb-4 text-sm font-medium text-gray-500">Usage Trend</h3>
        <UsageAreaChart data={trendData} />
      </div>
    </div>
  );
}
```

Key implementation details:
- 6 stat cards in 3-column grid (responsive to 2 on medium, 1 on small)
- Heroicons-style SVG icons inline (avoiding external icon library)
- Reuses existing StatCard component
- Area chart in white card below stats
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - OverviewTab is exported
  </verify>
  <done>
    - OverviewTab renders 6 stat cards with appropriate icons
    - Area chart displays below stat cards
    - Layout is responsive
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CSV export button and server action</name>
  <files>apps/web/app/actions/export-analytics.ts, apps/web/components/csv-export-button.tsx</files>
  <action>
1. Create `apps/web/app/actions/export-analytics.ts`:

```typescript
"use server";

import { auth } from "@/auth";
import { getExportData, getStartDate, type TimeRange } from "@/lib/analytics-queries";

export interface ExportRow {
  date: string;
  employeeName: string;
  employeeEmail: string;
  skillName: string;
  category: string;
  action: string;
  hoursSaved: number;
}

export async function fetchExportData(range: TimeRange): Promise<ExportRow[]> {
  const session = await auth();
  if (!session?.user) {
    throw new Error("Unauthorized");
  }

  const startDate = getStartDate(range);
  const data = await getExportData(startDate);
  return data;
}
```

2. Create `apps/web/components/csv-export-button.tsx`:

```typescript
"use client";

import { useState } from "react";
import { useTimeRange } from "./time-range-selector";
import { fetchExportData, type ExportRow } from "@/app/actions/export-analytics";

interface CsvExportButtonProps {
  className?: string;
}

export function CsvExportButton({ className = "" }: CsvExportButtonProps) {
  const range = useTimeRange();
  const [isExporting, setIsExporting] = useState(false);

  const handleExport = async () => {
    setIsExporting(true);
    try {
      const data = await fetchExportData(range);

      if (data.length === 0) {
        alert("No data to export for this time range");
        return;
      }

      // Build CSV content
      const headers = ["Date", "Employee Name", "Employee Email", "Skill Name", "Category", "Action", "Hours Saved"];
      const rows = data.map((row) => [
        row.date,
        escapeCSV(row.employeeName),
        escapeCSV(row.employeeEmail),
        escapeCSV(row.skillName),
        escapeCSV(row.category),
        escapeCSV(row.action),
        row.hoursSaved.toFixed(2),
      ]);

      const csv = [headers.join(","), ...rows.map((r) => r.join(","))].join("\n");

      // Generate filename with date
      const today = new Date().toISOString().split("T")[0];
      const filename = `relay-analytics-${today}.csv`;

      // Download
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error("Export failed:", error);
      alert("Export failed. Please try again.");
    } finally {
      setIsExporting(false);
    }
  };

  return (
    <button
      type="button"
      onClick={handleExport}
      disabled={isExporting}
      className={`inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed ${className}`}
    >
      {isExporting ? (
        <>
          <svg className="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
          </svg>
          Exporting...
        </>
      ) : (
        <>
          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>
          Export CSV
        </>
      )}
    </button>
  );
}

function escapeCSV(value: string): string {
  if (value.includes(",") || value.includes('"') || value.includes("\n")) {
    return `"${value.replace(/"/g, '""')}"`;
  }
  return value;
}
```

Key implementation details:
- Server action fetches data with auth check
- Button reads current time range from URL via useTimeRange hook
- CSV properly escapes values with commas/quotes
- Filename format: `relay-analytics-2026-02-06.csv` per CONTEXT.md
- Loading state with spinner
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - CsvExportButton and fetchExportData are exported
  </verify>
  <done>
    - Server action fetches export data with auth
    - Export button shows loading state while fetching
    - Downloaded CSV has proper filename and formatting
    - Export respects current time range
  </done>
</task>

</tasks>

<verification>
- OverviewTab compiles and renders stat cards + chart
- Export button triggers download with correct filename
- Server action requires authentication
</verification>

<success_criteria>
- OverviewTab shows 6 stat cards with icons + area chart
- CsvExportButton downloads CSV with all usage data
- Export respects current time range selection
- Filename format is relay-analytics-YYYY-MM-DD.csv
</success_criteria>

<output>
After completion, create `.planning/phases/23-analytics-dashboard/23-05-SUMMARY.md`
</output>
