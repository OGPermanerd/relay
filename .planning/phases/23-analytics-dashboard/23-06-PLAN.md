---
phase: 23-analytics-dashboard
plan: 06
type: execute
wave: 3
depends_on: ["23-01", "23-02", "23-03", "23-04", "23-05"]
files_modified:
  - apps/web/app/(protected)/analytics/page.tsx
  - apps/web/components/analytics-tabs.tsx
  - apps/web/app/(protected)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Analytics page is accessible at /analytics"
    - "Page has 3 tabs: Overview, Employees, Skills"
    - "Tab state persists in URL"
    - "Analytics link appears in main navigation"
    - "Time range selector and export button are in page header"
  artifacts:
    - path: "apps/web/app/(protected)/analytics/page.tsx"
      provides: "Analytics page with data fetching"
      min_lines: 40
    - path: "apps/web/components/analytics-tabs.tsx"
      provides: "Tab navigation component"
      min_lines: 30
  key_links:
    - from: "apps/web/app/(protected)/analytics/page.tsx"
      to: "apps/web/lib/analytics-queries.ts"
      via: "data fetching functions"
      pattern: "getOverviewStats|getEmployeeUsage|getSkillUsage"
    - from: "apps/web/app/(protected)/layout.tsx"
      to: "/analytics"
      via: "nav link"
      pattern: "href=\"/analytics\""
---

<objective>
Create the analytics page with tab navigation and add the nav link.

Purpose: Wire together all analytics components into a functional page accessible from main navigation.
Output: Analytics page at /analytics with tab navigation, add Analytics link to header nav
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/23-analytics-dashboard/23-01-SUMMARY.md
@.planning/phases/23-analytics-dashboard/23-05-SUMMARY.md
@apps/web/components/home-tabs.tsx (pattern: nuqs tabs)
@apps/web/app/(protected)/layout.tsx (nav structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AnalyticsTabs component</name>
  <files>apps/web/components/analytics-tabs.tsx</files>
  <action>
Create `apps/web/components/analytics-tabs.tsx`:

```typescript
"use client";

import { useQueryState, parseAsStringLiteral } from "nuqs";
import type { ReactNode } from "react";

const TABS = ["overview", "employees", "skills"] as const;
type AnalyticsTab = (typeof TABS)[number];

const TAB_LABELS: Record<AnalyticsTab, string> = {
  overview: "Overview",
  employees: "Employees",
  skills: "Skills",
};

interface AnalyticsTabsProps {
  overviewContent: ReactNode;
  employeesContent: ReactNode;
  skillsContent: ReactNode;
}

export function AnalyticsTabs({
  overviewContent,
  employeesContent,
  skillsContent,
}: AnalyticsTabsProps) {
  const [activeTab, setActiveTab] = useQueryState(
    "tab",
    parseAsStringLiteral(TABS).withDefault("overview")
  );

  const content: Record<AnalyticsTab, ReactNode> = {
    overview: overviewContent,
    employees: employeesContent,
    skills: skillsContent,
  };

  return (
    <div>
      {/* Tab buttons */}
      <div className="mb-6 flex border-b border-gray-200">
        {TABS.map((tab) => (
          <button
            key={tab}
            type="button"
            onClick={() => setActiveTab(tab)}
            className={`px-4 py-2 text-sm font-medium transition-colors ${
              activeTab === tab
                ? "border-b-2 border-blue-500 text-blue-600"
                : "text-gray-500 hover:text-gray-700"
            }`}
          >
            {TAB_LABELS[tab]}
          </button>
        ))}
      </div>

      {/* Tab content */}
      {content[activeTab as AnalyticsTab]}
    </div>
  );
}
```

Key details:
- Follows exact same pattern as HomeTabs
- URL param is `tab` with default `overview`
- Three tabs: Overview, Employees, Skills
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - AnalyticsTabs is exported
  </verify>
  <done>
    - AnalyticsTabs renders 3 tab buttons
    - Active tab has blue underline
    - Tab state persists in URL as ?tab=overview
  </done>
</task>

<task type="auto">
  <name>Task 2: Create analytics page with data fetching</name>
  <files>apps/web/app/(protected)/analytics/page.tsx</files>
  <action>
Create `apps/web/app/(protected)/analytics/page.tsx`:

```typescript
import { Suspense } from "react";
import { AnalyticsTabs } from "@/components/analytics-tabs";
import { OverviewTab } from "@/components/overview-tab";
import { EmployeesTab } from "@/components/employees-tab";
import { SkillsTab } from "@/components/skills-tab";
import { TimeRangeSelector } from "@/components/time-range-selector";
import { CsvExportButton } from "@/components/csv-export-button";
import {
  getOverviewStats,
  getUsageTrend,
  getEmployeeUsage,
  getSkillUsage,
  getGranularity,
  getStartDate,
  type TimeRange,
} from "@/lib/analytics-queries";

interface AnalyticsPageProps {
  searchParams: Promise<{ range?: string }>;
}

export default async function AnalyticsPage({ searchParams }: AnalyticsPageProps) {
  const params = await searchParams;
  const range = (params.range || "30d") as TimeRange;
  const startDate = getStartDate(range);
  const granularity = getGranularity(range);

  // Fetch all data in parallel
  const [overviewStats, trendData, employeeData, skillData] = await Promise.all([
    getOverviewStats(startDate),
    getUsageTrend(startDate, granularity),
    getEmployeeUsage(startDate),
    getSkillUsage(startDate),
  ]);

  return (
    <div className="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
      {/* Page Header */}
      <div className="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Analytics</h1>
          <p className="mt-1 text-sm text-gray-500">
            Org-wide usage trends and employee activity
          </p>
        </div>
        <div className="flex items-center gap-4">
          <Suspense fallback={<div className="h-10 w-64 animate-pulse rounded bg-gray-200" />}>
            <TimeRangeSelector />
          </Suspense>
          <CsvExportButton />
        </div>
      </div>

      {/* Tabs */}
      <AnalyticsTabs
        overviewContent={<OverviewTab stats={overviewStats} trendData={trendData} />}
        employeesContent={<EmployeesTab data={employeeData} />}
        skillsContent={<SkillsTab data={skillData} />}
      />
    </div>
  );
}
```

Key implementation details:
- Server Component fetches all data in parallel with Promise.all
- Reads `range` from searchParams (URL state from TimeRangeSelector)
- Time range selector and export button in page header
- Passes pre-fetched data to tab content components
- Suspense boundary around TimeRangeSelector for client component
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - Navigate to /analytics loads the page
  </verify>
  <done>
    - Analytics page loads at /analytics
    - Page header shows title, time range selector, and export button
    - Three tabs render with correct data
    - Changing time range refetches data (page reload)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Analytics nav link to protected layout</name>
  <files>apps/web/app/(protected)/layout.tsx</files>
  <action>
Update `apps/web/app/(protected)/layout.tsx` to add Analytics link in the nav.

Find the nav element with Home and Profile links, add Analytics between them:

```tsx
<nav className="hidden sm:flex sm:gap-6">
  <Link
    href="/"
    className="text-sm font-medium text-gray-600 transition hover:text-gray-900"
  >
    Home
  </Link>
  <Link
    href="/analytics"
    className="text-sm font-medium text-gray-600 transition hover:text-gray-900"
  >
    Analytics
  </Link>
  <Link
    href="/profile"
    className="text-sm font-medium text-gray-600 transition hover:text-gray-900"
  >
    Profile
  </Link>
  {isAdmin(user.email) && (
    <Link
      href="/admin/keys"
      className="text-sm font-medium text-gray-600 transition hover:text-gray-900"
    >
      Admin
    </Link>
  )}
</nav>
```

The Analytics link is visible to all users (not just admins) per CONTEXT.md decisions.
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - Nav shows Analytics link between Home and Profile
  </verify>
  <done>
    - Analytics link appears in header nav for all authenticated users
    - Link navigates to /analytics
  </done>
</task>

</tasks>

<verification>
- /analytics page loads and shows all 3 tabs
- Nav link appears and navigates correctly
- Time range changes trigger page refresh with new data
- Export button works from any tab
</verification>

<success_criteria>
- Analytics page accessible at /analytics
- 3 tabs functional with data
- Analytics link in main nav
- Time range and export in page header
</success_criteria>

<output>
After completion, create `.planning/phases/23-analytics-dashboard/23-06-SUMMARY.md`
</output>
