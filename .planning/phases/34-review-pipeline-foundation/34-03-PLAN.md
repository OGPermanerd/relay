---
phase: 34-review-pipeline-foundation
plan: 03
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - apps/web/lib/search-skills.ts
  - apps/web/lib/similar-skills.ts
  - apps/web/lib/trending.ts
  - apps/web/lib/leaderboard.ts
  - apps/web/lib/platform-stats.ts
  - apps/web/lib/user-stats.ts
  - apps/web/lib/my-leverage.ts
  - apps/web/lib/total-stats.ts
  - packages/db/src/services/search-skills.ts
  - packages/db/src/services/skill-forks.ts
  - apps/mcp/src/tools/list.ts
  - apps/mcp/src/tools/deploy.ts
autonomous: true

must_haves:
  truths:
    - "Search results only show published skills"
    - "Similar skills only show published skills"
    - "Trending, leaderboard, platform stats, user stats only count published skills"
    - "MCP list_skills and deploy_skill only return published skills"
    - "Tag extraction only counts published skills"
  artifacts:
    - path: "apps/web/lib/search-skills.ts"
      provides: "searchSkills and getAvailableTags filter by published"
      contains: "published"
    - path: "apps/web/lib/similar-skills.ts"
      provides: "All 4+ SQL paths filter by status='published'"
      contains: "status = 'published'"
    - path: "apps/web/lib/trending.ts"
      provides: "Trending query filters published"
      contains: "status = 'published'"
    - path: "apps/web/lib/leaderboard.ts"
      provides: "Leaderboard query filters published"
      contains: "status = 'published'"
    - path: "packages/db/src/services/search-skills.ts"
      provides: "MCP search path filters published"
      contains: "published"
    - path: "apps/mcp/src/tools/list.ts"
      provides: "MCP list filters published"
      contains: "published"
    - path: "apps/mcp/src/tools/deploy.ts"
      provides: "MCP deploy filters published"
      contains: "published"
  key_links:
    - from: "apps/web/lib/search-skills.ts"
      to: "skills table"
      via: "eq(skills.status, 'published') in conditions"
      pattern: "eq.*skills\\.status.*published"
    - from: "apps/web/lib/similar-skills.ts"
      to: "skills table"
      via: "AND s.status = 'published' in raw SQL"
      pattern: "s\\.status.*=.*published"
---

<objective>
Add `status = 'published'` filter to all 18 public-facing skill query paths so draft/pending/rejected skills never leak to non-author users.

Purpose: RVPL-06 and RVPL-08 -- only published skills appear in search, browse, trending, leaderboard, stats, MCP list, and MCP search.
Output: All public queries gated by status='published'.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status filter to web app query files (8 files)</name>
  <files>
    apps/web/lib/search-skills.ts
    apps/web/lib/similar-skills.ts
    apps/web/lib/trending.ts
    apps/web/lib/leaderboard.ts
    apps/web/lib/platform-stats.ts
    apps/web/lib/user-stats.ts
    apps/web/lib/my-leverage.ts
    apps/web/lib/total-stats.ts
  </files>
  <action>
Read each file first, then apply these changes:

**apps/web/lib/search-skills.ts:**
- `searchSkills()`: Add `eq(skills.status, "published")` to the conditions array. Import `eq` if not already imported. Import `skills` from `@everyskill/db` if not already.
- `getAvailableTags()`: This is raw SQL. Add `WHERE status = 'published'` to the SELECT query that extracts tags.

**apps/web/lib/similar-skills.ts** (CRITICAL -- 4+ separate SQL blocks):
- `trySemanticSearch()` has 2 raw SQL variants (with/without excludeSkillId). In each, find `JOIN skills s ON s.id = se.skill_id` and change to `JOIN skills s ON s.id = se.skill_id AND s.status = 'published'`.
- `trySemanticSearchBySkill()`: Same pattern -- add `AND s.status = 'published'` to the JOIN.
- `checkSimilarSkills()` ILIKE fallback: If Drizzle query, add `eq(skills.status, "published")` to where. If raw SQL, add `AND status = 'published'`.
- `findSimilarSkillsByName()`: Same -- add status='published' filter.

**apps/web/lib/trending.ts:**
- Raw SQL CTE. Find the JOIN to skills table and add `AND s.status = 'published'`.

**apps/web/lib/leaderboard.ts:**
- Raw SQL CTE. Find the LEFT JOIN to skills and add `AND s.status = 'published'`.

**apps/web/lib/platform-stats.ts:**
- Drizzle queries. Add `eq(skills.status, "published")` to each WHERE clause that queries skills. Defense-in-depth alongside existing `isNotNull(skills.publishedVersionId)`.

**apps/web/lib/user-stats.ts:**
- Drizzle query. Add `eq(skills.status, "published")` to the WHERE clause.

**apps/web/lib/my-leverage.ts:**
- `getSkillsCreated()` and `getSkillsCreatedStats()`: Raw SQL. Add `AND s.status = 'published'` to the WHERE clause.
- `getSkillsUsed()` and `getSkillsUsedStats()`: These query usage_events by userId -- no change needed (usage only exists for skills that were published).

**apps/web/lib/total-stats.ts:**
- First Drizzle query (skill count): Add `eq(skills.status, "published")` to WHERE.
- Second query joins via usage_events -- already scoped, but add filter if it touches skills table directly.
  </action>
  <verify>
Run `cd /home/dev/projects/relay && pnpm build --filter web` -- should compile.
Run `grep -rn "published" apps/web/lib/search-skills.ts apps/web/lib/similar-skills.ts apps/web/lib/trending.ts apps/web/lib/leaderboard.ts apps/web/lib/platform-stats.ts apps/web/lib/user-stats.ts apps/web/lib/my-leverage.ts apps/web/lib/total-stats.ts | wc -l` -- should be at least 12 matches.
  </verify>
  <done>All 8 web lib files filter by status='published'. No draft/pending/rejected skills leak to public queries.</done>
</task>

<task type="auto">
  <name>Task 2: Add status filter to DB services and MCP tools (4 files)</name>
  <files>
    packages/db/src/services/search-skills.ts
    packages/db/src/services/skill-forks.ts
    apps/mcp/src/tools/list.ts
    apps/mcp/src/tools/deploy.ts
  </files>
  <action>
Read each file first, then apply:

**packages/db/src/services/search-skills.ts:**
- `searchSkillsByQuery()`: Add `eq(skills.status, "published")` to the Drizzle conditions array. This is the query used by MCP search_skills tool.

**packages/db/src/services/skill-forks.ts:**
- `getForkCount()`: Add `eq(skills.status, "published")` filter so fork counts only count published forks.
- `getTopForks()`: Add status='published' filter to the Drizzle relational query or post-filter.

**apps/mcp/src/tools/list.ts:**
- After the tenant filter in `handleListSkills()`, add a status filter. After `const tenantFiltered = ...`:
  ```typescript
  const publishedFiltered = tenantFiltered.filter(
    (s: { status?: string }) => s.status === "published" || !s.status
  );
  ```
  Then use `publishedFiltered` instead of `tenantFiltered` for the subsequent category filter. The `|| !s.status` handles any old data without the column (defensive).

**apps/mcp/src/tools/deploy.ts:**
- In `handleDeploySkill()`, after finding the skill by ID, add a check:
  ```typescript
  if (skill.status && skill.status !== "published") {
    return { content: [{ type: "text" as const, text: JSON.stringify({ success: false, error: "Skill not published", message: "This skill is not yet published. Only published skills can be deployed." }) }], isError: true };
  }
  ```
  Also add `status: true` to the columns selection in findMany if it uses column selection, or rely on the full object including status.
  </action>
  <verify>
Run `cd /home/dev/projects/relay && pnpm build --filter @everyskill/db && pnpm build --filter mcp` -- both should compile.
Run `grep -n "published" packages/db/src/services/search-skills.ts packages/db/src/services/skill-forks.ts apps/mcp/src/tools/list.ts apps/mcp/src/tools/deploy.ts` -- should show matches in all 4 files.
  </verify>
  <done>DB search service, fork service, MCP list, and MCP deploy all filter by status='published'.</done>
</task>

</tasks>

<verification>
- `pnpm build --filter web` passes
- `pnpm build --filter @everyskill/db` passes
- `pnpm build --filter mcp` passes
- Grep for 'published' across all 12 modified files shows matches in every file
- No query path returns non-published skills to public consumers
</verification>

<success_criteria>
- All 18 public query paths (per research audit) filter by status='published'
- No Drizzle or raw SQL query leaks draft/pending/rejected skills
- All 3 packages compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/34-review-pipeline-foundation/34-03-SUMMARY.md`
</output>
