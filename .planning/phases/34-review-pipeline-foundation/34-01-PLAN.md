---
phase: 34-review-pipeline-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/skills.ts
  - packages/db/src/services/skill-status.ts
  - packages/db/src/services/index.ts
  - packages/db/src/migrations/0013_add_skill_status.sql
autonomous: true

must_haves:
  truths:
    - "skills table has a status TEXT column with NOT NULL DEFAULT 'published'"
    - "State machine validates transitions and rejects invalid ones"
    - "Existing skills retain status='published' after migration"
  artifacts:
    - path: "packages/db/src/schema/skills.ts"
      provides: "status column on skills table"
      contains: "status: text"
    - path: "packages/db/src/services/skill-status.ts"
      provides: "State machine with canTransition, getValidTransitions, SKILL_STATUSES"
      exports: ["canTransition", "getValidTransitions", "SKILL_STATUSES"]
    - path: "packages/db/src/migrations/0013_add_skill_status.sql"
      provides: "Migration adding status column + indexes"
      contains: "ALTER TABLE skills ADD COLUMN"
  key_links:
    - from: "packages/db/src/services/skill-status.ts"
      to: "packages/db/src/services/index.ts"
      via: "re-export"
      pattern: "export.*skill-status"
---

<objective>
Add the `status` column to the skills schema, create the state machine service, write the migration SQL, and run it.

Purpose: Every other plan in this phase depends on the status column existing and the state machine being importable.
Output: Schema column, state machine service, migration applied to database.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status column to schema + create state machine service</name>
  <files>
    packages/db/src/schema/skills.ts
    packages/db/src/services/skill-status.ts
    packages/db/src/services/index.ts
  </files>
  <action>
1. In `packages/db/src/schema/skills.ts`, add to the skills table columns (after `tags` line):
   ```
   status: text("status").notNull().default("published"),
   ```
   DEFAULT is 'published' for backward compat -- application code will explicitly set 'draft' for new skills.

2. Create NEW file `packages/db/src/services/skill-status.ts`:
   - Export `SKILL_STATUSES` as const array: ["draft", "pending_review", "ai_reviewed", "approved", "rejected", "changes_requested", "published"]
   - Export type `SkillStatus = typeof SKILL_STATUSES[number]`
   - Export `VALID_TRANSITIONS: Record<SkillStatus, SkillStatus[]>` lookup table:
     - draft -> [pending_review]
     - pending_review -> [ai_reviewed]
     - ai_reviewed -> [approved, rejected, changes_requested]
     - approved -> [published]
     - rejected -> [draft]
     - changes_requested -> [draft]
     - published -> []
   - Export `canTransition(from: SkillStatus, to: SkillStatus): boolean`
   - Export `getValidTransitions(status: SkillStatus): SkillStatus[]`

3. In `packages/db/src/services/index.ts`, add re-export:
   ```
   export { canTransition, getValidTransitions, SKILL_STATUSES, type SkillStatus } from "./skill-status";
   ```
  </action>
  <verify>Run `cd /home/dev/projects/relay && pnpm build --filter @everyskill/db` -- should compile with no errors.</verify>
  <done>skills schema has status column, skill-status.ts exports canTransition/getValidTransitions/SKILL_STATUSES, db package builds cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Write and run migration</name>
  <files>
    packages/db/src/migrations/0013_add_skill_status.sql
  </files>
  <action>
Create `packages/db/src/migrations/0013_add_skill_status.sql`:
```sql
-- Add status column to skills table
-- DEFAULT 'published' ensures existing skills remain visible
-- New skills will explicitly set status='draft' in application code
ALTER TABLE skills ADD COLUMN IF NOT EXISTS status TEXT NOT NULL DEFAULT 'published';

-- Index for efficient filtering on status
CREATE INDEX IF NOT EXISTS skills_status_idx ON skills (status);

-- Composite index for author + status queries (My Skills page)
CREATE INDEX IF NOT EXISTS skills_author_status_idx ON skills (author_id, status);
```

Run the migration: `cd /home/dev/projects/relay && psql "$DATABASE_URL" -f packages/db/src/migrations/0013_add_skill_status.sql`

Verify existing skills are all 'published': `psql "$DATABASE_URL" -c "SELECT count(*) FROM skills WHERE status != 'published';"` -- should return 0.

Verify column exists: `psql "$DATABASE_URL" -c "SELECT status FROM skills LIMIT 1;"` -- should return 'published'.
  </action>
  <verify>psql query `SELECT count(*) FROM skills WHERE status != 'published'` returns 0. Column exists with correct default.</verify>
  <done>Migration applied, all existing skills have status='published', indexes created.</done>
</task>

</tasks>

<verification>
- `pnpm build --filter @everyskill/db` passes
- `psql "$DATABASE_URL" -c "SELECT status FROM skills LIMIT 3;"` returns 'published' for all rows
- `node -e "const {canTransition} = require('./packages/db/dist/services/skill-status'); console.log(canTransition('draft','pending_review'), canTransition('draft','published'))"` returns true, false (or equivalent TS check)
</verification>

<success_criteria>
- skills table has `status TEXT NOT NULL DEFAULT 'published'` column
- All existing skills have status='published'
- State machine correctly validates: draft->pending_review (valid), draft->published (invalid), rejected->draft (valid)
- DB package compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/34-review-pipeline-foundation/34-01-SUMMARY.md`
</output>
