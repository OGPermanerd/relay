---
phase: 34-review-pipeline-foundation
plan: 04
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - apps/web/app/(protected)/skills/[slug]/page.tsx
  - apps/web/app/(protected)/my-skills/page.tsx
  - apps/web/components/my-skills-list.tsx
  - apps/web/app/actions/submit-for-review.ts
autonomous: true

must_haves:
  truths:
    - "Non-author, non-admin users see 404 for unpublished skills"
    - "Authors can view their own draft/pending/rejected skills on skill detail page"
    - "My Skills page shows status badge for each skill"
    - "Author can submit a draft skill for review"
    - "State machine rejects invalid transitions (e.g., published -> pending_review)"
  artifacts:
    - path: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      provides: "Access control: show if published OR author OR admin, else notFound()"
      contains: "notFound"
    - path: "apps/web/app/(protected)/my-skills/page.tsx"
      provides: "Status column in query, passed to MySkillsList"
      contains: "skills.status"
    - path: "apps/web/components/my-skills-list.tsx"
      provides: "Status badge with color coding per status"
      contains: "STATUS_COLORS"
    - path: "apps/web/app/actions/submit-for-review.ts"
      provides: "Server action: draft -> pending_review transition"
      exports: ["submitForReview"]
  key_links:
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "session.user.id === skill.authorId"
      via: "author check before render"
      pattern: "isAuthor.*isAdmin.*notFound"
    - from: "apps/web/app/actions/submit-for-review.ts"
      to: "packages/db/src/services/skill-status.ts"
      via: "canTransition import"
      pattern: "canTransition.*pending_review"
    - from: "apps/web/components/my-skills-list.tsx"
      to: "submit-for-review action"
      via: "Submit for Review button on draft skills"
      pattern: "submitForReview"
---

<objective>
Add access control to skill detail page, status badges to My Skills page, and create the submit-for-review server action.

Purpose: RVPL-09 (404 for non-author on unpublished), RVPL-12 (My Skills with status), RVPL-02 (submit for review), RVPL-05 (state machine enforced).
Output: Protected skill pages, author-facing status UI, working submit-for-review flow.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Skill detail access control + submit-for-review action</name>
  <files>
    apps/web/app/(protected)/skills/[slug]/page.tsx
    apps/web/app/actions/submit-for-review.ts
  </files>
  <action>
**apps/web/app/(protected)/skills/[slug]/page.tsx:**

Move the `auth()` call BEFORE the parallel data fetches so session is available for access control. Currently session is fetched after the data fetches (~line 78). Restructure so:

1. Fetch `skill` and `session` in parallel (both are needed before rendering):
   ```typescript
   const [skill, session] = await Promise.all([
     db.query.skills.findFirst({
       where: eq(skills.slug, params.slug),
       with: { author: { columns: { id: true, name: true, image: true } } },
     }),
     auth(),
   ]);
   ```

2. After the null check on `skill` (notFound), add access control:
   ```typescript
   const isPublished = skill.status === "published";
   const isAuthorOfSkill = session?.user?.id === skill.authorId;
   const userIsAdmin = isAdmin(session);

   if (!isPublished && !isAuthorOfSkill && !userIsAdmin) {
     notFound();
   }
   ```

3. Remove the later `const session = await auth()` since it's now fetched above.

4. Update the `isAuthor` variable that already exists (~line 94) to use the one computed above:
   ```typescript
   const isAuthor = isAuthorOfSkill;
   ```

**apps/web/app/actions/submit-for-review.ts (NEW file):**

Create server action:
```typescript
"use server";

import { auth } from "@/auth";
import { db, skills } from "@everyskill/db";
import { eq, and } from "drizzle-orm";
import { canTransition } from "@everyskill/db/services/skill-status";
import { revalidatePath } from "next/cache";

export async function submitForReview(skillId: string) {
  const session = await auth();
  if (!session?.user?.id) {
    return { error: "Not authenticated" };
  }
  if (!db) return { error: "Database not configured" };

  const skill = await db.query.skills.findFirst({
    where: and(eq(skills.id, skillId), eq(skills.authorId, session.user.id)),
    columns: { id: true, status: true },
  });

  if (!skill) return { error: "Skill not found" };

  if (!canTransition(skill.status as any, "pending_review")) {
    return { error: `Cannot submit for review from status '${skill.status}'` };
  }

  await db
    .update(skills)
    .set({ status: "pending_review", updatedAt: new Date() })
    .where(eq(skills.id, skillId));

  revalidatePath("/my-skills");
  return { success: true };
}
```

Note: The `as any` cast on `skill.status` is needed because Drizzle infers the column as `string` but `canTransition` expects `SkillStatus`. This is safe since `canTransition` returns false for unknown values.
  </action>
  <verify>Run `cd /home/dev/projects/relay && pnpm build --filter web` -- should compile.</verify>
  <done>Skill detail page returns 404 for non-author/non-admin on unpublished skills. submitForReview action validates transitions via state machine.</done>
</task>

<task type="auto">
  <name>Task 2: My Skills page with status badges and submit button</name>
  <files>
    apps/web/app/(protected)/my-skills/page.tsx
    apps/web/components/my-skills-list.tsx
  </files>
  <action>
**apps/web/app/(protected)/my-skills/page.tsx:**

1. Add `status` to the select columns:
   ```typescript
   status: skills.status,
   ```

2. Include status in the serialized output:
   ```typescript
   const serialized: MySkillItem[] = userSkills.map((s) => ({
     ...s,
     createdAt: s.createdAt.toISOString(),
   }));
   ```
   (Status is already a string, so spread handles it.)

3. Update the subtitle from "Skills you've created and published" to "Skills you've created".

**apps/web/components/my-skills-list.tsx:**

1. Add `status: string` to the `MySkillItem` interface.

2. Add status color mapping:
   ```typescript
   const STATUS_COLORS: Record<string, string> = {
     draft: "bg-gray-100 text-gray-700",
     pending_review: "bg-yellow-100 text-yellow-700",
     ai_reviewed: "bg-blue-100 text-blue-700",
     approved: "bg-green-100 text-green-700",
     rejected: "bg-red-100 text-red-700",
     changes_requested: "bg-orange-100 text-orange-700",
     published: "bg-emerald-100 text-emerald-700",
   };
   ```

3. Add status display labels:
   ```typescript
   const STATUS_LABELS: Record<string, string> = {
     draft: "Draft",
     pending_review: "Pending Review",
     ai_reviewed: "AI Reviewed",
     approved: "Approved",
     rejected: "Rejected",
     changes_requested: "Changes Requested",
     published: "Published",
   };
   ```

4. Add a status badge next to the category badge in each skill item:
   ```tsx
   <span className={`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${STATUS_COLORS[skill.status] || "bg-gray-100 text-gray-700"}`}>
     {STATUS_LABELS[skill.status] || skill.status}
   </span>
   ```

5. Add a "Submit for Review" button that appears ONLY when `skill.status === "draft"`. Import `submitForReview` from the action and use `useRouter` for refresh. Since this is a client component, use a button with onClick that calls the server action:
   ```tsx
   import { submitForReview } from "@/app/actions/submit-for-review";
   import { useRouter } from "next/navigation";
   ```
   Inside the component, add `const router = useRouter();` and a small button next to the delete button:
   ```tsx
   {skill.status === "draft" && (
     <button
       onClick={async () => {
         const result = await submitForReview(skill.id);
         if (result.error) {
           alert(result.error);
         } else {
           router.refresh();
         }
       }}
       className="rounded-lg border border-blue-300 px-3 py-1.5 text-sm font-medium text-blue-700 hover:bg-blue-50"
     >
       Submit for Review
     </button>
   )}
   ```
  </action>
  <verify>Run `cd /home/dev/projects/relay && pnpm build --filter web` -- should compile.</verify>
  <done>My Skills page shows status badges for all skills. Draft skills have a "Submit for Review" button that transitions to pending_review via state machine.</done>
</task>

</tasks>

<verification>
- `pnpm build --filter web` passes
- Skill detail page access control: non-published + non-author = 404
- My Skills shows status badge with correct colors
- Submit for Review button visible on draft skills only
- submitForReview action rejects invalid transitions
</verification>

<success_criteria>
- Non-author/non-admin visitors get 404 on unpublished skill detail pages (RVPL-09)
- Authors see their own drafts on detail page and My Skills page (RVPL-12)
- My Skills shows status badge per skill
- Submit for Review transitions draft -> pending_review (RVPL-02, RVPL-05)
- State machine rejects invalid transitions (e.g., published -> pending_review returns error)
</success_criteria>

<output>
After completion, create `.planning/phases/34-review-pipeline-foundation/34-04-SUMMARY.md`
</output>
