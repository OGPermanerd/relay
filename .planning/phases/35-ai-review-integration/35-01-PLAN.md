---
phase: 35-ai-review-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/skills.ts
  - packages/db/src/migrations/0014_add_status_message.sql
  - packages/db/src/services/skill-status.ts
  - packages/db/src/services/index.ts
autonomous: true

must_haves:
  truths:
    - "Skills table has a statusMessage column for visible error state"
    - "checkAutoApprove returns true when all 3 AI scores >= threshold (default 7)"
    - "checkAutoApprove returns false when any score is below threshold"
  artifacts:
    - path: "packages/db/src/schema/skills.ts"
      provides: "statusMessage text column"
      contains: "statusMessage"
    - path: "packages/db/src/migrations/0014_add_status_message.sql"
      provides: "Migration adding status_message column"
      contains: "ALTER TABLE skills ADD COLUMN"
    - path: "packages/db/src/services/skill-status.ts"
      provides: "checkAutoApprove function and DEFAULT_AUTO_APPROVE_THRESHOLD constant"
      exports: ["checkAutoApprove", "DEFAULT_AUTO_APPROVE_THRESHOLD"]
  key_links:
    - from: "packages/db/src/services/index.ts"
      to: "packages/db/src/services/skill-status.ts"
      via: "re-export"
      pattern: "checkAutoApprove.*DEFAULT_AUTO_APPROVE_THRESHOLD"
---

<objective>
Add the `statusMessage` column to the skills schema and implement auto-approve threshold logic.

Purpose: Provides the DB column for visible error state when AI review fails (RVPL-04), and the pure function for auto-approve decisions (RVPL-11). These are foundational for both the web pipeline (Plan 02) and MCP tools (Plan 03).
Output: Updated schema, migration file, `checkAutoApprove()` function exported from `@everyskill/db`.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add statusMessage column to skills schema + migration</name>
  <files>packages/db/src/schema/skills.ts, packages/db/src/migrations/0014_add_status_message.sql</files>
  <action>
1. In `packages/db/src/schema/skills.ts`, add a `statusMessage` column to the skills table definition, right after the `status` column (line 46):
   ```
   statusMessage: text("status_message"),
   ```
   This is a nullable TEXT column with no default. It stores error messages when AI review fails, and is null when there is no error.

2. Create migration file `packages/db/src/migrations/0014_add_status_message.sql`:
   ```sql
   -- Add status_message column for AI review error visibility
   ALTER TABLE skills ADD COLUMN IF NOT EXISTS status_message TEXT;
   ```

3. Run the migration:
   ```bash
   cd /home/dev/projects/relay && psql "$DATABASE_URL" -f packages/db/src/migrations/0014_add_status_message.sql
   ```

4. Verify the column exists:
   ```bash
   psql "$DATABASE_URL" -c "SELECT column_name, data_type FROM information_schema.columns WHERE table_name='skills' AND column_name='status_message';"
   ```
  </action>
  <verify>
Migration succeeds. `psql "$DATABASE_URL" -c "\d skills"` shows `status_message` column of type `text`.
  </verify>
  <done>The skills table has a `status_message` TEXT column. The schema type `Skill` includes `statusMessage: string | null`.</done>
</task>

<task type="auto">
  <name>Task 2: Add checkAutoApprove function to skill-status service</name>
  <files>packages/db/src/services/skill-status.ts, packages/db/src/services/index.ts</files>
  <action>
1. In `packages/db/src/services/skill-status.ts`, add after the existing `getValidTransitions` function:

   ```typescript
   /**
    * Default threshold for auto-approving skills.
    * All three AI review categories (quality, clarity, completeness)
    * must score at or above this threshold.
    */
   export const DEFAULT_AUTO_APPROVE_THRESHOLD = 7;

   /**
    * Check if a skill's AI review scores meet the auto-approve threshold.
    * Returns true if ALL three category scores >= threshold.
    */
   export function checkAutoApprove(
     categories: {
       quality: { score: number };
       clarity: { score: number };
       completeness: { score: number };
     },
     threshold: number = DEFAULT_AUTO_APPROVE_THRESHOLD
   ): boolean {
     return (
       categories.quality.score >= threshold &&
       categories.clarity.score >= threshold &&
       categories.completeness.score >= threshold
     );
   }
   ```

2. In `packages/db/src/services/index.ts`, update the skill-status re-export block to add `checkAutoApprove` and `DEFAULT_AUTO_APPROVE_THRESHOLD`:
   ```typescript
   export {
     canTransition,
     getValidTransitions,
     checkAutoApprove,
     DEFAULT_AUTO_APPROVE_THRESHOLD,
     SKILL_STATUSES,
     VALID_TRANSITIONS,
     type SkillStatus,
   } from "./skill-status";
   ```

3. Verify the build:
   ```bash
   cd /home/dev/projects/relay && npx tsc --noEmit -p packages/db/tsconfig.json
   ```
  </action>
  <verify>
`npx tsc --noEmit -p packages/db/tsconfig.json` passes (or only pre-existing errors). The function is importable: `import { checkAutoApprove, DEFAULT_AUTO_APPROVE_THRESHOLD } from "@everyskill/db/services/skill-status"`.
  </verify>
  <done>`checkAutoApprove({quality:{score:8},clarity:{score:7},completeness:{score:9}})` returns true. `checkAutoApprove({quality:{score:6},clarity:{score:8},completeness:{score:9}})` returns false (quality below 7). `DEFAULT_AUTO_APPROVE_THRESHOLD` is 7.</done>
</task>

</tasks>

<verification>
1. `psql "$DATABASE_URL" -c "SELECT column_name FROM information_schema.columns WHERE table_name='skills' AND column_name='status_message';"` returns 1 row
2. `checkAutoApprove` and `DEFAULT_AUTO_APPROVE_THRESHOLD` are exported from `@everyskill/db/services/skill-status`
3. `pnpm build` in packages/db succeeds (or only pre-existing errors)
</verification>

<success_criteria>
- skills table has status_message TEXT column
- checkAutoApprove correctly evaluates threshold logic
- Both are available for import by downstream plans (02 and 03)
</success_criteria>

<output>
After completion, create `.planning/phases/35-ai-review-integration/35-01-SUMMARY.md`
</output>
