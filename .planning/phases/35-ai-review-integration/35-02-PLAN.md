---
phase: 35-ai-review-integration
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - apps/web/app/actions/submit-for-review.ts
  - apps/web/components/my-skills-list.tsx
  - apps/web/app/(protected)/my-skills/page.tsx
autonomous: true

must_haves:
  truths:
    - "Submitting a skill for review triggers AI review inline (awaited, not fire-and-forget)"
    - "On AI review success, skill transitions to ai_reviewed (or published if auto-approved)"
    - "On AI review failure, skill stays in pending_review with a visible statusMessage"
    - "Authors can retry a failed review from My Skills page"
    - "Auto-approved skills skip the admin queue and go straight to published"
  artifacts:
    - path: "apps/web/app/actions/submit-for-review.ts"
      provides: "Pipeline-integrated submitForReview with AI review, error handling, and auto-approve"
      contains: "generateSkillReview"
    - path: "apps/web/components/my-skills-list.tsx"
      provides: "Error state display and retry button for failed reviews"
      contains: "statusMessage"
    - path: "apps/web/app/(protected)/my-skills/page.tsx"
      provides: "statusMessage included in query results"
      contains: "statusMessage"
  key_links:
    - from: "apps/web/app/actions/submit-for-review.ts"
      to: "apps/web/lib/ai-review.ts"
      via: "import generateSkillReview"
      pattern: "generateSkillReview"
    - from: "apps/web/app/actions/submit-for-review.ts"
      to: "packages/db/src/services/skill-status.ts"
      via: "import checkAutoApprove"
      pattern: "checkAutoApprove"
    - from: "apps/web/components/my-skills-list.tsx"
      to: "apps/web/app/actions/submit-for-review.ts"
      via: "retry button onClick"
      pattern: "submitForReview"
---

<objective>
Rewrite the submitForReview action to run AI review inline with error handling, auto-approve logic, and visible error state. Update My Skills UI to show errors and retry.

Purpose: This is the core pipeline work -- RVPL-03 (auto AI review on submit), RVPL-04 (error handling), and RVPL-11 (auto-approve threshold). When an author clicks "Submit for Review", the AI review runs immediately. Success transitions to ai_reviewed (or published if auto-approved). Failure shows a visible error with a retry option.
Output: Working submit-for-review pipeline with error handling and auto-approve.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-ai-review-integration/35-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite submitForReview action with inline AI review pipeline</name>
  <files>apps/web/app/actions/submit-for-review.ts</files>
  <action>
Rewrite `apps/web/app/actions/submit-for-review.ts` to implement the full pipeline. The current file is 35 lines and just transitions status. Replace with:

1. Keep the "use server" directive, auth check, and skill ownership check.
2. Expand the skill query to include `name`, `description`, `content`, `category` (needed for AI review).
3. Allow retry: if `currentStatus === "pending_review"`, skip the transition and go straight to AI review. If transitioning from `draft` or `changes_requested`, first transition to `pending_review`.
4. Clear `statusMessage` when starting (whether new submit or retry).
5. In a try/catch block, `await generateSkillReview(skill.name, skill.description, skill.content, skill.category)`.
6. On success: call `upsertSkillReview()` with the result, then call `checkAutoApprove(categories)`.
   - If NOT auto-approved: set status to `"ai_reviewed"` (single update).
   - If auto-approved: transition through the full state machine path programmatically â€” set status to `"ai_reviewed"`, then `"approved"`, then `"published"` in three sequential updates within the same try block. This respects the state machine audit trail while completing instantly for the user. Do NOT skip intermediate states.
7. On failure (catch block): set `statusMessage` to a user-friendly error ("AI review failed -- please try again later."), keep status as `pending_review`. Log the error with `console.error`.
8. Call `revalidatePath("/my-skills")` in both success and error paths.
9. Return `{ success: true, autoApproved: boolean }` on success, `{ error: string }` on failure.

Imports needed:
- `generateSkillReview, REVIEW_MODEL` from `@/lib/ai-review`
- `hashContent` from `@/lib/content-hash`
- `checkAutoApprove` from `@everyskill/db/services/skill-status`
- `upsertSkillReview` from `@everyskill/db/services/skill-reviews`

IMPORTANT: Do NOT use fire-and-forget (`.catch(() => {})`). The AI review MUST be awaited.
IMPORTANT: For auto-approve, go through the FULL state machine path: `ai_reviewed -> approved -> published` in three sequential DB updates. This respects the state machine and maintains an audit trail. All three updates happen within the same try block, so the user sees it as instant.
  </action>
  <verify>
`cd /home/dev/projects/relay/apps/web && npx next build` completes without errors in submit-for-review.ts. The action imports resolve correctly.
  </verify>
  <done>submitForReview awaits AI review, stores the review result, checks auto-approve threshold, and handles errors with statusMessage. Retry from pending_review works without a state machine error.</done>
</task>

<task type="auto">
  <name>Task 2: Update My Skills UI for error state display and retry</name>
  <files>apps/web/components/my-skills-list.tsx, apps/web/app/(protected)/my-skills/page.tsx</files>
  <action>
1. In `apps/web/app/(protected)/my-skills/page.tsx`:
   - Add `statusMessage: skills.statusMessage` to the select query (around line 30).
   - Add `statusMessage: s.statusMessage` to the serialized mapping.

2. In `apps/web/components/my-skills-list.tsx`:
   - Add `statusMessage: string | null;` to the `MySkillItem` interface.
   - Below the status badge (after line 79), add a conditional error display:
     ```tsx
     {skill.statusMessage && (
       <span className="inline-flex items-center gap-1 text-xs text-red-600">
         {skill.statusMessage}
       </span>
     )}
     ```
   - Change the "Submit for Review" button to also show when status is `pending_review` AND there is a `statusMessage` (error state = retry). Update the condition on line 94 from:
     ```tsx
     {skill.status === "draft" && (
     ```
     to:
     ```tsx
     {(skill.status === "draft" || skill.status === "changes_requested" || (skill.status === "pending_review" && skill.statusMessage)) && (
     ```
   - Change the button label to "Retry Review" when status is `pending_review`:
     ```tsx
     {skill.status === "pending_review" ? "Retry Review" : "Submit for Review"}
     ```
   - Add loading state: use `useState` for a `submitting` skill ID. While submitting, show a spinner/disabled state on the button. Clear on completion. This prevents double-clicks during the AI review call (which takes 5-15 seconds).

3. Verify with build:
   ```bash
   cd /home/dev/projects/relay/apps/web && npx next build
   ```
  </action>
  <verify>
`npx next build` succeeds. The My Skills page queries `statusMessage` and passes it to the client component. The error message and retry button render conditionally.
  </verify>
  <done>My Skills page shows error messages for failed AI reviews. Authors see a "Retry Review" button when a review has failed. The submit button shows loading state during AI review. Skills in `changes_requested` status also show the submit button.</done>
</task>

</tasks>

<verification>
1. `npx next build` passes for apps/web
2. submitForReview action awaits generateSkillReview (grep for `await generateSkillReview`)
3. Error path sets statusMessage on the skill row (grep for `statusMessage.*failed`)
4. Auto-approve path transitions to published (grep for `checkAutoApprove`)
5. My Skills UI conditionally renders statusMessage and retry button
</verification>

<success_criteria>
- Submitting a skill for review runs AI review synchronously
- AI review success transitions to ai_reviewed or published (if auto-approved)
- AI review failure leaves skill in pending_review with visible error message
- Authors can retry failed reviews from My Skills page
- No fire-and-forget patterns in the pipeline path
</success_criteria>

<output>
After completion, create `.planning/phases/35-ai-review-integration/35-02-SUMMARY.md`
</output>
