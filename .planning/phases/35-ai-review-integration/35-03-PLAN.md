---
phase: 35-ai-review-integration
plan: 03
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - apps/mcp/package.json
  - apps/mcp/src/tools/review-skill.ts
  - apps/mcp/src/tools/submit-for-review.ts
  - apps/mcp/src/tools/check-review-status.ts
  - apps/mcp/src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "From Claude, a user can trigger an advisory AI review of a skill (review_skill)"
    - "From Claude, a user can submit a draft skill for admin review (submit_for_review)"
    - "From Claude, a user can check the status of their submitted skills (check_review_status)"
    - "review_skill is advisory-only -- it returns scores but does NOT change skill status"
    - "submit_for_review triggers the full pipeline (AI review + auto-approve check)"
    - "All three tools require authentication (EVERYSKILL_API_KEY)"
  artifacts:
    - path: "apps/mcp/src/tools/review-skill.ts"
      provides: "MCPR-01: Advisory AI review tool"
      contains: "review_skill"
    - path: "apps/mcp/src/tools/submit-for-review.ts"
      provides: "MCPR-02: Pipeline submit tool"
      contains: "submit_for_review"
    - path: "apps/mcp/src/tools/check-review-status.ts"
      provides: "MCPR-03: Status check tool"
      contains: "check_review_status"
    - path: "apps/mcp/src/tools/index.ts"
      provides: "Tool registration imports"
      contains: "review-skill"
  key_links:
    - from: "apps/mcp/src/tools/review-skill.ts"
      to: "@anthropic-ai/sdk"
      via: "import Anthropic"
      pattern: "new Anthropic"
    - from: "apps/mcp/src/tools/submit-for-review.ts"
      to: "@everyskill/db/services/skill-status"
      via: "import canTransition, checkAutoApprove"
      pattern: "checkAutoApprove"
    - from: "apps/mcp/src/tools/check-review-status.ts"
      to: "@everyskill/db"
      via: "import db, skills"
      pattern: "db.select"
---

<objective>
Add three new MCP tools: review_skill (advisory AI review), submit_for_review (pipeline submit), and check_review_status (status inquiry).

Purpose: MCPR-01, MCPR-02, MCPR-03 -- authors and admins can trigger reviews, submit skills, and check status from within a Claude conversation. This brings the full review pipeline to the MCP interface.
Output: Three registered MCP tools, `@anthropic-ai/sdk` installed in apps/mcp.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-ai-review-integration/35-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @anthropic-ai/sdk and create review_skill + check_review_status tools</name>
  <files>apps/mcp/package.json, apps/mcp/src/tools/review-skill.ts, apps/mcp/src/tools/check-review-status.ts, apps/mcp/src/tools/index.ts</files>
  <action>
1. Install the Anthropic SDK in apps/mcp:
   ```bash
   cd /home/dev/projects/relay/apps/mcp && pnpm add @anthropic-ai/sdk
   ```

2. Create `apps/mcp/src/tools/review-skill.ts`:
   - Import: `z`, `Anthropic` from `@anthropic-ai/sdk`, `server` from `../server.js`, `db` from `@everyskill/db`, `getUserId`, `getTenantId` from `../auth.js`, `upsertSkillReview` from `@everyskill/db/services/skill-reviews`
   - Duplicate the AI review generation function (~50 lines) from `apps/web/lib/ai-review.ts`. Copy the `REVIEW_MODEL`, `SYSTEM_PROMPT`, `REVIEW_JSON_SCHEMA`, zod `ReviewOutputSchema`, and `generateSkillReview` function. This is necessary because apps/mcp cannot import from apps/web (different build systems).
   - Also duplicate `hashContent` inline (5 lines from `apps/web/lib/content-hash.ts` -- uses `crypto.subtle.digest`).
   - Register tool `"review_skill"` with:
     - Description: "Run an AI review on a skill. Returns quality, clarity, and completeness scores with suggestions. This is advisory-only -- it does not change the skill's status. Requires ANTHROPIC_API_KEY in MCP server environment."
     - inputSchema: `{ skillId: z.string().describe("ID of the skill to review") }`
   - Handler:
     a. Check `getUserId()` -- return auth error if null.
     b. Check `!db` -- return DB error if null.
     c. Check `process.env.ANTHROPIC_API_KEY` -- return clear error "ANTHROPIC_API_KEY is required. Add it to your MCP server configuration." if missing.
     d. Fetch skill by ID (no ownership check -- advisory review can be run on any skill the user can see): `db.select({id, name, description, content, category, authorId}).from(skills).where(eq(skills.id, skillId))`. Check skill exists.
     e. Call `generateSkillReview(skill.name, skill.description, skill.content, skill.category)` in try/catch.
     f. On success: call `upsertSkillReview()` to store the result (with `requestedBy: userId`, `reviewedContentHash` from `hashContent`, `modelName: REVIEW_MODEL`). Return the scores and suggestions as JSON.
     g. On failure: return `{ error: "AI review failed: " + errorMessage }` with `isError: true`.
   - Advisory-only: do NOT change skill status. No state machine transitions.

3. Create `apps/mcp/src/tools/check-review-status.ts`:
   - Import: `z`, `server` from `../server.js`, `db`, `skills` from `@everyskill/db`, `skillReviews` from `@everyskill/db/schema`, `getUserId` from `../auth.js`, `eq`, `desc` from `drizzle-orm`
   - Register tool `"check_review_status"` with:
     - Description: "Check the review status of your submitted skills. Shows current status, AI review scores if available, and any error messages. Omit skillId to see all your non-published skills."
     - inputSchema: `{ skillId: z.string().optional().describe("Check a specific skill by ID. Omit to see all your submitted skills.") }`
   - Handler:
     a. Check `getUserId()` -- return auth error if null.
     b. Check `!db` -- return DB error if null.
     c. If skillId provided: fetch that skill (with ownership check: `authorId = userId`). Also left-join `skillReviews` to get AI scores if they exist.
     d. If no skillId: fetch all user's skills that are NOT in `published` or `draft` status (i.e., skills in the pipeline: `pending_review`, `ai_reviewed`, `approved`, `rejected`, `changes_requested`). Left-join reviews.
     e. Return JSON with: `{ skills: [{ id, name, status, statusMessage, review: { quality, clarity, completeness, summary } | null }] }`

4. Update `apps/mcp/src/tools/index.ts` to import the two new tools:
   ```typescript
   import "./review-skill.js";
   import "./check-review-status.js";
   ```
   (submit-for-review.ts will be added in Task 2)

5. Verify: `cd /home/dev/projects/relay/apps/mcp && npx tsup src/index.ts --format cjs --dts` builds without errors.
  </action>
  <verify>
`cd /home/dev/projects/relay/apps/mcp && npx tsup src/index.ts --format cjs --dts` succeeds. `@anthropic-ai/sdk` is in package.json dependencies. `review-skill.ts` and `check-review-status.ts` exist and register tools.
  </verify>
  <done>review_skill tool runs advisory AI review and returns scores without changing status. check_review_status tool returns pipeline status and scores for user's skills. Both require authentication.</done>
</task>

<task type="auto">
  <name>Task 2: Create submit_for_review MCP tool with full pipeline logic</name>
  <files>apps/mcp/src/tools/submit-for-review.ts, apps/mcp/src/tools/index.ts</files>
  <action>
1. Create `apps/mcp/src/tools/submit-for-review.ts`:
   - Import: `z`, `server` from `../server.js`, `db`, `skills` from `@everyskill/db`, `getUserId`, `getTenantId` from `../auth.js`, `eq`, `and` from `drizzle-orm`, `canTransition`, `checkAutoApprove`, `type SkillStatus` from `@everyskill/db/services/skill-status`, `upsertSkillReview` from `@everyskill/db/services/skill-reviews`
   - Import the duplicated `generateSkillReview` and `hashContent` from `./review-skill.js` (export them from review-skill.ts so they can be shared). Or duplicate inline if the import causes circular issues.
   - Register tool `"submit_for_review"` with:
     - Description: "Submit a draft skill for review. This triggers AI analysis and may auto-approve high-scoring skills. The skill must be in 'draft' or 'changes_requested' status (or 'pending_review' for retry)."
     - inputSchema: `{ skillId: z.string().describe("ID of the skill to submit for review") }`
   - Handler (mirrors the web action logic):
     a. Check `getUserId()` -- return auth error if null.
     b. Check `!db` -- return DB error if null.
     c. Check `process.env.ANTHROPIC_API_KEY` -- return clear error if missing. CRITICAL: This check MUST happen BEFORE any status transitions to avoid leaving the skill stuck in `pending_review` without an error message.
     d. Fetch skill by ID with ownership check (`authorId = userId`). Include `name`, `description`, `content`, `category`, `status`.
     e. Check state machine: if `currentStatus !== "pending_review"` and `!canTransition(currentStatus, "pending_review")`, return error.
     f. If not already `pending_review`, transition to `pending_review` and clear `statusMessage`.
     g. If already `pending_review`, just clear `statusMessage` (retry case).
     h. Try: run `generateSkillReview()`, call `upsertSkillReview()`, call `checkAutoApprove()`.
        - If auto-approved: set status to `"published"`.
        - If not: set status to `"ai_reviewed"`.
        - Return `{ success: true, autoApproved, scores: { quality, clarity, completeness } }`.
     i. Catch: set `statusMessage` on the skill, return `{ error: "AI review failed...", retryable: true }` with `isError: true`.

2. Update `apps/mcp/src/tools/index.ts` to add:
   ```typescript
   import "./submit-for-review.js";
   ```

3. The duplicated `generateSkillReview` and `hashContent` should be in `review-skill.ts` and exported so `submit-for-review.ts` can import them. This avoids creating a separate helper file while preventing code duplication between the two MCP tools. The key constraint: MCP tools cannot import from `apps/web`. Keep it self-contained within `apps/mcp`.

4. Verify full MCP build:
   ```bash
   cd /home/dev/projects/relay/apps/mcp && npx tsup src/index.ts --format cjs --dts
   ```
  </action>
  <verify>
`cd /home/dev/projects/relay/apps/mcp && npx tsup src/index.ts --format cjs --dts` succeeds. The submit_for_review tool is registered. All three tools (review_skill, submit_for_review, check_review_status) are imported in index.ts.
  </verify>
  <done>submit_for_review MCP tool implements the full pipeline: state check, AI review, auto-approve check, error handling with statusMessage. All three MCP tools are registered and the MCP server builds successfully.</done>
</task>

</tasks>

<verification>
1. `cd /home/dev/projects/relay/apps/mcp && npx tsup src/index.ts --format cjs --dts` builds clean
2. `@anthropic-ai/sdk` is in apps/mcp/package.json dependencies
3. Three tool files exist: review-skill.ts, submit-for-review.ts, check-review-status.ts
4. All three are imported in index.ts
5. review_skill does NOT change skill status (advisory-only)
6. submit_for_review DOES change skill status (pipeline)
7. check_review_status returns status + scores for user's skills
</verification>

<success_criteria>
- review_skill returns AI scores without changing status
- submit_for_review triggers full pipeline (AI review + auto-approve)
- check_review_status returns pipeline status for user's skills
- All tools require authentication and handle missing ANTHROPIC_API_KEY gracefully
- MCP server builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/35-ai-review-integration/35-03-SUMMARY.md`
</output>
