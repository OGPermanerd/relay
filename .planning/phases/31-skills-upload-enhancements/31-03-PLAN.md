---
phase: 31-skills-upload-enhancements
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/ai-review.ts
  - apps/web/app/actions/skills.ts
  - packages/db/src/schema/skill-reviews.ts
  - packages/db/src/services/skill-reviews.ts
  - packages/db/src/migrations/0009_add_suggested_description.sql
autonomous: true

must_haves:
  truths:
    - "AI review runs automatically when a skill is uploaded -- no button click needed"
    - "AI review output includes a suggestedDescription field the user can later copy"
    - "Skill creation succeeds even if AI review fails (fire-and-forget)"
    - "suggestedDescription is persisted in the skill_reviews table"
  artifacts:
    - path: "apps/web/lib/ai-review.ts"
      provides: "Enhanced review with suggestedDescription output"
      exports: ["generateSkillReview", "ReviewOutputSchema", "REVIEW_MODEL"]
    - path: "apps/web/app/actions/skills.ts"
      provides: "Auto-trigger AI review after skill creation"
      contains: "autoGenerateReview"
    - path: "packages/db/src/migrations/0009_add_suggested_description.sql"
      provides: "Add suggested_description column to skill_reviews"
  key_links:
    - from: "apps/web/app/actions/skills.ts"
      to: "apps/web/lib/ai-review.ts"
      via: "import generateSkillReview"
      pattern: "generateSkillReview"
    - from: "apps/web/app/actions/skills.ts"
      to: "packages/db/src/services/skill-reviews.ts"
      via: "upsertSkillReview call in autoGenerateReview"
      pattern: "upsertSkillReview"
---

<objective>
Enhance AI review to include description suggestions (SKILL-06) and auto-trigger on upload (SKILL-05).

Purpose: Authors get immediate AI feedback on their skill, including a suggested improved description, without having to click "Request Review".
Output: Enhanced ai-review.ts with suggestedDescription, auto-trigger in skills.ts server action, DB migration for new column.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/web/lib/ai-review.ts
@apps/web/app/actions/skills.ts
@packages/db/src/schema/skill-reviews.ts
@packages/db/src/services/skill-reviews.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add suggestedDescription to AI review schema and output</name>
  <files>
    apps/web/lib/ai-review.ts
    packages/db/src/schema/skill-reviews.ts
    packages/db/src/services/skill-reviews.ts
    packages/db/src/migrations/0009_add_suggested_description.sql
  </files>
  <action>
    1. In `packages/db/src/schema/skill-reviews.ts`:
       - Add a new column: `suggestedDescription: text("suggested_description")` (nullable -- backward compatible)
       - Update the `SkillReview` and `NewSkillReview` types (they're auto-inferred, so just adding the column suffices)

    2. Create `packages/db/src/migrations/0009_add_suggested_description.sql`:
       ```sql
       ALTER TABLE skill_reviews ADD COLUMN IF NOT EXISTS suggested_description text;
       ```

    3. Run the migration: `cd packages/db && psql "$DATABASE_URL" -f src/migrations/0009_add_suggested_description.sql`

    4. In `packages/db/src/services/skill-reviews.ts`:
       - Add `suggestedDescription?: string` to `UpsertSkillReviewParams`
       - Update the upsert SQL to include `suggested_description` in both INSERT and ON CONFLICT UPDATE
       - Note: The ON CONFLICT is on `(tenant_id, skill_id)` per the unique index `skill_reviews_tenant_skill_unique`

    5. In `apps/web/lib/ai-review.ts`:
       - Add `suggestedDescription: z.string()` to `ReviewOutputSchema`
       - Update the system prompt to request a `suggestedDescription` field: "Also provide a `suggestedDescription` -- an improved version of the skill description that keeps the same meaning but improves clarity, specificity, and searchability."
       - Add the field to the JSON schema example in the system prompt
       - Switch from manual JSON prompting to `output_config` with `zodOutputFormat` from `@anthropic-ai/sdk/helpers/zod` for guaranteed schema compliance:
         ```typescript
         import { zodOutputFormat } from "@anthropic-ai/sdk/helpers/zod";
         // In generateSkillReview:
         const response = await client.messages.create({
           model: REVIEW_MODEL,
           max_tokens: 2048,
           system: SYSTEM_PROMPT,  // Remove JSON schema from system prompt
           messages: [{ role: "user", content: userPrompt }],
           output_config: { format: zodOutputFormat(ReviewOutputSchema) },
         });
         ```
       - Remove the manual JSON parsing and code-fence stripping since structured outputs guarantees valid JSON
       - Keep the `stop_reason` check but update it -- structured outputs uses `stop_reason: "end_turn"`
       - Parse the response text block with `ReviewOutputSchema.parse(JSON.parse(textBlock.text))`
  </action>
  <verify>
    - `cd packages/db && psql "$DATABASE_URL" -c "\d skill_reviews"` shows `suggested_description` column
    - `cd apps/web && npx tsc --noEmit` passes (no type errors)
  </verify>
  <done>
    - skill_reviews table has suggested_description nullable text column
    - ReviewOutputSchema includes suggestedDescription
    - upsertSkillReview accepts and persists suggestedDescription
    - generateSkillReview uses structured outputs via zodOutputFormat
  </done>
</task>

<task type="auto">
  <name>Task 2: Auto-trigger AI review on upload</name>
  <files>
    apps/web/app/actions/skills.ts
  </files>
  <action>
    1. Add imports at top of `apps/web/app/actions/skills.ts`:
       ```typescript
       import { generateSkillReview, REVIEW_MODEL } from "@/lib/ai-review";
       import { upsertSkillReview } from "@everyskill/db/services/skill-reviews";
       import { hashContent as hashContentForReview } from "@/lib/content-hash";
       ```
       Note: `hashContent` is already imported -- reuse it, no duplicate import needed.

    2. Create a private async helper function `autoGenerateReview` in the same file:
       ```typescript
       async function autoGenerateReview(
         skillId: string,
         name: string,
         description: string,
         content: string,
         category: string,
         userId: string,
         tenantId: string
       ): Promise<void> {
         try {
           const reviewOutput = await generateSkillReview(name, description, content, category);
           const { summary, suggestedDescription, ...categories } = reviewOutput;
           const contentHash = await hashContent(content);
           await upsertSkillReview({
             skillId,
             requestedBy: userId,
             categories,
             summary,
             suggestedDescription,
             reviewedContentHash: contentHash,
             modelName: REVIEW_MODEL,
           });
         } catch {
           // Intentionally swallowed -- review is fire-and-forget
         }
       }
       ```

    3. In the `checkAndCreateSkill` function, after the existing `generateSkillEmbedding` fire-and-forget call (line ~249), add:
       ```typescript
       autoGenerateReview(
         newSkill.id, name, description || "", rawContent, category,
         session.user.id, DEFAULT_TENANT_ID
       ).catch(() => {});
       ```

    4. Do the same in the `createSkill` function after its `generateSkillEmbedding` call (line ~432).

    5. The upsert SQL in skill-reviews.ts service needs to include `tenant_id`. Verify the existing upsert SQL includes tenant_id in the INSERT. Currently it does NOT include tenant_id in the INSERT values. Fix this:
       - Add `tenant_id` to the INSERT column list and values
       - The ON CONFLICT unique index is on `(tenant_id, skill_id)`, so the conflict target should match
       - Update ON CONFLICT clause: `ON CONFLICT (tenant_id, skill_id) DO UPDATE SET ...`
       - Add `tenantId: string` to `UpsertSkillReviewParams` (already has skillId)

    IMPORTANT: Do NOT remove the existing `requestAiReview` action in `app/actions/ai-review.ts` -- it still serves the on-demand re-review button on skill detail pages. The auto-review is additive.
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - `cd apps/web && pnpm build` succeeds
    - Grep `autoGenerateReview` in skills.ts -- appears in both checkAndCreateSkill and createSkill
  </verify>
  <done>
    - Both checkAndCreateSkill and createSkill fire-and-forget an AI review after skill creation
    - Review failures do not block skill creation
    - Existing on-demand review action preserved
  </done>
</task>

</tasks>

<verification>
1. `cd apps/web && pnpm build` -- clean build
2. `psql "$DATABASE_URL" -c "SELECT column_name FROM information_schema.columns WHERE table_name='skill_reviews' AND column_name='suggested_description'"` -- returns 1 row
3. TypeScript compiles without errors across packages/db and apps/web
</verification>

<success_criteria>
- AI review schema includes suggestedDescription
- skill_reviews table has suggested_description column
- Skill upload auto-triggers review (fire-and-forget)
- On-demand review still works
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/31-skills-upload-enhancements/31-03-SUMMARY.md`
</output>
