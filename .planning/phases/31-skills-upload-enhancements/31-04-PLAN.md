---
phase: 31-skills-upload-enhancements
plan: 04
type: execute
wave: 2
depends_on: ["31-02"]
files_modified:
  - apps/web/components/similarity-pane.tsx
  - apps/web/components/similar-skills-warning.tsx
  - apps/web/components/similar-skills-section.tsx
  - apps/web/components/skill-upload-form.tsx
  - apps/web/app/(protected)/skills/new/page.tsx
  - apps/web/lib/similar-skills.ts
  - apps/web/lib/embedding-generator.ts
  - apps/web/components/ai-review-display.tsx
autonomous: true

must_haves:
  truths:
    - "Upload page shows a right-hand similarity pane with AI-summarized matches"
    - "Semantic vs name match labels are hidden from users in all similarity displays"
    - "AI review summary data enriches similarity embeddings for more accurate matching"
    - "Similarity pane shows description, category, usage count, and similarity percentage"
    - "User can still Publish Anyway or Create as Variation from the similarity pane"
  artifacts:
    - path: "apps/web/components/similarity-pane.tsx"
      provides: "Right-hand panel showing similar skills with rich details"
      exports: ["SimilarityPane"]
    - path: "apps/web/components/similar-skills-warning.tsx"
      provides: "Updated warning without matchType label"
    - path: "apps/web/components/similar-skills-section.tsx"
      provides: "Updated section without matchType label"
  key_links:
    - from: "apps/web/components/skill-upload-form.tsx"
      to: "apps/web/components/similarity-pane.tsx"
      via: "SimilarityPane rendered conditionally when similarSkills exist"
      pattern: "<SimilarityPane"
    - from: "apps/web/app/actions/skills.ts"
      to: "apps/web/lib/similar-skills.ts"
      via: "checkSimilarSkills called during upload"
      pattern: "checkSimilarSkills"
    - from: "apps/web/lib/embedding-generator.ts"
      to: "apps/web/lib/ai-review.ts"
      via: "enriched embedding includes review summary"
      pattern: "reviewSummary|review.*summary"
---

<objective>
Create a rich similarity pane for the upload flow (SKILL-02), hide match type labels (SKILL-03), and wire AI review data into similarity detection (SKILL-07).

Purpose: Uploaders see detailed, AI-enriched similarity matches in a side panel, giving them better context to decide whether to publish, create a variation, or message the author.
Output: New SimilarityPane component, updated upload layout, hidden match labels, enriched embeddings.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/web/components/skill-upload-form.tsx
@apps/web/components/similar-skills-warning.tsx
@apps/web/components/similar-skills-section.tsx
@apps/web/lib/similar-skills.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Hide matchType labels and create SimilarityPane component</name>
  <files>
    apps/web/components/similar-skills-warning.tsx
    apps/web/components/similar-skills-section.tsx
    apps/web/components/similarity-pane.tsx
  </files>
  <action>
    SKILL-03: Hide matchType labels in existing components:

    1. In `apps/web/components/similar-skills-warning.tsx`:
       - Remove the `<span>` that renders "Semantic match" / "Name match" (lines 68-76)
       - Keep the similarity percentage badge
       - Keep "Create as Variation" button

    2. In `apps/web/components/similar-skills-section.tsx`:
       - Remove the `<span>` that renders "Semantic" / "Name" (lines 30-38)
       - Keep the similarity percentage badge

    SKILL-02: Create the rich SimilarityPane component:

    3. Create `apps/web/components/similarity-pane.tsx`:
       - "use client" component
       - Props: `{ similarSkills: SimilarSkillResult[], onProceed: () => void, onCancel: () => void, onCreateVariation: (skillId: string) => void, onMessageAuthor?: (skill: SimilarSkillResult) => void, isPending: boolean }`
       - Layout: Fixed-width right panel (w-80 on desktop, full-width sheet on mobile)
       - Header: "Similar Skills Found" with count badge
       - For each similar skill, render a card with:
         - Skill name (link to `/skills/{slug}`, opens in new tab)
         - Similarity percentage as a progress-bar style indicator (colored: green > 80%, amber 50-80%, red < 50%)
         - Description (truncated to 100 chars)
         - Category badge
         - Usage count + average rating
         - Two action buttons: "Create as Variation" and "Message Author" (the latter calls `onMessageAuthor` callback)
       - Bottom actions: "Go Back" button and "Publish Anyway" button
       - Subtle note: "This is just a heads up -- you can always publish your skill."
       - Mobile: When screen is < lg breakpoint, pane renders as a full-width section above the form (not side panel)
       - Do NOT display matchType anywhere (SKILL-03)
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - Grep for "matchType" in similar-skills-warning.tsx and similar-skills-section.tsx -- only in type imports, not in JSX rendering
    - Grep for "Semantic match" or "Name match" in components/ -- 0 results
  </verify>
  <done>
    - matchType labels removed from similar-skills-warning.tsx and similar-skills-section.tsx
    - SimilarityPane component created with rich skill cards, action buttons, and responsive layout
    - No match type labels visible anywhere in UI
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire SimilarityPane into upload form and enrich embeddings with AI review</name>
  <files>
    apps/web/components/skill-upload-form.tsx
    apps/web/app/(protected)/skills/new/page.tsx
    apps/web/lib/similar-skills.ts
    apps/web/lib/embedding-generator.ts
  </files>
  <action>
    SKILL-02: Integrate SimilarityPane into upload flow:

    1. In `apps/web/app/(protected)/skills/new/page.tsx` (the page that renders SkillUploadForm):
       - Change the layout from centered `max-w-2xl` to a wider container: `max-w-5xl mx-auto`
       - The SkillUploadForm itself handles the two-column layout internally

    2. In `apps/web/components/skill-upload-form.tsx`:
       - Import `SimilarityPane` from "./similarity-pane"
       - Replace the current `SimilarSkillsWarning` rendering with a two-column layout:
         - When `showWarning && state.similarSkills?.length > 0`:
           - Render a flex container: `<div className="flex flex-col lg:flex-row gap-6">`
           - Left column: the form fields (keep existing `<div className="space-y-6">` block) -- NOT hidden
           - Right column: `<SimilarityPane>` with all the props (similarSkills, onProceed, onCancel, onCreateVariation, isPending)
         - When no similar skills: render form at full width with `max-w-2xl` constraint
       - Add an `onMessageAuthor` callback prop placeholder that stores the selected skill for messaging (will be wired in Plan 05)
       - Store `messageTarget` state: `const [messageTarget, setMessageTarget] = useState<SimilarSkillResult | null>(null)`
       - Pass `onMessageAuthor={setMessageTarget}` to SimilarityPane
       - Remove the old `SimilarSkillsWarning` import (it's replaced by SimilarityPane in the upload flow)
       - Keep `SimilarSkillsWarning` component file -- it may be used elsewhere

    SKILL-07: Enrich embeddings with AI review data:

    3. In `apps/web/lib/embedding-generator.ts`:
       - Read the current `generateSkillEmbedding` function
       - Currently it creates embeddings from `${name} ${description}`
       - After the embedding is generated and stored, add NO changes here -- the enrichment happens in the server action

    4. In `apps/web/app/actions/skills.ts` (the `autoGenerateReview` function added in Plan 02):
       - After the review is successfully generated and upserted, regenerate the embedding with enriched text:
         ```typescript
         // After upsertSkillReview succeeds:
         // Re-embed with enriched text for better similarity matching (SKILL-07)
         generateSkillEmbedding(
           skillId, name,
           `${description} ${reviewOutput.summary}`
         ).catch(() => {});
         ```
       - This makes future similarity searches find this skill when the AI's understanding matches
       - Import `generateSkillEmbedding` (already imported in the file)
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - `cd apps/web && pnpm build` succeeds
    - Grep for "SimilarityPane" in skill-upload-form.tsx -- at least 1 match
    - Grep for "SimilarSkillsWarning" in skill-upload-form.tsx -- 0 matches (replaced)
    - Run Playwright tests: `cd apps/web && node_modules/.bin/playwright test` to verify upload page loads
  </verify>
  <done>
    - Upload page shows form + similarity pane side-by-side when similar skills found
    - SimilarityPane renders rich cards with all skill details
    - AI review summary enriches embeddings for better future similarity matching
    - Form is visible alongside pane (not hidden)
    - Build passes, upload page loads
  </done>
</task>

</tasks>

<verification>
1. `cd apps/web && pnpm build` -- clean build
2. `cd apps/web && npx tsc --noEmit` -- no type errors
3. Grep for "Semantic match" or "Name match" across all components -- 0 results
4. Playwright test: upload page loads without errors
</verification>

<success_criteria>
- Rich similarity pane shows on upload when similar skills found
- No matchType labels visible to users
- AI review data enriches embeddings after review completion
- Two-column layout on desktop, stacked on mobile
- All existing upload functionality preserved (Publish Anyway, Create as Variation)
</success_criteria>

<output>
After completion, create `.planning/phases/31-skills-upload-enhancements/31-04-SUMMARY.md`
</output>
