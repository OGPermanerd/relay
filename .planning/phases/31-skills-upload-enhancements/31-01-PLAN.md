---
phase: 31-skills-upload-enhancements
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/relative-time.ts
  - apps/web/lib/__tests__/relative-time.test.ts
  - apps/web/components/relative-time.tsx
  - apps/web/components/skill-detail.tsx
  - apps/web/components/skills-table-row.tsx
  - apps/web/components/my-skills-list.tsx
  - apps/web/components/ai-review-display.tsx
  - apps/web/components/reviews-list.tsx
  - apps/web/components/admin-key-manager.tsx
  - apps/web/components/api-key-manager.tsx
  - apps/web/components/employee-detail-modal.tsx
  - apps/web/components/employees-tab.tsx
  - apps/web/components/admin-settings-form.tsx
  - apps/web/app/(protected)/users/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "All timestamps in cards, lists, and detail views show relative format like '1d 5h 3min ago'"
    - "Timestamps older than 1 year show format like '1y 5d ago'"
    - "No hydration mismatches occur on any page with timestamps"
    - "Chart axis labels remain as absolute dates (not converted)"
  artifacts:
    - path: "apps/web/lib/relative-time.ts"
      provides: "formatRelativeTime pure function"
      exports: ["formatRelativeTime"]
    - path: "apps/web/lib/__tests__/relative-time.test.ts"
      provides: "Unit tests for relative time formatting"
      min_lines: 30
    - path: "apps/web/components/relative-time.tsx"
      provides: "Hydration-safe RelativeTime client component"
      exports: ["RelativeTime"]
  key_links:
    - from: "apps/web/components/relative-time.tsx"
      to: "apps/web/lib/relative-time.ts"
      via: "import formatRelativeTime"
      pattern: "import.*formatRelativeTime.*from.*relative-time"
    - from: "apps/web/components/skill-detail.tsx"
      to: "apps/web/components/relative-time.tsx"
      via: "RelativeTime component usage"
      pattern: "<RelativeTime"
---

<objective>
Implement relative timestamps across the platform (SKILL-01): create a TDD-tested pure function, a hydration-safe client component, and replace all 13 timestamp locations.

Purpose: Users see friendly relative times ("1d 5h 3min ago") instead of absolute dates, improving scannability.
Output: `formatRelativeTime()` utility, `<RelativeTime>` component, all timestamp locations converted.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
</context>

<feature>
  <name>Relative Timestamp Formatting</name>
  <files>apps/web/lib/relative-time.ts, apps/web/lib/__tests__/relative-time.test.ts</files>
  <behavior>
    formatRelativeTime(date: Date | string): string

    Cases (relative to "now"):
    - 0 seconds ago -> "just now"
    - 30 seconds ago -> "just now" (minutes granularity)
    - 5 minutes ago -> "5min ago"
    - 2 hours 15 minutes ago -> "2h 15min ago"
    - 1 day 3 hours ago -> "1d 3h ago"
    - 7 days 0 hours ago -> "7d ago" (minutes omitted when days >= 7)
    - 30 days 5 hours ago -> "30d 5h ago"
    - 365 days ago -> "1y ago"
    - 400 days ago -> "1y 35d ago"
    - future date -> "just now"
    - string ISO date input -> same as Date input
  </behavior>
  <implementation>
    RED: Write tests for all cases above using jest/vitest. Mock Date.now() with a fixed timestamp.
    GREEN: Implement formatRelativeTime as a pure function with no dependencies.
    REFACTOR: Clean up edge cases if needed.

    Then create `<RelativeTime>` client component:
    - "use client" directive
    - useState("") for initial render (empty string avoids hydration mismatch)
    - useEffect sets text on mount and refreshes every 60 seconds via setInterval
    - Accepts `date: Date | string` prop
    - Renders `<span>{text}</span>`

    Then replace all timestamp locations:
    - Files using `toLocaleDateString()`: skill-detail.tsx (line 46), reviews-list.tsx (line 56), admin-key-manager.tsx (lines 65, 339), api-key-manager.tsx (lines 66, 332, 338), employee-detail-modal.tsx (lines 100, 155), employees-tab.tsx (line 193)
    - Files using manual UTC formatting: skills-table-row.tsx (lines 96-111 formatDate), my-skills-list.tsx (lines 8-11 formatDate), ai-review-display.tsx (lines 48-57), admin-settings-form.tsx (line 20)
    - Server component: app/(protected)/users/[id]/page.tsx (line 89) -- pass date as ISO string, use RelativeTime component
    - DO NOT convert chart axis labels in skill-analytics-modal.tsx or usage-area-chart.tsx

    CRITICAL: Never use toLocaleDateString() or toLocaleString() -- causes hydration mismatches per MEMORY.md.
  </implementation>
</feature>

<verification>
1. `cd apps/web && npx vitest run lib/__tests__/relative-time.test.ts` -- all tests pass
2. `cd apps/web && npx tsc --noEmit` -- no TypeScript errors
3. `cd apps/web && pnpm build` -- successful build with no warnings
4. Grep for `toLocaleDateString` in components -- should return 0 matches (except chart files)
5. Playwright test on skills page loads without hydration errors
</verification>

<success_criteria>
- formatRelativeTime passes all test cases
- RelativeTime component renders without hydration warnings
- All 13 timestamp locations converted (chart axes excluded)
- Zero instances of toLocaleDateString in non-chart component files
- Build succeeds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/31-skills-upload-enhancements/31-01-SUMMARY.md`
</output>
