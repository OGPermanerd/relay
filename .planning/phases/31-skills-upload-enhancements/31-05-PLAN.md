---
phase: 31-skills-upload-enhancements
plan: 05
type: execute
wave: 3
depends_on: ["31-03", "31-04"]
files_modified:
  - apps/web/app/actions/skill-messages.ts
  - apps/web/components/message-author-dialog.tsx
  - apps/web/components/skill-upload-form.tsx
  - apps/web/components/similarity-pane.tsx
  - apps/web/app/(protected)/messages/page.tsx
  - apps/web/components/messages-list.tsx
autonomous: false

must_haves:
  truths:
    - "User can click 'Message Author' on a similar skill during upload to propose grouping"
    - "A dialog appears where user types a message proposing to group their skill under the existing one"
    - "Message is persisted in skill_messages table with correct tenant_id, user IDs, and skill IDs"
    - "Recipients can view received messages on a /messages page"
  artifacts:
    - path: "apps/web/app/actions/skill-messages.ts"
      provides: "Server action for sending grouping proposals"
      exports: ["sendGroupingProposal", "getMyMessages", "markAsRead"]
    - path: "apps/web/components/message-author-dialog.tsx"
      provides: "Modal dialog for composing grouping proposal message"
      exports: ["MessageAuthorDialog"]
    - path: "apps/web/app/(protected)/messages/page.tsx"
      provides: "Messages inbox page for viewing received proposals"
    - path: "apps/web/components/messages-list.tsx"
      provides: "List component rendering received messages"
      exports: ["MessagesList"]
  key_links:
    - from: "apps/web/components/skill-upload-form.tsx"
      to: "apps/web/components/message-author-dialog.tsx"
      via: "MessageAuthorDialog rendered when messageTarget is set"
      pattern: "<MessageAuthorDialog"
    - from: "apps/web/components/message-author-dialog.tsx"
      to: "apps/web/app/actions/skill-messages.ts"
      via: "form action calls sendGroupingProposal"
      pattern: "sendGroupingProposal"
    - from: "apps/web/app/actions/skill-messages.ts"
      to: "packages/db/src/services/skill-messages.ts"
      via: "import sendSkillMessage"
      pattern: "sendSkillMessage"
---

<objective>
Implement the "Message Author" feature (SKILL-04): dialog for proposing skill grouping, server action, and messages inbox page.

Purpose: When an uploader sees a similar skill, they can propose grouping their skill under it by messaging the original author directly.
Output: MessageAuthorDialog component, server action, /messages page.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/31-skills-upload-enhancements/31-03-SUMMARY.md
@.planning/phases/31-skills-upload-enhancements/31-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server action and message dialog component</name>
  <files>
    apps/web/app/actions/skill-messages.ts
    apps/web/components/message-author-dialog.tsx
    apps/web/components/skill-upload-form.tsx
    apps/web/components/similarity-pane.tsx
  </files>
  <action>
    1. Create `apps/web/app/actions/skill-messages.ts`:
       ```typescript
       "use server";
       import { auth } from "@/auth";
       import { sendSkillMessage, getMessagesForUser, markMessageRead } from "@everyskill/db/services/skill-messages";

       const DEFAULT_TENANT_ID = "default-tenant-000-0000-000000000000";

       export type MessageState = { error?: string; success?: boolean };

       export async function sendGroupingProposal(
         prevState: MessageState,
         formData: FormData
       ): Promise<MessageState> {
         const session = await auth();
         if (!session?.user?.id) return { error: "Not authenticated" };

         const toUserId = formData.get("toUserId") as string;
         const subjectSkillId = formData.get("subjectSkillId") as string;
         const proposedParentSkillId = formData.get("proposedParentSkillId") as string;
         const message = formData.get("message") as string;

         if (!toUserId || !subjectSkillId || !message?.trim())
           return { error: "Missing required fields" };
         if (message.length > 1000) return { error: "Message too long (max 1000 chars)" };

         const id = await sendSkillMessage({
           tenantId: DEFAULT_TENANT_ID,
           fromUserId: session.user.id,
           toUserId,
           subjectSkillId,
           proposedParentSkillId: proposedParentSkillId || undefined,
           message: message.trim(),
         });

         return id ? { success: true } : { error: "Failed to send message" };
       }

       export async function getMyMessages() {
         const session = await auth();
         if (!session?.user?.id) return [];
         return getMessagesForUser(session.user.id);
       }

       export async function markAsRead(formData: FormData) {
         const session = await auth();
         if (!session?.user?.id) return;
         const messageId = formData.get("messageId") as string;
         if (messageId) await markMessageRead(messageId);
       }
       ```

    2. Create `apps/web/components/message-author-dialog.tsx`:
       - "use client" component
       - Props: `{ skill: SimilarSkillResult, onClose: () => void }`
       - Renders a modal overlay (fixed inset-0 bg-black/50 z-50)
       - Modal content: white card centered on screen
       - Header: "Propose Grouping" with skill name
       - Body text: "Suggest that your skill could be grouped under '{skill.skillName}' by the original author."
       - Form with `useActionState(sendGroupingProposal, {})`:
         - Hidden inputs: toUserId (need authorId -- add `authorId` to SimilarSkillResult interface), subjectSkillId (skill.skillId), proposedParentSkillId (skill.skillId)
         - Textarea for message (placeholder: "Explain why your skill would be a good fit under this existing skill...", max 1000 chars)
         - Counter showing chars remaining
         - Submit button: "Send Proposal" (disabled while pending)
         - Cancel button calls onClose
       - On success: show "Message sent!" briefly, then call onClose
       - On error: show error message in red

    3. Update `SimilarSkillResult` interface in `apps/web/lib/similar-skills.ts`:
       - Add `authorId?: string` to the interface
       - Update the SQL queries in `trySemanticSearch` and `checkSimilarSkills` to also SELECT `s.author_id AS "authorId"` so the author ID is available for messaging
       - Note: This file is "use server" so it can query the DB directly

    4. Wire into `apps/web/components/skill-upload-form.tsx`:
       - Import `MessageAuthorDialog`
       - The `messageTarget` state was prepared in Plan 04. Render:
         ```tsx
         {messageTarget && (
           <MessageAuthorDialog
             skill={messageTarget}
             onClose={() => setMessageTarget(null)}
           />
         )}
         ```

    5. Ensure `apps/web/components/similarity-pane.tsx` passes `onMessageAuthor` through to each skill card's "Message Author" button. The button should call `onMessageAuthor(skill)` with the full skill object.
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - `cd apps/web && pnpm build` succeeds
    - Grep for "MessageAuthorDialog" in skill-upload-form.tsx -- present
    - Grep for "sendGroupingProposal" in message-author-dialog.tsx -- present
    - Grep for "authorId" in similar-skills.ts queries -- present
  </verify>
  <done>
    - sendGroupingProposal server action creates skill_messages records
    - MessageAuthorDialog modal opens from SimilarityPane "Message Author" button
    - authorId included in similarity query results for message targeting
    - Dialog validates input and shows success/error feedback
  </done>
</task>

<task type="auto">
  <name>Task 2: Messages inbox page</name>
  <files>
    apps/web/app/(protected)/messages/page.tsx
    apps/web/components/messages-list.tsx
  </files>
  <action>
    1. Create `apps/web/components/messages-list.tsx`:
       - "use client" component
       - Props: `{ messages: Array<{ id, fromUserId, subjectSkillId, proposedParentSkillId, message, status, createdAt, readAt }> }`
       - Renders a list of message cards:
         - Each card shows: message text, status badge (pending/accepted/declined), relative time (use `<RelativeTime>` from Plan 01 if available, otherwise format manually with ISO string)
         - Unread messages (readAt is null) have a blue left border
         - "Mark as read" button on unread messages (calls markAsRead server action)
         - Subject skill name -- for now show the skill ID (full skill name resolution would require joins, keep simple for v1)
       - Empty state: "No messages yet. When someone proposes grouping a skill under yours, it will appear here."

    2. Create `apps/web/app/(protected)/messages/page.tsx`:
       - Server component
       - Import and call `getMyMessages` server action
       - Render page with title "Messages" and `<MessagesList messages={messages} />`
       - Note: This page is inside `(protected)` route group so auth is already handled by layout

    3. Messages page should be accessible but does NOT need a nav link yet (nav changes are out of scope for this phase). Users access it via `/messages` URL directly or from future notification features (Phase 33).
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - `cd apps/web && pnpm build` succeeds
    - Run Playwright: verify `/messages` page loads without errors for authenticated user
  </verify>
  <done>
    - /messages page renders list of received grouping proposals
    - Unread messages visually distinguished
    - Mark as read functionality works
    - Empty state shown when no messages
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete upload enhancement flow: similarity pane, message author dialog, and messages inbox.</what-built>
  <how-to-verify>
    1. Visit http://localhost:2000/skills/new
    2. Upload a skill with a name/description similar to an existing skill
    3. Verify: right-hand similarity pane appears with similar skills (no "Semantic match"/"Name match" labels)
    4. Verify: each similar skill shows description, category, usage count, similarity percentage
    5. Click "Message Author" on a similar skill -- verify dialog opens
    6. Type a message and submit -- verify success feedback
    7. Click "Publish Anyway" -- verify skill is created
    8. Visit http://localhost:2000/messages -- verify the sent message appears for the recipient
    9. Check timestamps across the platform show relative format ("Xd Xh Xmin ago")
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `cd apps/web && pnpm build` -- clean build
2. `cd apps/web && npx tsc --noEmit` -- no type errors
3. Upload flow: similarity pane shows, message dialog works, skill creates
4. /messages page accessible and renders messages
5. All timestamps in relative format
</verification>

<success_criteria>
- "Message Author" button on similar skills opens a compose dialog
- Grouping proposals persist in skill_messages table
- /messages page shows received proposals
- End-to-end upload flow works: form -> similarity pane -> message or publish
</success_criteria>

<output>
After completion, create `.planning/phases/31-skills-upload-enhancements/31-05-SUMMARY.md`
</output>
