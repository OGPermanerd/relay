---
phase: 07-ratings-reviews
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/web/components/reviews-list.tsx
  - apps/web/app/(protected)/skills/[slug]/page.tsx
  - apps/web/components/skill-detail.tsx
autonomous: true

must_haves:
  truths:
    - "Skill detail page shows rating form for logged-in users"
    - "User's existing rating pre-populates the rating form"
    - "Reviews from other users display below skill content"
    - "Rating form submission updates displayed average rating"
  artifacts:
    - path: "apps/web/components/reviews-list.tsx"
      provides: "Display component for skill reviews"
      exports: ["ReviewsList"]
    - path: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      provides: "Skill page with rating form and reviews integration"
      contains: "RatingForm"
    - path: "apps/web/components/skill-detail.tsx"
      provides: "Updated skill detail with reviews section slot"
      contains: "children"
  key_links:
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "apps/web/components/rating-form.tsx"
      via: "import and render RatingForm"
      pattern: "import.*RatingForm"
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "@relay/db ratings query"
      via: "db.query.ratings for existing rating and reviews"
      pattern: "db\\.query\\.ratings"
---

<objective>
Integrate rating form and reviews display into the skill detail page.

Purpose: Users can see existing reviews and submit their own ratings directly on the skill detail page. The form pre-populates with the user's existing rating if they've already rated the skill.

Output: ReviewsList component, updated skill detail page with rating form integration, and queries for user's existing rating and skill reviews.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ratings-reviews/07-RESEARCH.md
@.planning/phases/07-ratings-reviews/07-01-SUMMARY.md

# Existing files to modify
@apps/web/app/(protected)/skills/[slug]/page.tsx (add rating form and reviews)
@apps/web/components/skill-detail.tsx (add children prop for reviews section)

# Database patterns
@packages/db/src/relations/index.ts (ratings.user relation for reviews query)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Reviews List Component</name>
  <files>apps/web/components/reviews-list.tsx</files>
  <action>
Create component to display existing reviews following the pattern from 07-RESEARCH.md:

1. Import Image from next/image
2. Define Review interface:
   - id: string
   - rating: number
   - comment: string | null
   - hoursSavedEstimate: number | null
   - createdAt: Date
   - user: { name: string | null; image: string | null }
3. Define ReviewsListProps: { reviews: Review[] }
4. Export function ReviewsList({ reviews }: ReviewsListProps)
5. If reviews.length === 0, return: <p className="text-gray-500">No reviews yet. Be the first to review!</p>
6. Return div with className="space-y-4" containing mapped reviews:
   - Container: rounded-lg border border-gray-200 p-4
   - Header row with flex items-center gap-3:
     - User avatar: Image with width/height 32, rounded-full OR fallback div with first letter
     - User info div:
       - Name: <p className="font-medium">{review.user.name || 'Anonymous'}</p>
       - Rating + date row: flex items-center gap-2
         - Stars: '★'.repeat(rating) + '☆'.repeat(5 - rating) in text-yellow-500
         - Date: text-sm text-gray-500, use toLocaleDateString()
   - Comment (if exists): <p className="mt-2 text-gray-700">{review.comment}</p>
   - Hours saved (if exists): <p className="mt-1 text-sm text-gray-500">Estimated {review.hoursSavedEstimate} hours saved</p>
  </action>
  <verify>TypeScript compiles: `pnpm --filter web exec tsc --noEmit`</verify>
  <done>ReviewsList component renders list of reviews with user info, rating stars, comments, and time estimates</done>
</task>

<task type="auto">
  <name>Task 2: Update Skill Detail Page with Rating Integration</name>
  <files>apps/web/app/(protected)/skills/[slug]/page.tsx</files>
  <action>
Add rating form and reviews to skill detail page:

1. Add imports:
   - auth from @/auth
   - RatingForm from @/components/rating-form
   - ReviewsList from @/components/reviews-list
   - ratings from @relay/db/schema (for query)
   - desc from drizzle-orm (for ordering reviews)

2. Inside the async function, after fetching skill:
   a. Get session: const session = await auth()

   b. Query user's existing rating (if logged in):
   ```typescript
   const existingRating = session?.user?.id && db
     ? await db.query.ratings.findFirst({
         where: and(
           eq(ratings.skillId, skill.id),
           eq(ratings.userId, session.user.id)
         ),
         columns: {
           rating: true,
           comment: true,
           hoursSavedEstimate: true,
         },
       })
     : null;
   ```
   Import 'and' from drizzle-orm

   c. Query reviews for this skill (exclude current user to avoid showing their own review in list):
   ```typescript
   const reviews = db
     ? await db.query.ratings.findMany({
         where: session?.user?.id
           ? and(
               eq(ratings.skillId, skill.id),
               sql`${ratings.userId} != ${session.user.id}`
             )
           : eq(ratings.skillId, skill.id),
         with: {
           user: {
             columns: { name: true, image: true },
           },
         },
         orderBy: desc(ratings.createdAt),
         limit: 20,
       })
     : [];
   ```
   Import 'sql' from drizzle-orm

3. Update the return JSX to include RatingForm and ReviewsList after SkillDetail:
   - Keep existing SkillDetail component
   - Add conditional section for rating form (only if session exists):
     ```tsx
     {session?.user && (
       <div className="mt-8 rounded-lg border border-gray-200 p-6">
         <h2 className="mb-4 text-xl font-semibold">
           {existingRating ? 'Update Your Rating' : 'Rate This Skill'}
         </h2>
         <RatingForm
           skillId={skill.id}
           skillSlug={skill.slug}
           existingRating={existingRating ?? undefined}
         />
       </div>
     )}
     ```
   - Add reviews section:
     ```tsx
     <div className="mt-8">
       <h2 className="mb-4 text-xl font-semibold">Reviews ({reviews.length})</h2>
       <ReviewsList reviews={reviews} />
     </div>
     ```
  </action>
  <verify>TypeScript compiles: `pnpm --filter web exec tsc --noEmit`</verify>
  <done>Skill detail page shows rating form for logged-in users (pre-populated if they already rated) and displays reviews from other users</done>
</task>

<task type="auto">
  <name>Task 3: Update Skill Detail Component for Reviews Section</name>
  <files>apps/web/components/skill-detail.tsx</files>
  <action>
The skill detail component doesn't need children props since we're adding the rating form and reviews directly in the page component. However, verify the component structure works well with the additions by:

1. Review the existing SkillDetail component structure
2. Ensure there's no structural issue with adding content after it in the page
3. If the component wraps everything in a container div, the page-level additions will be siblings

If needed, add a small visual separator at the bottom of SkillDetail:
- Add a horizontal divider at the end: <div className="mt-8 border-t border-gray-200" />

This ensures clean visual separation between skill content and the reviews/rating section added by the page.

Note: Keep the component focused on skill display. The rating form and reviews are page-level concerns that belong in the page component for better separation.
  </action>
  <verify>TypeScript compiles: `pnpm --filter web exec tsc --noEmit`</verify>
  <done>SkillDetail component provides clean visual boundary for page-level additions</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `pnpm --filter web exec tsc --noEmit`
2. Lint passes: `pnpm --filter web lint`
3. Build succeeds: `pnpm --filter web build`
4. Manual check: Navigate to /skills/[any-skill] while logged in to see rating form
</verification>

<success_criteria>
- ReviewsList component displays reviews with user avatars, star ratings, comments, and time estimates
- Skill detail page queries user's existing rating and pre-populates form
- Skill detail page displays reviews from other users
- Rating form only shows for authenticated users
- Form shows "Update Your Rating" when user has existing rating
</success_criteria>

<output>
After completion, create `.planning/phases/07-ratings-reviews/07-02-SUMMARY.md`
</output>
