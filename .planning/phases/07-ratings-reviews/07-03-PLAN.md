---
phase: 07-ratings-reviews
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - apps/web/lib/skill-stats.ts
  - apps/web/components/stat-card.tsx
  - apps/web/components/skill-detail.tsx
autonomous: true

must_haves:
  truths:
    - "FTE Days Saved uses average user-submitted time estimate when available"
    - "FTE Days Saved falls back to creator estimate when no user estimates exist"
    - "Skill detail page indicates whether FTE is based on user or creator estimates"
    - "Skill cards reflect aggregated ratings from user reviews"
  artifacts:
    - path: "apps/web/lib/skill-stats.ts"
      provides: "Updated getSkillStats with user estimate override logic"
      exports: ["getSkillStats", "SkillStats"]
    - path: "apps/web/components/skill-detail.tsx"
      provides: "FTE source indicator display"
      contains: "hoursSavedSource"
  key_links:
    - from: "apps/web/lib/skill-stats.ts"
      to: "ratings table hoursSavedEstimate"
      via: "SQL avg query"
      pattern: "avg.*hoursSavedEstimate"
    - from: "apps/web/components/skill-detail.tsx"
      to: "apps/web/lib/skill-stats.ts"
      via: "stats.hoursSavedSource prop"
      pattern: "hoursSavedSource"
---

<objective>
Update FTE Days Saved calculation to use user-submitted time estimates when available, overriding creator estimates.

Purpose: RATE-02 requires user-submitted time estimates to override creator estimates when available. This makes the FTE Days Saved metric more accurate by incorporating real user feedback on actual time saved.

Output: Updated getSkillStats function with user estimate aggregation, extended SkillStats interface, and UI indicator showing estimate source.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ratings-reviews/07-RESEARCH.md
@.planning/phases/07-ratings-reviews/07-01-SUMMARY.md
@.planning/phases/07-ratings-reviews/07-02-SUMMARY.md

# Files to modify
@apps/web/lib/skill-stats.ts (add user estimate override logic)
@apps/web/components/skill-detail.tsx (display estimate source)

# Schema reference
@packages/db/src/schema/ratings.ts (hoursSavedEstimate column)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SkillStats Interface and getSkillStats Function</name>
  <files>apps/web/lib/skill-stats.ts</files>
  <action>
Update getSkillStats to query user-submitted time estimates and use them when available:

1. Update SkillStats interface to add:
   - hoursSavedSource: 'user' | 'creator' (indicates which estimate is used)
   - hoursSavedEstimate: number (the value used for FTE calculation)

2. Update the default return (when db is null) to include:
   - hoursSavedSource: 'creator'
   - hoursSavedEstimate: 0

3. After the existing queries, add a new query for user time estimates:
   ```typescript
   // Query 4 - Average user-submitted hours saved estimate
   const timeEstimateResult = await db
     .select({
       avgHoursSaved: sql<string>`avg(${ratings.hoursSavedEstimate})`,
       countWithEstimate: sql<number>`cast(count(${ratings.hoursSavedEstimate}) as integer)`,
     })
     .from(ratings)
     .where(eq(ratings.skillId, skillId));
   ```
   Note: avg returns string in drizzle-orm, parse with parseFloat

4. Calculate effective hours saved:
   ```typescript
   const userAvgHours = timeEstimateResult?.[0]?.avgHoursSaved
     ? parseFloat(timeEstimateResult[0].avgHoursSaved)
     : null;
   const countWithEstimate = timeEstimateResult?.[0]?.countWithEstimate ?? 0;

   // Use user estimates if at least one exists, otherwise creator estimate
   const effectiveHoursSaved = countWithEstimate > 0 && userAvgHours !== null
     ? userAvgHours
     : (skill?.hoursSaved ?? 1);

   const hoursSavedSource: 'user' | 'creator' = countWithEstimate > 0 && userAvgHours !== null
     ? 'user'
     : 'creator';
   ```

5. Update FTE calculation to use effectiveHoursSaved:
   ```typescript
   const fteDaysSaved = Math.round(((totalUses * effectiveHoursSaved) / 8) * 10) / 10;
   ```

6. Update return statement to include new fields:
   ```typescript
   return {
     totalUses,
     uniqueUsers: usageResult?.[0]?.uniqueUsers ?? 0,
     averageRating: formatRating(skill?.averageRating ?? null),
     totalRatings: ratingResult?.[0]?.totalRatings ?? 0,
     fteDaysSaved,
     hoursSavedSource,
     hoursSavedEstimate: effectiveHoursSaved,
   };
   ```
  </action>
  <verify>TypeScript compiles: `pnpm --filter web exec tsc --noEmit`</verify>
  <done>getSkillStats returns hoursSavedSource ('user' or 'creator') and uses user-submitted estimates when available for FTE calculation</done>
</task>

<task type="auto">
  <name>Task 2: Update Skill Detail to Display Estimate Source</name>
  <files>apps/web/components/skill-detail.tsx</files>
  <action>
Update skill detail component to show the source of the time estimate:

1. Update SkillStats import/type to include new fields (hoursSavedSource, hoursSavedEstimate)
   Note: The type is imported from @/lib/skill-stats, which was updated in Task 1

2. In the stats grid or FTE display area, add an indicator showing estimate source.
   Below the FTE Days Saved StatCard or in the "Estimated time saved per use" section:

   ```tsx
   {/* Estimate source indicator */}
   <p className="mt-1 text-xs text-gray-500">
     {stats.hoursSavedSource === 'user' ? (
       <>Based on {stats.totalRatings} community estimate{stats.totalRatings !== 1 ? 's' : ''}</>
     ) : (
       <>Creator estimate: {stats.hoursSavedEstimate} hr{stats.hoursSavedEstimate !== 1 ? 's' : ''}/use</>
     )}
   </p>
   ```

3. Consider adding this as a subtitle under the FTE Days Saved stat card.
   Option A: Add to the existing section below stats grid where hoursSaved is shown
   Option B: Modify the StatCard to accept an optional subtitle prop

   Prefer Option A for simplicity - update the existing hoursSaved display section:
   ```tsx
   {/* Usage section - update existing */}
   <div className="mt-6">
     <p className="text-sm text-gray-600">
       Estimated time saved per use: {stats.hoursSavedEstimate} hour
       {stats.hoursSavedEstimate !== 1 ? 's' : ''}
       {' '}
       <span className="text-gray-400">
         ({stats.hoursSavedSource === 'user'
           ? `avg of ${stats.totalRatings} user estimate${stats.totalRatings !== 1 ? 's' : ''}`
           : 'creator estimate'})
       </span>
     </p>
   </div>
   ```

4. Remove the conditional on skill.hoursSaved since we now always have stats.hoursSavedEstimate

Note: The stats object now provides hoursSavedEstimate which is either from users or creator, so we always have a value to display.
  </action>
  <verify>TypeScript compiles: `pnpm --filter web exec tsc --noEmit`</verify>
  <done>Skill detail page shows estimate source (user community or creator) next to time saved display</done>
</task>

<task type="auto">
  <name>Task 3: Verify Rating Aggregation on Skill Cards</name>
  <files>apps/web/components/skill-card.tsx</files>
  <action>
Verify that skill cards correctly display aggregated ratings. The skill cards should already be pulling from the denormalized averageRating field on the skills table, which is updated by updateSkillRating when ratings are submitted.

1. Read the skill-card.tsx component to verify it displays averageRating
2. If it uses a different source (like stats), verify that source includes rating data
3. Ensure the card shows:
   - Average rating (from skills.averageRating, formatted)
   - Optionally: total ratings count

If the card already uses the skill's averageRating field, no changes needed since:
- Plan 07-01 calls updateSkillRating after each rating submission
- updateSkillRating recalculates and stores the average in skills.averageRating
- Skill cards read from skills.averageRating (denormalized for performance)

If changes ARE needed, update the skill card to:
- Display the formatted rating (use formatRating from @relay/db)
- Show rating count if available

This is a verification task - document findings in the summary. If the card already handles ratings correctly, note "No changes needed - skill cards already display denormalized averageRating".
  </action>
  <verify>Review skill-card.tsx and confirm it displays skill.averageRating or equivalent. Run `pnpm --filter web exec tsc --noEmit` to verify no type errors.</verify>
  <done>Skill cards display aggregated ratings from denormalized averageRating field (or updated to do so)</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `pnpm --filter web exec tsc --noEmit`
2. Lint passes: `pnpm --filter web lint`
3. Build succeeds: `pnpm --filter web build`
4. Unit test (if time permits): Create test for getSkillStats with mock ratings data
5. Manual verification:
   - View skill with no user estimates → shows "creator estimate"
   - Submit rating with hours saved estimate → FTE recalculates
   - View skill with user estimates → shows "avg of N user estimates"
</verification>

<success_criteria>
- SkillStats interface includes hoursSavedSource ('user' | 'creator') and hoursSavedEstimate
- getSkillStats queries avg(hoursSavedEstimate) from ratings and uses it when available
- FTE Days Saved calculation uses effective estimate (user or creator)
- Skill detail page indicates whether estimate is from users or creator
- Skill cards reflect aggregated ratings (via denormalized averageRating)
</success_criteria>

<output>
After completion, create `.planning/phases/07-ratings-reviews/07-03-SUMMARY.md`
</output>
