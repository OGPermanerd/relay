---
phase: 07-ratings-reviews
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/actions/ratings.ts
  - apps/web/components/star-rating-input.tsx
  - apps/web/components/rating-form.tsx
autonomous: true

must_haves:
  truths:
    - "Rating Server Action accepts skillId, rating (1-5), optional comment, optional hoursSavedEstimate"
    - "Validation fails gracefully with field-level errors"
    - "Star rating input supports keyboard navigation and screen readers"
  artifacts:
    - path: "apps/web/app/actions/ratings.ts"
      provides: "submitRating Server Action with Zod validation"
      exports: ["submitRating", "RatingState"]
    - path: "apps/web/components/star-rating-input.tsx"
      provides: "Accessible star rating input using radio buttons"
      exports: ["StarRatingInput"]
    - path: "apps/web/components/rating-form.tsx"
      provides: "Rating form with useActionState"
      exports: ["RatingForm"]
  key_links:
    - from: "apps/web/components/rating-form.tsx"
      to: "apps/web/app/actions/ratings.ts"
      via: "useActionState(submitRating)"
      pattern: "useActionState.*submitRating"
---

<objective>
Create rating submission Server Action and form components for skill ratings.

Purpose: Enable users to rate skills 1-5 stars with optional comment and time-saved estimate, following established patterns from skill upload (Server Actions, useActionState, Zod validation).

Output: Rating action, star rating input component, and rating form component ready for integration into skill detail page.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ratings-reviews/07-RESEARCH.md

# Existing patterns to follow
@apps/web/app/actions/skills.ts (Server Action pattern with Zod, useActionState state type)
@apps/web/components/skill-upload-form.tsx (useActionState pattern, form structure)
@packages/db/src/schema/ratings.ts (ratings table schema)
@packages/db/src/services/skill-metrics.ts (updateSkillRating service to call after insert)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Rating Server Action</name>
  <files>apps/web/app/actions/ratings.ts</files>
  <action>
Create Server Action for rating submission following the pattern in apps/web/app/actions/skills.ts:

1. Add "use server" directive at top
2. Import: auth from @/auth, db and ratings from @relay/db, updateSkillRating from @relay/db, revalidatePath from next/cache, z from zod, eq and and from drizzle-orm
3. Create ratingSchema with Zod:
   - skillId: z.string().uuid('Invalid skill ID')
   - rating: z.coerce.number().int().min(1).max(5) with custom messages
   - comment: z.string().max(2000).optional().transform(val => val || null)
   - hoursSavedEstimate: z.coerce.number().min(0).max(1000).optional().transform(val => val || null)
4. Export RatingState type: { errors?: Record<string, string[]>; message?: string; success?: boolean }
5. Export async function submitRating(prevState: RatingState, formData: FormData): Promise<RatingState>
   - Check session with auth(), return message if not signed in
   - Parse formData with ratingSchema.safeParse(), return errors if invalid
   - Check db exists, return message if not
   - Query for existing rating: db.query.ratings.findFirst where skillId AND userId
   - If exists: update with db.update(ratings).set({...}).where(eq(ratings.id, existing.id))
   - If not exists: insert with db.insert(ratings).values({...})
   - Call await updateSkillRating(skillId) to recalculate denormalized average
   - Call revalidatePath('/skills') and revalidatePath(`/skills/${skillSlug}`)
   - Note: skillSlug needs to be passed in formData for proper revalidation
   - Add skillSlug to schema: z.string().min(1)
   - Return { success: true } on success
   - Wrap in try/catch, log error in dev, return generic message on failure
  </action>
  <verify>TypeScript compiles without errors: `pnpm --filter web exec tsc --noEmit`</verify>
  <done>Server Action exports submitRating function accepting FormData with skillId, skillSlug, rating, comment, hoursSavedEstimate</done>
</task>

<task type="auto">
  <name>Task 2: Create Star Rating Input Component</name>
  <files>apps/web/components/star-rating-input.tsx</files>
  <action>
Create accessible star rating input following the pattern from 07-RESEARCH.md:

1. Add "use client" directive
2. Import useState from react
3. Define StarRatingInputProps interface:
   - name: string (required, for form field name)
   - defaultValue?: number (for pre-populating with existing rating)
   - disabled?: boolean (for pending state)
4. Export function StarRatingInput({ name, defaultValue, disabled }: StarRatingInputProps)
5. Use useState for hovered (number | null) and selected (number, default from defaultValue ?? 0)
6. Calculate displayValue = hovered ?? selected
7. Render a flex container with gap-1
8. Map over [1, 2, 3, 4, 5] to create 5 labels, each containing:
   - Hidden radio input (className="sr-only") with:
     - type="radio", name={name}, value={value}
     - checked={selected === value}
     - onChange={() => setSelected(value)}
     - disabled={disabled}
     - required (ensure at least one selected)
   - Star SVG that changes fill based on value <= displayValue:
     - Filled: fill-yellow-400 text-yellow-400
     - Empty: fill-none text-gray-300
   - Add hover handlers to label: onMouseEnter/onMouseLeave to set hovered
9. Add text showing current selection: "{selected} star(s)" or "Select rating"
10. Use the star path from Heroicons (24x24 viewBox): M11.48 3.499a.562.562 0 011.04 0l2.125 5.111...
  </action>
  <verify>TypeScript compiles: `pnpm --filter web exec tsc --noEmit`</verify>
  <done>StarRatingInput renders 5 clickable stars with keyboard support via hidden radio inputs</done>
</task>

<task type="auto">
  <name>Task 3: Create Rating Form Component</name>
  <files>apps/web/components/rating-form.tsx</files>
  <action>
Create rating form following pattern from skill-upload-form.tsx:

1. Add "use client" directive
2. Import: useActionState from react, submitRating and RatingState from @/app/actions/ratings, StarRatingInput from ./star-rating-input
3. Define RatingFormProps interface:
   - skillId: string
   - skillSlug: string
   - existingRating?: { rating: number; comment: string | null; hoursSavedEstimate: number | null }
4. Define initialState: RatingState = {}
5. Export function RatingForm({ skillId, skillSlug, existingRating }: RatingFormProps)
6. Use useActionState: const [state, formAction, isPending] = useActionState(submitRating, initialState)
7. Render form with action={formAction} and className="space-y-4"
8. Hidden inputs for skillId and skillSlug
9. Error message display (state.message) in red bg-red-50 div
10. Success message display (state.success) in green bg-green-50 div with appropriate text
11. Star rating section:
    - Label "Your Rating" with required asterisk
    - StarRatingInput with name="rating", defaultValue, disabled={isPending}
    - Error display for state.errors?.rating
12. Comment textarea section:
    - Label "Comment (optional)"
    - textarea name="comment", rows=3, defaultValue from existingRating
    - Placeholder "Share your experience with this skill..."
    - Error display for state.errors?.comment
13. Hours saved estimate input:
    - Label "Hours Saved (optional)"
    - input type="number" name="hoursSavedEstimate", min=0, max=1000, step=0.5
    - defaultValue from existingRating
    - Help text: "Your estimate helps calculate accurate time savings"
    - Error display
14. Submit button:
    - disabled={isPending}
    - Text: "Submitting..." when pending, "Update Rating" if existingRating, else "Submit Rating"
    - Styling: rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300
  </action>
  <verify>TypeScript compiles: `pnpm --filter web exec tsc --noEmit`</verify>
  <done>RatingForm renders complete form with star input, comment, hours saved, and handles submission state</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `pnpm --filter web exec tsc --noEmit`
2. Lint passes: `pnpm --filter web lint`
3. Exports are accessible: Create a test import file or check via TypeScript
4. Server Action signature matches useActionState requirements
</verification>

<success_criteria>
- apps/web/app/actions/ratings.ts exports submitRating Server Action with Zod validation
- apps/web/components/star-rating-input.tsx exports accessible StarRatingInput component
- apps/web/components/rating-form.tsx exports RatingForm using useActionState
- All TypeScript compiles without errors
- Components follow established project patterns (Tailwind classes, form structure)
</success_criteria>

<output>
After completion, create `.planning/phases/07-ratings-reviews/07-01-SUMMARY.md`
</output>
