---
phase: 22-web-remote-mcp
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/mcp/package.json
  - apps/web/middleware.ts
  - apps/mcp/src/tools/list.ts
  - apps/mcp/src/tools/search.ts
  - apps/mcp/src/tools/deploy.ts
autonomous: true

must_haves:
  truths:
    - "Tool handlers accept userId as a parameter and pass it to trackUsage"
    - "Stdio tool registrations still work by passing getUserId() as userId"
    - "mcp-handler is installed in apps/web"
    - "MCP SDK upgraded to >=1.25.2 in apps/mcp"
    - "Middleware exempts /api/mcp paths from session auth"
  artifacts:
    - path: "apps/mcp/src/tools/list.ts"
      provides: "handleListSkills with userId param"
      contains: "userId"
    - path: "apps/mcp/src/tools/search.ts"
      provides: "handleSearchSkills with userId param"
      contains: "userId"
    - path: "apps/mcp/src/tools/deploy.ts"
      provides: "handleDeploySkill with userId and transport params"
      contains: "userId"
    - path: "apps/web/middleware.ts"
      provides: "MCP route exemption"
      contains: "api/mcp"
  key_links:
    - from: "apps/mcp/src/tools/list.ts"
      to: "trackUsage"
      via: "userId param passed through"
      pattern: "userId.*trackUsage|trackUsage.*userId"
    - from: "apps/mcp/src/tools/deploy.ts"
      to: "response format"
      via: "transport param controls instructions vs hint"
      pattern: "transport|instructions"
---

<objective>
Prepare the foundation for HTTP MCP transport: install mcp-handler dependency, upgrade the MCP SDK to patch a security vulnerability, exempt /api/mcp from session middleware, and refactor the three existing tool handlers (list, search, deploy) to accept a userId parameter so they work for both stdio and HTTP transports.

Purpose: The current tool handlers read userId from a module-level cache designed for long-lived stdio processes. HTTP needs per-request auth, so handlers must accept userId as a parameter. Dependencies and middleware must be ready before the route can be created.
Output: Modified handler functions, updated dependencies, middleware exemption.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@apps/mcp/src/tools/list.ts
@apps/mcp/src/tools/search.ts
@apps/mcp/src/tools/deploy.ts
@apps/mcp/src/auth.ts
@apps/web/middleware.ts
@apps/web/package.json
@apps/mcp/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install mcp-handler, upgrade SDK, exempt middleware</name>
  <files>
    apps/web/package.json
    apps/mcp/package.json
    apps/web/middleware.ts
  </files>
  <action>
    1. Install mcp-handler in apps/web:
       cd apps/web && npm install mcp-handler@^1.0.7 @modelcontextprotocol/sdk@^1.25.2

    2. Upgrade @modelcontextprotocol/sdk in apps/mcp to ^1.25.2:
       cd apps/mcp && npm install @modelcontextprotocol/sdk@^1.25.2

    3. Add /api/mcp exemption to apps/web/middleware.ts:
       - Add a new const: `const isMcpApi = req.nextUrl.pathname.startsWith("/api/mcp");`
       - Add isMcpApi to the existing exemption check:
         `if (isAuthApi || isDevLogin || isInstallCallback || isMcpApi) { return; }`
       - This ensures MCP HTTP requests use bearer token auth (handled in route), not session cookies.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && npm ls mcp-handler --prefix apps/web` to confirm mcp-handler installed.
    Run `cd /home/dev/projects/relay && npm ls @modelcontextprotocol/sdk --prefix apps/mcp` to confirm SDK upgraded.
    Run `cd /home/dev/projects/relay && grep "isMcpApi" apps/web/middleware.ts` to confirm middleware updated.
    Run `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` to confirm no type errors.
  </verify>
  <done>
    mcp-handler ^1.0.7 and @modelcontextprotocol/sdk ^1.25.2 in apps/web/package.json.
    @modelcontextprotocol/sdk upgraded to ^1.25.2 in apps/mcp/package.json.
    Middleware exempts /api/mcp paths. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor tool handlers to accept userId parameter</name>
  <files>
    apps/mcp/src/tools/list.ts
    apps/mcp/src/tools/search.ts
    apps/mcp/src/tools/deploy.ts
  </files>
  <action>
    Refactor all three handler functions to accept userId as a parameter instead of calling getUserId() internally. Also add a `transport` parameter to deploy for HTTP-specific response formatting.

    **list.ts - handleListSkills:**
    - Change signature to: `handleListSkills({ category, limit, userId, skipNudge }: { category?: string; limit: number; userId?: string; skipNudge?: boolean })`
    - Replace `getUserId()` calls with the `userId` parameter
    - Replace `if (getUserId() === null) { incrementAnonymousCount(); }` with `if (!userId && !skipNudge) { incrementAnonymousCount(); }`
    - Replace `shouldNudge()` check with `if (!skipNudge && shouldNudge()) {`
    - Replace `getFirstAuthMessage()` with: only call if `!skipNudge`
    - Pass `userId` directly to `trackUsage({ toolName: "list_skills", userId, ... })`
    - Update the stdio registration at bottom to pass `getUserId() ?? undefined` as userId:
      `async ({ category, limit }) => handleListSkills({ category, limit, userId: getUserId() ?? undefined })`

    **search.ts - handleSearchSkills:**
    - Same pattern as list.ts:
    - Change signature to: `handleSearchSkills({ query, category, limit, userId, skipNudge }: { query: string; category?: string; limit: number; userId?: string; skipNudge?: boolean })`
    - Same userId/nudge refactoring as list.ts
    - Update stdio registration to pass userId: getUserId() ?? undefined

    **deploy.ts - handleDeploySkill:**
    - Change signature to: `handleDeploySkill({ skillId, userId, skipNudge, transport }: { skillId: string; userId?: string; skipNudge?: boolean; transport?: "stdio" | "http" })`
    - Same userId/nudge refactoring
    - Add transport-aware response: when `transport === "http"`, replace the `instructions` array with:
      ```
      message: "This skill is now available in this conversation. You can use it directly."
      ```
      When transport is undefined or "stdio", keep the existing instructions array.
    - Update stdio registration to pass userId: getUserId() ?? undefined

    **Why skipNudge:** HTTP transport requires auth (bearer token), so anonymous nudge logic is meaningless. The HTTP route will pass skipNudge: true. Stdio keeps the existing behavior.

    **IMPORTANT:** Keep all existing imports from "../auth.js" in place -- they are still used by the stdio registration calls at the bottom of each file.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay/apps/mcp && npx tsc --noEmit` to confirm no type errors.
    Grep for `getUserId()` inside the handler function bodies (NOT the registration calls) -- should find zero occurrences inside handleListSkills, handleSearchSkills, handleDeploySkill function bodies.
    Grep for `userId` in handler signatures -- should find it in all three.
  </verify>
  <done>
    All three handler functions accept userId and skipNudge parameters.
    handleDeploySkill accepts transport parameter and returns browser-friendly response for HTTP.
    Stdio registrations pass getUserId() as userId, preserving existing behavior.
    TypeScript compiles with no errors.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` passes
2. `cd /home/dev/projects/relay/apps/mcp && npx tsc --noEmit` passes
3. mcp-handler is in apps/web/node_modules
4. Middleware has /api/mcp exemption
5. Handler functions accept userId parameter
</verification>

<success_criteria>
- mcp-handler installed, SDK upgraded, no security vulnerabilities in SDK version
- Middleware exempts /api/mcp from session auth
- All three handlers accept userId param; stdio registrations pass getUserId()
- Deploy handler returns browser-friendly message when transport="http"
- Both apps/web and apps/mcp typecheck cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/22-web-remote-mcp/22-01-SUMMARY.md`
</output>
