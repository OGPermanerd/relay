---
phase: 22-web-remote-mcp
plan: 03
type: execute
wave: 3
depends_on: ["22-02"]
files_modified:
  - apps/web/app/(protected)/profile/page.tsx
  - apps/web/components/mcp-connect-button.tsx
  - apps/web/tests/e2e/mcp-http.spec.ts
autonomous: true

must_haves:
  truths:
    - "Profile page shows a 'Connect to Claude.ai' section with the MCP server URL"
    - "User can copy the MCP server URL to clipboard with one click"
    - "E2E test confirms MCP endpoint rejects unauthenticated requests with 401"
    - "E2E test confirms CORS preflight returns correct headers"
    - "E2E test confirms profile page renders the MCP connect section"
  artifacts:
    - path: "apps/web/components/mcp-connect-button.tsx"
      provides: "MCP connection UI component"
      min_lines: 20
    - path: "apps/web/app/(protected)/profile/page.tsx"
      provides: "Profile page with MCP connect section"
      contains: "McpConnectButton"
    - path: "apps/web/tests/e2e/mcp-http.spec.ts"
      provides: "E2E tests for MCP HTTP endpoint and connect UI"
      min_lines: 30
  key_links:
    - from: "apps/web/components/mcp-connect-button.tsx"
      to: "/api/mcp/mcp"
      via: "Displays the URL for Claude.ai connection"
      pattern: "api/mcp"
    - from: "apps/web/tests/e2e/mcp-http.spec.ts"
      to: "/api/mcp/mcp"
      via: "Playwright fetch to test endpoint"
      pattern: "api/mcp"
---

<objective>
Add a "Connect to Claude.ai" section to the profile page so users can easily connect their Relay account to Claude.ai via the MCP endpoint. Also create Playwright E2E tests verifying the MCP HTTP endpoint works (auth rejection, CORS) and the Connect UI renders correctly.

Purpose: Users need a frictionless way to get the MCP server URL and configure Claude.ai. E2E tests ensure the endpoint and UI work as expected.
Output: MCP connect component on profile page, E2E test file.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@apps/web/app/(protected)/profile/page.tsx
@.planning/phases/22-web-remote-mcp/22-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MCP Connect component and add to profile page</name>
  <files>
    apps/web/components/mcp-connect-button.tsx
    apps/web/app/(protected)/profile/page.tsx
  </files>
  <action>
    **1. Create apps/web/components/mcp-connect-button.tsx:**

    A client component ("use client") that displays the MCP server URL and provides copy-to-clipboard functionality.

    Props: `{ serverUrl: string }`

    UI layout:
    - Section heading: "Connect to Claude.ai" with a subtitle explaining what this does
    - A read-only input (or styled code block) showing the full MCP server URL
    - A "Copy URL" button that copies the URL to clipboard using navigator.clipboard.writeText()
    - After copy, button text changes to "Copied!" for 2 seconds then reverts
    - Brief instructions below: "1. Open Claude.ai Settings > Connectors, 2. Add a new MCP connector, 3. Paste this URL as the server URL, 4. Enter your API key as the bearer token"
    - Use existing Tailwind patterns from the profile page (rounded-lg bg-white p-6 shadow-sm)

    State: useState for `copied` boolean, setTimeout to reset after 2 seconds.

    **2. Update apps/web/app/(protected)/profile/page.tsx:**

    - Import McpConnectButton from "@/components/mcp-connect-button"
    - Compute the MCP server URL: `const mcpServerUrl = \`\${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:2000'}/api/mcp/mcp\`;`
    - Add a new section AFTER the "API Keys" section:
      ```tsx
      {/* MCP Connection */}
      <div className="mt-8">
        <h2 className="mb-4 text-lg font-semibold text-gray-900">MCP Connection</h2>
        <McpConnectButton serverUrl={mcpServerUrl} />
      </div>
      ```

    Note: The user needs BOTH an API key (from the section above) AND this URL to connect Claude.ai. The UI flow is natural: create key, then connect.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` to confirm no type errors.
    Run Playwright to test profile page loads: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/ --grep "profile" 2>&1 | tail -20` (if existing profile tests exist).
    Manually verify: `grep -r "McpConnectButton" apps/web/` shows import in profile page.
  </verify>
  <done>
    McpConnectButton component exists with copy-to-clipboard functionality.
    Profile page renders MCP Connection section with the server URL.
    TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Playwright E2E tests for MCP HTTP endpoint and Connect UI</name>
  <files>apps/web/tests/e2e/mcp-http.spec.ts</files>
  <action>
    Create `apps/web/tests/e2e/mcp-http.spec.ts` with Playwright tests.

    Follow existing test patterns (see apps/web/tests/e2e/home.spec.ts and install-callback.spec.ts for conventions). Use page.evaluate for raw fetch calls to API endpoints.

    **Test Group 1: MCP HTTP Endpoint**

    a) "rejects unauthenticated MCP requests with 401":
       - Use page.evaluate to POST to /api/mcp/mcp with MCP initialize payload, no Authorization header
       - Assert response status is 401

    b) "returns CORS headers for Claude.ai origin on OPTIONS":
       - Use page.evaluate to send OPTIONS to /api/mcp/mcp with Origin: https://claude.ai
       - Assert response status is 204
       - Assert Access-Control-Allow-Origin is "https://claude.ai"
       - Assert Access-Control-Allow-Headers includes "Authorization" and "Mcp-Session-Id"
       - Assert Access-Control-Expose-Headers includes "Mcp-Session-Id"

    c) "rejects CORS for unauthorized origins":
       - Use page.evaluate to send OPTIONS to /api/mcp/mcp with Origin: https://evil.com
       - Assert Access-Control-Allow-Origin is empty string or not "https://evil.com"

    d) "rejects invalid bearer token with 401":
       - Use page.evaluate to POST with Authorization: Bearer rlk_invalid_key_here
       - Assert response status is 401

    **Test Group 2: MCP Connect UI on Profile**

    e) "profile page shows MCP Connection section":
       - Navigate to /profile (requires auth -- use existing auth setup from other tests)
       - Assert page contains text "MCP Connection" or "Connect to Claude.ai"
       - Assert page contains text "api/mcp/mcp" (the server URL)
       - Assert copy button is visible

    Note on auth for profile test: Follow the same pattern used in existing E2E tests for authenticated pages. If tests use a dev login endpoint, use that. Check apps/web/tests/e2e/ for auth patterns.

    Run all tests: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/mcp-http.spec.ts`
    Fix any failures.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/mcp-http.spec.ts` -- all tests pass.
    Run `cd /home/dev/projects/relay/apps/web && npx playwright test` -- full suite still passes (no regressions).
  </verify>
  <done>
    E2E tests verify: 401 on unauth, CORS headers for Claude.ai, CORS rejection for unknown origins, 401 on invalid token.
    E2E test confirms profile page shows MCP Connection section with server URL.
    All tests pass. No regressions in existing test suite.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` passes
2. McpConnectButton component exists and renders on profile page
3. Playwright E2E tests all pass
4. No regressions in existing test suite
</verification>

<success_criteria>
- Profile page has "MCP Connection" section with copyable server URL
- Copy button works (copies URL to clipboard, shows "Copied!" feedback)
- Setup instructions are displayed for connecting Claude.ai
- E2E tests verify endpoint auth rejection (401), CORS headers, and UI rendering
- All Playwright tests pass including existing suite
</success_criteria>

<output>
After completion, create `.planning/phases/22-web-remote-mcp/22-03-SUMMARY.md`
</output>
