---
phase: 68-pre-llm-history
plan: 03
type: execute
wave: 3
depends_on: ["68-02"]
files_modified:
  - apps/web/app/actions/work-artifacts.ts
  - apps/web/tests/e2e/portfolio.spec.ts
autonomous: true

must_haves:
  truths:
    - "After uploading an artifact with extracted text, the system asynchronously analyzes the text against the skill catalog and stores suggested skill IDs"
    - "AI analysis uses Claude Haiku with structured output and Zod validation (same pattern as skill-recommendations.ts)"
    - "E2E tests verify the upload form, artifact list, delete flow, and Pre-platform badge are functional"
  artifacts:
    - path: "apps/web/app/actions/work-artifacts.ts"
      provides: "analyzeArtifactForSkills fire-and-forget function"
      contains: "analyzeArtifactForSkills"
    - path: "apps/web/tests/e2e/portfolio.spec.ts"
      provides: "E2E tests for artifact upload, list, and delete"
      contains: "Pre-Platform Work"
  key_links:
    - from: "apps/web/app/actions/work-artifacts.ts"
      to: "@anthropic-ai/sdk"
      via: "Claude Haiku API call for artifact analysis"
      pattern: "Anthropic|claude-3-haiku"
    - from: "apps/web/app/actions/work-artifacts.ts"
      to: "work_artifacts table"
      via: "UPDATE suggested_skill_ids after AI analysis"
      pattern: "suggested_skill_ids"
---

<objective>
Add AI-powered skill suggestion for uploaded artifacts and comprehensive E2E tests for the complete pre-LLM history feature.

Purpose: Complete the feature by adding intelligent skill matching (informing recommendations) and ensuring quality via automated tests.
Output: AI analysis function wired into artifact creation, and E2E tests covering the full upload/display/delete flow.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/68-pre-llm-history/68-02-SUMMARY.md — UI components and portfolio integration from Plan 02
@apps/web/lib/skill-recommendations.ts — AI matching pattern (Anthropic SDK, Zod validation, skill catalog fetch, structured output)
@apps/web/app/actions/work-artifacts.ts — server actions from Plan 01 (add analyzeArtifactForSkills here)
@apps/web/tests/e2e/portfolio.spec.ts — existing E2E tests (extend with artifact tests)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AI artifact analysis function with fire-and-forget pattern</name>
  <files>
    apps/web/app/actions/work-artifacts.ts
  </files>
  <action>
1. Add `analyzeArtifactForSkills` function to `apps/web/app/actions/work-artifacts.ts` (NOT exported — internal helper, not a server action):

   ```typescript
   async function analyzeArtifactForSkills(
     artifactId: string,
     extractedText: string,
     tenantId: string
   ): Promise<void> {
     // 1. Fetch published skills in the tenant's catalog
     //    SELECT id, name, description, category FROM skills
     //    WHERE tenant_id = $tenantId AND status = 'published' AND published_version_id IS NOT NULL
     //    (same query as skill-recommendations.ts getSkillCatalog)

     // 2. If no skills found, return early

     // 3. Build prompt for Claude Haiku:
     //    System: "You analyze work artifacts and match them to a skill catalog."
     //    User: "Given this historical work artifact text, identify which skills from
     //           the catalog are most relevant. Return up to 5 skill IDs."
     //    Include: artifact text (truncated to 2000 chars for cost), skill catalog as JSON array

     // 4. Call Anthropic with tool_use for structured output:
     //    model: "claude-3-haiku-20240307"
     //    max_tokens: 1024
     //    Tool schema: { skillIds: string[] } with Zod validation

     // 5. Parse response, validate with Zod (z.object({ skillIds: z.array(z.string()) }))

     // 6. Filter skillIds to only those that exist in the catalog (prevent hallucinated IDs)

     // 7. UPDATE work_artifacts SET suggested_skill_ids = $filteredIds WHERE id = $artifactId
   }
   ```

   Follow the exact Anthropic SDK pattern from skill-recommendations.ts:
   - `new Anthropic()` (reads ANTHROPIC_API_KEY from env)
   - Use `messages.create` with tool_use for structured output
   - Wrap entire function in try/catch — swallow all errors (fire-and-forget)
   - Log errors to console.error for debugging

2. Wire into `createWorkArtifact`:
   - After the INSERT, if extractedText is non-empty:
     ```typescript
     if (parsed.data.extractedText) {
       analyzeArtifactForSkills(id, parsed.data.extractedText, tenantId).catch((err) =>
         console.error("[artifact-analysis] Failed:", err)
       );
     }
     ```
   - The .catch() ensures fire-and-forget — response is NOT blocked by AI analysis

3. Validate Zod schema for AI response:
   ```typescript
   const ArtifactAnalysisSchema = z.object({
     skillIds: z.array(z.string()).max(5),
   });
   ```
  </action>
  <verify>
    - `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit` passes
    - The analyzeArtifactForSkills function is syntactically correct and uses the Anthropic SDK
    - createWorkArtifact calls analyzeArtifactForSkills in fire-and-forget pattern
  </verify>
  <done>AI analysis function exists that calls Claude Haiku to match artifact text to skill catalog. It fires asynchronously after artifact creation and updates suggested_skill_ids. Errors are caught and logged without blocking the user.</done>
</task>

<task type="auto">
  <name>Task 2: Add E2E tests for artifact upload, display, and management</name>
  <files>
    apps/web/tests/e2e/portfolio.spec.ts
  </files>
  <action>
1. Add new test cases to the existing portfolio.spec.ts test.describe block:

   **Test: "should display pre-platform work section"**
   - Navigate to /portfolio
   - Expect heading "Pre-Platform Work" to be visible
   - Expect "Add Pre-Platform Work" button OR the empty state text to be visible

   **Test: "should show artifact upload form when clicking add button"**
   - Navigate to /portfolio
   - Click "Add Pre-Platform Work" button
   - Expect Title input to be visible
   - Expect Category select to be visible
   - Expect Date input to be visible
   - Expect a submit button to be visible

   **Test: "should create and display an artifact"**
   - Navigate to /portfolio
   - Click "Add Pre-Platform Work" button
   - Fill in: title = "Q3 Project Plan", category = "document", date = "2024-06-15"
   - Optionally fill description = "Quarterly planning document"
   - Submit the form
   - Wait for the page to refresh/update
   - Expect "Q3 Project Plan" text to be visible in the artifact list
   - Expect "Pre-platform" badge to be visible

   **Test: "should delete an artifact"**
   - First create an artifact (same steps as above, use unique title like "Artifact to Delete")
   - Find the artifact row with that title
   - Click the delete button
   - Handle the confirm dialog: `page.on('dialog', dialog => dialog.accept())`
   - Wait for page update
   - Expect "Artifact to Delete" to NOT be visible (or the empty state to appear)

   **Test: "should show artifacts on impact timeline"**
   - Navigate to /portfolio (after creating an artifact in a prior test or using test.describe.serial)
   - The timeline chart should render — check for "Pre-platform Work" legend text OR the timeline heading
   - Use the conditional assertion pattern: `heading.or(emptyState)` since test data may vary

   NOTE: Since E2E tests run against real data that varies by test account, use the `heading.or(emptyState)` conditional assertion pattern from the existing tests. For the create/delete tests, perform operations within the same test to ensure deterministic state. Use `page.waitForResponse` or `page.waitForTimeout(1000)` after mutations to allow server-side revalidation.
  </action>
  <verify>
    - Run: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/portfolio.spec.ts`
    - All existing tests pass (no regression)
    - New artifact-specific tests pass
  </verify>
  <done>E2E tests verify: pre-platform section renders, upload form expands, artifact creation works, artifact deletion works, and timeline integration renders. All tests pass.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in apps/web
2. All portfolio E2E tests pass (old + new)
3. AI analysis function compiles and follows the established fire-and-forget pattern
4. Creating an artifact with text content triggers async AI analysis (observable via console.log or DB update)
</verification>

<success_criteria>
- analyzeArtifactForSkills calls Claude Haiku, validates response with Zod, updates suggested_skill_ids
- Fire-and-forget pattern: upload response is never blocked by AI analysis
- E2E tests cover: section visibility, form expansion, create artifact, delete artifact, timeline integration
- All existing and new E2E tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/68-pre-llm-history/68-03-SUMMARY.md`
</output>
