---
phase: 56-in-claude-feedback-collection
plan: 02
type: execute
wave: 2
depends_on: ["56-01"]
files_modified:
  - apps/mcp/src/tools/deploy.ts
  - apps/web/lib/skill-feedback-stats.ts
  - apps/web/components/feedback-sentiment.tsx
  - apps/web/components/skill-detail.tsx
  - apps/web/app/(protected)/skills/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "PostToolUse hook injects additionalContext prompting Claude to ask for feedback on first 3 uses, then every 10th"
    - "Skill detail page displays feedback sentiment ('85% positive') with last-30-day breakdown"
    - "Feedback trend data is visible in the stats grid as a new StatCard with sparkline"
    - "Zero feedback gracefully shows nothing (no empty card or 'N/A')"
  artifacts:
    - path: "apps/mcp/src/tools/deploy.ts"
      provides: "Updated buildHookFrontmatter with sync feedback prompt hook"
    - path: "apps/web/lib/skill-feedback-stats.ts"
      provides: "getSkillFeedbackStats query for 30-day aggregation and trend"
      exports: ["getSkillFeedbackStats", "SkillFeedbackStats"]
    - path: "apps/web/components/feedback-sentiment.tsx"
      provides: "FeedbackSentiment display component"
      exports: ["FeedbackSentiment"]
    - path: "apps/web/components/skill-detail.tsx"
      provides: "Updated detail component with feedback StatCard"
    - path: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      provides: "Page wires feedbackStats into SkillDetail"
  key_links:
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "apps/web/lib/skill-feedback-stats.ts"
      via: "getSkillFeedbackStats call in parallel data fetch"
      pattern: "getSkillFeedbackStats"
    - from: "apps/web/components/skill-detail.tsx"
      to: "apps/web/components/feedback-sentiment.tsx"
      via: "FeedbackSentiment component rendered in stats grid"
      pattern: "<FeedbackSentiment"
    - from: "apps/mcp/src/tools/deploy.ts"
      to: "PostToolUse hook frontmatter"
      via: "buildHookFrontmatter adds sync feedback prompt hook"
      pattern: "additionalContext"
---

<objective>
Add the PostToolUse feedback prompt hook to skill frontmatter (smart frequency gating) and display feedback sentiment with trends on skill detail pages.

Purpose: FDBK-02 (feedback prompting), FDBK-05 (sentiment display), FDBK-06 (feedback trends). Completes the feedback loop by prompting users and showing results.
Output: Updated deploy.ts frontmatter builder, feedback stats query, sentiment UI component, wired into skill detail page.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-in-claude-feedback-collection/56-01-SUMMARY.md

# Pattern references:
@apps/mcp/src/tools/deploy.ts
@apps/web/lib/skill-detail-trends.ts
@apps/web/components/stat-card.tsx
@apps/web/components/skill-detail.tsx
@apps/web/app/(protected)/skills/[slug]/page.tsx
@packages/db/src/schema/skill-feedback.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sync feedback prompt hook to deploy.ts frontmatter builder</name>
  <files>
    apps/mcp/src/tools/deploy.ts
  </files>
  <action>
Update `buildHookFrontmatter()` in `apps/mcp/src/tools/deploy.ts` to add a SECOND PostToolUse hook alongside the existing async tracking hook. The new hook is SYNCHRONOUS and returns `additionalContext` prompting Claude to ask for feedback.

The existing hook structure in `buildHookFrontmatter` outputs YAML frontmatter with a single async hook. Add a second hook entry in the same `hooks:` array. The key difference:
- Existing hook: `async: true`, does tracking curl, no output
- New hook: NO `async: true` (synchronous by default), uses local file counter, returns JSON with `additionalContext`

Add these lines to the `buildHookFrontmatter` return array, AFTER the existing async hook's `timeout: 30` line and BEFORE the closing `---`:

```
"        # Feedback prompt (sync - returns additionalContext)",
"        - type: command",
"          command: >-",
"            bash -c '",
`            SKILL_ID=\"${skillId}\";`,
"            CF=\"/tmp/everyskill-fb-${SKILL_ID}.cnt\";",
"            C=$(cat \"$CF\" 2>/dev/null || echo 0);",
"            C=$((C + 1));",
"            echo \"$C\" > \"$CF\";",
"            if [ \"$C\" -le 3 ] || [ $((C % 10)) -eq 0 ]; then",
`            printf \"{\\\\\"hookSpecificOutput\\\\\":{\\\\\"hookEventName\\\\\":\\\\\"PostToolUse\\\\\",\\\\\"additionalContext\\\\\":\\\\\"The user just used the EverySkill skill '%s'. Consider asking: Was this helpful? They can give feedback with: everyskill action:feedback skillId:%s feedbackType:thumbs_up (or thumbs_down) comment:optional_text\\\\\"}}\" \"${skillName.replace(/'/g, "\\\\'")}\" \"${skillId}\";`,
"            fi;",
"            '",
"          timeout: 5",
```

CRITICAL notes:
- Do NOT add `async: true` to this hook. It must be synchronous so `additionalContext` takes effect on the current turn.
- The `printf` outputs JSON to stdout ONLY when the frequency gate triggers (first 3 uses, then every 10th).
- When the gate doesn't trigger, the script outputs nothing (empty stdout = no additionalContext).
- All debug output goes to stderr via `>&2` if needed (but this script doesn't need any debug output).
- The existing async tracking hook remains unchanged.
- Escape the skillName for shell safety (replace single quotes).
- The `timeout: 5` is generous since this is just file read/write + printf.

After modification, verify the complete `buildHookFrontmatter` function produces valid YAML by mentally tracing through the joined array. The structure should be:
```yaml
hooks:
  PostToolUse:
    - matcher: "*"
      hooks:
        - type: command
          command: >-
            bash -c '...tracking curl...'
          async: true
          timeout: 30
        - type: command
          command: >-
            bash -c '...feedback prompt...'
          timeout: 5
```
  </action>
  <verify>
1. `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/mcp/tsconfig.json 2>&1 | head -10` -- compiles
2. Manually check the output of buildHookFrontmatter by reviewing the file -- it should have TWO `- type: command` entries under the hooks array
3. Search for "additionalContext" in the updated file: `grep -n "additionalContext" /home/dev/projects/relay/apps/mcp/src/tools/deploy.ts`
  </verify>
  <done>buildHookFrontmatter outputs YAML frontmatter with two PostToolUse hooks: existing async tracking + new sync feedback prompt with file-based counter and smart frequency gating (first 3, then every 10th)</done>
</task>

<task type="auto">
  <name>Task 2: Create feedback stats query, sentiment component, and wire into skill detail page</name>
  <files>
    apps/web/lib/skill-feedback-stats.ts
    apps/web/components/feedback-sentiment.tsx
    apps/web/components/skill-detail.tsx
    apps/web/app/(protected)/skills/[slug]/page.tsx
  </files>
  <action>
**1. Create `apps/web/lib/skill-feedback-stats.ts`** -- Server-side feedback aggregation:

Follow the exact pattern of `skill-detail-trends.ts`:
```typescript
import { db } from "@everyskill/db";
import { skillFeedback } from "@everyskill/db/schema";
import { eq, sql, gte, and } from "drizzle-orm";

export interface SkillFeedbackStats {
  totalFeedback: number;
  positivePct: number | null;
  last30DaysTotal: number;
  last30DaysPositivePct: number | null;
  feedbackTrend: number[]; // 14-day trend of daily feedback count
}
```

Export `getSkillFeedbackStats(skillId: string): Promise<SkillFeedbackStats>`:
- If `!db`, return zeros: `{ totalFeedback: 0, positivePct: null, last30DaysTotal: 0, last30DaysPositivePct: null, feedbackTrend: [] }`
- Calculate `thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);`
- Run two parallel queries against `skillFeedback` where `feedbackType IN ('thumbs_up', 'thumbs_down')`:
  1. All-time: `count(*)::int as total`, `count(*) FILTER (WHERE feedback_type = 'thumbs_up')::int as positive`
  2. Last 30 days: same but with `gte(skillFeedback.createdAt, thirtyDaysAgo)` added
- For both, filter to only thumbs votes using: `and(eq(skillFeedback.skillId, skillId), sql\`feedback_type IN ('thumbs_up', 'thumbs_down')\`)`
- Calculate 14-day trend (daily feedback count, non-cumulative) using the same date-fill pattern from `skill-detail-trends.ts`:
  - Query daily counts: `date_trunc('day', created_at)::date::text as date, count(*)::int as count` grouped by day, filtered to last 14 days and thumbs votes only
  - Build a map, fill missing days with 0
  - Return array of 14 numbers
- Calculate percentages: `total > 0 ? Math.round((positive / total) * 100) : null`

**2. Create `apps/web/components/feedback-sentiment.tsx`** -- Client component:
```typescript
"use client";

interface FeedbackSentimentProps {
  totalFeedback: number;
  positivePct: number | null;
  last30DaysTotal: number;
  last30DaysPositivePct: number | null;
}

export function FeedbackSentiment({ totalFeedback, positivePct, last30DaysTotal, last30DaysPositivePct }: FeedbackSentimentProps) {
  if (totalFeedback === 0) return null;

  // Use 30-day stats if available, otherwise all-time
  const displayPct = last30DaysTotal > 0 ? last30DaysPositivePct : positivePct;
  const displayTotal = last30DaysTotal > 0 ? last30DaysTotal : totalFeedback;
  const periodLabel = last30DaysTotal > 0 ? "last 30 days" : "all time";

  if (displayPct === null) return null;

  return (
    <div className="text-xs text-gray-500 mt-1">
      <span className={displayPct >= 80 ? "text-green-600 font-medium" : displayPct >= 50 ? "text-yellow-600 font-medium" : "text-red-600 font-medium"}>
        {displayPct}% positive
      </span>
      {" "}({displayTotal} vote{displayTotal !== 1 ? "s" : ""}, {periodLabel})
    </div>
  );
}
```

**3. Update `apps/web/components/skill-detail.tsx`**:
- Add to imports: `import { FeedbackSentiment } from "./feedback-sentiment";`
- Add `feedbackStats` to `SkillDetailProps` interface:
  ```typescript
  feedbackStats?: {
    totalFeedback: number;
    positivePct: number | null;
    last30DaysTotal: number;
    last30DaysPositivePct: number | null;
    feedbackTrend: number[];
  };
  ```
- Add `feedbackStats` to the component parameter destructuring
- In the stats grid (`<div className="mt-6 grid grid-cols-2 gap-4 sm:grid-cols-4">`), add a new StatCard AFTER the "Avg Rating" StatCard and BEFORE the forks StatCard:
  ```tsx
  {feedbackStats && feedbackStats.totalFeedback > 0 && (
    <StatCard
      label="Feedback"
      value={`${feedbackStats.last30DaysTotal > 0 ? feedbackStats.last30DaysPositivePct ?? 0 : feedbackStats.positivePct ?? 0}%`}
      suffix={`(${feedbackStats.totalFeedback})`}
      trendData={feedbackStats.feedbackTrend}
      trendColor="#f59e0b"
    />
  )}
  ```
  This shows "85% (12)" with an amber sparkline. Only renders when there's feedback data.

**4. Update `apps/web/app/(protected)/skills/[slug]/page.tsx`**:
- Add import: `import { getSkillFeedbackStats } from "@/lib/skill-feedback-stats";`
- Add `getSkillFeedbackStats(skill.id)` to the existing `Promise.all` block (the one that already fetches stats, trends, similar skills, etc.). Add it at the end and destructure as `feedbackStats`.
- Pass `feedbackStats` to the `<SkillDetail>` component: `feedbackStats={feedbackStats}`
  </action>
  <verify>
1. `cd /home/dev/projects/relay && npx tsc --noEmit 2>&1 | head -30` -- full project compiles
2. `grep -n "feedbackStats" /home/dev/projects/relay/apps/web/app/\(protected\)/skills/\[slug\]/page.tsx` -- prop is passed
3. `grep -n "FeedbackSentiment\|feedbackStats" /home/dev/projects/relay/apps/web/components/skill-detail.tsx` -- component used
4. Start dev server and verify skill detail page loads without errors: `cd /home/dev/projects/relay/apps/web && curl -s http://localhost:2002/api/health`
5. Run Playwright tests for skill detail page if they exist: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/ --grep "skill" 2>&1 | tail -20`
  </verify>
  <done>
- skill-feedback-stats.ts provides all-time + 30-day aggregation + 14-day trend
- FeedbackSentiment component renders percentage with color coding
- Skill detail page has new "Feedback" StatCard with sparkline (only shown when feedback exists)
- feedbackStats fetched in parallel with other skill detail data
- Skill detail page loads without errors
  </done>
</task>

</tasks>

<verification>
1. Deploy a skill via MCP and verify the YAML frontmatter contains TWO PostToolUse hooks (one async tracking, one sync feedback prompt)
2. Skill detail page shows feedback StatCard when skill has feedback data
3. StatCard displays percentage, count suffix, and sparkline trend
4. When no feedback exists, no StatCard renders (clean empty state)
5. TypeScript compiles cleanly across all packages
</verification>

<success_criteria>
- PostToolUse hook frontmatter has sync feedback prompt with file counter and smart frequency gating
- Feedback sentiment visible on skill detail page with 30-day breakdown and sparkline trend
- All TypeScript compiles, no runtime errors on skill detail pages
</success_criteria>

<output>
After completion, create `.planning/phases/56-in-claude-feedback-collection/56-02-SUMMARY.md`
</output>
