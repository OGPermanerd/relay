---
phase: 71-temporal-tracking
plan: 03
type: execute
wave: 2
depends_on: ["71-01"]
files_modified:
  - apps/web/components/updated-badge.tsx
  - apps/web/app/(protected)/skills/page.tsx
  - apps/web/components/skills-table.tsx
  - apps/web/components/skills-table-row.tsx
  - apps/web/components/whats-new-feed.tsx
  - apps/web/app/(protected)/page.tsx
autonomous: true

must_haves:
  truths:
    - "Skill cards in browse/search results show an 'Updated' badge when the skill changed since the user's last view"
    - "Skills the user has never viewed do NOT show the Updated badge"
    - "The dashboard shows a 'What's New' section listing recently changed skills the user previously viewed"
    - "The What's New feed is empty (or hidden) when the user has no updated previously-viewed skills"
    - "Badge loading uses a single batch query for all visible skill IDs (not N+1)"
  artifacts:
    - path: "apps/web/components/updated-badge.tsx"
      provides: "Amber-themed Updated badge component"
      exports: ["UpdatedBadge"]
    - path: "apps/web/components/whats-new-feed.tsx"
      provides: "Dashboard widget showing recently updated previously-viewed skills"
      exports: ["WhatsNewFeed"]
  key_links:
    - from: "apps/web/app/(protected)/skills/page.tsx"
      to: "packages/db/src/services/user-skill-views.ts"
      via: "getUserViewsForSkills batch query"
      pattern: "getUserViewsForSkills"
    - from: "apps/web/components/skills-table-row.tsx"
      to: "apps/web/components/updated-badge.tsx"
      via: "renders UpdatedBadge conditionally"
      pattern: "<UpdatedBadge"
    - from: "apps/web/app/(protected)/page.tsx"
      to: "packages/db/src/services/user-skill-views.ts"
      via: "getWhatsNewForUser query in Promise.all"
      pattern: "getWhatsNewForUser"
    - from: "apps/web/app/(protected)/page.tsx"
      to: "apps/web/components/whats-new-feed.tsx"
      via: "renders WhatsNewFeed with items"
      pattern: "<WhatsNewFeed"
---

<objective>
Add "Updated" badges to skill cards in browse/search (TEMP-02) and a "What's New" feed to the dashboard (TEMP-04).

Purpose: Users quickly see which skills have changed since they last looked, both in list views and via a dedicated dashboard feed. Reduces information overload by highlighting only what's new.
Output: UpdatedBadge component, modified skills table, WhatsNewFeed component, modified dashboard page.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/71-temporal-tracking/71-01-SUMMARY.md

@apps/web/components/company-approved-badge.tsx (pattern: existing badge component with Tailwind + inline SVG)
@apps/web/app/(protected)/skills/page.tsx (skills browse page — will be modified)
@apps/web/components/skills-table.tsx (skills table component — will be modified)
@apps/web/components/skills-table-row.tsx (table row — will be modified)
@apps/web/app/(protected)/page.tsx (dashboard page — will be modified)
@packages/db/src/services/user-skill-views.ts (from Plan 01 — provides getUserViewsForSkills, getWhatsNewForUser)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UpdatedBadge and wire into skills table</name>
  <files>
    apps/web/components/updated-badge.tsx
    apps/web/app/(protected)/skills/page.tsx
    apps/web/components/skills-table.tsx
    apps/web/components/skills-table-row.tsx
  </files>
  <action>
1. Create `apps/web/components/updated-badge.tsx`:
   - Follow `company-approved-badge.tsx` pattern (Tailwind + inline SVG)
   - Props: `size?: "sm" | "md"` (default "sm")
   - Amber color scheme: `border-amber-200 bg-amber-50 text-amber-700`
   - Size "sm": `text-xs px-2 py-0.5` (for table rows)
   - Size "md": `text-sm px-3 py-1` (for cards)
   - Icon: refresh/arrow-path SVG (Heroicons style), 12px
   - Text: "Updated" for md size, icon-only for sm size
   - `title="Updated since your last visit"` for accessibility

2. Modify `apps/web/app/(protected)/skills/page.tsx`:
   - Import `getUserViewsForSkills` from `@everyskill/db`
   - Import `auth` from auth location
   - After fetching skills (searchSkills call), get the current user's session
   - Extract all skill IDs from the results: `const skillIds = skills.map(s => s.id)`
   - If user is authenticated, batch-load views: `const viewMap = session?.user?.id ? await getUserViewsForSkills(session.user.id, skillIds) : new Map()`
   - Compute `updatedSkillIds: Set<string>` — iterate viewMap entries, if `skill.updatedAt > view.lastViewedAt`, add skillId to set
   - NOTE: To compare, you need the skill's updatedAt. The skills result likely has this. Build the set by iterating skills and checking viewMap: `for (const skill of skills) { const view = viewMap.get(skill.id); if (view && new Date(skill.updatedAt) > new Date(view.lastViewedAt)) updatedSkillIds.add(skill.id); }`
   - Pass `updatedSkillIds` as a prop to SkillsTable

3. Modify `apps/web/components/skills-table.tsx`:
   - Accept new optional prop: `updatedSkillIds?: Set<string>`
   - Pass `isUpdated={updatedSkillIds?.has(skill.id) ?? false}` to each SkillsTableRow

4. Modify `apps/web/components/skills-table-row.tsx`:
   - Accept new optional prop: `isUpdated?: boolean`
   - Import UpdatedBadge from `@/components/updated-badge`
   - Render `{isUpdated && <UpdatedBadge size="sm" />}` inline with existing badges (after CompanyApprovedBadge or VisibilityBadge if present)
  </action>
  <verify>
    - `pnpm turbo typecheck` passes
    - `pnpm lint` passes
    - Skills browse page loads without errors
    - Previously-viewed skills that were updated show the amber badge
  </verify>
  <done>
    Skills browse/search page shows "Updated" badge on skill rows where the skill was modified since the user's last view. Uses single batch query (no N+1).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WhatsNewFeed and wire into dashboard</name>
  <files>
    apps/web/components/whats-new-feed.tsx
    apps/web/app/(protected)/page.tsx
  </files>
  <action>
1. Create `apps/web/components/whats-new-feed.tsx`:
   - Server component (no "use client" — receives serialized data)
   - Props: `items: WhatsNewItem[]` (import type from `@everyskill/db`)
   - If items.length === 0, return null (don't render empty section)
   - Render a section with:
     - Header: "What's New" with a sparkles or bell icon
     - Subheader: "Skills you've viewed that have been updated"
     - List of items (max 10), each showing:
       - Skill name (linked to `/skills/${item.skillSlug}`)
       - Category badge
       - "Updated" label with relative time using `<RelativeTime>` component (import from `@/components/relative-time`)
       - View count context: "Viewed N times" in muted text
     - Tailwind card styling consistent with existing dashboard sections
   - All dates must be passed as ISO strings (serialization discipline). The component receives string dates and passes them to RelativeTime.

2. Modify `apps/web/app/(protected)/page.tsx`:
   - Import `getWhatsNewForUser` from `@everyskill/db`
   - Import `WhatsNewFeed` from `@/components/whats-new-feed`
   - Add `getWhatsNewForUser(session.user.id)` call to the existing `Promise.all()` that fetches dashboard data
   - Destructure the result alongside existing variables
   - Render `<WhatsNewFeed items={whatsNewItems} />` in the dashboard layout
   - Position: After the existing sections (compact stats, search, category tiles, company recommended, trending). The "What's New" section goes near the bottom, before any footer content.
   - Only include in Promise.all if user is authenticated (it always should be on the protected page, but guard anyway)
  </action>
  <verify>
    - `pnpm turbo typecheck` passes
    - `pnpm lint` passes
    - Dashboard page loads without errors
    - Run E2E tests: `cd apps/web && npx playwright test tests/e2e/dashboard.spec.ts` (or equivalent)
    - What's New section renders when user has previously-viewed skills that were updated
    - What's New section does NOT render for new users with no view history
  </verify>
  <done>
    Dashboard shows "What's New" feed listing recently changed skills the user has viewed before. Feed is empty/hidden for users with no updated viewed skills. Uses efficient query with 30-day window and limit 10.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo typecheck` passes across all packages
2. `pnpm lint` passes
3. Skills browse page shows "Updated" badge on previously-viewed skills that changed
4. Dashboard shows "What's New" feed with recently updated previously-viewed skills
5. No N+1 queries (batch load for badges, single query for What's New)
6. No hydration errors (all dates handled via RelativeTime or boolean flags)
7. Run Playwright E2E tests for skills browse and dashboard pages
</verification>

<success_criteria>
- "Updated" badge appears on skill cards in browse/search when skill changed since last view (TEMP-02)
- Dashboard includes "What's New" feed of recently changed previously-viewed skills (TEMP-04)
- Badges use batch loading (single query for N skills)
- No console errors, no hydration mismatches
- Typecheck and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/71-temporal-tracking/71-03-SUMMARY.md`
</output>
