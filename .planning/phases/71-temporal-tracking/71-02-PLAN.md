---
phase: 71-temporal-tracking
plan: 02
type: execute
wave: 2
depends_on: ["71-01"]
files_modified:
  - apps/web/app/(protected)/skills/[slug]/page.tsx
  - apps/web/app/actions/skill-views.ts
  - apps/web/lib/change-detection.ts
  - apps/web/components/change-summary.tsx
autonomous: true

must_haves:
  truths:
    - "When a user visits a skill detail page, their view is recorded with the current version number"
    - "Repeat visits to the same skill update the existing view record (not create duplicates)"
    - "The skill detail page shows a change summary section when the skill has changed since the user's last visit"
    - "The change summary lists version bumps, description updates, and new feedback items"
    - "First-time visitors see no change summary (nothing to compare against)"
  artifacts:
    - path: "apps/web/app/actions/skill-views.ts"
      provides: "Server action for recording skill views"
      exports: ["recordView"]
    - path: "apps/web/lib/change-detection.ts"
      provides: "Change detection logic comparing current skill state against last view"
      exports: ["detectChanges", "ChangeItem"]
    - path: "apps/web/components/change-summary.tsx"
      provides: "UI component showing list of changes since last visit"
      exports: ["ChangeSummary"]
  key_links:
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "apps/web/lib/change-detection.ts"
      via: "detectChanges() call before recording view"
      pattern: "detectChanges"
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "packages/db/src/services/user-skill-views.ts"
      via: "getUserView + recordSkillView calls"
      pattern: "getUserView|recordSkillView"
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "apps/web/components/change-summary.tsx"
      via: "renders ChangeSummary with changes array"
      pattern: "<ChangeSummary"
---

<objective>
Implement view tracking on the skill detail page (TEMP-01) and change summary display (TEMP-03).

Purpose: Users see what changed in a skill since their last visit — version bumps, description updates, new feedback. The system records each view for future comparisons.
Output: Server action for recording views, change detection logic, change summary component, modified skill detail page.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/71-temporal-tracking/71-01-SUMMARY.md

@apps/web/app/(protected)/skills/[slug]/page.tsx (skill detail page — will be modified)
@packages/db/src/services/user-skill-views.ts (from Plan 01 — provides getUserView, recordSkillView, getVersionNumber, countFeedbackSince)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create change detection logic and server action</name>
  <files>
    apps/web/lib/change-detection.ts
    apps/web/app/actions/skill-views.ts
  </files>
  <action>
1. Create `apps/web/lib/change-detection.ts`:

   Export interface `ChangeItem`:
   ```
   type: "version_bump" | "description_updated" | "new_feedback"
   label: string
   detail?: string  // e.g., "v3 -> v5"
   ```

   Export async function `detectChanges(skillId: string, lastViewedAt: Date, lastViewedVersion: number | null, currentVersionId: string | null): Promise<ChangeItem[]>`:
   - Import `getVersionNumber` and `countFeedbackSince` from `@everyskill/db`
   - Build changes array:
     a. **Version bump:** If lastViewedVersion is not null and currentVersionId is not null, get current version number via getVersionNumber(currentVersionId). If current > lastViewedVersion, push { type: "version_bump", label: "New version published", detail: `v${lastViewedVersion} → v${currentVersion}` }
     b. **New feedback:** Call countFeedbackSince(skillId, lastViewedAt). If count > 0, push { type: "new_feedback", label: `${count} new feedback item${count > 1 ? "s" : ""}` }
   - Return the changes array
   - Note: "description_updated" is detectable if version changed (version snapshots store description), so version_bump implicitly covers it. Keep the type for future granularity but don't detect separately in v1.

2. Create `apps/web/app/actions/skill-views.ts`:
   - Add "use server" directive
   - Import `recordSkillView` from `@everyskill/db`
   - Import `auth` from `@/lib/auth`

   Export async function `recordView(skillId: string, currentVersion: number | null)`:
   - Get session via auth()
   - If no session?.user?.id or no session.user.tenantId, return early
   - Call `recordSkillView(session.user.tenantId, session.user.id, skillId, currentVersion)` wrapped in try/catch (fire-and-forget semantics — never throw)
  </action>
  <verify>
    - `pnpm turbo typecheck` passes
    - Both files compile without errors
  </verify>
  <done>
    detectChanges function computes version bumps and new feedback count. recordView server action wraps recordSkillView with auth.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ChangeSummary component and wire into skill detail page</name>
  <files>
    apps/web/components/change-summary.tsx
    apps/web/app/(protected)/skills/[slug]/page.tsx
  </files>
  <action>
1. Create `apps/web/components/change-summary.tsx`:
   - Client component ("use client")
   - Props: `changes: ChangeItem[]` (import the type from `@/lib/change-detection`)
   - If changes.length === 0, return null (renders nothing for first-time visitors or no changes)
   - Render a card-like section with amber/yellow theme (consistent with "Updated" badge):
     - Header: "What's changed since your last visit" with a clock/refresh icon
     - List of changes, each with an appropriate icon per type:
       - version_bump: arrow-up icon, show detail string
       - new_feedback: chat-bubble icon
       - description_updated: pencil icon (future)
     - Tailwind classes: `rounded-lg border border-amber-200 bg-amber-50/50 p-4` (light amber card)
   - Date display: Do NOT use toLocaleDateString() (hydration issue). The component only shows change labels, not dates.

2. Modify `apps/web/app/(protected)/skills/[slug]/page.tsx`:
   - Import `getUserView`, `getVersionNumber`, `recordSkillView` from `@everyskill/db`
   - Import `detectChanges` from `@/lib/change-detection`
   - Import `ChangeSummary` from `@/components/change-summary`

   CRITICAL ORDER (Pitfall 3 — compute changes BEFORE recording view):
   a. After fetching the skill and session, fetch the user's PREVIOUS view:
      `const previousView = session?.user?.id ? await getUserView(session.user.id, skill.id) : undefined;`
   b. Get the current version number:
      `const currentVersion = skill.publishedVersionId ? await getVersionNumber(skill.publishedVersionId) : null;`
   c. Compute changes (only if user has a previous view):
      `const changes = previousView ? await detectChanges(skill.id, previousView.lastViewedAt, previousView.lastViewedVersion, skill.publishedVersionId) : [];`
   d. THEN record the new view (fire-and-forget, after computing changes):
      ```
      if (session?.user?.id && session.user.tenantId) {
        recordSkillView(session.user.tenantId, session.user.id, skill.id, currentVersion).catch(() => {});
      }
      ```
   e. Render `<ChangeSummary changes={changes} />` in the page, positioned after the skill header/metadata section and before the main content (description, versions, etc.)
   f. Serialize changes for client: Since ChangeItem has no Date fields (only strings), it's safe to pass directly.
  </action>
  <verify>
    - `pnpm turbo typecheck` passes
    - `pnpm lint` passes (no unused imports, no console.log)
    - Run relevant E2E tests: `cd apps/web && npx playwright test tests/e2e/skills.spec.ts` (or whatever covers skill detail page)
    - Verify: Visit a skill detail page → no errors → revisit → no errors → change a skill → revisit → change summary appears (manual or E2E)
  </verify>
  <done>
    Skill detail page records views on load (fire-and-forget), shows change summary section when skill has changed since last visit, first-time visitors see no change summary.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo typecheck` passes across all packages
2. `pnpm lint` passes
3. Skill detail page loads without errors for authenticated users
4. Change summary renders when a skill has been modified since last view
5. Change summary does NOT render on first visit to a skill
6. View is recorded in database (check: `psql everyskill -c "SELECT * FROM user_skill_views LIMIT 5"`)
</verification>

<success_criteria>
- Authenticated users' views are recorded with timestamp and version number (TEMP-01)
- Change summary shows version bumps and new feedback count (TEMP-03)
- No hydration errors, no console errors
- Typecheck and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/71-temporal-tracking/71-02-SUMMARY.md`
</output>
