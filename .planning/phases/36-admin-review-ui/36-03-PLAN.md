---
phase: 36-admin-review-ui
plan: 03
type: execute
wave: 3
depends_on: ["36-02"]
files_modified:
  - apps/web/app/(protected)/admin/reviews/[skillId]/page.tsx
  - apps/web/components/admin-review-detail.tsx
  - apps/web/components/review-diff-view.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin can view a skill's full content on the review detail page"
    - "Admin can see AI review scores (quality/clarity/completeness) on the review detail page"
    - "Admin can see a diff view against previous version content when a prior review decision with previous_content exists"
    - "Admin can approve a skill with a single click (optional notes) and the skill becomes published"
    - "Admin can reject a skill with required notes"
    - "Admin can request changes with required feedback notes"
    - "Review decision history is displayed on the detail page"
    - "Action buttons are disabled during pending state to prevent double-click"
  artifacts:
    - path: "apps/web/app/(protected)/admin/reviews/[skillId]/page.tsx"
      provides: "Review detail page with server-side data fetching"
      contains: "AdminReviewDetailPage"
    - path: "apps/web/components/admin-review-detail.tsx"
      provides: "Client component with skill content display, AI scores, action buttons, notes form"
      contains: "AdminReviewDetail"
    - path: "apps/web/components/review-diff-view.tsx"
      provides: "Line-level diff rendering component using diff npm package"
      contains: "ReviewDiffView"
  key_links:
    - from: "apps/web/app/(protected)/admin/reviews/[skillId]/page.tsx"
      to: "apps/web/lib/review-queries.ts"
      via: "getReviewDetail server-side call"
      pattern: "getReviewDetail"
    - from: "apps/web/components/admin-review-detail.tsx"
      to: "apps/web/app/actions/admin-reviews.ts"
      via: "approveSkillAction, rejectSkillAction, requestChangesAction calls"
      pattern: "(approve|reject|requestChanges)SkillAction"
    - from: "apps/web/components/admin-review-detail.tsx"
      to: "apps/web/components/review-diff-view.tsx"
      via: "conditional rendering when previous_content exists"
      pattern: "ReviewDiffView"
    - from: "apps/web/components/admin-review-detail.tsx"
      to: "apps/web/components/ai-review-display.tsx"
      via: "rendering AI scores"
      pattern: "AiReviewDisplay"
---

<objective>
Build the admin review detail page where admins see full skill content, AI review scores, content diff, and take approve/reject/request-changes actions.

Purpose: This is the core admin review experience -- the page where the actual review decision happens. Combines content display (ADMR-06, ADMR-07), action buttons (ADMR-03, ADMR-04, ADMR-05), and decision history (ADMR-08) into a single coherent review interface.

Output: Review detail page at /admin/reviews/[skillId], admin-review-detail client component with action forms, review-diff-view component for content comparison.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-admin-review-ui/36-02-SUMMARY.md
@apps/web/components/ai-review-display.tsx
@apps/web/app/actions/admin-reviews.ts
@apps/web/lib/review-queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install diff package and create the diff view component</name>
  <files>
    apps/web/components/review-diff-view.tsx
  </files>
  <action>
    1. Install the diff package: `cd /home/dev/projects/relay/apps/web && pnpm add diff && pnpm add -D @types/diff`

    2. Create `apps/web/components/review-diff-view.tsx` ("use client"):
       - Import `diffLines` and `Change` type from "diff"
       - Props interface `ReviewDiffViewProps`: oldContent (string), newContent (string), oldLabel (string, default "Previous Version"), newLabel (string, default "Current Version")
       - Compute changes: `const changes = diffLines(oldContent, newContent)`
       - Render a container div with rounded-lg border border-gray-200 overflow-hidden
       - Header bar: flex between oldLabel and newLabel, bg-gray-50, text-xs font-medium text-gray-500
       - Content area: `<pre className="text-sm font-mono overflow-x-auto p-0 m-0">`
       - Map over changes, for each Change:
         - Added lines: bg-green-50 text-green-800 border-l-4 border-green-400
         - Removed lines: bg-red-50 text-red-800 border-l-4 border-red-400
         - Unchanged lines: text-gray-700
         - Split change.value by "\n", filter out trailing empty string, render each line in a div with px-4 py-0.5
         - Prefix: "+" for added, "-" for removed, " " for unchanged (in a span with select-none mr-2 text-gray-400)
       - If no changes (oldContent === newContent), show "No differences found" message
       - Export the component
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && pnpm build` to verify the component compiles and diff package resolves.
  </verify>
  <done>ReviewDiffView component renders line-level diff with green/red highlighting. diff package installed and types available.</done>
</task>

<task type="auto">
  <name>Task 2: Build review detail page and admin review detail component with action forms</name>
  <files>
    apps/web/app/(protected)/admin/reviews/[skillId]/page.tsx
    apps/web/components/admin-review-detail.tsx
  </files>
  <action>
    1. Create `apps/web/app/(protected)/admin/reviews/[skillId]/page.tsx` (server component):
       - Props: `{ params: Promise<{ skillId: string }> }`
       - Auth check: session + isAdmin, redirect("/") if not
       - Resolve params: `const { skillId } = await params`
       - Call `getReviewDetail(skillId, session.user.tenantId || DEFAULT_TENANT_ID)` from `@/lib/review-queries`
       - If null, use `notFound()` from next/navigation
       - Pass all data to `<AdminReviewDetail />` client component
       - Serialize: skill object (with content, status, name, description, category, tags, statusMessage, createdAt as ISO string, updatedAt as ISO string), aiReview (categories, summary, suggestedDescription, createdAt as ISO string, modelName -- or null), decisions array (id, action, notes, reviewerName, createdAt as ISO string), previousContent (from the most recent decision's previous_content field, or null if no prior decisions)
       - Import DEFAULT_TENANT_ID from "@everyskill/db"

    2. Create `apps/web/components/admin-review-detail.tsx` ("use client"):
       - Props interface: skill (id, name, slug, description, category, tags, content, status, statusMessage), aiReview (categories, summary, suggestedDescription, reviewedAt, modelName) | null, decisions (array of { id, action, notes, reviewerName, createdAt }), previousContent (string | null)
       - Layout: Two-column on large screens (skill content left, AI review + actions right), single column on mobile

       LEFT COLUMN:
       - Skill header: name as h2, category badge, status badge (color-coded), description text
       - If previousContent exists AND previousContent !== skill.content: render `<ReviewDiffView oldContent={previousContent} newContent={skill.content} />` with labels "Previous Version" and "Submitted Version"
       - If previousContent is null or same as current: render skill.content in a `<pre>` block with rounded border, bg-gray-50, monospace, overflow-x-auto. Show "New submission -- no previous version" indicator if no previousContent.
       - Tags: render as small gray badges if present

       RIGHT COLUMN:
       - AI Review section: If aiReview exists, render `<AiReviewDisplay categories={aiReview.categories} summary={aiReview.summary} suggestedDescription={aiReview.suggestedDescription} reviewedAt={aiReview.reviewedAt} modelName={aiReview.modelName} />`. If no aiReview, show "No AI review available" message.

       - Action section (only when skill.status === "ai_reviewed"):
         - Approve button: green, calls approveSkillAction(skill.id, approveNotes). Optional notes textarea (collapsible, "Add notes (optional)").
         - Reject button: red, opens notes textarea (required, placeholder "Explain why this skill was rejected..."). Submit calls rejectSkillAction(skill.id, rejectNotes).
         - Request Changes button: amber/orange, opens notes textarea (required, placeholder "Describe what changes are needed..."). Submit calls requestChangesAction(skill.id, changesNotes).
         - All buttons use useState for pending state: `const [pending, setPending] = useState<string | null>(null)` (tracks which action is in progress). Disable all buttons when any action is pending.
         - On action result: if error, show red error text. If success, use `useRouter().refresh()` to refresh the page (server component will re-fetch data).
         - Notes validation: reject and request-changes show inline error "Notes are required" if submitted empty.

       - If skill.status !== "ai_reviewed" (already decided): show status indicator ("This skill has been {status}") instead of action buttons.

       DECISION HISTORY (below both columns, full width):
       - If decisions.length > 0, render "Review History" section
       - Each decision: card with action badge (Approved=green, Rejected=red, Changes Requested=amber), reviewer name, date (manual UTC format), notes (if present)
       - Order: most recent first (already sorted by query)

       Import: AiReviewDisplay from "@/components/ai-review-display", ReviewDiffView from "@/components/review-diff-view", approveSkillAction/rejectSkillAction/requestChangesAction from "@/app/actions/admin-reviews", useState from "react", useRouter from "next/navigation", Link from "next/link"

       Manual UTC date formatting for all dates (per MEMORY.md -- no toLocaleDateString).
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && pnpm build` to verify all pages and components compile.
    Start dev server and visit http://localhost:2000/admin/reviews -- if any skills are in ai_reviewed status, click one to verify the detail page renders.
    Run Playwright tests: `cd /home/dev/projects/relay/apps/web && node_modules/.bin/playwright test` to verify no regressions.
  </verify>
  <done>
    - /admin/reviews/[skillId] renders review detail page with skill content, AI scores, and action buttons
    - Diff view shows when previous_content exists and differs from current content
    - Approve/reject/request-changes actions work with proper validation (notes required for reject and request-changes)
    - Decision history section shows immutable audit trail
    - All action buttons disable during pending state
    - Build passes, no Playwright test regressions
  </done>
</task>

</tasks>

<verification>
- Visit /admin/reviews/[any-skill-id] -- page loads with full skill content (ADMR-06, ADMR-07)
- AI review scores display via AiReviewDisplay component (ADMR-06)
- Diff view renders when previous version content exists (ADMR-07)
- "New submission" indicator when no previous version (ADMR-07 edge case)
- Approve button publishes the skill (verify skill status changes to published) (ADMR-03)
- Reject button requires notes, stores decision (ADMR-04, ADMR-08)
- Request changes button requires notes, stores decision (ADMR-05, ADMR-08)
- Decision history shows all past decisions with reviewer, action, timestamp, notes (ADMR-08)
- Buttons disable during pending state (double-click protection)
- `pnpm build` passes
- Playwright tests pass (no regressions)
</verification>

<success_criteria>
- Complete admin review workflow: view skill -> see AI scores -> see diff (if applicable) -> approve/reject/request-changes
- All 9 ADMR requirements satisfied across Plans 01-03
- Immutable audit trail records every decision
- Full build passes, no E2E test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/36-admin-review-ui/36-03-SUMMARY.md`
</output>
