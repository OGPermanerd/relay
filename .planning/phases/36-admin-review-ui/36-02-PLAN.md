---
phase: 36-admin-review-ui
plan: 02
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - apps/web/app/actions/admin-reviews.ts
  - apps/web/app/(protected)/admin/layout.tsx
  - apps/web/app/(protected)/admin/reviews/page.tsx
  - apps/web/components/admin-review-queue.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can visit /admin/reviews and see a paginated table of skills with ai_reviewed status"
    - "Review queue supports pagination (20 per page) via URL search params"
    - "Review queue supports filtering by status, category, and date range"
    - "Admin nav shows 'Reviews' tab with a red badge showing pending review count"
    - "Approve action chains ai_reviewed -> approved -> published in a transaction with immutable decision record"
    - "Reject action requires non-empty notes and stores immutable decision record"
    - "Request-changes action requires non-empty notes and stores immutable decision record"
  artifacts:
    - path: "apps/web/app/actions/admin-reviews.ts"
      provides: "Server actions for approve, reject, request-changes"
      exports: ["approveSkillAction", "rejectSkillAction", "requestChangesAction"]
    - path: "apps/web/app/(protected)/admin/reviews/page.tsx"
      provides: "Review queue page with server-side data fetching"
      contains: "AdminReviewsPage"
    - path: "apps/web/components/admin-review-queue.tsx"
      provides: "Client component for review queue table with filters and pagination"
      contains: "AdminReviewQueue"
    - path: "apps/web/app/(protected)/admin/layout.tsx"
      provides: "Admin layout with Reviews nav item and pending count badge"
      contains: "pendingCount"
  key_links:
    - from: "apps/web/app/actions/admin-reviews.ts"
      to: "packages/db/src/services/review-decisions.ts"
      via: "createReviewDecision call in transaction"
      pattern: "createReviewDecision"
    - from: "apps/web/app/actions/admin-reviews.ts"
      to: "packages/db/src/services/skill-status.ts"
      via: "canTransition validation before status update"
      pattern: "canTransition"
    - from: "apps/web/app/(protected)/admin/reviews/page.tsx"
      to: "apps/web/lib/review-queries.ts"
      via: "getReviewQueue server-side call"
      pattern: "getReviewQueue"
    - from: "apps/web/app/(protected)/admin/layout.tsx"
      to: "apps/web/lib/review-queries.ts"
      via: "getPendingReviewCount for nav badge"
      pattern: "getPendingReviewCount"
---

<objective>
Build the admin review server actions (approve/reject/request-changes), the review queue page with pagination and filters, and the admin nav badge showing pending review count.

Purpose: Admins need to see which skills await review and take action. This plan delivers the queue listing (ADMR-01, ADMR-02), the three admin actions (ADMR-03, ADMR-04, ADMR-05), the immutable audit trail writes (ADMR-08), and the nav badge (ADMR-09).

Output: Server actions, review queue page + client component, updated admin layout with badge.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-admin-review-ui/36-01-SUMMARY.md
@apps/web/app/(protected)/admin/layout.tsx
@apps/web/app/(protected)/admin/skills/page.tsx
@apps/web/app/actions/admin-skills.ts
@apps/web/app/actions/submit-for-review.ts
@apps/web/components/admin-skills-table.tsx
@packages/db/src/services/skill-status.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin review server actions (approve, reject, request-changes)</name>
  <files>
    apps/web/app/actions/admin-reviews.ts
  </files>
  <action>
    Create `apps/web/app/actions/admin-reviews.ts` with "use server" directive. Three server actions:

    1. `approveSkillAction(skillId: string, notes?: string)`:
       - Auth check: `const session = await auth(); if (!session?.user?.id || !isAdmin(session)) return { error: "Unauthorized" };`
       - DB check: `if (!db) return { error: "Database not configured" };`
       - Fetch skill: `db.query.skills.findFirst({ where: eq(skills.id, skillId), columns: { id, status, tenantId, content } })`
       - Validate transition: `canTransition(currentStatus, "approved")` -- if false, return error
       - Fetch AI review snapshot: `getSkillReview(skillId)` for aiScoresSnapshot
       - Transaction: (a) insert reviewDecisions row with action="approved", optional notes, aiScoresSnapshot, previousContent = skill.content, (b) update skills set status="approved", statusMessage=null, updatedAt=new Date(), (c) update skills set status="published", updatedAt=new Date()
       - IMPORTANT: Use raw db.insert/db.update inside transaction, NOT the createReviewDecision service (service uses its own db reference, not the transaction context)
       - `revalidatePath("/admin")` (revalidates layout + all admin pages for badge refresh)
       - Return `{ success: true }`

    2. `rejectSkillAction(skillId: string, notes: string)`:
       - Auth + DB checks (same as approve)
       - Validate notes with zod: `z.string().min(1, "Rejection reason is required")` -- return error if invalid
       - Fetch skill, validate `canTransition(currentStatus, "rejected")`
       - Fetch AI review snapshot
       - Transaction: (a) insert reviewDecisions with action="rejected", notes (required), aiScoresSnapshot, previousContent = skill.content, (b) update skills set status="rejected", statusMessage = `Rejected: ${notes}`, updatedAt = new Date()
       - `revalidatePath("/admin")`
       - Return `{ success: true }`

    3. `requestChangesAction(skillId: string, notes: string)`:
       - Auth + DB checks (same as approve)
       - Validate notes with zod: `z.string().min(1, "Feedback is required")`
       - Fetch skill, validate `canTransition(currentStatus, "changes_requested")`
       - Fetch AI review snapshot
       - Transaction: (a) insert reviewDecisions with action="changes_requested", notes, aiScoresSnapshot, previousContent = skill.content, (b) update skills set status="changes_requested", statusMessage = notes, updatedAt = new Date()
       - `revalidatePath("/admin")`
       - Return `{ success: true }`

    Export a shared ActionResult type: `{ success?: boolean; error?: string }`.

    Imports: auth from "@/auth", isAdmin from "@/lib/admin", db/skills from "@everyskill/db", reviewDecisions from "@everyskill/db/schema" (or from the main export), canTransition/SkillStatus from "@everyskill/db/services/skill-status", getSkillReview from "@everyskill/db/services/skill-reviews", eq from "drizzle-orm", revalidatePath from "next/cache", z from "zod".

    NOTE: Import reviewDecisions directly -- the schema is exported from @everyskill/db (via schema/index.ts re-export added in Plan 01). If import fails, use `import { reviewDecisions } from "@everyskill/db/schema/review-decisions"`.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && pnpm build` to verify server actions compile.
  </verify>
  <done>Three server actions (approve, reject, request-changes) compile. Each validates admin role, validates state transition via canTransition, writes immutable review_decisions record in a transaction, and revalidates admin paths.</done>
</task>

<task type="auto">
  <name>Task 2: Build review queue page, client table component, and admin nav badge</name>
  <files>
    apps/web/app/(protected)/admin/reviews/page.tsx
    apps/web/components/admin-review-queue.tsx
    apps/web/app/(protected)/admin/layout.tsx
  </files>
  <action>
    1. Create `apps/web/app/(protected)/admin/reviews/page.tsx` (server component):
       - Props: `{ searchParams: Promise<{ page?: string; status?: string; category?: string; dateFrom?: string; dateTo?: string }> }`
       - Auth check: session + isAdmin, redirect("/") if not admin
       - Parse page from searchParams (default 1, min 1), pageSize = 20
       - Call `getReviewQueue({ tenantId: session.user.tenantId || DEFAULT_TENANT_ID, page, pageSize, status, category, dateFrom, dateTo })` from `@/lib/review-queries`
       - Render heading "Review Queue" with subtitle "Skills awaiting admin review"
       - Summary stats: "Showing {total} skills" count card (match pattern from admin/skills/page.tsx)
       - Render `<AdminReviewQueue skills={skills} total={total} page={page} pageSize={pageSize} currentFilters={{ status, category, dateFrom, dateTo }} />`
       - Import DEFAULT_TENANT_ID from "@everyskill/db"

    2. Create `apps/web/components/admin-review-queue.tsx` ("use client"):
       - Props: skills array (id, name, slug, category, status, authorName, createdAt, updatedAt), total count, page number, pageSize, currentFilters
       - Filter bar at top:
         - Status dropdown: "Awaiting Review" (ai_reviewed, default), "Pending AI" (pending_review), "Rejected" (rejected), "Changes Requested" (changes_requested), "All"
         - Category dropdown: "All", "prompt", "workflow", "agent", "mcp"
         - Date range: two date inputs (dateFrom, dateTo) -- standard HTML date inputs
         - Apply filters by navigating to same URL with updated search params via `useRouter().push()`
       - Table with columns: Skill Name (link to /admin/reviews/[skillId]), Category (badge), Author, Status (color-coded badge matching my-skills-list.tsx pattern), Updated (relative time or short date), Action (link "Review" pointing to /admin/reviews/[skillId])
       - Pagination at bottom: Previous/Next buttons using Link with updated page param. Show "Page {page} of {totalPages}". Disable Previous on page 1, Next on last page.
       - Empty state: "No skills awaiting review" when skills array is empty
       - Status badge colors: ai_reviewed = amber, pending_review = blue, rejected = red, changes_requested = orange (use same color scheme as my-skills-list.tsx)
       - Use useRouter and useSearchParams from next/navigation for filter changes
       - Format dates with manual UTC formatting (not toLocaleDateString -- hydration safety per MEMORY.md)

    3. Modify `apps/web/app/(protected)/admin/layout.tsx`:
       - Import `getPendingReviewCount` from `@/lib/review-queries`
       - Import `DEFAULT_TENANT_ID` from `@everyskill/db`
       - Add "Reviews" item to adminNavItems array, positioned FIRST (before Settings): `{ label: "Reviews", href: "/admin/reviews" }`
       - After the isAdmin check, call: `const pendingCount = await getPendingReviewCount(session?.user?.tenantId || DEFAULT_TENANT_ID);`
       - In the nav rendering, after the label text for "Reviews", conditionally render a badge: `{item.label === "Reviews" && pendingCount > 0 && <span className="ml-1 inline-flex items-center rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-700">{pendingCount}</span>}`
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && pnpm build` to verify all pages and components compile.
    Start dev server, visit http://localhost:2000/admin/reviews -- should render the queue page (may be empty if no ai_reviewed skills exist).
    Check admin nav shows "Reviews" tab with badge (badge shows 0 or count of ai_reviewed skills).
  </verify>
  <done>
    - /admin/reviews renders a paginated review queue with filter dropdowns for status, category, and date range
    - Pagination works with 20 items per page via URL search params
    - Admin layout shows "Reviews" nav item with red badge showing pending count
    - Queue table links each skill to /admin/reviews/[skillId] for detail view
  </done>
</task>

</tasks>

<verification>
- Visit /admin/reviews -- page loads with review queue table (ADMR-01)
- Filter dropdowns change URL params and re-fetch (ADMR-02)
- Pagination controls navigate between pages (ADMR-02)
- Admin nav shows "Reviews" with count badge (ADMR-09)
- Server actions file compiles with approve/reject/request-changes (ADMR-03, ADMR-04, ADMR-05)
- `pnpm build` passes with no errors
</verification>

<success_criteria>
- Review queue page at /admin/reviews shows paginated, filterable skill list
- Three server actions compile and validate admin role + state transitions + notes requirements
- Admin nav badge shows pending review count
- Full build passes
</success_criteria>

<output>
After completion, create `.planning/phases/36-admin-review-ui/36-02-SUMMARY.md`
</output>
