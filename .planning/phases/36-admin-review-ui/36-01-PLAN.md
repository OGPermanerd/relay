---
phase: 36-admin-review-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/review-decisions.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/relations/index.ts
  - packages/db/src/services/review-decisions.ts
  - packages/db/src/services/index.ts
  - packages/db/src/migrations/0015_create_review_decisions.sql
  - apps/web/lib/review-queries.ts
autonomous: true

must_haves:
  truths:
    - "review_decisions table exists with immutable insert-only design (no updatedAt column)"
    - "Review queue query returns paginated skills filtered by status, category, and date with total count"
    - "Pending review count query returns count of ai_reviewed skills for a tenant"
    - "Review detail query returns skill + AI scores + decision history for a given skillId"
  artifacts:
    - path: "packages/db/src/schema/review-decisions.ts"
      provides: "Immutable review_decisions table schema with tenant isolation RLS"
      contains: "reviewDecisions"
    - path: "packages/db/src/services/review-decisions.ts"
      provides: "createReviewDecision and getDecisionsForSkill functions"
      exports: ["createReviewDecision", "getDecisionsForSkill"]
    - path: "packages/db/src/migrations/0015_create_review_decisions.sql"
      provides: "SQL migration creating review_decisions table with indexes and RLS"
      contains: "CREATE TABLE"
    - path: "apps/web/lib/review-queries.ts"
      provides: "Server-side query functions for review queue, detail, and pending count"
      exports: ["getReviewQueue", "getReviewDetail", "getPendingReviewCount"]
  key_links:
    - from: "packages/db/src/schema/review-decisions.ts"
      to: "packages/db/src/schema/index.ts"
      via: "re-export"
      pattern: "export.*review-decisions"
    - from: "packages/db/src/services/review-decisions.ts"
      to: "packages/db/src/services/index.ts"
      via: "re-export"
      pattern: "export.*review-decisions"
    - from: "apps/web/lib/review-queries.ts"
      to: "packages/db/src/schema/review-decisions.ts"
      via: "import reviewDecisions"
      pattern: "reviewDecisions"
---

<objective>
Create the review_decisions database table for immutable audit trail and build all server-side query functions for the admin review UI.

Purpose: Establishes the data layer that the review queue page, review detail page, and admin actions will consume. The review_decisions table is separate from skill_reviews (which stores mutable AI review data) and is insert-only for SOC2 compliance.

Output: review_decisions schema + migration + service, plus review-queries.ts with getReviewQueue, getReviewDetail, and getPendingReviewCount.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/schema/skill-reviews.ts
@packages/db/src/schema/audit-logs.ts
@packages/db/src/schema/skills.ts
@packages/db/src/schema/index.ts
@packages/db/src/relations/index.ts
@packages/db/src/services/index.ts
@packages/db/src/services/skill-reviews.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review_decisions schema, migration, service, and relations</name>
  <files>
    packages/db/src/schema/review-decisions.ts
    packages/db/src/schema/index.ts
    packages/db/src/relations/index.ts
    packages/db/src/services/review-decisions.ts
    packages/db/src/services/index.ts
    packages/db/src/migrations/0015_create_review_decisions.sql
  </files>
  <action>
    1. Create `packages/db/src/schema/review-decisions.ts`:
       - Table `review_decisions` with columns: id (text PK, crypto.randomUUID), tenant_id (text NOT NULL FK to tenants), skill_id (text NOT NULL FK to skills ON DELETE CASCADE), reviewer_id (text NOT NULL FK to users), action (text NOT NULL -- "approved" | "rejected" | "changes_requested"), notes (text, nullable), ai_scores_snapshot (jsonb, nullable, typed as ReviewCategories from skill-reviews.ts), previous_content (text, nullable -- snapshot of skills.content at decision time for future diff), created_at (timestamptz precision 3, NOT NULL, defaultNow)
       - NO updatedAt column -- table is insert-only, immutable
       - Indexes: skill_id_idx, tenant_id_idx, reviewer_id_idx
       - pgPolicy for tenant_isolation (same pattern as skill-reviews.ts)
       - Export types: ReviewDecision, NewReviewDecision

    2. Create migration `packages/db/src/migrations/0015_create_review_decisions.sql`:
       - CREATE TABLE IF NOT EXISTS with all columns matching schema
       - CREATE INDEX IF NOT EXISTS for all 3 indexes
       - ALTER TABLE ENABLE ROW LEVEL SECURITY
       - CREATE POLICY tenant_isolation (RESTRICTIVE, FOR ALL, USING/WITH CHECK on current_setting)

    3. Add `export * from "./review-decisions";` to `packages/db/src/schema/index.ts`

    4. Add reviewDecisionsRelations to `packages/db/src/relations/index.ts`:
       - Import reviewDecisions from schema
       - Relations: tenant (one, to tenants), skill (one, to skills), reviewer (one, to users)
       - Also add `reviewDecisions: many(reviewDecisions)` to skillsRelations

    5. Create `packages/db/src/services/review-decisions.ts`:
       - `createReviewDecision(params: { tenantId, skillId, reviewerId, action, notes?, aiScoresSnapshot?, previousContent? }): Promise<void>` -- inserts a row, no return value needed
       - `getDecisionsForSkill(skillId: string): Promise<Array<{ id, action, notes, reviewerName, createdAt }>>` -- joins with users for reviewer name, orders by createdAt DESC
       - Import db from client, reviewDecisions from schema, users from schema, eq/desc from drizzle-orm

    6. Add exports to `packages/db/src/services/index.ts`:
       - `export { createReviewDecision, getDecisionsForSkill } from "./review-decisions";`
  </action>
  <verify>
    Run `cd /home/dev/projects/relay/packages/db && npx tsx -e "import { reviewDecisions } from './src/schema'; console.log('Schema OK:', Object.keys(reviewDecisions))"` to verify schema loads.
    Run migration: `cd /home/dev/projects/relay/packages/db && DATABASE_URL=$(grep DATABASE_URL /home/dev/projects/relay/.env.local | cut -d= -f2-) psql "$DATABASE_URL" -f src/migrations/0015_create_review_decisions.sql`
    Verify table exists: `psql "$DATABASE_URL" -c "\d review_decisions"`
    Run `cd /home/dev/projects/relay && pnpm build` to verify no type errors.
  </verify>
  <done>review_decisions table exists in database with correct columns, indexes, and RLS policy. Schema, relations, and service functions compile without errors. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create review query functions for queue, detail, and pending count</name>
  <files>
    apps/web/lib/review-queries.ts
  </files>
  <action>
    Create `apps/web/lib/review-queries.ts` with three server-side query functions:

    1. `getReviewQueue(params: { tenantId, page, pageSize, status?, category?, dateFrom?, dateTo? }): Promise<{ skills: ReviewQueueItem[], total: number }>`:
       - SELECT skills.id, name, slug, category, status, users.name as authorName, skills.authorId, skills.createdAt, skills.updatedAt
       - LEFT JOIN users on skills.authorId = users.id
       - WHERE tenantId matches, status filter (default: "ai_reviewed" if no status param), optional category filter, optional date range filters (dateFrom as `>= ::timestamptz`, dateTo as `<= ::timestamptz`)
       - ORDER BY skills.updatedAt DESC
       - LIMIT pageSize OFFSET (page-1)*pageSize
       - Parallel query for total count with same WHERE clause
       - Serialize dates with .toISOString() before returning (hydration safety)
       - Export ReviewQueueItem type

    2. `getReviewDetail(skillId: string, tenantId: string): Promise<ReviewDetailResult | null>`:
       - Fetch skill with author relation (id, name, image columns)
       - WHERE skills.id = skillId AND skills.tenantId = tenantId
       - Fetch AI review via getSkillReview(skillId) from @everyskill/db services
       - Fetch review decisions via getDecisionsForSkill(skillId) from @everyskill/db services
       - Return { skill (with content, status, statusMessage, name, description, category, tags), aiReview, decisions }
       - Serialize all dates with .toISOString()
       - Export ReviewDetailResult type

    3. `getPendingReviewCount(tenantId: string): Promise<number>`:
       - SELECT count(*) FROM skills WHERE tenantId = param AND status = "ai_reviewed"
       - Return the count number (0 if no db)

    Import db, skills, users from @everyskill/db. Import eq, and, sql, desc, count from drizzle-orm. Import getSkillReview from @everyskill/db services. Import getDecisionsForSkill from the new service. Import reviewDecisions from @everyskill/db schema for decisions query (alternative: use the service function).

    For getReviewDetail, also include the skill.content field (needed for the detail page to display content and for diff view).
  </action>
  <verify>
    Run `cd /home/dev/projects/relay && pnpm build` to verify all imports resolve and types check.
  </verify>
  <done>review-queries.ts exports getReviewQueue, getReviewDetail, and getPendingReviewCount. All functions type-check. Build passes with no errors.</done>
</task>

</tasks>

<verification>
- `\d review_decisions` shows correct columns (id, tenant_id, skill_id, reviewer_id, action, notes, ai_scores_snapshot, previous_content, created_at) -- NO updated_at
- `\di review_decisions*` shows 3 indexes (skill_id, tenant_id, reviewer_id)
- RLS is enabled: `SELECT rlsenabled FROM pg_class WHERE relname = 'review_decisions'` returns true
- `pnpm build` passes with no errors
- review-queries.ts exports 3 functions that compile correctly
</verification>

<success_criteria>
- review_decisions table created in database with immutable design (no updatedAt)
- Schema, relations, service, and query functions all type-check
- Full build passes
- Data layer is ready for server actions (Plan 02) and UI (Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/36-admin-review-ui/36-01-SUMMARY.md`
</output>
