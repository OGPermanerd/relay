---
phase: 30-branding-navigation
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/tenants.ts
  - packages/db/src/migrations/0008_add_vanity_domain.sql
  - packages/db/src/services/tenant.ts
autonomous: true

must_haves:
  truths:
    - "tenants table has a vanity_domain column (nullable, unique)"
    - "getTenantByVanityDomain() returns active tenant matching a vanity domain"
    - "SQL migration adds the column safely (IF NOT EXISTS pattern)"
  artifacts:
    - path: "packages/db/src/schema/tenants.ts"
      provides: "vanityDomain column on tenants table"
      contains: "vanity_domain"
    - path: "packages/db/src/migrations/0008_add_vanity_domain.sql"
      provides: "Migration to add vanity_domain column"
      contains: "ALTER TABLE tenants"
    - path: "packages/db/src/services/tenant.ts"
      provides: "getTenantByVanityDomain function"
      exports: ["getTenantByVanityDomain"]
  key_links:
    - from: "packages/db/src/services/tenant.ts"
      to: "packages/db/src/schema/tenants.ts"
      via: "tenants.vanityDomain column reference"
      pattern: "tenants\\.vanityDomain"
---

<objective>
Add vanity domain support to the tenant schema and service layer.

Purpose: BRAND-03 requires paid tenants to configure vanity URLs. This plan adds the `vanity_domain` column to the tenants table, creates the migration, and adds the `getTenantByVanityDomain()` service function.
Output: Schema column, migration, and service function.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@packages/db/src/schema/tenants.ts
@packages/db/src/services/tenant.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add vanity_domain to schema + migration + service</name>
  <files>packages/db/src/schema/tenants.ts, packages/db/src/migrations/0008_add_vanity_domain.sql, packages/db/src/services/tenant.ts</files>
  <action>
1. **Schema** -- Add to `packages/db/src/schema/tenants.ts`, after the `plan` column:
   ```typescript
   vanityDomain: text("vanity_domain").unique(), // e.g., "skills.acmecorp.com"
   ```

2. **Migration** -- Create `packages/db/src/migrations/0008_add_vanity_domain.sql`:
   ```sql
   -- Migration 0008: Add vanity_domain column to tenants
   -- Supports BRAND-03: paid tenants can configure a vanity URL

   DO $$
   BEGIN
     IF NOT EXISTS (
       SELECT 1 FROM information_schema.columns
       WHERE table_name = 'tenants' AND column_name = 'vanity_domain'
     ) THEN
       ALTER TABLE tenants ADD COLUMN vanity_domain TEXT UNIQUE;
     END IF;
   END $$;
   ```
   Follow existing idempotent migration pattern (IF NOT EXISTS guard, consistent with migrations 0002-0006).

3. **Service** -- Add to `packages/db/src/services/tenant.ts`, after `getTenantByDomain`:
   ```typescript
   /**
    * Look up an active tenant by vanity domain.
    * Returns the tenant record or null if not found / inactive / no vanity domain set.
    */
   export async function getTenantByVanityDomain(vanityDomain: string) {
     if (!db) return null;

     try {
       const [row] = await db
         .select()
         .from(tenants)
         .where(and(eq(tenants.vanityDomain, vanityDomain), eq(tenants.isActive, true)))
         .limit(1);
       return row ?? null;
     } catch {
       return null;
     }
   }
   ```

4. **Run migration**: `cd /home/dev/projects/relay && psql -d everyskill -f packages/db/src/migrations/0008_add_vanity_domain.sql`

5. **Sync Drizzle**: `cd /home/dev/projects/relay/packages/db && npx drizzle-kit push` (use if migration ran successfully to sync Drizzle's internal state).
  </action>
  <verify>
Run migration and confirm column exists:
```
psql -d everyskill -c "SELECT column_name FROM information_schema.columns WHERE table_name='tenants' AND column_name='vanity_domain';"
```
Run `cd /home/dev/projects/relay && npx tsc --noEmit -p apps/web/tsconfig.json 2>&1 | head -20` for type check.
  </verify>
  <done>
tenants table has `vanity_domain` TEXT UNIQUE column. `getTenantByVanityDomain()` function is exported from `@everyskill/db/services/tenant`. Migration 0008 ran idempotently.
  </done>
</task>

</tasks>

<verification>
- `packages/db/src/schema/tenants.ts` includes `vanityDomain` column.
- `packages/db/src/migrations/0008_add_vanity_domain.sql` exists with idempotent guard.
- `packages/db/src/services/tenant.ts` exports `getTenantByVanityDomain`.
- Column exists in database.
- TypeScript compiles without errors.
</verification>

<success_criteria>
Vanity domain column is available in the tenants schema and queryable via `getTenantByVanityDomain()`. Migration is idempotent and follows existing patterns.
</success_criteria>

<output>
After completion, create `.planning/phases/30-branding-navigation/30-06-SUMMARY.md`
</output>
