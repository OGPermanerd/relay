---
phase: 42-mcp-unification
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - apps/mcp/src/tools/legacy.ts
  - apps/mcp/src/tools/confirm-install.ts
  - apps/mcp/src/tools/check-review-status.ts
  - apps/mcp/src/tools/review-skill.ts
  - apps/mcp/src/tools/submit-for-review.ts
  - apps/mcp/src/tools/search.ts
  - apps/mcp/src/tools/list.ts
  - apps/mcp/src/tools/recommend.ts
  - apps/mcp/src/tools/describe.ts
  - apps/mcp/src/tools/deploy.ts
  - apps/mcp/src/tools/guide.ts
  - apps/mcp/src/tools/create.ts
  - apps/mcp/src/tools/update-skill.ts
  - apps/mcp/src/tools/check-skill-status.ts
  - apps/mcp/src/tools/index.ts
  - apps/mcp/test/tools.test.ts
autonomous: true

must_haves:
  truths:
    - "All 13 legacy tool registrations are centralized in legacy.ts with deprecation notices in descriptions"
    - "Individual tool files export only handler functions, no server.registerTool() calls"
    - "Tests verify the unified everyskill tool routes actions to correct handlers"
  artifacts:
    - path: "apps/mcp/src/tools/legacy.ts"
      provides: "All deprecated individual tool registrations"
      contains: "DEPRECATED.*use everyskill"
    - path: "apps/mcp/test/tools.test.ts"
      provides: "Tests for unified tool action routing"
      contains: "everyskill.*action"
  key_links:
    - from: "apps/mcp/src/tools/legacy.ts"
      to: "apps/mcp/src/tools/search.ts"
      via: "import handleSearchSkills for deprecated wrapper"
      pattern: "import.*handleSearchSkills.*from"
    - from: "apps/mcp/src/tools/index.ts"
      to: "apps/mcp/src/tools/legacy.ts"
      via: "side-effect import"
      pattern: 'import.*./legacy'
---

<objective>
Move all individual tool registrations to a centralized legacy.ts with deprecation notices, clean individual tool files to be pure handler modules, and add tests for the unified tool.

Purpose: Completes the STRAP migration by making `everyskill` the primary tool while keeping backward compatibility through clearly-deprecated legacy wrappers. Tests ensure the router dispatches correctly.

Output: `legacy.ts` with 13 deprecated tool registrations, clean handler-only tool files, and test coverage for the unified tool routing.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/42-mcp-unification/42-01-SUMMARY.md
@apps/mcp/src/tools/everyskill.ts
@apps/mcp/src/tools/index.ts
@apps/mcp/test/tools.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Centralize legacy tool registrations and clean handler files</name>
  <files>
    apps/mcp/src/tools/legacy.ts
    apps/mcp/src/tools/confirm-install.ts
    apps/mcp/src/tools/check-review-status.ts
    apps/mcp/src/tools/review-skill.ts
    apps/mcp/src/tools/submit-for-review.ts
    apps/mcp/src/tools/search.ts
    apps/mcp/src/tools/list.ts
    apps/mcp/src/tools/recommend.ts
    apps/mcp/src/tools/describe.ts
    apps/mcp/src/tools/deploy.ts
    apps/mcp/src/tools/guide.ts
    apps/mcp/src/tools/create.ts
    apps/mcp/src/tools/update-skill.ts
    apps/mcp/src/tools/check-skill-status.ts
    apps/mcp/src/tools/index.ts
  </files>
  <action>
    Create `apps/mcp/src/tools/legacy.ts` containing ALL 13 individual tool registrations (everything except log_usage which was deleted in Plan 01). Each registration:

    1. Prefixes description with `[DEPRECATED - use everyskill(action: '{action}') instead] `
    2. Keeps exact same inputSchema as the original
    3. Delegates to the same exported handler function

    The 13 tools to register in legacy.ts:
    - `list_skills` -> action "list"
    - `search_skills` -> action "search"
    - `recommend_skills` -> action "recommend"
    - `describe_skill` -> action "describe"
    - `deploy_skill` -> action "install"
    - `guide_skill` -> action "guide"
    - `create_skill` -> action "create"
    - `update_skill` -> action "update"
    - `review_skill` -> action "review"
    - `submit_for_review` -> action "submit_review"
    - `check_review_status` -> action "check_review"
    - `check_skill_status` -> action "check_status"
    - `confirm_install` -> (no unified action equivalent, but keep for backward compat)

    Import all handler functions from their respective files. Import `server` from `../server.js`, `z` from `zod`, and auth helpers from `../auth.js` as needed.

    **Clean individual tool files:** Remove `server.registerTool()` calls and `server` imports from ALL 13 handler files. Each file should export ONLY its handler function(s) and any supporting types/constants. Remove `import { server } from "../server.js"` from each file. Keep all other imports (db, auth, tracking, etc.) that the handler functions use.

    Files to clean (remove registerTool + server import):
    - `search.ts`, `list.ts`, `recommend.ts`, `describe.ts`, `deploy.ts`, `guide.ts`, `create.ts`, `update-skill.ts`, `check-skill-status.ts` (these 9 already have exported handlers)
    - `confirm-install.ts`, `check-review-status.ts`, `review-skill.ts`, `submit-for-review.ts` (these 4 got handlers extracted in Plan 01)

    **Update index.ts:** Replace all 13+ individual tool imports with just:
    ```
    import "./everyskill.js";
    import "./legacy.js";
    ```
    The everyskill.ts import was already added in Plan 01. Remove all individual tool file imports (list.js, search.js, deploy.js, etc.) since legacy.ts now handles their registration.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay/apps/mcp && npx tsc --noEmit` to confirm TypeScript compiles.
    Grep for `server.registerTool` in individual tool files (should find NONE -- only in everyskill.ts and legacy.ts).
    Grep for `DEPRECATED` in legacy.ts (should find 13 occurrences).
    Confirm index.ts has exactly 2 imports: everyskill.js and legacy.js.
  </verify>
  <done>
    All `server.registerTool()` calls are in exactly 2 files: `everyskill.ts` (unified tool) and `legacy.ts` (13 deprecated wrappers). Individual tool files are pure handler modules. index.ts imports only everyskill.js and legacy.js.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for unified tool action routing</name>
  <files>
    apps/mcp/test/tools.test.ts
  </files>
  <action>
    Add a new `describe("everyskill unified tool")` block to the existing test file. Import the router function or test via the handler imports used by everyskill.ts.

    Since the unified tool is registered via `server.registerTool()` side effect and the test file already imports handlers directly, test the routing logic by:

    1. Importing the handler functions that everyskill.ts delegates to (they are already imported in the test file for list/search/deploy).
    2. Adding tests that verify the unified tool's action-to-handler mapping works correctly.

    **Approach:** Since the tool is registered as a side effect on the MCP server and testing the full server dispatch is complex, test the action routing by importing a `routeEveryskillAction` function. To make this testable:

    In `everyskill.ts`, extract the switch/case routing logic into an exported function:
    ```typescript
    export async function routeEveryskillAction(args: z.infer<typeof EverySkillInput>) { ... }
    ```
    The `server.registerTool` callback calls `routeEveryskillAction(args)`.

    **Tests to add (at minimum):**
    - `search` action with query calls handleSearchSkills and returns results
    - `list` action calls handleListSkills and returns results
    - `describe` action without skillId returns clear error message
    - `search` action without query returns clear error message
    - `check_review` action with no skillId does not error (skillId is optional)

    Mock the handler functions using `vi.mock()` for the handler modules that are already mocked, and add mocks for the newly extractable ones. The test should verify that `routeEveryskillAction({ action: "search", query: "test" })` calls the search handler and returns its result.

    Keep tests simple -- the handlers themselves are already tested or are too complex to unit test (AI review). Focus on verifying the routing and param validation logic.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay/apps/mcp && npx vitest run` -- all tests pass including new ones.
    Confirm at least 5 new test cases exist for the unified tool.
  </verify>
  <done>
    Test file covers unified tool routing: successful dispatch for search/list actions, param validation errors for missing required params, and optional param handling. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/dev/projects/relay/apps/mcp && npx tsc --noEmit` -- zero errors
2. `cd /home/dev/projects/relay/apps/mcp && npx vitest run` -- all tests pass
3. `grep -r "server.registerTool" apps/mcp/src/tools/` returns matches ONLY in everyskill.ts and legacy.ts
4. `grep -c "DEPRECATED" apps/mcp/src/tools/legacy.ts` returns 13
5. `cat apps/mcp/src/tools/index.ts` shows exactly 2 imports
6. Individual handler files have no `server.registerTool` calls
</verification>

<success_criteria>
- legacy.ts contains all 13 deprecated tool registrations with clear deprecation notices
- Individual tool files are clean handler-only modules (no registration side effects)
- index.ts is reduced to 2 imports (everyskill + legacy)
- New tests verify unified tool routing and param validation
- All tests pass, TypeScript compiles clean
- Total registered tools: 14 (1 unified + 13 deprecated legacy)
</success_criteria>

<output>
After completion, create `.planning/phases/42-mcp-unification/42-02-SUMMARY.md`
</output>
