---
phase: 42-mcp-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mcp/src/tools/confirm-install.ts
  - apps/mcp/src/tools/check-review-status.ts
  - apps/mcp/src/tools/review-skill.ts
  - apps/mcp/src/tools/submit-for-review.ts
  - apps/mcp/src/tools/log-usage.ts
  - apps/mcp/src/tools/everyskill.ts
  - apps/mcp/src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "A single `everyskill` tool is registered with an `action` enum discriminator supporting 12 sub-commands"
    - "All 12 actions route to existing handler functions without duplicating business logic"
    - "Action-specific required params are validated in the router before delegating to handlers"
  artifacts:
    - path: "apps/mcp/src/tools/everyskill.ts"
      provides: "Unified tool registration with action router"
      contains: "server.registerTool.*everyskill"
    - path: "apps/mcp/src/tools/confirm-install.ts"
      provides: "Extracted handleConfirmInstall handler"
      contains: "export async function handleConfirmInstall"
    - path: "apps/mcp/src/tools/check-review-status.ts"
      provides: "Extracted handleCheckReviewStatus handler"
      contains: "export async function handleCheckReviewStatus"
    - path: "apps/mcp/src/tools/review-skill.ts"
      provides: "Extracted handleReviewSkill handler"
      contains: "export async function handleReviewSkill"
    - path: "apps/mcp/src/tools/submit-for-review.ts"
      provides: "Extracted handleSubmitForReview handler"
      contains: "export async function handleSubmitForReview"
  key_links:
    - from: "apps/mcp/src/tools/everyskill.ts"
      to: "apps/mcp/src/tools/search.ts"
      via: "import handleSearchSkills"
      pattern: "import.*handleSearchSkills.*from"
    - from: "apps/mcp/src/tools/everyskill.ts"
      to: "apps/mcp/src/tools/review-skill.ts"
      via: "import handleReviewSkill"
      pattern: "import.*handleReviewSkill.*from"
    - from: "apps/mcp/src/tools/index.ts"
      to: "apps/mcp/src/tools/everyskill.ts"
      via: "side-effect import"
      pattern: 'import.*./everyskill'
---

<objective>
Extract inline handlers from 4 tool files, remove the deprecated log_usage tool, and create the unified `everyskill` tool with STRAP action router.

Purpose: The unified tool reduces context window overhead from 14 separate tool definitions to 1, improving AI client tool selection. Handlers must be extractable functions before the router can import them.

Output: `everyskill.ts` with working action router dispatching to all 12 handler functions (log_usage excluded as deprecated no-op). Individual tool files retain their `server.registerTool()` calls for now (Plan 02 moves those to legacy.ts).
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@apps/mcp/src/tools/index.ts
@apps/mcp/src/server.ts
@apps/mcp/src/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract inline handlers and remove log_usage</name>
  <files>
    apps/mcp/src/tools/confirm-install.ts
    apps/mcp/src/tools/check-review-status.ts
    apps/mcp/src/tools/review-skill.ts
    apps/mcp/src/tools/submit-for-review.ts
    apps/mcp/src/tools/log-usage.ts
    apps/mcp/src/tools/index.ts
  </files>
  <action>
    Extract handler functions from 4 tool files that currently have inline callbacks in `server.registerTool()`. Each file keeps its existing `server.registerTool()` call (backward compat stays until Plan 02), but the callback now delegates to the exported handler.

    **confirm-install.ts:** Extract `export async function handleConfirmInstall({ skillId }: { skillId: string })` that contains the current inline logic (trackUsage call + success response). The `registerTool` callback calls `handleConfirmInstall({ skillId })`.

    **check-review-status.ts:** Extract `export async function handleCheckReviewStatus({ skillId }: { skillId?: string })` containing the full inline logic (auth check, DB queries for single skill or pipeline list). The callback calls `handleCheckReviewStatus({ skillId })`.

    **review-skill.ts:** Already exports `generateSkillReview` and `hashContent`. Additionally extract `export async function handleReviewSkill({ skillId }: { skillId: string })` wrapping the inline callback logic (auth check, skill fetch, call generateSkillReview, store result, return formatted response). The callback calls `handleReviewSkill({ skillId })`.

    **submit-for-review.ts:** Extract `export async function handleSubmitForReview({ skillId }: { skillId: string })` wrapping the full inline callback (auth check, skill fetch, state machine validation, status transitions, AI review, auto-approve chain). The callback calls `handleSubmitForReview({ skillId })`.

    **log-usage.ts:** DELETE this file entirely. It is a deprecated no-op that wastes context tokens.

    **index.ts:** Remove the `import "./log-usage.js"` line.

    Pattern to follow (same as search.ts, list.ts, etc.): Extract the async function body into an exported named function, then have the registerTool callback be a thin delegation. Handler functions use `getUserId()` and `getTenantId()` internally (they already do in the inline version) -- do NOT pass userId/tenantId as params for these 4 handlers since they call getUserId() themselves (unlike search/list which accept userId as a param for testability).
  </action>
  <verify>
    Run `cd /home/dev/projects/relay/apps/mcp && npx tsc --noEmit` to verify TypeScript compiles.
    Run `cd /home/dev/projects/relay/apps/mcp && npx vitest run` to verify existing tests pass.
    Grep for `handleConfirmInstall`, `handleCheckReviewStatus`, `handleReviewSkill`, `handleSubmitForReview` exports.
    Confirm `log-usage.ts` is deleted and not imported in `index.ts`.
  </verify>
  <done>
    All 4 handler functions are exported. Existing `server.registerTool()` calls delegate to them. `log_usage` tool is removed. All existing tests pass. TypeScript compiles clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unified everyskill tool with action router</name>
  <files>
    apps/mcp/src/tools/everyskill.ts
    apps/mcp/src/tools/index.ts
  </files>
  <action>
    Create `apps/mcp/src/tools/everyskill.ts` with the unified `everyskill` tool following the STRAP pattern.

    **Input schema (Zod):** Flat object with `action` enum discriminator:
    ```
    action: z.enum(["search", "list", "recommend", "describe", "install", "guide", "create", "update", "review", "submit_review", "check_review", "check_status"])
    ```
    Plus optional params: `query`, `category` (enum: prompt/workflow/agent/mcp), `limit` (1-50), `skillId`, `name`, `description`, `content`, `tags` (string array), `hoursSaved` (number), `visibility` (enum: tenant/personal), `filePath`.

    All params except `action` are `.optional()`. Add `.describe()` annotations noting which actions use each param.

    **Tool description:** Use the optimized description from research:
    ```
    EverySkill - AI skill marketplace. Search, discover, install, create, and manage reusable AI skills (prompts, workflows, agents, MCP configurations). IMPORTANT: Use this tool proactively whenever the user needs help with AI prompts, coding workflows, agent configurations, or asks about available skills. Actions: search (keyword search), list (browse all), recommend (AI-powered discovery), describe (full details + reviews), install (deploy to local env), guide (usage instructions), create (publish new skill), update (push changes), review (AI quality review), submit_review (full review pipeline), check_review (pipeline status), check_status (local vs published diff).
    ```

    **Router callback:** Switch on `args.action`. For each case:
    1. Validate action-specific required params. If missing, return a clear error: `{ error: "Missing required parameter", message: '"search" action requires "query" parameter' }` with `isError: true`.
    2. Delegate to the appropriate handler function.

    **Required params per action:**
    - `search`: requires `query`
    - `list`: no required params
    - `recommend`: requires `query`
    - `describe`: requires `skillId`
    - `install`: requires `skillId`
    - `guide`: requires `skillId`
    - `create`: requires `name`, `description`, `content`, `category`, `hoursSaved`
    - `update`: requires `skillId`, `content`
    - `review`: requires `skillId`
    - `submit_review`: requires `skillId`
    - `check_review`: no required params (skillId optional)
    - `check_status`: requires `skillId`

    **Handler imports:**
    - `handleSearchSkills` from `./search.js`
    - `handleListSkills` from `./list.js`
    - `handleRecommendSkills` from `./recommend.js`
    - `handleDescribeSkill` from `./describe.js`
    - `handleDeploySkill` from `./deploy.js`
    - `handleGuideSkill` from `./guide.js`
    - `handleCreateSkill` from `./create.js`
    - `handleUpdateSkill` from `./update-skill.js`
    - `handleReviewSkill` from `./review-skill.js`
    - `handleSubmitForReview` from `./submit-for-review.js`
    - `handleCheckReviewStatus` from `./check-review-status.js`
    - `handleCheckSkillStatus` from `./check-skill-status.js`
    - `handleConfirmInstall` from `./confirm-install.js`

    Note: `install` action calls `handleDeploySkill` (renamed for user-friendliness, maps to same handler). Do NOT call handleConfirmInstall for `install` -- `install` maps to `handleDeploySkill`. The `confirm_install` tool is NOT exposed as a unified action (it is an internal follow-up tool, not user-facing).

    Wait -- the research schema has 12 actions, not 13. `confirm_install` is excluded from the unified tool (correct -- it's a follow-up tool called after install, not a user-initiated action). The 12 actions are: search, list, recommend, describe, install, guide, create, update, review, submit_review, check_review, check_status.

    For handlers that accept `userId` param (search, list, recommend, describe, deploy, guide, create, update, check-skill-status): pass `getUserId() ?? undefined`.
    For handlers that call `getUserId()` internally (review, submit_for_review, check_review_status): just pass `{ skillId }`.
    For `install` (handleDeploySkill): pass `{ skillId, userId, skipNudge: true }` -- skip nudge since the unified tool itself is the discovery surface.

    **index.ts:** Add `import "./everyskill.js"` at the top of the import list.
  </action>
  <verify>
    Run `cd /home/dev/projects/relay/apps/mcp && npx tsc --noEmit` to confirm TypeScript compiles.
    Run `cd /home/dev/projects/relay/apps/mcp && npx vitest run` to confirm existing tests still pass.
    Grep for `server.registerTool.*everyskill` in everyskill.ts to confirm registration.
    Grep for `import.*everyskill` in index.ts.
  </verify>
  <done>
    The `everyskill` unified tool is registered alongside all existing individual tools. It routes 12 actions to existing handlers. TypeScript compiles. Existing tests pass. The tool has an optimized description for AI discoverability.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/dev/projects/relay/apps/mcp && npx tsc --noEmit` -- zero errors
2. `cd /home/dev/projects/relay/apps/mcp && npx vitest run` -- all tests pass
3. Grep confirms 5 exported handler functions (4 newly extracted + confirm-install)
4. `everyskill.ts` exists with `server.registerTool("everyskill", ...)`
5. `log-usage.ts` is deleted, not referenced in index.ts
6. All 14 original tools (minus log_usage = 13) still register normally alongside the new unified tool
</verification>

<success_criteria>
- The unified `everyskill` tool registers successfully with 12 actions
- All existing individual tools continue to work (backward compatible)
- `log_skill_usage` deprecated tool is removed
- TypeScript compiles with zero errors
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/42-mcp-unification/42-01-SUMMARY.md`
</output>
