---
phase: 25-multi-tenancy-schema-audit
plan: 07
type: execute
wave: 3
depends_on: ["25-03", "25-04"]
files_modified:
  - packages/db/src/schema/skills.ts
  - packages/db/src/schema/users.ts
  - packages/db/src/schema/ratings.ts
  - packages/db/src/schema/usage-events.ts
  - packages/db/src/schema/skill-versions.ts
  - packages/db/src/schema/skill-embeddings.ts
  - packages/db/src/schema/skill-reviews.ts
  - packages/db/src/schema/api-keys.ts
  - packages/db/src/schema/site-settings.ts
  - packages/db/drizzle.config.ts
autonomous: true

must_haves:
  truths:
    - "Every tenant-scoped table has a pgPolicy definition for tenant isolation"
    - "RLS policies use current_setting('app.current_tenant_id', true) for row filtering"
    - "Drizzle config includes entities.roles: true for pgRole support"
  artifacts:
    - path: "packages/db/src/schema/skills.ts"
      provides: "Skills table with pgPolicy for tenant isolation"
      contains: "pgPolicy"
    - path: "packages/db/drizzle.config.ts"
      provides: "Drizzle config with RLS role support"
      contains: "entities"
  key_links:
    - from: "packages/db/src/schema/skills.ts"
      to: "PostgreSQL RLS"
      via: "pgPolicy using current_setting"
      pattern: "current_setting.*app\\.current_tenant_id"
---

<objective>
Add Drizzle pgPolicy definitions to all 9 tenant-scoped schema files and update drizzle.config.ts for RLS role support.

Purpose: While the SQL migrations (Plans 25-05/25-06) create the actual database policies, the Drizzle schema definitions must also declare them so Drizzle's introspection and future migration generation stay in sync. This ensures defense-in-depth: both database-level RLS and schema-level documentation of policies.
Output: All 9 schema files with pgPolicy declarations, drizzle.config.ts updated with entities.roles.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/25-multi-tenancy-schema-audit/25-03-SUMMARY.md
@.planning/phases/25-multi-tenancy-schema-audit/25-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pgPolicy to all 9 schema files</name>
  <files>
    packages/db/src/schema/skills.ts
    packages/db/src/schema/users.ts
    packages/db/src/schema/ratings.ts
    packages/db/src/schema/usage-events.ts
    packages/db/src/schema/skill-versions.ts
    packages/db/src/schema/skill-embeddings.ts
    packages/db/src/schema/skill-reviews.ts
    packages/db/src/schema/api-keys.ts
    packages/db/src/schema/site-settings.ts
  </files>
  <action>
Read each of the 9 schema files (they were modified by Plans 25-03 and 25-04 to include tenantId columns). Add pgPolicy definitions to each table.

**Add these imports to each file:**
```typescript
import { pgPolicy } from "drizzle-orm/pg-core";
import { sql } from "drizzle-orm";
```

**Add this policy to each table's third argument (the extras array):**
```typescript
pgPolicy("tenant_isolation", {
  as: "restrictive",
  for: "all",
  using: sql`tenant_id = current_setting('app.current_tenant_id', true)`,
  withCheck: sql`tenant_id = current_setting('app.current_tenant_id', true)`,
}),
```

For the skills table, the extras array should end up with:
```typescript
(table) => [
  index("skills_search_idx").using("gin", table.searchVector),
  uniqueIndex("skills_tenant_slug_unique").on(table.tenantId, table.slug),
  index("skills_tenant_id_idx").on(table.tenantId),
  pgPolicy("tenant_isolation", {
    as: "restrictive",
    for: "all",
    using: sql`tenant_id = current_setting('app.current_tenant_id', true)`,
    withCheck: sql`tenant_id = current_setting('app.current_tenant_id', true)`,
  }),
]
```

For tables that don't yet have a third argument (extras array), add one:
```typescript
// Before (no extras):
export const ratings = pgTable("ratings", { ... });

// After (with extras):
export const ratings = pgTable("ratings", { ... },
  (table) => [
    index("ratings_tenant_id_idx").on(table.tenantId),
    pgPolicy("tenant_isolation", {
      as: "restrictive",
      for: "all",
      using: sql`tenant_id = current_setting('app.current_tenant_id', true)`,
      withCheck: sql`tenant_id = current_setting('app.current_tenant_id', true)`,
    }),
  ]
);
```

**Important:** Do NOT use `pgRole` or `to:` in the policy definition. The research notes that the current app connects as the database owner. Using `to: appRole` would break since the app_user role doesn't exist yet. Omitting `to:` makes the policy apply to the `public` role (all users), which combined with FORCE ROW LEVEL SECURITY (from migration 0005) ensures it works for all connections.
  </action>
  <verify>
Run: `cd /home/dev/projects/relay && npx tsc --noEmit -p packages/db/tsconfig.json 2>&1 | head -30`
Verify that pgPolicy import and usage exist in all 9 files:
```bash
grep -l "pgPolicy" packages/db/src/schema/{skills,users,ratings,usage-events,skill-versions,skill-embeddings,skill-reviews,api-keys,site-settings}.ts
```
Should list all 9 files.
  </verify>
  <done>
All 9 tenant-scoped tables have pgPolicy("tenant_isolation") declarations using current_setting('app.current_tenant_id', true) for both USING and WITH CHECK clauses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update drizzle.config.ts for RLS support</name>
  <files>
    packages/db/drizzle.config.ts
  </files>
  <action>
Read and update `packages/db/drizzle.config.ts` to include `entities` configuration for RLS role support.

Add `entities: { roles: true }` to the config:
```typescript
export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema/index.ts",
  out: "./src/migrations",
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
  entities: {
    roles: true,
  },
});
```

This tells Drizzle Kit to track pgRole and pgPolicy entities during migration generation.
  </action>
  <verify>
Run: `grep -A2 "entities" packages/db/drizzle.config.ts`
Should show `entities: { roles: true }`.
  </verify>
  <done>
drizzle.config.ts includes entities.roles: true, enabling Drizzle Kit to manage RLS policies during migration generation.
  </done>
</task>

</tasks>

<verification>
- All 9 schema files contain pgPolicy import and tenant_isolation policy definition
- drizzle.config.ts has entities.roles: true
- TypeScript compiles without errors
- Policies use current_setting('app.current_tenant_id', true) consistently
</verification>

<success_criteria>
Drizzle schema definitions are fully in sync with the database-level RLS policies created by migration 0005. The drizzle.config.ts supports RLS role management. All files compile.
</success_criteria>

<output>
After completion, create `.planning/phases/25-multi-tenancy-schema-audit/25-07-SUMMARY.md`
</output>
