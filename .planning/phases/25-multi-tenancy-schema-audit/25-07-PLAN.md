---
phase: 25-multi-tenancy-schema-audit
plan: 07
type: execute
wave: 4
depends_on: ["25-03", "25-04", "25-05", "25-06"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All 5 migrations (0002-0006) run successfully against the database"
    - "The tenants table exists with a 'default' tenant row"
    - "All 9 data tables have a NOT NULL tenant_id column with FK to tenants"
    - "RLS is enabled on all 9 tenant-scoped tables"
    - "The audit_logs table exists with trigger-based modification protection"
    - "The skills table has a composite unique on (tenant_id, slug) instead of global slug unique"
    - "TypeScript compiles without errors across the entire project"
    - "The dev server starts without errors"
  artifacts: []
  key_links:
    - from: "packages/db/src/migrations/0002_add_tenants.sql"
      to: "PostgreSQL database"
      via: "migration execution"
      pattern: "tenants table exists"
    - from: "packages/db/src/migrations/0005_enforce_tenant_id.sql"
      to: "PostgreSQL database"
      via: "RLS policy creation"
      pattern: "RLS enabled on all tables"
---

<objective>
Run all migrations and verify the complete multi-tenancy schema and audit foundation works end-to-end.

Purpose: This is the final verification step that confirms all schema changes, migrations, RLS policies, and audit logging work together correctly. It ensures the database is in the expected state before downstream phases start building on the multi-tenant foundation.
Output: A working database with multi-tenant isolation and audit logging.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/25-multi-tenancy-schema-audit/25-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run migrations and verify database state</name>
  <files></files>
  <action>
Run the migrations and verify the database state. Execute these steps in order:

**Step 1: Run migrations**
The project uses Drizzle migrations. Check how migrations are run in this project:
```bash
cd /home/dev/projects/relay
# Check package.json scripts for migration commands
grep -i "migrat" packages/db/package.json apps/web/package.json
```

If there's a `db:migrate` or `db:push` script, use it. Otherwise, run:
```bash
cd /home/dev/projects/relay/packages/db
npx drizzle-kit push
```

If `drizzle-kit push` fails because it can't handle custom SQL migrations, run them manually:
```bash
# Load .env.local for DATABASE_URL
source <(grep DATABASE_URL ../../.env.local | sed 's/^/export /')

# Run custom migrations in order
for f in src/migrations/0002_*.sql src/migrations/0003_*.sql src/migrations/0004_*.sql src/migrations/0005_*.sql src/migrations/0006_*.sql; do
  echo "Running $f..."
  psql "$DATABASE_URL" -f "$f"
done
```

**Step 2: Verify database state**
```bash
# Verify tenants table exists and has default tenant
psql "$DATABASE_URL" -c "SELECT id, name, slug FROM tenants;"

# Verify tenant_id columns exist and are NOT NULL
psql "$DATABASE_URL" -c "\d skills" | grep tenant_id

# Verify RLS is enabled
psql "$DATABASE_URL" -c "SELECT tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public' AND tablename IN ('skills', 'users', 'ratings', 'usage_events', 'skill_versions', 'skill_embeddings', 'skill_reviews', 'api_keys', 'site_settings');"

# Verify RLS policies exist
psql "$DATABASE_URL" -c "SELECT tablename, policyname FROM pg_policies WHERE schemaname = 'public';"

# Verify audit_logs table exists with trigger
psql "$DATABASE_URL" -c "\d audit_logs"
psql "$DATABASE_URL" -c "SELECT tgname FROM pg_trigger WHERE tgrelid = 'audit_logs'::regclass;"

# Verify composite unique on skills
psql "$DATABASE_URL" -c "SELECT conname FROM pg_constraint WHERE conrelid = 'skills'::regclass AND contype = 'u';"
```

**Step 3: Verify TypeScript compilation**
```bash
cd /home/dev/projects/relay
npx tsc --noEmit -p packages/db/tsconfig.json
```

**Step 4: Verify dev server starts**
```bash
cd /home/dev/projects/relay/apps/web
npm run build 2>&1 | tail -20
```
If build fails due to tenant_id not being passed in existing queries, that's EXPECTED — those query updates are in future phases. The important thing is that the schema compiles and migrations run.

**Step 5: Run existing Playwright tests**
```bash
cd /home/dev/projects/relay/apps/web
node_modules/.bin/playwright test 2>&1 | tail -30
```
Note: Some tests may fail because existing queries don't yet pass tenant_id. Document which tests fail — these will be fixed in later phases when queries are updated.
  </action>
  <verify>
- `SELECT * FROM tenants WHERE slug = 'default'` returns one row
- `\d skills` shows `tenant_id | text | not null`
- `SELECT rowsecurity FROM pg_tables WHERE tablename = 'skills'` returns `true` (or `t`)
- `SELECT policyname FROM pg_policies WHERE tablename = 'skills'` returns `tenant_isolation`
- `SELECT tgname FROM pg_trigger WHERE tgrelid = 'audit_logs'::regclass` returns `no_audit_update`
- TypeScript compiles (packages/db)
  </verify>
  <done>
All migrations run successfully. Database has: tenants table with default tenant, tenant_id NOT NULL on all 9 tables, RLS enabled with tenant_isolation policies, audit_logs with trigger protection, composite unique on skills(tenant_id, slug). TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
- Tenants table exists with default tenant row
- All 9 tables have NOT NULL tenant_id with FK to tenants
- RLS enabled and forced on all 9 tables
- tenant_isolation policy exists on all 9 tables
- audit_logs table exists with no_audit_update trigger
- skills has composite unique (tenant_id, slug)
- TypeScript compiles
</verification>

<success_criteria>
The database is fully migrated to multi-tenant with RLS. All schema changes are verified at both the TypeScript and database levels. The foundation is ready for Phase 26 (Auth & Subdomain Routing) and other downstream phases.
</success_criteria>

<output>
After completion, create `.planning/phases/25-multi-tenancy-schema-audit/25-07-SUMMARY.md`
</output>
