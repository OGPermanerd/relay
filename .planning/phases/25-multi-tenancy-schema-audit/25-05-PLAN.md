---
phase: 25-multi-tenancy-schema-audit
plan: 05
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - packages/db/src/migrations/0002_add_tenants.sql
  - packages/db/src/migrations/0003_add_tenant_id_columns.sql
  - packages/db/src/migrations/0004_backfill_tenant_id.sql
  - packages/db/src/migrations/meta/_journal.json
autonomous: true

must_haves:
  truths:
    - "Migration 0002 creates the tenants table and inserts a default tenant row"
    - "Migration 0003 adds nullable tenant_id column to all 9 data tables"
    - "Migration 0004 backfills all existing rows with the default tenant's ID"
    - "Drizzle migration journal includes entries for migrations 0002-0004"
  artifacts:
    - path: "packages/db/src/migrations/0002_add_tenants.sql"
      provides: "Tenants table DDL + default tenant seed"
    - path: "packages/db/src/migrations/0003_add_tenant_id_columns.sql"
      provides: "Add nullable tenant_id to 9 tables"
    - path: "packages/db/src/migrations/0004_backfill_tenant_id.sql"
      provides: "Backfill tenant_id with default tenant"
    - path: "packages/db/src/migrations/meta/_journal.json"
      provides: "Drizzle migration journal with entries for 0002-0004"
  key_links:
    - from: "packages/db/src/migrations/0004_backfill_tenant_id.sql"
      to: "packages/db/src/migrations/0002_add_tenants.sql"
      via: "references default tenant created in 0002"
      pattern: "default-tenant-000-0000-000000000000"
---

<objective>
Create the first 3 custom SQL migration files: create tenants table, add nullable tenant_id columns, and backfill existing data. Also update the Drizzle migration journal.

Purpose: These migrations are the first half of the multi-step migration from single-tenant to multi-tenant. The nullable-then-backfill-then-enforce pattern ensures zero data loss and safe rollback at each step. Plan 25-06 handles the constraint enforcement and audit logs.
Output: 3 SQL migration files and updated migration journal.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@packages/db/drizzle.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration files 0002-0004 and update journal</name>
  <files>
    packages/db/src/migrations/0002_add_tenants.sql
    packages/db/src/migrations/0003_add_tenant_id_columns.sql
    packages/db/src/migrations/0004_backfill_tenant_id.sql
    packages/db/src/migrations/meta/_journal.json
  </files>
  <action>
Create three SQL migration files. These are custom migrations (not Drizzle-generated) for the multi-step nullable-to-NOT-NULL pattern.

**File: `0002_add_tenants.sql`**
```sql
-- Create tenants table
CREATE TABLE IF NOT EXISTS tenants (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  name text NOT NULL,
  slug text NOT NULL UNIQUE,
  domain text,
  logo text,
  is_active boolean NOT NULL DEFAULT true,
  plan text NOT NULL DEFAULT 'freemium',
  created_at timestamp NOT NULL DEFAULT now(),
  updated_at timestamp NOT NULL DEFAULT now()
);

-- Seed a default tenant for backfilling existing data
INSERT INTO tenants (id, name, slug, domain)
VALUES ('default-tenant-000-0000-000000000000', 'Default', 'default', NULL)
ON CONFLICT (slug) DO NOTHING;
```

**File: `0003_add_tenant_id_columns.sql`**
```sql
-- Add nullable tenant_id to all 9 data tables
ALTER TABLE users ADD COLUMN IF NOT EXISTS tenant_id text;
ALTER TABLE skills ADD COLUMN IF NOT EXISTS tenant_id text;
ALTER TABLE ratings ADD COLUMN IF NOT EXISTS tenant_id text;
ALTER TABLE usage_events ADD COLUMN IF NOT EXISTS tenant_id text;
ALTER TABLE skill_versions ADD COLUMN IF NOT EXISTS tenant_id text;
ALTER TABLE skill_embeddings ADD COLUMN IF NOT EXISTS tenant_id text;
ALTER TABLE skill_reviews ADD COLUMN IF NOT EXISTS tenant_id text;
ALTER TABLE api_keys ADD COLUMN IF NOT EXISTS tenant_id text;
ALTER TABLE site_settings ADD COLUMN IF NOT EXISTS tenant_id text;
```

**File: `0004_backfill_tenant_id.sql`**
```sql
-- Backfill all existing rows with the default tenant ID
-- WHERE tenant_id IS NULL makes this idempotent (safe to re-run)
UPDATE users SET tenant_id = 'default-tenant-000-0000-000000000000' WHERE tenant_id IS NULL;
UPDATE skills SET tenant_id = 'default-tenant-000-0000-000000000000' WHERE tenant_id IS NULL;
UPDATE ratings SET tenant_id = 'default-tenant-000-0000-000000000000' WHERE tenant_id IS NULL;
UPDATE usage_events SET tenant_id = 'default-tenant-000-0000-000000000000' WHERE tenant_id IS NULL;
UPDATE skill_versions SET tenant_id = 'default-tenant-000-0000-000000000000' WHERE tenant_id IS NULL;
UPDATE skill_embeddings SET tenant_id = 'default-tenant-000-0000-000000000000' WHERE tenant_id IS NULL;
UPDATE skill_reviews SET tenant_id = 'default-tenant-000-0000-000000000000' WHERE tenant_id IS NULL;
UPDATE api_keys SET tenant_id = 'default-tenant-000-0000-000000000000' WHERE tenant_id IS NULL;
UPDATE site_settings SET tenant_id = 'default-tenant-000-0000-000000000000' WHERE tenant_id IS NULL;
```

Note: Using a deterministic UUID ('default-tenant-000-0000-000000000000') for the default tenant so the backfill migration can reference it without a subquery.

**Update `packages/db/src/migrations/meta/_journal.json`:**
Read the existing journal first to understand the format, then append entries for migrations 0002, 0003, and 0004 following the existing entry pattern (idx, version, when, tag, breakpoints). Use the same format as existing entries. Set appropriate sequential idx values and timestamps.
  </action>
  <verify>
Verify all 3 migration files exist and contain valid SQL:
```bash
for f in packages/db/src/migrations/000{2,3,4}_*.sql; do echo "=== $f ==="; head -5 "$f"; done
```
Verify the journal has entries for 0002-0004:
```bash
grep "0002\|0003\|0004" packages/db/src/migrations/meta/_journal.json
```
  </verify>
  <done>
Three migration files exist: 0002 creates tenants table + default tenant row, 0003 adds nullable tenant_id to all 9 tables, 0004 backfills with default tenant ID. Migration journal updated with entries for 0002-0004.
  </done>
</task>

</tasks>

<verification>
- 3 migration files exist in packages/db/src/migrations/
- 0002 creates tenants table and seeds default tenant
- 0003 adds nullable tenant_id to all 9 tables
- 0004 backfills with default tenant ID
- Drizzle migration journal updated with entries for 0002-0004
</verification>

<success_criteria>
The first 3 migration files are ready to run sequentially against the database. The journal references them. Plan 25-06 will add the constraint enforcement and audit logs migrations.
</success_criteria>

<output>
After completion, create `.planning/phases/25-multi-tenancy-schema-audit/25-05-SUMMARY.md`
</output>
