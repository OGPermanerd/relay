---
phase: 25-multi-tenancy-schema-audit
plan: 08
type: execute
wave: 3
depends_on: ["25-01"]
files_modified:
  - packages/db/src/services/audit.ts
  - packages/db/src/services/index.ts
autonomous: true

must_haves:
  truths:
    - "An audit log write helper exists that inserts entries into audit_logs table"
    - "The helper is fire-and-forget safe (catches errors, logs to console)"
    - "The service is exported from the packages/db services index"
  artifacts:
    - path: "packages/db/src/services/audit.ts"
      provides: "writeAuditLog function for SOC2 compliance"
      exports: ["writeAuditLog", "AuditEntry"]
  key_links:
    - from: "packages/db/src/services/audit.ts"
      to: "packages/db/src/schema/audit-logs.ts"
      via: "imports auditLogs table"
      pattern: "import.*auditLogs.*from.*audit-logs"
    - from: "packages/db/src/services/audit.ts"
      to: "packages/db/src/client.ts"
      via: "imports db client"
      pattern: "import.*db.*from.*client"
---

<objective>
Create the audit log write service for SOC2 compliance event logging.

Purpose: The writeAuditLog() helper provides a fire-and-forget API for recording security events. It's the application-layer interface to the append-only audit_logs table. Future phases will call this from auth handlers, admin actions, and data modification endpoints.
Output: Audit service module with writeAuditLog function, exported from the services index.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@packages/db/src/services/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audit log write service</name>
  <files>
    packages/db/src/services/audit.ts
    packages/db/src/services/index.ts
  </files>
  <action>
Create `packages/db/src/services/audit.ts`:

```typescript
import { db } from "../client";
import { auditLogs } from "../schema/audit-logs";

export interface AuditEntry {
  actorId?: string | null;
  tenantId?: string | null;
  action: string;
  resourceType?: string;
  resourceId?: string;
  ipAddress?: string;
  metadata?: Record<string, unknown>;
}

/**
 * Write an audit log entry. Fire-and-forget safe.
 * Uses direct INSERT (not transaction-scoped) because audit_logs
 * is append-only and doesn't need RLS tenant filtering.
 *
 * Common action patterns:
 * - "auth.login" / "auth.logout" / "auth.login_failed"
 * - "skill.create" / "skill.update" / "skill.delete"
 * - "admin.delete_skill" / "admin.merge_skills"
 * - "api_key.create" / "api_key.revoke"
 * - "settings.update"
 */
export async function writeAuditLog(entry: AuditEntry): Promise<void> {
  if (!db) return;
  try {
    await db.insert(auditLogs).values(entry);
  } catch (error) {
    // Never throw from audit logging â€” it must not break the primary operation
    console.error("Failed to write audit log:", error);
  }
}

/**
 * Write multiple audit log entries in a single INSERT.
 * Useful for batch operations like merge-skills.
 */
export async function writeAuditLogs(entries: AuditEntry[]): Promise<void> {
  if (!db || entries.length === 0) return;
  try {
    await db.insert(auditLogs).values(entries);
  } catch (error) {
    console.error("Failed to write audit logs:", error);
  }
}
```

Then update `packages/db/src/services/index.ts` to export the audit service. Read it first to see the current export pattern, then add:
```typescript
export * from "./audit";
```
  </action>
  <verify>
Run: `cd /home/dev/projects/relay && npx tsc --noEmit -p packages/db/tsconfig.json 2>&1 | head -20`
Verify the service compiles and is exported:
```bash
grep "audit" packages/db/src/services/index.ts
```
  </verify>
  <done>
writeAuditLog() and writeAuditLogs() are exported from packages/db/src/services/audit.ts. They are fire-and-forget safe (catch errors, log to console). The services index re-exports them. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
- packages/db/src/services/audit.ts exists with writeAuditLog and writeAuditLogs exports
- AuditEntry interface exported with correct fields
- packages/db/src/services/index.ts re-exports from "./audit"
- TypeScript compiles without errors
</verification>

<success_criteria>
The audit log write service is available for import by any part of the application. It correctly inserts into the audit_logs table and gracefully handles errors without breaking calling code.
</success_criteria>

<output>
After completion, create `.planning/phases/25-multi-tenancy-schema-audit/25-08-SUMMARY.md`
</output>
