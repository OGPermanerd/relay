---
phase: 25-multi-tenancy-schema-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/tenants.ts
  - packages/db/src/schema/audit-logs.ts
autonomous: true

must_haves:
  truths:
    - "A tenants table schema exists with id, name, slug, domain, logo, isActive, plan, createdAt, updatedAt columns"
    - "An audit_logs table schema exists with id, actorId, tenantId, action, resourceType, resourceId, ipAddress, metadata, createdAt columns"
  artifacts:
    - path: "packages/db/src/schema/tenants.ts"
      provides: "Tenants table definition"
      exports: ["tenants", "Tenant", "NewTenant"]
    - path: "packages/db/src/schema/audit-logs.ts"
      provides: "Audit logs table definition"
      exports: ["auditLogs", "AuditLog", "NewAuditLog"]
  key_links: []
---

<objective>
Create the tenants and audit_logs Drizzle schema files — the two new tables required for multi-tenancy and SOC2 compliance.

Purpose: These are the foundation tables that all other Phase 25 plans depend on. The tenants table enables tenant isolation; the audit_logs table enables compliance tracking.
Output: Two new schema files with Drizzle table definitions and type exports.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/schema/users.ts
@packages/db/src/schema/skills.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tenants and audit_logs schema files</name>
  <files>
    packages/db/src/schema/tenants.ts
    packages/db/src/schema/audit-logs.ts
  </files>
  <action>
Create two new schema files following the existing pattern in the codebase (text IDs, timestamp columns, type exports).

**File 1: `packages/db/src/schema/tenants.ts`**
```typescript
import { pgTable, text, timestamp, boolean } from "drizzle-orm/pg-core";

export const tenants = pgTable("tenants", {
  id: text("id")
    .primaryKey()
    .$defaultFn(() => crypto.randomUUID()),
  name: text("name").notNull(),
  slug: text("slug").notNull().unique(),
  domain: text("domain"),           // e.g., "company.com" for email-based matching
  logo: text("logo"),               // URL to tenant logo
  isActive: boolean("is_active").notNull().default(true),
  plan: text("plan").notNull().default("freemium"), // "freemium" | "paid"
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});

export type Tenant = typeof tenants.$inferSelect;
export type NewTenant = typeof tenants.$inferInsert;
```

**File 2: `packages/db/src/schema/audit-logs.ts`**
```typescript
import { pgTable, text, timestamp, jsonb, uuid } from "drizzle-orm/pg-core";

export const auditLogs = pgTable("audit_logs", {
  id: uuid("id").primaryKey().defaultRandom(),
  actorId: text("actor_id"),        // User who performed the action
  tenantId: text("tenant_id"),      // Tenant context (nullable for cross-tenant events)
  action: text("action").notNull(), // e.g., "auth.login", "skill.create"
  resourceType: text("resource_type"), // e.g., "skill", "api_key"
  resourceId: text("resource_id"),
  ipAddress: text("ip_address"),
  metadata: jsonb("metadata").$type<Record<string, unknown>>(),
  createdAt: timestamp("created_at", { withTimezone: true }).notNull().defaultNow(),
});

export type AuditLog = typeof auditLogs.$inferSelect;
export type NewAuditLog = typeof auditLogs.$inferInsert;
```

Note: Do NOT add these to `packages/db/src/schema/index.ts` yet — Plan 03 handles the index file update along with tenant_id column additions.
  </action>
  <verify>
Run: `cd /home/dev/projects/relay && npx tsc --noEmit -p packages/db/tsconfig.json 2>&1 | head -20`
Both files should compile without errors. Verify the files exist and export the correct types.
  </verify>
  <done>
tenants.ts exports tenants table with all 9 columns (id, name, slug, domain, logo, isActive, plan, createdAt, updatedAt) plus Tenant and NewTenant types.
audit-logs.ts exports auditLogs table with all 9 columns (id, actorId, tenantId, action, resourceType, resourceId, ipAddress, metadata, createdAt) plus AuditLog and NewAuditLog types.
  </done>
</task>

</tasks>

<verification>
- `packages/db/src/schema/tenants.ts` exists with correct table definition
- `packages/db/src/schema/audit-logs.ts` exists with correct table definition
- TypeScript compiles without errors
</verification>

<success_criteria>
Both schema files exist, export correct types, and compile. These files are ready for consumption by Plan 03 (schema index + tenant_id columns) and Plan 04 (migrations).
</success_criteria>

<output>
After completion, create `.planning/phases/25-multi-tenancy-schema-audit/25-01-SUMMARY.md`
</output>
