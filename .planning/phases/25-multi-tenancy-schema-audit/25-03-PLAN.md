---
phase: 25-multi-tenancy-schema-audit
plan: 03
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - packages/db/src/schema/skills.ts
  - packages/db/src/schema/users.ts
  - packages/db/src/schema/ratings.ts
  - packages/db/src/schema/usage-events.ts
  - packages/db/src/schema/skill-versions.ts
  - packages/db/src/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "skills, users, ratings, usage-events, and skill-versions tables have a tenantId column referencing tenants.id"
    - "skills table has a composite unique index on (tenantId, slug) instead of a global slug unique"
    - "Schema index re-exports tenants and auditLogs"
  artifacts:
    - path: "packages/db/src/schema/skills.ts"
      provides: "Skills table with tenantId column and composite unique"
      contains: "tenantId"
    - path: "packages/db/src/schema/users.ts"
      provides: "Users table with tenantId column"
      contains: "tenantId"
    - path: "packages/db/src/schema/index.ts"
      provides: "Re-exports all schema including tenants and auditLogs"
      contains: "tenants"
  key_links:
    - from: "packages/db/src/schema/skills.ts"
      to: "packages/db/src/schema/tenants.ts"
      via: "tenantId FK reference"
      pattern: "references.*tenants\\.id"
---

<objective>
Add tenant_id column to the first 5 data tables (skills, users, ratings, usage-events, skill-versions) and update the schema index to export tenants and auditLogs.

Purpose: Every data table needs tenant isolation. This plan modifies 5 schema definitions to include tenant_id references and updates the barrel export. Plan 25-04 handles the remaining 4 tables and relations.
Output: 5 schema files updated with tenantId, schema index updated.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@packages/db/src/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tenantId to skills, users, ratings, usage-events, skill-versions and update schema index</name>
  <files>
    packages/db/src/schema/skills.ts
    packages/db/src/schema/users.ts
    packages/db/src/schema/ratings.ts
    packages/db/src/schema/usage-events.ts
    packages/db/src/schema/skill-versions.ts
    packages/db/src/schema/index.ts
  </files>
  <action>
For each of the 5 data tables, add a `tenantId` column with a foreign key to the tenants table. Read each file first to understand its current structure.

**Pattern for all tables** (add this column after the `id` column):
```typescript
import { tenants } from "./tenants";

// Add this column to each table:
tenantId: text("tenant_id").notNull().references(() => tenants.id),
```

**Special cases:**

1. **skills.ts** — Replace the `.unique()` on slug with a composite unique index:
   - Remove `.unique()` from the slug column definition
   - Add to the table's third argument (alongside existing search index):
   ```typescript
   import { uniqueIndex } from "drizzle-orm/pg-core";
   // In the table extras array:
   uniqueIndex("skills_tenant_slug_unique").on(table.tenantId, table.slug),
   index("skills_tenant_id_idx").on(table.tenantId),
   ```

2. **users.ts** — Keep `.unique()` on email (email is a global login identity). Just add tenantId column. Add a tenant_id index:
   ```typescript
   import { index } from "drizzle-orm/pg-core";
   // Add index in table extras:
   (table) => [index("users_tenant_id_idx").on(table.tenantId)]
   ```

3. **ratings.ts**, **usage-events.ts**, **skill-versions.ts** — Standard pattern: add tenantId column, add tenant_id index in extras.

**Update `packages/db/src/schema/index.ts`:**
Add these two exports:
```typescript
export * from "./tenants";
export * from "./audit-logs";
```
  </action>
  <verify>
Run: `cd /home/dev/projects/relay && npx tsc --noEmit -p packages/db/tsconfig.json 2>&1 | head -30`
All 5 modified files plus the index should compile without errors.
Verify: grep for "tenantId" in each of the 5 schema files to confirm it was added.
  </verify>
  <done>
skills, users, ratings, usage-events, and skill-versions have tenantId column referencing tenants.id. Skills has composite unique on (tenantId, slug). Schema index exports tenants and auditLogs.
  </done>
</task>

</tasks>

<verification>
- 5 schema files contain `tenantId: text("tenant_id").notNull().references(() => tenants.id)`
- skills.ts has `uniqueIndex("skills_tenant_slug_unique").on(table.tenantId, table.slug)` and no `.unique()` on slug
- schema/index.ts exports tenants and auditLogs
- TypeScript compiles without errors across the entire packages/db project
</verification>

<success_criteria>
The first 5 data tables and the schema index reflect the multi-tenant structure. Plan 25-04 will handle the remaining 4 tables and relations.
</success_criteria>

<output>
After completion, create `.planning/phases/25-multi-tenancy-schema-audit/25-03-SUMMARY.md`
</output>
