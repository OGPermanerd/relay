---
phase: 25-multi-tenancy-schema-audit
plan: 04
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - packages/db/src/schema/skill-embeddings.ts
  - packages/db/src/schema/skill-reviews.ts
  - packages/db/src/schema/api-keys.ts
  - packages/db/src/schema/site-settings.ts
  - packages/db/src/relations/index.ts
autonomous: true

must_haves:
  truths:
    - "skill-embeddings, skill-reviews, api-keys, and site-settings tables have a tenantId column referencing tenants.id"
    - "skill-embeddings has composite unique on (tenantId, skillId)"
    - "skill-reviews has composite unique on (tenantId, skillId)"
    - "Relations include tenant references for skills and users"
  artifacts:
    - path: "packages/db/src/schema/skill-embeddings.ts"
      provides: "Skill embeddings table with tenantId and composite unique"
      contains: "tenantId"
    - path: "packages/db/src/schema/api-keys.ts"
      provides: "API keys table with tenantId column"
      contains: "tenantId"
    - path: "packages/db/src/relations/index.ts"
      provides: "Relations with tenant references"
      contains: "tenantsRelations"
  key_links:
    - from: "packages/db/src/schema/skill-embeddings.ts"
      to: "packages/db/src/schema/tenants.ts"
      via: "tenantId FK reference"
      pattern: "references.*tenants\\.id"
    - from: "packages/db/src/relations/index.ts"
      to: "packages/db/src/schema/tenants.ts"
      via: "tenantsRelations many() definitions"
      pattern: "tenantsRelations"
---

<objective>
Add tenant_id column to the remaining 4 data tables (skill-embeddings, skill-reviews, api-keys, site-settings) and update relations to include tenant references.

Purpose: Completes the schema-level tenant isolation started in Plan 25-03. Also wires up Drizzle relations so the ORM understands tenant ownership.
Output: 4 schema files updated with tenantId, relations updated with tenant back-references.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@packages/db/src/relations/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tenantId to skill-embeddings, skill-reviews, api-keys, site-settings</name>
  <files>
    packages/db/src/schema/skill-embeddings.ts
    packages/db/src/schema/skill-reviews.ts
    packages/db/src/schema/api-keys.ts
    packages/db/src/schema/site-settings.ts
  </files>
  <action>
For each of the 4 data tables, add a `tenantId` column with a foreign key to the tenants table. Read each file first to understand its current structure.

**Pattern for all tables** (add this column after the `id` column):
```typescript
import { tenants } from "./tenants";

// Add this column to each table:
tenantId: text("tenant_id").notNull().references(() => tenants.id),
```

**Special cases:**

1. **skill-embeddings.ts** — If it has a unique constraint on skill_id, change to composite `(tenant_id, skill_id)`:
   ```typescript
   uniqueIndex("skill_embeddings_tenant_skill_unique").on(table.tenantId, table.skillId),
   index("skill_embeddings_tenant_id_idx").on(table.tenantId),
   ```

2. **skill-reviews.ts** — If it has a unique constraint on skill_id, change to composite `(tenant_id, skill_id)`:
   ```typescript
   uniqueIndex("skill_reviews_tenant_skill_unique").on(table.tenantId, table.skillId),
   index("skill_reviews_tenant_id_idx").on(table.tenantId),
   ```

3. **site-settings.ts** — The singleton pattern uses `id = 'default'`. Keep the `id` column but add tenant_id. The effective unique key becomes `(tenant_id, id)` so each tenant gets its own settings row. Add a composite unique index.

4. **api-keys.ts** — Keep key_hash globally unique (it's an auth identity). Just add tenantId column and tenant_id index.
  </action>
  <verify>
Run: `cd /home/dev/projects/relay && npx tsc --noEmit -p packages/db/tsconfig.json 2>&1 | head -30`
All 4 modified files should compile without errors.
Verify: grep for "tenantId" in each of the 4 schema files to confirm it was added.
  </verify>
  <done>
skill-embeddings, skill-reviews, api-keys, and site-settings have tenantId column referencing tenants.id. skill-embeddings and skill-reviews have composite unique constraints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update relations to include tenant references</name>
  <files>
    packages/db/src/relations/index.ts
  </files>
  <action>
Update `packages/db/src/relations/index.ts` to add tenant relations:

1. Import `tenants` from the schema
2. Add a `tenantsRelations` definition with `many` relations to users, skills, etc:
```typescript
import { tenants, auditLogs } from "../schema";

export const tenantsRelations = relations(tenants, ({ many }) => ({
  users: many(users),
  skills: many(skills),
  apiKeys: many(apiKeys),
}));
```

3. Add `tenant` relation to existing `usersRelations`:
```typescript
// Add to usersRelations:
tenant: one(tenants, {
  fields: [users.tenantId],
  references: [tenants.id],
}),
```

4. Add `tenant` relation to existing `skillsRelations`:
```typescript
// Add to skillsRelations:
tenant: one(tenants, {
  fields: [skills.tenantId],
  references: [tenants.id],
}),
```

Import `tenants` at the top of the file alongside other schema imports.
  </action>
  <verify>
Run: `cd /home/dev/projects/relay && npx tsc --noEmit -p packages/db/tsconfig.json 2>&1 | head -20`
Relations file should compile without errors.
  </verify>
  <done>
Relations include tenantsRelations (many users, skills, apiKeys), and usersRelations and skillsRelations include a tenant one-relation.
  </done>
</task>

</tasks>

<verification>
- 4 schema files contain `tenantId: text("tenant_id").notNull().references(() => tenants.id)`
- skill-embeddings and skill-reviews have composite unique constraints
- relations/index.ts has tenantsRelations and tenant back-references on users and skills
- TypeScript compiles without errors across the entire packages/db project
</verification>

<success_criteria>
All 9 Drizzle schema definitions (across Plans 25-03 and 25-04) reflect the multi-tenant structure with tenant_id columns. Relations are fully wired. The database schema files are ready for migration generation.
</success_criteria>

<output>
After completion, create `.planning/phases/25-multi-tenancy-schema-audit/25-04-SUMMARY.md`
</output>
