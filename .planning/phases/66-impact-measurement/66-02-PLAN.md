---
phase: 66-impact-measurement
plan: 02
type: execute
wave: 2
depends_on: ["66-01"]
files_modified:
  - apps/web/app/(protected)/portfolio/page.tsx
  - apps/web/components/portfolio-view.tsx
  - apps/web/tests/e2e/portfolio.spec.ts
autonomous: true

must_haves:
  truths:
    - "User sees a skills impact timeline chart on the portfolio page showing cumulative hours saved with event markers"
    - "User sees an impact calculator displaying total hours saved, estimated cost equivalent, and contribution counts"
    - "Timeline distinguishes creation events, fork events, and suggestion-implemented events as different colored markers"
    - "Impact metrics reflect current data on every page load (standard server-component fetch)"
    - "Portfolio page still loads correctly with all existing features intact"
  artifacts:
    - path: "apps/web/app/(protected)/portfolio/page.tsx"
      provides: "Parallel data fetching for timeline and calculator stats"
      contains: "getImpactTimeline"
    - path: "apps/web/components/portfolio-view.tsx"
      provides: "Renders ImpactTimelineChart and ImpactCalculator sections"
      contains: "ImpactTimelineChart"
    - path: "apps/web/tests/e2e/portfolio.spec.ts"
      provides: "E2E tests for impact timeline and calculator sections"
      contains: "Impact"
  key_links:
    - from: "apps/web/app/(protected)/portfolio/page.tsx"
      to: "apps/web/lib/portfolio-queries.ts"
      via: "Promise.all with getImpactTimeline + getImpactCalculatorStats"
      pattern: "getImpactTimeline.*getImpactCalculatorStats"
    - from: "apps/web/components/portfolio-view.tsx"
      to: "apps/web/components/impact-timeline-chart.tsx"
      via: "component import and render with data prop"
      pattern: "ImpactTimelineChart"
    - from: "apps/web/components/portfolio-view.tsx"
      to: "apps/web/components/impact-calculator.tsx"
      via: "component import and render with stats prop"
      pattern: "ImpactCalculator"
---

<objective>
Wire the impact timeline chart and calculator into the portfolio page with parallel server-side data fetching, and add E2E tests.

Purpose: Complete the user-facing feature by connecting data queries to UI components on the existing portfolio page.
Output: Updated portfolio page with timeline + calculator sections, updated E2E tests.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/66-impact-measurement/66-01-SUMMARY.md
@apps/web/app/(protected)/portfolio/page.tsx
@apps/web/components/portfolio-view.tsx
@apps/web/tests/e2e/portfolio.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire timeline and calculator data into portfolio page and view</name>
  <files>apps/web/app/(protected)/portfolio/page.tsx, apps/web/components/portfolio-view.tsx</files>
  <action>
**page.tsx changes:**

Add imports for `getImpactTimeline` and `getImpactCalculatorStats` from `@/lib/portfolio-queries`.

Expand the Promise.all to include both new queries in parallel with the existing three:
```typescript
const [stats, skills, ranking, timeline, impactStats] = await Promise.all([
  getPortfolioStats(session.user.id),
  getPortfolioSkills(session.user.id),
  getContributionRanking(session.user.id, tenantId),
  getImpactTimeline(session.user.id),
  getImpactCalculatorStats(session.user.id),
]);
```

Pass new props to PortfolioView: `timeline={timeline} impactStats={impactStats}`.

**portfolio-view.tsx changes:**

Add imports for `ImpactTimelineChart` from `@/components/impact-timeline-chart` and `ImpactCalculator` from `@/components/impact-calculator`. Add imports for `TimelineEvent` and `ImpactCalculatorStats` types from `@/lib/portfolio-queries`.

Update `PortfolioViewProps` interface to include:
```typescript
timeline: TimelineEvent[];
impactStats: ImpactCalculatorStats;
```

Update the component's destructured props to include `timeline` and `impactStats`.

Add two new sections between the IP Breakdown cards and the "Your Skills" list:
1. `<ImpactTimelineChart data={timeline} />` — the chart component handles its own section heading and empty state
2. `<ImpactCalculator stats={impactStats} />` — the calculator handles its own section heading and empty state

The placement order should be: Hero Stats -> IP Breakdown -> Impact Timeline -> Impact Calculator -> Skills List. This puts the visual/narrative elements (growth over time, then total value) before the detailed list.
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit` to confirm no TypeScript errors. Start dev server and verify `curl -s http://localhost:2002/portfolio | head -100` returns HTML (page loads without 500 error).</verify>
  <done>Portfolio page fetches timeline and impact stats in parallel with existing queries. PortfolioView renders ImpactTimelineChart and ImpactCalculator between IP breakdown and skills list. Page loads without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add E2E tests for impact timeline and calculator</name>
  <files>apps/web/tests/e2e/portfolio.spec.ts</files>
  <action>
Add two new tests to the existing "Portfolio Page" describe block in portfolio.spec.ts:

**Test: "should display impact timeline section"**
1. Navigate to /portfolio
2. Assert `page.getByText("Skills Impact Timeline")` is visible (section heading from the chart component)
3. The chart or empty state placeholder should be present. Check for either the recharts container OR the "No impact data yet" empty state text. Use: `await expect(page.locator('.recharts-wrapper, :text("No impact data yet")')).toBeVisible()` — or simpler: just check the heading exists since the component always renders one or the other.

**Test: "should display impact calculator section"**
1. Navigate to /portfolio
2. Assert `page.getByText("Impact Calculator")` is visible (section heading)
3. Assert `page.getByText("Total Hours Saved")` is visible
4. Assert `page.getByText("Estimated Value Added")` is visible
5. Assert `page.getByText("Skills Created")` is visible
6. Assert `page.getByText("Skills Forked")` is visible
7. Assert `page.getByText("Suggestions Implemented")` is visible

These tests verify the sections render and all expected labels are present. The actual values depend on test data but the labels should always be present (the component renders stat labels even when values are zero, or shows the empty state placeholder — either way the section heading is always there).

Run the full portfolio E2E suite: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/portfolio.spec.ts`

If the dev server was stopped by tests, restart it: `cd /home/dev/projects/relay/apps/web && npm run dev &`
  </action>
  <verify>Run `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/portfolio.spec.ts` — all tests (existing 4 + new 2) pass.</verify>
  <done>All 6 E2E tests pass: 4 existing portfolio tests + 2 new tests for impact timeline and calculator sections. Dev server is running.</done>
</task>

</tasks>

<verification>
1. `cd /home/dev/projects/relay && npx tsc --noEmit` passes
2. Portfolio page loads at http://localhost:2002/portfolio without errors
3. All 6 E2E tests pass (`npx playwright test tests/e2e/portfolio.spec.ts`)
4. Timeline section visible (chart or empty state)
5. Calculator section visible with all stat labels
6. Existing portfolio features (hero stats, IP breakdown, skills list) still work
</verification>

<success_criteria>
- page.tsx fetches 5 queries in parallel (3 existing + 2 new)
- portfolio-view.tsx renders ImpactTimelineChart and ImpactCalculator
- Timeline and calculator sections appear between IP breakdown and skills list
- 6 E2E tests pass (4 existing + 2 new)
- No regressions to existing portfolio functionality
</success_criteria>

<output>
After completion, create `.planning/phases/66-impact-measurement/66-02-SUMMARY.md`
</output>
