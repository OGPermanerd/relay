---
phase: 66-impact-measurement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/portfolio-queries.ts
  - apps/web/components/impact-timeline-chart.tsx
  - apps/web/components/impact-calculator.tsx
autonomous: true

must_haves:
  truths:
    - "getImpactTimeline returns events with cumulative hours saved computed by PostgreSQL window function"
    - "getImpactCalculatorStats returns total hours, cost equivalent, and contribution counts"
    - "ImpactTimelineChart renders a ComposedChart with Area (cumulative) and Scatter (event markers)"
    - "ImpactCalculator displays stat cards for hours saved, cost equivalent, and contribution breakdown"
    - "Both components handle empty state with dashed-border placeholder"
  artifacts:
    - path: "apps/web/lib/portfolio-queries.ts"
      provides: "getImpactTimeline and getImpactCalculatorStats query functions + types"
      exports: ["getImpactTimeline", "getImpactCalculatorStats", "TimelineEvent", "ImpactCalculatorStats"]
    - path: "apps/web/components/impact-timeline-chart.tsx"
      provides: "Recharts ComposedChart with Area + Scatter overlay"
      contains: "ComposedChart"
    - path: "apps/web/components/impact-calculator.tsx"
      provides: "Impact value-added display with stat cards"
      contains: "ImpactCalculator"
  key_links:
    - from: "apps/web/lib/portfolio-queries.ts"
      to: "skills + skill_feedback tables"
      via: "UNION ALL SQL with window function"
      pattern: "UNION ALL"
    - from: "apps/web/components/impact-timeline-chart.tsx"
      to: "TimelineEvent type"
      via: "props interface"
      pattern: "TimelineEvent"
    - from: "apps/web/components/impact-calculator.tsx"
      to: "ImpactCalculatorStats type"
      via: "props interface"
      pattern: "ImpactCalculatorStats"
---

<objective>
Add timeline query, impact calculator query, and their corresponding client components for the portfolio impact measurement feature.

Purpose: Provide the data layer and visual components needed to show users their contribution growth over time and quantify their total value added.
Output: Two new query functions in portfolio-queries.ts, two new client components (impact-timeline-chart.tsx, impact-calculator.tsx).
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@apps/web/lib/portfolio-queries.ts
@apps/web/lib/ip-valuation.ts
@apps/web/components/quality-trend-chart.tsx
@packages/db/src/schema/skill-feedback.ts
@packages/db/src/schema/skills.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add impact timeline and calculator queries to portfolio-queries.ts</name>
  <files>apps/web/lib/portfolio-queries.ts</files>
  <action>
Add two new query functions and their TypeScript interfaces to the existing portfolio-queries.ts file. Import HOURLY_RATE from `@/lib/ip-valuation` at the top (the file is server-only, so this import is safe).

**Interface: TimelineEvent**
```typescript
export interface TimelineEvent {
  date: string;           // ISO date string
  eventType: "creation" | "fork" | "suggestion";
  skillName: string;
  hoursImpact: number;
  cumulativeHoursSaved: number;
}
```

**Function: getImpactTimeline(userId: string): Promise<TimelineEvent[]>**
Uses a single SQL query with UNION ALL combining three event sources:
1. Original skill creations: `skills WHERE author_id = userId AND forked_from_id IS NULL AND published_version_id IS NOT NULL AND status = 'published'` — hours_impact = `total_uses * COALESCE(hours_saved, 1)`
2. Fork creations: same but `forked_from_id IS NOT NULL`
3. Implemented suggestions: `skill_feedback WHERE user_id = userId AND feedback_type = 'suggestion' AND status = 'accepted' AND implemented_by_skill_id IS NOT NULL` — use `COALESCE(reviewed_at, created_at)` as event_date (reviewed_at may be NULL), hours_impact = 0

Apply `SUM(hours_impact) OVER (ORDER BY event_date ROWS UNBOUNDED PRECEDING)` window function for cumulative_hours_saved. ORDER BY event_date ASC.

Return empty array if `!db`. Map rows: convert event_date to ISO string via `new Date(String(row.event_date)).toISOString()`, cast event_type, parse numbers.

**Interface: ImpactCalculatorStats**
```typescript
export interface ImpactCalculatorStats {
  totalHoursSaved: number;
  estimatedCostSaved: number;     // totalHoursSaved * HOURLY_RATE
  skillsCreated: number;
  skillsForked: number;
  suggestionsImplemented: number;
}
```

**Function: getImpactCalculatorStats(userId: string): Promise<ImpactCalculatorStats>**
Two queries:
1. Skills query: `SELECT COALESCE(SUM(total_uses * COALESCE(hours_saved, 1)), 0)::double precision AS total_hours_saved, COUNT(*) FILTER (WHERE forked_from_id IS NULL)::integer AS skills_created, COUNT(*) FILTER (WHERE forked_from_id IS NOT NULL)::integer AS skills_forked FROM skills WHERE author_id = userId AND published_version_id IS NOT NULL AND status = 'published'`
2. Suggestions query: `SELECT COUNT(*)::integer AS suggestions_implemented FROM skill_feedback WHERE user_id = userId AND feedback_type = 'suggestion' AND status = 'accepted' AND implemented_by_skill_id IS NOT NULL`

Compute `estimatedCostSaved = totalHoursSaved * HOURLY_RATE`. Return default zeros if `!db`.
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit` to confirm no TypeScript errors. Verify the new exports exist: `grep -n "export async function getImpactTimeline\|export async function getImpactCalculatorStats\|export interface TimelineEvent\|export interface ImpactCalculatorStats" apps/web/lib/portfolio-queries.ts`</verify>
  <done>portfolio-queries.ts exports getImpactTimeline, getImpactCalculatorStats, TimelineEvent, and ImpactCalculatorStats. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create impact timeline chart and impact calculator client components</name>
  <files>apps/web/components/impact-timeline-chart.tsx, apps/web/components/impact-calculator.tsx</files>
  <action>
**impact-timeline-chart.tsx** — "use client" component.

Imports: ComposedChart, Area, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend from "recharts". Import TimelineEvent type from `@/lib/portfolio-queries`.

Define a local `TimelineDataPoint` interface:
```typescript
interface TimelineDataPoint {
  date: string;
  cumulativeHoursSaved: number;
  creationEvent?: number;
  forkEvent?: number;
  suggestionEvent?: number;
  eventLabel?: string;
}
```

Create `transformTimelineForChart(events: TimelineEvent[]): TimelineDataPoint[]` that maps each event: set `cumulativeHoursSaved` always, set the matching event type key to `cumulativeHoursSaved` value (others undefined), set `eventLabel` to `skillName`.

Define `MONTHS` array and `formatDateShort(isoDate: string): string` using UTC methods (NOT toLocaleDateString — hydration risk). Pattern: `MONTHS[d.getUTCMonth()] + " " + d.getUTCDate()`.

Props: `{ data: TimelineEvent[] }`. Named export `ImpactTimelineChart`.

Empty state: if `data.length === 0`, render dashed-border placeholder div with text "No impact data yet. Publish skills to see your timeline."

Chart: `<ResponsiveContainer width="100%" height="100%">` wrapping `<ComposedChart>` with:
- CartesianGrid strokeDasharray="3 3"
- XAxis dataKey="date" with tickFormatter={formatDateShort}
- YAxis label "Hours Saved"
- Tooltip with custom labelFormatter using formatDateShort
- Legend
- Area: dataKey="cumulativeHoursSaved", stroke="#3b82f6", fill="#3b82f6", fillOpacity=0.1, strokeWidth=2, name="Cumulative Hours Saved", type="monotone"
- Scatter: dataKey="creationEvent", fill="#10b981", name="Skill Created"
- Scatter: dataKey="forkEvent", fill="#8b5cf6", name="Skill Forked"
- Scatter: dataKey="suggestionEvent", fill="#f59e0b", name="Suggestion Implemented"

Wrap chart in a section with h2 "Skills Impact Timeline" and the chart at height 350px.

**impact-calculator.tsx** — "use client" component.

Import ImpactCalculatorStats type from `@/lib/portfolio-queries`.

Props: `{ stats: ImpactCalculatorStats }`. Named export `ImpactCalculator`.

Do NOT import formatCurrency from ip-valuation.ts (it's server-only). Instead, inline a simple `formatCurrency` function: `value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")` prefixed with "$".

Empty state: if all stats are zero (totalHoursSaved + skillsCreated + skillsForked + suggestionsImplemented === 0), render dashed-border placeholder.

Layout: A card (rounded-lg bg-white shadow-sm border border-gray-200 p-6) with:
- h2 "Impact Calculator" section heading
- Top row: two large stat displays side by side
  - "Total Hours Saved" — large number (stats.totalHoursSaved.toFixed(1))
  - "Estimated Value Added" — large number with dollar sign ($formatCurrency(stats.estimatedCostSaved)), subtitle "at $150/hr"
- Bottom row: three smaller stats
  - "Skills Created" — stats.skillsCreated
  - "Skills Forked" — stats.skillsForked
  - "Suggestions Implemented" — stats.suggestionsImplemented

Use consistent Tailwind: text-3xl font-bold for large numbers, text-sm text-gray-500 for labels.
  </action>
  <verify>Run `cd /home/dev/projects/relay && npx tsc --noEmit` to confirm no TypeScript errors. Verify both files exist and have correct exports: `grep -n "export function ImpactTimelineChart\|export function ImpactCalculator" apps/web/components/impact-timeline-chart.tsx apps/web/components/impact-calculator.tsx`</verify>
  <done>Both components exist, export correctly, handle empty states, and TypeScript compiles clean. ImpactTimelineChart renders ComposedChart with Area + 3 Scatter series. ImpactCalculator renders stat cards with hours saved, cost equivalent, and contribution counts.</done>
</task>

</tasks>

<verification>
1. `cd /home/dev/projects/relay && npx tsc --noEmit` passes
2. portfolio-queries.ts exports all 4 new symbols (2 functions, 2 interfaces)
3. impact-timeline-chart.tsx is a "use client" component using ComposedChart
4. impact-calculator.tsx is a "use client" component with inline formatCurrency
5. No toLocaleDateString() usage in any new code
</verification>

<success_criteria>
- Two new query functions with correct SQL (UNION ALL + window function for timeline, FILTER WHERE for calculator)
- Two new client components with empty state handling
- Timeline chart uses Area + Scatter in ComposedChart (not separate charts)
- Impact calculator shows hours saved, dollar value, and contribution breakdown
- All TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/66-impact-measurement/66-01-SUMMARY.md`
</output>
