---
phase: 40-visibility-scoping
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - apps/web/lib/search-skills.ts
  - apps/web/lib/trending.ts
  - apps/web/lib/leaderboard.ts
  - apps/web/lib/platform-stats.ts
  - apps/web/lib/similar-skills.ts
  - apps/web/app/actions/search.ts
  - apps/web/app/(protected)/skills/[slug]/page.tsx
  - apps/web/app/actions/get-skill-content.ts
  - apps/web/app/actions/fork-skill.ts
autonomous: true

must_haves:
  truths:
    - "User browsing skills never sees another user's personal skills"
    - "Trending, leaderboard, and platform stats only count tenant-visible skills"
    - "Skill detail page returns 404 for personal skills viewed by non-author"
    - "Similar skills results exclude personal skills of other users"
    - "Quick search respects visibility filtering"
  artifacts:
    - path: "apps/web/lib/search-skills.ts"
      provides: "Visibility-filtered skill search"
      contains: "buildVisibilityFilter"
    - path: "apps/web/lib/trending.ts"
      provides: "Visibility-filtered trending"
      contains: "visibilitySQL\\|visibility"
    - path: "apps/web/lib/leaderboard.ts"
      provides: "Visibility-filtered leaderboard"
      contains: "visibility"
    - path: "apps/web/lib/platform-stats.ts"
      provides: "Visibility-filtered platform stats"
      contains: "visibility"
    - path: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      provides: "Visibility access check on detail page"
      contains: "visibility.*personal"
  key_links:
    - from: "apps/web/lib/search-skills.ts"
      to: "packages/db/src/lib/visibility.ts"
      via: "import buildVisibilityFilter"
      pattern: "import.*buildVisibilityFilter.*from.*visibility"
    - from: "apps/web/lib/trending.ts"
      to: "packages/db/src/lib/visibility.ts"
      via: "import visibilitySQL"
      pattern: "import.*visibilitySQL.*from.*visibility"
    - from: "apps/web/app/(protected)/skills/[slug]/page.tsx"
      to: "skill.visibility"
      via: "access control check"
      pattern: "visibility.*personal"
---

<objective>
Apply visibility filtering to all web-side skill read paths -- search, trending, leaderboard, platform stats, similar skills, skill detail page, tags, quick search, get-skill-content, and fork access checks.

Purpose: Enforces VIS-02 -- users never see another user's personal skills in any browse, search, or aggregation context on the web app.
Output: All 15 web query paths respect visibility scoping.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-visibility-scoping/40-01-SUMMARY.md
@packages/db/src/lib/visibility.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply visibility to Drizzle query builder paths</name>
  <files>
    apps/web/lib/search-skills.ts
    apps/web/lib/similar-skills.ts
    apps/web/app/actions/search.ts
    apps/web/app/(protected)/skills/[slug]/page.tsx
    apps/web/app/actions/get-skill-content.ts
    apps/web/app/actions/fork-skill.ts
  </files>
  <action>
**1. apps/web/lib/search-skills.ts**
- Add `userId?: string` to the `SearchParams` interface.
- Import `buildVisibilityFilter` from `@everyskill/db/lib/visibility`.
- In `searchSkills()`, after the `eq(skills.status, "published")` condition push, add: `conditions.push(buildVisibilityFilter(params.userId))`.
- In `getAvailableTags()`: Add `userId?: string` parameter. Change the raw SQL to include visibility: `AND (visibility = 'tenant')` (tags should only come from tenant-visible skills -- no userId needed since tags are org-level).

**2. apps/web/lib/similar-skills.ts**
- Read the file first. Find `checkSimilarSkills()` and `findSimilarSkillsByName()`.
- Add `userId?: string` parameter to both functions.
- Import `buildVisibilityFilter` from `@everyskill/db/lib/visibility`.
- For Drizzle query builder paths: add `buildVisibilityFilter(userId)` to the conditions.
- For raw SQL paths (`trySemanticSearch`, `trySemanticSearchBySkill`): add `AND (visibility = 'tenant' OR (visibility = 'personal' AND author_id = '${userId}'))` condition. If no userId, use `AND visibility = 'tenant'`. Import `visibilitySQL` from `@everyskill/db/lib/visibility` and interpolate into the raw SQL template.
- When calling from other places that pass these functions, thread userId through.

**3. apps/web/app/actions/search.ts**
- Read the file first. This contains `quickSearch` server action.
- Import `auth` if not already imported.
- Get session via `await auth()`, extract `session?.user?.id`.
- Pass `userId: session?.user?.id` to the `searchSkills()` call.

**4. apps/web/app/(protected)/skills/[slug]/page.tsx**
- After fetching the skill and session (around line 45-55), add a visibility access check:
  ```
  const isAuthorOfSkill = session?.user?.id === skill.authorId;
  const userIsAdmin = isAdmin(session);
  // Visibility check: personal skills only visible to author and admins
  if (skill.visibility === "personal" && !isAuthorOfSkill && !userIsAdmin) {
    notFound();
  }
  ```
- This check should go right after the existing status-based access control block.
- Also pass `userId` to `findSimilarSkillsByName()` call if it exists on this page.

**5. apps/web/app/actions/get-skill-content.ts**
- Read the file first. Add a visibility check: after fetching the skill, if `skill.visibility === "personal"` and the requesting user is not the author and not admin, return null or throw an error.
- Get session via `auth()`, check `session?.user?.id`.

**6. apps/web/app/actions/fork-skill.ts**
- Read the file first. When fetching the parent skill to fork, add a visibility check: if the parent skill is "personal" and the current user is not the author, reject the fork request.
  </action>
  <verify>
Run: `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit`
Expected: No type errors. All imports resolve correctly.
Then run: `cd /home/dev/projects/relay/apps/web && pnpm build`
Expected: Build succeeds with no errors.
  </verify>
  <done>
All Drizzle query builder paths (searchSkills, getAvailableTags, checkSimilarSkills, findSimilarSkillsByName, quickSearch, skill detail page, get-skill-content, fork-skill) include visibility filtering. Personal skills are hidden from non-authors in all these paths.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply visibility to raw SQL paths (trending, leaderboard, platform stats)</name>
  <files>
    apps/web/lib/trending.ts
    apps/web/lib/leaderboard.ts
    apps/web/lib/platform-stats.ts
  </files>
  <action>
**1. apps/web/lib/trending.ts**
- Import `visibilitySQL` from `@everyskill/db/lib/visibility`.
- Add `userId?: string` parameter to `getTrendingSkills()`.
- In the CTE WHERE clause, after `AND s.status = 'published'`, add: `AND ${visibilitySQL(userId)}` (interpolated into the sql template literal).
- Per research recommendation: for trending/leaderboard/platform-stats, use visibility='tenant' only (no userId) so personal skills don't inflate org metrics. This means calling `visibilitySQL()` with no argument, which returns `visibility = 'tenant'`. This is a deliberate design choice per research pitfalls 3 and 4.

Actually, for trending/leaderboard/platform-stats: ALWAYS filter to `visibility = 'tenant'` regardless of userId. Personal skills should NEVER appear in org-level aggregations. Simply add `AND s.visibility = 'tenant'` directly in the SQL. No need for the helper here -- just inline the condition.

**2. apps/web/lib/leaderboard.ts**
- Read the file first.
- In the leaderboard CTE that joins skills, add `AND s.visibility = 'tenant'` after `AND s.status = 'published'`.
- This ensures personal skills don't contribute to leaderboard rankings (research pitfall 4).

**3. apps/web/lib/platform-stats.ts**
- Read the file first.
- Add `AND visibility = 'tenant'` (or `AND s.visibility = 'tenant'` depending on alias) to all skill queries.
- For Drizzle paths: add `eq(skills.visibility, "tenant")` condition.
- For raw SQL paths: add `AND visibility = 'tenant'` inline.
- Personal skills should not count toward org-level platform stats (research pitfall 3).

**Callers of trending/leaderboard/platform-stats:**
- Check the homepage page.tsx and any server components that call these. These functions currently take no userId param, and for the org-level stats we just hardcode `visibility = 'tenant'` in the query, so callers DON'T need to change. No signature changes needed.
  </action>
  <verify>
Run: `cd /home/dev/projects/relay/apps/web && pnpm build`
Expected: Build succeeds with no errors.
Manually verify SQL by checking the raw SQL strings contain visibility conditions:
- `grep -n "visibility" apps/web/lib/trending.ts apps/web/lib/leaderboard.ts apps/web/lib/platform-stats.ts`
Expected: Each file has at least one visibility condition.
  </verify>
  <done>
Trending, leaderboard, and platform stats queries all filter to visibility='tenant' only. Personal skills never appear in org-level aggregations, rankings, or stats.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds in apps/web
2. Every file in the query path inventory (research paths 1-19) has a visibility condition
3. Grep for `buildVisibilityFilter\|visibilitySQL\|visibility.*tenant\|visibility.*personal` across all modified files confirms coverage
4. Skill detail page returns 404 for personal skills when accessed by non-author
</verification>

<success_criteria>
- searchSkills() accepts userId and applies buildVisibilityFilter
- getAvailableTags() only returns tags from tenant-visible skills
- Trending, leaderboard, platform-stats all filter to visibility='tenant'
- Similar skills filtering respects visibility
- Quick search threads userId from session
- Skill detail page 404s for personal skills viewed by non-author
- get-skill-content and fork-skill check visibility before proceeding
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/40-visibility-scoping/40-02-SUMMARY.md`
</output>
