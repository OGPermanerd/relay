---
phase: 40-visibility-scoping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/skills.ts
  - packages/db/src/lib/visibility.ts
  - packages/db/src/migrations/0019_add_skill_visibility.sql
autonomous: true

must_haves:
  truths:
    - "skills table has a visibility column with NOT NULL DEFAULT 'tenant'"
    - "All existing skills have visibility='tenant' after migration"
    - "buildVisibilityFilter and visibilitySQL helpers exist and return correct SQL for both authenticated and anonymous users"
  artifacts:
    - path: "packages/db/src/schema/skills.ts"
      provides: "visibility column on skills table"
      contains: "visibility"
    - path: "packages/db/src/lib/visibility.ts"
      provides: "Reusable visibility filter helpers"
      exports: ["buildVisibilityFilter", "visibilitySQL"]
    - path: "packages/db/src/migrations/0019_add_skill_visibility.sql"
      provides: "Migration adding column and indexes"
      contains: "ALTER TABLE skills ADD COLUMN"
  key_links:
    - from: "packages/db/src/lib/visibility.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "imports skills table for column references"
      pattern: "import.*skills.*from.*schema"
---

<objective>
Add the visibility column to the skills schema, create the migration, and build the reusable visibility filter helpers that all subsequent plans depend on.

Purpose: Foundation for all visibility scoping -- the column and helpers must exist before any query path or UI can use them.
Output: Schema with visibility column, migration SQL, and buildVisibilityFilter/visibilitySQL helper functions.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/schema/skills.ts
@packages/db/src/migrations/0013_add_skill_status.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visibility column to skills schema and create migration</name>
  <files>
    packages/db/src/schema/skills.ts
    packages/db/src/migrations/0019_add_skill_visibility.sql
  </files>
  <action>
1. In `packages/db/src/schema/skills.ts`, add a `visibility` column to the skills table definition, right after the `statusMessage` field:
   ```
   visibility: text("visibility").notNull().default("tenant"), // "tenant" or "personal"
   ```

2. Create migration file `packages/db/src/migrations/0019_add_skill_visibility.sql`:
   ```sql
   -- Add visibility column: "tenant" (visible to all org members) or "personal" (author only)
   ALTER TABLE skills ADD COLUMN IF NOT EXISTS visibility TEXT NOT NULL DEFAULT 'tenant';

   -- Index for efficient filtering on visibility
   CREATE INDEX IF NOT EXISTS skills_visibility_idx ON skills (visibility);

   -- Composite index for personal skill lookups (visibility + author_id)
   CREATE INDEX IF NOT EXISTS skills_visibility_author_idx ON skills (visibility, author_id);
   ```

3. Run the migration: `cd /home/dev/projects/relay && pnpm --filter @everyskill/db db:migrate`

This follows the exact same pattern as migration 0013_add_skill_status.sql (column with safe default, index).
All existing skills get visibility='tenant' automatically via DEFAULT, so no behavior change.
  </action>
  <verify>
Run: `cd /home/dev/projects/relay && psql "$DATABASE_URL" -c "SELECT column_name, data_type, column_default FROM information_schema.columns WHERE table_name='skills' AND column_name='visibility'"`
Expected: visibility column exists with TEXT type and default 'tenant'.
Also verify indexes: `psql "$DATABASE_URL" -c "SELECT indexname FROM pg_indexes WHERE tablename='skills' AND indexname LIKE '%visibility%'"`
Expected: skills_visibility_idx and skills_visibility_author_idx both exist.
  </verify>
  <done>skills table has visibility TEXT NOT NULL DEFAULT 'tenant' column with two indexes. All existing rows have visibility='tenant'.</done>
</task>

<task type="auto">
  <name>Task 2: Create visibility filter helper functions</name>
  <files>
    packages/db/src/lib/visibility.ts
  </files>
  <action>
1. Create directory: `mkdir -p packages/db/src/lib`

2. Create `packages/db/src/lib/visibility.ts` with two exported functions:

**buildVisibilityFilter(userId?: string): SQL** -- For Drizzle query builder paths:
- If no userId: return `eq(skills.visibility, "tenant")` (anonymous sees only tenant-visible)
- If userId: return `or(eq(skills.visibility, "tenant"), and(eq(skills.visibility, "personal"), eq(skills.authorId, userId)))` (authenticated sees tenant + own personal)
- The `or()` call returns `SQL | undefined` -- use non-null assertion `!` since we always pass 2 args

**visibilitySQL(userId?: string): SQL** -- For raw SQL template paths:
- If no userId: return `sql\`visibility = 'tenant'\``
- If userId: return `sql\`(visibility = 'tenant' OR (visibility = 'personal' AND author_id = ${userId}))\``

Import from: `drizzle-orm` (sql, SQL, eq, or, and) and `../schema/skills` (skills).

Note: This file is importable as `@everyskill/db/lib/visibility` thanks to the wildcard export in package.json.

3. Verify TypeScript compiles: `cd /home/dev/projects/relay && pnpm --filter @everyskill/db typecheck`
  </action>
  <verify>
Run: `cd /home/dev/projects/relay && pnpm --filter @everyskill/db typecheck`
Expected: No type errors. The file should export both functions correctly.
Also verify the import path works: check that `@everyskill/db/lib/visibility` resolves by examining package.json exports (wildcard `./*` pattern).
  </verify>
  <done>buildVisibilityFilter and visibilitySQL are exported from packages/db/src/lib/visibility.ts, TypeScript compiles cleanly, and the module is importable as @everyskill/db/lib/visibility.</done>
</task>

</tasks>

<verification>
1. `psql "$DATABASE_URL" -c "SELECT visibility FROM skills LIMIT 5"` -- all rows show 'tenant'
2. `pnpm --filter @everyskill/db typecheck` -- no errors
3. Migration file exists at packages/db/src/migrations/0019_add_skill_visibility.sql
4. Helper file exists at packages/db/src/lib/visibility.ts with both exports
</verification>

<success_criteria>
- skills table has visibility column (TEXT NOT NULL DEFAULT 'tenant')
- Two indexes exist (skills_visibility_idx, skills_visibility_author_idx)
- All existing skills have visibility='tenant'
- buildVisibilityFilter and visibilitySQL are exported and type-check clean
- No existing functionality broken (build passes)
</success_criteria>

<output>
After completion, create `.planning/phases/40-visibility-scoping/40-01-SUMMARY.md`
</output>
