---
phase: 40-visibility-scoping
plan: 03
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - apps/web/components/skill-upload-form.tsx
  - apps/web/app/actions/skills.ts
autonomous: true

must_haves:
  truths:
    - "User can set a skill's visibility to 'tenant' or 'personal' when creating it"
    - "Visibility selector defaults to 'tenant' (team visible)"
    - "Created skill has the visibility value the user selected"
    - "Forked skills default to 'personal' visibility"
  artifacts:
    - path: "apps/web/components/skill-upload-form.tsx"
      provides: "Visibility radio group in create form"
      contains: "visibility"
    - path: "apps/web/app/actions/skills.ts"
      provides: "Accepts and persists visibility on create"
      contains: "visibility"
  key_links:
    - from: "apps/web/components/skill-upload-form.tsx"
      to: "apps/web/app/actions/skills.ts"
      via: "form submits visibility field"
      pattern: "name=\"visibility\""
    - from: "apps/web/app/actions/skills.ts"
      to: "packages/db/src/schema/skills.ts"
      via: "inserts visibility value"
      pattern: "visibility.*formData\\|visibility.*parsed"
---

<objective>
Add visibility selector UI to the skill creation form and thread the visibility value through the create and fork server actions.

Purpose: Implements VIS-01 -- users choose who can see their skill at creation time. Also handles fork visibility default (personal).
Output: Skill upload form with visibility radio group, server actions accept and persist visibility.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-visibility-scoping/40-01-SUMMARY.md
@apps/web/components/skill-upload-form.tsx
@apps/web/app/actions/skills.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visibility selector to skill upload form</name>
  <files>
    apps/web/components/skill-upload-form.tsx
  </files>
  <action>
1. Add "visibility" to the controlled `fields` state with default value `"tenant"`:
   ```
   const [fields, setFields] = useState({
     name: "",
     description: "",
     category: "",
     tags: "",
     usageInstructions: "",
     content: "",
     hoursSaved: "1",
     visibility: "tenant",  // NEW
   });
   ```

2. Add a visibility radio group to the form, placed AFTER the Category field and BEFORE the Tags field. Use a simple radio group (not a complex component):
   ```tsx
   {/* Visibility field */}
   <fieldset>
     <legend className="block text-sm font-medium text-gray-700">
       Visibility
     </legend>
     <div className="mt-2 flex gap-6">
       <label className="flex items-center gap-2 cursor-pointer">
         <input
           type="radio"
           name="visibility"
           value="tenant"
           checked={fields.visibility === "tenant"}
           onChange={(e) => setField("visibility", e.target.value)}
           disabled={isPending}
           className="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"
         />
         <div>
           <span className="text-sm font-medium text-gray-900">Team</span>
           <p className="text-xs text-gray-500">Everyone in your org can see this</p>
         </div>
       </label>
       <label className="flex items-center gap-2 cursor-pointer">
         <input
           type="radio"
           name="visibility"
           value="personal"
           checked={fields.visibility === "personal"}
           onChange={(e) => setField("visibility", e.target.value)}
           disabled={isPending}
           className="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"
         />
         <div>
           <span className="text-sm font-medium text-gray-900">Personal</span>
           <p className="text-xs text-gray-500">Only you can see this</p>
         </div>
       </label>
     </div>
   </fieldset>
   ```

3. The form already uses native form submission via `formAction`, and the radio input has `name="visibility"`, so the value will be included in FormData automatically. No additional wiring needed.
  </action>
  <verify>
Run: `cd /home/dev/projects/relay/apps/web && npx tsc --noEmit`
Expected: No type errors.
  </verify>
  <done>Skill upload form shows a Team/Personal radio group for visibility, defaulting to Team. The value is submitted as part of the form data.</done>
</task>

<task type="auto">
  <name>Task 2: Thread visibility through create and fork server actions</name>
  <files>
    apps/web/app/actions/skills.ts
    apps/web/app/actions/fork-skill.ts
  </files>
  <action>
**1. apps/web/app/actions/skills.ts**

a) Add `visibility` to the Zod schema `createSkillSchema`:
   ```
   visibility: z.enum(["tenant", "personal"]).default("tenant"),
   ```

b) In `checkAndCreateSkill()`, parse visibility from formData:
   - Add `visibility: formData.get("visibility")` to the `safeParse` call.
   - In the `db.insert(skills).values(...)` call, add `visibility: parsed.data.visibility`.

c) In `createSkill()` (the standalone create action), do the same:
   - Add `visibility: formData.get("visibility")` to the `safeParse` call.
   - In the `db.insert(skills).values(...)` call, add `visibility: parsed.data.visibility`.

**2. apps/web/app/actions/fork-skill.ts**
- Read the file first.
- When inserting the forked skill, set `visibility: "personal"` (forked skills default to personal per research recommendation -- safest from data privacy perspective, user can change later).
- Do NOT inherit parent's visibility. The fork is the user's private copy.

**Both files:** Ensure the visibility column is included in the insert values. The schema default is 'tenant', so if visibility is somehow missing from form data, it falls back to 'tenant' at the DB level.
  </action>
  <verify>
Run: `cd /home/dev/projects/relay/apps/web && pnpm build`
Expected: Build succeeds with no errors.
Verify: grep for "visibility" in both files to confirm it's threaded through the insert.
  </verify>
  <done>
checkAndCreateSkill, createSkill, and forkSkill all persist visibility correctly. Created skills use the user's selection (defaulting to "tenant"). Forked skills always start as "personal".
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds in apps/web
2. Visibility radio group renders on the create skill page
3. Form submission includes visibility in FormData
4. Server action parses and persists visibility value
5. Fork action sets visibility to "personal"
</verification>

<success_criteria>
- Skill upload form has a visible Team/Personal radio group
- Default selection is "Team" (tenant)
- checkAndCreateSkill persists the selected visibility
- createSkill persists the selected visibility
- forkSkill always creates with visibility="personal"
- Zod validates visibility is one of "tenant" or "personal"
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/40-visibility-scoping/40-03-SUMMARY.md`
</output>
