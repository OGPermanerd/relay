---
phase: 46-search-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/search-queries.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/services/search-analytics.ts
  - packages/db/src/services/index.ts
  - packages/db/src/relations/index.ts
  - packages/db/src/migrations/0023_create_search_queries.sql
  - apps/web/app/actions/discover.ts
  - apps/web/app/actions/search.ts
  - apps/web/app/(protected)/skills/page.tsx
autonomous: true

must_haves:
  truths:
    - "Every search query is logged with result count, search type, and tenant ID without blocking the search response"
    - "Logged queries are normalized (lowercase+trimmed) for accurate aggregation"
    - "Quick search, discover, and browse searches are each logged with distinct search_type values"
  artifacts:
    - path: "packages/db/src/schema/search-queries.ts"
      provides: "search_queries table definition with RLS"
      contains: "pgPolicy"
    - path: "packages/db/src/services/search-analytics.ts"
      provides: "logSearchQuery fire-and-forget + admin query functions"
      contains: "logSearchQuery"
    - path: "packages/db/src/migrations/0023_create_search_queries.sql"
      provides: "Database migration for search_queries table"
      contains: "CREATE TABLE search_queries"
  key_links:
    - from: "apps/web/app/actions/discover.ts"
      to: "packages/db/src/services/search-analytics.ts"
      via: "fire-and-forget logSearchQuery call"
      pattern: "logSearchQuery.*catch"
    - from: "apps/web/app/actions/search.ts"
      to: "packages/db/src/services/search-analytics.ts"
      via: "fire-and-forget logSearchQuery call"
      pattern: "logSearchQuery.*catch"
---

<objective>
Create the search_queries table, logging service, admin query functions, and wire fire-and-forget logging into all three search entry points.

Purpose: Foundation for search analytics -- every search is logged so admins can identify skill gaps and understand search behavior.
Output: Working schema + migration, service with logSearchQuery + 4 admin query functions, logging wired into discover/quick/browse search paths.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/schema/usage-events.ts (tenant-isolated table pattern with RLS pgPolicy)
@packages/db/src/services/audit.ts (fire-and-forget logging pattern)
@packages/db/src/schema/index.ts (schema export pattern)
@packages/db/src/services/index.ts (service export pattern)
@packages/db/src/relations/index.ts (relations pattern)
@apps/web/app/actions/discover.ts (discover search entry point)
@apps/web/app/actions/search.ts (quick search entry point)
@apps/web/app/(protected)/skills/page.tsx (browse search entry point)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema, migration, service, and exports</name>
  <files>
    packages/db/src/schema/search-queries.ts
    packages/db/src/schema/index.ts
    packages/db/src/services/search-analytics.ts
    packages/db/src/services/index.ts
    packages/db/src/relations/index.ts
    packages/db/src/migrations/0023_create_search_queries.sql
  </files>
  <action>
    1. Create `packages/db/src/schema/search-queries.ts`:
       - Follow `usage-events.ts` pattern exactly for imports and structure
       - Columns: id (uuid PK defaultRandom), tenantId (text NOT NULL FK to tenants.id), userId (text nullable FK to users.id), query (text NOT NULL), normalizedQuery (text NOT NULL), resultCount (integer NOT NULL), searchType (text NOT NULL), createdAt (timestamp withTimezone NOT NULL defaultNow)
       - Three indexes: tenant_id, created_at, normalized_query
       - pgPolicy "tenant_isolation" matching usage_events pattern (restrictive, all, using/withCheck on current_setting)
       - Export types: SearchQuery (inferSelect), NewSearchQuery (inferInsert)

    2. Add `export * from "./search-queries"` to `packages/db/src/schema/index.ts`

    3. Create `packages/db/src/services/search-analytics.ts`:
       - Import db from "../client", searchQueries from schema, sql/eq/and/gte/desc from drizzle-orm
       - Interface SearchQueryEntry: { tenantId: string, userId: string | null, query: string, normalizedQuery: string, resultCount: number, searchType: string }
       - `logSearchQuery(entry: SearchQueryEntry): Promise<void>` -- fire-and-forget pattern matching writeAuditLog exactly (if !db return, try/catch with console.error)
       - `getSearchSummaryStats(tenantId: string, since: Date)` -- returns { totalSearches, uniqueQueries, zeroResultSearches, uniqueSearchers } using count(*), count(DISTINCT normalized_query), count(*) FILTER WHERE result_count=0, count(DISTINCT user_id)
       - `getTopQueries(tenantId: string, since: Date, limit = 50)` -- returns array of { query, searchCount, avgResults, zeroResultCount, lastSearched } grouped by normalized_query, ordered by count desc
       - `getZeroResultQueries(tenantId: string, since: Date, limit = 30)` -- returns array of { query, searchCount, lastSearched } where result_count=0, grouped by normalized_query, ordered by count desc
       - `getTrendingQueries(tenantId: string, since: Date, limit = 20)` -- returns array of { query, searchCount, uniqueUsers } from last 7 days, grouped by normalized_query, ordered by count desc
       - All query functions filter by tenantId AND gte(createdAt, since)
       - Cast all aggregation results with `::int` to get JS numbers not strings

    4. Add exports to `packages/db/src/services/index.ts`:
       ```
       export { logSearchQuery, getSearchSummaryStats, getTopQueries, getZeroResultQueries, getTrendingQueries, type SearchQueryEntry } from "./search-analytics";
       ```

    5. Add searchQueriesRelations to `packages/db/src/relations/index.ts`:
       - Import searchQueries from schema
       - Add relation: tenant (one, tenantId -> tenants.id), user (one, userId -> users.id)
       - Follow exact same pattern as notificationsRelations
       - Add searchQueries to tenants many() and users many() relations

    6. Create migration `packages/db/src/migrations/0023_create_search_queries.sql`:
       - CREATE TABLE with all columns matching the Drizzle schema
       - CREATE INDEX x3 (tenant_id, created_at, normalized_query)
       - ALTER TABLE ENABLE ROW LEVEL SECURITY
       - CREATE POLICY tenant_isolation AS RESTRICTIVE FOR ALL USING/WITH CHECK

    7. Run migration: `psql "$DATABASE_URL" -f packages/db/src/migrations/0023_create_search_queries.sql`
  </action>
  <verify>
    - `cd /home/dev/projects/relay && pnpm build --filter @everyskill/db` succeeds
    - `psql "$DATABASE_URL" -c "SELECT column_name FROM information_schema.columns WHERE table_name='search_queries' ORDER BY ordinal_position"` shows all 7 columns
    - `psql "$DATABASE_URL" -c "SELECT polname FROM pg_policies WHERE tablename='search_queries'"` shows tenant_isolation
  </verify>
  <done>search_queries table exists in database with RLS, schema/service/relations all exported from @everyskill/db</done>
</task>

<task type="auto">
  <name>Task 2: Wire fire-and-forget logging into search entry points</name>
  <files>
    apps/web/app/actions/discover.ts
    apps/web/app/actions/search.ts
    apps/web/app/(protected)/skills/page.tsx
  </files>
  <action>
    1. In `apps/web/app/actions/discover.ts`:
       - Add import: `import { logSearchQuery } from "@everyskill/db";`
       - After `const finalResults = applyPreferenceBoost(...)` and before the return statement (around line 158), add:
         ```
         logSearchQuery({
           tenantId,
           userId: userId ?? null,
           query: trimmed,
           normalizedQuery: trimmed.toLowerCase(),
           resultCount: finalResults.length,
           searchType: "discover",
         }).catch(() => {});
         ```
       - Do NOT await -- fire-and-forget with .catch(() => {})

    2. In `apps/web/app/actions/search.ts`:
       - Add import: `import { logSearchQuery } from "@everyskill/db";`
       - After `const session = await auth();` add: `const tenantId = session?.user?.tenantId ?? "default-tenant-000-0000-000000000000";`
       - After the `const results = ...` mapping (line ~26, before the return), add:
         ```
         const trimmed = query.trim();
         logSearchQuery({
           tenantId,
           userId: session?.user?.id ?? null,
           query: trimmed,
           normalizedQuery: trimmed.toLowerCase(),
           resultCount: results.length,
           searchType: "quick",
         }).catch(() => {});
         ```
       - Note: `results` here is the mapped QuickSearchResult array, so resultCount is correct

    3. In `apps/web/app/(protected)/skills/page.tsx`:
       - Add import: `import { logSearchQuery } from "@everyskill/db";`
       - Add constant: `const DEFAULT_TENANT_ID = "default-tenant-000-0000-000000000000";`
       - After the `searchSkills()` call resolves and skills array is available, add a conditional block:
         ```
         if (query) {
           const tenantId = session?.user?.tenantId ?? DEFAULT_TENANT_ID;
           logSearchQuery({
             tenantId,
             userId: session?.user?.id ?? null,
             query,
             normalizedQuery: query.toLowerCase().trim(),
             resultCount: skills.length,
             searchType: "browse",
           }).catch(() => {});
         }
         ```
       - Place this after the Promise.all resolves but before getUsageTrends
       - IMPORTANT: Only log when `query` is non-empty (user actually searched)
  </action>
  <verify>
    - `cd /home/dev/projects/relay && pnpm build --filter @everyskill/web` succeeds with no type errors
    - Start dev server, perform a search on /skills?q=test, then check: `psql "$DATABASE_URL" -c "SELECT search_type, query, result_count FROM search_queries ORDER BY created_at DESC LIMIT 5"` shows the logged query
  </verify>
  <done>All three search paths (discover, quick, browse) log queries fire-and-forget. No search latency impact. Rows appear in search_queries table after searching.</done>
</task>

</tasks>

<verification>
1. `pnpm build` (full monorepo) succeeds with no errors
2. Database has search_queries table with RLS policy
3. Performing searches creates rows in search_queries with correct search_type values
4. Search response times are unchanged (fire-and-forget, no blocking)
</verification>

<success_criteria>
- search_queries table exists with tenant_id FK, RLS policy, and 3 indexes
- logSearchQuery + 4 admin query functions exported from @everyskill/db
- discoverSkills logs with searchType="discover", quickSearch logs with searchType="quick", browse page logs with searchType="browse"
- Logging is fire-and-forget (.catch(() => {})), never awaited in request path
</success_criteria>

<output>
After completion, create `.planning/phases/46-search-analytics/46-01-SUMMARY.md`
</output>
