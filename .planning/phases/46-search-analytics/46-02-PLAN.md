---
phase: 46-search-analytics
plan: 02
type: execute
wave: 2
depends_on: ["46-01"]
files_modified:
  - apps/web/app/(protected)/admin/layout.tsx
  - apps/web/app/(protected)/admin/search/page.tsx
  - apps/web/components/admin-search-table.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view a Search Analytics page showing summary stats (total searches, unique queries, zero-result count, unique searchers)"
    - "Admin can see zero-result queries ranked by frequency to identify skill gaps"
    - "Admin can see most-searched terms and trending queries sorted by frequency"
  artifacts:
    - path: "apps/web/app/(protected)/admin/search/page.tsx"
      provides: "Admin search analytics page with summary cards"
      contains: "getSearchSummaryStats"
    - path: "apps/web/components/admin-search-table.tsx"
      provides: "Client component with tabbed data tables"
      contains: "use client"
    - path: "apps/web/app/(protected)/admin/layout.tsx"
      provides: "Admin nav with Search link"
      contains: "Search"
  key_links:
    - from: "apps/web/app/(protected)/admin/search/page.tsx"
      to: "packages/db/src/services/search-analytics.ts"
      via: "server component data fetching"
      pattern: "getTopQueries|getZeroResultQueries|getTrendingQueries"
    - from: "apps/web/app/(protected)/admin/layout.tsx"
      to: "apps/web/app/(protected)/admin/search/page.tsx"
      via: "nav link routing"
      pattern: "/admin/search"
---

<objective>
Build the admin search analytics dashboard page with summary cards and tabbed data tables showing top queries, zero-result queries, and trending queries.

Purpose: Admins identify skill gaps from zero-result queries and understand search behavior from frequency/trending data.
Output: New /admin/search page with 4 summary stat cards, a tabbed table (Top / Zero Results / Trending), and "Search" added to admin nav.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-search-analytics/46-01-SUMMARY.md
@apps/web/app/(protected)/admin/compliance/page.tsx (admin page pattern with summary cards)
@apps/web/components/admin-compliance-table.tsx (client table component pattern)
@apps/web/app/(protected)/admin/layout.tsx (admin nav pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin search analytics page and table component</name>
  <files>
    apps/web/app/(protected)/admin/layout.tsx
    apps/web/app/(protected)/admin/search/page.tsx
    apps/web/components/admin-search-table.tsx
  </files>
  <action>
    1. Add "Search" nav item to `apps/web/app/(protected)/admin/layout.tsx`:
       - Add `{ label: "Search", href: "/admin/search" }` to the adminNavItems array

    2. Create `apps/web/app/(protected)/admin/search/page.tsx` (server component):
       - Import auth, redirect, isAdmin from existing locations (same as compliance page)
       - Import { getSearchSummaryStats, getTopQueries, getZeroResultQueries, getTrendingQueries } from "@everyskill/db"
       - Import AdminSearchTable client component
       - Auth guard: same as compliance page (session check + isAdmin, redirect if not)
       - Set tenantId = session.user.tenantId || DEFAULT_TENANT_ID
       - Compute `thirtyDaysAgo` and `sevenDaysAgo` as Date objects
       - Fetch all 4 datasets in parallel with Promise.all:
         - getSearchSummaryStats(tenantId, thirtyDaysAgo)
         - getTopQueries(tenantId, thirtyDaysAgo, 50)
         - getZeroResultQueries(tenantId, thirtyDaysAgo, 30)
         - getTrendingQueries(tenantId, sevenDaysAgo, 20)
       - Render page structure matching compliance page pattern:
         - h1: "Search Analytics"
         - Subtitle: "Understand what users are searching for and identify skill gaps."
         - 4 summary cards in a grid (sm:grid-cols-4):
           a. "Total Searches" (stats.totalSearches) -- gray border
           b. "Unique Queries" (stats.uniqueQueries) -- gray border
           c. "Zero Results" (stats.zeroResultSearches) -- red-50 bg, red-200 border (highlights gaps)
           d. "Unique Searchers" (stats.uniqueSearchers) -- gray border
         - "Last 30 days" subtitle under the cards
         - AdminSearchTable component receiving all 3 query datasets
       - Pass dates as ISO strings to client component (per project convention -- no toLocaleDateString)

    3. Create `apps/web/components/admin-search-table.tsx` ("use client"):
       - Three interfaces for row types:
         - TopQueryRow: { query, searchCount, avgResults, zeroResultCount, lastSearched }
         - ZeroResultRow: { query, searchCount, lastSearched }
         - TrendingRow: { query, searchCount, uniqueUsers }
       - Props: { topQueries: TopQueryRow[], zeroResultQueries: ZeroResultRow[], trendingQueries: TrendingRow[] }
       - State: activeTab ("top" | "zero" | "trending"), default "top"
       - Tab buttons at top: "Top Queries", "Zero Results", "Trending"
         - Active tab: blue-600 text, border-b-2 border-blue-600
         - Inactive: gray-500 text, hover:text-gray-700
       - Table rendering per tab:
         a. "top" tab columns: Query, Searches, Avg Results, Zero-Result Count, Last Searched
         b. "zero" tab columns: Query, Times Searched, Last Searched (with red-100 bg badge for emphasis)
         c. "trending" tab columns: Query (7-day), Searches, Unique Users
       - Date formatting: Use RelativeTime component (import from @/components/relative-time) for lastSearched fields, matching compliance table pattern
       - Empty state: "No search data yet." centered in table area
       - Follow exact Tailwind class patterns from AdminComplianceTable (table/thead/tbody structure, hover:bg-gray-50 on rows, text-xs uppercase headers)
  </action>
  <verify>
    - `cd /home/dev/projects/relay && pnpm build --filter @everyskill/web` succeeds
    - Run Playwright test to verify the page loads for admin: `cd /home/dev/projects/relay/apps/web && npx playwright test tests/e2e/admin.spec.ts` (if exists) or manually verify the page loads at /admin/search
    - Navigate to /admin/search -- page renders with 4 summary cards and the tabbed table
  </verify>
  <done>
    Admin can navigate to /admin/search from the admin nav, see 4 summary stat cards (total, unique, zero-result, searchers), and switch between Top Queries, Zero Results, and Trending tabs. All data sourced from search_queries table via Plan 01's service functions.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds (full monorepo)
2. /admin/search loads for admin users, redirects non-admins
3. Summary cards display correct aggregate numbers
4. Tab switching shows different query datasets
5. Zero-result queries tab clearly highlights skill gap signals
6. No hydration errors (dates passed as ISO strings, formatted client-side)
</verification>

<success_criteria>
- "Search" appears in admin nav bar between "Compliance" and existing items
- /admin/search shows 4 summary stat cards with last-30-day data
- Top Queries tab shows normalized queries with search count, avg results, zero-result count
- Zero Results tab shows queries that returned nothing, ranked by frequency
- Trending tab shows last-7-day queries ranked by search count with unique user count
- Page handles empty state gracefully (no data yet)
</success_criteria>

<output>
After completion, create `.planning/phases/46-search-analytics/46-02-SUMMARY.md`
</output>
