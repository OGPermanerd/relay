# Milestone v7.0: Algorithm & Architecture Rewrite

**Status:** ✅ SHIPPED 2026-02-18
**Phases:** 69-75
**Total Plans:** 17

## Overview

Implement research-backed algorithmic infrastructure — GraphRAG communities, adaptive query routing, temporal tracking, extended visibility, multi-model benchmarking — to make the "smart skills database" promise real.

## Phases

### Phase 69: Extended Visibility

**Goal**: Users and admins can manage skills across 4 graduated visibility levels with correct tenant isolation
**Depends on**: Nothing (first v7.0 phase)
**Plans**: 3 plans

Plans:
- [x] 69-01-PLAN.md -- Visibility foundation: helpers, schema, migration, unit tests
- [x] 69-02-PLAN.md -- Inline query updates + validation schemas + admin gate
- [x] 69-03-PLAN.md -- UI: upload form visibility options + VisibilityBadge

**Details:**
- CHECK constraint (not enum) for 4 visibility values — easy to extend without migration
- RLS cross-tenant reads for global_approved via OR in USING clause
- Server-side admin resolution via auth() + isAdmin() passed as boolean prop
- VisibilityBadge color scheme: Global=purple, Company=blue, Portable=green, Private=gray
- Updated 15+ query sites across services, MCP, and actions

### Phase 70: MCP Preference Sync

**Goal**: Users' search preferences flow bidirectionally between the web UI and MCP tools
**Depends on**: Nothing (parallel with Phase 69)
**Plans**: 2 plans

Plans:
- [x] 70-01-PLAN.md -- Preference CRUD: get_preferences + set_preferences actions in unified tool
- [x] 70-02-PLAN.md -- Search boost: preference reranking in search/recommend + defaultSort in list

**Details:**
- Read-modify-write pattern for MCP set_preferences to preserve claudeMdWorkflowNotes and trainingDataConsent
- PREFERENCE_BOOST = 1.3 matches web UI discover.ts multiplier
- Stable sort for text search preference reranking
- All preference loading wrapped in try/catch — failures never break core MCP tools

### Phase 71: Temporal Tracking

**Goal**: Users can see what changed in skills since they last looked, reducing information overload
**Depends on**: Nothing (parallel with Phases 69-70)
**Plans**: 3 plans

Plans:
- [x] 71-01-PLAN.md -- DB foundation: user_skill_views schema, migration, service layer
- [x] 71-02-PLAN.md -- View tracking + change summary on skill detail page (TEMP-01, TEMP-03)
- [x] 71-03-PLAN.md -- Updated badge on skill cards + What's New dashboard feed (TEMP-02, TEMP-04)

**Details:**
- UPSERT targets unique (tenant_id, user_id, skill_id) composite index
- Changes computed BEFORE recording view to preserve comparison baseline
- View recording is fire-and-forget — never blocks page render
- WhatsNewFeed returns null when empty (hidden, not empty state)

### Phase 72: Community Detection

**Goal**: The system autonomously clusters skills into meaningful thematic communities using embedding similarity
**Depends on**: Nothing (parallel, benefits from Phase 69 for visibility filtering)
**Plans**: 2 plans

Plans:
- [x] 72-01-PLAN.md -- DB foundation: skill_communities schema, migration, graphology install
- [x] 72-02-PLAN.md -- Detection service (KNN + Louvain) + cron endpoint with live verification

**Details:**
- K=10 nearest neighbors, MIN_SIMILARITY=0.3 edge threshold, RESOLUTION=1.0 Louvain parameter
- Atomic refresh via db.transaction (delete + insert) not per-row UPSERT
- HNSW index for efficient KNN queries
- MIN_SKILLS_FOR_DETECTION=5 as lower bound

### Phase 73: Community Discovery UI

**Goal**: Users can browse and explore skill communities to discover related skills they would not have found through search
**Depends on**: Phase 72 (communities must exist in the database)
**Plans**: 2 plans

Plans:
- [x] 73-01-PLAN.md -- Schema migration + query services + AI label generator + cron integration
- [x] 73-02-PLAN.md -- Community browse page, detail page, card component, dashboard section

**Details:**
- Claude Haiku for label generation — cost-efficient for short outputs
- Labels generated automatically in cron after detection
- pgvector AVG() for centroid similarity — no JS vector math
- Dashboard limited to 3 communities max with "View all" overflow

### Phase 74: Adaptive Query Routing

**Goal**: Search queries are automatically classified and routed to the optimal retrieval strategy
**Depends on**: Nothing (independent)
**Plans**: 3 plans

Plans:
- [x] 74-01-PLAN.md -- Schema migration + query classifier + search router foundation
- [x] 74-02-PLAN.md -- Wire routing into discover, quick search, and skills page entry points
- [x] 74-03-PLAN.md -- Route type breakdown in admin search analytics dashboard

**Details:**
- Pure-function classifier with zero dependencies — deterministic, testable, no async
- Centralized embedding generation in router to avoid double-generation on fallback
- RouteResult<T> carries fellBack flag and classificationReason for analytics
- Keyword-to-hybrid fallback wrapped in try/catch for graceful embedding failure handling

### Phase 75: RAGAS Benchmarking

**Goal**: Benchmark results provide 4-dimension quality insight (faithfulness, relevancy, precision, recall) alongside the existing overall score
**Depends on**: Nothing (independent)
**Plans**: 2 plans

Plans:
- [x] 75-01-PLAN.md -- Schema migration + judge prompt extension for 4-dimension scoring
- [x] 75-02-PLAN.md -- Query layer + radar chart + dimension comparison UI

**Details:**
- Nullable INTEGER columns for backward compatibility with existing results
- Single API call scores all 5 dimensions (not 4 separate calls) — cost efficient
- max_tokens increased from 512 to 1024 for richer per-dimension judge output
- Divergent scoring examples in prompt to mitigate score clustering
- qualityScore remains the judge's holistic score — NOT recalculated from dimensions

---

## Milestone Summary

**Key Decisions:**
- PostgreSQL adjacency lists for graphs, no graph DB (scale too small for Neo4j)
- Louvain in JS via graphology, no Python sidecar (~300 lines)
- Rule-based query classification, no LLM per-query (handles 90%+ correctly)
- RAGAS as TypeScript judge prompt adaptation, no Python RAGAS library
- Direct SDKs with dynamic import, no Vercel AI SDK (project already has direct Anthropic SDK)
- CHECK constraint for visibility (not enum) — easy to extend without migration
- sigma.js + graphology for interactive knowledge topology visualization

**Issues Resolved:**
- Cross-tenant visibility queries updated across 15+ query sites
- KNN graph construction uses HNSW index to avoid quadratic CROSS JOIN
- Near-invisible dimmed nodes in topology graph fixed with tinted dimming function

**Issues Deferred:**
- Hierarchical sub-communities (COMM-D01) — deferred to v8.0+
- Community health scores (COMM-D02) — deferred to v8.0+
- AI-generated change summaries (TEMP-D01) — deferred to v8.0+
- Query intent display (ROUTE-D01) — deferred to v8.0+

**Technical Debt Incurred:**
- Some REQUIREMENTS.md checkboxes for VIS-01 through VIS-05 not checked despite being complete (traceability table shows Complete)
- Knowledge topology visualization not tracked as a formal requirement (implemented ad hoc)

---

_For current project status, see .planning/ROADMAP.md_
