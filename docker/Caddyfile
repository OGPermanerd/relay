# Host Caddyfile for FNCR-dev2 VPS
# Caddy runs on VPS host, proxies to LXC containers
#   relay-dev (10.10.10.152) — EverySkill web app
#   ceo (10.10.10.21) — Muse MCP server

{
    on_demand_tls {
        ask http://10.10.10.152:2000/api/check-domain
    }
}

# Muse MCP server — runs in ceo LXC
muse.everyskill.ai {
    bind 178.156.181.178
    reverse_proxy 10.10.10.21:3001
}

# Dev
dev.everyskill.ai {
    bind 178.156.181.178
    reverse_proxy 10.10.10.152:2002 {
        header_up X-Real-IP {remote_host}
    }
}

# Staging
staging.everyskill.ai {
    bind 178.156.181.178
    reverse_proxy 10.10.10.152:2001 {
        header_up X-Real-IP {remote_host}
    }
}

# www → bare domain redirect
www.everyskill.ai {
    bind 178.156.181.178
    redir https://everyskill.ai{uri} permanent
}

# Bare domain
everyskill.ai {
    bind 178.156.181.178
    reverse_proxy 10.10.10.152:2000 {
        header_up X-Real-IP {remote_host}
    }
}

# Tenant subdomains (*.everyskill.ai) + vanity domains
# On-demand TLS provisions certs via HTTP challenge, validated by /api/check-domain
https:// {
    bind 178.156.181.178
    tls {
        on_demand
    }
    reverse_proxy 10.10.10.152:2000 {
        header_up X-Real-IP {remote_host}
    }
}
